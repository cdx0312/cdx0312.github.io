<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="go," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="第12章 读写数据12.1 读取用户的输入 fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止 fmt.Scanf第一个参数用来格式化字符串 fmt.Sscan从字符串读取 bufio.Reader缓冲读，读到指定字符输出一次  123inputReader := bufio.NewReader(os.Stdin)fmt.Println(&quot;Please enter your nam">
<meta name="keywords" content="go">
<meta property="og:type" content="article">
<meta property="og:title" content="the way to go advaced">
<meta property="og:url" content="http://yoursite.com/2020/04/16/the-way-to-go-advanced/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="第12章 读写数据12.1 读取用户的输入 fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止 fmt.Scanf第一个参数用来格式化字符串 fmt.Sscan从字符串读取 bufio.Reader缓冲读，读到指定字符输出一次  123inputReader := bufio.NewReader(os.Stdin)fmt.Println(&quot;Please enter your nam">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-04-16T06:34:43.993Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="the way to go advaced">
<meta name="twitter:description" content="第12章 读写数据12.1 读取用户的输入 fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止 fmt.Scanf第一个参数用来格式化字符串 fmt.Sscan从字符串读取 bufio.Reader缓冲读，读到指定字符输出一次  123inputReader := bufio.NewReader(os.Stdin)fmt.Println(&quot;Please enter your nam">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/04/16/the-way-to-go-advanced/"/>





  <title>the way to go advaced | 小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/the-way-to-go-advanced/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">the way to go advaced</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T14:22:48+08:00">
                2020-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="第12章-读写数据"><a href="#第12章-读写数据" class="headerlink" title="第12章 读写数据"></a>第12章 读写数据</h1><h2 id="12-1-读取用户的输入"><a href="#12-1-读取用户的输入" class="headerlink" title="12.1 读取用户的输入"></a>12.1 读取用户的输入</h2><ul>
<li>fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止</li>
<li>fmt.Scanf第一个参数用来格式化字符串</li>
<li>fmt.Sscan从字符串读取</li>
<li>bufio.Reader缓冲读，读到指定字符输出一次</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">inputReader := bufio.NewReader(os.Stdin)</div><div class="line">fmt.Println(<span class="string">"Please enter your name:"</span>)</div><div class="line">input, err := inputReader.ReadString(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure>
<h2 id="12-2-文件读写"><a href="#12-2-文件读写" class="headerlink" title="12.2 文件读写"></a>12.2 文件读写</h2><h3 id="12-2-1-读文件"><a href="#12-2-1-读文件" class="headerlink" title="12.2.1 读文件"></a>12.2.1 读文件</h3><ul>
<li>go语言中os.File类型的指针叫做文件句柄</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    inputFile, inputError := os.Open(<span class="string">"input.dat"</span>)</div><div class="line">    <span class="keyword">if</span> inputError != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"An error occurred on opening the inputfile\n Does the file exist?\n Have you got acces to it?\n"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> inputFile.Close()</div><div class="line">    inputReader := bufio.NewReader(inputFile)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        inputString, readerError := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> readerError == io.EOF &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"The input was: %s"</span>, inputString)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>将整个文件的内容读到一个字符串里边去 - ioutil.ReadFile(),第一个返回值是[]byte，第二个是error</li>
<li>带缓冲的读取 - bufio.Reader.Read()</li>
<li>按列读取文件中的数据，空格分隔，fmt.Fscanln(file, str1 str2 str3)</li>
</ul>
<h3 id="12-2-2-compress包：读取压缩文件"><a href="#12-2-2-compress包：读取压缩文件" class="headerlink" title="12.2.2 compress包：读取压缩文件"></a>12.2.2 compress包：读取压缩文件</h3><ul>
<li>compress包支持的压缩文件格式为bzip2,flate,gzip,lzw,zlib</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fz, err := gzip.NewReader(fi)</div></pre></td></tr></table></figure>
<h3 id="12-2-3-写文件"><a href="#12-2-3-写文件" class="headerlink" title="12.2.3 写文件"></a>12.2.3 写文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">outputFile, outputError := os.OpenFile(<span class="string">"output.dat"</span>, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</div><div class="line"><span class="keyword">if</span> outputError != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> outputFile.Close()</div><div class="line">outputWriter := bufio.NewWriter(outputFile)</div><div class="line">outputString := <span class="string">"Hello hello hello"</span></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">    outputWriter.WriteString(outputString)</div><div class="line">&#125;</div><div class="line">outputWrite.Flush()</div></pre></td></tr></table></figure>
<ul>
<li>os.O_RDONLY</li>
<li>os.O_WRONLY</li>
<li>os.O_CREATE：不存在创建</li>
<li>os.O_TRUNC：存在截断长度为0，类似清空</li>
<li>使用os.Stdout.WriteString(“string”) 可以输出到屏幕</li>
</ul>
<h2 id="12-3-文件拷贝"><a href="#12-3-文件拷贝" class="headerlink" title="12.3 文件拷贝"></a>12.3 文件拷贝</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    CopyFile(<span class="string">"target.txt"</span>, <span class="string">"source.txt"</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">    src, err := os.Open(srcName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> src.Close()</div><div class="line"></div><div class="line">    dst, err := os.Create(dstName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> dst.Close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> io.Copy(dst, src)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-4-从命令行读取参数"><a href="#12-4-从命令行读取参数" class="headerlink" title="12.4 从命令行读取参数"></a>12.4 从命令行读取参数</h2><h3 id="12-4-1-os包"><a href="#12-4-1-os包" class="headerlink" title="12.4.1 os包"></a>12.4.1 os包</h3><ul>
<li>os包中的os.Args来处理命令行参数，在程序启动后读取命令行输入的参数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    who := <span class="string">"Alice"</span></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</div><div class="line">        who += strings.Join(os.Args[<span class="number">1</span>:], <span class="string">" "</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"hello"</span>, who)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="12-4-2-flag包"><a href="#12-4-2-flag包" class="headerlink" title="12.4.2 flag包"></a>12.4.2 flag包</h3><ul>
<li>flag包可以用来替换变量</li>
<li>flag.Parse()扫描参数列表或者常量列表</li>
<li>flag.Arg(0) 第一个参数</li>
</ul>
<h2 id="12-5-buffer读取文件"><a href="#12-5-buffer读取文件" class="headerlink" title="12.5 buffer读取文件"></a>12.5 buffer读取文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(r *bufio.Reader)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf, err := r.ReadBytes(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Fprintf(os.Stdout, <span class="string">"%s"</span>, buf)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    <span class="keyword">if</span> flag.NArgs() == <span class="number">0</span> &#123;</div><div class="line">        cat(bufio.NewReader(os.Stdin))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; flag.NArg(); i++ &#123;</div><div class="line">        f, err := os.Open(flag.Arg(i))</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        cat(bufio.NewReader(f))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-6-用切片读写文件"><a href="#12-6-用切片读写文件" class="headerlink" title="12.6 用切片读写文件"></a>12.6 用切片读写文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *os.File)</span></span> &#123;</div><div class="line">    <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">    <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">switch</span> nr, err := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">        <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">            fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading: %s\n"</span>, err.Error())</div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">        <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">if</span> nw, ew := os.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">                fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing: %s\n"</span>, ew.Error())</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-7-defer关闭文件"><a href="#12-7-defer关闭文件" class="headerlink" title="12.7 defer关闭文件"></a>12.7 defer关闭文件</h2><p>函数退出前会执行文件关闭</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">data</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    f, _ := os.Open(name, os.O_RDONLY, <span class="number">0</span>)</div><div class="line">    <span class="keyword">defer</span> f.Close()</div><div class="line">    contents, _ := ioutil.ReadAll(f)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(contents)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-8-fmt-Fprintf"><a href="#12-8-fmt-Fprintf" class="headerlink" title="12.8 fmt.Fprintf"></a>12.8 fmt.Fprintf</h2><p>接口概念阐述例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// unbuffered</span></div><div class="line">    fmt.Fprintf(os.Stdout, <span class="string">"%s\n"</span>, <span class="string">"hello world! - unbuffered"</span>)</div><div class="line">    <span class="comment">// buffered: os.Stdout implements io.Writer</span></div><div class="line">    buf := bufio.NewWriter(os.Stdout)</div><div class="line">    <span class="comment">// and now so does buf.</span></div><div class="line">    fmt.Fprintf(buf, <span class="string">"%s\n"</span>, <span class="string">"hello world! - buffered"</span>)</div><div class="line">    buf.Flush()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>函数签名：<code>func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)</code></p>
</li>
<li><p>第一个参数必须实现io.Writer接口</p>
</li>
</ul>
<h2 id="12-9-json数据格式"><a href="#12-9-json数据格式" class="headerlink" title="12.9 json数据格式"></a>12.9 json数据格式</h2><ul>
<li><p>编码格式JSON，XML，gob等</p>
</li>
<li><p>术语</p>
<ul>
<li>数据结构-&gt;指定格式=序列化或者编码-传输之前</li>
<li>指定格式-&gt;数据结构=反序列化或者解码-传输之后</li>
</ul>
</li>
<li><p>序列化是将内存中的数据结构转换成指定格式</p>
</li>
<li><p>json.Marshal() - 编码，web中使用json.MarshalforHTML()</p>
</li>
<li><p>JSON和go类型对应：</p>
<ul>
<li>bool-boolean</li>
<li>float64-number</li>
<li>string-string</li>
<li>nil-null</li>
</ul>
</li>
<li><p>编码要求：</p>
<ul>
<li>JSON 对象只支持字符串类型的 key；要编码一个 Go map 类型，map 必须是 map[string]T（T是 json 包中支持的任何类型）</li>
<li>Channel，复杂类型和函数类型不能被编码</li>
<li>不支持循环数据结构；它将引起序列化进入一个无限循环</li>
<li>指针可以被编码，实际上是对指针指向的值进行编码（或者指针是 nil）</li>
</ul>
</li>
<li><p>反序列化</p>
<ul>
<li>json.Unmarshal(json, &amp;v)</li>
</ul>
</li>
<li><p>编码和解码流</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewEncoder</span><span class="params">(r io.Writer)</span> *<span class="title">Encoder</span></span></div></pre></td></tr></table></figure>
<ul>
<li>json到文件 encode</li>
<li>文件到json decode</li>
</ul>
<h2 id="12-10-XML数据格式"><a href="#12-10-XML数据格式" class="headerlink" title="12.10 XML数据格式"></a>12.10 XML数据格式</h2><ul>
<li>encoding/xml包含了xml解析器来解析xml内容</li>
<li>marshal()，unMarshal()完成数据结构和xml内容的转换</li>
<li>xml中的标签<ul>
<li>StartElement</li>
<li>Chardata</li>
<li>EndElement</li>
<li>Comment</li>
<li>Directive</li>
<li>ProcInst</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    input := <span class="string">"&lt;Person&gt;&lt;FirstName&gt;Laura&lt;/FirstName&gt;&lt;LastName&gt;Lynn&lt;/LastName&gt;&lt;/Person&gt;"</span></div><div class="line">    inputReader := strings.NewReader(input)</div><div class="line">    p := xml.NewDecoder(inputReader)</div><div class="line">    <span class="keyword">for</span> t, err = p.Token(); err == <span class="literal">nil</span>; t, err = p.Token() &#123;</div><div class="line">        <span class="keyword">switch</span> token := t.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> xml.StartElement:</div><div class="line">            name := token.Name.Local</div><div class="line">            fmt.Printf(<span class="string">"Token name: %s\n"</span>, name)</div><div class="line">            <span class="keyword">for</span> _, attr := <span class="keyword">range</span> token.Attr &#123;</div><div class="line">                attrName := attr.Name.Local</div><div class="line">                attrValue := attr.Value</div><div class="line">                fmt.Printf(<span class="string">"An attribute is: %s %s\n"</span>, attrName, attrValue)</div><div class="line">                <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">        <span class="keyword">case</span> xml.EndElement:</div><div class="line">            fmt.Println(<span class="string">"End of token"</span>)</div><div class="line">        <span class="keyword">case</span> xml.CharData:</div><div class="line">            content := <span class="keyword">string</span>([]<span class="keyword">byte</span>(token))</div><div class="line">            fmt.Printf(<span class="string">"This is the content: %v\n"</span>, content)</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Gob传输数据"><a href="#Gob传输数据" class="headerlink" title="Gob传输数据"></a>Gob传输数据</h2><ul>
<li>Gob是go自己的以二进制形式序列化和反序列化程序数据的格式</li>
<li>Gob通常用于远程调用参数和结果的传输，机器和程序之间的数据传输</li>
<li>Gob只用于go语言中</li>
<li>Gob 文件或流是完全自描述的：里面包含的所有类型都有一个对应的描述，并且总是可以用 Go 解码，而不需要了解文件的内容。</li>
<li>可导出字段会被编码，零值会被忽略</li>
<li>Gob 使用通用的 io.Writer 接口，通过 NewEncoder() 函数创建 Encoder 对象并调用 Encode()；相反的过程使用通用的 io.Reader 接口，通过 NewDecoder() 函数创建 Decoder 对象并调用 Decode()</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> P <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y, Z <span class="keyword">int</span></div><div class="line">    Name    <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Q <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y *<span class="keyword">int32</span></div><div class="line">    Name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// Initialize the encoder and decoder.  Normally enc and dec would be</span></div><div class="line">    <span class="comment">// bound to network connections and the encoder and decoder would</span></div><div class="line">    <span class="comment">// run in different processes.</span></div><div class="line">    <span class="keyword">var</span> network bytes.Buffer   <span class="comment">// Stand-in for a network connection</span></div><div class="line">    enc := gob.NewEncoder(&amp;network) <span class="comment">// Will write to network.</span></div><div class="line">    dec := gob.NewDecoder(&amp;network)    <span class="comment">// Will read from network.</span></div><div class="line">    <span class="comment">// Encode (send) the value.</span></div><div class="line">    err := enc.Encode(P&#123;<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">"Pythagoras"</span>&#125;)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"encode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Decode (receive) the value.</span></div><div class="line">    <span class="keyword">var</span> q Q</div><div class="line">    err = dec.Decode(&amp;q)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"decode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"%q: &#123;%d,%d&#125;\n"</span>, q.Name, *q.X, *q.Y)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编码到文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> &#123;</div><div class="line">    Type             <span class="keyword">string</span></div><div class="line">    City             <span class="keyword">string</span></div><div class="line">    Country          <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> VCard <span class="keyword">struct</span> &#123;</div><div class="line">    FirstName    <span class="keyword">string</span></div><div class="line">    LastName    <span class="keyword">string</span></div><div class="line">    Addresses    []*Address</div><div class="line">    Remark        <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> content    <span class="keyword">string</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    pa := &amp;Address&#123;<span class="string">"private"</span>, <span class="string">"Aartselaar"</span>,<span class="string">"Belgium"</span>&#125;</div><div class="line">    wa := &amp;Address&#123;<span class="string">"work"</span>, <span class="string">"Boom"</span>, <span class="string">"Belgium"</span>&#125;</div><div class="line">    vc := VCard&#123;<span class="string">"Jan"</span>, <span class="string">"Kersschot"</span>, []*Address&#123;pa,wa&#125;, <span class="string">"none"</span>&#125;</div><div class="line">    <span class="comment">// fmt.Printf("%v: \n", vc) // &#123;Jan Kersschot [0x126d2b80 0x126d2be0] none&#125;:</span></div><div class="line">    <span class="comment">// using an encoder:</span></div><div class="line">    file, _ := os.OpenFile(<span class="string">"vcard.gob"</span>, os.O_CREATE|os.O_WRONLY, <span class="number">0666</span>)</div><div class="line">    <span class="keyword">defer</span> file.Close()</div><div class="line">    enc := gob.NewEncoder(file)</div><div class="line">    err := enc.Encode(vc)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Println(<span class="string">"Error in encoding gob"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-12-go中的密码学"><a href="#12-12-go中的密码学" class="headerlink" title="12.12 go中的密码学"></a>12.12 go中的密码学</h2><ul>
<li>hash 包：实现了 adler32、crc32、crc64 和 fnv 校验；</li>
<li>crypto 包：实现了其它的 hash 算法，比如 md4、md5、sha1 等。以及完整地实现了 aes、blowfish、rc4、rsa、xtea 等加密算法。</li>
<li>sha1</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    hasher := sha1.New()</div><div class="line">    io.WriteString(hasher, <span class="string">"test"</span>)</div><div class="line">    b := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, hasher.Sum(b))</div><div class="line">    fmt.Printf(<span class="string">"Result: %d\n"</span>, hasher.Sum(b))</div><div class="line">    <span class="comment">//</span></div><div class="line">    hasher.Reset()</div><div class="line">    data := []<span class="keyword">byte</span>(<span class="string">"We shall overcome!"</span>)</div><div class="line">    n, err := hasher.Write(data)</div><div class="line">    <span class="keyword">if</span> n!=<span class="built_in">len</span>(data) || err!=<span class="literal">nil</span> &#123;</div><div class="line">        log.Printf(<span class="string">"Hash write error: %v / %v"</span>, n, err)</div><div class="line">    &#125;</div><div class="line">    checksum := hasher.Sum(b)</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, checksum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第13章-错误处理与测试"><a href="#第13章-错误处理与测试" class="headerlink" title="第13章 错误处理与测试"></a>第13章 错误处理与测试</h1><ul>
<li>go没有try-catch-finally机制</li>
<li>go有defer-panic-and-recover机制</li>
<li>永远不要忽略错误，否则可能会导致程序崩溃！！</li>
<li>普通错误通过返回值来返回</li>
<li>真正的异常用panic和recover来处理</li>
<li>产生错误的函数会返回两个变量，一个值和一个错误码；如果后者是 nil 就是成功，非 nil 就是发生了错误。</li>
<li>为了防止发生错误时正在执行的函数（如果有必要的话甚至会是整个程序）被中止，在调用函数后必须检查错误。</li>
</ul>
<h2 id="13-1-错误处理"><a href="#13-1-错误处理" class="headerlink" title="13.1 错误处理"></a>13.1 错误处理</h2><ul>
<li>go中的error接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</div><div class="line">    Error() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="13-1-1-定义错误"><a href="#13-1-1-定义错误" class="headerlink" title="13.1.1 定义错误"></a>13.1.1 定义错误</h3><ul>
<li>新建：<code>err := errors.New(&quot;error string&quot;)</code></li>
<li>自定义error</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PathError records an error and the operation and file path that caused it.</span></div><div class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</div><div class="line">    Op <span class="keyword">string</span>    <span class="comment">// "open", "unlink", etc.</span></div><div class="line">    Path <span class="keyword">string</span>  <span class="comment">// The associated file.</span></div><div class="line">    Err error  <span class="comment">// Returned by the system call.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PathError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> e.Op + <span class="string">" "</span> + e.Path + <span class="string">": "</span>+ e.Err.Error()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>错误类型以<code>Error</code>结尾，错误变量以<code>err</code>或者<code>Err</code>开头</li>
</ul>
<h3 id="13-1-2-用fmt创建错误对象"><a href="#13-1-2-用fmt创建错误对象" class="headerlink" title="13.1.2 用fmt创建错误对象"></a>13.1.2 用fmt创建错误对象</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Errorf(<span class="string">"math: square root of negative number %g"</span>, f)</div></pre></td></tr></table></figure>
<h2 id="13-2-运行时异常和panic"><a href="#13-2-运行时异常和panic" class="headerlink" title="13.2 运行时异常和panic"></a>13.2 运行时异常和panic</h2><ul>
<li>运行时异常：数组越界，断言失败等会触发panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Starting the program</div><div class="line"><span class="built_in">panic</span>: A severe error occurred: stopping the program!</div><div class="line"><span class="built_in">panic</span> PC=<span class="number">0x4f</span>3038</div><div class="line">runtime.<span class="built_in">panic</span>+<span class="number">0x99</span> /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">1032</span></div><div class="line">       runtime.<span class="built_in">panic</span>(<span class="number">0x442938</span>, <span class="number">0x4f</span>08e8)</div><div class="line">main.main+<span class="number">0xa5</span> E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.<span class="keyword">go</span>:<span class="number">8</span></div><div class="line">       main.main()</div><div class="line">runtime.mainstart+<span class="number">0xf</span> <span class="number">386</span>/asm.s:<span class="number">84</span></div><div class="line">       runtime.mainstart()</div><div class="line">runtime.goexit /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">148</span></div><div class="line">       runtime.goexit()</div><div class="line">---- Error run E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.exe with code Crashed</div><div class="line">---- Program exited with code <span class="number">-1073741783</span></div></pre></td></tr></table></figure>
<ul>
<li>Go panicking：在多层嵌套的函数调用中调用 panic，可以马上中止当前函数的执行，所有的 defer 语句都会保证执行并把控制权交还给接收到 panic 的函数调用者。这样向上冒泡直到最顶层，并执行（每层的） defer，在栈顶处程序崩溃，并在命令行中用传给 panic 的值报告错误情况：这个终止过程就是 panicking</li>
</ul>
<h2 id="13-3-recover"><a href="#13-3-recover" class="headerlink" title="13.3 recover"></a>13.3 recover</h2><ul>
<li>recover用于从panic中恢复，停止终止过程，恢复正常执行</li>
<li>recover中能在defer修饰的函数中使用，用来取得panic调用中传递过来的错误值，如果是正常执行，调用recover会返回nil，不会生效</li>
<li>panic 会导致栈被展开直到 defer 修饰的 recover() 被调用或者程序中止。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, err)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g() <span class="comment">//   possible runtime-error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>recover和catch很像</li>
<li>defer-panic-recover 在某种意义上也是一种像 if，for 这样的控制流机制</li>
</ul>
<h2 id="13-4-自定义包中的错误处理和panicking"><a href="#13-4-自定义包中的错误处理和panicking" class="headerlink" title="13.4 自定义包中的错误处理和panicking"></a>13.4 自定义包中的错误处理和panicking</h2><ul>
<li>最佳实践<ul>
<li>在包的内部，总是应该从panic中recover，不允许显式的超出包范围的panic()</li>
<li>向包的调用者返回错误值，而不是panic</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// parse.go</span></div><div class="line"><span class="keyword">package</span> parse</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">    <span class="string">"strconv"</span></div><div class="line">)</div><div class="line"><span class="comment">// A ParseError indicates an error in converting a word into an integer.</span></div><div class="line"><span class="keyword">type</span> ParseError <span class="keyword">struct</span> &#123;</div><div class="line">    Index <span class="keyword">int</span>      <span class="comment">// The index into the space-separated list of words.</span></div><div class="line">    Word  <span class="keyword">string</span>   <span class="comment">// The word that generated the parse error.</span></div><div class="line">    Err error <span class="comment">// The raw error that precipitated this error, if any.</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// String returns a human-readable error message.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ParseError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"pkg parse: error parsing %q as int"</span>, e.Word)</div><div class="line">&#125;</div><div class="line"><span class="comment">// Parse parses the space-separated words in in put as integers.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">            err, ok = r.(error)</div><div class="line">            <span class="keyword">if</span> !ok &#123;</div><div class="line">                err = fmt.Errorf(<span class="string">"pkg: %v"</span>, r)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fields := strings.Fields(input)</div><div class="line">    numbers = fields2numbers(fields)</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fields2numbers</span><span class="params">(fields []<span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(fields) == <span class="number">0</span> &#123;</div><div class="line">        <span class="built_in">panic</span>(<span class="string">"no words to parse"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> idx, field := <span class="keyword">range</span> fields &#123;</div><div class="line">        num, err := strconv.Atoi(field)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="built_in">panic</span>(&amp;ParseError&#123;idx, field, err&#125;)</div><div class="line">        &#125;</div><div class="line">        numbers = <span class="built_in">append</span>(numbers, num)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// panic_package.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"./parse/parse"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> examples = []<span class="keyword">string</span>&#123;</div><div class="line">            <span class="string">"1 2 3 4 5"</span>,</div><div class="line">            <span class="string">"100 50 25 12.5 6.25"</span>,</div><div class="line">            <span class="string">"2 + 2 = 4"</span>,</div><div class="line">            <span class="string">"1st class"</span>,</div><div class="line">            <span class="string">""</span>,</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> _, ex := <span class="keyword">range</span> examples &#123;</div><div class="line">        fmt.Printf(<span class="string">"Parsing %q:\n  "</span>, ex)</div><div class="line">        nums, err := parse.Parse(ex)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(err) <span class="comment">// here String() method from ParseError is used</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(nums)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-5-一种用闭包处理错误的模式"><a href="#13-5-一种用闭包处理错误的模式" class="headerlink" title="13.5 一种用闭包处理错误的模式"></a>13.5 一种用闭包处理错误的模式</h2><ul>
<li>每当函数返回时，我们检查是否有错误发生，会很繁琐</li>
<li>defer/panic/recover和闭包可以优雅的解决这个问题，但是要求所有函数都是同一种签名才可以</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    f()</div><div class="line">    fmt.Println(<span class="string">"Returned normally from f."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(<span class="string">"Recovered in f"</span>, r)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fmt.Println(<span class="string">"Calling g."</span>)</div><div class="line">    g(<span class="number">0</span>)</div><div class="line">    fmt.Println(<span class="string">"Returned normally from g."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Panicking!"</span>)</div><div class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v"</span>, i))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"Defer in g"</span>, i)</div><div class="line">    fmt.Println(<span class="string">"Printing in g"</span>, i)</div><div class="line">    g(i + <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">Calling g.</span></div><div class="line"><span class="comment">Printing in g 0</span></div><div class="line"><span class="comment">Printing in g 1</span></div><div class="line"><span class="comment">Printing in g 2</span></div><div class="line"><span class="comment">Printing in g 3</span></div><div class="line"><span class="comment">Panicking!</span></div><div class="line"><span class="comment">Defer in g 3</span></div><div class="line"><span class="comment">Defer in g 2</span></div><div class="line"><span class="comment">Defer in g 1</span></div><div class="line"><span class="comment">Defer in g 0</span></div><div class="line"><span class="comment">Recovered in f 4</span></div><div class="line"><span class="comment">Returned normally from f.</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="13-6-启动外部命令和程序"><a href="#13-6-启动外部命令和程序" class="headerlink" title="13.6 启动外部命令和程序"></a>13.6 启动外部命令和程序</h2><ul>
<li>os包又一个StartProcess函数可以调用或者启动外部系统命令和二进制可执行文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// exec.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os/exec"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"><span class="comment">// 1) os.StartProcess //</span></div><div class="line"><span class="comment">/*********************/</span></div><div class="line"><span class="comment">/* Linux: */</span></div><div class="line">    env := os.Environ()</div><div class="line">    procAttr := &amp;os.ProcAttr&#123;</div><div class="line">               Env: env,</div><div class="line">               Files: []*os.File&#123;</div><div class="line">                   os.Stdin,</div><div class="line">                   os.Stdout,</div><div class="line">                   os.Stderr,</div><div class="line">               &#125;,</div><div class="line">           &#125;</div><div class="line">    <span class="comment">// 1st example: list files</span></div><div class="line">    pid, err := os.StartProcess(<span class="string">"/bin/ls"</span>, []<span class="keyword">string</span>&#123;<span class="string">"ls"</span>, <span class="string">"-l"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line">    <span class="comment">// 2nd example: show all processes</span></div><div class="line">    pid, err = os.StartProcess(<span class="string">"/bin/ps"</span>, []<span class="keyword">string</span>&#123;<span class="string">"-e"</span>, <span class="string">"-opid,ppid,comm"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line"><span class="comment">/* Output 1st:</span></div><div class="line"><span class="comment">The process id is &amp;&#123;2054 0&#125;total 2056</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo 1157555 2011-07-04 16:48 Mieken_exec</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo    2124 2011-07-04 16:48 Mieken_exec.go</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo   18528 2011-07-04 16:48 Mieken_exec_go_.6</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo  913920 2011-06-03 16:13 panic.exe</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo     180 2011-04-11 20:39 panic.go</span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="comment">// 2) exec.Run //</span></div><div class="line"><span class="comment">/***************/</span></div><div class="line"><span class="comment">// Linux:  OK, but not for ls ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls", "-l")  // no error, but doesn't show anything ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls")          // no error, but doesn't show anything ?</span></div><div class="line">    cmd := exec.Command(<span class="string">"gedit"</span>)  <span class="comment">// this opens a gedit-window</span></div><div class="line">    err = cmd.Run()</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Error %v executing command!"</span>, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The command is %v"</span>, cmd)</div><div class="line"><span class="comment">// The command is &amp;&#123;/bin/ls [ls -l] []  &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0xf840000210 &lt;nil&gt; true [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [] [] 0xf8400128c0&#125;</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// in Windows: uitvoering: Error fork/exec /bin/ls: The system cannot find the path specified. starting process!</span></div></pre></td></tr></table></figure>
<h2 id="13-7-go中的单元测试和基准测试"><a href="#13-7-go中的单元测试和基准测试" class="headerlink" title="13.7 go中的单元测试和基准测试"></a>13.7 go中的单元测试和基准测试</h2><ul>
<li>testing包是用来进行自动化测试，日志和错误报告的</li>
<li>单元测试文件名为<code>*_test.go</code>，测试文件不会被普通的go编译器编译，不会被部署，只会被gotest编译</li>
<li><code>func TestAbcde(t *testing.T)</code></li>
<li>测试失败<ul>
<li><code>Fail</code> 失败继续执行</li>
<li><code>FailNow</code>失败终止执行，继续执行下一个文件</li>
<li><code>Log</code> 打印到错误日志</li>
<li><code>Fatal</code> Log+FailNow</li>
</ul>
</li>
<li>基准测试函数 <code>BenchmarkReverse()</code> 用<code>go test -test.bench=.*</code>来执行基准函数</li>
</ul>
<h2 id="13-8-测试实例"><a href="#13-8-测试实例" class="headerlink" title="13.8 测试实例"></a>13.8 测试实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> even</div><div class="line"><span class="keyword">import</span> <span class="string">"testing"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEven</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Even(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 must be even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Even(<span class="number">7</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 7 is not even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOdd</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Odd(<span class="number">11</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 11 must be odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Odd(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 is not odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试用例需要覆盖<ul>
<li>正常的用例</li>
<li>反面的用例</li>
<li>边界检查用例</li>
</ul>
</li>
</ul>
<h2 id="13-9-用测试数据表驱动测试"><a href="#13-9-用测试数据表驱动测试" class="headerlink" title="13.9 用测试数据表驱动测试"></a>13.9 用测试数据表驱动测试</h2><ul>
<li>将测试的输入数据和期望的结果写在一起组成一个数据表，数据表中的每条记录都是一个含有输入和期望值的完整测试用例</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> tests = []<span class="keyword">struct</span>&#123;     <span class="comment">// Test table</span></div><div class="line">    in  <span class="keyword">string</span></div><div class="line">    out <span class="keyword">string</span></div><div class="line">&#125;&#123;</div><div class="line">    &#123;<span class="string">"in1"</span>, <span class="string">"exp1"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in2"</span>, <span class="string">"exp2"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in3"</span>, <span class="string">"exp3"</span>&#125;,</div><div class="line">...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFunction</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">        s := FuncToBeTested(tt.in)</div><div class="line">        <span class="keyword">if</span> s != tt.out &#123;</div><div class="line">            t.Errorf(<span class="string">"%d. %q =&gt; %q, wanted: %q"</span>, i, tt.in, s, tt.out)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-10-性能调试：分析并优化go程序"><a href="#13-10-性能调试：分析并优化go程序" class="headerlink" title="13.10 性能调试：分析并优化go程序"></a>13.10 性能调试：分析并优化go程序</h2><h3 id="13-10-1-时间和内存消耗"><a href="#13-10-1-时间和内存消耗" class="headerlink" title="13.10.1 时间和内存消耗"></a>13.10.1 时间和内存消耗</h3><ul>
<li><code>/usr/bin/time -f &#39;%Uu %Ss %er %MkB %C&#39; goprogexec</code> 用户时间，系统时间，实际时间，最大内存占用</li>
</ul>
<h3 id="13-10-2-go-test调试"><a href="#13-10-2-go-test调试" class="headerlink" title="13.10.2 go test调试"></a>13.10.2 go test调试</h3><ul>
<li>go test -x -v -cpuprofile=prof.out -file x_test.go</li>
</ul>
<h3 id="13-10-3-pprof调试"><a href="#13-10-3-pprof调试" class="headerlink" title="13.10.3 pprof调试"></a>13.10.3 pprof调试</h3><ul>
<li>pprof运行时报告数据</li>
<li>有用的命令<ul>
<li>topN - 分析结果中最开头的N份样本</li>
<li>web - 调用统计，浏览器打开</li>
<li>list - 代码行数和执行消耗时间</li>
</ul>
</li>
</ul>
<h2 id="第14章-协程和通道"><a href="#第14章-协程和通道" class="headerlink" title="第14章 协程和通道"></a>第14章 协程和通道</h2><p>不需要共享内存来通信，而是通过通信来共享内存。</p>
<h3 id="14-1-并发，并行和协程"><a href="#14-1-并发，并行和协程" class="headerlink" title="14.1 并发，并行和协程"></a>14.1 并发，并行和协程</h3><ul>
<li>不要使用全局变量或者共享内存，会给你代码在并发运算时带来风险</li>
<li>go中使用goroutine进行并发运算</li>
<li>协程和操作系统的线程不是一对一的关系，协程是根据一个或多个线程的可用性，映射（多路复用，执行于）在他们之上的；协程调度器在 Go 运行时很好的完成了这个工作。</li>
<li>协程工作在相同的地址空间中，所以共享内存的方式一定是同步的</li>
<li>go使用channel来同步协程</li>
<li>当系统调用阻塞协程时，其他协程会继续在其他线程上工作</li>
<li>协程比线程更轻量级，4K的内存就可以创建一个协程</li>
<li>协程通过关键字go来创建</li>
<li>协程的栈会根据需要进行伸缩，不会溢出，结束会自动退出清理</li>
<li>main可以看做一个协程</li>
<li>init函数中可以运行协程</li>
<li>并发程序可能并行，也可能不是</li>
<li>并行是一种通过多处理器来提高速度的能力</li>
<li><p>go中设置GOMASXPROCS来支持多个系统线程的应用，n个核设置GOMAXPROCS=n-1</p>
</li>
<li><p>Go 协程意味着并行（或者可以以并行的方式部署），协程一般来说不是这样的</p>
</li>
<li>Go 协程通过通道来通信；协程通过让出和恢复操作来通信</li>
</ul>
<h3 id="14-2-协程间的通信"><a href="#14-2-协程间的通信" class="headerlink" title="14.2 协程间的通信"></a>14.2 协程间的通信</h3><h3 id="14-2-1-概念"><a href="#14-2-1-概念" class="headerlink" title="14.2.1 概念"></a>14.2.1 概念</h3><ul>
<li>通道（channel），就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。 数据的所有权（可以读写数据的能力）也因此被传递。</li>
<li>channel未初始化未nil</li>
<li>channel只能传递一种类型的数据</li>
<li>channel实际上是类型化消息的队列，使数据得以传输。它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</li>
<li>channel是引用类型，make来初始化 <code>ch1 := make(chan string)</code></li>
</ul>
<h3 id="14-2-2-通信操作符-lt"><a href="#14-2-2-通信操作符-lt" class="headerlink" title="14.2.2 通信操作符&lt;-"></a>14.2.2 通信操作符<code>&lt;-</code></h3><ul>
<li>数据是按照箭头的方向流动的<ul>
<li><code>ch &lt;-int1</code></li>
<li><code>int2 := &lt;- ch</code></li>
<li><code>&lt;-ch</code></li>
</ul>
</li>
<li>channel的收发都是原子操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    <span class="keyword">go</span> getData(ch)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokyo"</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></div><div class="line">    <span class="comment">// time.Sleep(2e9)</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input = &lt;-ch</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>协程的同步：<ul>
<li>main() 等待了 1 秒让两个协程完成，如果不这样，sendData() 就没有机会输出。</li>
<li>getData() 使用了无限循环：它随着 sendData() 的发送完成和 ch 变空也结束了。</li>
<li>如果我们移除一个或所有 go 关键字，程序无法运行，Go 运行时会抛出 panic：</li>
</ul>
</li>
</ul>
<h3 id="14-2-3-通道阻塞"><a href="#14-2-3-通道阻塞" class="headerlink" title="14.2.3 通道阻塞"></a>14.2.3 通道阻塞</h3><ul>
<li>通道默认是同步且无缓冲的：接收者接收数据之前，发送不会结束。通道的发送和接收操作都是在对方准备好之前是阻塞的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump(ch1)       <span class="comment">// pump hangs</span></div><div class="line">    fmt.Println(&lt;-ch1) <span class="comment">// prints only 0</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 0</span></div></pre></td></tr></table></figure>
<h3 id="14-2-4-通过channel进行协程同步"><a href="#14-2-4-通过channel进行协程同步" class="headerlink" title="14.2.4 通过channel进行协程同步"></a>14.2.4 通过channel进行协程同步</h3><ul>
<li>通过channel，两个协程在通信中的某刻同步交换数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Println(&lt;-in)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    out &lt;- <span class="number">2</span></div><div class="line">    <span class="keyword">go</span> f1(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-5-同步通道-使用带缓冲的通道"><a href="#14-2-5-同步通道-使用带缓冲的通道" class="headerlink" title="14.2.5 同步通道-使用带缓冲的通道"></a>14.2.5 同步通道-使用带缓冲的通道</h3><ul>
<li><code>ch1 := make(chan string, buf)</code> buf为个数</li>
<li>在缓冲满载之前，给通道发送数据是不会被阻塞的</li>
<li>在缓冲空之前，读取是不会阻塞的</li>
</ul>
<h3 id="14-2-6-协程中用通道输出结果"><a href="#14-2-6-协程中用通道输出结果" class="headerlink" title="14.2.6 协程中用通道输出结果"></a>14.2.6 协程中用通道输出结果</h3><p>用通道来完成阻塞</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> sum(bigArray, ch) <span class="comment">// bigArray puts the calculated sum on ch</span></div><div class="line"><span class="comment">// .. do something else for a while</span></div><div class="line">sum := &lt;- ch <span class="comment">// wait for, and retrieve the sum</span></div></pre></td></tr></table></figure>
<h3 id="14-2-7-信号量模式"><a href="#14-2-7-信号量模式" class="headerlink" title="14.2.7 信号量模式"></a>14.2.7 信号量模式</h3><ul>
<li>协程通过在通道中放置一个值来处理结束的信号</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">compute</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</div><div class="line">    ch &lt;- someComputation() <span class="comment">// when it completes, signal on the channel.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// allocate a channel.</span></div><div class="line">    <span class="keyword">go</span> compute(ch)        <span class="comment">// stat something in a goroutines</span></div><div class="line">    doSomethingElseForAWhile()</div><div class="line">    result := &lt;- ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-实现并行的for循环"><a href="#14-2-8-实现并行的for循环" class="headerlink" title="14.2.8 实现并行的for循环"></a>14.2.8 实现并行的for循环</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> data &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">(i <span class="keyword">int</span>, v <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">        doSomething(i, v)</div><div class="line">        ...</div><div class="line">    &#125; (i, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-用带缓冲通道实现一个信号量"><a href="#14-2-8-用带缓冲通道实现一个信号量" class="headerlink" title="14.2.8 用带缓冲通道实现一个信号量"></a>14.2.8 用带缓冲通道实现一个信号量</h3><ul>
<li>信号量是实现互斥锁常见的同步机制<ul>
<li>带缓冲通道的容量和要同步的资源容量相同</li>
<li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li>
<li>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    stream := pump()</div><div class="line">    <span class="keyword">go</span> suck(stream)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(&lt;-ch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-10-给通道使用for循环"><a href="#14-2-10-给通道使用for循环" class="headerlink" title="14.2.10 给通道使用for循环"></a>14.2.10 给通道使用for循环</h3><ul>
<li>for-range</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">    fmt.Printf(<span class="string">"The value is %v\n"</span>, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    suck(pump())</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-2-11-通道的方向"><a href="#14-2-11-通道的方向" class="headerlink" title="14.2.11 通道的方向"></a>14.2.11 通道的方向</h2><ul>
<li>只接收：<code>var recv_noly &lt;-chan int</code></li>
<li>只发送：<code>var send_only chan&lt;- int</code></li>
</ul>
<h2 id="14-3-协程的同步：关闭通道-测试阻塞的通道"><a href="#14-3-协程的同步：关闭通道-测试阻塞的通道" class="headerlink" title="14.3 协程的同步：关闭通道-测试阻塞的通道"></a>14.3 协程的同步：关闭通道-测试阻塞的通道</h2><ul>
<li>通道可以被显示的关闭</li>
<li>发送者需要关闭通道，接收者不需要</li>
<li>关闭方法：defer close(ch)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    getData(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokio"</span></div><div class="line">    <span class="built_in">close</span>(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input, open := &lt;-ch</div><div class="line">        <span class="keyword">if</span> !open &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>for-range来读取通道会检测通道是否会关闭</li>
</ul>
<h2 id="14-4-使用select切换协程"><a href="#14-4-使用select切换协程" class="headerlink" title="14.4 使用select切换协程"></a>14.4 使用select切换协程</h2><ul>
<li>select 被称为通信开关</li>
<li>select可以处理多个通信中的一个</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump1(ch1)</div><div class="line">    <span class="keyword">go</span> pump2(ch2)</div><div class="line">    <span class="keyword">go</span> suck(ch1, ch2)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i * <span class="number">2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i + <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch1, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch1:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 1: %d\n"</span>, v)</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch2:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 2: %d\n"</span>, v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-5-通道、超时和计时器"><a href="#14-5-通道、超时和计时器" class="headerlink" title="14.5 通道、超时和计时器"></a>14.5 通道、超时和计时器</h2><ul>
<li>time.Ticker结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ticker <span class="keyword">struct</span> &#123;</div><div class="line">    C &lt;-<span class="keyword">chan</span> Time <span class="comment">// the channel on which the ticks are delivered.</span></div><div class="line">    <span class="comment">// contains filtered or unexported fields</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以返回一个通道并且不关闭</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rate_per_sec := <span class="number">10</span></div><div class="line"><span class="keyword">var</span> dur Duration = <span class="number">1e9</span></div><div class="line">chRate := time.Tick(dur)</div><div class="line"><span class="keyword">for</span> req := <span class="keyword">range</span> requests &#123;</div><div class="line">    &lt;- chRate</div><div class="line">    <span class="keyword">go</span> client.Call(<span class="string">"Service.Method"</span>, req, ...)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现了按照指定频率处理请求</p>
<ul>
<li>Timer和Ticker类似，但是只会发送一次时间，可以应用在超时模式中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">    timeout&lt;-<span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line"></div><div class="line">    <span class="keyword">case</span> &lt;-timeout</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-6-协程和恢复"><a href="#14-6-协程和恢复" class="headerlink" title="14.6 协程和恢复"></a>14.6 协程和恢复</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(workChan &lt;-<span class="keyword">chan</span> *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> work := <span class="keyword">range</span> workChan &#123;</div><div class="line">        <span class="keyword">go</span> safelyDo(work)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">safelyDo</span><span class="params">(work *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err := revocer(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">""</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    do(work)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>一个协程发生panic会继续执行其他的协程</em></p>
<h2 id="14-7-新旧模型对比"><a href="#14-7-新旧模型对比" class="headerlink" title="14.7 新旧模型对比"></a>14.7 新旧模型对比</h2><h3 id="旧模式-使用共享内存来进行同步"><a href="#旧模式-使用共享内存来进行同步" class="headerlink" title="旧模式 - 使用共享内存来进行同步"></a>旧模式 - 使用共享内存来进行同步</h3><ul>
<li>首先定义一个结构体处理一个任务</li>
<li>各个任务组成任务池来共享内存，引入锁机制</li>
<li>任务数量巨大，则锁机制的开销会导致效率急剧下降</li>
</ul>
<h3 id="新模式-使用通道"><a href="#新模式-使用通道" class="headerlink" title="新模式 - 使用通道"></a>新模式 - 使用通道</h3><ul>
<li>使用一个通道接受需要处理的任务，一个通道接受处理完成的任务及其结果。worker在协程中启动，数量N可以调整</li>
<li>不使用锁的机制，因为从通道获取到新任务不存在竞争关系</li>
<li>我理解实际上锁机制是实现在了channel中，一个channel的获取是原子性的，从而提高性能</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Worker的写法, Master -&gt; Workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;- in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用锁的情景：<ul>
<li>访问共享数据结构中的缓存信息</li>
<li>保存应用程序上下文和状态信息数据</li>
</ul>
</li>
<li>使用通道的情景<ul>
<li>与异步操作的结果进行交互</li>
<li>分发任务</li>
<li>传递数据所有权</li>
</ul>
</li>
</ul>
<h2 id="14-8-惰性生成器的实现"><a href="#14-8-惰性生成器的实现" class="headerlink" title="14.8 惰性生成器的实现"></a>14.8 惰性生成器的实现</h2><ul>
<li>生成器是指当被调用时返回一个序列中下一个值的函数，也被称为惰性求值</li>
<li>int channel实现的生成器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> resume <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">integers</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    yield := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    count := <span class="number">0</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            yield &lt;- count</div><div class="line">            count++</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> yield</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateInteger</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    resume = integers()</div><div class="line">    <span class="keyword">return</span> &lt;- resume</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用空接口，闭包和高阶函数可以实现一个通用的惰性生产期的工厂函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> EvalFunc <span class="function"><span class="keyword">func</span><span class="params">(Any)</span> <span class="params">(Any, Any)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">BuildLazyEvaluator</span><span class="params">(evalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">    retValChan := <span class="built_in">make</span>(<span class="keyword">chan</span> Any)</div><div class="line">    loopFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">var</span> actState Any = initState</div><div class="line">        <span class="keyword">var</span> retVal</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            retVal, actState = evalFunc(actState)</div><div class="line">            retValChan &lt;- retVal</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    retFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> &lt;- retValChan</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> loopFunc()</div><div class="line">    <span class="keyword">return</span> retFunc</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildLazyIntEvaluator</span><span class="params">(evalFunc EvalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    ef := BuildLazyIntEvaluator(evalFunc, initState)</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> ef().(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    evenFunc := <span class="function"><span class="keyword">func</span><span class="params">(state Any)</span> <span class="params">(Any, Any)</span></span> &#123;</div><div class="line">        os := state.(<span class="keyword">int</span>)</div><div class="line">        ns := os + <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> os, ns</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    even := BuildLazyIntEvaluator(evenFunc, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        fmt.</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-9-实现Future模式"><a href="#14-9-实现Future模式" class="headerlink" title="14.9 实现Future模式"></a>14.9 实现Future模式</h2><ul>
<li>Future指的是你使用某一个值之前需要先对其进行计算，因此可以提前计算好</li>
<li>求两个矩阵的乘积的逆 -&gt; 先逆运算再乘</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseProduct</span><span class="params">(a, b Matrix)</span></span> &#123;</div><div class="line">    a_inv_future := InverseFuture(a)</div><div class="line">    b_inv_future := InverseFuture(b)</div><div class="line">    a_inv := &lt;- a_inv_future</div><div class="line">    b_inv := &lt;- b_inv_future</div><div class="line">    <span class="keyword">return</span> Product(a_inv, b_inv)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseFuture</span><span class="params">(a Matrix)</span> <span class="title">chan</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">    future := <span class="built_in">make</span>(<span class="keyword">chan</span> Matrix)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        future &lt;- Inverse(a)</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> future</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-10-复用"><a href="#14-10-复用" class="headerlink" title="14.10 复用"></a>14.10 复用</h2><h3 id="CS模式"><a href="#CS模式" class="headerlink" title="CS模式"></a>CS模式</h3><ul>
<li>go中服务器通常会在协程中执行向客户端的响应，故而会对每一个客户端请求启动一个协程，常见操作为客户端请求包含一个通道，服务器向这个通道中发送响应</li>
<li>使用协程可以大大提高QPS</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> binOp <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">run</span><span class="params">(op binOp, req *Request)</span></span> &#123;</div><div class="line">    req.replyc &lt;- op(req.a, req.b)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span> <span class="params">(op binOp, service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        req := &lt;- service</div><div class="line">        <span class="keyword">go</span> run(op, req)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="title">chan</span> *<span class="title">Request</span></span> &#123;</div><div class="line">    reqChan := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(op, reqChan)</div><div class="line">    <span class="keyword">return</span> reqChan</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    adder := startServer(<span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;<span class="keyword">return</span> a + b&#125;)</div><div class="line">    <span class="keyword">const</span> N = <span class="number">100</span></div><div class="line">    <span class="keyword">var</span> reqs [n]Request</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; N; i++ &#123;</div><div class="line">        req := &amp;reqs[i]</div><div class="line">        req.a = i</div><div class="line">        req.b = i + N</div><div class="line">        req.replyc = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        adder &lt;- req</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通过信号通道关闭服务器"><a href="#通过信号通道关闭服务器" class="headerlink" title="通过信号通道关闭服务器"></a>通过信号通道关闭服务器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="params">(service <span class="keyword">chan</span> *Request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    service = <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    quit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">    <span class="keyword">go</span> server(op, service, quit)</div><div class="line">    <span class="keyword">return</span> service, quit</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(op binOp, service <span class="keyword">chan</span> *request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> req := &lt;-service:</div><div class="line">                <span class="keyword">go</span> run(op, req)</div><div class="line">            <span class="keyword">case</span> &lt;- quit:</div><div class="line">                <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-11-限制同时处理的请求数-带缓冲的通道"><a href="#14-11-限制同时处理的请求数-带缓冲的通道" class="headerlink" title="14.11 限制同时处理的请求数 - 带缓冲的通道"></a>14.11 限制同时处理的请求数 - 带缓冲的通道</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line"><span class="comment">//    ...</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">    process(r)</div><div class="line">    &lt;- sem</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        request := &lt;- service</div><div class="line">        <span class="keyword">go</span> handler(request)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-12-链式协程"><a href="#14-12-链式协程" class="headerlink" title="14.12 链式协程"></a>14.12 链式协程</h2><ul>
<li>海量协程的创建和运行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ngoroutine = flag.Int(<span class="string">"n"</span>, <span class="number">100000</span>, <span class="string">"how many goroutines"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;- right</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">var</span> left, right <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="literal">nil</span>, leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *ngoroutine; i++ &#123;</div><div class="line">        left, right = right, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">    &#125;</div><div class="line">    right &lt;- <span class="number">0</span></div><div class="line">    x := &lt;-leftmost</div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-13-在多核心上并行运算"><a href="#14-13-在多核心上并行运算" class="headerlink" title="14.13 在多核心上并行运算"></a>14.13 在多核心上并行运算</h2><ul>
<li>信号量模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span> &#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU)</div><div class="line">    DOAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-14并行化大量数据的计算"><a href="#14-14并行化大量数据的计算" class="headerlink" title="14.14并行化大量数据的计算"></a>14.14并行化大量数据的计算</h2><ul>
<li>串行处理流水线</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SerialProcessData</span><span class="params">(in &lt;- <span class="keyword">chan</span> *Data, out <span class="keyword">chan</span> &lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> in &#123;</div><div class="line">        tmpA := PreproceeData(data)</div><div class="line">        tmpB := ProcessStepA(tmpA)</div><div class="line">        tmpC := ProcessStepB(tmpB)</div><div class="line">        out &lt;- PostProcessData(tmpC)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParallelProcessData</span><span class="params">(in &lt;-<span class="keyword">chan</span> *Data, out <span class="keyword">chan</span>&lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="comment">// make channels:</span></div><div class="line">    preOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepAOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepBOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepCOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    <span class="comment">// start parallel computations:</span></div><div class="line">    <span class="keyword">go</span> PreprocessData(in, preOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepA(preOut,StepAOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepB(StepAOut,StepBOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepC(StepBOut,StepCOut)</div><div class="line">    <span class="keyword">go</span> PostProcessData(StepCOut,out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-15-漏桶算法"><a href="#14-15-漏桶算法" class="headerlink" title="14.15 漏桶算法"></a>14.15 漏桶算法</h2><ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">client</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">var</span> b *Buffer</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> b = &lt;- freeList</div><div class="line">                <span class="comment">// got one</span></div><div class="line">            <span class="keyword">default</span>: b = <span class="built_in">new</span>(Buffer)</div><div class="line">        &#125;</div><div class="line">        loadInto(b)</div><div class="line">        serverChan &lt;- b</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        b := &lt;-serverChan       <span class="comment">// Wait for work.</span></div><div class="line">        process(b)</div><div class="line">        <span class="comment">// Reuse buffer if there's room.</span></div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> freeList &lt;- b:</div><div class="line">                <span class="comment">// Reuse buffer if free slot on freeList; nothing more to do</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Free list full, just carry on: the buffer is 'dropped'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-16-对go协程进行基准测试"><a href="#14-16-对go协程进行基准测试" class="headerlink" title="14.16 对go协程进行基准测试"></a>14.16 对go协程进行基准测试</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">" sync"</span>, testing.Benchmark(BenchmarkChannelSync).String())</div><div class="line">	fmt.Println(<span class="string">"buffered"</span>, testing.Benchmark(BenchmarkChannelBuffered).String())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelSync</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelBuffered</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-17-使用通道并发访问对象"><a href="#14-17-使用通道并发访问对象" class="headerlink" title="14.17 使用通道并发访问对象"></a>14.17 使用通道并发访问对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name   <span class="keyword">string</span></div><div class="line">	salary <span class="keyword">float64</span></div><div class="line">	chF    <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, salary <span class="keyword">float64</span>)</span> *<span class="title">Person</span></span> &#123;</div><div class="line">	p := &amp;Person&#123;name, salary, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>)&#125;</span></div><div class="line"><span class="function">	<span class="title">go</span> <span class="title">p</span>.<span class="title">backend</span><span class="params">()</span></span></div><div class="line"><span class="function">	<span class="title">return</span> <span class="title">p</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(p *Person)</span> <span class="title">backend</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> f := <span class="keyword">range</span> p.chF &#123;</div><div class="line">		f()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">SetSalary</span><span class="params">(sal <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; p.salary = sal &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Retrieve salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Salary</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	fChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">float64</span>)</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fChan &lt;- p.salary &#125;</div><div class="line">	<span class="keyword">return</span> &lt;-fChan</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"Person - name is: "</span> + p.Name + <span class="string">" - salary is: "</span> + strconv.FormatFloat(p.Salary(), <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">64</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	bs := NewPerson(<span class="string">"Smith Bill"</span>, <span class="number">2500.5</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">	bs.SetSalary(<span class="number">4000.25</span>)</div><div class="line">	fmt.Println(<span class="string">"Salary changed:"</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第15章-网络，模板和网页应用"><a href="#第15章-网络，模板和网页应用" class="headerlink" title="第15章 网络，模板和网页应用"></a>第15章 网络，模板和网页应用</h1><h2 id="15-1-tcp服务器"><a href="#15-1-tcp服务器" class="headerlink" title="15.1 tcp服务器"></a>15.1 tcp服务器</h2><ul>
<li>服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        conn, err := listener.Accept()</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">go</span> doServerStuff(conn)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doServerStuff</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</div><div class="line">        <span class="built_in">len</span>, err := conn.Read(buf)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(<span class="string">"%v"</span>, <span class="keyword">string</span>(buf[:<span class="built_in">len</span>]))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//打开连接:</span></div><div class="line">	conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">//由于目标计算机积极拒绝而无法创建连接</span></div><div class="line">		fmt.Println(<span class="string">"Error dialing"</span>, err.Error())</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 终止程序</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	inputReader := bufio.NewReader(os.Stdin)</div><div class="line">	fmt.Println(<span class="string">"First, what is your name?"</span>)</div><div class="line">	clientName, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">	<span class="comment">// fmt.Printf("CLIENTNAME %s", clientName)</span></div><div class="line">	trimmedClient := strings.Trim(clientName, <span class="string">"\r\n"</span>) <span class="comment">// Windows 平台下用 "\r\n"，Linux平台下使用 "\n"</span></div><div class="line">	<span class="comment">// 给服务器发送信息直到程序退出：</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"What to send to the server? Type Q to quit."</span>)</div><div class="line">		input, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">		trimmedInput := strings.Trim(input, <span class="string">"\r\n"</span>)</div><div class="line">		<span class="comment">// fmt.Printf("input:--%s--", input)</span></div><div class="line">		<span class="comment">// fmt.Printf("trimmedInput:--%s--", trimmedInput)</span></div><div class="line">		<span class="keyword">if</span> trimmedInput == <span class="string">"Q"</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		_, err = conn.Write([]<span class="keyword">byte</span>(trimmedClient + <span class="string">" says: "</span> + trimmedInput))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>改进后的tcp_server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> maxRead = <span class="number">25</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	<span class="keyword">if</span> flag.NArg() != <span class="number">2</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"usage: host port"</span>)</div><div class="line">	&#125;</div><div class="line">	hostAndPort := fmt.Sprintf(<span class="string">"%s:%s"</span>, flag.Arg(<span class="number">0</span>), flag.Arg(<span class="number">1</span>))</div><div class="line">	listener := initServer(hostAndPort)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		conn, err := listener.Accept()</div><div class="line">		checkError(err, <span class="string">"Accept: "</span>)</div><div class="line">		<span class="keyword">go</span> connectionHandler(conn)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initServer</span><span class="params">(hostAndPort <span class="keyword">string</span>)</span> *<span class="title">net</span>.<span class="title">TCPListener</span></span> &#123;</div><div class="line">	serverAddr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, hostAndPort)</div><div class="line">	checkError(err, <span class="string">"Resolving address:port failed: `"</span> + hostAndPort + <span class="string">"'"</span>)</div><div class="line">	listener, err := net.ListenTCP(<span class="string">"tcp"</span>, serverAddr)</div><div class="line">	checkError(err, <span class="string">"ListenTCP: "</span>)</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Listening to:    "</span>, listener.Addr().String())</div><div class="line">	<span class="keyword">return</span> listener</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">connectionHandler</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">	connFrom := conn.RemoteAddr().String()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Connection from: "</span>, connFrom)</div><div class="line">	sayHello(conn)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">var</span> ibuf []<span class="keyword">byte</span> = <span class="built_in">make</span>([]<span class="keyword">byte</span>, maxRead + <span class="number">1</span>)</div><div class="line">		length, err := conn.Read(ibuf[<span class="number">0</span>:maxRead])</div><div class="line">		ibuf[maxRead] = <span class="number">0</span> <span class="comment">// to prevent overflow</span></div><div class="line">		<span class="keyword">switch</span> err &#123;</div><div class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">		   handleMsg(length, err, ibuf)</div><div class="line">		<span class="keyword">case</span> syscall.EAGAIN:  <span class="comment">// try again</span></div><div class="line">		   <span class="keyword">continue</span></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			    <span class="keyword">goto</span> DISCONNECT</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">DISCONNECT:</div><div class="line">	err := conn.Close()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Closed connection: "</span>, connFrom)</div><div class="line">	checkError(err, <span class="string">"Close: "</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">(to net.Conn)</span></span> &#123;</div><div class="line">	obuf := []<span class="keyword">byte</span>&#123;<span class="string">'L'</span>, <span class="string">'e'</span>, <span class="string">'t'</span>, <span class="string">'\''</span>, <span class="string">'s'</span>, <span class="string">' '</span>, <span class="string">'G'</span>, <span class="string">'O'</span>, <span class="string">'!'</span>, <span class="string">'\n'</span>&#125;</div><div class="line">	wrote, err := to.Write(obuf)</div><div class="line">	checkError(err, <span class="string">"Write: wrote "</span> + <span class="keyword">string</span>(wrote) + <span class="string">" bytes."</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMsg</span><span class="params">(length <span class="keyword">int</span>, err error, msg []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> length &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&lt;"</span>, length, <span class="string">":"</span>)</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">			<span class="keyword">if</span> msg[i] == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			fmt.Printf(<span class="string">"%c"</span>, msg[i])</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&gt;"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkError</span><span class="params">(error error, info <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ERROR: "</span> + info + <span class="string">" "</span> + error.Error())  <span class="comment">// terminate goprogram</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-2-简单的网页服务器"><a href="#15-2-简单的网页服务器" class="headerlink" title="15.2 简单的网页服务器"></a>15.2 简单的网页服务器</h2><ul>
<li>net/http包</li>
<li>http.ListenAndServer</li>
<li>http.URL</li>
<li>http.Request</li>
<li>request.FormValue</li>
<li>request.ParseForm</li>
<li>http.HandlerFunc 具体函数 - 对应路径，类似于controller</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Inside HelloServer handler"</span>)</div><div class="line">	fmt.Fprintf(w, <span class="string">"Hello,"</span>+req.URL.Path[<span class="number">1</span>:])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, HelloServer)</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>http.ListenAndServerTLS - https</li>
</ul>
<h2 id="15-3-访问并读取页面"><a href="#15-3-访问并读取页面" class="headerlink" title="15.3 访问并读取页面"></a>15.3 访问并读取页面</h2><ul>
<li><code>http.Head()</code>来请求URL</li>
<li><code>http.Get()</code>获取Body中的网页内容</li>
<li><code>http.Redirect(w RespoonseWriter, r *Request, url string, code int)</code> 浏览器重定向URL</li>
<li><code>http.NotFound(w ResponseWriter, r *Request)</code> 404</li>
<li><code>http.Error(w ResponseWriter, r *Request)</code> 错误信息和错误码</li>
<li><code>http.Request</code></li>
<li><p><code>req.Method</code></p>
</li>
<li><p>go定义的HTTP状态码</p>
<ul>
<li>http.StatusContinue               = 100</li>
<li>http.StatusOK                       = 200</li>
<li>http.StatusFound                   = 302</li>
<li>http.StatusBadRequest            = 400</li>
<li>http.StatusUnauthorized        = 401</li>
<li>http.StatusForbidden            = 403</li>
<li>http.StatusNotFound             = 404</li>
<li>http.StatusInternalServerError    = 500</li>
</ul>
</li>
</ul>
<h2 id="15-4-网页应用"><a href="#15-4-网页应用" class="headerlink" title="15.4 网页应用"></a>15.4 网页应用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> form = <span class="string">`</span></div><div class="line"><span class="string">	&lt;html&gt;&lt;body&gt;</span></div><div class="line"><span class="string">		&lt;form action="#" method="post" name="bar"&gt;</span></div><div class="line"><span class="string">			&lt;input type="text" name="in" /&gt;</span></div><div class="line"><span class="string">			&lt;input type="submit" value="submit"/&gt;</span></div><div class="line"><span class="string">		&lt;/form&gt;</span></div><div class="line"><span class="string">	&lt;/body&gt;&lt;/html&gt;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SimpleServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	io.WriteString(w, <span class="string">"&lt;h1&gt;hello, world&lt;/h1&gt;"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FormServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>)</div><div class="line">	<span class="keyword">switch</span> request.Method &#123;</div><div class="line">	<span class="keyword">case</span> <span class="string">"GET"</span>:</div><div class="line">		io.WriteString(w, form)</div><div class="line">	<span class="keyword">case</span> <span class="string">"POST"</span>:</div><div class="line">		io.WriteString(w, request.FormValue(<span class="string">"in"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/test1"</span>, SimpleServer)</div><div class="line">	http.HandleFunc(<span class="string">"/test2"</span>, FormServer)</div><div class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":8088"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-5-网页应用健壮"><a href="#15-5-网页应用健壮" class="headerlink" title="15.5 网页应用健壮"></a>15.5 网页应用健壮</h2><ul>
<li>使用闭包的错误处理模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> HandleFnc <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">logPanics</span><span class="params">(function HandlerFunc)</span> <span class="title">HandlerFnc</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">                log...</div><div class="line">            &#125;</div><div class="line">        &#125;()</div><div class="line">        function(writer, request)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-6-模板技术动态生成页面"><a href="#15-6-模板技术动态生成页面" class="headerlink" title="15.6 模板技术动态生成页面"></a>15.6 模板技术动态生成页面</h2><ul>
<li>模板缓存</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"regexp"</span></div><div class="line">	<span class="string">"text/template"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> lenPath = <span class="built_in">len</span>(<span class="string">"/view/"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> titleValidator = regexp.MustCompile(<span class="string">"^[a-zA-Z0-9]+$"</span>)</div><div class="line"><span class="keyword">var</span> templates = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*template.Template)</div><div class="line"><span class="keyword">var</span> err error</div><div class="line"></div><div class="line"><span class="keyword">type</span> Page <span class="keyword">struct</span> &#123;</div><div class="line">	Title <span class="keyword">string</span></div><div class="line">	Body  []<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, tmpl := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"edit"</span>, <span class="string">"view"</span>&#125; &#123;</div><div class="line">		templates[tmpl] = template.Must(template.ParseFiles(tmpl + <span class="string">".html"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/view/"</span>, makeHandler(viewHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/edit/"</span>, makeHandler(editHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/save/"</span>, makeHandler(saveHandler))</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeHandler</span><span class="params">(fn <span class="keyword">func</span>(http.ResponseWriter, *http.Request, <span class="keyword">string</span>)</span>) <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		title := r.URL.Path[lenPath:]</div><div class="line">		<span class="keyword">if</span> !titleValidator.MatchString(title) &#123;</div><div class="line">			http.NotFound(w, r)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		fn(w, r, title)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">viewHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// page not found</span></div><div class="line">		http.Redirect(w, r, <span class="string">"/edit/"</span>+title, http.StatusFound)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"view"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">editHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		p = &amp;Page&#123;Title: title&#125;</div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"edit"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	body := r.FormValue(<span class="string">"body"</span>)</div><div class="line">	p := &amp;Page&#123;Title: title, Body: []<span class="keyword">byte</span>(body)&#125;</div><div class="line">	err := p.save()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	http.Redirect(w, r, <span class="string">"/view/"</span>+title, http.StatusFound)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">renderTemplate</span><span class="params">(w http.ResponseWriter, tmpl <span class="keyword">string</span>, p *Page)</span></span> &#123;</div><div class="line">	err := templates[tmpl].Execute(w, p)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Page)</span> <span class="title">save</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	filename := p.Title + <span class="string">".txt"</span></div><div class="line">	<span class="comment">// file created with read-write permissions for the current user only</span></div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filename, p.Body, <span class="number">0600</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">(title <span class="keyword">string</span>)</span> <span class="params">(*Page, error)</span></span> &#123;</div><div class="line">	filename := title + <span class="string">".txt"</span></div><div class="line">	body, err := ioutil.ReadFile(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Page&#123;Title: title, Body: body&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-7-template包-先不看"><a href="#15-7-template包-先不看" class="headerlink" title="15.7 template包 - 先不看"></a>15.7 template包 - 先不看</h2><h2 id="15-8-多功能网页服务器"><a href="#15-8-多功能网页服务器" class="headerlink" title="15.8 多功能网页服务器"></a>15.8 多功能网页服务器</h2><h2 id="15-9-RPC远程调用"><a href="#15-9-RPC远程调用" class="headerlink" title="15.9 RPC远程调用"></a>15.9 RPC远程调用</h2><ul>
<li><p>net/rpc包实现互相通信</p>
</li>
<li><p>rpc_object</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> rpc_objects</div><div class="line"></div><div class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</div><div class="line">	N, M <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Args)</span> <span class="title">Multiply</span><span class="params">(args *Args, reply *<span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	*reply = args.N * args.M</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	calc := <span class="built_in">new</span>(rpc_objects.Args)</div><div class="line">	rpc.Register(calc)</div><div class="line">	rpc.HandleHTTP()</div><div class="line">	listener, e := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</div><div class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Starting RPC-server -listen error:"</span>, e)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> http.Serve(listener, <span class="literal">nil</span>)</div><div class="line">	time.Sleep(<span class="number">1000e9</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>rpc_client</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> serverAddress = <span class="string">"localhost"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	client, err := rpc.DialHTTP(<span class="string">"tcp"</span>, serverAddress + <span class="string">":1234"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Error dialing:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Synchronous call</span></div><div class="line">	args := &amp;rpc_objects.Args&#123;<span class="number">7</span>, <span class="number">8</span>&#125;</div><div class="line">	<span class="keyword">var</span> reply <span class="keyword">int</span></div><div class="line">	err = client.Call(<span class="string">"Args.Multiply"</span>, args, &amp;reply)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Args error:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Args: %d * %d = %d"</span>, args.N, args.M, reply)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-10-基于网络的通道-netchan"><a href="#15-10-基于网络的通道-netchan" class="headerlink" title="15.10 基于网络的通道 netchan"></a>15.10 基于网络的通道 netchan</h2><ul>
<li>netchan包实现了类型安全的网络通道：允许一个通道两端出现由网络连接的不同计算机</li>
<li><p>一组导出器会按名称发布一组通道，导入器连接到导出的机器，并按照名称导入这些通道</p>
</li>
<li><p>发送端</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">exp, err := netchan.NewExporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Exporter: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err := exp.Export(<span class="string">"sendmyType"</span>, ch, netchan.Send)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Send Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接收端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">imp, err := netchan.NewImporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Importer: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err = imp.Import(<span class="string">"sendmyType"</span>, ch, netchan.Receive)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Receive Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-11-websocket"><a href="#15-11-websocket" class="headerlink" title="15.11 websocket"></a>15.11 websocket</h2><ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"new connection\n"</span>)</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">100</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">" =&gt; closing connection\n"</span>)</div><div class="line">	ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.Handle(<span class="string">"/websocket"</span>, websocket.Handler(server))</div><div class="line">	err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ListenAndServe: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	ws, err := websocket.Dial(<span class="string">"ws://localhost:12345/websocket"</span>, <span class="string">""</span>,</div><div class="line">		<span class="string">"http://localhost/"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"Dial: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> readFromServer(ws)</div><div class="line">	time.Sleep(<span class="number">5e9</span>)</div><div class="line">    ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFromServer</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1000</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s\n"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-12-使用smtp发送邮件"><a href="#15-12-使用smtp发送邮件" class="headerlink" title="15.12 使用smtp发送邮件"></a>15.12 使用smtp发送邮件</h2><ul>
<li>smpt Simple Mail Transfer Protocol</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// Set up authentication information.</span></div><div class="line">        auth := smtp.PlainAuth(</div><div class="line">                <span class="string">""</span>,</div><div class="line">                <span class="string">"user@example.com"</span>,</div><div class="line">                <span class="string">"password"</span>,</div><div class="line">                <span class="string">"mail.example.com"</span>,</div><div class="line">        )</div><div class="line">        <span class="comment">// Connect to the server, authenticate, set the sender and recipient,</span></div><div class="line">        <span class="comment">// and send the email all in one step.</span></div><div class="line">        err := smtp.SendMail(</div><div class="line">                <span class="string">"mail.example.com:25"</span>,</div><div class="line">                auth,</div><div class="line">                <span class="string">"sender@example.org"</span>,</div><div class="line">                []<span class="keyword">string</span>&#123;<span class="string">"recipient@example.net"</span>&#125;,</div><div class="line">                []<span class="keyword">byte</span>(<span class="string">"This is the email body."</span>),</div><div class="line">        )</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                log.Fatal(err)</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第16章-常见的错误与陷阱"><a href="#第16章-常见的错误与陷阱" class="headerlink" title="第16章 常见的错误与陷阱"></a>第16章 常见的错误与陷阱</h1><ul>
<li>永远不要声明形如<code>var p*a</code>的变量</li>
<li>永远不要在for循环中改变计数器的变量</li>
<li>永远不要在for-range循环中使用一个值去改变自身的值</li>
<li>永远不要将goto和前置标签一起使用</li>
<li>永远不要忘记在函数名后边加上()</li>
<li>永远不要使用new()创建map</li>
<li>为一个两类型定义一个String方法时，不要使用fmt.Print或者类似的代码</li>
<li>永远不要忘记当终止缓存写入时，使用Flush函数</li>
<li>永远不要忽略错误提示，忽略错误会导致程序崩溃</li>
<li>不要使用全局变量或者共享内存，并发不安全</li>
<li>println函数仅仅用于调试</li>
<li>使用正确的方式初始化一个元素是切片的映射，例如<code>map[type]slice</code></li>
<li>一直使用逗号，ok或者checked形式作为类型断言</li>
<li>使用一个工厂函数创建并初始化自己定义的类型</li>
<li>仅当一个结构体的方法想改变结构体时，使用结构体指针作为方法的接受者，否则使用一个结构体类型</li>
</ul>
<h2 id="16-1-误用短声明导致变量覆盖"><a href="#16-1-误用短声明导致变量覆盖" class="headerlink" title="16.1 误用短声明导致变量覆盖"></a>16.1 误用短声明导致变量覆盖</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">shadow</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	x, err := check1() <span class="comment">// x是新创建变量，err是被赋值</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 正确返回err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> y, err := check2(x); err != <span class="literal">nil</span> &#123; <span class="comment">// y和if语句中err被创建</span></div><div class="line">		<span class="keyword">return</span> <span class="comment">// if语句中的err覆盖外面的err，所以错误的返回nil！</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(y)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="16-2-误用字符串"><a href="#16-2-误用字符串" class="headerlink" title="16.2 误用字符串"></a>16.2 误用字符串</h2><ul>
<li>字符串不可变</li>
<li>字符串运算效率低下</li>
<li>使用字符数组进行运算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> b bytes.Buffer</div><div class="line">...</div><div class="line"><span class="keyword">for</span> condition &#123;</div><div class="line">    b.WriteString(str) <span class="comment">// 将字符串str写入缓存buffer</span></div><div class="line">&#125;</div><div class="line">    <span class="keyword">return</span> b.String()</div></pre></td></tr></table></figure>
<h2 id="16-3-发生错误时使用defer关闭一个文件"><a href="#16-3-发生错误时使用defer关闭一个文件" class="headerlink" title="16.3 发生错误时使用defer关闭一个文件"></a>16.3 发生错误时使用defer关闭一个文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</div><div class="line">    <span class="keyword">if</span> f, err = os.Open(file); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 对文件进行操作</span></div><div class="line">    f.Process(data)</div><div class="line">    <span class="comment">// 关闭文件</span></div><div class="line">    f.Close()</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>defer只在函数返回时才会被执行，在循环的结尾或其他一些有限范围的代码内是不会被执行的</li>
</ul>
<h2 id="16-4-new和make"><a href="#16-4-new和make" class="headerlink" title="16.4 new和make"></a>16.4 new和make</h2><ul>
<li>切片，Map和channel，用make</li>
<li>数组，结构体，值类型用new</li>
</ul>
<h2 id="16-5-不需要将一个指向切片的指针传递给函数"><a href="#16-5-不需要将一个指向切片的指针传递给函数" class="headerlink" title="16.5 不需要将一个指向切片的指针传递给函数"></a>16.5 不需要将一个指向切片的指针传递给函数</h2><ul>
<li>切片实际上就是一个指向潜在数组的指针</li>
<li>当切片作为参数传递时，切记不要解引用切片</li>
</ul>
<h2 id="16-6-使用指针指向接口类型"><a href="#16-6-使用指针指向接口类型" class="headerlink" title="16.6 使用指针指向接口类型"></a>16.6 使用指针指向接口类型</h2><ul>
<li>接口类型已经是一个指针了</li>
</ul>
<h2 id="16-7-使用值类型时误用指针"><a href="#16-7-使用值类型时误用指针" class="headerlink" title="16.7 使用值类型时误用指针"></a>16.7 使用值类型时误用指针</h2><ul>
<li>值类型的内存时栈上分配，内存分配快速且开销不大</li>
<li>指针类型需要在堆上创建，导致额外的内存分配</li>
</ul>
<h2 id="16-8-误用协程和通道"><a href="#16-8-误用协程和通道" class="headerlink" title="16.8 误用协程和通道"></a>16.8 误用协程和通道</h2><ul>
<li>大多数情况下，通过栈传递参数会更有效率</li>
<li>当且仅当代码中并发执行非常重要，才使用协程和通道</li>
</ul>
<h2 id="16-9-闭包和协程的使用"><a href="#16-9-闭包和协程的使用" class="headerlink" title="16.9 闭包和协程的使用"></a>16.9 闭包和协程的使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> values = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 版本A:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123; <span class="comment">// ix是索引值</span></div><div class="line">        <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;() <span class="comment">// 调用闭包打印每个索引值</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    <span class="comment">// 版本B: 和A版本类似，但是通过调用闭包作为一个协程</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本C: 正确的处理方式</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;(ix)</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本D: 输出值:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        val := values[ix]</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(val, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">0 1 2 3 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">4 4 4 4 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">1 0 3 4 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">10 11 12 13 14</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="16-10-糟糕的错误处理"><a href="#16-10-糟糕的错误处理" class="headerlink" title="16.10 糟糕的错误处理"></a>16.10 糟糕的错误处理</h2><ul>
<li>创建一个布尔型变量用于测试错误条件是多余的</li>
<li>避免错误检测使代码变得混乱，使用闭包来封装你的错误检验</li>
</ul>
<h1 id="第17章-Go语言模式"><a href="#第17章-Go语言模式" class="headerlink" title="第17章 Go语言模式"></a>第17章 Go语言模式</h1><h2 id="17-1-逗号，ok模式"><a href="#17-1-逗号，ok模式" class="headerlink" title="17.1 逗号，ok模式"></a>17.1 逗号，ok模式</h2><ol>
<li>函数返回时检查错误<ol>
<li><code>val, err := pack1.Func()</code></li>
</ol>
</li>
<li>检测Map中是否存在一个键值<ol>
<li><code>if value, isPresent = map1[key1]; isPresent {}</code></li>
</ol>
</li>
<li>检测一个接口类型变量varI是否包含了类型T，类型断言<ol>
<li><code>if value, ok := varI.(T); ok {}</code></li>
</ol>
</li>
<li>检测一个通道ch是否关闭<ol>
<li><code>for input := range ch {}</code></li>
</ol>
</li>
</ol>
<h2 id="17-2-defer模式"><a href="#17-2-defer模式" class="headerlink" title="17.2 defer模式"></a>17.2 defer模式</h2><table>
<thead>
<tr>
<th>使用场景</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>关闭一个文件流</td>
<td><code>defer f.Close()</code></td>
</tr>
<tr>
<td>解锁一个被锁定的资源</td>
<td><code>defer mu.Unlock()</code></td>
</tr>
<tr>
<td>关闭一个通道</td>
<td><code>defer close(ch)</code></td>
</tr>
<tr>
<td>从panic恢复</td>
<td><code>defer func(){if err := revocer(); err ！= nil {}}</code></td>
</tr>
<tr>
<td>停止一个计时器</td>
<td><code>defer tick1.Stop()</code></td>
</tr>
<tr>
<td>释放一个进程p</td>
<td><code>defer p，Release()</code></td>
</tr>
<tr>
<td>停止CPU性能分析并立即写入</td>
<td><code>defer pprof.StopCPUProfile()</code></td>
</tr>
</tbody>
</table>
<h2 id="17-3-可见性模式"><a href="#17-3-可见性模式" class="headerlink" title="17.3 可见性模式"></a>17.3 可见性模式</h2><h2 id="17-4-运算符模式和接口"><a href="#17-4-运算符模式和接口" class="headerlink" title="17.4 运算符模式和接口"></a>17.4 运算符模式和接口</h2><h3 id="17-4-1-函数作为运算符"><a href="#17-4-1-函数作为运算符" class="headerlink" title="17.4.1 函数作为运算符"></a>17.4.1 函数作为运算符</h3><ul>
<li>go中没有函数重载，我们不得不给函数起不同的名称，可以将其作为包的私有函数，并暴露单一的 Add() 函数作为公共 API。可以在嵌套的 switch 断言中测试类型，以便在任何支持的参数组合上执行操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a Matrix, b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> a.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> sparseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">		<span class="keyword">case</span> denseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">		…</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-2-方法作为运算符"><a href="#17-4-2-方法作为运算符" class="headerlink" title="17.4.2 方法作为运算符"></a>17.4.2 方法作为运算符</h3><ul>
<li>根据接收者的不同，可以区分不同的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *sparseMatrix)</span> <span class="title">Add</span><span class="params">(b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">	<span class="keyword">case</span> denseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-3-使用接口"><a href="#17-4-3-使用接口" class="headerlink" title="17.4.3 使用接口"></a>17.4.3 使用接口</h3><ul>
<li>不同类型上执行相同的方法时，创建一个通用化的接口以实现多态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Algebraic <span class="keyword">interface</span> &#123;</div><div class="line">	Add(b Algebraic) Algebraic</div><div class="line">	Min(b Algebraic) Algebraic</div><div class="line">	Mult(b Algebraic) Algebraic</div><div class="line">	…</div><div class="line">	Elements()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *denseMatrix)</span> <span class="title">Add</span><span class="params">(b Algebraic)</span> <span class="title">Algebraic</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addDenseToSparse(a, b.(sparseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> x in <span class="keyword">range</span> b.Elements() …</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第18章-实用代码块"><a href="#第18章-实用代码块" class="headerlink" title="第18章 实用代码块"></a>第18章 实用代码块</h1><h2 id="18-1-字符串"><a href="#18-1-字符串" class="headerlink" title="18.1 字符串"></a>18.1 字符串</h2><ul>
<li>如何修改字符串中的一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">str := <span class="string">"hello"</span></div><div class="line">c := []<span class="keyword">byte</span>(str)</div><div class="line">c[<span class="number">0</span>] = <span class="string">'c'</span></div><div class="line">s2 := <span class="keyword">string</span>(c)</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取字符串的子串 - <code>substr := str[n;m]</code></p>
</li>
<li><p>如何使用for或者for-range遍历一个字符串</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gives only the bytes:</span></div><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ &#123;</div><div class="line">… = str[i]</div><div class="line">&#125;</div><div class="line"><span class="comment">// gives the Unicode characters:</span></div><div class="line"><span class="keyword">for</span> ix, ch := <span class="keyword">range</span> str &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取一个字符串的字节数 - len()</p>
</li>
<li><p>如何获取一个字符串的字符数 - utf8.RuneCountInString(str)</p>
</li>
<li><p>如何连接字符串</p>
<ul>
<li><code>with a bytes.Buffer</code></li>
<li><code>Strings.Join()</code></li>
<li><code>+=</code></li>
</ul>
</li>
<li>如何解析命令行参数：使用os或者flag包</li>
</ul>
<h2 id="18-2-数组和切片"><a href="#18-2-数组和切片" class="headerlink" title="18.2 数组和切片"></a>18.2 数组和切片</h2><ul>
<li><p>创建</p>
<ul>
<li><code>arr1 := new([len]type)</code></li>
<li><code>slice1 := make([]type, len)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>arr1 := [...]type{i1,i2,i3,i4,i5}</code></li>
<li><code>arrKeyValue := [len]type{i1:val1, i2: val2}</code></li>
<li><code>var slice1 []type = arr1[start:end]</code></li>
</ul>
</li>
<li><p>截断数组或者切片的最后一个元素</p>
<ul>
<li><code>line = line[:len(line)-1]</code></li>
</ul>
</li>
<li><p>遍历数组或者切片</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</div><div class="line">… = arr[i]</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> ix, value := <span class="keyword">range</span> arr &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>二维数组或者切片中查找指定值V</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">found := <span class="literal">false</span></div><div class="line">Found: <span class="keyword">for</span> row := <span class="keyword">range</span> arr2Dim &#123;</div><div class="line">    <span class="keyword">for</span> column := <span class="keyword">range</span> arr2Dim[row] &#123;</div><div class="line">        <span class="keyword">if</span> arr2Dim[row][column] == V&#123;</div><div class="line">            found = <span class="literal">true</span></div><div class="line">            <span class="keyword">break</span> Found</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-3-Map"><a href="#18-3-Map" class="headerlink" title="18.3 Map"></a>18.3 Map</h2><ul>
<li><p>创建</p>
<ul>
<li><code>map1 := make(map[keyType]valueType)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>map1 := map[string]int{&quot;one&quot;:1, &quot;two&quot;:2}</code></li>
</ul>
</li>
<li><p>遍历</p>
<ul>
<li><code>for key, val := range map1{}</code></li>
</ul>
</li>
<li><p>在map中检测key1是否存在</p>
<ul>
<li><code>val1, isPresent = map1[key1]</code></li>
</ul>
</li>
<li><p>删除一个键</p>
<ul>
<li><code>delete(map1, key1)</code></li>
</ul>
</li>
</ul>
<h2 id="18-4-结构体"><a href="#18-4-结构体" class="headerlink" title="18.4 结构体"></a>18.4 结构体</h2><ul>
<li>创建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> structName <span class="keyword">struct</span> &#123;</div><div class="line">    field1 type1</div><div class="line">    field2 type2</div><div class="line"></div><div class="line">&#125;</div><div class="line">ms := <span class="built_in">new</span>(struct1)</div></pre></td></tr></table></figure>
<ul>
<li><p>初始化</p>
<ul>
<li><code>ms := &amp;struct1{10,10,&quot;chris&quot;}</code></li>
</ul>
</li>
<li><p>结构体命名大写开头则包外可见</p>
</li>
<li>每个结构体需要定义一个构件函数来初始化结构体</li>
</ul>
<h2 id="18-5-接口"><a href="#18-5-接口" class="headerlink" title="18.5 接口"></a>18.5 接口</h2><ul>
<li><p>检测一个值v是否实现了接口Stringer</p>
<ul>
<li><code>if v, ok := v.(Stringer); ok {}</code></li>
</ul>
</li>
<li><p>如何使用接口实现一个类型分类接口</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">classifier</span><span class="params">(items ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, x := <span class="keyword">range</span> items &#123;</div><div class="line">        <span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a bool\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">float64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a float64\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is an int\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is nil\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a string\n"</span>, i)</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d’s type is unknown\n"</span>, i)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-6-函数"><a href="#18-6-函数" class="headerlink" title="18.6 函数"></a>18.6 函数</h2><ul>
<li>使用recover恢复panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, x)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-7-文件"><a href="#18-7-文件" class="headerlink" title="18.7 文件"></a>18.7 文件</h2><ul>
<li>打开并读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">file, err := os.Open(<span class="string">"input.dat"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> file.Close()</div><div class="line"></div><div class="line">iReader := bufio.NewReader(file)</div><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">    str, err := iReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">""</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过切片读写文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *file.File)</span></span> &#123;</div><div class="line">  <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">  <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">  <span class="keyword">for</span> &#123;</div><div class="line">    <span class="keyword">switch</span> nr, er := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">    <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">      fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading from %s: %s\n"</span>,</div><div class="line">        f.String(), er.String())</div><div class="line">      os.Exit(<span class="number">1</span>)</div><div class="line">    <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">      <span class="keyword">return</span></div><div class="line">    <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">      <span class="keyword">if</span> nw, ew := file.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">        fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing from %s: %s\n"</span>,</div><div class="line">          f.String(), ew.String())</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-8-goroutine和channel"><a href="#18-8-goroutine和channel" class="headerlink" title="18.8 goroutine和channel"></a>18.8 goroutine和channel</h2><ul>
<li><p>tips</p>
<ul>
<li>出于性能考虑建议使用带缓存的通道</li>
<li>限制一个通道的数据数量并将它们封装成一个数组</li>
</ul>
</li>
<li><p>遍历一个channel</p>
<ul>
<li><code>for v := range ch {}</code></li>
</ul>
</li>
<li><p>检测一个通道ch是否关闭</p>
<ul>
<li><code>input, open := &lt;-ch; !open { }</code></li>
</ul>
</li>
<li><p>通过一个通道让主程序等待直到协程完成</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    ch &lt;- <span class="number">1</span></div><div class="line">&#125;()</div><div class="line">&lt;-ch</div></pre></td></tr></table></figure>
<ul>
<li>通道的工厂模板</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代器模板</li>
<li>如何限制并发请求的处理数量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">	a, b   <span class="keyword">int</span></div><div class="line">	replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	<span class="comment">// do something</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	sem &lt;- <span class="number">1</span> <span class="comment">// doesn't matter what we put in it</span></div><div class="line">	process(r)</div><div class="line">	&lt;-sem <span class="comment">// one empty place in the buffer: the next request can start</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		request := &lt;-service</div><div class="line">		<span class="keyword">go</span> handle(request)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">	<span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如何在多核上实现并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span>&#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU) <span class="comment">// Buffering optional but sensible</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Drain the channel sem, waiting for NCPU tasks to complete</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// All done.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="comment">// do the part of the computation</span></div><div class="line">    sem &lt;<span class="number">-1</span> <span class="comment">// signal that this piece is done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU) <span class="comment">// runtime.GOMAXPROCS = NCPU</span></div><div class="line">    DoAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何终止一个协程</p>
<ul>
<li><code>runtime.Goexit()</code></li>
</ul>
</li>
<li><p>简单的超时模板</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>) <span class="comment">// one second</span></div><div class="line">    timeout &lt;- <span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line">    <span class="comment">// a read from ch has occurred</span></div><div class="line">    <span class="keyword">case</span> &lt;-timeout:</div><div class="line">    <span class="comment">// the read from ch has timed out</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用输入通道和输出通道代替锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;-in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-9-网络和网页应用"><a href="#18-9-网络和网页应用" class="headerlink" title="18.9 网络和网页应用"></a>18.9 网络和网页应用</h2><ul>
<li>制作解析并使模板生效<ul>
<li><code>var strTempl = template.Must(template.New(&quot;TName&quot;).Parse(strTemplateHTML))</code></li>
</ul>
</li>
</ul>
<h2 id="18-10-其他"><a href="#18-10-其他" class="headerlink" title="18.10 其他"></a>18.10 其他</h2><ul>
<li>在程序出错时终止程序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    ...</div><div class="line">    os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"ERROR occurred: "</span> + err.Error())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-11-出于性能考虑的最佳实践和建议"><a href="#18-11-出于性能考虑的最佳实践和建议" class="headerlink" title="18.11 出于性能考虑的最佳实践和建议"></a>18.11 出于性能考虑的最佳实践和建议</h2><ul>
<li>尽可能的使用<code>:=</code>去初始化声明的一个变量</li>
<li>尽可能的使用字符代替字符串</li>
<li>尽可能使用切片替代数组</li>
<li>尽可能使用数组和切片替换映射</li>
<li>如果只想获取切片中的某项值，不需要值的索引，尽可能使用for-range去遍历切片</li>
<li>当数组元素是稀疏的，使用映射会降低内存消耗</li>
<li>初始化Map时指定其容量</li>
<li>当定义一个方法时，使用指针类型所谓方法的接受者</li>
<li>在代码中使用常量或者标志提取常量的值</li>
<li>尽可能在需要分配大量内存时使用缓存</li>
<li>使用缓存模板</li>
</ul>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate comment here</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="cdx 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="cdx 支付宝"/>
        <p>支付宝</p>
      </div>
    

    
      <div id="bitcoin" style="display: inline-block">
        <img id="bitcoin_qr" src="/images/bitcoin.png" alt="cdx 比特币"/>
        <p>比特币</p>
      </div>
    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/go/" rel="tag"># go</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/16/the-way-to-go-基础/" rel="next" title="the way to go 基础篇">
                <i class="fa fa-chevron-left"></i> the way to go 基础篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#第12章-读写数据"><span class="nav-number">1.</span> <span class="nav-text">第12章 读写数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#12-1-读取用户的输入"><span class="nav-number">1.1.</span> <span class="nav-text">12.1 读取用户的输入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-2-文件读写"><span class="nav-number">1.2.</span> <span class="nav-text">12.2 文件读写</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-1-读文件"><span class="nav-number">1.2.1.</span> <span class="nav-text">12.2.1 读文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-2-compress包：读取压缩文件"><span class="nav-number">1.2.2.</span> <span class="nav-text">12.2.2 compress包：读取压缩文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-2-3-写文件"><span class="nav-number">1.2.3.</span> <span class="nav-text">12.2.3 写文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-3-文件拷贝"><span class="nav-number">1.3.</span> <span class="nav-text">12.3 文件拷贝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-4-从命令行读取参数"><span class="nav-number">1.4.</span> <span class="nav-text">12.4 从命令行读取参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-1-os包"><span class="nav-number">1.4.1.</span> <span class="nav-text">12.4.1 os包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-4-2-flag包"><span class="nav-number">1.4.2.</span> <span class="nav-text">12.4.2 flag包</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-5-buffer读取文件"><span class="nav-number">1.5.</span> <span class="nav-text">12.5 buffer读取文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-6-用切片读写文件"><span class="nav-number">1.6.</span> <span class="nav-text">12.6 用切片读写文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-7-defer关闭文件"><span class="nav-number">1.7.</span> <span class="nav-text">12.7 defer关闭文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-8-fmt-Fprintf"><span class="nav-number">1.8.</span> <span class="nav-text">12.8 fmt.Fprintf</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-9-json数据格式"><span class="nav-number">1.9.</span> <span class="nav-text">12.9 json数据格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-10-XML数据格式"><span class="nav-number">1.10.</span> <span class="nav-text">12.10 XML数据格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gob传输数据"><span class="nav-number">1.11.</span> <span class="nav-text">Gob传输数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-12-go中的密码学"><span class="nav-number">1.12.</span> <span class="nav-text">12.12 go中的密码学</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第13章-错误处理与测试"><span class="nav-number">2.</span> <span class="nav-text">第13章 错误处理与测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#13-1-错误处理"><span class="nav-number">2.1.</span> <span class="nav-text">13.1 错误处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-1-定义错误"><span class="nav-number">2.1.1.</span> <span class="nav-text">13.1.1 定义错误</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-1-2-用fmt创建错误对象"><span class="nav-number">2.1.2.</span> <span class="nav-text">13.1.2 用fmt创建错误对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-2-运行时异常和panic"><span class="nav-number">2.2.</span> <span class="nav-text">13.2 运行时异常和panic</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-3-recover"><span class="nav-number">2.3.</span> <span class="nav-text">13.3 recover</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-4-自定义包中的错误处理和panicking"><span class="nav-number">2.4.</span> <span class="nav-text">13.4 自定义包中的错误处理和panicking</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-5-一种用闭包处理错误的模式"><span class="nav-number">2.5.</span> <span class="nav-text">13.5 一种用闭包处理错误的模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-6-启动外部命令和程序"><span class="nav-number">2.6.</span> <span class="nav-text">13.6 启动外部命令和程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-7-go中的单元测试和基准测试"><span class="nav-number">2.7.</span> <span class="nav-text">13.7 go中的单元测试和基准测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-8-测试实例"><span class="nav-number">2.8.</span> <span class="nav-text">13.8 测试实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-9-用测试数据表驱动测试"><span class="nav-number">2.9.</span> <span class="nav-text">13.9 用测试数据表驱动测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-10-性能调试：分析并优化go程序"><span class="nav-number">2.10.</span> <span class="nav-text">13.10 性能调试：分析并优化go程序</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#13-10-1-时间和内存消耗"><span class="nav-number">2.10.1.</span> <span class="nav-text">13.10.1 时间和内存消耗</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-10-2-go-test调试"><span class="nav-number">2.10.2.</span> <span class="nav-text">13.10.2 go test调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-10-3-pprof调试"><span class="nav-number">2.10.3.</span> <span class="nav-text">13.10.3 pprof调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#第14章-协程和通道"><span class="nav-number">2.11.</span> <span class="nav-text">第14章 协程和通道</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#14-1-并发，并行和协程"><span class="nav-number">2.11.1.</span> <span class="nav-text">14.1 并发，并行和协程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-协程间的通信"><span class="nav-number">2.11.2.</span> <span class="nav-text">14.2 协程间的通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-1-概念"><span class="nav-number">2.11.3.</span> <span class="nav-text">14.2.1 概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-2-通信操作符-lt"><span class="nav-number">2.11.4.</span> <span class="nav-text">14.2.2 通信操作符<-</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-3-通道阻塞"><span class="nav-number">2.11.5.</span> <span class="nav-text">14.2.3 通道阻塞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-4-通过channel进行协程同步"><span class="nav-number">2.11.6.</span> <span class="nav-text">14.2.4 通过channel进行协程同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-5-同步通道-使用带缓冲的通道"><span class="nav-number">2.11.7.</span> <span class="nav-text">14.2.5 同步通道-使用带缓冲的通道</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-6-协程中用通道输出结果"><span class="nav-number">2.11.8.</span> <span class="nav-text">14.2.6 协程中用通道输出结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-7-信号量模式"><span class="nav-number">2.11.9.</span> <span class="nav-text">14.2.7 信号量模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-8-实现并行的for循环"><span class="nav-number">2.11.10.</span> <span class="nav-text">14.2.8 实现并行的for循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-8-用带缓冲通道实现一个信号量"><span class="nav-number">2.11.11.</span> <span class="nav-text">14.2.8 用带缓冲通道实现一个信号量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#14-2-10-给通道使用for循环"><span class="nav-number">2.11.12.</span> <span class="nav-text">14.2.10 给通道使用for循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-2-11-通道的方向"><span class="nav-number">2.12.</span> <span class="nav-text">14.2.11 通道的方向</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-3-协程的同步：关闭通道-测试阻塞的通道"><span class="nav-number">2.13.</span> <span class="nav-text">14.3 协程的同步：关闭通道-测试阻塞的通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-4-使用select切换协程"><span class="nav-number">2.14.</span> <span class="nav-text">14.4 使用select切换协程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-5-通道、超时和计时器"><span class="nav-number">2.15.</span> <span class="nav-text">14.5 通道、超时和计时器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-6-协程和恢复"><span class="nav-number">2.16.</span> <span class="nav-text">14.6 协程和恢复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-7-新旧模型对比"><span class="nav-number">2.17.</span> <span class="nav-text">14.7 新旧模型对比</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#旧模式-使用共享内存来进行同步"><span class="nav-number">2.17.1.</span> <span class="nav-text">旧模式 - 使用共享内存来进行同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#新模式-使用通道"><span class="nav-number">2.17.2.</span> <span class="nav-text">新模式 - 使用通道</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-8-惰性生成器的实现"><span class="nav-number">2.18.</span> <span class="nav-text">14.8 惰性生成器的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-9-实现Future模式"><span class="nav-number">2.19.</span> <span class="nav-text">14.9 实现Future模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-10-复用"><span class="nav-number">2.20.</span> <span class="nav-text">14.10 复用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CS模式"><span class="nav-number">2.20.1.</span> <span class="nav-text">CS模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过信号通道关闭服务器"><span class="nav-number">2.20.2.</span> <span class="nav-text">通过信号通道关闭服务器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-11-限制同时处理的请求数-带缓冲的通道"><span class="nav-number">2.21.</span> <span class="nav-text">14.11 限制同时处理的请求数 - 带缓冲的通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-12-链式协程"><span class="nav-number">2.22.</span> <span class="nav-text">14.12 链式协程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-13-在多核心上并行运算"><span class="nav-number">2.23.</span> <span class="nav-text">14.13 在多核心上并行运算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-14并行化大量数据的计算"><span class="nav-number">2.24.</span> <span class="nav-text">14.14并行化大量数据的计算</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-15-漏桶算法"><span class="nav-number">2.25.</span> <span class="nav-text">14.15 漏桶算法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-16-对go协程进行基准测试"><span class="nav-number">2.26.</span> <span class="nav-text">14.16 对go协程进行基准测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-17-使用通道并发访问对象"><span class="nav-number">2.27.</span> <span class="nav-text">14.17 使用通道并发访问对象</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第15章-网络，模板和网页应用"><span class="nav-number">3.</span> <span class="nav-text">第15章 网络，模板和网页应用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#15-1-tcp服务器"><span class="nav-number">3.1.</span> <span class="nav-text">15.1 tcp服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-2-简单的网页服务器"><span class="nav-number">3.2.</span> <span class="nav-text">15.2 简单的网页服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-3-访问并读取页面"><span class="nav-number">3.3.</span> <span class="nav-text">15.3 访问并读取页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-4-网页应用"><span class="nav-number">3.4.</span> <span class="nav-text">15.4 网页应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-5-网页应用健壮"><span class="nav-number">3.5.</span> <span class="nav-text">15.5 网页应用健壮</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-6-模板技术动态生成页面"><span class="nav-number">3.6.</span> <span class="nav-text">15.6 模板技术动态生成页面</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-7-template包-先不看"><span class="nav-number">3.7.</span> <span class="nav-text">15.7 template包 - 先不看</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-8-多功能网页服务器"><span class="nav-number">3.8.</span> <span class="nav-text">15.8 多功能网页服务器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-9-RPC远程调用"><span class="nav-number">3.9.</span> <span class="nav-text">15.9 RPC远程调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-10-基于网络的通道-netchan"><span class="nav-number">3.10.</span> <span class="nav-text">15.10 基于网络的通道 netchan</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-11-websocket"><span class="nav-number">3.11.</span> <span class="nav-text">15.11 websocket</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-12-使用smtp发送邮件"><span class="nav-number">3.12.</span> <span class="nav-text">15.12 使用smtp发送邮件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第16章-常见的错误与陷阱"><span class="nav-number">4.</span> <span class="nav-text">第16章 常见的错误与陷阱</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#16-1-误用短声明导致变量覆盖"><span class="nav-number">4.1.</span> <span class="nav-text">16.1 误用短声明导致变量覆盖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-2-误用字符串"><span class="nav-number">4.2.</span> <span class="nav-text">16.2 误用字符串</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-3-发生错误时使用defer关闭一个文件"><span class="nav-number">4.3.</span> <span class="nav-text">16.3 发生错误时使用defer关闭一个文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-4-new和make"><span class="nav-number">4.4.</span> <span class="nav-text">16.4 new和make</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-5-不需要将一个指向切片的指针传递给函数"><span class="nav-number">4.5.</span> <span class="nav-text">16.5 不需要将一个指向切片的指针传递给函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-6-使用指针指向接口类型"><span class="nav-number">4.6.</span> <span class="nav-text">16.6 使用指针指向接口类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-7-使用值类型时误用指针"><span class="nav-number">4.7.</span> <span class="nav-text">16.7 使用值类型时误用指针</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-8-误用协程和通道"><span class="nav-number">4.8.</span> <span class="nav-text">16.8 误用协程和通道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-9-闭包和协程的使用"><span class="nav-number">4.9.</span> <span class="nav-text">16.9 闭包和协程的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-10-糟糕的错误处理"><span class="nav-number">4.10.</span> <span class="nav-text">16.10 糟糕的错误处理</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第17章-Go语言模式"><span class="nav-number">5.</span> <span class="nav-text">第17章 Go语言模式</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#17-1-逗号，ok模式"><span class="nav-number">5.1.</span> <span class="nav-text">17.1 逗号，ok模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-2-defer模式"><span class="nav-number">5.2.</span> <span class="nav-text">17.2 defer模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-3-可见性模式"><span class="nav-number">5.3.</span> <span class="nav-text">17.3 可见性模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-4-运算符模式和接口"><span class="nav-number">5.4.</span> <span class="nav-text">17.4 运算符模式和接口</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#17-4-1-函数作为运算符"><span class="nav-number">5.4.1.</span> <span class="nav-text">17.4.1 函数作为运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-4-2-方法作为运算符"><span class="nav-number">5.4.2.</span> <span class="nav-text">17.4.2 方法作为运算符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#17-4-3-使用接口"><span class="nav-number">5.4.3.</span> <span class="nav-text">17.4.3 使用接口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#第18章-实用代码块"><span class="nav-number">6.</span> <span class="nav-text">第18章 实用代码块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#18-1-字符串"><span class="nav-number">6.1.</span> <span class="nav-text">18.1 字符串</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-2-数组和切片"><span class="nav-number">6.2.</span> <span class="nav-text">18.2 数组和切片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-3-Map"><span class="nav-number">6.3.</span> <span class="nav-text">18.3 Map</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-4-结构体"><span class="nav-number">6.4.</span> <span class="nav-text">18.4 结构体</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-5-接口"><span class="nav-number">6.5.</span> <span class="nav-text">18.5 接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-6-函数"><span class="nav-number">6.6.</span> <span class="nav-text">18.6 函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-7-文件"><span class="nav-number">6.7.</span> <span class="nav-text">18.7 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-8-goroutine和channel"><span class="nav-number">6.8.</span> <span class="nav-text">18.8 goroutine和channel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-9-网络和网页应用"><span class="nav-number">6.9.</span> <span class="nav-text">18.9 网络和网页应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-10-其他"><span class="nav-number">6.10.</span> <span class="nav-text">18.10 其他</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-11-出于性能考虑的最佳实践和建议"><span class="nav-number">6.11.</span> <span class="nav-text">18.11 出于性能考虑的最佳实践和建议</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
