<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/golang/源码解读/bytes/buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/07/golang/源码解读/bytes/buffer/" itemprop="url">go源码解读-bytes.Buffer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-07T17:28:50+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bytes-Buffer"><a href="#bytes-Buffer" class="headerlink" title="bytes.Buffer"></a>bytes.Buffer</h2><ul>
<li>Buffer结构体<ul>
<li>bytes.Buffer实际上就是长度可变的，可读可写的数组buffer</li>
<li>bytes.Buffer的零值为一个可用的buffer</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Buffer <span class="keyword">struct</span> &#123;</div><div class="line">	buf      []<span class="keyword">byte</span> <span class="comment">// 字节切片，Buffer中的内容为切片[off: len(buf)]</span></div><div class="line">	off      <span class="keyword">int</span>    <span class="comment">// 读取索引 &amp;buf[off], 写入从&amp;buf[len(buf)]写入</span></div><div class="line">	lastRead readOp <span class="comment">// 记录上一次对buffer的操作，从而实现撤销操作</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 最后一次操作buffer的行为</span></div><div class="line"><span class="keyword">type</span> readOp <span class="keyword">int8</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	opRead      readOp = <span class="number">-1</span> <span class="comment">// Any other read operation.</span></div><div class="line">	opInvalid   readOp = <span class="number">0</span>  <span class="comment">// Non-read operation.</span></div><div class="line">	opReadRune1 readOp = <span class="number">1</span>  <span class="comment">// Read rune of size 1.</span></div><div class="line">	opReadRune2 readOp = <span class="number">2</span>  <span class="comment">// Read rune of size 2.</span></div><div class="line">	opReadRune3 readOp = <span class="number">3</span>  <span class="comment">// Read rune of size 3.</span></div><div class="line">	opReadRune4 readOp = <span class="number">4</span>  <span class="comment">// Read rune of size 4.</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="Buffer结构体的方法"><a href="#Buffer结构体的方法" class="headerlink" title="Buffer结构体的方法"></a>Buffer结构体的方法</h3><ul>
<li>Bytes方法返回Buffer未读取的字节数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Bytes</span><span class="params">()</span> []<span class="title">byte</span></span> &#123; <span class="keyword">return</span> b.buf[b.off:] &#125;</div></pre></td></tr></table></figure>
<ul>
<li>String方法以字符串的格式返回未读取的buffer数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Special case, useful in debugging.</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"&lt;nil&gt;"</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(b.buf[b.off:])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Len方法返回未读取的字节数</li>
<li>Cap方法返回buffer数据分配的内存大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(b.buf) - b.off &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">cap</span>(b.buf) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Truncate截取<code>b.buf[:b.off+n]</code>为新的buf</li>
<li>Reset方法为重置操作，创建一个零值的Buffer</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Truncate</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> || n &gt; b.Len() &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes.Buffer: truncation out of range"</span>)</div><div class="line">	&#125;</div><div class="line">	b.buf = b.buf[:b.off+n]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Reset</span><span class="params">()</span></span> &#123;</div><div class="line">	b.buf = b.buf[:<span class="number">0</span>]</div><div class="line">	b.off = <span class="number">0</span></div><div class="line">	b.lastRead = opInvalid</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Grow方法对buffer的容量进行扩容，n指定扩容的字节数大小</li>
<li>n为负数会panic, buffer不能扩容也会报错</li>
<li>grow方法返回的m为写入数据的起点</li>
<li>tryGrowByReslice方法是在buf本身容量是足够的情况下的扩容操作，只需要重新获取切片接口</li>
<li>扩容时是有最小扩容空间的，为64字节，n&lt;64则会被赋值为64，避免小尺度多次扩容的情况</li>
<li>扩容时，会优先考虑复用已经分配的切片空间，不能满足其需求则会重新扩容</li>
<li>makeSlice创建一个新的slice并分配空间，扩容尺寸为原来分配的内存空间的2倍+n个字节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes.Buffer.Grow: negative count"</span>)</div><div class="line">	&#125;</div><div class="line">	m := b.grow(n)</div><div class="line">	b.buf = b.buf[:m]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">grow</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	m := b.Len()</div><div class="line">	<span class="comment">// If buffer is empty, reset to recover space.</span></div><div class="line">	<span class="keyword">if</span> m == <span class="number">0</span> &amp;&amp; b.off != <span class="number">0</span> &#123;</div><div class="line">		b.Reset()</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Try to grow by means of a reslice.</span></div><div class="line">	<span class="keyword">if</span> i, ok := b.tryGrowByReslice(n); ok &#123;</div><div class="line">		<span class="keyword">return</span> i</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.buf == <span class="literal">nil</span> &amp;&amp; n &lt;= smallBufferSize &#123;</div><div class="line">		b.buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, n, smallBufferSize)</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	c := <span class="built_in">cap</span>(b.buf)</div><div class="line">	<span class="keyword">if</span> n &lt;= c/<span class="number">2</span>-m &#123;</div><div class="line">		<span class="comment">// We can slide things down instead of allocating a new</span></div><div class="line">		<span class="comment">// slice. We only need m+n &lt;= c to slide, but</span></div><div class="line">		<span class="comment">// we instead let capacity get twice as large so we</span></div><div class="line">		<span class="comment">// don't spend all our time copying.</span></div><div class="line">		<span class="built_in">copy</span>(b.buf, b.buf[b.off:])</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> c &gt; maxInt-c-n &#123;</div><div class="line">		<span class="built_in">panic</span>(ErrTooLarge)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Not enough space anywhere, we need to allocate.</span></div><div class="line">		buf := makeSlice(<span class="number">2</span>*c + n)</div><div class="line">		<span class="built_in">copy</span>(buf, b.buf[b.off:])</div><div class="line">		b.buf = buf</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Restore b.off and len(b.buf).</span></div><div class="line">	b.off = <span class="number">0</span></div><div class="line">	b.buf = b.buf[:m+n]</div><div class="line">	<span class="keyword">return</span> m</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">tryGrowByReslice</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l := <span class="built_in">len</span>(b.buf); n &lt;= <span class="built_in">cap</span>(b.buf)-l &#123;</div><div class="line">		b.buf = b.buf[:l+n]</div><div class="line">		<span class="keyword">return</span> l, <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// makeSlice allocates a slice of size n. If the allocation fails, it panics</span></div><div class="line"><span class="comment">// with ErrTooLarge.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSlice</span><span class="params">(n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="comment">// If the make fails, give a known error.</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">recover</span>() != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(ErrTooLarge)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Write方法向buf中写入字节数组p</li>
<li>WriteString向buf中写入字符串，内建方法copy支持复制字符串到字节数组中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(p))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(p))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(s))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(s))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>MinRead为ReadFrom最少读入的字节数</li>
<li>ReadFrom从实现了io.Reader接口的结构体中读取数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MinRead = <span class="number">512</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		i := b.grow(MinRead)</div><div class="line">		b.buf = b.buf[:i]</div><div class="line">		m, e := r.Read(b.buf[i:<span class="built_in">cap</span>(b.buf)])</div><div class="line">		<span class="keyword">if</span> m &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(errNegativeRead)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		b.buf = b.buf[:i+m]</div><div class="line">		n += <span class="keyword">int64</span>(m)</div><div class="line">		<span class="keyword">if</span> e == io.EOF &#123;</div><div class="line">			<span class="keyword">return</span> n, <span class="literal">nil</span> <span class="comment">// e is EOF, so return nil explicitly</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, e</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteTo 将数据写入到,直到Buffer中数据为空</li>
<li>WriteByte方法将字节c写入到buffer中</li>
<li>WriteRune方法将字符r写入到buffer中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteTo</span><span class="params">(w io.Writer)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> nBytes := b.Len(); nBytes &gt; <span class="number">0</span> &#123;</div><div class="line">		m, e := w.Write(b.buf[b.off:])</div><div class="line">		<span class="keyword">if</span> m &gt; nBytes &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"bytes.Buffer.WriteTo: invalid Write count"</span>)</div><div class="line">		&#125;</div><div class="line">		b.off += m</div><div class="line">		n = <span class="keyword">int64</span>(m)</div><div class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, e</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// all bytes should have been written, by definition of</span></div><div class="line">		<span class="comment">// Write method in io.Writer</span></div><div class="line">		<span class="keyword">if</span> m != nBytes &#123;</div><div class="line">			<span class="keyword">return</span> n, io.ErrShortWrite</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Buffer is now empty; reset.</span></div><div class="line">	b.Reset()</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteByte</span><span class="params">(c <span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="number">1</span>)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">	b.buf[m] = c</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Read方法从buffer中读取len(p)个字节到字节切片p中</li>
<li>Next返回从buffer中将要读取到的n个字节切片</li>
<li>ReadByte从buffer中读取一个字节</li>
<li>ReadRune从buffer中读取一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(p) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	n = <span class="built_in">copy</span>(p, b.buf[b.off:])</div><div class="line">	b.off += n</div><div class="line">	<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</div><div class="line">		b.lastRead = opRead</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Next</span><span class="params">(n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m := b.Len()</div><div class="line">	<span class="keyword">if</span> n &gt; m &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line">	data := b.buf[b.off : b.off+n]</div><div class="line">	b.off += n</div><div class="line">	<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</div><div class="line">		b.lastRead = opRead</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> data</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadByte</span><span class="params">()</span> <span class="params">(<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	c := b.buf[b.off]</div><div class="line">	b.off++</div><div class="line">	b.lastRead = opRead</div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadRune</span><span class="params">()</span> <span class="params">(r <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	c := b.buf[b.off]</div><div class="line">	<span class="keyword">if</span> c &lt; utf8.RuneSelf &#123;</div><div class="line">		b.off++</div><div class="line">		b.lastRead = opReadRune1</div><div class="line">		<span class="keyword">return</span> <span class="keyword">rune</span>(c), <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	r, n := utf8.DecodeRune(b.buf[b.off:])</div><div class="line">	b.off += n</div><div class="line">	b.lastRead = readOp(n)</div><div class="line">	<span class="keyword">return</span> r, n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>UnreadRune,撤销ReadRune方法的操作</li>
<li>UnreadByte,撤销ReadByte方法的操作</li>
<li>UnreadRune,撤销ReadRune方法的操作</li>
<li>UnreadRune,撤销ReadRune方法的操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.lastRead &lt;= opInvalid &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.off &gt;= <span class="keyword">int</span>(b.lastRead) &#123;</div><div class="line">		b.off -= <span class="keyword">int</span>(b.lastRead)</div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// bytes, UnreadByte returns an error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadByte</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.lastRead == opInvalid &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Buffer: UnreadByte: previous operation was not a successful read"</span>)</div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> b.off &gt; <span class="number">0</span> &#123;</div><div class="line">		b.off--</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadBytes从buffer中读取字节切片直到遇到delim字节，返回结果中包含delim字节</li>
<li>ReadString从buffer中读取字符串，直到遇到delim字节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadBytes</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	slice, err := b.readSlice(delim)</div><div class="line">	<span class="comment">// return a copy of slice. The buffer's backing array may</span></div><div class="line">	<span class="comment">// be overwritten by later calls.</span></div><div class="line">	line = <span class="built_in">append</span>(line, slice...)</div><div class="line">	<span class="keyword">return</span> line, err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// readSlice is like ReadBytes but returns a reference to internal buffer data.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">readSlice</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	i := IndexByte(b.buf[b.off:], delim)</div><div class="line">	end := b.off + i + <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> i &lt; <span class="number">0</span> &#123;</div><div class="line">		end = <span class="built_in">len</span>(b.buf)</div><div class="line">		err = io.EOF</div><div class="line">	&#125;</div><div class="line">	line = b.buf[b.off:end]</div><div class="line">	b.off = end</div><div class="line">	b.lastRead = opRead</div><div class="line">	<span class="keyword">return</span> line, err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadString</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">	slice, err := b.readSlice(delim)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(slice), err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="初始化方法"><a href="#初始化方法" class="headerlink" title="初始化方法"></a>初始化方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBuffer</span><span class="params">(buf []<span class="keyword">byte</span>)</span> *<span class="title">Buffer</span></span> &#123; <span class="keyword">return</span> &amp;Buffer&#123;buf: buf&#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBufferString</span><span class="params">(s <span class="keyword">string</span>)</span> *<span class="title">Buffer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Buffer&#123;buf: []<span class="keyword">byte</span>(s)&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/golang/源码解读/strings/builder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/07/golang/源码解读/strings/builder/" itemprop="url">go源码解读-strings.Builder</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-07T17:26:49+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="builder"><a href="#builder" class="headerlink" title="builder"></a>builder</h2><ul>
<li>Builder是效率最高，内存使用最少的创建一个字符串的方法</li>
<li>Builder结构体包含两个参数<ul>
<li>addr 字符串的地址</li>
<li>buf 字节数组</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A Builder is used to efficiently build a string using Write methods.</span></div><div class="line"><span class="comment">// It minimizes memory copying. The zero value is ready to use.</span></div><div class="line"><span class="comment">// Do not copy a non-zero Builder.</span></div><div class="line"><span class="keyword">type</span> Builder <span class="keyword">struct</span> &#123;</div><div class="line">	addr *Builder <span class="comment">// of receiver, to detect copies by value</span></div><div class="line">	buf  []<span class="keyword">byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><ul>
<li>String方法返回Builder构建的数据</li>
<li>Len方法返回字节数组占据的字节数，1个汉字三个字节</li>
<li>Cap方法返回字节数组分配的内存空间大小</li>
<li>Reset方法将Builder重置为初始状态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// String returns the accumulated string.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b.buf))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Len returns the number of accumulated bytes; b.Len() == len(b.String()).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(b.buf) &#125;</div><div class="line"></div><div class="line"><span class="comment">// Cap returns the capacity of the builder's underlying byte slice. It is the</span></div><div class="line"><span class="comment">// total space allocated for the string being built and includes any bytes</span></div><div class="line"><span class="comment">// already written.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">cap</span>(b.buf) &#125;</div><div class="line"></div><div class="line"><span class="comment">// Reset resets the Builder to be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Reset</span><span class="params">()</span></span> &#123;</div><div class="line">	b.addr = <span class="literal">nil</span></div><div class="line">	b.buf = <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Grow方法"><a href="#Grow方法" class="headerlink" title="Grow方法"></a>Grow方法</h3><ul>
<li>Grow方法来扩展buf数组的分配内存的大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// grow copies the buffer to a new, larger buffer so that there are at least n</span></div><div class="line"><span class="comment">// bytes of capacity beyond len(b.buf).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(b.buf), <span class="number">2</span>*<span class="built_in">cap</span>(b.buf)+n)</div><div class="line">	<span class="built_in">copy</span>(buf, b.buf)</div><div class="line">	b.buf = buf</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Grow grows b's capacity, if necessary, to guarantee space for</span></div><div class="line"><span class="comment">// another n bytes. After Grow(n), at least n bytes can be written to b</span></div><div class="line"><span class="comment">// without another allocation. If n is negative, Grow panics.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.Builder.Grow: negative count"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>(b.buf)-<span class="built_in">len</span>(b.buf) &lt; n &#123;</div><div class="line">		b.grow(n)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">copyCheck</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.addr == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// This hack works around a failing of Go's escape analysis</span></div><div class="line">		<span class="comment">// that was causing b to escape and be heap allocated.</span></div><div class="line">		<span class="comment">// See issue 23382.</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> once issue 7921 is fixed, this should be reverted to</span></div><div class="line">		<span class="comment">// just "b.addr = b".</span></div><div class="line">		b.addr = (*Builder)(noescape(unsafe.Pointer(b)))</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> b.addr != b &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: illegal use of non-zero Builder copied by value"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">noescape</span><span class="params">(p unsafe.Pointer)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</div><div class="line">	x := <span class="keyword">uintptr</span>(p)</div><div class="line">	<span class="keyword">return</span> unsafe.Pointer(x ^ <span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Write相关方法"><a href="#Write相关方法" class="headerlink" title="Write相关方法"></a>Write相关方法</h3><ul>
<li>Write方法将字节数组加添加到buf数组后面</li>
<li>WriteByte将字节c添加到buf数组后边</li>
<li>WriteRune将rune字符添加到buf数组后面</li>
<li>WriteString将字符串添加到buf数组后面</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Write appends the contents of p to b's buffer.</span></div><div class="line"><span class="comment">// Write always returns len(p), nil.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, p...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteByte appends the byte c to b's buffer.</span></div><div class="line"><span class="comment">// The returned error is always nil.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteByte</span><span class="params">(c <span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, c)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteRune appends the UTF-8 encoding of Unicode code point r to b's buffer.</span></div><div class="line"><span class="comment">// It returns the length of r and a nil error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteRune</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	<span class="keyword">if</span> r &lt; utf8.RuneSelf &#123;</div><div class="line">		b.buf = <span class="built_in">append</span>(b.buf, <span class="keyword">byte</span>(r))</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	l := <span class="built_in">len</span>(b.buf)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>(b.buf)-l &lt; utf8.UTFMax &#123;</div><div class="line">		b.grow(utf8.UTFMax)</div><div class="line">	&#125;</div><div class="line">	n := utf8.EncodeRune(b.buf[l:l+utf8.UTFMax], r)</div><div class="line">	b.buf = b.buf[:l+n]</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteString appends the contents of s to b's buffer.</span></div><div class="line"><span class="comment">// It returns the length of s and a nil error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, s...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/golang/源码解读/bytes/reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/07/golang/源码解读/bytes/reader/" itemprop="url">go源码解读-bytes.Reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-07T17:26:21+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bytes-Reader"><a href="#bytes-Reader" class="headerlink" title="bytes.Reader"></a>bytes.Reader</h2><ul>
<li>bytes包中的结构体Reader实现的接口包括<ul>
<li>io.Reader</li>
<li>io.ReaderAt</li>
<li>io.WriterTo</li>
<li>io.Seeker,</li>
<li>io.ByteScanner</li>
<li>io.RuneScanner</li>
</ul>
</li>
</ul>
<h3 id="Reader结构体机器方法"><a href="#Reader结构体机器方法" class="headerlink" title="Reader结构体机器方法"></a>Reader结构体机器方法</h3><ul>
<li>bytes.Reader可以实现从字节数组中读取数据</li>
<li>bytes.Reader是只读的，并且支持查找</li>
<li>bytes.Reader的零值等价于从空slice中读取的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">struct</span> &#123;</div><div class="line">	s        []<span class="keyword">byte</span> <span class="comment">// 字节数组</span></div><div class="line">	i        <span class="keyword">int64</span> <span class="comment">// 当前读取到的索引</span></div><div class="line">	prevRune <span class="keyword">int</span>   <span class="comment">// 上一个读取的字符的索引</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Reader结构体的方法"><a href="#Reader结构体的方法" class="headerlink" title="Reader结构体的方法"></a>Reader结构体的方法</h3><ul>
<li>Len方法返回Reader结构体中还未读取的部分的字节数</li>
<li>Size方法返回Reader结构体中字节数组s的字节数，Size这个方法无论何时调用，返回结果都应该相同</li>
<li>Reset方法，初始化Reader为最初从字节b读取的状态，重置方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(<span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) - r.i)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Reset</span><span class="params">(b []<span class="keyword">byte</span>)</span></span> &#123; *r = Reader&#123;b, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.Reader接口的Read方法，将数据读取到字节数组byte中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.ReaderAt接口的ReadAt方法，从offset的位置开始读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadAt</span><span class="params">(b []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// cannot modify state - see io.ReaderAt</span></div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"bytes.Reader.ReadAt: negative offset"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> off &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[off:])</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="built_in">len</span>(b) &#123;</div><div class="line">		err = io.EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.ByteReader的ReadByte方法，每次读取一个byte数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReadByte implements the  interface.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadByte</span><span class="params">()</span> <span class="params">(<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	b := r.s[r.i]</div><div class="line">	r.i++</div><div class="line">	<span class="keyword">return</span> b, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.ByteScanner接口的UnreadByte方法，将上一个读取过的byte设置为未读取，及r.i–</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadByte</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Reader.UnreadByte: at beginning of slice"</span>)</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	r.i--</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.RuneReader接口的ReadRune方法，从byte中读取一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadRune</span><span class="params">()</span> <span class="params">(ch <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		r.prevRune = <span class="number">-1</span></div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="keyword">int</span>(r.i)</div><div class="line">	<span class="keyword">if</span> c := r.s[r.i]; c &lt; utf8.RuneSelf &#123;</div><div class="line">		r.i++</div><div class="line">		<span class="keyword">return</span> <span class="keyword">rune</span>(c), <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	ch, size = utf8.DecodeRune(r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(size)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.RuneScanner接口的UnreadRune方法，将上一个字符，设置为未读，r.i = int64(r.prevRune)即可</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Reader.UnreadRune: at beginning of slice"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.prevRune &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Reader.UnreadRune: previous operation was not ReadRune"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = <span class="keyword">int64</span>(r.prevRune)</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.Seeker的Seek方法<ul>
<li>whence场景包括开头，结尾，和当前指向的index</li>
<li>返回的是要查找的索引值</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">var</span> abs <span class="keyword">int64</span></div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">case</span> io.SeekStart:</div><div class="line">		abs = offset</div><div class="line">	<span class="keyword">case</span> io.SeekCurrent:</div><div class="line">		abs = r.i + offset</div><div class="line">	<span class="keyword">case</span> io.SeekEnd:</div><div class="line">		abs = <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) + offset</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"bytes.Reader.Seek: invalid whence"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> abs &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"bytes.Reader.Seek: negative position"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = abs</div><div class="line">	<span class="keyword">return</span> abs, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实现io.WriterTo接口的WriteTo方法，将i之后的字节切片写入w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">WriteTo</span><span class="params">(w io.Writer)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	b := r.s[r.i:]</div><div class="line">	m, err := w.Write(b)</div><div class="line">	<span class="keyword">if</span> m &gt; <span class="built_in">len</span>(b) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes.Reader.WriteTo: invalid Write count"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i += <span class="keyword">int64</span>(m)</div><div class="line">	n = <span class="keyword">int64</span>(m)</div><div class="line">	<span class="keyword">if</span> m != <span class="built_in">len</span>(b) &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="初始化Reader方法"><a href="#初始化Reader方法" class="headerlink" title="初始化Reader方法"></a>初始化Reader方法</h3><ul>
<li>NewReader创建一个读取b的Reader对象</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NewReader returns a new Reader reading from b.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReader</span><span class="params">(b []<span class="keyword">byte</span>)</span> *<span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;Reader&#123;b, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/24/golang/go语言实战/go语言实战-打包和工具链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/24/golang/go语言实战/go语言实战-打包和工具链/" itemprop="url">go语言实战 - 3、4、5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-24T17:08:09+08:00">
                2020-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第三章-打包和工具链"><a href="#第三章-打包和工具链" class="headerlink" title="第三章 打包和工具链"></a>第三章 打包和工具链</h2><h3 id="包-package"><a href="#包-package" class="headerlink" title="包 package"></a>包 package</h3><ul>
<li>go语言的程序会被组织成若干组文件，每组文件都被称为一个包</li>
<li>不能把多个包放在同一个目录中</li>
<li>不能把同一个包拆分到多个不同目录中</li>
<li>一个目录下的.go文件必须声明同一个包名</li>
<li>包名命名的管理是使用包所在的目录的名字</li>
<li>包的导入使用全路径，允许名字重复</li>
<li>导入后的报名默认使用包的名字，但是是可以修改的</li>
<li>main包会被编译成二进制可执行文件</li>
<li>main包需要有个main函数作为主函数入口</li>
<li>go build 命令用于构建可执行程序</li>
</ul>
<h3 id="导入-import"><a href="#导入-import" class="headerlink" title="导入 import"></a>导入 import</h3><ul>
<li>import语句告诉编译器到磁盘的哪里去寻找导入的包</li>
<li>编译器会使用Go环境变量设置的路径，通过引入的相对路径来查找磁盘上的包</li>
<li>标准库中的包会在安装Go的位置找到</li>
<li>Go开发者创建的包会在Gopath的环境变量指定的目录中查找</li>
<li>go get命令将获取指定URL的包</li>
<li>包支持命名导入 <code>import nh net/http</code></li>
<li>导入一个不在代码里使用的包时，会导致编译报错，避免代码变得臃肿</li>
<li><code>_</code>空白标识符用于抛弃，比如导入的包，抛出的异常，返回的函数都可以被抛弃</li>
</ul>
<h3 id="初始函数-init"><a href="#初始函数-init" class="headerlink" title="初始函数 init"></a>初始函数 init</h3><ul>
<li>每个包可以包含任意多个init函数，这些函数在程序执行开始的时候被调用</li>
<li>所有被编译器发现的init函数都会在main函数之前执行</li>
<li>init函数主要用在设置包、初始化变量、或者其他先导设置工作，例如在数据库驱动启动的包中，初始化函数会将自身注册到sql包中，启动之后才可以完成数据库的调用</li>
<li>空白标识符可以保证导入包的初始化函数正常执行，而不会报错</li>
</ul>
<h3 id="go-工具"><a href="#go-工具" class="headerlink" title="go 工具"></a>go 工具</h3><ul>
<li>go build 执行编译</li>
<li>go clean 删除编译之后产生的二进制文件</li>
<li>go run 先编译，后执行</li>
<li>go vet 帮助开发人员检测代码的常见错误<ul>
<li>类型匹配错误</li>
<li>方法签名调用错误</li>
<li>错误的结构标签</li>
<li>没有指定字段名的结构字面量</li>
</ul>
</li>
<li>go fmt 将代码布局修改成和go源码类似的风格</li>
<li>go doc tar可以在命令行打开tar包的相关文档</li>
<li>godoc -http=:6060可以在web浏览文档</li>
</ul>
<h3 id="良好的习惯"><a href="#良好的习惯" class="headerlink" title="良好的习惯"></a>良好的习惯</h3><ul>
<li>包应该在代码库的根目录</li>
<li>包可以非常小</li>
<li>代码需要执行 go fmt</li>
<li>给代码写文档</li>
</ul>
<h2 id="第四章-数组、切片和映射"><a href="#第四章-数组、切片和映射" class="headerlink" title="第四章 数组、切片和映射"></a>第四章 数组、切片和映射</h2><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><ul>
<li>数组是一个长度固定的数据类型，用于存储一段具有相同的类型的元素的连续块</li>
<li>内存时连续分配的</li>
<li>数组的类型信息可以提供每次访问一个元素时需要在内存中移动的距离</li>
<li>随机读取速度非常快</li>
<li>声明 var array [5]int，声明之后数组里存储的数据类型和长度都不能改变了</li>
<li>声明之后，数组的值默认为零值</li>
<li>使用数组字面量可以在定义的时候给数组元素赋值 <code>array := [5]int{1,2,3,4,5}</code></li>
<li>相同类型的数组可以赋值给另一个数组</li>
<li>数组变量的类型时包含长度和每个元素的类型的，只有两部分都相同的数组，才是同类型的数组，才可以互相赋值</li>
<li>指针数组赋值，两个数组会指向同一组的字符串</li>
<li>多维数组 <code>var array [2][2]int</code></li>
<li>函数之间传递数组的开销比较大，值传递需要复制整个数组，最好只传入指向数组的指针</li>
</ul>
<h3 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h3><ul>
<li>切片的概念类似于动态数组，可以根据需要自动增长和缩小</li>
<li>切片是一个很小的对象，对底层数组进行了抽象，并提供相关的方法</li>
<li>前片有3个字段的数据，指向底层数组的指针，切片长度，切片容量</li>
<li>切片的创建方法<ul>
<li>make创建<ul>
<li>只指定长度，长度和容量相等 <code>slice := make([]string, 5)</code></li>
<li>指定了长度和容量 <code>slice := make([]string, 3, 5)</code></li>
<li>不允许创建容量小于长度的切片</li>
</ul>
</li>
<li>使用切片字面量来创建<ul>
<li>长度和容量都是3 <code>slice := []string{&quot;r&quot;, &quot;g&quot;, &quot;b&quot;}</code></li>
<li>创建长度和容量是100的切片 <code>slice := []string{99: &quot;&quot;}</code></li>
</ul>
</li>
<li>nil 切片 <code>var slice []int</code></li>
</ul>
</li>
<li>空切片，在底层数组中包含0个元素，也没有分配内核的存储空间<ul>
<li><code>slice := []int{}</code></li>
<li><code>slice := make([]int, 0)</code></li>
</ul>
</li>
<li>切片索引的赋值和数组完全一致</li>
<li>切片可以理解为底层数组的一个滑动窗口，类似于视图的概念</li>
<li>底层数组容量是k的切片<code>slice[i:j]</code>其长度为j-i,容量为k-i</li>
<li>切片是可以根据需要来增加切片的容量的，go语言内置的append函数会处理其细节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// The append built-in function appends elements to the end of a slice. If</span></div><div class="line"><span class="comment">// it has sufficient capacity, the destination is resliced to accommodate the</span></div><div class="line"><span class="comment">// new elements. If it does not, a new underlying array will be allocated.</span></div><div class="line"><span class="comment">// Append returns the updated slice. It is therefore necessary to store the</span></div><div class="line"><span class="comment">// result of append, often in the variable holding the slice itself:</span></div><div class="line"><span class="comment">//	slice = append(slice, elem1, elem2)</span></div><div class="line"><span class="comment">//	slice = append(slice, anotherSlice...)</span></div><div class="line"><span class="comment">// As a special case, it is legal to append a string to a byte slice, like this:</span></div><div class="line"><span class="comment">//	slice = append([]byte("hello "), "world"...)</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(slice []Type, elems ...Type)</span> []<span class="title">Type</span></span></div></pre></td></tr></table></figure>
<ul>
<li>切片添加多个数据用<code>...</code>完成</li>
<li>切片迭代<code>for index, val := range slice</code></li>
<li>切片也支持多维</li>
<li>函数内传递切片采用值传递，其本身尺寸很小</li>
</ul>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><ul>
<li>映射用于存储一组无序的键值对</li>
<li>查询时间复杂度O(1)</li>
<li>映射是可以迭代的，但是不保证顺序</li>
<li>映射的散列表包含一组桶，在存储、删除或者查找键值对的时候，所有操作都需要选择一个桶</li>
<li>散列函数生成的散列值的低位来选择桶</li>
<li>创建和初始化<ul>
<li><code>dict := make(map[string]int)</code></li>
<li><code>dict := map[string]string{&quot;Red&quot;:&quot;red&quot;}</code></li>
<li><code>dict := map[int][]string{}</code></li>
</ul>
</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>数组是构造切片和映射的基石</li>
<li>go语言里切片经常用于处理数据的集合，映射用来处理具有键值对结构的数据</li>
<li>内置函数make可以创建切片和映射，并制定原始的长度和容量</li>
<li>切片有容量限制，可以使用append来扩展容量</li>
<li>映射的增长没有任何限制</li>
<li>内置函数len可以用来获取切片或者映射的长度</li>
<li>内置函数cap只能用于切片</li>
<li>将切片或者映射传递给函数的成本很小，不会复制底层的数据结构</li>
</ul>
<h2 id="第五章-Go语言的类型系统"><a href="#第五章-Go语言的类型系统" class="headerlink" title="第五章 Go语言的类型系统"></a>第五章 Go语言的类型系统</h2><ul>
<li>go语言是一种静态类型的语言，编译器编译时需要知道每个值的类型</li>
<li>值的类型可以使得编译器知道分配多少内存给这个值，以及这个内存存储什么数据</li>
</ul>
<h3 id="用户定义的类型"><a href="#用户定义的类型" class="headerlink" title="用户定义的类型"></a>用户定义的类型</h3><ul>
<li>当用户声明一个新的类型时，这个声明就给编译器提供一个框架，告知必要的内存大小和表示信息</li>
<li>自定义类型的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</div><div class="line">  name <span class="keyword">string</span></div><div class="line">  age <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> bill user</div></pre></td></tr></table></figure>
<ul>
<li>声明变量时，这个变量对应的值总是会被初始化，未指定初始化的值时，各个字段默认取零值<ul>
<li>数字类型零值为0</li>
<li>字符串类型零值为””</li>
<li>bool类型零值为false</li>
</ul>
</li>
</ul>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ul>
<li>方法能给用户定义的类型添加新的行为</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</div><div class="line">  name <span class="keyword">string</span></div><div class="line">  email <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span> <span class="title">notify</span> <span class="params">()</span></span> &#123;</div><div class="line">  fmt.Printf(<span class="string">"Sending User Email To %s&lt;%s&gt; \n"</span>, u.name, u.email)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span> <span class="title">changeEmail</span><span class="params">(email <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">  u.email = email</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</div><div class="line">  bill := user &#123;</div><div class="line">    name: <span class="string">"Bill"</span>,</div><div class="line">    email: <span class="string">"bill@email.com"</span>,</div><div class="line">  &#125;</div><div class="line">  bill.notify()</div><div class="line"></div><div class="line">  lisa := &amp;user&#123;<span class="string">"Lisa"</span>, <span class="string">"lisa@email.com"</span>&#125;</div><div class="line">  lisa.notify()</div><div class="line"></div><div class="line">  bill.changeEmail(<span class="string">"bill@new.com"</span>)</div><div class="line">  bill.notify()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上一个函数如果有接收者，这个函数就被称为方法</li>
</ul>
<h3 id="类型的本质"><a href="#类型的本质" class="headerlink" title="类型的本质"></a>类型的本质</h3><ul>
<li><p>内置类型</p>
<ul>
<li>对内置类型进行增加或者删除的时候，会创建一个新值，所以函数中内置类型的传递时值传递</li>
</ul>
</li>
<li><p>引用类型</p>
<ul>
<li>引用类型包括：切片，映射，通道，接口，函数类型</li>
<li>创建的变量被称为标头值，函数中使用是指针传递，本质上共享底层数据结构</li>
</ul>
</li>
<li><p>结构类型</p>
<ul>
<li>当需要更改类型本身的值时，采用指针传递</li>
<li>当不需要更改类型本身的值时，用值传递</li>
</ul>
</li>
</ul>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><ul>
<li>多态是指代码可以根据类型的具体实现采用不同行为的能力</li>
<li>如果一个类型实现了这个接口的所有方法，那么就是实现了这个接口</li>
<li>接口是用来定义行为的类型</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/23/golang/go语言实战/go语言实战-测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/23/golang/go语言实战/go语言实战-测试/" itemprop="url">go语言实战 - 测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-23T10:07:50+08:00">
                2020-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="go语言实战-测试"><a href="#go语言实战-测试" class="headerlink" title="go语言实战 - 测试"></a>go语言实战 - 测试</h1><h2 id="第九章-测试和性能"><a href="#第九章-测试和性能" class="headerlink" title="第九章 测试和性能"></a>第九章 测试和性能</h2><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><ul>
<li>单元测试是用来测试包或者程序的一部分代码或者一组代码的函数</li>
<li>正向路径测试，保证代码不产生错误，正常运行的测试</li>
<li>负向路径测试，保证代码产生错误，并且是预期的错误</li>
<li>go中的单元测试<ul>
<li>基础测试，只用一组参数和结果进行测试</li>
<li>表组测试，多组参数和结果进行测试</li>
<li>mock数据来减少外部依赖</li>
</ul>
</li>
</ul>
<h4 id="基础单元测试"><a href="#基础单元测试" class="headerlink" title="基础单元测试"></a>基础单元测试</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	checkMark = <span class="string">"\u2713"</span></div><div class="line">	ballotX = <span class="string">"\u2717"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	statusCode := <span class="number">200</span></div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, uri, statusCode)</div><div class="line">		&#123;</div><div class="line">			resp, err := http.Get(uri)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">			&#125;</div><div class="line">			t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">			<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">			<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">=== RUN   TestDownload</span></div><div class="line"><span class="comment">--- PASS: TestDownload (0.27s)</span></div><div class="line"><span class="comment">    01_test.go:17: Given the need to test downloading content</span></div><div class="line"><span class="comment">    01_test.go:19: 	When checking "https://api.weixin.qq.com/cgi-bin/user/info" for status code "200"</span></div><div class="line"><span class="comment">    01_test.go:25: 		Should be able to make the Get call ✓</span></div><div class="line"><span class="comment">    01_test.go:30: 		Should reveive a "200" status ✓</span></div><div class="line"><span class="comment">PASS</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<ul>
<li>go语言只认为以_test.go结尾的文件是测试文件</li>
<li>testing包提供了从测试框架到报告测试的输出和状态的各种测试功能的支持</li>
<li>测试函数必须是公开的函数，并且以Test开头，函数签名必须接收一个指向testing.T类型的指针，并且不返回任何值</li>
</ul>
<h4 id="表组测试"><a href="#表组测试" class="headerlink" title="表组测试"></a>表组测试</h4><ul>
<li>测试可以接受一组不通的输入并且产生不同的输出的代码，推荐使用表组测试的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload2</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> urls = []<span class="keyword">struct</span>&#123;</div><div class="line">		url <span class="keyword">string</span></div><div class="line">		statusCode <span class="keyword">int</span></div><div class="line">	&#125; &#123;</div><div class="line">		&#123;</div><div class="line">			url: <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span>,</div><div class="line">			statusCode: <span class="number">200</span>,</div><div class="line">		&#125;,</div><div class="line">		&#123;</div><div class="line">			url: <span class="string">"https://api.weixin.qq.com/cgi-bin/user"</span>,</div><div class="line">			statusCode: http.StatusNotFound,</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</div><div class="line">			uri := u.url</div><div class="line">			statusCode := u.statusCode</div><div class="line">			t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, uri, statusCode)</div><div class="line">			&#123;</div><div class="line">				resp, err := http.Get(uri)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">				&#125;</div><div class="line">				t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">				<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">				<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">					t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Mock调用"><a href="#Mock调用" class="headerlink" title="Mock调用"></a>Mock调用</h4><ul>
<li>httptest包可以让开发人员模仿基于http的网络调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> feed = <span class="string">`&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="string">&lt;rss&gt;</span></div><div class="line"><span class="string">&lt;channel&gt;</span></div><div class="line"><span class="string">	&lt;title&gt;Going Go Programming&lt;/title&gt;</span></div><div class="line"><span class="string">	&lt;description&gt;Golang : https://github.com/goinggo&lt;/description&gt;</span></div><div class="line"><span class="string">	&lt;link&gt;http://www.goinggo.net/&lt;/link&gt;</span></div><div class="line"><span class="string">	&lt;item&gt;</span></div><div class="line"><span class="string">		&lt;pubDate&gt;Sun, 15 Mar 2015 15:04:00 +0000&lt;/pubDate&gt;</span></div><div class="line"><span class="string">		&lt;title&gt;Object Oriented Programming Mechanics&lt;/title&gt;</span></div><div class="line"><span class="string">		&lt;description&gt;Go is an object oriented language.&lt;/description&gt;</span></div><div class="line"><span class="string">		&lt;link&gt;http://www.goinggo.net/2015/03/object-oriented&lt;/link&gt;</span></div><div class="line"><span class="string">	&lt;/item&gt;</span></div><div class="line"><span class="string">&lt;/channel&gt;</span></div><div class="line"><span class="string">&lt;/rss&gt;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mockServer</span><span class="params">()</span> *<span class="title">httptest</span>.<span class="title">Server</span></span> &#123;</div><div class="line">	f := <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		w.WriteHeader(<span class="number">200</span>)</div><div class="line">		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/xml"</span>)</div><div class="line">		_, _ = fmt.Fprintln(w, feed)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> httptest.NewServer(http.HandlerFunc(f))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload3</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	statusCode := <span class="number">200</span></div><div class="line"></div><div class="line">	server := mockServer()</div><div class="line">	<span class="keyword">defer</span> server.Close()</div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, server.URL, statusCode)</div><div class="line">		&#123;</div><div class="line">			resp, err := http.Get(server.URL)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">			&#125;</div><div class="line">			t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">			<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">			<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ul>
<li>开发人员可以创建自己的示例</li>
<li>函数开头为Example</li>
<li>示例代码的函数名字必须基于已经存在的公开的函数或者方法</li>
<li>最好将示例的输出列在下方</li>
</ul>
<h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><ul>
<li>基准测试是测试代码性能的方法</li>
<li>基准测试必须以Benchmark开头，接受一个执行testing.B类型的指针作为唯一参数</li>
<li>基准测试默认框架会在持续1s的时间内，反复调用需要测试的函数，测试框架每次调用测试函数时，都会增加b.N的值</li>
<li>如果只想运行基准测试，而跳过单元测试，则用命令<code>go test -v -run=&quot;none&quot; -bench=&quot;BenchmarkSprintf&quot;</code>即可</li>
<li><code>-benchtime=3s</code>可以变更基准测试的运行时间，默认为1s</li>
<li><code>b.ResetTimer</code>用来重置计时器</li>
<li><code>-benchmem</code>展示每次操作分配内存的次数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"strconv"</span></div><div class="line">	<span class="string">"testing"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 找出最快的奖整数转换成字符串的方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSprintf</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="number">10</span></div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		fmt.Sprintf(<span class="string">"%d"</span>, number)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkFormat</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="keyword">int64</span>(<span class="number">10</span>)</div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		strconv.FormatInt(number, <span class="number">10</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkItoa</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="number">10</span></div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		strconv.Itoa(number)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">goos: darwin</span></div><div class="line"><span class="comment">goarch: amd64</span></div><div class="line"><span class="comment">pkg: api/books/go-in-action/9-testing</span></div><div class="line"><span class="comment">BenchmarkSprintf-12    	20000000	        70.6 ns/op</span></div><div class="line"><span class="comment">BenchmarkFormat-12     	1000000000	         2.56 ns/op</span></div><div class="line"><span class="comment">BenchmarkItoa-12       	1000000000	         2.42 ns/op</span></div><div class="line"><span class="comment">PASS</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>测试功能被内置到go语言中，go语言提供了必要的测试工具</li>
<li>go test工具用来运行测试</li>
<li>测试文件总是以_test作为文件名的结尾</li>
<li>表组测试是利用一个测试函数测试多组值的好办法</li>
<li>表中的实例代码，既能用于测试，也能用于文档</li>
<li>基准测试提供了探查代码性能的机制</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/golang/go语言实战/go语言实战-标准库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/21/golang/go语言实战/go语言实战-标准库/" itemprop="url">go语言实战 - 标准库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-21T10:27:52+08:00">
                2020-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第八章-标准库"><a href="#第八章-标准库" class="headerlink" title="第八章 标准库"></a>第八章 标准库</h2><ul>
<li>标准库是一组核心包，用于扩展和增强语言的能力<ul>
<li>每次语言更新都会带有标准库</li>
<li>标准库会严格遵守哦向后兼容的承诺</li>
<li>标准库是go语言开发，构建，发布过程的一部分</li>
<li>标准库由go的构建者们维护和评审</li>
<li>go语言发布新版本时，标准库都会被测试，并评估性能</li>
</ul>
</li>
<li>开发中尽量使用标准库</li>
</ul>
<h3 id="文档与源代码"><a href="#文档与源代码" class="headerlink" title="文档与源代码"></a>文档与源代码</h3><ul>
<li>作为go发布包的一部分，标准库的源代码是经过预编译的，称为归档文件</li>
<li>这些文件是go静态库文件，由go的构建工具创建，并在编译和链接最终程序时被使用</li>
</ul>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><h4 id="log包简介"><a href="#log包简介" class="headerlink" title="log包简介"></a>log包简介</h4><ul>
<li>log包日志项包含前缀、日期时间戳、源文件、行数、日志消息等组成</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"log"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	log.SetPrefix(<span class="string">"TRACE: "</span>)</div><div class="line">	log.SetFlags(log.Ldate | log.Lmicroseconds | log.Llongfile)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"message"</span>)</div><div class="line"></div><div class="line">	log.Fatalln(<span class="string">"fatal message"</span>)</div><div class="line"></div><div class="line">	log.Panicln(<span class="string">"panic message"</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/* 输出结果</span></div><div class="line"><span class="comment">TRACE: 2020/04/21 14:34:16.281971 /Users/dxchang/go/src/api/books/go-in-action/8-pkg/log.go:11: message</span></div><div class="line"><span class="comment">TRACE: 2020/04/21 14:34:16.282102 /Users/dxchang/go/src/api/books/go-in-action/8-pkg/log.go:13: fatal message</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<ul>
<li>init函数作为初始化的一部分，会在main函数执行前执行</li>
<li>SetPrefix()方法进行设置前缀，一般全部大写</li>
<li>SetFlags设定标志来控制可以写到每个日志项的输出信息，如下</li>
<li>这样可以用一个字节来存储日志的标志位，<code>log.Ldate | log.Ltime | log.Lmicroseconds | log.Llongfile</code>和传入<code>00001111</code>是等价的</li>
<li>日志中以ln结尾的函数会换行，以f结尾的函数可以自定义格式化输出</li>
<li>log包是多线程安全的，多个goroutine同时来调用一个日志记录器的函数，不会存在写冲突</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	Ldate         = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span>     <span class="comment">// 本地日期: 2009/01/23</span></div><div class="line">	Ltime                         <span class="comment">// 本地时间: 01:23:23</span></div><div class="line">	Lmicroseconds                 <span class="comment">// 时间毫秒数: 01:23:23.123123.</span></div><div class="line">	Llongfile                     <span class="comment">// 日志打印的文件全路径: /a/b/c/d.go:23</span></div><div class="line">	Lshortfile                    <span class="comment">// 日志打印的文件短路径: d.go:23</span></div><div class="line">	LUTC                          <span class="comment">// 使用UTC时区时间</span></div><div class="line">	LstdFlags     = Ldate | Ltime <span class="comment">// 默认日志，打印日期和时间，到秒</span></div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>Fatal系列函数来先写消息，然后调用os.Exit方法退出</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Fatal is equivalent to Print() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatal</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprint(v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Fatalf is equivalent to Printf() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatalf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintf(format, v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Fatalln is equivalent to Println() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatalln</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintln(v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Panic函数写日志消息，触发panic，打印堆栈然后退出</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Panic is equivalent to Print() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panic</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprint(v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Panicf is equivalent to Printf() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panicf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprintf(format, v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Panicln is equivalent to Println() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panicln</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprintln(v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Print函数是写日志消息的标准方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Print calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Print.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprint(v...))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Printf calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Printf.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintf(format, v...))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Println calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Println.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintln(v...))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="定制的日志记录器"><a href="#定制的日志记录器" class="headerlink" title="定制的日志记录器"></a>定制的日志记录器</h4><ul>
<li>创建一个定制的日志记录器，需要创建一个Logger类型值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	Trace *log.Logger <span class="comment">// 记录所有日志</span></div><div class="line">	Info *log.Logger <span class="comment">// 重要的信息</span></div><div class="line">	Warning *log.Logger <span class="comment">// 警告</span></div><div class="line">	Error *log.Logger <span class="comment">// 错误</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	file, err := os.OpenFile(<span class="string">"errors.txt"</span>, os.O_CREATE | os.O_WRONLY | os.O_APPEND, <span class="number">0666</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(<span class="string">"Failed to open error log file:"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace = log.New(ioutil.Discard, <span class="string">"TRACE: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Info = log.New(os.Stdout, <span class="string">"INFO: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Warning = log.New(os.Stdout, <span class="string">"WARNING: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Error = log.New(io.MultiWriter(file, os.Stderr), <span class="string">"TRACE: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	Trace.Println(<span class="string">"I have something standard to say"</span>)</div><div class="line">	Info.Println(<span class="string">"Special Information"</span>)</div><div class="line">	Warning.Println(<span class="string">"There is something you need to know"</span>)</div><div class="line">	Error.Println(<span class="string">"Something has failed"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>log包的New()函数完成Logger类型的初始化，设定输出位置，日志前缀，及日志输出内容</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(out io.Writer, prefix <span class="keyword">string</span>, flag <span class="keyword">int</span>)</span> *<span class="title">Logger</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Logger&#123;out: out, prefix: prefix, flag: flag&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ioutil.Discard实现了io.Writer接口，但是并不会发生实际的写入，使用Discard可以禁用这个类型的日志</li>
<li>os.Stdin、os.Stdout、os.Stderr分别指向标准输入，标准输出，标准错误</li>
<li>io.MultiWriter()方法可以向多个实现了io.Writer接口的位置写入日志</li>
</ul>
<h4 id="log包中的其余函数"><a href="#log包中的其余函数" class="headerlink" title="log包中的其余函数"></a>log包中的其余函数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flags</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Flags()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetFlags</span><span class="params">(flag <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	std.SetFlags(flag)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Prefix</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Prefix()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetPrefix</span><span class="params">(prefix <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	std.SetPrefix(prefix)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SetOutput sets the output destination for the standard logger.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetOutput</span><span class="params">(w io.Writer)</span></span> &#123;</div><div class="line">	std.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> std.mu.Unlock()</div><div class="line">	std.out = w</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Output</span><span class="params">(calldepth <span class="keyword">int</span>, s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Output(calldepth+<span class="number">1</span>, s) <span class="comment">// +1 for this frame.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>logger结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</div><div class="line">	mu     sync.Mutex <span class="comment">// 互斥锁，支持原子写入</span></div><div class="line">	prefix <span class="keyword">string</span>     <span class="comment">// 日志前缀</span></div><div class="line">	flag   <span class="keyword">int</span>        <span class="comment">// 日志输出内容标志位</span></div><div class="line">	out    io.Writer  <span class="comment">// 日志输出位置</span></div><div class="line">	buf    []<span class="keyword">byte</span>     <span class="comment">// 要追加的日志内容</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>logger核心方法 Output</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// s为要写入的日志，calldepth目前均为2</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Output</span><span class="params">(calldepth <span class="keyword">int</span>, s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	now := time.Now() <span class="comment">// get this early.</span></div><div class="line">	<span class="keyword">var</span> file <span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> line <span class="keyword">int</span></div><div class="line">	l.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> l.mu.Unlock()</div><div class="line">	<span class="keyword">if</span> l.flag&amp;(Lshortfile|Llongfile) != <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Release lock while getting caller info - it's expensive.</span></div><div class="line">		l.mu.Unlock()</div><div class="line">		<span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">		_, file, line, ok = runtime.Caller(calldepth)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			file = <span class="string">"???"</span></div><div class="line">			line = <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">		l.mu.Lock()</div><div class="line">	&#125;</div><div class="line">	l.buf = l.buf[:<span class="number">0</span>]</div><div class="line">	l.formatHeader(&amp;l.buf, now, file, line)</div><div class="line">	l.buf = <span class="built_in">append</span>(l.buf, s...)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> || s[<span class="built_in">len</span>(s)<span class="number">-1</span>] != <span class="string">'\n'</span> &#123;</div><div class="line">		l.buf = <span class="built_in">append</span>(l.buf, <span class="string">'\n'</span>)</div><div class="line">	&#125;</div><div class="line">	_, err := l.out.Write(l.buf)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编码-解码"><a href="#编码-解码" class="headerlink" title="编码/解码"></a>编码/解码</h3><ul>
<li>xml/json包可以完成json和xml的编码解码</li>
</ul>
<h4 id="解码JSON"><a href="#解码JSON" class="headerlink" title="解码JSON"></a>解码JSON</h4><ul>
<li>使用json包的NewDecode函数和Decode方法来完成json解码</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> gResponse <span class="keyword">struct</span> &#123;</div><div class="line">	ErrCode <span class="keyword">int</span> <span class="string">`json:"errcode"`</span></div><div class="line">	ErrMsg <span class="keyword">string</span> <span class="string">`json:"errmsg"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	resp, err := http.Get(uri)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> gr gResponse</div><div class="line">	err = json.NewDecoder(resp.Body).Decode(&amp;gr)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(gr)</div><div class="line">&#125;</div><div class="line"><span class="comment">// &#123;41001 access_token missing hints: [xHkBIOLoRa-GmALMa!]&#125;</span></div></pre></td></tr></table></figure>
<ul>
<li>json中NewDecoder方法返回Decoder对象</li>
<li>Decoder结构体从输入流中读取数据并解码成json</li>
<li>Decode方法完成JSON的解析映射</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Decoder&#123;r: r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// A Decoder reads and decodes JSON values from an input stream.</span></div><div class="line"><span class="keyword">type</span> Decoder <span class="keyword">struct</span> &#123;</div><div class="line">	r       io.Reader</div><div class="line">	buf     []<span class="keyword">byte</span></div><div class="line">	d       decodeState</div><div class="line">	scanp   <span class="keyword">int</span>   <span class="comment">// start of unread data in buf</span></div><div class="line">	scanned <span class="keyword">int64</span> <span class="comment">// amount of data already scanned</span></div><div class="line">	scan    scanner</div><div class="line">	err     error</div><div class="line"></div><div class="line">	tokenState <span class="keyword">int</span></div><div class="line">	tokenStack []<span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dec *Decoder)</span> <span class="title">Decode</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> dec.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> dec.err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := dec.tokenPrepareForDecode(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !dec.tokenValueAllowed() &#123;</div><div class="line">		<span class="keyword">return</span> &amp;SyntaxError&#123;msg: <span class="string">"not at beginning of value"</span>, Offset: dec.offset()&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Read whole value into buffer.</span></div><div class="line">	n, err := dec.readValue()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	dec.d.init(dec.buf[dec.scanp : dec.scanp+n])</div><div class="line">	dec.scanp += n</div><div class="line"></div><div class="line">	err = dec.d.unmarshal(v)</div><div class="line"></div><div class="line">	dec.tokenValueEnd()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>json文档以string的形式存在，此时使用json.Unmarshal方法完成反序列化处理</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> gResponse <span class="keyword">struct</span> &#123;</div><div class="line">	ErrCode <span class="keyword">int</span> <span class="string">`json:"errcode"`</span></div><div class="line">	ErrMsg <span class="keyword">string</span> <span class="string">`json:"errmsg"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	resp, err := http.Get(uri)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">	bytes, err := ioutil.ReadAll(resp.Body)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> gr gResponse</div><div class="line">	err = json.Unmarshal(bytes, &amp;gr)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(gr)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="编码JSON"><a href="#编码JSON" class="headerlink" title="编码JSON"></a>编码JSON</h4><ul>
<li>MarshalIndent方法可以完成map和结构体到json的映射</li>
</ul>
<h3 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h3><h4 id="Writer和Reader接口"><a href="#Writer和Reader接口" class="headerlink" title="Writer和Reader接口"></a>Writer和Reader接口</h4><ul>
<li>io包的核心就是Writer和Reader接口<ul>
<li>Writer接口<ul>
<li>Writer接口接收字节切片，返回两个值，写入的字节数和错误输出</li>
<li>Writer接口从p里向底层的数据流写入len(p)字节的数据</li>
<li>Writer无论如何也不能改p中的数据</li>
</ul>
</li>
<li>Reader接口<ul>
<li>Reader接口接收字节切片，返回两个值，读取的字节数和错误输出</li>
<li>Read最多读入len(p)个字节，保存到p</li>
<li>可以使用所有的p的空间来存储临时数据</li>
<li>当字节长度不足len(p)，Read会立刻返回可用的数据，而不是等待更多的数据</li>
<li>当成功读取了部分字节后，发生错误或者读取完成，Read方法会返回读入的字节数</li>
<li>即使有错误发生，当读取的字节数&gt;0时，需要先处理读取的数据，再处理错误</li>
<li>读取的实现，不鼓励返回0个字节并且返回nil值的错误<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">	Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">	Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> b bytes.Buffer</div><div class="line">	b.Write([]<span class="keyword">byte</span>(<span class="string">"Hello "</span>))</div><div class="line"></div><div class="line">	fmt.Fprintf(&amp;b, <span class="string">"World"</span>)</div><div class="line"></div><div class="line">	b.WriteTo(os.Stdout)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Buffe的Write方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Write appends the contents of p to the buffer, growing the buffer as</span></div><div class="line"><span class="comment">// needed. The return value n is the length of p; err is always nil. If the</span></div><div class="line"><span class="comment">// buffer becomes too large, Write will panic with ErrTooLarge.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(p))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(p))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], p), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h4><ul>
<li>一个简单的curl,第一个参数指定curl的网站，，第二个参数指定将curl获取的response的body写入的文件名</li>
<li>defer 打开关闭的资源</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	r, err := http.Get(os.Args[<span class="number">1</span>])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	file, err := os.Create(os.Args[<span class="number">2</span>])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> file.Close()</div><div class="line"></div><div class="line">	dest := io.MultiWriter(os.Stdout, file)</div><div class="line">	io.Copy(dest, r.Body)</div><div class="line">	<span class="keyword">if</span> err := r.Body.Close(); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>标准库由特殊的保证，并且被社区广泛应用</li>
<li>使用标准库会让你的代码更易于管理</li>
<li>接口允许你的代码组合已有的功能</li>
<li>阅读标准库的代码是熟悉go语言习惯的好方法</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/golang/源码解读/container/ring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/golang/源码解读/container/ring/" itemprop="url">go源码解读-ring</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ring"><a href="#ring" class="headerlink" title="ring"></a>ring</h2><ul>
<li>ring为环结构，没有开始和结束</li>
<li>本质是双向链表</li>
<li>空ring的next和prev都指向自己</li>
</ul>
<h3 id="ring结构体"><a href="#ring结构体" class="headerlink" title="ring结构体"></a>ring结构体</h3><ul>
<li>Ring结构体包含三个参数<ul>
<li>next 指向当前节点的下一个节点</li>
<li>prev 指向当前节点的上一个节点</li>
<li>Value 当前节点的值</li>
</ul>
</li>
<li>New方法为创建一个包含n个元素的ring的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ring <span class="keyword">struct</span> &#123;</div><div class="line">	next, prev *Ring</div><div class="line">	Value      <span class="keyword">interface</span>&#123;&#125; <span class="comment">// for use by client; untouched by this library</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// New creates a ring of n elements.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	r := <span class="built_in">new</span>(Ring)</div><div class="line">	p := r</div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; n; i++ &#123;</div><div class="line">		p.next = &amp;Ring&#123;prev: p&#125;</div><div class="line">		p = p.next</div><div class="line">	&#125;</div><div class="line">	p.next = r</div><div class="line">	r.prev = p</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Ring结构体的方法"><a href="#Ring结构体的方法" class="headerlink" title="Ring结构体的方法"></a>Ring结构体的方法</h3><ul>
<li>init为初始一个0个节点的Ring结构体的方法</li>
<li>Next返回当前节点的下一个节点</li>
<li>Prev返回当前节点的上一个节点</li>
<li>Move将当前节点移动n个位置</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">init</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	r.next = r</div><div class="line">	r.prev = r</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Next returns the next ring element. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.next</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Prev returns the previous ring element. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.prev</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Move moves n % r.Len() elements backward (n &lt; 0) or forward (n &gt;= 0)</span></div><div class="line"><span class="comment">// in the ring and returns that ring element. r must not be empty.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Move</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> n &lt; <span class="number">0</span>:</div><div class="line">		<span class="keyword">for</span> ; n &lt; <span class="number">0</span>; n++ &#123;</div><div class="line">			r = r.prev</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> n &gt; <span class="number">0</span>:</div><div class="line">		<span class="keyword">for</span> ; n &gt; <span class="number">0</span>; n-- &#123;</div><div class="line">			r = r.next</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="链接操作"><a href="#链接操作" class="headerlink" title="链接操作"></a>链接操作</h4><ul>
<li>Link 将s和r链接到一起，返回r.next<ul>
<li>s和r在一个圆环里，操作会将r和s之间的元素移除到圆环</li>
<li>s和r不在一个圆环里，操作会将r和s合并成一个圆环</li>
</ul>
</li>
<li>Unlink移除n%r.len个元素，本质上是对Link方法的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Link</span><span class="params">(s *Ring)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	n := r.Next()</div><div class="line">	<span class="keyword">if</span> s != <span class="literal">nil</span> &#123;</div><div class="line">		p := s.Prev()</div><div class="line">		<span class="comment">// Note: Cannot use multiple assignment because</span></div><div class="line">		<span class="comment">// evaluation order of LHS is not specified.</span></div><div class="line">		r.next = s</div><div class="line">		s.prev = r</div><div class="line">		n.prev = p</div><div class="line">		p.next = n</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Unlink removes n % r.Len() elements from the ring r, starting</span></div><div class="line"><span class="comment">// at r.Next(). If n % r.Len() == 0, r remains unchanged.</span></div><div class="line"><span class="comment">// The result is the removed subring. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Unlink</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.Link(r.Move(n + <span class="number">1</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Len和Do方法"><a href="#Len和Do方法" class="headerlink" title="Len和Do方法"></a>Len和Do方法</h4><ul>
<li>Len方法返回圆环的长度</li>
<li>Do方法的参数为一个函数f，对于圆环上的每个元素的值，执行该函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</div><div class="line">		n = <span class="number">1</span></div><div class="line">		<span class="keyword">for</span> p := r.Next(); p != r; p = p.next &#123;</div><div class="line">			n++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Do calls function f on each element of the ring, in forward order.</span></div><div class="line"><span class="comment">// The behavior of Do is undefined if f changes *r.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Do</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">interface</span>&#123;&#125;)</span>)</span> &#123;</div><div class="line">	<span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</div><div class="line">		f(r.Value)</div><div class="line">		<span class="keyword">for</span> p := r.Next(); p != r; p = p.next &#123;</div><div class="line">			f(p.Value)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/golang/源码解读/container/list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/golang/源码解读/container/list/" itemprop="url">go源码解读-list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><ul>
<li>go语言中的列表采用双向链表来实现</li>
<li>实现过程中主要依赖于两个结构体，Element和List对象</li>
<li>显然list是线程不安全的包</li>
</ul>
<h3 id="Element详解"><a href="#Element详解" class="headerlink" title="Element详解"></a>Element详解</h3><ul>
<li>Element中包含四个字段，类似于Java中的成员变量<ul>
<li>next为当前元素的下一个元素</li>
<li>pre为当前元素的上一个元素</li>
<li>&amp;l.root为链表最后一个元素的下一个元素，同时也是链表第一个元素的上个元素，形如一个环</li>
<li>list标识当前元素归属于哪个链表</li>
<li>Value采用interface{}类型，可以保存任意的数据结构，也就是说go中的链表可以保存一个类似[‘abc’,12,12.03]这样的数据</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Element is an element of a linked list.</span></div><div class="line"><span class="keyword">type</span> Element <span class="keyword">struct</span> &#123;</div><div class="line">	next, prev *Element</div><div class="line"></div><div class="line">  list *List</div><div class="line"></div><div class="line">	Value <span class="keyword">interface</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Element结构体实现了两个方法<ul>
<li>Next()方法返回当前节点的下一个节点数据</li>
<li>Prev()方法返回当前节点的上一个节点数据</li>
<li>两个方法都屏蔽掉了list.root的情况，也就是如果找到的节点是根节点，则不做返回</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> p := e.next; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</div><div class="line">		<span class="keyword">return</span> p</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> p := e.prev; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</div><div class="line">		<span class="keyword">return</span> p</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ul>
<li>链表包含两个元素<ul>
<li>root 根节点，只用在&amp;root, root.prev, root.next这三种情况</li>
<li>len 链表中的节点数量，不包含根节点</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// List represents a doubly linked list.</span></div><div class="line"><span class="comment">// The zero value for List is an empty list ready to use.</span></div><div class="line"><span class="keyword">type</span> List <span class="keyword">struct</span> &#123;</div><div class="line">	root Element <span class="comment">// sentinel list element, only &amp;root, root.prev, and root.next are used</span></div><div class="line">	<span class="built_in">len</span>  <span class="keyword">int</span>     <span class="comment">// current list length excluding (this) sentinel element</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="初始化列表"><a href="#初始化列表" class="headerlink" title="初始化列表"></a>初始化列表</h4><ul>
<li>list提供一个可外部调用的初始化方法New,实际上是调用了List的Init()方法</li>
<li>Init方法返回一个空列表，也就是root的前后节点都指向自己，并且列表长度为0</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns an initialized list.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">List</span></span> &#123; <span class="keyword">return</span> <span class="built_in">new</span>(List).Init() &#125;</div><div class="line"></div><div class="line"><span class="comment">// Init initializes or clears list l.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">List</span></span> &#123;</div><div class="line">	l.root.next = &amp;l.root</div><div class="line">	l.root.prev = &amp;l.root</div><div class="line">	l.<span class="built_in">len</span> = <span class="number">0</span></div><div class="line">	<span class="keyword">return</span> l</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Len-Front-Back方法"><a href="#Len-Front-Back方法" class="headerlink" title="Len, Front, Back方法"></a>Len, Front, Back方法</h4><ul>
<li>Len返回list中的元素数量，获取复杂度O(1)</li>
<li>Front方法返回列表第一个元素，也就是l.root.next</li>
<li>Back方法返回列表最后一个元素，也就是l.root.prev</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> l.<span class="built_in">len</span> &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Front</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.root.next</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Back</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.root.prev</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Remove方法"><a href="#Remove方法" class="headerlink" title="Remove方法"></a>Remove方法</h4><ul>
<li>Remove方法移除列表中指定元素，这个地方会对e.list做校验，如果不符合则不会进入remove方法</li>
<li>remove方法完成移除元素e的操作，将e.next和e.prev设置为nil，防止内存泄露</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Remove</span><span class="params">(e *Element)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	<span class="keyword">if</span> e.list == l &#123;</div><div class="line">		<span class="comment">// if e.list == l, l must have been initialized when e was inserted</span></div><div class="line">		<span class="comment">// in l or l == nil (e is a zero Element) and l.remove will crash</span></div><div class="line">		l.remove(e)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> e.Value</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// remove removes e from its list, decrements l.len, and returns e.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">remove</span><span class="params">(e *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	e.prev.next = e.next</div><div class="line">	e.next.prev = e.prev</div><div class="line">	e.next = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></div><div class="line">	e.prev = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></div><div class="line">	e.list = <span class="literal">nil</span></div><div class="line">	l.<span class="built_in">len</span>--</div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h3><ul>
<li>lazyInit方法，懒加载，延迟初始化一个空链表</li>
<li>insertValue方法是对insert的一层封装</li>
<li>insert方法将节点e插入到节点at后面</li>
<li>PushFront 将节点插入到root节点之后</li>
<li>PushBach 将节点插入到root.prev之后</li>
<li>InsertBefore 将节点插入到mark节点之前</li>
<li>InsertAfter 将节点插入到mark节点之后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFront</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, &amp;l.root)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBack</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, l.root.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertBefore</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, mark.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertAfter</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	<span class="keyword">return</span> l.insertValue(v, mark)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">lazyInit</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.root.next == <span class="literal">nil</span> &#123;</div><div class="line">		l.Init()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">List</span></span> &#123;</div><div class="line">	l.root.next = &amp;l.root</div><div class="line">	l.root.prev = &amp;l.root</div><div class="line">	l.<span class="built_in">len</span> = <span class="number">0</span></div><div class="line">	<span class="keyword">return</span> l</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">insertValue</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.insert(&amp;Element&#123;Value: v&#125;, at)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">insert</span><span class="params">(e, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	n := at.next</div><div class="line">	at.next = e</div><div class="line">	e.prev = at</div><div class="line">	e.next = n</div><div class="line">	n.prev = e</div><div class="line">	e.list = l</div><div class="line">	l.<span class="built_in">len</span>++</div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="移动节点操作"><a href="#移动节点操作" class="headerlink" title="移动节点操作"></a>移动节点操作</h4><ul>
<li>move为节点移动的核心方法，将节点e移动到节点at后面</li>
<li>MoveToFront将节点e移动到root节点之后</li>
<li>MoveToBack将节点e移动到root.prev节点之后</li>
<li>MoveBefore将节点移动到mark节点之前,这个地方如果e.next == mark的时候是不需要移动的</li>
<li>MoveAfter将节点移动到mark节点之后,这个地方如果mark.next == e 也是不需要移动的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToFront</span><span class="params">(e *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || l.root.next == e &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	l.move(e, &amp;l.root)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToBack</span><span class="params">(e *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || l.root.prev == e &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	l.move(e, l.root.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveBefore</span><span class="params">(e, mark *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	l.move(e, mark.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveAfter</span><span class="params">(e, mark *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	l.move(e, mark)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// move moves e to next to at and returns e.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">move</span><span class="params">(e, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e == at &#123;</div><div class="line">		<span class="keyword">return</span> e</div><div class="line">	&#125;</div><div class="line">	e.prev.next = e.next</div><div class="line">	e.next.prev = e.prev</div><div class="line"></div><div class="line">	n := at.next</div><div class="line">	at.next = e</div><div class="line">	e.prev = at</div><div class="line">	e.next = n</div><div class="line">	n.prev = e</div><div class="line"></div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="列表方法"><a href="#列表方法" class="headerlink" title="列表方法"></a>列表方法</h4><ul>
<li>PushBackList方法将other列表插入到l列表root.prev之后</li>
<li>PushFrontList方法将other列表插入到l列表root节点之后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBackList</span><span class="params">(other *List)</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">for</span> i, e := other.Len(), other.Front(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Next() &#123;</div><div class="line">		l.insertValue(e.Value, l.root.prev)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFrontList</span><span class="params">(other *List)</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">for</span> i, e := other.Len(), other.Back(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Prev() &#123;</div><div class="line">		l.insertValue(e.Value, &amp;l.root)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/golang/源码解读/container/heap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/golang/源码解读/container/heap/" itemprop="url">go源码解读-heap</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h2><ul>
<li>go中的堆采用小根堆实现</li>
<li>采用接口形式，也就是需要实现Push,Pop,Len,Less,Swap方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">	sort.Interface</div><div class="line">	Push(x <span class="keyword">interface</span>&#123;&#125;) <span class="comment">// add x as element Len()</span></div><div class="line">	Pop() <span class="keyword">interface</span>&#123;&#125;   <span class="comment">// remove and return element Len() - 1.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="堆的构建"><a href="#堆的构建" class="headerlink" title="堆的构建"></a>堆的构建</h3><ul>
<li>调用init来完成对于堆的构建</li>
<li>比较i与<code>2*i+1</code>, <code>2*i+2</code>的大小进行建堆</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">(h Interface)</span></span> &#123;</div><div class="line">	<span class="comment">// heapify</span></div><div class="line">	n := h.Len()</div><div class="line">	<span class="keyword">for</span> i := n/<span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		down(h, i, n)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">down</span><span class="params">(h Interface, i0, n <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	i := i0</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		j1 := <span class="number">2</span>*i + <span class="number">1</span></div><div class="line">		<span class="keyword">if</span> j1 &gt;= n || j1 &lt; <span class="number">0</span> &#123; <span class="comment">// j1 &lt; 0 after int overflow</span></div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		j := j1 <span class="comment">// left child</span></div><div class="line">		<span class="keyword">if</span> j2 := j1 + <span class="number">1</span>; j2 &lt; n &amp;&amp; h.Less(j2, j1) &#123;</div><div class="line">			j = j2 <span class="comment">// = 2*i + 2  // right child</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !h.Less(j, i) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		h.Swap(i, j)</div><div class="line">		i = j</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> i &gt; i0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Push-Pop方法"><a href="#Push-Pop方法" class="headerlink" title="Push, Pop方法"></a>Push, Pop方法</h3><ul>
<li>Push方法将数据防止在末尾，逐个节点向上调整</li>
<li>Pop方法将待出堆的节点和末尾节点交换，向下调整根节点</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Push</span><span class="params">(h Interface, x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	h.Push(x)</div><div class="line">	up(h, h.Len()<span class="number">-1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Pop is equivalent to Remove(h, 0).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pop</span><span class="params">(h Interface)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	n := h.Len() - <span class="number">1</span></div><div class="line">	h.Swap(<span class="number">0</span>, n)</div><div class="line">	down(h, <span class="number">0</span>, n)</div><div class="line">	<span class="keyword">return</span> h.Pop()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">up</span><span class="params">(h Interface, j <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		i := (j - <span class="number">1</span>) / <span class="number">2</span> <span class="comment">// parent</span></div><div class="line">		<span class="keyword">if</span> i == j || !h.Less(j, i) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		h.Swap(i, j)</div><div class="line">		j = i</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fix-Remove方法"><a href="#Fix-Remove方法" class="headerlink" title="Fix, Remove方法"></a>Fix, Remove方法</h3><ul>
<li>Remove方法移除树第i个节点，并调整堆结构</li>
<li>Fix方法在数据值便跟时调整堆结构</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Remove</span><span class="params">(h Interface, i <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	n := h.Len() - <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> n != i &#123;</div><div class="line">		h.Swap(i, n)</div><div class="line">		<span class="keyword">if</span> !down(h, i, n) &#123;</div><div class="line">			up(h, i)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> h.Pop()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fix</span><span class="params">(h Interface, i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> !down(h, i, h.Len()) &#123;</div><div class="line">		up(h, i)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="示例-优先队列"><a href="#示例-优先队列" class="headerlink" title="示例-优先队列"></a>示例-优先队列</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// An Item is something we manage in a priority queue.</span></div><div class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</div><div class="line">	value    <span class="keyword">string</span> <span class="comment">// The value of the item; arbitrary.</span></div><div class="line">	priority <span class="keyword">int</span>    <span class="comment">// The priority of the item in the queue.</span></div><div class="line">	<span class="comment">// The index is needed by update and is maintained by the heap.Interface methods.</span></div><div class="line">	index <span class="keyword">int</span> <span class="comment">// The index of the item in the heap.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// A PriorityQueue implements heap.Interface and holds Items.</span></div><div class="line"><span class="keyword">type</span> PriorityQueue []*Item</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(pq) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="comment">// We want Pop to give us the highest, not lowest, priority so we use greater than here.</span></div><div class="line">	<span class="keyword">return</span> pq[i].priority &gt; pq[j].priority</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	pq[i], pq[j] = pq[j], pq[i]</div><div class="line">	pq[i].index = i</div><div class="line">	pq[j].index = j</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">Push</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(*pq)</div><div class="line">	item := x.(*Item)</div><div class="line">	item.index = n</div><div class="line">	*pq = <span class="built_in">append</span>(*pq, item)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	old := *pq</div><div class="line">	n := <span class="built_in">len</span>(old)</div><div class="line">	item := old[n<span class="number">-1</span>]</div><div class="line">	item.index = <span class="number">-1</span> <span class="comment">// for safety</span></div><div class="line">	*pq = old[<span class="number">0</span> : n<span class="number">-1</span>]</div><div class="line">	<span class="keyword">return</span> item</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// update modifies the priority and value of an Item in the queue.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">update</span><span class="params">(item *Item, value <span class="keyword">string</span>, priority <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	item.value = value</div><div class="line">	item.priority = priority</div><div class="line">	heap.Fix(pq, item.index)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This example creates a PriorityQueue with some items, adds and manipulates an item,</span></div><div class="line"><span class="comment">// and then removes the items in priority order.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Some items and their priorities.</span></div><div class="line">	items := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;</div><div class="line">		<span class="string">"banana"</span>: <span class="number">3</span>, <span class="string">"apple"</span>: <span class="number">2</span>, <span class="string">"pear"</span>: <span class="number">4</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create a priority queue, put the items in it, and</span></div><div class="line">	<span class="comment">// establish the priority queue (heap) invariants.</span></div><div class="line">	pq := <span class="built_in">make</span>(PriorityQueue, <span class="built_in">len</span>(items))</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> value, priority := <span class="keyword">range</span> items &#123;</div><div class="line">		pq[i] = &amp;Item&#123;</div><div class="line">			value:    value,</div><div class="line">			priority: priority,</div><div class="line">			index:    i,</div><div class="line">		&#125;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	heap.Init(&amp;pq)</div><div class="line"></div><div class="line">	<span class="comment">// Insert a new item and then modify its priority.</span></div><div class="line">	item := &amp;Item&#123;</div><div class="line">		value:    <span class="string">"orange"</span>,</div><div class="line">		priority: <span class="number">1</span>,</div><div class="line">	&#125;</div><div class="line">	heap.Push(&amp;pq, item)</div><div class="line">	pq.update(item, item.value, <span class="number">5</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Take the items out; they arrive in decreasing priority order.</span></div><div class="line">	<span class="keyword">for</span> pq.Len() &gt; <span class="number">0</span> &#123;</div><div class="line">		item := heap.Pop(&amp;pq).(*Item)</div><div class="line">		fmt.Printf(<span class="string">"%.2d:%s "</span>, item.priority, item.value)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Output:</span></div><div class="line">	<span class="comment">// 05:orange 04:pear 03:banana 02:apple</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/golang/go语言实战/go语言实战-并发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/golang/go语言实战/go语言实战-并发/" itemprop="url">go语言实战 - 并发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:23:36+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="go语言实战-并发"><a href="#go语言实战-并发" class="headerlink" title="go语言实战 - 并发"></a>go语言实战 - 并发</h1><h2 id="第六章-并发"><a href="#第六章-并发" class="headerlink" title="第六章 并发"></a>第六章 并发</h2><ul>
<li>go语言的并发是指让某个函数独立于其他函数运行的能力</li>
<li>go语言的并发同步模型来自于<em>通信顺序进程</em>泛型(Communication SequentialProcess，CSP)<ul>
<li>CSP是一种消息传递模型，通过在goroutine之间传递数据来传递消息，而非对数据加锁来实现同步访问</li>
<li>go引入了新数据类型，通道channle</li>
</ul>
</li>
</ul>
<h3 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a>并发与并行</h3><ul>
<li><p>操作系统的进程与线程</p>
<ul>
<li>进程包含了应用程序在运行时需要用到和维护的各种资源的容器，如内存地址空间，文件，设备的句柄及线程</li>
<li>线程是一个执行空间，被操作系统调度来执行代码</li>
</ul>
</li>
<li><p>操作系统会在物理处理器上调度线程来运行，go语言会在逻辑处理器上调度goroutine来运行</p>
</li>
<li>go语言默认给每个可用的物理处理器分配一个逻辑处理器</li>
<li>一个逻辑处理器可以调度无数个goroutine<ul>
<li>创建一个goroutine并准备运行</li>
<li>goroutine会首先进入调度器的全局运行队列中</li>
<li>调度器将队列中的goroutine分配给一个逻辑处理器，也就是将goroutinue放置到逻辑处理器对应的本地运行队列中</li>
<li>本地运行队列中的goroutine会等待到自己被分配的逻辑处理器执行</li>
</ul>
</li>
</ul>
<h3 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h3><ul>
<li>runtime.GOMAXPROCS可以更改调度器可以使用的逻辑处理器的数量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	runtime.GOMAXPROCS(<span class="number">1</span>)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Start Goroutine"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">		<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">3</span>; count++ &#123;</div><div class="line">			<span class="keyword">for</span> char := <span class="string">'a'</span>; char &lt; <span class="string">'z'</span>; char++ &#123;</div><div class="line">				fmt.Printf(<span class="string">"%c"</span>, char)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">		<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">3</span>; count++ &#123;</div><div class="line">			<span class="keyword">for</span> char := <span class="string">'A'</span>; char &lt; <span class="string">'Z'</span>; char++ &#123;</div><div class="line">				fmt.Printf(<span class="string">"%c"</span>, char)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Waiting To Finish"</span>)</div><div class="line">	wg.Wait()</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Finish this"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>设置一个逻辑处理器的结果</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Start Goroutine</div><div class="line">Waiting To Finish</div><div class="line">A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y</div><div class="line">Finish this</div></pre></td></tr></table></figure>
<ul>
<li>设置多个逻辑处理器的结果</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Start Goroutine</div><div class="line">Waiting To Finish</div><div class="line">a b c d e f g h A B C D E F G H I J K L M N i j k l m n o p q r O P Q R S s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y</div><div class="line">Finish this</div></pre></td></tr></table></figure>
<ul>
<li>一个正运行的goroutine再工作结束前，可以被停止并重新调度，避免一个goroutine长时间占用逻辑处理器</li>
<li>runtime包提供了修改go语言运行时配置参数的能力</li>
<li>并不是逻辑处理器数量越多越好，需要经过基准测试来评估</li>
</ul>
<h3 id="竞争状态"><a href="#竞争状态" class="headerlink" title="竞争状态"></a>竞争状态</h3><ul>
<li>两个或者多个goroutine访问某个共享资源，则称其处于互相竞争的状态</li>
<li>runtime.Gosched()强制调度器切换两个goroutine</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter <span class="keyword">int</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line">		value := counter</div><div class="line">		<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">		runtime.Gosched()</div><div class="line"></div><div class="line">		value++</div><div class="line">		counter = value</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="锁住共享资源"><a href="#锁住共享资源" class="headerlink" title="锁住共享资源"></a>锁住共享资源</h3><h4 id="原子函数"><a href="#原子函数" class="headerlink" title="原子函数"></a>原子函数</h4><ul>
<li>原子函数能够以底层的加锁机制来同步访问整醒变量和指针</li>
<li>atomic包的AddInt64函数会同步整型值的加法，强制同一时刻只能有一个goroutine运行并完成这个加法操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter <span class="keyword">int64</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line"></div><div class="line">		atomic.AddInt64(&amp;counter, <span class="number">1</span>)</div><div class="line"></div><div class="line">		<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">		runtime.Gosched()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LoadInt64和StoreInt64提供了一种安全地读写一个整型值的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	shutdown <span class="keyword">int64</span></div><div class="line">	wg sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> doWork(<span class="string">"A"</span>)</div><div class="line">	<span class="keyword">go</span> doWork(<span class="string">"B"</span>)</div><div class="line"></div><div class="line">	time.Sleep(<span class="number">1</span>*time.Second)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"shutdown now"</span>)</div><div class="line"></div><div class="line">	atomic.StoreInt64(&amp;shutdown, <span class="number">1</span>)</div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(name <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"Doing %s Work \n"</span>, name)</div><div class="line">		time.Sleep(<span class="number">250</span>*time.Millisecond)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> atomic.LoadInt64(&amp;shutdown) == <span class="number">1</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"Shutting %s Down \n"</span>, name)</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h3><ul>
<li>互斥锁mutex用于在代码上创建一个临界区，保证统一时间只有一个goroutine可以执行这个临界区代码，修正上述代码如下</li>
<li>使用大括号可以使得临界区看起来更加清晰</li>
<li>强制退出当前线程之后，如果调度器分配其他线程执行，会因为拿不到临界区的互斥锁而等待，从而保证调度器会分配回当前线程来进行程序继续执行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter   <span class="keyword">int</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">	mutex     sync.Mutex</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line">		mutex.Lock()</div><div class="line">		&#123;</div><div class="line">			value := counter</div><div class="line">			<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">			runtime.Gosched()</div><div class="line"></div><div class="line">			value++</div><div class="line">			counter = value</div><div class="line">		&#125;</div><div class="line">		mutex.Unlock()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通道"><a href="#通道" class="headerlink" title="通道"></a>通道</h3><ul>
<li>通道通过发送和接收需要共享的资源，在goroutine之间做同步</li>
<li>声明通道时，需要指定将要被共享的数据的类型，可以通过通道共享内置类型，命名类型，结构类型和引用类型的值或者指针</li>
<li>make关键字来创建通道</li>
<li><code>&lt;-</code>运算符表示数据的流向</li>
</ul>
<h4 id="无缓冲的通道"><a href="#无缓冲的通道" class="headerlink" title="无缓冲的通道"></a>无缓冲的通道</h4><ul>
<li>无缓冲的通道指的是接手前没有能力保存任何值的通道</li>
<li>这种对通道进行发送和接收的交互 行为本身就是同步的，否则会阻塞，发送和接收的goroutine互相依赖</li>
<li>网球比赛示例如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> wg sync.WaitGroup</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UnixNano())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	court := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> player(<span class="string">"Nodal"</span>, court)</div><div class="line">	<span class="keyword">go</span> player(<span class="string">"Dick"</span>, court)</div><div class="line"></div><div class="line">	court &lt;- <span class="number">1</span></div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">player</span><span class="params">(name <span class="keyword">string</span>, court <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		ball, ok := &lt;- court</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			fmt.Printf(<span class="string">"Player %s win \n"</span>, name)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		n := rand.Intn(<span class="number">100</span>)</div><div class="line">		<span class="keyword">if</span> n % <span class="number">13</span> == <span class="number">0</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"Player %s missed \n"</span>, name)</div><div class="line">			<span class="built_in">close</span>(court)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		fmt.Printf(<span class="string">"Player %s hit %d \n"</span>, name, ball)</div><div class="line"></div><div class="line">		ball++</div><div class="line"></div><div class="line">		court &lt;- ball</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="有缓冲通道"><a href="#有缓冲通道" class="headerlink" title="有缓冲通道"></a>有缓冲通道</h3><ul>
<li>有缓冲通道时一种在被接收前能存储一个或多个值的通道</li>
<li>并不强制要求goroutine之间必须同时完成接收和发送</li>
<li>4个goroutine来完成10个工作可以使用带缓冲的通道来实现</li>
<li>需要注意，通道关闭之后是只能从通道读取数据，不能写入，不会有数据丢失</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	numberGoroutine = <span class="number">4</span></div><div class="line">	taskLoad = <span class="number">10</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> wg sync.WaitGroup</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UnixNano())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	tasks := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, taskLoad)</div><div class="line">	wg.Add(numberGoroutine)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> gr := <span class="number">1</span>; gr &lt;= numberGoroutine; gr++ &#123;</div><div class="line">		<span class="keyword">go</span> worker(tasks, gr)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> post := <span class="number">1</span>; post &lt;= taskLoad; post++ &#123;</div><div class="line">		tasks &lt;- fmt.Sprintf(<span class="string">"Task %d"</span>, post)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">close</span>(tasks)</div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(tasks <span class="keyword">chan</span> <span class="keyword">string</span>, worker <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		task, ok := &lt;- tasks</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			fmt.Printf(<span class="string">"Worker %d shutdown \n"</span>, worker)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		fmt.Printf(<span class="string">"Worker %d start work %s \n"</span>, worker, task)</div><div class="line"></div><div class="line">		time.Sleep(time.Duration(rand.Int63n(<span class="number">100</span>))*time.Millisecond)</div><div class="line">		fmt.Printf(<span class="string">"Worker %d finshed work %s \n"</span>, worker, task)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">Worker 2 start work Task 1</span></div><div class="line"><span class="comment">Worker 4 start work Task 4</span></div><div class="line"><span class="comment">Worker 1 start work Task 2</span></div><div class="line"><span class="comment">Worker 3 start work Task 3</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 4</span></div><div class="line"><span class="comment">Worker 4 start work Task 5</span></div><div class="line"><span class="comment">Worker 1 finshed work Task 2</span></div><div class="line"><span class="comment">Worker 1 start work Task 6</span></div><div class="line"><span class="comment">Worker 3 finshed work Task 3</span></div><div class="line"><span class="comment">Worker 3 start work Task 7</span></div><div class="line"><span class="comment">Worker 2 finshed work Task 1</span></div><div class="line"><span class="comment">Worker 2 start work Task 8</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 5</span></div><div class="line"><span class="comment">Worker 4 start work Task 9</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 9</span></div><div class="line"><span class="comment">Worker 4 start work Task 10</span></div><div class="line"><span class="comment">Worker 1 finshed work Task 6</span></div><div class="line"><span class="comment">Worker 1 shutdown</span></div><div class="line"><span class="comment">Worker 2 finshed work Task 8</span></div><div class="line"><span class="comment">Worker 3 finshed work Task 7</span></div><div class="line"><span class="comment">Worker 3 shutdown</span></div><div class="line"><span class="comment">Worker 2 shutdown</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 10</span></div><div class="line"><span class="comment">Worker 4 shutdown</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>并发是指goroutine运行的时候是互相独立的</li>
<li>使用关键字go创建goroutine来运行函数</li>
<li>goroutine在逻辑处理器上执行，而逻辑处理器则具有独立的系统线程和运行队列</li>
<li>竞争状态是指两个或者多个goroutine试图访问同一个资源</li>
<li>原子函数和互斥锁提供了一种防止出现竞争状态的方法</li>
<li>通道提供了一种在两个goroutine之间共享数据的简单方法</li>
<li>无缓冲的通道保证同时交换数据，有缓冲的通道不做这种保证</li>
</ul>
<h2 id="第七章-并发模式"><a href="#第七章-并发模式" class="headerlink" title="第七章 并发模式"></a>第七章 并发模式</h2><h3 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h3><ul>
<li>runner包用于展示如何通过通道来监视程序的执行时间</li>
<li>runner包也可以终止程序</li>
<li>适合用于定时任务中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrTimeout = errors.New(<span class="string">"received timeout"</span>)</div><div class="line"><span class="keyword">var</span> ErrInterrupt = errors.New(<span class="string">"received interrupt"</span>)</div><div class="line"></div><div class="line"><span class="comment">// Runner 在给定的超时时间内执行一组任务，并且在操作系统发出终端信号时结束这些任务</span></div><div class="line"><span class="keyword">type</span> Runner <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// 操作系统信号</span></div><div class="line">	interrupt <span class="keyword">chan</span> os.Signal</div><div class="line"></div><div class="line">	complete <span class="keyword">chan</span> error</div><div class="line"></div><div class="line">	timeout &lt;-<span class="keyword">chan</span> time.Time</div><div class="line"></div><div class="line">	tasks []<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewRunner</span><span class="params">(d time.Duration)</span> *<span class="title">Runner</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Runner&#123;</div><div class="line">		interrupt: <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>),</div><div class="line">		complete: <span class="built_in">make</span>(<span class="keyword">chan</span> error),</div><div class="line">		timeout: time.After(d),</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Add</span><span class="params">(tasks ...<span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span>  &#123;</div><div class="line">	r.tasks = <span class="built_in">append</span>(r.tasks, tasks...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	signal.Notify(r.interrupt, os.Interrupt)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		r.complete &lt;- r.run()</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> err := &lt;- r.complete:</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	<span class="keyword">case</span> &lt;-r.timeout:</div><div class="line">		<span class="keyword">return</span> ErrTimeout</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> id, task := <span class="keyword">range</span> r.tasks &#123;</div><div class="line">		<span class="keyword">if</span> r.gotInterrupt() &#123;</div><div class="line">			<span class="keyword">return</span> ErrInterrupt</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		task(id)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">gotInterrupt</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;- r.interrupt:</div><div class="line">		signal.Stop(r.interrupt)</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>函数调用方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> timeout = <span class="number">3</span> * time.Second</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"Starting work"</span>)</div><div class="line"></div><div class="line">	r := runner.NewRunner(timeout)</div><div class="line"></div><div class="line">	r.Add(createTask(), createTask(), createTask())</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := r.Start(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">switch</span> err &#123;</div><div class="line">		<span class="keyword">case</span> runner.ErrTimeout:</div><div class="line">			log.Println(<span class="string">"Terminating due to timeout."</span>)</div><div class="line">			os.Exit(<span class="number">1</span>)</div><div class="line">		<span class="keyword">case</span> runner.ErrInterrupt:</div><div class="line">			log.Println(<span class="string">"Terminating due to interrupt"</span>)</div><div class="line">			os.Exit(<span class="number">2</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	log.Println(<span class="string">"Process ended."</span>)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createTask</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">		log.Printf(<span class="string">"Processor - Task %d."</span>, id)</div><div class="line">		time.Sleep(time.Duration(id) * time.Second)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h3><ul>
<li>pool用于展示如何使用有缓冲的通道实现资源池</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pool</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"errors"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	m sync.Mutex</div><div class="line">	resources <span class="keyword">chan</span> io.Closer</div><div class="line">	factory <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span></div><div class="line"><span class="function">	<span class="title">closed</span> <span class="title">bool</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPool</span><span class="params">(fn <span class="keyword">func</span>()</span> <span class="params">(io.Closer, error)</span>, <span class="title">size</span> <span class="title">uint</span>) <span class="params">(*Pool, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"size value too small"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;Pool&#123;</div><div class="line">		factory:fn,</div><div class="line">		resources: <span class="built_in">make</span>(<span class="keyword">chan</span> io.Closer, size),</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrPoolClosed = errors.New(<span class="string">"pool has been closed"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Acquire</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> r, ok := &lt;- p.resources:</div><div class="line">		log.Println(<span class="string">"Acquire:"</span>, <span class="string">"Shared Resource"</span>)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrPoolClosed</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> r, <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		log.Println(<span class="string">"Acquire:"</span>, <span class="string">"New Resource"</span>)</div><div class="line">		<span class="keyword">return</span> p.factory()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Release</span><span class="params">(r io.Closer)</span></span> &#123;</div><div class="line">	p.m.Lock()</div><div class="line">	<span class="keyword">defer</span> p.m.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> p.closed &#123;</div><div class="line">		r.Close()</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> p.resources &lt;- r:</div><div class="line">		log.Println(<span class="string">"Release: "</span>, <span class="string">"In Queue"</span>)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		log.Println(<span class="string">"Release:"</span>, <span class="string">"Closing"</span>)</div><div class="line">		r.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</div><div class="line">	p.m.Lock()</div><div class="line">	<span class="keyword">defer</span> p.m.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> p.closed &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	p.closed = <span class="literal">true</span></div><div class="line"></div><div class="line">	<span class="built_in">close</span>(p.resources)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> r := <span class="keyword">range</span> p.resources&#123;</div><div class="line">		r.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>连接池的使用代码如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"api/books/go-in-action/7-concurrency-pattern/pool"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"sync/atomic"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	maxGoroutines = <span class="number">25</span></div><div class="line">	poolResources = <span class="number">2</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> dbConnection <span class="keyword">struct</span> &#123;</div><div class="line">	ID <span class="keyword">int32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(conn *dbConnection)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"Close: Connection"</span>, conn.ID)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> idCounter <span class="keyword">int32</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createConnection</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</div><div class="line">	id := atomic.AddInt32(&amp;idCounter, <span class="number">1</span>)</div><div class="line">	log.Println(<span class="string">"Create: New Connection"</span>, id)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;dbConnection&#123;ID:id&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(maxGoroutines)</div><div class="line"></div><div class="line">	p, err := pool.NewPool(createConnection, poolResources)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> query := <span class="number">0</span>; query &lt; maxGoroutines; query++ &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(q <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			performQueries(q, p)</div><div class="line">			wg.Done()</div><div class="line">		&#125;(query)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">	log.Println(<span class="string">"Shutdown Program"</span>)</div><div class="line">	p.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">performQueries</span><span class="params">(query <span class="keyword">int</span>, p *pool.Pool)</span></span> &#123;</div><div class="line">	conn, err := p.Acquire()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> p.Release(conn)</div><div class="line"></div><div class="line">	time.Sleep(time.Duration(rand.Intn(<span class="number">1000</span>)) * time.Millisecond)</div><div class="line">	log.Printf(<span class="string">"QID[%d] CID[%d] \n"</span>, query, conn.(*dbConnection).ID)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="work"><a href="#work" class="headerlink" title="work"></a>work</h3><ul>
<li>work包的目的是展示如何使用无缓冲的通道来创建一个goroutine池</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> work</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Worker <span class="keyword">interface</span> &#123;</div><div class="line">	Task()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	work <span class="keyword">chan</span> Worker</div><div class="line">	wg sync.WaitGroup</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(maxGoroutines <span class="keyword">int</span>)</span> *<span class="title">Pool</span></span> &#123;</div><div class="line">	p := Pool&#123;</div><div class="line">		work: <span class="built_in">make</span>(<span class="keyword">chan</span> Worker),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	p.wg.Add(maxGoroutines)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; maxGoroutines; i++ &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> w := <span class="keyword">range</span> p.work &#123;</div><div class="line">				w.Task()</div><div class="line">			&#125;</div><div class="line">			p.wg.Done()</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;p</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Run</span><span class="params">(w Worker)</span></span> &#123;</div><div class="line">	p.work &lt;- w</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Shutdown</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="built_in">close</span>(p.work)</div><div class="line">	p.wg.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>运行函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"api/books/go-in-action/7-concurrency-pattern/work"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> names = []<span class="keyword">string</span> &#123;</div><div class="line">	<span class="string">"steve"</span>,</div><div class="line">	<span class="string">"bob"</span>,</div><div class="line">	<span class="string">"mary"</span>,</div><div class="line">	<span class="string">"therese"</span>,</div><div class="line">	<span class="string">"jason"</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> namePrinter <span class="keyword">struct</span> &#123;</div><div class="line">	name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *namePrinter)</span> <span class="title">Task</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(m.name)</div><div class="line">	time.Sleep(time.Second)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	p := work.New(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(<span class="number">100</span> * <span class="built_in">len</span>(names))</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</div><div class="line">		<span class="keyword">for</span> _, name := <span class="keyword">range</span> names &#123;</div><div class="line">			np := namePrinter&#123;name:name&#125;</div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">				p.Run(&amp;np)</div><div class="line">				wg.Done()</div><div class="line">			&#125;()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	wg.Wait()</div><div class="line">	p.Shutdown()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><ul>
<li>可以使用通道来控制程序的声明周期</li>
<li>带default分支的select语句可以用来尝试向通道发送或者接受数据，而不会被阻塞</li>
<li>有缓冲的通道可以用来管理一组可服用的资源</li>
<li>语言运行时会处理好通道的协作和同步</li>
<li>使用无缓冲的通道来创建完成工作的goroutines池</li>
<li>任何时间都可以用无缓冲的通道来让两个goroutine交换数据，在通道操作完成时一定保证对方接收到了数据</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">89</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
