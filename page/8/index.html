<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/8/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/1_函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/1_函数/" itemprop="url">1. 函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>我们知道圆的计算公式是：</p>
<p><strong>S=π<em>r</em>r</strong></p>
<p>当我们知道圆的半径r时，就可以很快的计算出圆的面积：</p>
<blockquote>
<p>r1=12.34<br>s1=3.14<em>r1</em>r1</p>
</blockquote>
<p> 当代码出现规律的重复时，你就需要当心了，每次写<code>3.14*x*x</code>不仅很麻烦，而且，如果要把<code>3.14</code>改为<code>3.14159265359</code> 的时候就要全部替换。</p>
<p>有了函数，我们就不用再每次 再写<code>s=3.14*x*x</code>而是写成更有意义的函数调用<code>s=area_of_circle(x)</code>,而函数<code>area_of _circle(x)</code>本身只需要写一次就可以多次调用。</p>
<p>基本上所有的高级语言都支持函数，Python也不例外。Python不但能非常灵活的定义函数，而且本身内置了很多有用的函数，可以直接调用。</p>
<hr>
<h2 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h2><hr>
<p>Python内置了很多有用的函数，我们可以直接调用。</p>
<p>要调用一个函数，需要知道函数的名称和参数，比如求绝对值的函数<code>abs</code>,只有一个参数。可以直接在Python的官方网站查看文档：</p>
<p> <a href="http://docs.python.org/3/library/functions.html#abs" target="_blank" rel="external">http://docs.python.org/3/library/functions.html#abs</a></p>
<p> 也可以在交互式命令行通过<code>help(abs)</code>查看abs函数的帮助信息。<br>调用<code>abs</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">100</span>)</div><div class="line"><span class="number">100</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">-256</span>)</div><div class="line"><span class="number">256</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="number">-12.88</span>)</div><div class="line"><span class="number">12.88</span></div></pre></td></tr></table></figure>
<p>调用函数时，如果传入的参数的数量不对，会报<code>TperError</code>的 错误，并且给出错位信息：<code>str</code>是错误的参数类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; abs(&apos;a&apos;)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</div><div class="line">TypeError: bad operand type for abs(): &apos;str&apos;</div></pre></td></tr></table></figure>
<p>而<code>max</code>函数<code>max()</code>可以接收任意多个参数，并返回最大的那个：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>max(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">45</span>,<span class="number">65</span>,<span class="number">334</span>)</div><div class="line"><span class="number">334</span></div></pre></td></tr></table></figure>
<h3 id="数据类型转换"><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h3><p>Python内置的常用函数还包括数据类型转换函数，比如<code>int()</code>函数可以把其他数据类型转换为整数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>int(<span class="string">'1234'</span>)</div><div class="line"><span class="number">1234</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>int(<span class="number">12.34</span>)</div><div class="line"><span class="number">12</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>float(<span class="number">12.34</span>)</div><div class="line"><span class="number">12.34</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>str(<span class="number">1.23</span>)</div><div class="line"><span class="string">'1.23'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>str(<span class="number">100</span>)</div><div class="line"><span class="string">'100'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>bool(<span class="number">1</span>)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>bool(<span class="string">''</span>)</div><div class="line"><span class="keyword">False</span></div></pre></td></tr></table></figure></p>
<p>函数名其实就是指向一个函数对象的引用，完全可以把函数名赋给一个变量，相当于给这个函数起了一个别名：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>a=abs        <span class="comment">#变量a指向abs函数</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>a(<span class="number">-1</span>)        <span class="comment">#所以可以通过a来调用函数</span></div><div class="line"><span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p>请用Python内置的<code>hex()</code>函数把一个整数转换成十六进制表示的字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>n1=<span class="number">255</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>n2=<span class="number">1000</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(str(hex(n1)))</div><div class="line"><span class="number">0xff</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(str(hex(n2)))</div><div class="line"><span class="number">0x3e8</span></div></pre></td></tr></table></figure>
<h2 id="定义函数"><a href="#定义函数" class="headerlink" title="定义函数"></a>定义函数</h2><hr>
<p>在Python中，定义一个函数要使用<code>def</code>语句，依次写出函数名，括号，括号中的参数和冒号<code>:</code>，然后在缩进块中编写函数体，函数的返回值用<code>return</code>语句返回。</p>
<p>我们自定义一个求绝对值的<code>my_abs</code>函数为例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">my_abs</span><span class="params">(x)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> x&gt;=<span class="number">0</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> x</div><div class="line"><span class="meta">... </span>    <span class="keyword">else</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> -x</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_abs(<span class="number">-1524</span>)</div><div class="line"><span class="number">1524</span></div></pre></td></tr></table></figure>
<blockquote>
<p>请注意，函数内部结构的的语句在执行时，一旦执行到return时，函数就执行完毕，并将结果返回。因此，函数内部可以通过条件判断和循环实现非常复杂的逻辑。<br>如果没有<code>return</code>语句，函数执行完也会返回结果，只是结果为<code>None</code>.</p>
</blockquote>
<h3 id="空函数"><a href="#空函数" class="headerlink" title="空函数"></a>空函数</h3><p>如果想定义一个什么事业不做的空函数，可以用<code>pass</code>语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">nop</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">pass</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p><code>pass</code>语句什么都不做，有什么用？实际上<code>pass</code>可以用来作为占位符，比如现在还没有想好怎么写函数的代码，可以先放一个<code>pass</code>，让代码能运行起来。</p>
<p><code>pass</code>还可以用在其他语句里，比如：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; <span class="keyword">if</span> age&gt;=<span class="number">18</span>:</div><div class="line">..     <span class="keyword">pass</span></div><div class="line">..</div></pre></td></tr></table></figure></p>
<p>缺少了<code>pass</code>，代码运行就会有语法错误。</p>
<h3 id="参数检查"><a href="#参数检查" class="headerlink" title="参数检查"></a>参数检查</h3><p>调用函数是，如果参数个数不对，Python解释器会自动检查出来，并抛出<code>TypeError</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_abs(<span class="number">1</span>,<span class="number">12</span>,<span class="number">-5</span>)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">TypeError: my_abs() takes <span class="number">1</span> positional argument but <span class="number">3</span> were given</div></pre></td></tr></table></figure>
<p>单数如果参数类型不对，Python解释器就无法帮我们检查。试试<code>my_abs</code>和内置函数<code>abs</code>的区别：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>my_abs(<span class="string">'x'</span>)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">2</span>, <span class="keyword">in</span> my_abs</div><div class="line">TypeError: unorderable types: str() &gt;= int()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>abs(<span class="string">'x'</span>)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>,   <span class="keyword">in</span> &lt;module&gt;</div><div class="line">TypeError: bad operand type <span class="keyword">for</span> abs(): <span class="string">'str'</span></div></pre></td></tr></table></figure>
<blockquote>
<p>当传入了不恰当的参数时，内置函数<code>abs</code>会检查出参数错误，而我们定义的<code>my_abs</code>没有参数检查，会导致<code>if</code>语句出错，出错信息和<code>abs</code>不一样，所以这个函数定义的不够好。<br>让我们修改一下<code>my_abs</code>的定义，对参数进行检查，只允许整数和浮点数类型的参数。数据类型的检查可以用内置函数<code>isinstance()</code>来实现：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">my_abs</span><span class="params">(x)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(x,(int,float)):</div><div class="line"><span class="meta">... </span>            <span class="keyword">raise</span> TypeError(<span class="string">'bad operand type'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> x&gt;=<span class="number">0</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> x</div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> x&lt;<span class="number">0</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> -x</div></pre></td></tr></table></figure>
<h3 id="返回多个值"><a href="#返回多个值" class="headerlink" title="返回多个值"></a>返回多个值</h3><p>函数可以返回多个值吗？答案是肯定的。</p>
<p>比如在游戏中经常需要从一个点移动到另一个点，给出坐标，位移和角度，就可以计算出新的坐标：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> math</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">move</span><span class="params">(x,y,step,angle=<span class="number">0</span>)</span>:</span></div><div class="line"><span class="meta">... </span>    nx=x+step*math.cos(angle)</div><div class="line"><span class="meta">... </span>    ny=y+step*math.sin(angle)</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> nx, ny</div><div class="line">...</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<p><code>import math</code>语句表示导入<code>math</code>包，并允许后续代码引用<code>math</code>包里面的<code>sin</code> ,<code>cos</code>等函数。<br>然后我们就可以同时获得返回值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>x,y=move(<span class="number">100</span>,<span class="number">100</span>,<span class="number">60</span>,math.pi/<span class="number">6</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(x,y)</div><div class="line"><span class="number">151.96152422706632</span> <span class="number">130.0</span></div></pre></td></tr></table></figure>
<p>但是其实这只是一个假象，Python函数返回的仍然是单一值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>r=move(<span class="number">100</span>,<span class="number">100</span>,<span class="number">60</span>,math.pi/<span class="number">6</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(r)</div><div class="line">(<span class="number">151.96152422706632</span>, <span class="number">130.0</span>)</div></pre></td></tr></table></figure>
<p>原来返回的是一个tuple，但是，在语法上面，返回一个tuple是可以省略括号，而多个变量可以同时接收一个tuple，按位置赋给对应的值，所以，Python的函数的返回多值，实际上就是返回一个tuple，但是写起来方便很多。</p>
<h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> math</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">quadratic</span><span class="params">(a,b,c)</span>:</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">not</span> isinstance(a,(int,float)):</div><div class="line">		<span class="keyword">raise</span> TypeError(<span class="string">'输入的数据类型错误'</span>)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">not</span> isinstance(b,(int,float)):</div><div class="line">		<span class="keyword">raise</span> TypeError(<span class="string">'输入的数据类型错误'</span>)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">not</span> isinstance(c,(int,float)):</div><div class="line">		<span class="keyword">raise</span> TypeError(<span class="string">'输入的数据类型错误'</span>)</div><div class="line"></div><div class="line">	d=b*b<span class="number">-4</span>*a*c</div><div class="line"></div><div class="line">	<span class="keyword">if</span> a!=<span class="number">0</span>:</div><div class="line">		<span class="keyword">if</span> d&gt;<span class="number">0</span>:</div><div class="line">			s=<span class="string">'方程有两个不同的实数根'</span></div><div class="line">			x1=(-b+math.sqrt(d))/<span class="number">2</span>/a</div><div class="line">			x2=(-b-math.sqrt(d))/<span class="number">2</span>/a</div><div class="line">			<span class="keyword">return</span> s,x1,x2</div><div class="line">		<span class="keyword">elif</span> d==<span class="number">0</span>:</div><div class="line">			s=<span class="string">'方程有两个相同的实数根'</span></div><div class="line">			x1=-b/<span class="number">2</span>/a</div><div class="line">			x2=-b/<span class="number">2</span>/a</div><div class="line">			<span class="keyword">return</span> s,x1,x2</div><div class="line">		<span class="keyword">else</span>:</div><div class="line">			s=<span class="string">'方程有两个不同的复数根'</span></div><div class="line">			<span class="keyword">return</span> s</div><div class="line">	<span class="keyword">elif</span> b!=<span class="number">0</span>:</div><div class="line">		s=<span class="string">'方程有一个实数根'</span></div><div class="line">		x1=-c/b</div><div class="line">		<span class="keyword">return</span> s,x1</div><div class="line">	<span class="keyword">elif</span> c!=<span class="number">0</span>:</div><div class="line">		s=<span class="string">'方程无解'</span></div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	<span class="keyword">else</span>:</div><div class="line">		s=<span class="string">'方程无意义'</span></div><div class="line">		<span class="keyword">return</span> s</div><div class="line"></div><div class="line">r=quadratic(<span class="number">1</span>,<span class="number">4</span>,<span class="number">2</span>)</div><div class="line">print(r)</div><div class="line"></div><div class="line"></div><div class="line">F:\python&gt;python jiefangcheng.py</div><div class="line">(<span class="string">'方程有两个不同的实数根'</span>, <span class="number">-0.5857864376269049</span>, <span class="number">-3.414213562373095</span>)</div></pre></td></tr></table></figure>
<hr>
<h2 id="函数的参数"><a href="#函数的参数" class="headerlink" title="函数的参数"></a>函数的参数</h2><p>定义函数的时候，我们把参数的名字和位置确定下来，函数的接口定义就完成了。对于函数的调用者来说，只需要知道如何传递正确的参数，以及函数将返回什么样的值就足够了，函数内部的复杂逻辑被封装起来，调用者无需了解。</p>
<p>Python的函数定义非常简单，但灵活度却很大。除了正常定义的必选参数外，还可以使用默认参数，可变参数和关键字参数，是的函数定义出来的接口，不但能处理复杂的参数，还可以简化调用者的代码。</p>
<h3 id="位置参数"><a href="#位置参数" class="headerlink" title="位置参数"></a>位置参数</h3><p>我们先写一个计算x的平方的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">power</span><span class="params">(x)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> x*x</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">5</span>)</div><div class="line"><span class="number">25</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">52</span>)</div><div class="line"><span class="number">2704</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>对于<code>power(x)</code>的函数，参数x就是一个位置参数。当我们调用<code>power</code>函数时，必须传入有且仅有一参数x。</p>
</blockquote>
<p>现在，我们要计算x³怎么办？计算xⁿ怎么办，我们可以把<code>power(x)</code>改为`power(x,n)，用来计算xⁿ：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">power</span><span class="params">(x,n)</span>:</span></div><div class="line"><span class="meta">... </span>    s=<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n&gt;<span class="number">0</span>:</div><div class="line"><span class="meta">... </span>            n=n<span class="number">-1</span></div><div class="line"><span class="meta">... </span>            s=s*x</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> s</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">5</span>,<span class="number">5</span>)</div><div class="line"><span class="number">3125</span></div></pre></td></tr></table></figure>
<blockquote>
<p>修改后的<code>power(x,n)</code>函数有两个参数：x和n，这两个参数都是位置参数，调用函数时，传入的两个值按照位置顺序依次赋给x和n。</p>
</blockquote>
<h3 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h3><p>新的<code>power(x,n)</code>函数没有问题，但是，旧的调用代码失败了，原因是我们增加了一个参数，导致旧的代码因为缺少一个参数而无法正常调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">5</span>)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">TypeError: power() missing <span class="number">1</span> required positional argument: <span class="string">'n'</span></div></pre></td></tr></table></figure>
<p>Python的错误信息很明确：调用函数<code>power( )</code>缺少了一个位置信息n。</p>
<blockquote>
<p>这个时候默认参数就派上用场了。由于我们经常计算x²，所以，完全可以把第二个参数n默认值设为2：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">power</span><span class="params">(x,n=<span class="number">2</span>)</span>:</span></div><div class="line"><span class="meta">... </span>    s=<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n&gt;<span class="number">0</span>:</div><div class="line"><span class="meta">... </span>            n=n<span class="number">-1</span></div><div class="line"><span class="meta">... </span>            s=s*x</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> s</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">5</span>)</div><div class="line"><span class="number">25</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>power(<span class="number">5</span>,<span class="number">5</span>)</div><div class="line"><span class="number">3125</span></div></pre></td></tr></table></figure>
<blockquote>
<p>这个例子可以看出，默认参数可以简化函数的调用。设置默认参数时，要注意以下几点：</p>
<blockquote>
<p>1.必选参数在前，默认参数在后，否则Python的解释器会报错<br>2.如何设置默认参数：<br>把变化大的参数放在前面，变化小的参数放后面。变化小的参数可以做默认参数。</p>
</blockquote>
</blockquote>
<p>使用默认参数的好处是能降低调用函数的难度。</p>
<blockquote>
<p>举个例子，我们写个一年级小学生的注册的函数，需要传入<code>name</code>和<code>gender</code>两个参数：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">enroll</span><span class="params">(name,gender)</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'name:'</span>,name)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'gender:'</span>,gender)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>enroll(<span class="string">'James'</span>,<span class="string">'D'</span>)</div><div class="line">name: James</div><div class="line">gender: D</div></pre></td></tr></table></figure>
<p>这样，调用<code>enroll()</code>函数需要传入两个参数。如果要继续传入年龄，城市信息等信息怎么办？这样会使得调用函数的复杂度大大增大。我们可以把年龄和城市设为默认参数，这样大多数学生注册时不需要提供年龄和城市，只需要提供必需的两个参数，只有与默认的参数不符的学生才需要提供额外信息：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">enroll</span><span class="params">(name,gender,age=<span class="number">7</span>,city=<span class="string">'Beijing'</span>)</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'name:'</span>,name)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'gender:'</span>,gender)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'age:'</span>,age)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'city:'</span>,city)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>enroll(<span class="string">'James'</span>,<span class="string">'D'</span>)</div><div class="line">name: James</div><div class="line">gender: D</div><div class="line">age: <span class="number">7</span></div><div class="line">city: Beijing</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>enroll(<span class="string">'James'</span>,<span class="string">'D'</span>,<span class="number">6</span>,<span class="string">'Shanghai'</span>)</div><div class="line">name: James</div><div class="line">gender: D</div><div class="line">age: <span class="number">6</span></div><div class="line">city: Shanghai</div></pre></td></tr></table></figure>
<p>可见，默认参数降低了函数的复杂度，而一旦函数需要更复杂的调用时，又可以传递更多的参数来实现。无论是简单调用还是复杂调用，函数只需要定义一个。</p>
<p>有多个默认参数时，调用的时候，既可以按照顺序提供默认参数，比如调用<code>enroll(&#39;Bob&#39;,&#39;M&#39;,7)</code>，意思是除了<code>name</code>和<code>gender</code>两个参数外，最后一个参数应用在参数<code>age</code>上，<code>city</code>上则使用默认值。</p>
<p>也可以不按照顺序提供默认参数。当不按照顺序提供默认参数的时候，需要把参数名写上。比如调用<code>enroll(&#39;Adam&#39;,&#39;B&#39;,city=&#39;Tianjin&#39;)</code>，意思是city参数用传进去的值，其他默认参数继续使用默认值。</p>
<p>默认参数使用很有效，但是使用不当也会产生误导，如下：</p>
<p>先定义一个函数，传入一个list，添加一个<code>END</code>再返回：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">add_end</span><span class="params">(L=[])</span>:</span></div><div class="line"><span class="meta">... </span>    L.append(<span class="string">'END'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> L</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>])</div><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">'END'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end([<span class="string">'x'</span>,<span class="string">'t'</span>,<span class="string">'xc'</span>])</div><div class="line">[<span class="string">'x'</span>, <span class="string">'t'</span>, <span class="string">'xc'</span>, <span class="string">'END'</span>]</div></pre></td></tr></table></figure></p>
<p>调用没有问题，一开始调用默认参数也没有问题，但是再调用<code>add_end()</code>时，结果就不对了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</div><div class="line">[<span class="string">'END'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</div><div class="line">[<span class="string">'END'</span>, <span class="string">'END'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</div><div class="line">[<span class="string">'END'</span>, <span class="string">'END'</span>, <span class="string">'END'</span>]</div></pre></td></tr></table></figure>
<blockquote>
<p>这是因为Python在函数定义的时候，默认参数<code>L</code>的值就被计算出来了，即<code>[]</code>，因为默认参数<code>L</code>也是一个变量，它指向对象<code>[]</code>，每次调用该函数，如果改变了<code>L</code>的内容，则下次调用时，默认参数的内容就变了，不再是定义的<code>[]</code>了，所以定义默认参数时要牢记一点：<code>默认参数必须指向不变对象来实现！</code></p>
</blockquote>
<p>可以用<code>None</code>来修改：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">add_end</span><span class="params">(L=None)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> L <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line"><span class="meta">... </span>            L=[]</div><div class="line"><span class="meta">... </span>    L.append(<span class="string">'END'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> L</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</div><div class="line">[<span class="string">'END'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end()</div><div class="line">[<span class="string">'END'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add_end([<span class="string">'x'</span>,<span class="number">5</span>,<span class="string">'dfs'</span>])</div><div class="line">[<span class="string">'x'</span>, <span class="number">5</span>, <span class="string">'dfs'</span>, <span class="string">'END'</span>]</div></pre></td></tr></table></figure>
<p>设计<code>str</code>,<code>None</code>这样的不变对象的目的在于：不变对象一旦创建，对象内部的数据就不能修改，这样就减少了由于修改数据导致的错误。此外，由于对象不变，多任务环境下同时读取对象不需要加锁，同时读取一点问题都没有。我们在编写程序时，如果可以设计一个不变对象，就尽量设计成不变的对象。</p>
<h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h3><p>在Python函数中，还可以定义可变参数。顾名思义，可变参数就是传入参数的个数是可变的，可以是1个，2个，到任意个。</p>
<p>我们以数学题为例，给定一组数字a,b,c……，计算a²＋b²＋c²＋……。</p>
<p>要定义出这个函数，我们必须确定输入的从参数。由于参数的个数不确定，我们首先想到把a,b,c,……作为一个list或者 tuple传进来，这样函数可以定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(numbers)</span>:</span></div><div class="line"><span class="meta">... </span>    sum=<span class="number">0</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> n <span class="keyword">in</span> numbers:</div><div class="line"><span class="meta">... </span>            sum=sum+n*n</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> sum</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</div><div class="line"><span class="number">14</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>])</div><div class="line"><span class="number">285</span></div></pre></td></tr></table></figure>
<p>但是这样调用的时候需要先组装成一个list和tuple，如果利用可变参数，调用函数的方式可以变为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">cal</span><span class="params">(*numbers)</span>:</span></div><div class="line"><span class="meta">... </span>    sum=<span class="number">0</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> n <span class="keyword">in</span> numbers:</div><div class="line"><span class="meta">... </span>            sum=sum+n*n</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> sum</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cal(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</div><div class="line"><span class="number">14</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cal()</div><div class="line"><span class="number">0</span></div></pre></td></tr></table></figure>
<p>定义可变参数和定义一个list或者tuple相比，仅仅在参数前面加了个*号，在函数内部，参数<code>numbers</code>接受到的是一个tuple，因此，函数代码完全不变，但是，调用该函数时，可以传入任意个参数，包括零个参数。</p>
<p>如果已经有了一个list或者tuple，要调用一个可变参数时，可以这样做：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>numbers=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cal(*numbers)</div><div class="line"><span class="number">30</span></div></pre></td></tr></table></figure>
<h3 id="关键字参数"><a href="#关键字参数" class="headerlink" title="关键字参数"></a>关键字参数</h3><p>可变参数允许传入0个或者任意个参数，这些可变参数在函数调用时自动组装为一个tuple。而关键字参数允许你传入0个或任意个含参数名的参数，这些关键字参数在函数内部自动组装成一个dictionary：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name,age,**kw)</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'name:'</span>,name,<span class="string">'age:'</span>,age,<span class="string">'others:'</span>,kw)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'Mike'</span>,<span class="number">30</span>)</div><div class="line">name: Mike age: <span class="number">30</span> others: &#123;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>)</div><div class="line">name: james age: <span class="number">22</span> others: &#123;<span class="string">'city'</span>: <span class="string">'Beijing'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>,gender=<span class="string">'b'</span>)</div><div class="line">name: james age: <span class="number">22</span> others: &#123;<span class="string">'gender'</span>: <span class="string">'b'</span>, <span class="string">'city'</span>: <span class="string">'Beijing'</span>&#125;</div></pre></td></tr></table></figure>
<p>函数<code>person</code>除了必选参数<code>name</code>和<code>age&#39;</code>之外，还可以接受关键字参数<code>kw</code>。在调用函数时，可以只传入必选参数，也可以传入任意个数的关键字参数。</p>
<p>关键字参数可以扩展函数的功能。比如，在<code>person</code>函数里，我们保证能接收到<code>name</code>和<code>age</code>两个参数，但是如果调用者愿意提供更多的参数，我们也能接收到。试想你正在做一个用户注册的功能，除了用户名和年龄是必填选项，其他都是可选项，利用关键字这个函数就可以很容易满足注册的需求。</p>
<p>和可变参数类似，也可以先组装一个dict，然后把该dict转换为关键字参数传入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>extra=&#123;<span class="string">'city'</span>:<span class="string">'beijing'</span>,<span class="string">'job'</span>:<span class="string">'teacher'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'jack'</span>,<span class="number">24</span>,**extra)</div><div class="line">name: jack age: <span class="number">24</span> others: &#123;<span class="string">'job'</span>: <span class="string">'teacher'</span>, <span class="string">'city'</span>: <span class="string">'beijing'</span>&#125;</div></pre></td></tr></table></figure>
<p><code>**extra</code>表示把<code>extra</code>这个dict的所有key-value用关键字参数传入到<code>**kw</code>中，<code>kw</code>将获得一个dict，注意<code>kw</code>获得的dict是<code>extra</code>的一个拷贝，对<code>kw</code>的改动不会影响到原始数据。</p>
<h3 id="命名关键字参数"><a href="#命名关键字参数" class="headerlink" title="命名关键字参数"></a>命名关键字参数</h3><p>对于关键字参数，函数调用者可以传入任意不受限制的关键字采纳数。至于到底传入了哪些，需要函数内部通过<code>kw</code>检查。仍以<code>person</code>为例，我们希望检查是否有<code>city</code>和<code>job</code>的参数,这时候仍可以传入不受限制的关键字参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name,age,**kw)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> <span class="string">'city'</span> <span class="keyword">in</span> kw:</div><div class="line"><span class="meta">... </span>            <span class="keyword">pass</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> <span class="string">'job'</span> <span class="keyword">in</span> kw:</div><div class="line"><span class="meta">... </span>            <span class="keyword">pass</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'name:'</span>,name,<span class="string">'age:'</span>,age,<span class="string">'others:'</span>,kw)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>,gender=<span class="string">'b'</span>)</div><div class="line">name: james age: <span class="number">22</span> others: &#123;<span class="string">'gender'</span>: <span class="string">'b'</span>, <span class="string">'city'</span>: <span class="string">'Beijing'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>,job=<span class="string">'teacher'</span>)</div><div class="line">name: james age: <span class="number">22</span> others: &#123;<span class="string">'job'</span>: <span class="string">'teacher'</span>, <span class="string">'city'</span>: <span class="string">'Beijing'</span>&#125;</div></pre></td></tr></table></figure>
<p>如果我们要限制关键字参数的名字，就可以用命名关键字参数，例如，只接收<code>city</code>和<code>job</code>作为关键字参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name,age,*,city,job)</span>:</span></div><div class="line"><span class="meta">... </span>    print(name,age,city,job)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>,job=<span class="string">'teacher'</span>)</div><div class="line">james <span class="number">22</span> Beijing teacher</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'james'</span>,<span class="number">22</span>,city=<span class="string">'Beijing'</span>,gender=<span class="string">'b'</span>)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">TypeError: person() got an unexpected keyword argument <span class="string">'gender'</span></div></pre></td></tr></table></figure>
<p>和关键字参数<strong>kw不同，命名关键字需要一个特殊分隔符<code>*</code>,<code>*</code>后面的参数为命名关键字参数，如果函数定义中已经有一个可变参数，后面就不需要一个特殊分隔符<code>*</code>。
</strong>命名关键字可以有缺省**可以简化调用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">person</span><span class="params">(name,age,*,city=<span class="string">'beijing'</span>,job)</span>:</span></div><div class="line"><span class="meta">... </span>    print(name,age,city,job)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">'Jack'</span>,<span class="number">24</span>,job=<span class="string">'Engineer'</span>)</div><div class="line">Jack <span class="number">24</span> beijing Engineer</div></pre></td></tr></table></figure>
<p><strong>使用命名关键字参数时需要注意，如果没有可变参数，就必须加一个<code>*</code>作为特殊分隔符。如果缺少<code>*</code>，Python解释器将无法识别位置参数和命名关键字参数</strong></p>
<h3 id="参数组合"><a href="#参数组合" class="headerlink" title="参数组合"></a>参数组合</h3><p>在Python中定义函数，可以选用必选参数，默认参数，可变参数，关键字参数和命名关键字参数，这五种参数都可以组合使用。但是请注意，参数定义的顺序是：必选参数，默认参数，可变参数，命名关键字参数和关键字参数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">f1</span><span class="params">(a,b,c=<span class="number">0</span>,*args,**kw)</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'a='</span>,a, <span class="string">'b='</span>,b, <span class="string">'c='</span>,c, <span class="string">'args='</span>,args, <span class="string">'kw='</span>,kw)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">f2</span><span class="params">(a,b,c=<span class="number">0</span>,*,d,**kw)</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'a='</span>,a, <span class="string">'b='</span>,b, <span class="string">'c='</span>,c, <span class="string">'d='</span>,d, <span class="string">'kw='</span>,kw)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f1(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">0</span> args= () kw= &#123;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f1(<span class="number">1</span>,<span class="number">2</span>,c=<span class="number">3</span>)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">3</span> args= () kw= &#123;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f1(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">'a'</span>,<span class="string">'b'</span>)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">3</span> args= (<span class="string">'a'</span>, <span class="string">'b'</span>) kw= &#123;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f1(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,x=<span class="number">999</span>)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">3</span> args= (<span class="string">'a'</span>, <span class="string">'b'</span>) kw= &#123;<span class="string">'x'</span>: <span class="number">999</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f2(<span class="number">1</span>,<span class="number">2</span>,d=<span class="number">99</span>,ext=<span class="keyword">None</span>)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">0</span> d= <span class="number">99</span> kw= &#123;<span class="string">'ext'</span>: <span class="keyword">None</span>&#125;</div></pre></td></tr></table></figure>
<p>在函数调用的时候，Python解释器自动按照参数位置和参数名把对应的参数传进去，最神奇的是通过一个tuple和dict，你也可以调用上述函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>args=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>kw=&#123;<span class="string">'d'</span>:<span class="number">88</span>,<span class="string">'x'</span>:<span class="string">'#'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f1(*args,**kw)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">3</span> args= (<span class="number">4</span>,) kw= &#123;<span class="string">'d'</span>: <span class="number">88</span>, <span class="string">'x'</span>: <span class="string">'#'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>args=(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>kw=&#123;<span class="string">'d'</span>:<span class="number">88</span>,<span class="string">'x'</span>:<span class="string">'#'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>f2(*args,**kw)</div><div class="line">a= <span class="number">1</span> b= <span class="number">2</span> c= <span class="number">3</span> d= <span class="number">88</span> kw= &#123;<span class="string">'x'</span>: <span class="string">'#'</span>&#125;</div></pre></td></tr></table></figure>
<p>所以，对于任意函数，都可以通过类似<code>func(*args,**kw)</code>的形式调用它，无论他的参数是如何定义的。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>Python的函数具有非常灵活的参数形态，既可以实现简单的调用，又可以传入非常复杂的参数。默认参数一定要用不可变对象，如果是可变对象程序运行时会出现逻辑错误！</p>
<p>要注意定义可变参数和关键字参数的语法：</p>
<p><code>*args</code>是可变参数，args接收的是一个tuple；</p>
<p><code>**kw</code>是关键字参数，kw接收的是一个dict。</p>
<p>以及调用函数时如何传入可变参数和关键字参数的语法：</p>
<p>可变参数既可以直接传入：<code>func(1,2,3)</code>，又可以先组装list或者tuple，再通过<code>*args</code>传入：<code>func(*(1,2,3))</code>;</p>
<p>关键字参数既可以直接传入：<code>func(a=1,b=2)</code>又可以先组装dict，再通过<code>**kw</code>传入：<code>func(**{&#39;a&#39;:1,&#39;b&#39;:2})</code>。</p>
<p>使用<code>*args</code>和<code>**kw</code>是Python的习惯洗发，当然也可以用其他参数名，但是最好使用习惯用法。命名关键字参数时为了限制调用者可以传入的参数名，同时也可以提供默认值。</p>
<p>定义命名的关键字参数在没有可变参数的情况下不要忘记加分隔符<code>*</code>。</p>
<hr>
<h2 id="递归函数"><a href="#递归函数" class="headerlink" title="递归函数"></a>递归函数</h2><p>在函数内部，可以调用其他函数。如果一个函数在内部调用自己本身，这个函数就是递归函数。举个例子，我们计算阶乘<code>n!=1*2*3*...*n</code>，用函数<code>fact()</code>来表示，可以看出：fact(n)=n!=1<em>2</em>3<em>…</em>n=fact(n-1)<em>n，所以fact(n)可以表示为`n</em>fact(n-1)`,只有在n=1时需要特殊处理。于是，fact(n)用递归的方式写出来就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fact</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> n==<span class="number">1</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> <span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>fact(<span class="number">1</span>)</div><div class="line"><span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>fact(<span class="number">100</span>)</div><div class="line"><span class="number">93326215443944152681699238856266700490715968264381621468592963895217599993229915</span></div><div class="line"><span class="number">608941463976156518286253697920827223758251185210916864000000000000000000000000</span></div></pre></td></tr></table></figure>
<p>递归函数的优点是定义简单，逻辑清楚。理论上，所有的递归函数都可以写成循环的方式，但是循环的逻辑不如递归的逻辑清楚。</p>
<p>使用递归函数是需要防止栈溢出。在计算机中，函数调用时通过栈这种数据结构来实现的，每当进入一个函数调用，栈就会加一层栈帧，每当函数返回，栈就会减一层栈帧。由于栈的大小不是无限的，所以递归的次数过多，会导致栈溢出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">4</span>, <span class="keyword">in</span> fact</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">4</span>, <span class="keyword">in</span> fact</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">2</span>, <span class="keyword">in</span> fact</div><div class="line">RecursionError: maximum recursion depth exceeded <span class="keyword">in</span> comparison</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>fact(<span class="number">5000</span>)</div></pre></td></tr></table></figure>
<p>解决递归调用栈溢出的方法是通过<strong>尾递归</strong>优化，事实上尾递归和循环的效果是一样的，所以，把循环看成是一种特殊的尾递归也是可以的。</p>
<p>尾递归是指，在函数返回的时候，调用函数本身，并且return语句不能包含表达式。这样，编译器或者解释器就可以吧尾递归做优化，使递归本身无论调用多少次，都只占一个栈帧，不会出现栈溢出的情况。</p>
<p>上面的<code>fact(n)</code>函数由于<code>return n*fact(n-1)</code>引入了乘法表达式，所以就不是尾递归了。要改成尾递归的方式，需要多一点代码，主要是把每一步的成绩传入到递归函数中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fact</span><span class="params">(n)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> fact_iter(n,<span class="number">1</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fact_iter</span><span class="params">(num,product)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> num==<span class="number">1</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">return</span> product</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> fact_iter(num<span class="number">-1</span>,num*product)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>可以看到，<code>return fact_iter(num-1,num*product)</code>仅仅返回递归函数本身，<code>num-1</code>和<code>num*product</code>在函数调用前就会被计算出来，不会影响函数调用。</p>
<p><code>fact(5)</code>对应的<code>fact_iter(5,1)</code>的调用如下：</p>
<blockquote>
<p>fact_iter(5,1)<br>fact_iter(4,5)<br>fact_iter(3,20)<br>fact_iter(2,60)<br>fact_iter(1,120)<br>120</p>
</blockquote>
<p>尾递归调用时，如果做了优化，栈就不会增长，因此，无论多少次调用都不会导致栈溢出。</p>
<p>遗憾的是，大多数编程语言都没有针对尾递归做优化，Python解释器也没有做优化，所以，即使把上面的<code>fact(n)</code>函数改为尾递归方式，也会导致栈溢出。</p>
<h3 id="练习-2"><a href="#练习-2" class="headerlink" title="练习"></a>练习</h3><p>汉诺塔的移动可以用递归函数非常简单的实现，请编写move函数，它接收参数n，表示3个柱子A,B,C中第一个柱子A的盘子数量，然后打印出所有盘子从A借助B移动到C的方法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">move</span><span class="params">(n, a, b, c)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> n == <span class="number">1</span>:</div><div class="line"><span class="meta">... </span>        print(<span class="string">'move'</span>, a, <span class="string">'--&gt;'</span>, c)</div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span></div><div class="line"><span class="meta">... </span>    move(n<span class="number">-1</span>, a, c, b)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'move'</span>, a, <span class="string">'--&gt;'</span>, c)</div><div class="line"><span class="meta">... </span>    move(n<span class="number">-1</span>, b, a, c)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>move(<span class="number">4</span>, <span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>)</div><div class="line">move A --&gt; B</div><div class="line">move A --&gt; C</div><div class="line">move B --&gt; C</div><div class="line">move A --&gt; B</div><div class="line">move C --&gt; A</div><div class="line">move C --&gt; B</div><div class="line">move A --&gt; B</div><div class="line">move A --&gt; C</div><div class="line">move B --&gt; C</div><div class="line">move B --&gt; A</div><div class="line">move C --&gt; A</div><div class="line">move B --&gt; C</div><div class="line">move A --&gt; B</div><div class="line">move A --&gt; C</div><div class="line">move B --&gt; C</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/17.异步IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/17.异步IO/" itemprop="url">17. 异步IO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h1><p>在IO编程中我们知道CPU的速度远远快于磁盘网络等IO。在一个线程中，CPU执行代码的速度极快，然而一旦遇到IO操作，比如读写文件、发送网络数据时，就需要等待IO操作完成，才能进行下一步操作，这种情况称为同步IO。</p>
<p>在IO操作的过程中，当前线程被挂起，而其他需要CPU执行的代码就无法被当前线程执行了。因为一个IO操作就阻塞了当前线程，导致代码无法执行，所以我们必须使用多线程或者多进程并发执行代码，为多个用户服务。每个用户都会分配一个线程，如果遇到IO导致线程被挂起，其他用户的线程不受影响。</p>
<p>多线程和多进程的模型虽然解决了并发问题，但是系统不能无上限地增加线程。由于系统切换线程的开销也很大，所以，线程一旦过多，CPU的时间就花在线程切换上了，导致性能下降。</p>
<p>由于我们要解决的问题是CPU告诉执行能力和IO设备的龟速严重不匹配，多线程和多进程只是解决这一问题的一种方法。另一种方法是异步IO。当代码需要执行一个耗时的IO操作时，它只发出IO指令并不等待IO结果。然后去执行其他代码，一段时间后，当IO结果返回时，再通知CPU进行处理。</p>
<p>可以知道，普通顺序写的代码是无法完成异步IO的，异步IO模型需要一个消息循环，在消息循环中，主线程不断的重复着“读取消息-处理消息”这一过程：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">loop = get_event_loop()</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	event = loop.get_event()</div><div class="line">	process_event(event)</div></pre></td></tr></table></figure></p>
<p>消息模型其实早就应用在桌面程序中了，一个GUI程序的主线程就负责不停地读取消息并处理消息。所有的键盘、鼠标等消息都被发送到GUI程序的消息队列中，然后由GUI程序的主线程处理。由于GUI线程处理键盘鼠标等消息的速度非常快、所以用户感觉不到延迟。某些情况下，GUI线程会在一个消息处理的过程中遇到问题导致一次消息处理时间过长，此时用户会感觉到整个GUI程序停止响应了，敲键盘鼠标都没有反应。这种情况说明在消息模型中，处理一个消息必须非常迅速，否则主线程将无法及时处理消息队列中的其他消息，导致程序看上去停止响应。</p>
<p>当遇到IO操作时，代码只负责发送IO请求，不等待IO结果，然后直接结束本轮消息处理，进入下一轮操作处理过程。当IO操作完成后，将受到一条IO完成的消息，处理该消息时就可以直接获取IO操作的结果。</p>
<p>在发出IO请求到受到IO完成这段时间里面，同步IO模型下，主线程只能挂起，但是异步IO模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样在异步IO下，一个线程就可以同时处理多个IO请求，并且没有切换线程的操作。对大多数IO密集型程序，异步IO会大大提高系统的多任务处理能力。</p>
<hr>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>协程，又称微线程、 钎程。英文名Coroutine。</p>
<p>子程序或者成为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，A执行完毕。所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。子程序调用总是一个入口一个返回，调用顺序是明确的。而协程的调用和子程序不同。</p>
<p>协程看上去也是子程序，但是在执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。注意在一个子程序中中断，去执行其他子程序，不是调用函数，有点类似CPU中断。比如子程序A、B：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">def A():</div><div class="line">    print(&apos;1&apos;)</div><div class="line">    print(&apos;2&apos;)</div><div class="line">    print(&apos;3&apos;)</div><div class="line"></div><div class="line">def B():</div><div class="line">    print(&apos;x&apos;)</div><div class="line">    print(&apos;y&apos;)</div><div class="line">    print(&apos;z&apos;)</div></pre></td></tr></table></figure></p>
<p>假设由协程执行，在执行A的过程中，可以随时中断，去执行B，B也可能在执行中中断再去执行A，结果可能是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">x</div><div class="line">y</div><div class="line">3</div><div class="line">z</div></pre></td></tr></table></figure></p>
<p>但是再A总是没有调用B的，所以协程的调用比起函数调用理解要难。</p>
<p>看起来A、B的执行有点像多线程，但协程的特点在于是一个线程执行。和多线程相比，协程最大的优势就是极高的执行效率。因为子程序切换不是线程切换，而是程序自身控制的 ，因此没有线程切换的开销，和多线程相比，线程数量越多，协程的性能优势就越明显。</p>
<p>第二大优势就是不休要多线程的锁机制，因为只有一个线程，也不存在同时写和变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</p>
<p>协程是一个线程执行，为了利用多核CPU，可以用多进程+协程，即充分利用多核，又充分发挥协程的高效率，可获得奇高的性能。</p>
<p>Python对协程的支持是通过generator实现的。</p>
<p>在generator中，我们不但可以通过<code>for</code>循环来迭代，还可以不断调用<code>next()</code>函数获取由<code>yield</code>语句返回下一个值。但是Python的<code>yield</code>不但可以返回一个值，还可以接收调用者发出的参数。</p>
<p>例如：传统的生产者-消费者模型就是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。如果改用协程，生产者生产消息后，直接通过yield跳转到消费者开始执行，等消费者执行完毕后，切换回生产者继续生产，效率极高：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    r=<span class="string">''</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="meta">... </span>            n = <span class="keyword">yield</span> r</div><div class="line"><span class="meta">... </span>            <span class="keyword">if</span> <span class="keyword">not</span>  n:</div><div class="line"><span class="meta">... </span>                    <span class="keyword">return</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'[CONSUMER] Consuming %s...'</span> % n )</div><div class="line"><span class="meta">... </span>            r=<span class="string">'200 OK'</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(c)</span>:</span></div><div class="line"><span class="meta">... </span>    c.send(<span class="keyword">None</span>)</div><div class="line"><span class="meta">... </span>    n=<span class="number">0</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</div><div class="line"><span class="meta">... </span>            n = n + <span class="number">1</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'[PRODUCER] Producing %s...'</span> %n)</div><div class="line"><span class="meta">... </span>            r = c.send(n)</div><div class="line"><span class="meta">... </span>            print(<span class="string">'[PRODUCER] Consumer return: %s'</span> % r )</div><div class="line"><span class="meta">... </span>    c.close()</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = consumer()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>produce(c)</div><div class="line">[PRODUCER] Producing <span class="number">1.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">1.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">2.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">2.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">3.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">3.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">4.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">4.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">5.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">5.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div></pre></td></tr></table></figure></p>
<p>注意到<code>consumer</code>函数是一个<code>generator</code>，把一个<code>consumer</code>传入<code>produce</code>后：</p>
<p>1、首先调用<code>c.send(None)</code>启动生成器；<br>2、一旦产生了东西，通过<code>c.send(n)</code>切换到<code>consumer</code>执行<br>3、<code>consumer</code>通过<code>yield</code>拿到消息，处理，又通过<code>yield</code>把结果传回。<br>4、<code>produce</code>拿到<code>consumer</code>处理的结果，继续生产下一条消息<br>5、<code>produce</code>决定不生产了，通过<code>c.close()</code>关闭<code>consumer</code>整个过程结束。</p>
<p>整个流程无锁，由一个线程执行，<code>produce</code>和<code>consumer</code>协作完成任务，所以称为协程。</p>
<hr>
<h2 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a>asyncio</h2><p><code>asyncio</code>是python3.4版本引入的标准库，直接内置了对异步IO的支持。<code>asyncio</code>的编程模型就是一个消息循环。我们从<code>asyncio</code>模块中直接获取一个<code>Eventloop</code>的引用，然后把需要执行的协程扔到<code>Eventloop</code>中执行，就实现了异步IO。</p>
<p>用<code>asyncio</code>实现<code>Hello world</code>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> asyncio</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>@asyncio.coroutine</div><div class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">"Hello world!!"</span>)</div><div class="line"><span class="meta">... </span>    r=<span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</div><div class="line"><span class="meta">... </span>    print(<span class="string">"Hello again!"</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop = asyncio.get_event_loop()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop.run_until_complete(hello())</div><div class="line">Hello world!!</div><div class="line">Hello again!</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop.close()</div></pre></td></tr></table></figure></p>
<p><code>@asyncio.coroutine</code>把一个generator标记为coroutine类型，然后，我们就把这个Coroutine扔到Eventloop中执行。</p>
<p><code>hello()</code>首先打印出<code>Hello world!!</code>，然后，<code>yield from</code>语法可以让我们方便的调用另一个<code>generator</code>。由于<code>asyncio.sleep()</code>也是一个Coroutine，所以线程不会等待<code>asyncio.sleep()</code>，而是直接中断并执行下一个消息循环。当<code>asyncio.sleep()</code>返回时，线程就可以从<code>yield from</code>拿到返回值，然后接着执行下一行语句。</p>
<p>把<code>asyncio.sleep(1)</code>看做一个耗时1秒的IO操作，在此期间，主线程并未等待，而是去执行<code>Eventloop</code>中其他可以执行的coroutine了，因此可以实现并发执行。</p>
<p>用Task封装两个<code>coroutine</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">	print(<span class="string">'Hello world! (%s)'</span> % threading.currentThread())</div><div class="line">	<span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</div><div class="line">	print(<span class="string">'Hello again! (%s)'</span> % threading.currentThread())</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">tasks = [hello(), hello()]</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div><div class="line">loop.close()</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python 1.1.py</div><div class="line">Hello world! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">Hello world! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">#（停顿1s）</div><div class="line">Hello again! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">Hello again! (&lt;_MainThread(MainThread, started 20036)&gt;)</div></pre></td></tr></table></figure></p>
<p>由打印出来的当前线程可以看出，两个<code>continue</code>是由同一个线程并发执行的。如果把<code>asyncio.sleep()</code>换成真正的IO操作，则多个<code>coroutine</code>就可以由一个线程并发执行。我们用<code>asyncio</code>的异步网络连接来获取sina、sohu和163的网站首页：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wget</span><span class="params">(host)</span>:</span></div><div class="line">	print(<span class="string">'wget %s...'</span> % host)</div><div class="line">	connect = asyncio.open_connection(host, <span class="number">80</span>)</div><div class="line">	reader, writer = <span class="keyword">yield</span> <span class="keyword">from</span> connect</div><div class="line">	header = <span class="string">'GET / HTTP/1.0\r\nHost: %s\r\n\r\n'</span> %host</div><div class="line">	writer.write(header.encode(<span class="string">'utf-8'</span>))</div><div class="line">	<span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">		line = <span class="keyword">yield</span> <span class="keyword">from</span> reader.readline()</div><div class="line">		<span class="keyword">if</span> line == <span class="string">b'\r\n'</span>:</div><div class="line">			<span class="keyword">break</span></div><div class="line">		print(<span class="string">'%s header &gt; %s'</span> %(host, line.decode(<span class="string">'utf-8'</span>).rstrip()))</div><div class="line">	writer.close()</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">tasks = [wget(host) <span class="keyword">for</span> host <span class="keyword">in</span>[<span class="string">'www.sina.com.cn'</span>, <span class="string">'www.sohu.com'</span>, <span class="string">'www.163.com'</span>]]</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div><div class="line">loop.close()</div></pre></td></tr></table></figure></p>
<p>执行结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python <span class="number">1.2</span>.py</div><div class="line">wget www.sina.com.cn...</div><div class="line">wget www<span class="number">.163</span>.com...</div><div class="line">wget www.sohu.com...</div><div class="line">www.sina.com.cn header &gt; HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">www.sina.com.cn header &gt; Server: nginx</div><div class="line">www.sina.com.cn header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">29</span> GMT</div><div class="line">www.sina.com.cn header &gt; Content-Type: text/html</div><div class="line">www.sina.com.cn header &gt; Last-Modified: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">02</span> GMT</div><div class="line">www.sina.com.cn header &gt; Vary: Accept-Encoding</div><div class="line">www.sina.com.cn header &gt; Expires: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">18</span>:<span class="number">29</span> GMT</div><div class="line">www.sina.com.cn header &gt; Cache-Control: max-age=<span class="number">60</span></div><div class="line">www.sina.com.cn header &gt; X-Powered-By: shci_v1<span class="number">.03</span></div><div class="line">www.sina.com.cn header &gt; Age: <span class="number">50</span></div><div class="line">www.sina.com.cn header &gt; Content-Length: <span class="number">595123</span></div><div class="line">www.sina.com.cn header &gt; X-Cache: HIT <span class="keyword">from</span> ja108<span class="number">-181.</span>sina.com.cn</div><div class="line">www.sina.com.cn header &gt; Connection: close</div><div class="line">www<span class="number">.163</span>.com header &gt; HTTP/<span class="number">1.0</span> <span class="number">302</span> Moved Temporarily</div><div class="line">www<span class="number">.163</span>.com header &gt; Server: Cdn Cache Server V2<span class="number">.0</span></div><div class="line">www<span class="number">.163</span>.com header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">21</span>:<span class="number">18</span> GMT</div><div class="line">www<span class="number">.163</span>.com header &gt; Content-Length: <span class="number">0</span></div><div class="line">www<span class="number">.163</span>.com header &gt; Location: http://www<span class="number">.163</span>.com/special/<span class="number">0077j</span>t/error_isp.html</div><div class="line">www<span class="number">.163</span>.com header &gt; Connection: close</div><div class="line">www.sohu.com header &gt; HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">www.sohu.com header &gt; Content-Type: text/html</div><div class="line">www.sohu.com header &gt; Content-Length: <span class="number">90665</span></div><div class="line">www.sohu.com header &gt; Connection: close</div><div class="line">www.sohu.com header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">18</span>:<span class="number">29</span> GMT</div><div class="line">www.sohu.com header &gt; Server: SWS</div><div class="line">www.sohu.com header &gt; Vary: Accept-Encoding</div><div class="line">www.sohu.com header &gt; Cache-Control: no-transform, max-age=<span class="number">120</span></div><div class="line">www.sohu.com header &gt; Expires: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">20</span>:<span class="number">29</span> GMT</div><div class="line">www.sohu.com header &gt; Last-Modified: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">28</span> GMT</div><div class="line">www.sohu.com header &gt; Content-Encoding: gzip</div><div class="line">www.sohu.com header &gt; X-RS: <span class="number">10511343.19686393</span><span class="number">.11189627</span></div><div class="line">www.sohu.com header &gt; FSS-Cache: HIT <span class="keyword">from</span> <span class="number">9580427.16723861</span><span class="number">.11355128</span></div><div class="line">www.sohu.com header &gt; FSS-Proxy: Powered by <span class="number">3944245.5451583</span><span class="number">.5718860</span></div></pre></td></tr></table></figure></p>
<p>三个连接是由一个线程通过Coroutine并发完成。</p>
<p><code>asyncio</code>提供了完善的异步IO支持，异步操作需要在<code>coroutine</code>中通过<code>yield from</code>完成，多个<code>coroutine</code>可以封装一组Task然后并发执行。</p>
<hr>
<h2 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h2><p>用<code>asyncio</code>提供的<code>@asyncio.coroutine</code>可以把一个generator标记为coroutine类型，然后在coroutine内部用<code>yield from</code>调用另一个coroutine实现异步操作。</p>
<p>为了简化并更好地标示异步IO，从python3.5开始引入了新的语法<code>async</code>和<code>await</code>，可以让Coroutine的代码更加简洁易读。</p>
<p><code>async</code>和<code>await</code>是针对coroutine的新语法，要使用新的语法，只需要做两步简单的替换：</p>
<blockquote>
<p>1、把<code>@asyncio.coroutine</code>替换为<code>async</code><br>2、把<code>yield from</code>替换为<code>await</code></p>
</blockquote>
<p>对比一下上一节的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#old</div><div class="line">@asyncio.coroutine</div><div class="line">def hello():</div><div class="line">	print(&apos;Hello world! (%s)&apos; % threading.currentThread())</div><div class="line">	yield from asyncio.sleep(1)</div><div class="line">	print(&apos;Hello again! (%s)&apos; % threading.currentThread())</div><div class="line"></div><div class="line">#new</div><div class="line">async def hello():</div><div class="line">	print(&apos;Hello world! (%s)&apos; % threading.currentThread())</div><div class="line">	await asyncio.sleep(1)</div><div class="line">	print(&apos;Hello again! (%s)&apos; % threading.currentThread())</div></pre></td></tr></table></figure></p>
<p>剩下代码保持不变。</p>
<hr>
<h2 id="aiohttp"><a href="#aiohttp" class="headerlink" title="aiohttp"></a>aiohttp</h2><p><code>asyncio</code>可以实现单线程并发IO操作。如果仅用在客户端，发挥的威力不大。如果把<code>asyncio</code>用在服务器端，例如Web服务器，由于HTTP连接就是IO操作，因此可以用单线程+<code>cortinue</code>实现多用户的高并发支持。</p>
<p><code>asyncio</code>实现了TCP、UDP、SSL等协议，<code>aiohttp</code>则是基于<code>asyncio</code>实现了HTTP框架。</p>
<p>安装<code>aiohttp</code>然后编写一个HTTP服务器，分别处理以下URL：</p>
<blockquote>
<p><code>/</code>-首页返回<code>b&#39;&lt;h1&gt;Index&lt;/h1&gt;&#39;</code><br><code>/hello/{name}</code>-根据URL参数返回文本<code>hello, %s!</code></p>
</blockquote>
<p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</div><div class="line">    <span class="keyword">return</span> web.Response(body=<span class="string">b'&lt;h1&gt;Index&lt;/h1&gt;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</div><div class="line">    text = <span class="string">'&lt;h1&gt;hello, %s!&lt;/h1&gt;'</span> % request.match_info[<span class="string">'name'</span>]</div><div class="line">    <span class="keyword">return</span> web.Response(body=text.encode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(loop)</span>:</span></div><div class="line">    app = web.Application(loop=loop)</div><div class="line">    app.router.add_route(<span class="string">'GET'</span>, <span class="string">'/'</span>, index)</div><div class="line">    app.router.add_route(<span class="string">'GET'</span>, <span class="string">'/hello/&#123;name&#125;'</span>, hello)</div><div class="line">    srv = <span class="keyword">await</span> loop.create_server(app.make_handler(), <span class="string">'127.0.0.1'</span>, <span class="number">8000</span>)</div><div class="line">    print(<span class="string">'Server started at http://127.0.0.1:8000...'</span>)</div><div class="line">    <span class="keyword">return</span> srv</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(init(loop))</div><div class="line">loop.run_forever()</div></pre></td></tr></table></figure></p>
<p>注意<code>aiohttp</code>的初始化函数<code>init()</code>也是一个<code>coroutine</code>，<code>loop.creat_server()</code>则利用<code>asyncio</code>创建TCP服务。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/16.Web编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/16.Web编程/" itemprop="url">16. Web编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><p>随着互联网的兴起，人们发现CS架构不适合Web，最大的原因是Web应用程序的修改和升级非常迅速，而CS架构需要每个客户端逐个升级桌面APP，因此BS架构开始流行。</p>
<p>在BS架构下，客户端只需浏览器，应用程序的逻辑和数据都存储在服务器端。浏览器只需要请求服务器获取Web页面，并把Web页面展示给用户即可。Web页面也具有极强的交互性。由于Web页面使用HTML编写的，而HTML具备超强的表现力，并且服务端升级后，客户端无需任何部署就可以使用到最新的版本，因此BS架构迅速流行起来。</p>
<p>Web开发的阶段：<br>1、静态Web页面<br>2、CGI：Common Gateway Interface<br>3、ASP/JSP/PHP：脚本语言开发与HTML结合紧密。<br>4、MVC：Model-View-Controller的模式，ASP发展为ASP.Net，JSP和PHP也有一大堆MVC框架。</p>
<p>Python是一种解释型脚本语言，开发效率高，所以很适合来做WEB开发。Python有上百种Web开发框架，有很多成熟的模板技术。</p>
<h2 id="HTTP协议简介"><a href="#HTTP协议简介" class="headerlink" title="HTTP协议简介"></a>HTTP协议简介</h2><p>在Web应用中，服务器把网页传给浏览器，实际上就是把网页的HTML代码发送给浏览器，让浏览器显示出来。而浏览器和服务器之间的传输协议就是HTTP，所以：</p>
<blockquote>
<p>HTML是一种用来定义网页的文本，会HTML，就可以编写网页<br>HTTP是在网络上传输HTML的协议，用于浏览器和服务器的通信。</p>
</blockquote>
<p>chrome浏览器视图，开发者，开发者工具，就可以显示开发者工具：<br><img src="/img/1478682531152.png" alt="Alt text"></p>
<p><code>Elements</code>显示网页的结构，<code>Network</code>显示浏览器和服务器的通信。我们点<code>Network</code>，确保第一个小红灯亮着，Chrome就会记录所有浏览器和服务器之间的通信：<br><img src="/img/1478682659522.png" alt="Alt text"></p>
<p>当我们在地址栏输入<code>www.sina.com.cn</code>时，浏览器将显示新浪的首页。在<code>Network</code>中，定位到第一条记录，点击，右侧将显示<code>Request Headers</code>，点击右侧的<code>view source</code>，我们就可以看到浏览器发给新浪服务器的请求了：<br><img src="/img/1478691391893.png" alt="Alt text"></p>
<p>最主要的头两行分析如下，第一行为</p>
<blockquote>
<p>GET / HTTP/1.1</p>
</blockquote>
<p>GET表示一个读取请求，将从服务器获得网页数据，<code>/</code>表示URL的路径，URL总是以<code>/</code>开头，<code>/</code>就表示首页，最后的<code>HTTP/1.1</code>表示采用的HTTP版本是1.1。目前HTTP协议的版本就是1.1，但是大部分服务器也支持1.0版本，主要区别在于1.1版本允许多个HTTP请求复用一个TCP连接，以加快传输速度。</p>
<p>第二行开始，每一行都类似于<code>Xxx：abcdefg</code>：</p>
<blockquote>
<p>Host: www.sina.com.cn</p>
</blockquote>
<p>表示请求的域名是<code>www.sina.com.cn</code>，如果一天服务器有多个网站，服务器就需要通过Host来区分浏览器请求的是哪个网站。</p>
<p>继续往下找到<code>Response Headers</code>，点击<code>view source</code>，显示服务器返回的原始相应数据：<br><img src="/img/1478692170995.png" alt="Alt text"></p>
<p>HTTP相应分为Header和Body两部分，我们在Network中看到的Header最重要的几行如下：</p>
<blockquote>
<p>200 OK</p>
</blockquote>
<p><code>200</code>表示一个成功的响应，后面的<code>OK</code>是说明。失败的响应有<code>404 Not Found</code>，<code>500Internal Server Error</code>等。</p>
<blockquote>
<p>Content-Type：text/html</p>
</blockquote>
<p><code>Content-Type</code>指示响应的内容，这里是<code>text/html</code>表示HTML网页。请注意浏览器就是靠<code>Content-Type</code>来判断响应的内容是网页还是图片，是时频还是音乐，不是靠URL来判断响应的内容的。</p>
<p>HTTP响应的Body就是HTML源码，我们可以直接查看：<br><img src="/img/1478692487428.png" alt="Alt text"></p>
<p>当浏览器读取到新浪首页的HTML源码后，它会解析HTML，显示页面，然后根据HTML里面的各种链接，再发送HTTP请求到新浪服务器，拿到相应的图片、时频、Flash。JavaScript脚本、CSS等各种资源，最终显示出一个完整的页面。我们在Network下回看到很多额外的请求。</p>
<h3 id="HTTP请求"><a href="#HTTP请求" class="headerlink" title="HTTP请求"></a>HTTP请求</h3><blockquote>
<p>1、浏览器首先向服务器发送HTTP请求，请求包括：</p>
<blockquote>
<p>方法：GET–仅请求资源、POST–附带用户数据<br>路径：由Host头指定–Host：www.sina.com.cn<br>以及其他相关的Header</p>
</blockquote>
<p>2、服务器向浏览器返回HTTP相应，相应包括：</p>
<blockquote>
<p>响应代码：200表示成功，3xx表示重定向，4xx表示客户端发送的请求有错误，5xx表示服务器端处理时发生了错误；<br>响应类型：由Content-Type指定；<br>以及其他相关的Header；<br>通常服务器的HTTP响应会携带内容，也就是有一个Body，包含响应的内容，网页的HTML源码就在Body中。</p>
</blockquote>
<p>3、如果浏览器还需要继续向服务器请求其他资源，比如图片，就再次发出HTTP请求，重复步骤1、2。</p>
</blockquote>
<p>Web采用的HTTP协议采用了非常简单的请求-响应模式，从而大大简化了开发。当我们编写一个页面时，我们只需要在HTTP请求中把HTML发送出去，不需要考虑如何附带图片、视频等，浏览器如果需要请求图片和视频，它会发送另一个HTTP请求，因此，一个HTTP请求只处理一个资源。</p>
<p>HTTP协议同时具备极强的扩展性，虽然浏览器请求的是<a href="http://www.sina.com.cn/的首页，但是新浪在HTML中可以链入其他服务器的资源，比如`" target="_blank" rel="external">http://www.sina.com.cn/的首页，但是新浪在HTML中可以链入其他服务器的资源，比如`</a><img src="http://i1.sinaimg.cn/home/2013/1008/U8455P30DT20131008135420.png">`=&gt;<img src="http://i1.sinaimg.cn/home/2013/1008/U8455P30DT20131008135420.png">，从而将请求压力分散到各个服务器上，并且，一个站点可以链接到其他站点，无数个站点互相链接起来，就形成了World Wide Web，简称WWW。</p>
<h3 id="HTTP格式"><a href="#HTTP格式" class="headerlink" title="HTTP格式"></a>HTTP格式</h3><p>每个HTTP请求和相应都遵循相同的格式，一个HTTP包含Header和Body两部分，其中Body是可选的。</p>
<p>HTTP协议是一种文本协议，所以它的格式非常简单。HTTP　GET请求的格式：<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">GET</span> <span class="string">/path</span> HTTP/1.1</div><div class="line"><span class="attribute">Header1</span>: Value1</div><div class="line"><span class="attribute">Header2</span>: Value2</div><div class="line"><span class="attribute">Header3</span>: Value3</div></pre></td></tr></table></figure></p>
<p>每个Header一行一个，换行符是<code>\r\n</code>。HTTP POST请求的格式是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">POST</span> <span class="string">/path</span> HTTP/1.1</div><div class="line"><span class="attribute">Header1</span>: Value1</div><div class="line"><span class="attribute">Header2</span>: Value2</div><div class="line"><span class="attribute">Header3</span>: Value3</div><div class="line"></div><div class="line">body data goes here...</div></pre></td></tr></table></figure></p>
<p>当遇到连续两个<code>\r\n</code>时，Header部分结束，后面的数据都是Body。</p>
<p>HTTP相应的格式：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">200 OK</div><div class="line"><span class="attribute">Header1</span>: Value1</div><div class="line"><span class="attribute">Header2</span>: Value2</div><div class="line"><span class="attribute">Header3</span>: Value3</div><div class="line"></div><div class="line">body data goes here...</div></pre></td></tr></table></figure></p>
<p>HTTP响应如果包含body，也是通过<code>\r\n\r\n</code>来分割的。Body数据类型是由<code>Content-Type</code>来确定的。</p>
<hr>
<h2 id="HTML简介"><a href="#HTML简介" class="headerlink" title="HTML简介"></a>HTML简介</h2><p>ＨＴＭＬ定义了一套语法规则，来告诉浏览器如何把一个丰富多彩的页面显示出来。最简单的HTML长这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Hello&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &lt;h1&gt;Hello, world!&lt;/h1&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>可以用文本编辑器编写HTML，然后保存为<code>hello.html</code>，双击或者把文件拖到浏览器中，就可以看到效果：<br><img src="/img/1478694755907.png" alt="Alt text"><br>HTML文档就是一些列的Tag组成的，最外层的Tag是<code>&lt;html&gt;</code>。规范的HTML也包含<code>&lt;head&gt;...&lt;/head&gt;</code>和<code>&lt;body&gt;...&lt;body&gt;</code>注意不要和HTTP中的Header和Body搞混了。由于HTML是富文档模型，所以还有一系列的Tag来表示链接、图片、表格、表单等等。</p>
<h3 id="CSS简介"><a href="#CSS简介" class="headerlink" title="CSS简介"></a>CSS简介</h3><p>CSS是Cascading Style Sheets(层叠样式表)，CSS用来控制HTML里的所有元素如何展现，比如，给标题元素<code>&lt;h1&gt;</code>加一个样式，变成48号字体，灰色，带阴影。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Hello&lt;/title&gt;</div><div class="line">  &lt;style&gt;</div><div class="line">    h1 &#123;</div><div class="line">      color: #333333;</div><div class="line">      font-size: 48px;</div><div class="line">      text-shadow: 3px 3px 3px #666666;</div><div class="line">    &#125;</div><div class="line">  &lt;/style&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &lt;h1&gt;Hello, world!&lt;/h1&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>效果如下：<br><img src="/img/1478696324582.png" alt="Alt text"></p>
<h3 id="JavaScript简介"><a href="#JavaScript简介" class="headerlink" title="JavaScript简介"></a>JavaScript简介</h3><p>JavaScript和Java没有关系。JavaScript是为了让HTML具有交互性而作为脚本语言添加的，JavaScript既可以内嵌到HTML中，也可以从外部链接到HTML中。如果我们希望当用户点击标题时把标题变为红色，就必须通过JavaScript来实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Hello&lt;/title&gt;</div><div class="line">  &lt;style&gt;</div><div class="line">    h1 &#123;</div><div class="line">      color: #333333;</div><div class="line">      font-size: 48px;</div><div class="line">      text-shadow: 3px 3px 3px #666666;</div><div class="line">    &#125;</div><div class="line">  &lt;/style&gt;</div><div class="line">   &lt;script&gt;</div><div class="line">    function change() &#123;</div><div class="line">      document.getElementsByTagName(&apos;h1&apos;)[0].style.color = &apos;#ff0000&apos;;</div><div class="line">    &#125;</div><div class="line">  &lt;/script&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &lt;h1 onclick=&quot;change()&quot;&gt;Hello, world!&lt;/h1&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p><img src="/img/1478696913936.png" alt="Alt text"></p>
<p>如果要学习Web开发，首先要对HTML、CSS和JavaScript作一定的了解。HTML定义了页面的内容，CSS来控制页面元素的样式，而JavaScript负责页面的交互逻辑。</p>
<hr>
<h2 id="WSGI接口"><a href="#WSGI接口" class="headerlink" title="WSGI接口"></a>WSGI接口</h2><p>了解HTTP协议和HTML文档，一个Web应用的本质是：</p>
<blockquote>
<p>浏览器发送一个请求—&gt;服务器收到请求，生成一个HTML文档—&gt;服务器把HTML文档作为HTTP相应的Body发送给浏览器—&gt;浏览器收到HTTP响应，从HTTP Body中取出HTML并显示。</p>
</blockquote>
<p>最简单的WEB应用就是先把HTML用文件保存好，用一个线程的HTTP服务器软件接收用户请求，从文件中读取HTML，返回。Apache、Nginx、Lighttpd等这些常见的静态服务器就是做这件事情的。</p>
<p> 如果要动态生成HTML，就需要把上述步骤自己实现。不过那些工作量很大，所以底层的代码由专门的服务器软件实现，我们用python专注于生成HTML文档。我们不希望接触到TCP连接。HTTP原始请求和响应格式，所以需要一个统一的接口，让我们专心用Python编写Web业务。</p>
<p>这个接口就是WSGI：Web Server Gateway Interface，只要求开发者实现一个函数，就可以相应HTTP请求。最简单的实例如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(envision, start_response)</span>:</span></div><div class="line"><span class="meta">... </span>    start_response(<span class="string">'200 OK'</span>,[(<span class="string">'Content-Type'</span>, <span class="string">'text/html'</span>)])</div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> [<span class="string">b'&lt;h1&gt;Hello, world!&lt;/h1&gt;'</span>]</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>上面的<code>application()</code>函数就是符合WSGI标准的一个HTTP处理函数，它接收两个参数：</p>
<blockquote>
<p>environ：一个包含所有HTTP请求信息的<code>dict</code>对象<br>start_response：一个发送HTTP响应的函数。</p>
</blockquote>
<p>在<code>application()</code>函数中，调用：</p>
<blockquote>
<p>start_response(‘200 OK’,[(‘Content-Type’, ‘text/html’)])</p>
</blockquote>
<p>就发送了HTTP响应的Header，注意Header只能发送一次，也就是只能调用一次<code>start_response()</code>函数。<code>start_response()</code>函数接收两个参数，一个是HTTP响应码，一个是一组<code>list</code>表示的HTTP Header，每个Header用一个包含两个<code>str</code>的<code>tuple</code>表示。</p>
<p>通常情况下，都应该把<code>Connect-Type</code>头发送给浏览器。其他很多常用的HTTP Header也应该发送。</p>
<p>然后函数的返回值<code>b&#39;&lt;h1&gt;Hello, world!&lt;/h1&gt;&#39;</code>将作为HTTP响应的Body发送给浏览器。</p>
<p>有了WSGI，我们关心的就是如何从<code>environ</code>这个<code>dict</code>对象中拿到HTTP请求信息然后构造HTML，通过<code>start_response()</code>函数发送Header，最后返回Body。</p>
<p>整个<code>application()</code>函数本身并没有涉及到任何解析HTTP的部分，也就是说，底层代码不需要我们自己编写，我们只负责在更高层次上考虑如何响应请求就可以了。并且<code>application()</code>必须由WSGI服务器来调用。有很多符合WSGI规范的服务器，我们可以挑选一个来用。Python内置了一个WSGI服务器，这个模块叫wsgiref，它是用纯Python编写的WSGI服务器的参考实现。</p>
<h3 id="运行WSGI服务"><a href="#运行WSGI服务" class="headerlink" title="运行WSGI服务"></a>运行WSGI服务</h3><p>我们先编写hello.py，实现WEB应用程序的WSGI处理函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">	start_response(<span class="string">'200 OK'</span>,[(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)])</div><div class="line">	<span class="keyword">return</span> [<span class="string">b'&lt;h1&gt;Hello, world!&lt;/h1&gt;'</span>]</div></pre></td></tr></table></figure></p>
<p>然后再编写一个<code>server.py</code>，负责启动WSGI服务器，加载<code>application()</code>函数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> wsgiref.simple_server <span class="keyword">import</span> make_server</div><div class="line"></div><div class="line"><span class="keyword">from</span> hello <span class="keyword">import</span> application</div><div class="line"></div><div class="line"><span class="comment">#创建一个服务器，IP地址为空，端口为8000，处理函数是application</span></div><div class="line">httpd = make_server(<span class="string">''</span>, <span class="number">8000</span>, application)</div><div class="line">print(<span class="string">'Serving HTTP on port 8000...'</span>)</div><div class="line"></div><div class="line">httpd.serve_forever()</div></pre></td></tr></table></figure></p>
<p>两个文件在一个目录下，执行服务器程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python server.py</div><div class="line">Serving HTTP on port <span class="number">8000.</span>..</div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">10</span>/Nov/<span class="number">2016</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">17</span>] <span class="string">"GET / HTTP/1.1"</span> <span class="number">200</span> <span class="number">22</span></div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">10</span>/Nov/<span class="number">2016</span> <span class="number">20</span>:<span class="number">47</span>:<span class="number">17</span>] <span class="string">"GET /favicon.ico HTTP/1.1"</span> <span class="number">200</span> <span class="number">22</span></div></pre></td></tr></table></figure></p>
<p> 启动成功后，打开浏览器，输入<code>http://localhost:8000/</code>就可以看到结果了。<br> <img src="/img/1478782158828.png" alt="Alt text"></p>
<p>按<code>Ctrl+c</code>终止服务器。</p>
<p>为了丰富WEB内容，可以在<code>environ</code>里读取<code>PATH_INFO</code>,这样可以显示更加动态的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">	start_response(<span class="string">'200 OK'</span>,[(<span class="string">'Content-Type'</span>,<span class="string">'text/html'</span>)])</div><div class="line">	body=<span class="string">'&lt;h1&gt;Hello, %s!&lt;/h1&gt;'</span> % (environ[<span class="string">'PATH_INFO'</span>][<span class="number">1</span>:] <span class="keyword">or</span> <span class="string">'web'</span>)</div><div class="line">	<span class="keyword">return</span> [body.encode(<span class="string">'utf-8'</span>)]</div></pre></td></tr></table></figure></p>
<p>你可以在地址栏输入用户名作为URL的一部分，将返回<code>Hello,xx!</code>：<br><img src="/img/1478782836071.png" alt="Alt text"></p>
<p>无论多么复杂的WEB应用程序，入口都是一个WSGI处理函数。HTTP请求的所有输入信息都可以通过<code>environ</code>获得，HTTP响应的输出都可以通过<code>start_response()</code>加上函数返回值作为Body。复杂的Web应用程序，光靠一个WSGI函数来处理还是太底层了，我们需要在WSGI之上再抽象出Web框架，进一步简化开发。</p>
<hr>
<h2 id="使用Web框架"><a href="#使用Web框架" class="headerlink" title="使用Web框架"></a>使用Web框架</h2><p>了解了WSGI框架，我们发现：其实一个WebAPP就是写一个WSGI的处理函数，针对每个HTTP请求进行相应。</p>
<p>但是如何处理HTTP请求不是问题，问题是如何处理100个不同的URL。</p>
<p>每一个URL可以对应GET和POST请求，当然还有PUT、DELETE等请求，但是通常我们只考虑最常见的GET和POST请求。</p>
<p>一个最简单的想法是从<code>environ</code>变量里取出HTTP请求的信息，然后逐个判断：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">application</span><span class="params">(environ, start_response)</span>:</span></div><div class="line">    method = environ[<span class="string">'REQUEST_METHOD'</span>]</div><div class="line">    path = environ[<span class="string">'PATH_INFO'</span>]</div><div class="line">    <span class="keyword">if</span> method==<span class="string">'GET'</span> <span class="keyword">and</span> path==<span class="string">'/'</span>:</div><div class="line">        <span class="keyword">return</span> handle_home(environ, start_response)</div><div class="line">    <span class="keyword">if</span> method==<span class="string">'POST'</span> <span class="keyword">and</span> path=<span class="string">'/signin'</span>:</div><div class="line">        <span class="keyword">return</span> handle_signin(environ, start_response)</div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>这样写下去代码是没法维护的，因为WSGI提供的接口虽然比HTTP接口高级了不少，但是和Web APP的处理逻辑相比，还是比较低级的，我们需要在WSGI接口之上能进一步抽象，让我们专注于用一个函数处理一个URL，至于URL到函数 的映射就交给WEB框架来做。</p>
<p>Python提供了上百个开源的框架，最流行的为<a href="http://flask.pocoo.org/" target="_blank" rel="external">flask</a>。</p>
<p>写一个<code>app.py</code>，处理三个URL，分别是：</p>
<blockquote>
<p>1、<code>GET /</code>：首页，返回<code>Home</code><br>2、<code>GET /signin</code>:登录页，显示登录表单<br>3、<code>POST /signin</code>：处理登录表单，显示登录结果。</p>
</blockquote>
<p>同一个URL<code>/signin</code>分别有GET和POST两种请求，映射到两个处理函数争取。Flask通过Python的装饰器在内部自动地把URL和函数关联起来：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</div><div class="line"></div><div class="line">app=Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/',methods=['GET', 'Post'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> <span class="string">'&lt;h1&gt;Home&lt;/h1&gt;'</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/signin', methods=['GET'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin_form</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> <span class="string">'''&lt;form action="/signin" method="post"&gt;</span></div><div class="line"><span class="string">			  &lt;p&gt;&lt;input name="username"&gt;&lt;/p&gt;</span></div><div class="line"><span class="string">			  &lt;p&gt;&lt;input name="password" type="password"&gt;&lt;/p&gt;</span></div><div class="line"><span class="string">			  &lt;p&gt;&lt;button type="submit"&gt;Sign In&lt;/p&gt;</span></div><div class="line"><span class="string">			  &lt;/form&gt;'''</span></div><div class="line"></div><div class="line"><span class="meta">@app.route('/signin', methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">if</span> request.form[<span class="string">'username'</span>]==<span class="string">'admin'</span> <span class="keyword">and</span> request.form[<span class="string">'password'</span>]==<span class="string">'password'</span>:</div><div class="line">		<span class="keyword">return</span> <span class="string">'&lt;h3&gt;Hello, admin!&lt;/h3&gt;'</span></div><div class="line">	<span class="keyword">return</span> <span class="string">'&lt;h3&gt;Bad username or password.&lt;/h3&gt;'</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">	app.run()</div></pre></td></tr></table></figure></p>
<p>运行<code>python app.py</code>，Flask自带的Server在端口5000上监听：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python app.py</div><div class="line"> * Running on http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/ (Press CTRL+C to quit)</div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Nov/<span class="number">2016</span> <span class="number">18</span>:<span class="number">07</span>:<span class="number">12</span>] <span class="string">"GET / HTTP/1.1"</span> <span class="number">200</span> -</div><div class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> - - [<span class="number">11</span>/Nov/<span class="number">2016</span> <span class="number">18</span>:<span class="number">07</span>:<span class="number">12</span>] <span class="string">"GET /favicon.ico HTTP/1.1"</span> <span class="number">404</span> -</div></pre></td></tr></table></figure></p>
<p>在浏览器首页输入：<code>http://localhost:5000/</code>:<br><img src="/img/1478858951071.png" alt="Alt text"></p>
<p>首页显示正确，地址栏输入:<code>http://localhost:5000/signin</code>:<br><img src="/img/1478859009824.png" alt="Alt text"></p>
<p>输入预设的用户名和口令：<br><img src="/img/1478859057990.png" alt="Alt text"><br><img src="/img/1478859073699.png" alt="Alt text"></p>
<p>实际的Web APP应该拿到用户名和口令后，去数据库查询再对比，来判断用户是否能登录成功。除了Flask，常见的python框架还有：Django、web.py、Bottle、Tornado</p>
<p>有了Web框架，我们在编写Web应用时，注意力就从WSGI处理函数转移到URL+对应的处理函数，编写变得简单。在编写URL处理函数时，除了配置URL外，从HTTP请求拿到用户数据也是非常重要的。Web框架都提供了自己的API来实现这些功能。Flask通过<code>request.form[&#39;name&#39;]</code>来获取表单的内容。</p>
<hr>
<h2 id="使用模板"><a href="#使用模板" class="headerlink" title="使用模板"></a>使用模板</h2><p>Web框架把我们从WSGI中拯救出来了，我们只需要不断地编写函数，带上URL，就可以继续Web APP的开发了。Web App最复杂的部分在HTML页面。HTML不仅要正确，还要通过CSS美化，再加上复杂的JavaScript脚本来实现各种交互和动画效果。用python的字符串是无法实现的。所以出现了模板技术。</p>
<p>使用模板首先需要预先准备一个HTML文档，这个HTMl文档不是普通的HTML，而是嵌入了一些变量和指令，然后根据我们传入的数据，替换后得到最终的HTMl，发送给用户：<br><img src="/img/1478859739321.png" alt="Alt text"></p>
<p>这就是传说中的MVC：Model-View-Controller，模型-视图-控制器</p>
<p>Python处理URL的函数就是C：Controller，Controller负责业务逻辑，比如检查用户名是否存在，取出用户信息等等。包含变量<code></code>的模板就是V：View，View负责显示逻辑，通过简单地替换一些变量，View最终输出的就是用户看到的HTML。</p>
<p>上面的例子中，Model就是一个<code>dict</code>：</p>
<blockquote>
<p>{ ‘name’: ‘Michael’}</p>
</blockquote>
<p>因为Python支持关键字参数，很多Web框架允许传入关键字参数，然后在框架内部组装出一个<code>dict</code>作为Model。</p>
<p>对之前的app.py进行改写：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request, render_template</div><div class="line"></div><div class="line">app=Flask(__name__)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/',methods=['GET', 'Post'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">home</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> render_template(<span class="string">'home.html'</span>)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/signin', methods=['GET'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin_form</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> render_template(<span class="string">'form.html'</span>)</div><div class="line"></div><div class="line"><span class="meta">@app.route('/signin', methods=['POST'])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">signin</span><span class="params">()</span>:</span></div><div class="line">	username=request.form[<span class="string">'username'</span>]</div><div class="line">	password=request.form[<span class="string">'password'</span>]</div><div class="line">	<span class="keyword">if</span> username==<span class="string">'admin'</span> <span class="keyword">and</span> password==<span class="string">'password'</span>:</div><div class="line">		<span class="keyword">return</span> render_template(<span class="string">'signin-ok.html'</span>, username=username)</div><div class="line">	<span class="keyword">return</span> render_template(<span class="string">'form.html'</span>, message=<span class="string">'Bad username or password'</span>,username=username)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__==<span class="string">'__main__'</span>:</div><div class="line">	app.run()</div></pre></td></tr></table></figure></p>
<p>Flask通过<code>render_template()</code>函数来实现模板的渲染。和Web框架类似，Python的模板也有很多中。Flask默认支持的模板是jinja2，用jinja2来编写模板home.html、显示首页：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Home&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &lt;h1 style=&quot;font-style:italic&quot;&gt;Home&lt;/h1&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html</div></pre></td></tr></table></figure></p>
<p>form.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Please Sign In&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &#123;% if message %&#125;</div><div class="line">  &lt;p style=&quot;color:red&quot;&gt;&#123;&#123; message &#125;&#125;&lt;/p&gt;</div><div class="line">  &#123;% endif %&#125;</div><div class="line">  &lt;form action=&quot;/signin&quot; method=&quot;post&quot;&gt;</div><div class="line">    &lt;legend&gt;Please sign in:&lt;/legend&gt;</div><div class="line">    &lt;p&gt;&lt;input name=&quot;username&quot; placeholder=&quot;Username&quot; value=&quot;&#123;&#123; username &#125;&#125;&quot;&gt;&lt;/p&gt;</div><div class="line">    &lt;p&gt;&lt;input name=&quot;password&quot; placeholder=&quot;Password&quot; type=&quot;password&quot;&gt;&lt;/p&gt;</div><div class="line">    &lt;p&gt;&lt;button type=&quot;submit&quot;&gt;Sign In&lt;/button&gt;&lt;/p&gt;</div><div class="line">  &lt;/form&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>signin-ok.html:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;head&gt;</div><div class="line">  &lt;title&gt;Welcome, &#123;&#123; username &#125;&#125;&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">  &lt;p&gt;Welcome, &#123;&#123; username &#125;&#125;!&lt;/p&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/14.网络编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/14.网络编程/" itemprop="url">14. 网络编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h1><p>现在几乎所有的程序都是网络程序，很少有单机版的程序了。计算机网络就是把各个计算机连接到一起，让网络中的计算机可以互相通信。网络编程就是如何在程序中实现两台计算机的通信。比如当你使用浏览器浏览新浪网时，你的计算机就和新浪的某台服务器通过互联网连接起来了，然后新浪的服务器把网页内容作为数据通过互联网传输到你的电脑。由于电脑上有很多软件，不同的程序连接的别的计算机也会不同。网络通信是两台计算机上的两个进程之间的通信。</p>
<p>网络编程对所有开发语言都是一样的。用Python进行网络编程，就是在Python程序本身这个进程内，连接别的服务器进程的通信端口进行通信。</p>
<h3 id="TCP-IP简介"><a href="#TCP-IP简介" class="headerlink" title="TCP/IP简介"></a>TCP/IP简介</h3><p>计算机wield联网，必须规定通信协议，早期的计算机网络，都是由各厂商自己规定一套协议，IBM、Apple和Micosoft都有各自的网络协议，互不兼容，同样的网络协议的计算机可以互相交流，不同协议的计算机就不可以。</p>
<p>为了实现所有不同类型的计算机都连接起来，互联网协议簇（Internet Protocol Suite）就是通用协议标准。最主要的两个协议是TCP协议和IP协议。</p>
<p>通信的时候，双方必须知道对方的标识，互联网中每一个计算机的唯一标识就是IP地址。如果一台计算机同时接入两个或两个以上的网络，比如路由器，它就会有两个或更多个IP地址，所以IP地址对应的实际上是计算机的网络接口，通常是网卡。</p>
<p>IP协议负责把数据从一台计算机通过网络发送到另一台计算机。数据被分割成一小块一小块，然后通过IP包发送出去。由于互联网链路复杂，两台计算机之间经常有多条线路，因此路由器就负责决定如何把一个IP包转发出去。IP报的特点是按块发送，途径多个路由，但不保证能到达，也不保证顺利到达。</p>
<p>TCP协议是建立在IP协议之上的。TCP协议负责在两台计算机之间建立可靠连接，保证数据包按顺序到达。TCP协议会通过握手建立连接，然后对每个IP包进行编号，确保对方按顺序收到，如果包丢了，就自动重发。</p>
<p>一个IP包除了包含要传输的数据外，还包含源IP地址和目的IP地址，源端口和目的端口。</p>
<p>在两台计算机通信时，只发IP地址是不够的，因为同一台计算机上跑着多个网络程序。一个IP包来了之后，到底是交给浏览器还是QQ就需要端口号来区分。每个网络程序都向操作系统申请唯一的端口号这样，两个进程在两台计算机之间建立的网络连接就需要各自的IP地址和各自的端口号。一个进程也可能同时与多个计算机建立链接，因此会申请很多端口。</p>
<h2 id="TCP编程"><a href="#TCP编程" class="headerlink" title="TCP编程"></a>TCP编程</h2><p>Socket是网络编程的一个抽象概念。通常我们用一个Socket表示打开了一个网络链接，而打开一个Socket需要知道目标计算机的IP地址和端口号，再指定协议类型即可。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>大多数连接都是可靠的TCP连接。创建TCP连接时，主动发起连接的叫客户端，被动相应连接的叫服务器。当我们在浏览器中访问新浪时，我们自己的计算机就是客户端，浏览器会主动向新浪的服务器发起连接。如果一切顺利，新浪的服务器接受了我们的连接，一个TCP连接就建立起来了，后面的通信就是发送网页内容了。所以我们要创建一个基于TCP的Socket：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">s.connect((<span class="string">'www.sina.com.cn'</span>,<span class="number">80</span>))</div></pre></td></tr></table></figure></p>
<p>创建<code>Socket</code>时，<code>AF_INET</code>指定使用IPv4协议，如果要用更先进的IPv6，就指定为<code>AF_INET6</code>。<code>SOCK_STREAM</code>指定使用面向流的TCP协议，这样一个<code>Socket</code>对象就创建成功，但是还没有建立连接。</p>
<p>客户端要主动发起TCP连接，必须知道服务器的IP地址和端口号。IP地址可以用域名自动转换得到，端口号需要服务器来提供。服务器提供什么样的服务，端口号就必须固定下来。80端口是WEB服务的标准端口。端口号小于1024的是Internet标准服务的端口，端口号大于1024的可以任意使用。</p>
<p>建立TCP连接后，我们可以向新浪服务器发送请求，要求返回首页的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.send(<span class="string">b'GET / HTTP/1.1\r\nHost: www.sina.com.cn\r\nConnection: close\r\n\r\n'</span>)</div></pre></td></tr></table></figure></p>
<p>TCP连接创建的是双向通道，双方都可以同时给对方发数据。但是谁先发谁后发怎么协调要根据具体的协议来决定。例如，HTTP协议规定客户端必须先发请求给服务器，服务器收到后才发数据给客户端。发送的文本格式必须符合HTTP标准，如果格式没问题，接下来就可以接收新浪返回的数据了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">buffer=[]</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	d=s.recv(<span class="number">1024</span>)</div><div class="line">	<span class="keyword">if</span> d:</div><div class="line">		buffer.append(d)</div><div class="line">	<span class="keyword">else</span>:</div><div class="line">		<span class="keyword">break</span></div><div class="line">data=<span class="string">b''</span>.join(buffer)</div></pre></td></tr></table></figure></p>
<p>接收数据时，调用<code>recv(max)</code>方法，一次最多接收指定的字节数，因此在一个while循环中反复接收，直到<code>recv()</code>返回空数据，表示接收完毕，退出循环。</p>
<p>当我们接收完出局后，调用<code>close()</code>方法关闭Socket，这样一次完整的网络通信就结束了。接收到的数据包括HTTP头和网页本身，我们只需要把HTTP头和网页分离一下，吧HTTP头打印出来，网页内容保存到文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">header, html = data.split(<span class="string">b'\r\n\r\n'</span>, <span class="number">1</span>)</div><div class="line">print(header.decode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'sina.html'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">	f.write(html)</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python <span class="number">11.</span>py</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Server: nginx</div><div class="line">Date: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">24</span>:<span class="number">26</span> GMT</div><div class="line">Content-Type: text/html</div><div class="line">Last-Modified: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">13</span> GMT</div><div class="line">Vary: Accept-Encoding</div><div class="line">Expires: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">25</span>:<span class="number">26</span> GMT</div><div class="line">Cache-Control: max-age=<span class="number">60</span></div><div class="line">X-Powered-By: shci_v1<span class="number">.03</span></div><div class="line">Age: <span class="number">31</span></div><div class="line">Content-Length: <span class="number">597288</span></div><div class="line">X-Cache: HIT <span class="keyword">from</span> ja180<span class="number">-183.</span>sina.com.cn</div><div class="line">Connection: close</div></pre></td></tr></table></figure></p>
<h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>和客户端相比，服务器编程要复杂一些。服务器进程首先要绑定一份端口并监听来自其他客户端的连接。服务器会打开固定端口监听，每来一个客户端连接，就创建该Socket连接。由于服务器会有大量来自客户端的连接，所以服务器要能够区分一个Socket连接是和那个客户端绑定的。一个Socket依赖四项：服务器地址、服务器端口、客户端地址、客户端端口来唯一确定一个Socket。</p>
<p>每个连接都需要一个新的进程或者线程来处理，否则服务器一次就只能服务一个客户端了。我们来编写一个简单的服务器程序，它接收客户端连接，把客户端发过来的字符串加上<code>Hello</code>再发回去。首先创建一个基于IPv4和TCP协议的Socket：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div></pre></td></tr></table></figure></p>
<p>然后，我们要绑定监听的地址和端口。服务器可能有多块网卡，可以绑定到某一块网卡的IP地址上，也可以用<code>0.0.0.0</code>绑定到所有的网络地址，还可以用<code>127.0.0.1</code>绑定到本机地址。</p>
<p>端口号需要预先指定。因为我们写的这个服务不是标准服务，所以用9999这个端口号，小于1024的端口号必须有管理员权限才能绑定：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.blind(<span class="string">'127.0.0.1'</span>,<span class="number">9999</span>)</div></pre></td></tr></table></figure></p>
<p>紧接着，调用<code>listen()</code>方法开始监听，传入的参数指定等待连接的最大数量：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s.listen(<span class="number">5</span>)</div><div class="line">print(<span class="string">'Waiting for connection...'</span>)</div></pre></td></tr></table></figure></p>
<p>接下来，服务器程序通过一个永久循环来接受来自客户端的连接，<code>accept()</code>会等待并返回一个客户端的连接：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	sock.addr=s.accept()</div><div class="line">	t=threading.Thread(target==tcplink,args=(sock, addr))</div><div class="line">	t.start()</div></pre></td></tr></table></figure></p>
<p>每个连接都必须创建新的线程或进程来处理，否则，单线程在处理连接的过程中无法接受其他客户端的连接：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcplink</span><span class="params">(sock, addr)</span>:</span></div><div class="line">	print(<span class="string">'Accecpt new connection from %s:%s...'</span> %addr)</div><div class="line">	sock.send(<span class="string">b'Welcome!'</span>)</div><div class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">		data=sock.recv(<span class="number">1024</span>)</div><div class="line">		time.sleep(<span class="number">1</span>)</div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> data.decode(<span class="string">'utf-8'</span>) == <span class="string">'exit'</span>:</div><div class="line">			<span class="keyword">break</span></div><div class="line">		sock.send((<span class="string">'Hello, %s!'</span> %data.decode(<span class="string">'utf-8'</span>)).encode(<span class="string">'utf-8'</span>))</div><div class="line">		sock.close()</div><div class="line">		print(<span class="string">'Connection from %s:%s closed.'</span> %addr)</div></pre></td></tr></table></figure></p>
<p>建立连接后，服务器首先发一条欢迎信息，然后等待客户端数据，并加上Hello再发送给客户端，如果客户端发送了exit字符串，就直接关闭连接。要测试这个程序，我们还需要编写一个客户端程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line"><span class="comment"># 建立连接:</span></div><div class="line">s.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div><div class="line"><span class="comment"># 接收欢迎消息:</span></div><div class="line">print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</div><div class="line">    <span class="comment"># 发送数据:</span></div><div class="line">    s.send(data)</div><div class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line">s.send(<span class="string">b'exit'</span>)</div><div class="line">s.close()</div></pre></td></tr></table></figure></p>
<p>用TCP协议进行Socket编程在Python中十分简单，对于客户端，要主动连接服务器的IP和指定端口，对于服务器，要首先监听指定端口，然后对每一个新的连接，创建一个线程或进程来处理。通常，服务器会无限运行下去。</p>
<hr>
<p>##UDP 编程</p>
<p>TCP建立的是可靠的连接，并且通信双方都可以以流的形式发送数据。UDP是面向无连接的协议。使用UDP时，不需要建立连接，只需要知道对方的IP地址和端口号，就可以直接发数据包，但是能够到达就不知道了。UDP的有点在于速度快，对于不要求可靠到达的数据，就可以使用UDP协议。</p>
<p>和TCP类似，使用UDP的通信双方也分为客户端和服务器，服务器首先需要绑定端口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line"><span class="comment"># 绑定端口:</span></div><div class="line">s.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div></pre></td></tr></table></figure></p>
<p>创建Socket时，<code>SOCK_DGRAM</code>指定了这个Socket的类型是UDP。绑定端口和TCP一样，但是不需要调用<code>listen()</code>方法，而是直接接收来自任何客户端的数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">print(<span class="string">'Bind UDP on 9999...'</span>)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    <span class="comment"># 接收数据:</span></div><div class="line">    data, addr = s.recvfrom(<span class="number">1024</span>)</div><div class="line">    print(<span class="string">'Received from %s:%s.'</span> % addr)</div><div class="line">    s.sendto(<span class="string">b'Hello, %s!'</span> % data, addr)</div></pre></td></tr></table></figure></p>
<p><code>recvform()</code>方法返回数据和客户端的地址与端口，这样，服务器收到数据后，直接调用<code>sendto()</code>就可以把数据用UDP发送给客户端了。</p>
<p>客户端使用UDP时，首先仍然创建基于UDP的Socket，然后不需要调用<code>connect()</code>直接通过<code>sendto()</code>给服务器发送数据：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</div><div class="line">    <span class="comment"># 发送数据:</span></div><div class="line">    s.sendto(data, (<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div><div class="line">    <span class="comment"># 接收数据:</span></div><div class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line">s.close()</div></pre></td></tr></table></figure></p>
<p>从服务器接收数据仍然调用<code>recv()</code>方法。</p>
<p>UDP的使用与TCP类似，但是不需要建立连接。此外，服务器绑定UDP端口和TCP端口互不冲突，也就是说，UDP的9999端口与TCP的9999端口可以各自绑定。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/15.电子邮件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/15.电子邮件/" itemprop="url">15. 电子邮件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h1><p>电子邮件软件成为MUA：Mail User Agent—-邮件用户代理。E-mail从MUA发出去，不是直接到达对方电脑而是发到MTA(Mail Transfer Agent—邮件传输代理)，就是Email服务提供商，比如网易，新浪等。MTA会把email投递到MDA(Mail Delivery Agent—邮件投递代理)，存储在某个文件或特殊的数据库里也就是邮箱。要想获取邮件，必须通过MUA从MDA上获取到自己电脑上。</p>
<blockquote>
<p>发件人—&gt;MUA—&gt;MTA—&gt;MTA—&gt;若干个MTA—&gt;MDA&lt;—MUA&lt;—收件人</p>
</blockquote>
<p>要编写程序来发送和接收邮件，本质上就是：</p>
<blockquote>
<p>1、编写MUA把邮件发到MTA<br>2、编写MUA从MDA上收邮件</p>
</blockquote>
<p>发邮件时MUA和MTA使用的协议是SMTP：Simple Mail Transfer Protocol。<br>收邮件时，MUA和MDA使用的协议有两种：POP：Post Office Protocol，目前版本是3，俗称POP3；IMAP：Internet Message Access Protocol，目前版本是4，优点是不但能取邮件，还可以直接操作MDA上存储的邮件，比如从收件箱移到垃圾箱。</p>
<p>邮件客户端在发邮件时，会让你先配置SMTP服务器，也就是你要发到哪个MTA上。比如你在用163邮箱，就不能直接发送到新浪的MTA上，你要填163提供的SMTP服务器地址：<code>smtp.163.com</code>，还需要输入邮箱地址和邮箱口令来证明你是163用户，这样MUA才能正常地把Email通过SMTP协议发送到MTA。</p>
<p>从MDA收取邮件时，MDA服务器会要求验证邮箱口令，这样MUA才能顺利地通过POP或IMAP协议从MDA获取邮件。</p>
<h2 id="SMTP发送邮件"><a href="#SMTP发送邮件" class="headerlink" title="SMTP发送邮件"></a>SMTP发送邮件</h2><p>SMTP是发送邮件的协议，Python内置对SMTP的支持，可以发送纯文本邮件，HTML邮件及其附件。</p>
<p>Python对SMTP支持有<code>smtplib</code>和<code>email</code>两个模块，<code>email</code>负责构造邮件，<code>stmplib</code>负责发送邮件。首先，我们来构造一个最简单的纯文本邮件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>msg=MIMEText(<span class="string">'Hello, send by Python...'</span>,<span class="string">'plain'</span>,<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure></p>
<p>注意到构造<code>MIMEText</code>对象时，第一个参数就是邮件正文，第二个参数是MIME的subtype，传入<code>plain</code>表示纯文本，最终的MIME就是<code>text/plain</code>，最后一定要用<code>utf-8</code>编码保证多语言兼容性。然后通过SMTP发送出去：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">from_addr=input(<span class="string">'From:'</span>)</div><div class="line">password=input(<span class="string">'Password:'</span>)</div><div class="line"></div><div class="line">to_addr=input(<span class="string">'To:'</span>)</div><div class="line"></div><div class="line">smtp_server=input(<span class="string">'SMTP server: '</span>)</div><div class="line"></div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line">server=smtplib.SMTP(smtp_server, <span class="number">25</span>)<span class="comment">#smtp默认的端口是25</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">server.login(from_addr, password)</div><div class="line">server.sendmail(from_addr,[to_addr],msg.as_string())</div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>我们用<code>set_debuglevel(1)</code>就可以打印出和SMTP服务器交互的所有信息。SMTP协议就是简单的文本命令和相应。<code>login()</code>方法用来登录SMTP服务器，<code>sendmail()</code>方法就是发邮件，由于可以一次发给对个人，所以传入一个<code>list</code>，邮件正文是一个<code>str</code>，<code>as_string()</code>把MIMEText对象编程<code>str</code>。收到的邮件的问题是没有主题收件人没有显示为友好的名字，且收到了邮件却提示你不在收件人中。这是因为邮件主题、如何显示发件人、收件人的信息并不是通过SMTP协议发给MTA，而是包含在发给MTA的文本中的，所以，我们必须把From、To、Subject添加到MIMEText中才是一封完整的邮件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email <span class="keyword">import</span> encoders</div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr, formataddr</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_format_addr</span><span class="params">(s)</span>:</span></div><div class="line">    name, addr = parseaddr(s)</div><div class="line">    <span class="keyword">return</span> formataddr((Header(name, <span class="string">'utf-8'</span>).encode(), addr))</div><div class="line"></div><div class="line">from_addr=input(<span class="string">'From:'</span>)</div><div class="line">password=input(<span class="string">'Password:'</span>)</div><div class="line">to_addr=input(<span class="string">'To:'</span>)</div><div class="line">smtp_server=input(<span class="string">'SMTP server: '</span>)</div><div class="line"></div><div class="line">msg=MIMEText(<span class="string">'hello, send by python...'</span>, <span class="string">'plain'</span> ,<span class="string">'utf-8'</span>)</div><div class="line">msg[<span class="string">'From'</span>] = _format_addr(<span class="string">'Python爱好者 &lt;%s&gt;'</span> % from_addr)</div><div class="line">msg[<span class="string">'To'</span>] = _format_addr(<span class="string">'管理员 &lt;%s&gt;'</span> % to_addr)</div><div class="line">msg[<span class="string">'Subject'</span>] = Header(<span class="string">'来自SMTP的问候……'</span>, <span class="string">'utf-8'</span>).encode()</div><div class="line"></div><div class="line">server = smtplib.SMTP(smtp_server, <span class="number">25</span>) <span class="comment"># SMTP协议默认端口是25</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">server.login(from_addr, password)</div><div class="line">server.sendmail(from_addr, [to_addr], msg.as_string())</div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>我们编写了一个函数<code>_format_addr()</code>来格式化一个邮件地址。注意不能简单地传入<code>name &lt;addr@example.com&gt;</code>,因为如果包含中文，需要通过<code>Header</code>对象编码。</p>
<p><code>msg[&#39;To&#39;]</code>发送的是字符串而不是list，如果有多个地址邮件，用，分隔即可。发送邮箱显示：<br><img src="/img/1478864121047.png" alt="Alt text"></p>
<p>你看到的收件人的名字可能不是我们传入的管理员，因为很多邮件服务商在显示邮件时会把收件人名字自动替换为用户注册的名字。我们插卡Email原始内容如下：</p>
<blockquote>
<p>From: =?utf-8?b?UHl0aG9u54ix5aW96ICF?= <a href="&#x6d;&#97;&#105;&#x6c;&#116;&#111;&#x3a;&#120;&#120;&#x78;&#x78;&#120;&#120;&#x40;&#49;&#54;&#51;&#x2e;&#99;&#x6f;&#109;">&#120;&#120;&#x78;&#x78;&#120;&#120;&#x40;&#49;&#54;&#51;&#x2e;&#99;&#x6f;&#109;</a><br>To: =?utf-8?b?566h55CG5ZGY?= <a href="&#109;&#97;&#x69;&#x6c;&#x74;&#111;&#58;&#120;&#120;&#120;&#x78;&#x78;&#120;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;">&#120;&#120;&#120;&#x78;&#x78;&#120;&#64;&#x71;&#113;&#x2e;&#99;&#111;&#x6d;</a><br>Subject: =?utf-8?b?5p2l6IeqU01UUOeahOmXruWAmeKApuKApg==?=</p>
</blockquote>
<h3 id="发送HTML邮件"><a href="#发送HTML邮件" class="headerlink" title="发送HTML邮件"></a>发送HTML邮件</h3><p>如果我们要发送HTML邮件而不是普通的纯文本文件怎么办，就在构造<code>MIMEText</code>对象时，把HTML字符串传进去，再把第二个参数由plain改为plain就可以了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msg=MIMEText(&apos;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&apos; + &apos;&lt;p&gt;send by &lt;a href=&quot;http://www.python.org&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&apos;+&apos;&lt;/body&gt;&lt;/html&gt;&apos;, &apos;html&apos;, &apos;utf-8&apos;)</div></pre></td></tr></table></figure></p>
<p>再发送一遍邮件：<br><img src="/img/1478864651325.png" alt="Alt text"></p>
<h3 id="发送附件"><a href="#发送附件" class="headerlink" title="发送附件"></a>发送附件</h3><p>如果Email中要加上附件，可以把带附件的邮件看做包含若干部分的邮件：文本和各个附件本身，所以可以构造一个<code>MIMEMultipart</code>对象代表邮件本身，然后往里面加上一个<code>MIMEText</code>作为邮件正文，再继续往里面加上表示附件的<code>MIMEBase</code>对象即可：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 邮件对象:</span></div><div class="line">msg = MIMEMultipart()</div><div class="line">msg[<span class="string">'From'</span>] = _format_addr(<span class="string">'Python爱好者 &lt;%s&gt;'</span> % from_addr)</div><div class="line">msg[<span class="string">'To'</span>] = _format_addr(<span class="string">'管理员 &lt;%s&gt;'</span> % to_addr)</div><div class="line">msg[<span class="string">'Subject'</span>] = Header(<span class="string">'来自SMTP的问候……'</span>, <span class="string">'utf-8'</span>).encode()</div><div class="line"></div><div class="line"><span class="comment"># 邮件正文是MIMEText:</span></div><div class="line">msg.attach(MIMEText(<span class="string">'send with file...'</span>, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="comment"># 添加附件就是加上一个MIMEBase，从本地读取一个图片:</span></div><div class="line"><span class="keyword">with</span> open(<span class="string">'/Users/michael/Downloads/test.png'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">    <span class="comment"># 设置附件的MIME和文件名，这里是png类型:</span></div><div class="line">    mime = MIMEBase(<span class="string">'image'</span>, <span class="string">'png'</span>, filename=<span class="string">'test.png'</span>)</div><div class="line">    <span class="comment"># 加上必要的头信息:</span></div><div class="line">    mime.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">'test.png'</span>)</div><div class="line">    mime.add_header(<span class="string">'Content-ID'</span>, <span class="string">'&lt;0&gt;'</span>)</div><div class="line">    mime.add_header(<span class="string">'X-Attachment-Id'</span>, <span class="string">'0'</span>)</div><div class="line">    <span class="comment"># 把附件的内容读进来:</span></div><div class="line">    mime.set_payload(f.read())</div><div class="line">    <span class="comment"># 用Base64编码:</span></div><div class="line">    encoders.encode_base64(mime)</div><div class="line">    <span class="comment"># 添加到MIMEMultipart:</span></div><div class="line">    msg.attach(mime)</div></pre></td></tr></table></figure></p>
<p> 发送结果：<br> <img src="/img/1478944551315.png" alt="Alt text"></p>
<h3 id="发送图片"><a href="#发送图片" class="headerlink" title="发送图片"></a>发送图片</h3><p>如果要把一个图片嵌入到邮件正文中，直接在HTML邮件中连接图片地址是不行的，我们需要按照发送附件的方法，把邮件作为附件添加进去，然后在HTML中通过引用<code>src=&quot;cid:0&quot;</code>就可以把附件作为图片嵌入。如果有多个图片，可以依次编号，然后引用不同的<code>cid:x</code>就可以。</p>
<p>把上面代码中加入<code>MIMEMultipart</code>的<code>MIMEText</code>从<code>plain</code>改为<code>html</code>，然后在适当的位置引用图片：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">msg.attach(MIMEText(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;'</span> +</div><div class="line">    <span class="string">'&lt;p&gt;&lt;img src="cid:0"&gt;&lt;/p&gt;'</span> +</div><div class="line">    <span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>, <span class="string">'html'</span>, <span class="string">'utf-8'</span>))</div></pre></td></tr></table></figure></p>
<p>发送结果：<br><img src="/img/1478945851210.png" alt="Alt text"></p>
<h3 id="同时支持HTML和Plain格式"><a href="#同时支持HTML和Plain格式" class="headerlink" title="同时支持HTML和Plain格式"></a>同时支持HTML和Plain格式</h3><p>如果我们发送HTML邮件，收件人通过浏览器或者Outlook之类的软件是可以正常浏览邮件内容的，但是如果收件人的设备无法查看HTML邮件时，我们可以在发送HTML的同时再附加一个纯文本，如果收件人无法查看HTML格式的邮件，就可以自动降级查看纯文本邮件。</p>
<p>利用<code>MIMEMultipart</code>可以组合一个HTML和Plain，要注意指定subtype是<code>alternative</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">msg = MIMEMultipart(<span class="string">'alternative'</span>)</div><div class="line">msg[<span class="string">'From'</span>] = ...</div><div class="line">msg[<span class="string">'To'</span>] = ...</div><div class="line">msg[<span class="string">'Subject'</span>] = ...</div><div class="line"></div><div class="line">msg.attach(MIMEText(<span class="string">'hello'</span>, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>))</div><div class="line">msg.attach(MIMEText(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span>, <span class="string">'html'</span>, <span class="string">'utf-8'</span>))</div><div class="line"><span class="comment"># 正常发送msg对象...</span></div></pre></td></tr></table></figure></p>
<h3 id="加密SMTP"><a href="#加密SMTP" class="headerlink" title="加密SMTP"></a>加密SMTP</h3><p>使用标准的25端口连接SMTP服务器时，使用的是明文传输，发送邮件的整个过程可能会被窃听。要更安全地发送邮件，可以加密SMTP会话，实际上就是先创建SSL安全连接，然后再使用SMTP协议发送邮件。</p>
<p>Gmail提供的SMTP服务必须要加密传输。首先知道Gmail的SMTP端口是587，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">smtp_server = <span class="string">'smtp.gmail.com'</span></div><div class="line">smtp_port = <span class="number">587</span></div><div class="line">server = smtplib.SMTP(smtp_server, smtp_port)</div><div class="line">server.starttls()</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>只需要在创建SMTP对象后，立刻调用<code>starttls()</code>方法，就创建了安全链接。后面的代码和前面的发送邮件代码完全一样。</p>
<p>使用Python的smtplib发送邮件很简单，只要掌握了各种邮件类型的构造方法，正确设置好邮件头就可以顺利发出。构造一个邮件对象就是一个<code>Message</code>对象，如果构建一个<code>MIMEText</code>对象，就表示一个作为附件的图片，要把多个对象组合起来，就用<code>MIMEMultipart</code>，<code>MIMEBase</code>可以表示任何对象，继承关系如下：<br><img src="/img/1478946592016.png" alt="Alt text"></p>
<hr>
<h2 id="POP3收取邮件"><a href="#POP3收取邮件" class="headerlink" title="POP3收取邮件"></a>POP3收取邮件</h2><p>收邮件就是编写一个MUA作为客户端，从MDA把邮件获取到用户的电脑或者手机上。收取邮件最常用的协议是POP协议。Python内置了一个<code>poplib</code>模块，实现了POP3协议。</p>
<p>POP3收取的不是一个已经可以阅读的邮件本身，而是邮件的原始文本，这和SMTP一样，SMTP发送的也是经过编码后的一大段文本。要把POP3收取的文本变为可以阅读的邮件，还需要用<code>email</code>模块提供的各种类来解析原始文本，变成可阅读的邮件对象。收取邮件分为两部分：</p>
<blockquote>
<p>1、用<code>poplib</code>把邮件的原始文本下载到本地；<br>2、用<code>email</code>解析原始文本，还原为邮件对象。</p>
</blockquote>
<h3 id="通过POP3下载邮件"><a href="#通过POP3下载邮件" class="headerlink" title="通过POP3下载邮件"></a>通过POP3下载邮件</h3><p>POP3的协议本身很简单，以下面的代码为例，我们来获取最新的一封邮件内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">import</span> poplib</div><div class="line"></div><div class="line"><span class="comment">#输入邮箱地址，口令和POP3服务器地址：</span></div><div class="line">email = input(<span class="string">'Email:'</span>)</div><div class="line">password =input(<span class="string">'Password:'</span>)</div><div class="line">pop3_server = input(<span class="string">'POP3 server:'</span>)</div><div class="line"></div><div class="line"><span class="comment">#连接到POP3服务器</span></div><div class="line">server = poplib.POP3(pop3_server)</div><div class="line"><span class="comment">#可以打开或关闭调试信息</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">print(server.getwelcome().decode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="comment">#身份认证</span></div><div class="line">server.user(email)</div><div class="line">server.pass_(password)</div><div class="line"></div><div class="line"><span class="comment">#start()返回邮件数量和占用空间</span></div><div class="line">print(<span class="string">'Messages: %s, Size: %s'</span> %server.stat())</div><div class="line"><span class="comment">#list()返回所有邮件的编号</span></div><div class="line">resp, mails, octets = server.list()</div><div class="line"></div><div class="line">print(mails)</div><div class="line"></div><div class="line"><span class="comment">#获取最新一封邮件，索引号从1开始</span></div><div class="line">index = len(mails)</div><div class="line">resp, lines, octets = server.retr(index)</div><div class="line">msg_content = <span class="string">b'\r\n'</span>.join(lines).decode(<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">msg = Parser().parsestr(msg_content)</div><div class="line"></div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>用POP3协议很简单，要获取所有邮件，只需要循环使用<code>retr()</code>把每一封邮件内容拿到即可。</p>
<h3 id="解析邮件"><a href="#解析邮件" class="headerlink" title="解析邮件"></a>解析邮件</h3><p>解析邮件的过程和上一节构造邮件刚好相反，必须导入必要的模块：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> decode_header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr</div><div class="line"></div><div class="line"><span class="keyword">import</span> poplib</div></pre></td></tr></table></figure></p>
<p>一行代码可以把邮件内容解析为Message对象：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msg = Parser().parsestr(msg_content)</div></pre></td></tr></table></figure></p>
<p>这个<code>Message</code>对象本身可能是一个<code>MIMEMultipart</code>对象，即包含嵌套的其他<code>MIMEBase</code>对象，嵌套可能还不止一层。所以我们要递归地打印出Message对象的层次结构：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># indent用于缩进显示:</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_info</span><span class="params">(msg, indent=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> indent == <span class="number">0</span>:</div><div class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> [<span class="string">'From'</span>, <span class="string">'To'</span>, <span class="string">'Subject'</span>]:</div><div class="line">            value = msg.get(header, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> value:</div><div class="line">                <span class="keyword">if</span> header==<span class="string">'Subject'</span>:</div><div class="line">                    value = decode_str(value)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    hdr, addr = parseaddr(value)</div><div class="line">                    name = decode_str(hdr)</div><div class="line">                    value = <span class="string">u'%s &lt;%s&gt;'</span> % (name, addr)</div><div class="line">            print(<span class="string">'%s%s: %s'</span> % (<span class="string">'  '</span> * indent, header, value))</div><div class="line">    <span class="keyword">if</span> (msg.is_multipart()):</div><div class="line">        parts = msg.get_payload()</div><div class="line">        <span class="keyword">for</span> n, part <span class="keyword">in</span> enumerate(parts):</div><div class="line">            print(<span class="string">'%spart %s'</span> % (<span class="string">'  '</span> * indent, n))</div><div class="line">            print(<span class="string">'%s--------------------'</span> % (<span class="string">'  '</span> * indent))</div><div class="line">            print_info(part, indent + <span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        content_type = msg.get_content_type()</div><div class="line">        <span class="keyword">if</span> content_type==<span class="string">'text/plain'</span> <span class="keyword">or</span> content_type==<span class="string">'text/html'</span>:</div><div class="line">            content = msg.get_payload(decode=<span class="keyword">True</span>)</div><div class="line">            charset = guess_charset(msg)</div><div class="line">            <span class="keyword">if</span> charset:</div><div class="line">                content = content.decode(charset)</div><div class="line">            print(<span class="string">'%sText: %s'</span> % (<span class="string">'  '</span> * indent, content + <span class="string">'...'</span>))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%sAttachment: %s'</span> % (<span class="string">'  '</span> * indent, content_type))</div></pre></td></tr></table></figure></p>
<p>邮件的Subject或者Email中包含的名字都是经过编码后的str，要正常显示，就必须decode：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_Str</span><span class="params">(s)</span>:</span></div><div class="line">	value, charset = decode_header(s)[<span class="number">0</span>]</div><div class="line">	<span class="keyword">if</span> charset:</div><div class="line">		value = value.decode(charset)</div><div class="line">	<span class="keyword">return</span> value</div></pre></td></tr></table></figure></p>
<p><code>decode_header()</code>返回一个list，因为像<code>Cc``Bcc</code>这样的字段可能包含多个邮件地址，所以解析出来的会有多个元素。上面的代码我们只取了第一个元素。文本邮件的内容也是str，还需要检测编码，否则非UTF-8编码的邮件都无法正常显示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gusee_charset</span><span class="params">(msg)</span>:</span></div><div class="line">	charset = msg.get_charset()</div><div class="line">	<span class="keyword">if</span> charset <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">		content_type = msg.get(<span class="string">'Content-Type'</span>, <span class="string">''</span>).lower()</div><div class="line">		pos = content_type.find(<span class="string">'charset='</span>)</div><div class="line">		<span class="keyword">if</span> pos &gt;= <span class="number">0</span>:</div><div class="line">			charset = content_type[pos + <span class="number">8</span>:].strip()</div><div class="line">	<span class="keyword">return</span> charset</div></pre></td></tr></table></figure></p>
<p>把上面的代码整理好，我们就可以来试试获取一封邮件。先往自己的邮箱发送一封邮件，然后用Python程序把它收到本地：<br><img src="/img/1478954102163.png" alt="Alt text"></p>
<p>源码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> decode_header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr</div><div class="line"></div><div class="line"><span class="keyword">import</span> poplib</div><div class="line"></div><div class="line"><span class="comment"># 输入邮件地址, 口令和POP3服务器地址:</span></div><div class="line">email = input(<span class="string">'Email: '</span>)</div><div class="line">password = input(<span class="string">'Password: '</span>)</div><div class="line">pop3_server = input(<span class="string">'POP3 server: '</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_charset</span><span class="params">(msg)</span>:</span></div><div class="line">    charset = msg.get_charset()</div><div class="line">    <span class="keyword">if</span> charset <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        content_type = msg.get(<span class="string">'Content-Type'</span>, <span class="string">''</span>).lower()</div><div class="line">        pos = content_type.find(<span class="string">'charset='</span>)</div><div class="line">        <span class="keyword">if</span> pos &gt;= <span class="number">0</span>:</div><div class="line">            charset = content_type[pos + <span class="number">8</span>:].strip()</div><div class="line">    <span class="keyword">return</span> charset</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_str</span><span class="params">(s)</span>:</span></div><div class="line">    value, charset = decode_header(s)[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> charset:</div><div class="line">        value = value.decode(charset)</div><div class="line">    <span class="keyword">return</span> value</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_info</span><span class="params">(msg, indent=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> indent == <span class="number">0</span>:</div><div class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> [<span class="string">'From'</span>, <span class="string">'To'</span>, <span class="string">'Subject'</span>]:</div><div class="line">            value = msg.get(header, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> value:</div><div class="line">                <span class="keyword">if</span> header==<span class="string">'Subject'</span>:</div><div class="line">                    value = decode_str(value)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    hdr, addr = parseaddr(value)</div><div class="line">                    name = decode_str(hdr)</div><div class="line">                    value = <span class="string">u'%s &lt;%s&gt;'</span> % (name, addr)</div><div class="line">            print(<span class="string">'%s%s: %s'</span> % (<span class="string">'  '</span> * indent, header, value))</div><div class="line">    <span class="keyword">if</span> (msg.is_multipart()):</div><div class="line">        parts = msg.get_payload()</div><div class="line">        <span class="keyword">for</span> n, part <span class="keyword">in</span> enumerate(parts):</div><div class="line">            print(<span class="string">'%spart %s'</span> % (<span class="string">'  '</span> * indent, n))</div><div class="line">            print(<span class="string">'%s--------------------'</span> % (<span class="string">'  '</span> * indent))</div><div class="line">            print_info(part, indent + <span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        content_type = msg.get_content_type()</div><div class="line">        <span class="keyword">if</span> content_type==<span class="string">'text/plain'</span> <span class="keyword">or</span> content_type==<span class="string">'text/html'</span>:</div><div class="line">            content = msg.get_payload(decode=<span class="keyword">True</span>)</div><div class="line">            charset = guess_charset(msg)</div><div class="line">            <span class="keyword">if</span> charset:</div><div class="line">                content = content.decode(charset)</div><div class="line">            print(<span class="string">'%sText: %s'</span> % (<span class="string">'  '</span> * indent, content + <span class="string">'...'</span>))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%sAttachment: %s'</span> % (<span class="string">'  '</span> * indent, content_type))</div><div class="line"></div><div class="line"><span class="comment"># 连接到POP3服务器:</span></div><div class="line">server = poplib.POP3(pop3_server)</div><div class="line"><span class="comment"># 可以打开或关闭调试信息:</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line"><span class="comment"># 可选:打印POP3服务器的欢迎文字:</span></div><div class="line">print(server.getwelcome().decode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="comment"># 身份认证:</span></div><div class="line">server.user(email)</div><div class="line">server.pass_(password)</div><div class="line"><span class="comment"># stat()返回邮件数量和占用空间:</span></div><div class="line">print(<span class="string">'Messages: %s. Size: %s'</span> % server.stat())</div><div class="line"><span class="comment"># list()返回所有邮件的编号:</span></div><div class="line">resp, mails, octets = server.list()</div><div class="line"><span class="comment"># 可以查看返回的列表类似[b'1 82923', b'2 2184', ...]</span></div><div class="line">print(mails)</div><div class="line"><span class="comment"># 获取最新一封邮件, 注意索引号从1开始:</span></div><div class="line">index = len(mails)</div><div class="line">resp, lines, octets = server.retr(index)</div><div class="line"><span class="comment"># lines存储了邮件的原始文本的每一行,</span></div><div class="line"><span class="comment"># 可以获得整个邮件的原始文本:</span></div><div class="line">msg_content = <span class="string">b'\r\n'</span>.join(lines).decode(<span class="string">'utf-8'</span>)</div><div class="line"><span class="comment"># 稍后解析出邮件:</span></div><div class="line">msg = Parser().parsestr(msg_content)</div><div class="line">print_info(msg)</div><div class="line"><span class="comment"># 可以根据邮件索引号直接从服务器删除邮件:</span></div><div class="line"><span class="comment"># server.dele(index)</span></div><div class="line"><span class="comment"># 关闭连接:</span></div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/12.常用第三方模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/12.常用第三方模块/" itemprop="url">12. 常用第三方模块</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="常用第三方模块"><a href="#常用第三方模块" class="headerlink" title="常用第三方模块"></a>常用第三方模块</h1><p>除了内建的模块，Python还有很多的第三方模块，在<a href="https://pypi.python.org/pypi" target="_blank" rel="external">PyPI-the Python Package Index</a>注册。</p>
<h2 id="PIL"><a href="#PIL" class="headerlink" title="PIL"></a>PIL</h2><p>PIL：Python Imaging Library，已经是Python平台事实上的图像处理标准库了。PIL的功能非常强大，API却非常简单易用。PIL只支持到2.7，PIL上的兼容版本Pillow，加了很多新特性，可以支持到3.x。</p>
<h3 id="操作图像"><a href="#操作图像" class="headerlink" title="操作图像"></a>操作图像</h3><p>图像缩放操作：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>im=Image.open(<span class="string">'1.jpg'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>w,h=im.size</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Original image size: %sx%s'</span> %(w,h))</div><div class="line">Original image size: <span class="number">600</span>x337</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>im.thumbnail((w//<span class="number">2</span>, h//<span class="number">2</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(<span class="string">'Resize image to: %sx%s'</span> %(w//<span class="number">2</span>,h//<span class="number">2</span>))</div><div class="line">Resize image to: <span class="number">300</span>x168</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>im.save(<span class="string">'thumbnail.jpg'</span>,<span class="string">'jpeg'</span>)</div></pre></td></tr></table></figure></p>
<p>其他功能如切片、旋转、滤镜、输出文字、调色板等一应俱全。比如，模糊效果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> PIL <span class="keyword">import</span> Image,ImageFilter</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>im=Image.open(<span class="string">'1.jpg'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>im2=im.filter(ImageFilter.BLUR)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>im2.save(<span class="string">'blur.jpg'</span>,<span class="string">'jpeg'</span>)</div></pre></td></tr></table></figure></p>
<p>PIL的<code>ImageDraw</code>提供了一系列绘图的方法，让我们可以直接绘图。如生成字幕验证码的图片：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment">#-*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont, ImageFilter</div><div class="line"></div><div class="line"><span class="keyword">import</span> random</div><div class="line"></div><div class="line"><span class="comment">#随机字母：</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rndChar</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> chr(random.randint(<span class="number">65</span>,<span class="number">90</span>))</div><div class="line"></div><div class="line"><span class="comment">#随机颜色1：</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rndColor</span><span class="params">()</span>:</span></div><div class="line">	<span class="keyword">return</span> (random.randint(<span class="number">64</span>,<span class="number">255</span>),random.randint(<span class="number">64</span>,<span class="number">255</span>),random.randint(<span class="number">64</span>,<span class="number">255</span>))</div><div class="line"></div><div class="line"><span class="comment">#随机颜色2：</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">rndColor2</span><span class="params">()</span>:</span></div><div class="line">		<span class="keyword">return</span> (random.randint(<span class="number">32</span>,<span class="number">217</span>),random.randint(<span class="number">32</span>,<span class="number">217</span>),random.randint(<span class="number">32</span>,<span class="number">217</span>))</div><div class="line"></div><div class="line"><span class="comment">#240*60</span></div><div class="line">width=<span class="number">60</span>*<span class="number">4</span></div><div class="line">height=<span class="number">60</span></div><div class="line">image=Image.new(<span class="string">'RGB'</span>,(width,height),(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>))</div><div class="line"><span class="comment">#创建Font、Draw对象：</span></div><div class="line">font=ImageFont.truetype(<span class="string">'C:\Windows\Fonts\Arial.ttf'</span>,<span class="number">36</span>)</div><div class="line">draw=ImageDraw.Draw(image)</div><div class="line"><span class="comment">#填充：</span></div><div class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(width):</div><div class="line">	<span class="keyword">for</span> y <span class="keyword">in</span> range(height):</div><div class="line">		draw.point((x,y),fill=rndColor())</div><div class="line"><span class="comment">#输出文字：</span></div><div class="line"><span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">4</span>):</div><div class="line">	draw.text((<span class="number">60</span>*t+<span class="number">10</span>,<span class="number">10</span>),rndChar(),font=font,fill=rndColor2())</div><div class="line"><span class="comment">#模糊</span></div><div class="line">image=image.filter(ImageFilter.BLUR)</div><div class="line">image.save(<span class="string">'code.jpg'</span>,<span class="string">'jpeg'</span>)</div></pre></td></tr></table></figure></p>
<p>得到的验证码图片如下：<br><img src="/img/1478431423817.png" alt="Alt text"></p>
<p><a href="https://pillow.readthedocs.org/" target="_blank" rel="external">详细的Pillow官方文档：</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/13.virtualenv&图形界面/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/13.virtualenv&图形界面/" itemprop="url">13. virtualenv&图形界面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="virtualenv-amp-图形界面"><a href="#virtualenv-amp-图形界面" class="headerlink" title="virtualenv&amp;图形界面"></a>virtualenv&amp;图形界面</h1><h2 id="virtualenv"><a href="#virtualenv" class="headerlink" title="virtualenv"></a>virtualenv</h2><p>在开发Python应用程序的时候，系统安装的Python只有一个3.5版本。所有的第三方包都会被安装到Python3的<code>site-packages</code>目录下。</p>
<p>如果要同时开发多个应用程序，那么这些应用程序共用一个Python3.5，如果应用A需要jinja2.7，应用B需要jinja2.6，这时候需要用virtualenv来为一个应用创建一套隔离的Python运行环境。</p>
<p>第一步，创建项目文件夹myproject，在该文件夹中安装虚拟环境env：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;mkdir myproject</div><div class="line">D:\笔记\Python\Notepad++&gt;cd myproject</div><div class="line">D:\笔记\Python\Notepad++\myproject&gt;dir</div><div class="line"> 驱动器 D 中的卷是 文件</div><div class="line"> 卷的序列号是 <span class="number">0</span>BE3<span class="number">-0E5</span>C</div><div class="line"></div><div class="line"> D:\笔记\Python\Notepad++\myproject 的目录</div><div class="line"></div><div class="line"><span class="number">2016</span>/<span class="number">11</span>/<span class="number">06</span>  <span class="number">20</span>:<span class="number">01</span>    &lt;DIR&gt;          .</div><div class="line"><span class="number">2016</span>/<span class="number">11</span>/<span class="number">06</span>  <span class="number">20</span>:<span class="number">01</span>    &lt;DIR&gt;          ..</div><div class="line">               <span class="number">0</span> 个文件              <span class="number">0</span> 字节</div><div class="line">               <span class="number">2</span> 个目录 <span class="number">104</span>,<span class="number">178</span>,<span class="number">057</span>,<span class="number">216</span> 可用字节</div><div class="line"></div><div class="line">D:\笔记\Python\Notepad++\myproject&gt;virtualenv env</div><div class="line">Using base prefix <span class="string">'c:\\users\\cdxu0\\appdata\\local\\programs\\python\\python35'</span></div><div class="line">New python executable <span class="keyword">in</span> D:\笔记\Python\Notepad++\myproject\env\Scripts\python.exe</div><div class="line">Installing setuptools, pip, wheel...done.</div></pre></td></tr></table></figure></p>
<p>第二步，启动虚拟环境，安装所需库类。在windows中虚拟环境的启动使用命令：your_env_dir\Scripts\activate，默认情况下，virtualenv已经安装好了pip。在启动虚拟环境后直接使用pip install命令就可以为该虚拟环境安装库类。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++\myproject&gt;cd env\Scripts</div><div class="line"></div><div class="line">D:\笔记\Python\Notepad++\myproject\env\Scripts&gt;activate</div><div class="line"></div><div class="line">(env) D:\笔记\Python\Notepad++\myproject\env\Scripts&gt;pip install flask==<span class="number">0.9</span></div></pre></td></tr></table></figure></p>
<p>第三步，在虚拟环境中可以运行脚本等操作，离开虚拟环境，使用deactivate命令。</p>
<hr>
<h2 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h2><p>Python支持多种图形界面的第三方库，比如：Tk，wxWidgets ，Qt，GTK等。但是Python自带的库是支持Tk的TKinter，使用Tkinter，无需安装任何包就可以直接使用。</p>
<p>使用TKinter十分简单，第一步导入TKinter包的所有内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</div></pre></td></tr></table></figure></p>
<p>第二步从<code>Frame</code>派生一个<code>Application</code>类，这是所有Widget的父容器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(Frame)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,master=None)</span>:</span></div><div class="line">		Frame.__init__(self,master)</div><div class="line">		self.pack()</div><div class="line">		self.createWidgets()</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">createWidgets</span><span class="params">(self)</span>:</span></div><div class="line">		self.helloLabel=Label(self, text=<span class="string">'Hello, world!'</span>)</div><div class="line">		self.helloLabel.pack()</div><div class="line">		self.quitButton=Button(self, text=<span class="string">'Quit'</span>, command=self.quit)</div><div class="line">		self.quitButton.pack()</div></pre></td></tr></table></figure></p>
<p>在GUI中，每个Button、Label、输入框等，都是一个Widget。Frame则是可以容纳其他Widget的Widget，所有的Widget组合起来就是一棵树。</p>
<p><code>pack()</code>方法把Widget加入到父容器中，并实现布局。<code>pack()</code>是最简单的布局，<code>grid()</code>可以实现更复杂的布局。</p>
<p>在<code>createWidgets()</code>方法中，我们创建一个<code>Label</code>和一个<code>Button</code>，当Button被点击时，触发<code>self.quit()</code>使得程序退出。</p>
<p>第三步，实例化<code>Application</code>，并启动消息循环：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>app=Application()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app.master.title(<span class="string">'Hello world!'</span>)</div><div class="line"><span class="string">''</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app.mainloop()</div></pre></td></tr></table></figure></p>
<p>GUI程序的主线负责监听来自操作系统的消息，并依次处理每一条消息。因此，如果消息处理非常耗时，就需要新线程中处理。运行这个GUI程序：<br><img src="/img/1478439318915.png" alt="Alt text"></p>
<p>点击Quit按钮或者窗口的x结束程序。</p>
<h3 id="输入文本"><a href="#输入文本" class="headerlink" title="输入文本"></a>输入文本</h3><p>我们再对这个GUI程序改进一下，加入一个文本框，让用户可以输入文本，然后点按钮后，弹出消息对话框。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment">#-*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> tkinter.messagebox <span class="keyword">as</span> messagebox</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(Frame)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,master=None)</span>:</span></div><div class="line">		Frame.__init__(self,master)</div><div class="line">		self.pack()</div><div class="line">		self.createWidgets()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">createWidgets</span><span class="params">(self)</span>:</span></div><div class="line">		self.nameInput=Entry(self)</div><div class="line">		self.nameInput.pack()</div><div class="line">		self.alterButton=Button(self, text=<span class="string">'Hello'</span>, command=self.hello)</div><div class="line">		self.alterButton.pack()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></div><div class="line">		name=self.nameInput.get() <span class="keyword">or</span> <span class="string">'world'</span></div><div class="line">		messagebox.showinfo(<span class="string">'Message'</span>,<span class="string">'Hello, %s'</span> %name)</div><div class="line"></div><div class="line">app=Application()</div><div class="line">app.master.title(<span class="string">'Hello World'</span>)</div><div class="line">app.mainloop()</div></pre></td></tr></table></figure></p>
<p>当用户点击按钮时，出发<code>hello()</code>,通过<code>self.nameInput.get()</code>获得用户输入的文本后，使用<code>tkMessageBox.showinfo()</code>可以弹出消息对话框：<br><img src="/img/1478440468867.png" alt="Alt text"><br><img src="/img/1478440493401.png" alt="Alt text"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/11.常用内建模块/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/11.常用内建模块/" itemprop="url">11. 常用内建模块</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="常用内建模块"><a href="#常用内建模块" class="headerlink" title="常用内建模块"></a>常用内建模块</h1><h2 id="datetime"><a href="#datetime" class="headerlink" title="datetime"></a>datetime</h2><p>datetime是Python处理日期和时间的标准库。</p>
<p>获取当前的日期和时间：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now=datetime.now()  <span class="comment">#获取当前的datetime</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(now)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">20</span>:<span class="number">25</span>:<span class="number">50.305269</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(type(now))</div><div class="line">&lt;<span class="class"><span class="keyword">class</span> '<span class="title">datetime</span>.<span class="title">datetime</span>'&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意到<code>datetime</code>是模块，<code>datetime</code>模块还包含一个<code>datetime</code>类，通过<code>from datetime import datetime</code>导入的才是<code>datetime</code>这个类。如果仅导入<code>import datetime</code>，则必须引用全名<code>datetime.datetime</code>。<code>datetime.now()</code>返回当前日期和时间，其类型是<code>datetime</code>。</p>
<p>获取指定日期和时间：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dt=datetime(<span class="number">2015</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>,<span class="number">11</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(dt)</div><div class="line"><span class="number">2015</span><span class="number">-11</span><span class="number">-11</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">00</span></div></pre></td></tr></table></figure></p>
<p>datetime转换为timestamp，在计算机中，时间实际上是由数字表示的，我们把1970年1月1日00:00:00UTC+00:00时区的时刻称为epoch time，记为0，当前时间就是相当于epoch time的秒数，称为timestamp。</p>
<blockquote>
<p>timestamp=0=1970-1-1 00:00:00 UTC+0:00</p>
</blockquote>
<p>对应的北京时间是</p>
<blockquote>
<p>timestamp=0=1970-1-1 08:00:00 UTC+8:00</p>
</blockquote>
<p>课件timestamp的值和时区毫无关系，因为timestamp一旦确定，其UTC时间就确定了，转换到任意时区的时间也是完全确定的，这就是为什么计算机存储的当前时间是一timestamp表示的，因为世界各地的计算机在任意时刻的timestamp都是完全相同的。</p>
<p>把一个<code>datetime</code>类型转换为timestamp只需要简单调用<code>timestamp()</code>方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>dt.timestamp()</div><div class="line"><span class="number">1447211460.0</span></div></pre></td></tr></table></figure></p>
<p>注意Python的timestamp是一个浮点数。如果有小数点，小数位表示毫秒数。某些编程语言的timestamp使用整数表示毫秒数，这种情况下需要把timestamp除以1000就得到Python的浮点表示方法。</p>
<p>timestamp转换为datetime：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t=<span class="number">1429417200.0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(datetime.fromtimestamp(t))</div><div class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-19</span> <span class="number">12</span>:<span class="number">20</span>:<span class="number">00</span></div></pre></td></tr></table></figure></p>
<p>注意到timestamp是一个浮点数，它没有时区的概念，而datetime有时区的。上述转换是在timestamp和本地时间做转换。本地时间是指当前操作系统设定的时区。例如北京时区是东八区，则本地时间是2015-04-19 12:20:00，实际上就是UTC+8:00时区的时间2015-04-19 12:20:00 UTC+8:00，而此时的格林威治标准时间与北京差了八个小时，也就是UTC+0:00时区的时间：2015-04-19 04:20:00 UTC+0:00。</p>
<p>timestamp也可以直接转换到UTC标准时区的时间：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t=<span class="number">1429417200.0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(datetime.fromtimestamp(t))</div><div class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-19</span> <span class="number">12</span>:<span class="number">20</span>:<span class="number">00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(datetime.utcfromtimestamp(t))</div><div class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-19</span> <span class="number">04</span>:<span class="number">20</span>:<span class="number">00</span></div></pre></td></tr></table></figure></p>
<p>str转换为datetime，很多时候，用户输入的日期和时间是字符串，要处理日期和时间，首先要把str转换为datetime。转换方法是通过<code>datetime.strptime()</code>实现：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cday=datetime.strptime(<span class="string">'2015-6-1 18:19:59'</span>,<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(cday)</div><div class="line"><span class="number">2015</span><span class="number">-06</span><span class="number">-01</span> <span class="number">18</span>:<span class="number">19</span>:<span class="number">59</span></div></pre></td></tr></table></figure></p>
<p>字符串<code>&#39;%Y-%m-%d %H:%M:%S&#39;</code>规定了日期和时间部分的格式。</p>
<p>datetime转换为str，如果已经有了datetime对象，要把它格式化 为字符串显示给用户，就需要转换为str，转换方法是通过<code>strftime()</code>实现的，同样需要一个日期和时间的格式化字符串：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now=datetime.now()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(now.strftime(<span class="string">'%a,%b %d %H:%M'</span>))</div><div class="line">Tue,Nov <span class="number">01</span> <span class="number">21</span>:<span class="number">26</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(now)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">21</span>:<span class="number">26</span>:<span class="number">20.187960</span></div></pre></td></tr></table></figure></p>
<p>datetime加减，对日期和时间进行加减实际上就是把datetime往后或往前计算，得到新的datetime。加减可以直接用<code>+``-</code>运算符，需要导入<code>timedelta</code>这个类：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timedelta</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now=datetime.now()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">726284</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now+timedelta(hours=<span class="number">10</span>)</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">726284</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now-timedelta(days=<span class="number">2</span>)</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">10</span>, <span class="number">30</span>, <span class="number">21</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">726284</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now+timedelta(days=<span class="number">1</span>,hours=<span class="number">10</span>)</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">29</span>, <span class="number">50</span>, <span class="number">726284</span>)</div></pre></td></tr></table></figure></p>
<p>本地时间转换为UTC时间，一个<code>datetime</code>类型有一个时区属性<code>tzinfo</code>，但是默认为<code>None</code>，所以无法区分这个<code>datetime</code>到底是哪个市区，除非强行给<code>datetime</code>设置一个时区：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime,timedelta,timezone</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>tz_utc_8=timezone(timedelta(hours=<span class="number">8</span>))  <span class="comment">#创建时区UTC+8:00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now=datetime.now()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>now</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">21</span>, <span class="number">35</span>, <span class="number">48</span>, <span class="number">271569</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dt=now.replace(tzinfo=tz_utc_8) <span class="comment">#强制设置为UTC+8:00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dt</div><div class="line">datetime.datetime(<span class="number">2016</span>, <span class="number">11</span>, <span class="number">1</span>, <span class="number">21</span>, <span class="number">35</span>, <span class="number">48</span>, <span class="number">271569</span>, tzinfo=datetime.timezone(datetime.timedelta(<span class="number">0</span>, <span class="number">28800</span>)))</div></pre></td></tr></table></figure></p>
<p>如果系统时区恰好是UTC+8:00,那么上述代码就是正确的，否则，不能强制设置为UTC+8:00时区。</p>
<p>时区转换，我们可以先通过<code>utcnow()</code>拿到当前的UTC时间，再转换为任意时区的时间：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>utc_dt=datetime.utcnow().replace(tzinfo=timezone.utc) <span class="comment">#拿到UTC时间，强制设置时区为UTC+0:00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(utc_dt)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">21.800814</span>+<span class="number">00</span>:<span class="number">00</span>  <span class="comment">#astimezone()将转化时区为北京时间</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>bj_dt=utc_dt.astimezone(timezone(timedelta(hours=<span class="number">8</span>)))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(bj_dt)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">21</span>:<span class="number">39</span>:<span class="number">21.800814</span>+<span class="number">08</span>:<span class="number">00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>tokyo_dt=utc_dt.astimezone(timezone(timedelta(hours=<span class="number">9</span>)))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(tokyo_dt)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">22</span>:<span class="number">39</span>:<span class="number">21.800814</span>+<span class="number">09</span>:<span class="number">00</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>tokyo_dt2=bj_dt.astimezone(timezone(timedelta(hours=<span class="number">9</span>)))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(tokyo_dt2)</div><div class="line"><span class="number">2016</span><span class="number">-11</span><span class="number">-01</span> <span class="number">22</span>:<span class="number">39</span>:<span class="number">21.800814</span>+<span class="number">09</span>:<span class="number">00</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>时区转换的关键在于，拿到一个<code>datetime</code>时，要获知其正确的时区，然后强制设置时区，作为基准时间。利用带时区的<code>datetime</code>，通过<code>astimezone()</code>方法，可以转换到任意时区。</p>
<p>datetime表示时间需要时区信息才能确定一个特定的时间，否则只能视为本地时间。如果要存储datetime，最佳方法是将其转换为timestamp再存储，因为timestamp的值与时区完全无关。</p>
<hr>
<h2 id="collections"><a href="#collections" class="headerlink" title="collections"></a>collections</h2><p>collections是Python内建的一个集合模块，提供了许多有用的集合类。</p>
<h3 id="namedtuple"><a href="#namedtuple" class="headerlink" title="namedtuple"></a>namedtuple</h3><p>我们知道<code>tuple</code>可以表示不变集合，比如，一个点的二维坐标可以表示为：<br>                                    <figure class="highlight plain"><figcaption><span>p</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">但是看到(1,2)，很难看出这个`tuple`是用来表示一个坐标的。定义一个class又没有必要，这时候，`namedtuple`就可以使用了：</div><div class="line"></div><div class="line">```python</div><div class="line">&gt;&gt;&gt; from collections import namedtuple</div><div class="line">&gt;&gt;&gt; Point=namedtuple(&apos;Point&apos;,[&apos;x&apos;,&apos;y&apos;])</div><div class="line">&gt;&gt;&gt; p=Point(1,2)</div><div class="line">&gt;&gt;&gt; p.x</div><div class="line">1</div><div class="line">&gt;&gt;&gt; p.y</div><div class="line">2</div><div class="line">&gt;&gt;&gt; isinstance(p,Point)</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(p,tuple)</div><div class="line">True</div></pre></td></tr></table></figure></p>
<p><code>namedtuple</code>是一个函数，它用来创建一个自定义的<code>tuple</code>对象，并且规定了<code>tuple</code>元素的个数，并可以用属性而不是索引来引用<code>tuple</code>的某个元素。这样我们可以用<code>namedtuple</code>可以很方便的定义一种数据结构，它具备tuple的不变性，又可以根据属性来引用，十分方便。可以验证创建的<code>Point</code>对象是<code>tuple</code>的一种子类。</p>
<p>类似的如果要用坐标和半径定义一个圆：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>Circle=namedtuple(<span class="string">'Circle'</span>,[<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'r'</span>])</div></pre></td></tr></table></figure></p>
<h3 id="deque"><a href="#deque" class="headerlink" title="deque"></a>deque</h3><p>使用list村塾数据时，按索引访问元素很快，但是插入和删除元素就很慢了，因为list是线性存储，数据量大的时候，插入和删除效率很低。deque是为了高效实现插入和删除操作 的双向列表，适合用于队列和栈：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> deque</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>q=deque([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>q.append(<span class="string">'x'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>q.appendleft(<span class="string">'y'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>q</div><div class="line">deque([<span class="string">'y'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'x'</span>])</div></pre></td></tr></table></figure></p>
<p><code>deque</code>除了实现list的<code>append()</code>和<code>pop()</code>外，还支持<code>appendleft()</code>和<code>popleft()</code>这样可以非常高效的往头部添加或删除元素。</p>
<h3 id="defaultdict"><a href="#defaultdict" class="headerlink" title="defaultdict"></a>defaultdict</h3><p>使用<code>dict</code>时，如果引用的key不存在，就会抛出<code>KeyError</code>。如果希望key不存在时，返回一个默认值，就可以用<code>defalultdict</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dd=defaultdict(<span class="keyword">lambda</span>: <span class="string">'N/A'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dd[<span class="string">'key1'</span>]=<span class="string">'abc'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dd[<span class="string">'key1'</span>]</div><div class="line"><span class="string">'abc'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>dd[<span class="string">'key2'</span>]</div><div class="line"><span class="string">'N/A'</span></div></pre></td></tr></table></figure>
<p>注意默认值是返回函数调用的，而函数在创建<code>defaultdict</code>对象时传入。</p>
<h3 id="OrderedDict"><a href="#OrderedDict" class="headerlink" title="OrderedDict"></a>OrderedDict</h3><p>使用dict时，key是无序的。在对dict做迭代时，我们无法确定Key的顺序，如果要保持Key的顺序，可以用<code>OrderedDict</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>d=dict([(<span class="string">'a'</span>,<span class="number">1</span>),(<span class="string">'b'</span>,<span class="number">2</span>),(<span class="string">'c'</span>,<span class="number">3</span>)])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>d</div><div class="line">&#123;<span class="string">'a'</span>: <span class="number">1</span>, <span class="string">'b'</span>: <span class="number">2</span>, <span class="string">'c'</span>: <span class="number">3</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od=OrderedDict([(<span class="string">'a'</span>,<span class="number">1</span>),(<span class="string">'b'</span>,<span class="number">2</span>),(<span class="string">'c'</span>,<span class="number">3</span>)])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od</div><div class="line">OrderedDict([(<span class="string">'a'</span>, <span class="number">1</span>), (<span class="string">'b'</span>, <span class="number">2</span>), (<span class="string">'c'</span>, <span class="number">3</span>)])</div></pre></td></tr></table></figure></p>
<p>注意，<code>OrderedDict</code>的Key会按照插入的顺序排列，不是Key本身排序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>od=OrderedDict()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od[<span class="string">'z'</span>]=<span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od[<span class="string">'y'</span>]=<span class="number">2</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od[<span class="string">'a'</span>]=<span class="number">3</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>od</div><div class="line">OrderedDict([(<span class="string">'z'</span>, <span class="number">1</span>), (<span class="string">'y'</span>, <span class="number">2</span>), (<span class="string">'a'</span>, <span class="number">3</span>)])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>list(od.keys())</div><div class="line">[<span class="string">'z'</span>, <span class="string">'y'</span>, <span class="string">'a'</span>]</div></pre></td></tr></table></figure></p>
<p><code>OrderedDict</code>可以实现一个FIFO的dict，当容量超出限制时，先删除最早添加的Key：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">LastUpdatedOrderedDict</span><span class="params">(OrderedDict)</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,capacity)</span>:</span></div><div class="line"><span class="meta">... </span>            super( LastUpdatedOrderedDict,self).__init__()</div><div class="line"><span class="meta">... </span>            self._capacity=capacity</div><div class="line">...</div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">__setitem__</span><span class="params">(self,key,value)</span>:</span></div><div class="line"><span class="meta">... </span>            containsKey=<span class="number">1</span> <span class="keyword">if</span> key <span class="keyword">in</span> self <span class="keyword">else</span> <span class="number">0</span></div><div class="line"><span class="meta">... </span>            <span class="keyword">if</span> len(self)-constainsKey&gt;=self._capacity:</div><div class="line"><span class="meta">... </span>                    last=self.popoitem(last=<span class="keyword">False</span>)</div><div class="line"><span class="meta">... </span>                    print(<span class="string">'remove:'</span>,last)</div><div class="line"><span class="meta">... </span>            <span class="keyword">if</span> constainsKey:</div><div class="line"><span class="meta">... </span>                    <span class="keyword">del</span> self[key]</div><div class="line"><span class="meta">... </span>                    print(<span class="string">'set:'</span>,(key,value))</div><div class="line"><span class="meta">... </span>            <span class="keyword">else</span>:</div><div class="line"><span class="meta">... </span>                    print(<span class="string">'add:'</span>,(key,value))</div><div class="line"><span class="meta">... </span>            OrderdeDict.__setitem__(self,key,value)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p><code>Counter</code>是一个简单的计数器，例如统计字符出现的个数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c=Counter()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> ch <span class="keyword">in</span> <span class="string">'programming'</span>:</div><div class="line"><span class="meta">... </span>    c[ch]=c[ch]+<span class="number">1</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c</div><div class="line">Counter(&#123;<span class="string">'m'</span>: <span class="number">2</span>, <span class="string">'g'</span>: <span class="number">2</span>, <span class="string">'r'</span>: <span class="number">2</span>, <span class="string">'o'</span>: <span class="number">1</span>, <span class="string">'p'</span>: <span class="number">1</span>, <span class="string">'n'</span>: <span class="number">1</span>, <span class="string">'i'</span>: <span class="number">1</span>, <span class="string">'a'</span>: <span class="number">1</span>&#125;)</div></pre></td></tr></table></figure></p>
<p><code>Counter</code>实际上也是<code>dict</code>的一个子类。</p>
<hr>
<h2 id="base64"><a href="#base64" class="headerlink" title="base64"></a>base64</h2><p>Base64是一种用64个字符来表示任意二进制数据的方法。用记事本打开exe,jpg,pdf这些文件会看到一大堆乱码，因为二进制文件包含了很多无法显示和打印的字符，所以，如果让笔记本这样的文本处理软件能处理二进制数据，就需要一个二进制到字符串的转换方法。Base64是一种最常见的二进制编码方法。</p>
<p>Base64的原理很简单，首先，准备一个包含64个字符的数组：</p>
<blockquote>
<p>[‘A’,’B’,’C’……’a’,’b’,’c’…….’0’,’1’,’2’…..’+’,’/‘]</p>
</blockquote>
<p>然后，对二进制数据进行处理，每三个字节一组，一共是24个bit，划为四组，每组为6bit：<br><img src="/img/1478069277975.png" alt="Alt text"></p>
<p>这样我们得到4个数字作为索引，然后查表，获得相应的4个字符，就是编码后的字符串。</p>
<p>所以，base64编码会把三个字节的二进制数据编码为4字节的文本数据，长度增加33%，好处是编码后的文本数据可以在邮件正文，网页等直接显示。如果要编码的二进制数据不是3的倍数，最后剩下的1个或2个字节可以用\x00字节在末尾补足后，再在编码的末尾加上一个或两个=号，表示补了多少个字节，解码的时候会自动去掉。</p>
<p>Python内置的base64可以直接进行base64的编解码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> base64</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">b'binary\x00string'</span>)</div><div class="line"><span class="string">b'YmluYXJ5AHN0cmluZw=='</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64decode(<span class="string">b'YmluYXJ5AHN0cmluZw=='</span>)</div><div class="line"><span class="string">b'binary\x00string'</span></div></pre></td></tr></table></figure></p>
<p>由于标准的Base64编码后可能出现符号+和/，在URL中就不能直接作为参数，所以又有一种URL safe的base64编码，其实就是把+、/分别变为-和_：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>base64.b64encode(<span class="string">b'i\xb7\x1d\xfb\xef\xff'</span>)</div><div class="line"><span class="string">b'abcd++//'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>base64.urlsafe_b64encode(<span class="string">b'i\xb7\x1d\xfb\xef\xff'</span>)</div><div class="line"><span class="string">b'abcd--__'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>base64.urlsafe_b64decode(<span class="string">'abcd--__'</span>)</div><div class="line"><span class="string">b'i\xb7\x1d\xfb\xef\xff'</span></div></pre></td></tr></table></figure></p>
<p> Base64是一种通过查表的编码方法，不能用于加密，即使使用自定义的编码表也不行。适用于小段内容的编码，比如数字证书签名，Cookie的内容等。</p>
<p>由于=字符也可能出现在Base64编码中，但=用在URL，Cookie里面会造成歧义，很多Base64编码后会把=去掉。</p>
<blockquote>
<p>标准Base64:<br>‘abcd’ -&gt; ‘YWJjZA==’<br>自动去掉=:<br>‘abcd’ -&gt; ‘YWJjZA’</p>
</blockquote>
<p>去掉之后解码时，由于Base64是把3个字节变为4个字节的，所以Base64编码的长度永远是4的倍数，加上=后就可以正常解码了。</p>
<hr>
<h2 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h2><p>Python没有专门处理字节的数据类型，但是由于<code>b&#39;str&#39;</code>可以表示字节，所以，字节数组=二进制str。而在C语言中，我们可以很方便的使用struct、union等来处理字节，以及字节和int、float的转换。</p>
<p>在Python中，比如要把一个32位无符号整数编程字节，也就是四个长度的bytes ，需要配合运算符：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>n=<span class="number">10240099</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b1=(n&amp;<span class="number">0xff000000</span>)&gt;&gt;<span class="number">24</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b2=(n&amp;<span class="number">0xff0000</span>)&gt;&gt;<span class="number">16</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b3=(n&amp;<span class="number">0xff00</span>)&gt;&gt;<span class="number">8</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>b4=n&amp;<span class="number">0xff</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>bs=bytes([b1,b2,b3,b4])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>bs</div><div class="line"><span class="string">b'\x00\x9c@c'</span></div></pre></td></tr></table></figure></p>
<p>很麻烦，如果换成浮点数就无能为力了。Python提供了一个<code>struct</code>模块来解决bytes和其他二进制数据类型的转换。<code>struct</code>的<code>pack</code>函数把任意数据变为<code>bytes</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> struct</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>struct.pack(<span class="string">'&gt;I'</span>,<span class="number">10240099</span>)</div><div class="line"><span class="string">b'\x00\x9c@c'</span></div></pre></td></tr></table></figure></p>
<p><code>pack</code>的第一个参数是处理指令，<code>‘&gt;I’</code>的意思是：<code>&gt;</code>表示字节顺序是big-endian，也就是网络序，<code>I</code>表示4字节无符号整数。后面的参数个数要和处理指令一致。<code>unpack</code>把<code>bytes</code>变成相应的数据类型:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>struct.unpack(<span class="string">'&gt;IH'</span>,<span class="string">b'\xf0\xf0\xf0\xf0\x80\x80'</span>)</div><div class="line">(<span class="number">4042322160</span>, <span class="number">32896</span>)</div></pre></td></tr></table></figure></p>
<p>根据<code>&gt;IH</code>的说明，后面的<code>bytes</code>一次变为<code>I</code>：4字节无符号数和<code>H</code>：2字节无符号整数。所以，尽管Python不适合编写底层操作字节流的代码，但在对性能要求不高的地方，利用struct 很方便。</p>
<h2 id="hashlib"><a href="#hashlib" class="headerlink" title="hashlib"></a>hashlib</h2><p>Python的hashlib提供了常见的摘要算法，如MD5、SHA1等等。</p>
<h3 id="摘要算法"><a href="#摘要算法" class="headerlink" title="摘要算法"></a>摘要算法</h3><p>又称哈希算法、散列算法。它通过一个函数，把任意长度的数据转换为一个长度固定的数据串。摘要算法就是通过摘要函数<code>f()</code>对任意的数据data计算出固定长度的摘要digest，目的是为了发现原始数据是否被人篡改过。摘要算法之所以可以确定数据是否被篡改过是因为摘要函数是一个单向函数，计算<code>f(data)</code>很容易，但是通过digest 反推data很困难。对原始数据做一个bit的修改都会导致计算出的摘要完全不同。</p>
<p>以MD5为例，计算一个字符串的MD5值：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>md5=hashlib.md5()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>md5.update(<span class="string">'how to use md5 in python hashlib?'</span>.encode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(md5.hexdigest())</div><div class="line">d26a53750bc40b38b65a520292f69306</div></pre></td></tr></table></figure></p>
<p>如果数据量很大，可以分块多次调用<code>update()</code>，最后计算的结果是一样的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>md5=hashlib.md5()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>md5.update(<span class="string">'how to use md5 in'</span>.encode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>md5.update(<span class="string">'python hashlib?'</span>.encode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(md5.hexdigest())</div><div class="line"><span class="number">047</span>b2e59ed7530a32db954459f82266b</div></pre></td></tr></table></figure></p>
<p>MD5是最常见的摘要算法，速度很快，上观南城结果是固定的128bit字节，通常用一个32位的16进制字符串表示。</p>
<p>另一种常见的摘要算法是SHA1：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> hashlib</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sha1=hashlib.sha1()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sha1.update(<span class="string">'how to use sha1 in '</span>.encode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>sha1.update(<span class="string">'python hashlib?'</span>.encode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(sha1.hexdigest())</div><div class="line"><span class="number">2</span>c76b57293ce30acef38d98f6046927161b46a44</div></pre></td></tr></table></figure></p>
<p>SHA1的结果是160bit字节，通常用一个40位的16进制字符来表示。比SHA1更安全的算法是SHA256和SHA512，越安全的算法越慢，摘要长度也会更长。</p>
<h3 id="摘要算法应用"><a href="#摘要算法应用" class="headerlink" title="摘要算法应用"></a>摘要算法应用</h3><p>任何允许用户登录的网站都会存储用户登录的用户名和口令，存储的方法是存储到数据库表中：</p>
<table>
<thead>
<tr>
<th style="text-align:left">name</th>
<th style="text-align:right">passwd</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Michael</td>
<td style="text-align:right">123456</td>
</tr>
<tr>
<td style="text-align:left">bob</td>
<td style="text-align:right">asd121</td>
</tr>
<tr>
<td style="text-align:left">alice</td>
<td style="text-align:right">alice123456</td>
</tr>
</tbody>
</table>
<p>如果以明文保存用户口令，如果数据库泄露，所有用户的口令都泄露。而且网站运维人员是可以访问数据库的，也就是能获取到所有用户的口令。正确保存口令的方式是不存储用户的明文口令，而是存储用户口令的摘要，比如MD5：<br>| name      |  passwd |<br>| :——– | ——–:|<br>| Michael   |   e10adc3949ba59abbe56e057f20f883e |<br>|bob        |   878ef96e86145580c38c87f0410ad153 |<br>|alice      |  99b1c2188db85afee403b1536010c2c9|</p>
<p>当用户登录时，首先计算机用户输入的明文口令的MD5，然后和数据库的MD5对比，结果一致说明口令输入正确，如果不一致则口令错误。</p>
<hr>
<h2 id="itertools"><a href="#itertools" class="headerlink" title="itertools"></a>itertools</h2><p>Python的内建模块<code>itertools</code>提供了非常有用的用于操作迭代对象的函数。首先来看<code>itertools</code>提供的几个无限迭代器：</p>
<p><code>cycle()</code>会把传入的一个序列无限重复下去。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cs = itertools.cycle(<span class="string">'ABC'</span>) <span class="comment"># 注意字符串也是序列的一种</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> cs:</div><div class="line"><span class="meta">... </span>    print(c)</div><div class="line">...</div><div class="line"><span class="string">'A'</span></div><div class="line"><span class="string">'B'</span></div><div class="line"><span class="string">'C'</span></div><div class="line"><span class="string">'A'</span></div><div class="line"><span class="string">'B'</span></div><div class="line"><span class="string">'C'</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p><code>repeat()</code>负责把一个元素无限重复下去，不过提供第二个参数就可以限定重复次数：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> itertools</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ns=itertools.repeat(<span class="string">'a'</span>,<span class="number">4</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> n <span class="keyword">in</span> ns:</div><div class="line">	print(n)</div><div class="line"></div><div class="line"></div><div class="line">a</div><div class="line">a</div><div class="line">a</div><div class="line">a</div></pre></td></tr></table></figure></p>
<p>无限序列只有在<code>for</code>迭代时才会无限地迭代下去，如果只是创建了一个迭代对象，它不会事先把无限个元素生成出来，事实上也不可能在内存中创建无限多个元素。无限序列虽然可以无限迭代下去，但是通常我们会通过<code>takewhile()</code>等函数根据条件判断来截取出一个有限的序列：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>naturals=itertools.count(<span class="number">1</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>ns=itertools.takewhile(<span class="keyword">lambda</span> x:x&lt;=<span class="number">10</span>,naturals)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>list(ns)</div><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</div></pre></td></tr></table></figure></p>
<p><code>itertools</code>提供的几个迭代器操作函数更加有用：</p>
<h3 id="chain"><a href="#chain" class="headerlink" title="chain()"></a>chain()</h3><p><code>chain()</code>可以把一组迭代对象串联起来，形成一个更大的迭代器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> c <span class="keyword">in</span> itertools.chain(<span class="string">'abc'</span>,<span class="string">'1234'</span>):</div><div class="line">	print(c)</div><div class="line"></div><div class="line"></div><div class="line">a</div><div class="line">b</div><div class="line">c</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div></pre></td></tr></table></figure></p>
<h3 id="groupby"><a href="#groupby" class="headerlink" title="groupby()"></a>groupby()</h3><p><code>groupby()</code>把迭代器中相邻的重复元素挑出来放在一起：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key,group <span class="keyword">in</span> itertools.groupby(<span class="string">'aaabbbccaaadd'</span>):</div><div class="line">	print(key,list(group))</div><div class="line"></div><div class="line"></div><div class="line">a [<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>]</div><div class="line">b [<span class="string">'b'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>]</div><div class="line">c [<span class="string">'c'</span>, <span class="string">'c'</span>]</div><div class="line">a [<span class="string">'a'</span>, <span class="string">'a'</span>, <span class="string">'a'</span>]</div><div class="line">d [<span class="string">'d'</span>, <span class="string">'d'</span>]</div></pre></td></tr></table></figure></p>
<p>实际上挑选规则是通过函数完成的，只要作用于函数的两个元素返回的值相等，这两个元素就被认为是在一组的，而函数返回值作为组的key。如果我们要忽略大小写分组，可以让元素Aa都返回相同的key:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key,group <span class="keyword">in</span> itertools.groupby(<span class="string">'AAaBbbcCCDcd'</span>,<span class="keyword">lambda</span> c:c.upper()):</div><div class="line">	print(key,list(group))</div><div class="line"></div><div class="line"></div><div class="line">A [<span class="string">'A'</span>, <span class="string">'A'</span>, <span class="string">'a'</span>]</div><div class="line">B [<span class="string">'B'</span>, <span class="string">'b'</span>, <span class="string">'b'</span>]</div><div class="line">C [<span class="string">'c'</span>, <span class="string">'C'</span>, <span class="string">'C'</span>]</div><div class="line">D [<span class="string">'D'</span>]</div><div class="line">C [<span class="string">'c'</span>]</div><div class="line">D [<span class="string">'d'</span>]</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h2><h3 id="DOM-vs-SAX"><a href="#DOM-vs-SAX" class="headerlink" title="DOM vs SAX"></a>DOM vs SAX</h3><p>操作XMl有两种方法：DOM和SAX，DOM会把整个XML读入内存，解析为树，因此占用内存大，解析慢，优点是可以任意遍历树的节点。SAX是流模式，边读边解析，占用内存小，缺点是我们需要自己处理事件。正常情况下优先考虑SAX。在Python中我们关心的事件是<code>start_element</code>,<code>end_element</code>,<code>char_data</code>准备好这三个函数就可以解析xml了。如当SAX解析器读到一个节点时：</p>
<blockquote>
<p><a href="/">python</a></p>
</blockquote>
<p>会产生三个事件：</p>
<blockquote>
<p>1.start_element事件，在读取<a href="/">时；<br>2.char_data事件，在读取python时<br>3.end_element事件，在读取</a></p>
</blockquote>
<p>代码验证如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> xml.parsers.expat <span class="keyword">import</span> ParserCreate</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DefaultSaxHandler</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start_element</span><span class="params">(self, name, attrs)</span>:</span></div><div class="line">        print(<span class="string">'sax:start_element: %s, attrs: %s'</span> % (name, str(attrs)))</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">end_element</span><span class="params">(self, name)</span>:</span></div><div class="line">        print(<span class="string">'sax:end_element: %s'</span> % name)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">char_data</span><span class="params">(self, text)</span>:</span></div><div class="line">        print(<span class="string">'sax:char_data: %s'</span> % text)</div><div class="line"></div><div class="line">xml = <span class="string">r'''&lt;?xml version="1.0"?&gt;</span></div><div class="line"><span class="string">&lt;ol&gt;</span></div><div class="line"><span class="string">    &lt;li&gt;&lt;a href="/python"&gt;Python&lt;/a&gt;&lt;/li&gt;</span></div><div class="line"><span class="string">    &lt;li&gt;&lt;a href="/ruby"&gt;Ruby&lt;/a&gt;&lt;/li&gt;</span></div><div class="line"><span class="string">&lt;/ol&gt;</span></div><div class="line"><span class="string">'''</span></div><div class="line"></div><div class="line">handler = DefaultSaxHandler()</div><div class="line">parser = ParserCreate()</div><div class="line">parser.StartElementHandler = handler.start_element</div><div class="line">parser.EndElementHandler = handler.end_element</div><div class="line">parser.CharacterDataHandler = handler.char_data</div><div class="line">parser.Parse(xml)</div></pre></td></tr></table></figure></p>
<p>需要注意的是读取一大段字符串时，CharacterDataHandler可能被多次调用，所以需要自己保存起来，在EndElementHandler里面合并。</p>
<hr>
<h2 id="HTMLParser"><a href="#HTMLParser" class="headerlink" title="HTMLParser"></a>HTMLParser</h2><p>编写一个搜索引擎，第一步是用爬虫把目标网站的页面抓下来，第二步就是解析该HTML页面，看看里面的内容到底是新闻、图片还是视频。</p>
<p>HTML本质上是XML的子集，但是HTML的语法没有XML那么严格，所以不能用标准的DOM或者SAX来解析HTML。可以用HTMLParser来解析HTML：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> html.parser <span class="keyword">import</span> HTMLParser</div><div class="line"><span class="keyword">from</span> html.entities <span class="keyword">import</span> name2codepoint</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHTMLParser</span><span class="params">(HTMLParser)</span>:</span></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_starttag</span><span class="params">(self,tag,attrs)</span>:</span></div><div class="line">		print(<span class="string">'&lt;/%s&gt;'</span> %tag)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_endtag</span><span class="params">(self,tag)</span>:</span></div><div class="line">		print(<span class="string">'&lt;/%s&gt;'</span> %tag)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_startendtag</span><span class="params">(self ,tag,attrs)</span>:</span></div><div class="line">		print(<span class="string">'&lt;/%s&gt;'</span> %tag)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_data</span><span class="params">(self,data)</span>:</span></div><div class="line">		print(data)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_comment</span><span class="params">(self,data)</span>:</span></div><div class="line">		print(<span class="string">'&lt;!--'</span>,data ,<span class="string">'--&gt;'</span>)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_entityref</span><span class="params">(self,name)</span>:</span></div><div class="line">		print(<span class="string">'&amp;%s:'</span> %name)</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">handle_charref</span><span class="params">(self,name)</span>:</span></div><div class="line">		print(<span class="string">'&amp;#%s:'</span> %name)</div><div class="line"></div><div class="line">parser=MyHTMLParser()</div><div class="line">parser.feed(<span class="string">'''&lt;html&gt;</span></div><div class="line"><span class="string">&lt;head&gt;&lt;/head&gt;</span></div><div class="line"><span class="string">&lt;body&gt;</span></div><div class="line"><span class="string">&lt;!-- test html parser--&gt;</span></div><div class="line"><span class="string">	&lt;p&gt;Some&lt;a href=\"#\"&gt;html&lt;/a&gt; HTML&amp;nbsp;tutorial...&lt;br&gt;END&lt;/p&gt;</span></div><div class="line"><span class="string">&lt;/body&gt;&lt;/html&gt;'''</span>)</div></pre></td></tr></table></figure></p>
<p><code>feed()</code>方法可以多次调用，也就是不一定一次把整个HTML字符串都塞进去，可以一部分一部分塞进去。特殊字符有两种，一种是用英文表示的<code>&amp;nbsp</code>，一种是用数字表示的<code>&amp;#1234;</code>，这两种字符都可以通过Parser解析出来。</p>
<hr>
<h2 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h2><p>urllib提供了一系列用于操作URL的功能。</p>
<h3 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h3><p>urllib的<code>request</code>模块可以非常方便地抓取URL内容，也就是发送一个GET请求到指定的页面，然后返回HTTP的相应：</p>
<p>例如，对豆瓣的一个URL<code>https://api.douban.com/v2/book/2129650</code>进行抓取并返回相应：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib <span class="keyword">import</span> request</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> request.urlopen(<span class="string">'https://api.douban.com/v2/book/2129650'</span>) <span class="keyword">as</span> f:</div><div class="line"><span class="meta">... </span>    dada=f.read()</div><div class="line"><span class="meta">... </span>    print(<span class="string">'Status:'</span>,f.status,f.reason)</div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> k,v <span class="keyword">in</span> f.getheaders():</div><div class="line"><span class="meta">... </span>            print(<span class="string">'%s:%s'</span> %(k,v))</div><div class="line"><span class="meta">... </span>    print(<span class="string">'Data:'</span>,data.decode(<span class="string">'utf-8'</span>))</div><div class="line">...</div><div class="line">Status: <span class="number">200</span> OK</div><div class="line">Date:Sun, <span class="number">06</span> Nov <span class="number">2016</span> <span class="number">08</span>:<span class="number">44</span>:<span class="number">01</span> GMT</div><div class="line">Content-Type:application/json; charset=utf<span class="number">-8</span></div><div class="line">Content-Length:<span class="number">2055</span></div><div class="line">Connection:close</div><div class="line">Vary:Accept-Encoding</div><div class="line">X-Ratelimit-Remaining2:<span class="number">96</span></div><div class="line">X-Ratelimit-Limit2:<span class="number">100</span></div><div class="line">Expires:Sun, <span class="number">1</span> Jan <span class="number">2006</span> <span class="number">01</span>:<span class="number">00</span>:<span class="number">00</span> GMT</div><div class="line">Pragma:no-cache</div><div class="line">Cache-Control:must-revalidate, no-cache, private</div><div class="line">Set-Cookie:bid=L9LbgN0KHkE; Expires=Mon, <span class="number">06</span>-Nov<span class="number">-17</span> <span class="number">08</span>:<span class="number">44</span>:<span class="number">01</span> GMT; Domain=.douban.com; Path=/</div><div class="line">X-DOUBAN-NEWBID:L9LbgN0KHkE</div><div class="line">X-DAE-Node:dis16</div><div class="line">X-DAE-App:book</div><div class="line">Server:dae</div><div class="line">Data: &#123;<span class="string">"rating"</span>:&#123;<span class="string">"max"</span>:<span class="number">10</span>,<span class="string">"numRaters"</span>:<span class="number">16</span>,<span class="string">"average"</span>:<span class="string">"7.4"</span>,<span class="string">"min"</span>:<span class="number">0</span>&#125;,<span class="string">"subtitle"</span>:<span class="string">""</span>,<span class="string">"author"</span>:[<span class="string">"廖雪峰编著"</span>],<span class="string">"pubdate"</span>:<span class="string">"2007-6"</span>,<span class="string">"tags"</span>:[&#123;<span class="string">"count"</span>:<span class="number">20</span>,<span class="string">"name"</span>:<span class="string">"spring"</span>,<span class="string">"title"</span>:<span class="string">"spring"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">11</span>,<span class="string">"name"</span>:<span class="string">"Java"</span>,<span class="string">"title"</span>:<span class="string">"Java"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">6</span>,<span class="string">"name"</span>:<span class="string">"javaee"</span>,<span class="string">"title"</span>:<span class="string">"javaee"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">4</span>,<span class="string">"name"</span>:<span class="string">"j2ee"</span>,<span class="string">"title"</span>:<span class="string">"j2ee"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">3</span>,<span class="string">"name"</span>:<span class="string">"POJO"</span>,<span class="string">"title"</span>:<span class="string">"POJO"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">3</span>,<span class="string">"name"</span>:<span class="string">"计算机"</span>,<span class="string">"title"</span>:<span class="string">"计算机"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">3</span>,<span class="string">"name"</span>:<span class="string">"藏书"</span>,<span class="string">"title"</span>:<span class="string">"藏书"</span>&#125;,&#123;<span class="string">"count"</span>:<span class="number">3</span>,<span class="string">"name"</span>:<span class="string">"编程"</span>,<span class="string">"title"</span>:<span class="string">"编程"</span>&#125;],<span class="string">"origin_title"</span>:<span class="string">""</span>,<span class="string">"image"</span>:<span class="string">"https://img3.doubanio.com\/mpic\/s2648230.jpg"</span>,<span class="string">"binding"</span>:<span class="string">""</span>,<span class="string">"translator"</span>:[],<span class="string">"catalog"</span>:<span class="string">""</span>,<span class="string">"pages"</span>:<span class="string">"509"</span>,<span class="string">"images"</span>:&#123;<span class="string">"small"</span>:<span class="string">"https://img3.doubanio.com\/spic\/s2648230.jpg"</span>,<span class="string">"large"</span>:<span class="string">"https://img3.doubanio.com\/lpic\/s2648230.jpg"</span>,<span class="string">"medium"</span>:<span class="string">"https://img3.doubanio.com\/mpic\/s2648230.jpg"</span>&#125;,<span class="string">"alt"</span>:<span class="string">"https:\/\/book.douban.com\/subject\/2129650\/"</span>,<span class="string">"id"</span>:<span class="string">"2129650"</span>,<span class="string">"publisher"</span>:<span class="string">"电子工业"</span>,<span class="string">"isbn10"</span>:<span class="string">"7121042622"</span>,<span class="string">"isbn13"</span>:<span class="string">"9787121042621"</span>,<span class="string">"title"</span>:<span class="string">"Spring 2.0核心技术与最佳实践"</span>,<span class="string">"url"</span>:<span class="string">"https:\/\/api.douban.com\/v2\/book\/2129650"</span>,<span class="string">"alt_title"</span>:<span class="string">""</span>,<span class="string">"author_intro"</span>:<span class="string">""</span>,<span class="string">"summary"</span>:<span class="string">"本书注重实践而又深入 理论，由浅入深且详细介绍了Spring 2.0框架的几乎全部的内容，并重点突出2.0版本的新特性。本书将为读者展示如何应用Spring 2.0框架创建灵活高效的JavaEE应用，并提供了一个真正 可直接部署的完整的Web应用程序——Live在线书店(http:\/\/www.livebookstore.net)。\n在介绍Spring框架的同时，本书还介绍了与Spring相关的大量第三方框架，涉及领域全面，实用 性强。本书另一大特色是实用性强，易于上手，以实际项目为出发点，介绍项目开发中应遵循 的最佳开发模式。\n本书还介绍了大量实践性极强的例子，并给出了完整的配置步骤，几乎覆 盖了Spring 2.0版本的新特性。\n本书适合有一定Java基础的读者，对JavaEE开发人员特别有 帮助。本书既可以作为Spring 2.0的学习指南，也可以作为实际项目开发的参考手册。"</span>,<span class="string">"price"</span>:<span class="string">"59.80元"</span>&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到HTTP相应的头和JSON数据，如果我们要模拟浏览器发送GET请求，就需要使用Request对象，通过往Request对象添加HTTP头，我们就可以把请求伪装成浏览器。例如，模拟iPhone6区请求豆瓣首页：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib <span class="keyword">import</span> request</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>req=request.Request(<span class="string">'http://www.douban.com/'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">with</span> request.urlopen(req) <span class="keyword">as</span> f:</div><div class="line"><span class="meta">... </span>    print(<span class="string">'Status:'</span>,f.status, f.reason)</div><div class="line"><span class="meta">... </span>    <span class="keyword">for</span> k,v <span class="keyword">in</span> f.getheaders():</div><div class="line"><span class="meta">... </span>            print(<span class="string">'%s:%s'</span> %(k,v))</div><div class="line"><span class="meta">... </span>    print(<span class="string">'Data:'</span>,f.read().decode(<span class="string">'utf-8'</span>))</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>这样豆瓣就会返回适合iPhone的移动版网页。</p>
<h3 id="Post"><a href="#Post" class="headerlink" title="Post"></a>Post</h3><p>如果要以POST发送一个请求，只需要把参数data以bytes形式传入。</p>
<p>我们模拟一个微博登录，先读取登录的邮箱和口令，然后按照weibo.cn的登录页的格式以<code>username=xxx&amp;password=xxx</code>的编码传入：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request, parse</div><div class="line"></div><div class="line">print(<span class="string">'Login to weibo.cn...'</span>)</div><div class="line">email = input(<span class="string">'Email: '</span>)</div><div class="line">passwd = input(<span class="string">'Password: '</span>)</div><div class="line">login_data = parse.urlencode([</div><div class="line">    (<span class="string">'username'</span>, email),</div><div class="line">    (<span class="string">'password'</span>, passwd),</div><div class="line">    (<span class="string">'entry'</span>, <span class="string">'mweibo'</span>),</div><div class="line">    (<span class="string">'client_id'</span>, <span class="string">''</span>),</div><div class="line">    (<span class="string">'savestate'</span>, <span class="string">'1'</span>),</div><div class="line">    (<span class="string">'ec'</span>, <span class="string">''</span>),</div><div class="line">    (<span class="string">'pagerefer'</span>, <span class="string">'https://passport.weibo.cn/signin/welcome?entry=mweibo&amp;r=http%3A%2F%2Fm.weibo.cn%2F'</span>)</div><div class="line">])</div><div class="line"></div><div class="line">req = request.Request(<span class="string">'https://passport.weibo.cn/sso/login'</span>)</div><div class="line">req.add_header(<span class="string">'Origin'</span>, <span class="string">'https://passport.weibo.cn'</span>)</div><div class="line">req.add_header(<span class="string">'User-Agent'</span>, <span class="string">'Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25'</span>)</div><div class="line">req.add_header(<span class="string">'Referer'</span>, <span class="string">'https://passport.weibo.cn/signin/login?entry=mweibo&amp;res=wel&amp;wm=3349&amp;r=http%3A%2F%2Fm.weibo.cn%2F'</span>)</div><div class="line"></div><div class="line"><span class="keyword">with</span> request.urlopen(req, data=login_data.encode(<span class="string">'utf-8'</span>)) <span class="keyword">as</span> f:</div><div class="line">    print(<span class="string">'Status:'</span>, f.status, f.reason)</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> f.getheaders():</div><div class="line">        print(<span class="string">'%s: %s'</span> % (k, v))</div><div class="line">    print(<span class="string">'Data:'</span>, f.read().decode(<span class="string">'utf-8'</span>))</div></pre></td></tr></table></figure></p>
<h3 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h3><p>如果还需要更复杂的控制，比如通过一个Proxy去访问网站，我们需要利用ProxyHandler来处理，实例如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">proxy_handler = urllib.request.ProxyHandler(&#123;<span class="string">'http'</span>: <span class="string">'http://www.example.com:3128/'</span>&#125;)</div><div class="line">proxy_auth_handler = urllib.request.ProxyBasicAuthHandler()</div><div class="line">proxy_auth_handler.add_password(<span class="string">'realm'</span>, <span class="string">'host'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>)</div><div class="line">opener = urllib.request.build_opener(proxy_handler, proxy_auth_handler)</div><div class="line"><span class="keyword">with</span> opener.open(<span class="string">'http://www.example.com/login.html'</span>) <span class="keyword">as</span> f:</div><div class="line">    <span class="keyword">pass</span></div></pre></td></tr></table></figure></p>
<p>urllib提供的功能就是利用程序去执行各种HTTP请求。如果要模拟浏览器完成特定功能，需要把请求伪装成浏览器。伪装的方法是先监控浏览器发出的请求，再根据浏览器的请求头来伪装，<code>User-Agent</code>头就是用来标示浏览器的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/10.正则表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/10.正则表达式/" itemprop="url">10. 正则表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:13+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h1><p>字符串是编程时涉及到最多的一种数据结构，对于字符串进行操作的需求几乎无处不在。比如判断一个字符串是否是合法的Email地址，虽然可以编程提取@前后的子串，再分别判断是否是单词和域名，但这样做不但麻烦，而且代码难以复用。</p>
<p>正则表达式是一种用来匹配字符串的强有力的武器。它设计的思想是用一种描述性的语言来给字符串定义了一个规则，凡是符合规则 对字符串，我们就认为它匹配了，否则，该字符串就是不合法的。</p>
<p>所以我们判断一个字符串是否是合法的Email的方法是：<br>1、创建一个匹配Email的正则表达式<br>2、用该正则表达式去匹配用户的输入来判断是否合法。</p>
<p>因为正则表达式也是用字符串表示的，首先需要了解如何用字符来描述字符。</p>
<p>在正则表达式中，如果直接给出字符，就是精确匹配。用<code>\d</code>可以匹配一个数字，<code>\w</code>可以匹配一个字母或数字，所以：</p>
<blockquote>
<p><code>00\d</code>可以匹配<code>007</code>，但是无法匹配<code>00A</code><br><code>\d\d\d</code>可以匹配<code>010</code><br><code>\w\w\d</code>可以匹配<code>py3</code><br><code>.</code>可以匹配任意字符，<code>py.</code>可以匹配<code>pyc``py0``py!</code>等。</p>
</blockquote>
<p>要匹配变长的字符，在正则表达式中，用<code>*</code>表示任意个字符，用<code>+</code>表示至少一个字符，用<code>?</code>表示0个或1个字符，用<code>{n}</code>表示n个字符，用<code>{n,m}</code>表示n-m个字符：</p>
<p><code>\d{3}\s+\d{3,8}</code><br>1、<code>\d{3}</code>表示匹配三个数字<br>2、<code>\s</code>表示可以匹配一个空格（包括Tab等空白符），<code>\s+</code>表示至少有一个空白符，<br>3、<code>\d{3.8}</code>表示3-8个数字。<br>综合起来，上面的正则表达式可以匹配任意个空格隔开的带区号的电话号码。如果要匹配<code>010-12345</code>这样的号码时，由于<code>-</code>是特殊字符，在正则表达式中要用<code>\</code>转义，所以上面的正则为：<code>\d{3}\-\d{3,8}</code>，但是仍然无法匹配<code>010 - 12345</code>这样的电话号码。</p>
<h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><p>要做更精确的匹配，可以用<code>[]</code>表示范围：</p>
<blockquote>
<p><code>[0-9a-zA-Z\_]</code>可以匹配一个数字、字母或者下划线<br><code>[0-9a-zA-Z\_]+</code>可以匹配至少由一个数字、字母或者下划线组成的祖字符串，比如<code>a100</code>，<code>0_z</code>，<code>Py300</code>等<br><code>[a-zA-z\_][0-9a-zA-Z\_]*</code>可以匹配由字母或下划线开头，后接任意个由一个数字、字母或者下划线组成的字符串。<br><code>[a-zA-z\_][0-9a-zA-Z\_]{0,19}</code>更精确地限制了变量的长度是1-20个字符</p>
</blockquote>
<p><code>A|B</code>可以匹配A或B，所以<code>(P|p)ython</code>可以匹配<code>python</code>或者<code>Python</code>。</p>
<p><code>^</code>表示行的开头，<code>^\d</code>表示必须以数字开头。</p>
<p><code>$</code>表示行的结束，<code>\d$</code>表示必须以数字结束。</p>
<h2 id="re模块"><a href="#re模块" class="headerlink" title="re模块"></a>re模块</h2><p>Python提供<code>re</code>模块，包含所有正则表达式的功能。又有Python的字符串本身也用<code>\</code>转义，要特别注意：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>s=<span class="string">'ABC\\-001'</span></div><div class="line"><span class="comment">#python的字符串，对应的正则表达式'ABC\-001'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s=<span class="string">r'ABC\-001'</span></div><div class="line"><span class="comment">#加r就不再考虑转义的问题</span></div></pre></td></tr></table></figure></p>
<p>如何判断正则表达式是否匹配：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">r'^\d&#123;3&#125;\-\d&#123;3,8&#125;$'</span>, <span class="string">'010-12345'</span>)</div><div class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'010-12345'</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">r'^\d&#123;3&#125;\-\d&#123;3,8&#125;$'</span>, <span class="string">'010 12345'</span>)</div></pre></td></tr></table></figure></p>
<p><code>match()</code>方法判断是否匹配，如果匹配成功，返回一个Match对象，否则返回None。常见的判断方法是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">test=<span class="string">'用户输入的字符串'</span></div><div class="line"><span class="keyword">if</span> re.match(<span class="string">r'正则表达式'</span>,est):</div><div class="line">	print(<span class="string">'ok'</span>)</div><div class="line"><span class="keyword">else</span>:</div><div class="line">	print(<span class="string">'failed'</span>)</div></pre></td></tr></table></figure></p>
<h2 id="切分字符串"><a href="#切分字符串" class="headerlink" title="切分字符串"></a>切分字符串</h2><p>用正则表达式切分字符串比用固定的字符更灵活，正常的切分代码为：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">'a b    c'</span>.split()</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div></pre></td></tr></table></figure></p>
<p>无法识别连续的空格，用正则表达式：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'\s+'</span>,<span class="string">'a b   c'</span>)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</div></pre></td></tr></table></figure></p>
<p>无论多少个空格都可以正常分割。加入<code>,</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'[\s\.]+'</span>,<span class="string">'a, b, c d'</span>)</div><div class="line">[<span class="string">'a,'</span>, <span class="string">'b,'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div></pre></td></tr></table></figure></p>
<p>加入<code>;</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.split(<span class="string">r'[\s\.\;]+'</span>,<span class="string">'a,b;; c d'</span>)</div><div class="line">[<span class="string">'a,b'</span>, <span class="string">'c'</span>, <span class="string">'d'</span>]</div></pre></td></tr></table></figure></p>
<h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><p>除了简单地判断是否匹配之外，正则表达式还有提取子串的强大功能。用<code>()</code>表示的就是要提取的分组。比如：</p>
<p><code>^(\d{3}-(\d{3,8}))$</code>分别定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>m=re.match(<span class="string">r'^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$'</span>, <span class="string">'010-12345'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m</div><div class="line">&lt;_sre.SRE_Match object; span=(<span class="number">0</span>, <span class="number">9</span>), match=<span class="string">'010-12345'</span>&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>)</div><div class="line"><span class="string">'010-12345'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>)</div><div class="line"><span class="string">'010'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)</div><div class="line"><span class="string">'12345'</span></div></pre></td></tr></table></figure></p>
<p>如果正则表达式中定义了组，就可以在<code>Match</code>对象上用<code>group()</code>方法提取出子串来。</p>
<p><code>group(0)</code>永远是原始字符串，<code>group(1)</code>、<code>group(2)</code>……表示第一个、第二个子串。</p>
<p>提取子串很有用：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>t=<span class="string">'19:13:12'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m = re.match(<span class="string">r'^(0[0-9]|1[0-9]|2[0-3]|[0-9])\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])\:(0[0-9]|1[0-9]|2[0-9]|3[0-9]|4[0-9]|5[0-9]|[0-9])$'</span>, t)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>m.groups()</div><div class="line">(<span class="string">'19'</span>, <span class="string">'13'</span>, <span class="string">'12'</span>)</div></pre></td></tr></table></figure></p>
<p>这个正则表达式可以直接识别合法的时间。但是有些时候，用正则表达式也无法做到完全验证，比如识别日期：</p>
<blockquote>
<p>‘^(0[1-9]|1[0-2]|[0-9])-(0[0-9]|1[0-9]|2[0-9]|3[0-1]|[0-9])$’</p>
</blockquote>
<p>对于<code>2-30</code>，<code>4-31</code>这样的非法日期，用正则还是识别不了。</p>
<h2 id="贪婪匹配"><a href="#贪婪匹配" class="headerlink" title="贪婪匹配"></a>贪婪匹配</h2><p>正则匹配默认是贪婪匹配，也就是匹配尽可能多的字符。如匹配出数字后面的0：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">r'^(\d+)(0*)$'</span>,<span class="string">'102300'</span>).groups()</div><div class="line">(<span class="string">'102300'</span>, <span class="string">''</span>)</div></pre></td></tr></table></figure></p>
<p>由于<code>\d+</code>采用贪婪匹配，直接把后面的0全匹配了，结果<code>0*</code>只能匹配空字符串了。</p>
<p>必须让<code>\d+</code>采用非贪婪匹配，才能把后面的0匹配出来，加个<code>？</code>就可以了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>re.match(<span class="string">r'^(\d+?)(0*)$'</span>,<span class="string">'102300'</span>).groups()</div><div class="line">(<span class="string">'1023'</span>, <span class="string">'00'</span>)</div></pre></td></tr></table></figure></p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>当我们在Python中使用正则表达式时，re模块会做两件事情：</p>
<blockquote>
<p>1、编译正则表达式，如果正则表达式的字符串本身不合法会报错。<br>2、用编译后的正则表达式去匹配字符串</p>
</blockquote>
<p>如果一个正则表达式要重复机器那次，出于效率的考虑，我们可以预编译该正则表达式，接下来重复使用时就不需要编译这个步骤了，直接匹配：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> re</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re_telephone=re.compile(<span class="string">r'^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re_telephone.match(<span class="string">'010-12345'</span>).groups()</div><div class="line">(<span class="string">'010'</span>, <span class="string">'12345'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>re_telephone.match(<span class="string">'010-8989'</span>).groups()</div><div class="line">(<span class="string">'010'</span>, <span class="string">'8989'</span>)</div></pre></td></tr></table></figure></p>
<p>编译后生成Regular Expression对象，由于该对象自己包含了正则表达式，所以调用对应的方法时不用给出正则字符串。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
