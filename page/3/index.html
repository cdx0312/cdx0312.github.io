<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/2.高级特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/2.高级特性/" itemprop="url">2.高级特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T15:29:57+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h1><p>掌握了Python的数据类型，语句和函数，基本上就可以编出很多有用的程序了，比如构造一个<code>1,3,5,...,99</code>的列表，可以通过循环实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L=[]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>n=<span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">while</span> n&lt;=<span class="number">99</span>:</div><div class="line"><span class="meta">... </span>    L.append(n)</div><div class="line"><span class="meta">... </span>    n=n+<span class="number">2</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(L)</div><div class="line">[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">17</span>, <span class="number">19</span>, <span class="number">21</span>, <span class="number">23</span>, <span class="number">25</span>, <span class="number">27</span>, <span class="number">29</span>, <span class="number">31</span>, <span class="number">33</span>, <span class="number">35</span>, <span class="number">37</span>, <span class="number">39</span>, <span class="number">41</span>, <span class="number">43</span>, <span class="number">45</span>, <span class="number">47</span>, <span class="number">49</span>, <span class="number">51</span>, <span class="number">53</span>, <span class="number">55</span>, <span class="number">57</span>, <span class="number">59</span>, <span class="number">61</span>, <span class="number">63</span>, <span class="number">65</span>, <span class="number">67</span>, <span class="number">69</span>, <span class="number">71</span>, <span class="number">73</span>, <span class="number">75</span>, <span class="number">77</span>, <span class="number">79</span>, <span class="number">81</span>, <span class="number">83</span>, <span class="number">85</span>, <span class="number">87</span>, <span class="number">89</span>, <span class="number">91</span>, <span class="number">93</span>, <span class="number">95</span>, <span class="number">97</span>, <span class="number">99</span>]</div></pre></td></tr></table></figure>
<p>取list的前一半元素，也可以通过循环实现。</p>
<p>但是Python中，代码不是越多越好，而是越少越好。代码不是越复杂越好，而是越简单越好。</p>
<p>基于这一思想，我们开始介绍Python中非常有用的高级特性，1行代码能实现的功能，绝对不用五行代码。</p>
<hr>
<p>[TOC]</p>
<hr>
<h2 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h2><p>取一个list或者tuple的部分元素是非常常见的操作，比如，一个list如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">L=[<span class="string">'Michael'</span>,<span class="string">'Sarah'</span>,<span class="string">'Tracy'</span>,<span class="string">'Bob'</span>,<span class="string">'Jack'</span>]</div></pre></td></tr></table></figure>
<p>取前三个元素，应该怎么办？</p>
<p>笨方法：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> Q=[L[<span class="number">0</span>],L[<span class="number">1</span>],L[<span class="number">2</span>]]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(Q)</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div></pre></td></tr></table></figure></p>
<p>该方法如果扩展之后让去N个元素就没有办法了。取N个元素，也就是取序号为0-N-1的元素，可以用循环：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>r=[]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>n=<span class="number">3</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>i=<span class="number">0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">while</span> i&lt;n:</div><div class="line"><span class="meta">... </span>    r.append(L[i])</div><div class="line"><span class="meta">... </span>    i=i+<span class="number">1</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>print(r)</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<p> 或者：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>r=[]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>n=<span class="number">3</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</div><div class="line"><span class="meta">... </span>    r.append(L[i])</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>r</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div></pre></td></tr></table></figure>
<p>对这种经常取指定索引范围的操作，用循环身份繁琐，因此，Python提供了切片（slice）操作符，能大大简化这种操作。</p>
<p>对应上面的问题，取前三个元素，用一行代码就可以搞定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">0</span>:<span class="number">3</span>]</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">1</span>:<span class="number">3</span>]</div><div class="line">[<span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[:<span class="number">3</span>]</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>]</div></pre></td></tr></table></figure>
<p><code>L[0:3]</code>表示，从索引0开始取，取到索引3为止，但不包括3.即索引取0,1,2，正好是三个元素。如果第一个索引是0，还可以省略，也可以从索引1开始，取出两个元素。</p>
<p>类似的，既然Python支持<code>L[-1]</code>取出倒数第一个元素，那么他同样支持倒数切片：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">-3</span>:<span class="number">-1</span>]</div><div class="line">[<span class="string">'Tracy'</span>, <span class="string">'Bob'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">-5</span>:]</div><div class="line">[<span class="string">'Michael'</span>, <span class="string">'Sarah'</span>, <span class="string">'Tracy'</span>, <span class="string">'Bob'</span>, <span class="string">'Jack'</span>]</div></pre></td></tr></table></figure>
<p>切片操作十分有用。我们先创建一个0-99的数列：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L=list(range(<span class="number">100</span>))</div></pre></td></tr></table></figure>
<p>可以通过切片取出某一段数列，比如前十个，后十个，11-20等：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[:<span class="number">10</span>]</div><div class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">-10</span>:]</div><div class="line">[<span class="number">90</span>, <span class="number">91</span>, <span class="number">92</span>, <span class="number">93</span>, <span class="number">94</span>, <span class="number">95</span>, <span class="number">96</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[<span class="number">10</span>:<span class="number">20</span>]</div><div class="line">[<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>]</div></pre></td></tr></table></figure></p>
<p>前十个数，每两个去一个：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[:<span class="number">10</span>:<span class="number">2</span>]</div><div class="line">[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>]</div></pre></td></tr></table></figure></p>
<p>所有数，每五个取一个：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L[::<span class="number">5</span>]</div><div class="line">[<span class="number">0</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">40</span>, <span class="number">45</span>, <span class="number">50</span>, <span class="number">55</span>, <span class="number">60</span>, <span class="number">65</span>, <span class="number">70</span>, <span class="number">75</span>, <span class="number">80</span>, <span class="number">85</span>, <span class="number">90</span>, <span class="number">95</span>]</div></pre></td></tr></table></figure></p>
<p>如果什么都不写，只写<code>[:]</code>就可以复制一个list。</p>
<p>tuple也是list的一种，唯一区别是tuple不可变。因此tuple也可以用切片操作，操作的结果仍然是tuple：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>t=tuple(range(<span class="number">20</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t</div><div class="line">(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t[:<span class="number">3</span>]</div><div class="line">(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t[<span class="number">-12</span>:<span class="number">-3</span>]</div><div class="line">(<span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>)</div></pre></td></tr></table></figure>
<p>字符串<code>xxx</code>也可以看成是一种list，每一个元素就是一个字符。因此，字符串也可以用切片操作，只是操作结果仍然是字符串：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>h=<span class="string">'abcdefghi'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>h[:<span class="number">4</span>]</div><div class="line"><span class="string">'abcd'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>h[<span class="number">2</span>:<span class="number">8</span>:<span class="number">2</span>]</div><div class="line"><span class="string">'ceg'</span></div></pre></td></tr></table></figure>
<p>在许多编程语言中，针对字符串提供了很多种截取函数，如substring，其实目的就是对字符串进行切片。Python没有针对字符串的截取函数，只需要切片一个操作就可以完成，非常简单。</p>
<blockquote>
<p>小结<br>有了切片操作，很多地方循环就不需要了。Python的切片非常灵活，一行代码就可以实现多行循环才能完成的操作</p>
</blockquote>
<h2 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h2><p>如果给定一个list或者tuple，我们可以通过<code>for</code>循环来遍历这个list或者tuple，这种遍历我们称为迭代（iteration）。</p>
<p>在Python中，迭代是通过<code>for...in</code>来完成的，而很多语言如Java，迭代是通过下标完成的，比如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;list.length;i++)&#123;</div><div class="line">	n=list[i]</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>可以看出，Python的<code>for</code>循环抽象程度要高于Java的<code>for</code>循环，因为Python的for循环不仅可以用于list或tuple上，还可以用于其他可迭代对象上，list这种数据类型虽然有下标，但很多其他数据类型是没有下标的。只要是可迭代对象，无论有无下标，都可以迭代，比如dict就可以迭代：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>d=&#123;<span class="string">'a'</span>:<span class="number">1</span>,<span class="string">'b'</span>:<span class="number">2</span>,<span class="string">'c'</span>:<span class="number">3</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> key <span class="keyword">in</span> d:</div><div class="line"><span class="meta">... </span>    print(key)</div><div class="line">...</div><div class="line">c</div><div class="line">a</div><div class="line">b</div></pre></td></tr></table></figure>
<p>其中因为dict的存储不是按照list的方式顺序排列，所以迭代出来的顺序很可能不一样。默认情况下，dict迭代的是key。如果要迭代value，可以用<code>for value in d.values()</code>，如果要同时迭代key和value，可以用<code>for k,v in d.items()</code>。</p>
<p>由于字符串也是可迭代对象，因此，也可以用作<code>for</code>循环：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> ch <span class="keyword">in</span> <span class="string">'abcdnf'</span>:</div><div class="line"><span class="meta">... </span>    print(ch)</div><div class="line">...</div><div class="line">a</div><div class="line">b</div><div class="line">c</div><div class="line">d</div><div class="line">n</div><div class="line">f</div></pre></td></tr></table></figure>
<p>所以，当我们使用<code>for</code>循环时，只要作用于一个可迭代对象，<code>for</code>循环就可以正常运行，而我们不太关心该对象是list还是其他的数据类型。</p>
<p>如何判断一个对象是可迭代对象呢？方法是通过collections模块的Iterable类型判断：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; from collections import Iterable</div><div class="line">&gt;&gt;&gt; isinstance(&apos;abc&apos;,Iterable) #str是否可迭代</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance([1,2,3,4],Iterable) #str是否可迭代</div><div class="line">True</div><div class="line">&gt;&gt;&gt; isinstance(123,Iterable) #str是否可迭代</div><div class="line">False</div></pre></td></tr></table></figure>
<p>如果对list实现类似Java那样的下标循环怎么办？Python中内置的<code>enumerate</code>函数可以把一个list编程索引-元素对，这样就可以在<code>for</code>循环中同事迭代索引和元素本身：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; for i, value in enumerate([&apos;a&apos;,&apos;b&apos;,&apos;c&apos;,&apos;d&apos;,&apos;e&apos;]):</div><div class="line">...     print(i,value)</div><div class="line">...</div><div class="line">0 a</div><div class="line">1 b</div><div class="line">2 c</div><div class="line">3 d</div><div class="line">4 e</div></pre></td></tr></table></figure>
<p>上面的<code>for</code>循环里，同时引用了两个变量，在Python里面是很常见的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; for x,y in [(1,2),(3,4),(5,6),(7,8)]:</div><div class="line">...     print(x,y)</div><div class="line">...</div><div class="line">1 2</div><div class="line">3 4</div><div class="line">5 6</div><div class="line">7 8</div></pre></td></tr></table></figure>
<blockquote>
<p>小结<br>任何可迭代对象都可以作用于<code>for</code>循环，包括我们自定义的数据类型，只要符合迭代条件，就可以使用<code>for</code>循环。</p>
</blockquote>
<hr>
<h2 id="列表生成式"><a href="#列表生成式" class="headerlink" title="列表生成式"></a>列表生成式</h2><p>列表生成式即List Comprehensions，是Python内置的非常简单却强大的可以用来创建list的生成式，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>list(range(<span class="number">1</span>,<span class="number">11</span>))</div><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</div></pre></td></tr></table></figure>
<p>但是如果要生成<code>[1*1,2*2,3*3,...,10*10]</code>，方法一是循环：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L=[]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">11</span>):</div><div class="line"><span class="meta">... </span>    L.append(x*x)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L</div><div class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</div></pre></td></tr></table></figure>
<p>但是循环太繁琐，而列表生成式则可以用一行语句代替循环生成上面的list：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>[x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">11</span>)]</div><div class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</div></pre></td></tr></table></figure>
<p>写列表生成式时，把要生成的元素<code>x*x</code>放在前面，后面跟上<code>for</code>循环，就可以把list创建出来。</p>
<p>for循环后面还可以加上if判断，这样我们局可以筛选出仅偶数的平方：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>[x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">11</span>) <span class="keyword">if</span> x%<span class="number">2</span>==<span class="number">0</span>]</div><div class="line">[<span class="number">4</span>, <span class="number">16</span>, <span class="number">36</span>, <span class="number">64</span>, <span class="number">100</span>]</div></pre></td></tr></table></figure>
<p>还可以使用两层循环，可以生成全排列：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>[x+y <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">'abcd'</span> <span class="keyword">for</span> y <span class="keyword">in</span> <span class="string">'ABCD'</span>]</div><div class="line">[<span class="string">'aA'</span>, <span class="string">'aB'</span>, <span class="string">'aC'</span>, <span class="string">'aD'</span>, <span class="string">'bA'</span>, <span class="string">'bB'</span>, <span class="string">'bC'</span>, <span class="string">'bD'</span>, <span class="string">'cA'</span>, <span class="string">'cB'</span>, <span class="string">'cC'</span>, <span class="string">'cD'</span>, <span class="string">'dA'</span>, <span class="string">'dB'</span>, <span class="string">'dC'</span>, <span class="string">'dD'</span>]</div></pre></td></tr></table></figure>
<p>三层和三层以上的循环就很少用了。</p>
<p>运用列表生成式可以写出非常简洁的代码。例如，列出当前目录下的所有文件和目录名，可以通过一行代码实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; <span class="keyword">import</span> os</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>[d <span class="keyword">for</span> d <span class="keyword">in</span> os.listdir(<span class="string">'.'</span>)]</div><div class="line">[<span class="string">'3D Objects'</span>, <span class="string">'AppData'</span>, <span class="string">'Application Data'</span>, <span class="string">'Contacts'</span>, <span class="string">'Cookies'</span>, <span class="string">'Desktop'</span>, <span class="string">'Documents'</span>, <span class="string">'Downloads'</span>, <span class="string">'Favorites'</span>, <span class="string">'IntelGraphicsProfiles'</span>, <span class="string">'Links'</span>, <span class="string">'Local Settings'</span>, <span class="string">'Music'</span>, <span class="string">'My Documents'</span>, <span class="string">'NetHood'</span>, <span class="string">'NTUSER.DAT'</span>, <span class="string">'ntuser.dat.LOG1'</span>, <span class="string">'ntuser.dat.LOG2'</span>, <span class="string">'NTUSER.DAT&#123;eccc1a56-42ca-11e6-9cd4-bf9ec156b7db&#125;.TM.blf'</span>, <span class="string">'NTUSER.DAT&#123;eccc1a56-42ca-11e6-9cd4-bf9ec156b7db&#125;.TMContainer00000000000000000001.regtrans-ms'</span>, <span class="string">'NTUSER.DAT&#123;eccc1a56-42ca-11e6-9cd4-bf9ec156b7db&#125;.TMContainer00000000000000000002.regtrans-ms'</span>, <span class="string">'ntuser.ini'</span>, <span class="string">'OneDrive'</span>, <span class="string">'Pictures'</span>, <span class="string">'PrintHood'</span>, <span class="string">'Recent'</span>, <span class="string">'Saved Games'</span>, <span class="string">'Searches'</span>, <span class="string">'SendTo'</span>, <span class="string">'Templates'</span>, <span class="string">'Videos'</span>, <span class="string">'「开始」菜单'</span>]</div></pre></td></tr></table></figure>
<p><code>for</code>循环其实可以同时使用两个甚至多个变量，如<code>dict</code>的<code>items()</code>可以同时迭代key和value：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> k,v <span class="keyword">in</span> d.items():</div><div class="line"><span class="meta">... </span>    print(k,<span class="string">'='</span>,v)</div><div class="line">...</div><div class="line">c = <span class="number">3</span></div><div class="line">a = <span class="number">1</span></div><div class="line">b = <span class="number">2</span></div></pre></td></tr></table></figure>
<p>因此列表生成式也可以使用两个变量来生成list：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>d=&#123;<span class="string">'a'</span>:<span class="string">'b'</span>,<span class="string">'c'</span>:<span class="string">'v'</span>,<span class="string">'d'</span>:<span class="string">'g'</span>&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>[k + <span class="string">'='</span> + v <span class="keyword">for</span> k,v <span class="keyword">in</span> d.items()]</div><div class="line">[<span class="string">'d=g'</span>, <span class="string">'c=v'</span>, <span class="string">'a=b'</span>]</div></pre></td></tr></table></figure>
<p>最后把一个list中的所有字符串变为小写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L=[<span class="string">'Hello'</span>,<span class="string">'DSFA'</span>,<span class="string">'DFAC'</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>[s.lower() <span class="keyword">for</span> s <span class="keyword">in</span> L]</div><div class="line">[<span class="string">'hello'</span>, <span class="string">'dsfa'</span>, <span class="string">'dfac'</span>]</div></pre></td></tr></table></figure>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p> L1=[‘Hello’,’World’,18,’Apple’,None]，添加if语句，期待L2=[‘hello’, ‘world’, ‘apple’]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L2=[s.lower() <span class="keyword">for</span> s <span class="keyword">in</span> L1 <span class="keyword">if</span> isinstance(s,str)]</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>L2</div><div class="line">[<span class="string">'hello'</span>, <span class="string">'world'</span>, <span class="string">'apple'</span>]</div></pre></td></tr></table></figure>
<hr>
<h2 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h2><p>通过列表生成式，我们可以直接创建一个列表。但是受到内存的限制，列表容量肯定是有限的。而且，创建一个包含100万个元素的列表，不仅占用很大的空间，如果我们仅仅需要访问前面几个元素，后面的绝大多数元素占用的空间就被白白浪费了。</p>
<p>所以，如果列表元素可以按照某种算法推算出来，那我们是否可以在循环过程中不断推算出后面的元素呢？这样就不必创建完整的list，从而节省大量的空间。在Python中，这种一边循环一边计算的机制，称为生成器：generator。</p>
<p>要创建一个generator，有很多中方法。第一种很简答，只要把一个列表生成式的<code>[]</code> 改为<code>()</code>，就创建了一个generator：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>L</div><div class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>]</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g=(x*x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g</div><div class="line">&lt;generator object &lt;genexpr&gt; at <span class="number">0x0000020E84788E60</span>&gt;</div></pre></td></tr></table></figure>
<p>可以看出创建<code>L</code>和<code>g</code>的区别仅在于最外层是<code>[]</code>还是<code>()</code>，<code>L</code>是一个list，而g是一个generator。我们可以直接打出list的么一个元素，但是我们怎么打出generator的每一个元素呢，如果要一个一个打，可以通过<code>next()</code>函数来获得generator的下一个返回值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">4</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">9</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">16</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">25</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">36</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">49</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">64</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div><div class="line"><span class="number">81</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(g)</div></pre></td></tr></table></figure>
<p>我们前面讲过，generator保存的是算法，每次调用<code>next(g)</code>，就计算出下一个<code>g</code>的值，直到计算到最后一个元素，没有更多的元素时，抛出<code>stopiteration</code>的错误。generator非常强大，如果推算的算法比较复杂，用类似列表生成式的<code>for</code>循环无法实现的时候，还可以用函数来实现。比如著名的斐波拉契数列（Fibonacci），除了第一个和第二个数外，任意一个数可由前面两个数相加得到：<br>1,1,2,3,5,8,13,21,34…</p>
<p>斐波拉契数列用列表生成式写不出来，但是，用函数可以把它打印出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(max)</span>:</span></div><div class="line"><span class="meta">... </span>    n,a,b=<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n&lt;max:</div><div class="line"><span class="meta">... </span>            print(b)</div><div class="line"><span class="meta">... </span>            a,b=b,a+b</div><div class="line"><span class="meta">... </span>            n=n+<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> <span class="string">'done'</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>fib(<span class="number">10</span>)</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="number">5</span></div><div class="line"><span class="number">8</span></div><div class="line"><span class="number">13</span></div><div class="line"><span class="number">21</span></div><div class="line"><span class="number">34</span></div><div class="line"><span class="number">55</span></div><div class="line"><span class="string">'done'</span></div></pre></td></tr></table></figure>
<p>仔细看，<code>fib</code>函数实际上是定义了斐波拉契数列的推算规则，可以从第一个元素开始，推算出后续任意的元素，这种逻辑非常类似generator。也就是说，上面个的函数和generator只有一步之遥。要把<code>fib</code>变为generator，只需要把<code>print(b)</code>改为<code>yield b</code>就可以了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">fib</span><span class="params">(max)</span>:</span></div><div class="line"><span class="meta">... </span>    n,a,b=<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n&lt;max:</div><div class="line"><span class="meta">... </span>            <span class="keyword">yield</span> b</div><div class="line"><span class="meta">... </span>            a,b=b,a+b</div><div class="line"><span class="meta">... </span>            n=n+<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">return</span> <span class="string">'done'</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>fib(<span class="number">10</span>)</div><div class="line">&lt;generator object fib at <span class="number">0x0000020E84788BA0</span>&gt;</div></pre></td></tr></table></figure>
<p>这就是定义generator的另一种方法。如果一个函数定义包含关键字<code>yield</code>，那么这个函数就不再是一个普通的函数，而是一个generator。</p>
<p>这里最难理解的是generator和函数的执行流程不一样。函数是顺序执行的，遇到return语句或者最后一行函数语句就返回。而变为generator的函数，在每次调用<code>next()</code>的时候执行，遇到<code>yield</code>语句返回，再次执行时从上次返回的yield语句出继续执行。</p>
<p>举个例子，定义一个generator，一次返回数字1,3,5：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">odd</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'step1'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">yield</span> <span class="number">1</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">'step2'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="number">3</span>)</div><div class="line"><span class="meta">... </span>    print(<span class="string">'step3'</span>)</div><div class="line"><span class="meta">... </span>    <span class="keyword">yield</span> (<span class="number">5</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>o=odd()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(o)</div><div class="line">step1</div><div class="line"><span class="number">1</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(o)</div><div class="line">step2</div><div class="line"><span class="number">3</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(o)</div><div class="line">step3</div><div class="line"><span class="number">5</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>next(o)</div><div class="line">Traceback (most recent call last):</div><div class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</div><div class="line">StopIteration</div></pre></td></tr></table></figure>
<p>可以看出，<code>odd()</code>不是普通函数，而是generator，在执行过程中，遇到yield就会中断，下次又继续执行。执行3次之后，没有<code>yield</code>可以执行了，所以第四次调用<code>next(o)</code>就报错。回到<code>fib</code>的例子，我们在循环过程中不断用<code>yield</code>，就会不断中断。当然要给循环设置一个条件来跳出循环，不然就会产生一个无限数列出来。同样的，把函数改为generator之后，我们基本上从来不会用<code>next()</code>来获取下一个返回值，而是直接使用<code>for</code>循环来迭代。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span>  n <span class="keyword">in</span> fib(<span class="number">10</span>):</div><div class="line"><span class="meta">... </span>    print(n)</div><div class="line">...</div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">1</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="number">5</span></div><div class="line"><span class="number">8</span></div><div class="line"><span class="number">13</span></div><div class="line"><span class="number">21</span></div><div class="line"><span class="number">34</span></div><div class="line"><span class="number">55</span></div></pre></td></tr></table></figure>
<p>但是使用<code>for</code>循环时，发现拿不到generator的<code>return</code>语句的返回值。如果想要拿到返回值，必须捕获<code>StopIteration</code>错误，返回值包含在<code>StopIteration</code>的<code>value</code>中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>f=fib(<span class="number">6</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="meta">... </span>    <span class="keyword">try</span>:</div><div class="line"><span class="meta">... </span>            x=next(f)</div><div class="line"><span class="meta">... </span>            print(<span class="string">'g'</span>,x)</div><div class="line"><span class="meta">... </span>    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</div><div class="line"><span class="meta">... </span>            print(<span class="string">'Generator return value:'</span>,e.value)</div><div class="line"><span class="meta">... </span>            <span class="keyword">break</span></div><div class="line">...</div><div class="line">g <span class="number">1</span></div><div class="line">g <span class="number">1</span></div><div class="line">g <span class="number">2</span></div><div class="line">g <span class="number">3</span></div><div class="line">g <span class="number">5</span></div><div class="line">g <span class="number">8</span></div><div class="line">Generator <span class="keyword">return</span> value: done</div></pre></td></tr></table></figure>
<blockquote>
<p>练习<br>杨辉三角，把每一行看做一个list，试着写一个generator，不断输出下一行的list：</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">tri</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    L=[<span class="number">1</span>]</div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">yield</span> L</div><div class="line"><span class="meta">... </span>            L=[L[x]+L[x+<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> range(len(L)<span class="number">-1</span>)]</div><div class="line"><span class="meta">... </span>            L.insert(<span class="number">0</span>,<span class="number">1</span>)</div><div class="line"><span class="meta">... </span>            L.append(<span class="number">1</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>n=<span class="number">0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> t <span class="keyword">in</span> tri():</div><div class="line"><span class="meta">... </span>    print(t)</div><div class="line"><span class="meta">... </span>    n=n+<span class="number">1</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">if</span> n==<span class="number">10</span>:</div><div class="line"><span class="meta">... </span>            <span class="keyword">break</span></div><div class="line">...</div><div class="line">[<span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">4</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">5</span>, <span class="number">10</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">7</span>, <span class="number">21</span>, <span class="number">35</span>, <span class="number">35</span>, <span class="number">21</span>, <span class="number">7</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">8</span>, <span class="number">28</span>, <span class="number">56</span>, <span class="number">70</span>, <span class="number">56</span>, <span class="number">28</span>, <span class="number">8</span>, <span class="number">1</span>]</div><div class="line">[<span class="number">1</span>, <span class="number">9</span>, <span class="number">36</span>, <span class="number">84</span>, <span class="number">126</span>, <span class="number">126</span>, <span class="number">84</span>, <span class="number">36</span>, <span class="number">9</span>, <span class="number">1</span>]</div></pre></td></tr></table></figure>
<blockquote>
<p>小结<br>generator是非常强大的工具，在Python中，可以简单的把列表生成式改为generator。要理解generator的工作原理，他是在<code>for</code>循环的过程中不断计算出下一个元素，并在适当的条件结束循环。对于函数改成的generator来说，遇到<code>return</code>语句或者执行到函数体最后一行语句，就要结束generator的指令，<code>for</code>循环随之结束。</p>
</blockquote>
<p>请注意区分普通函数和generator函数，普通函数调用直接返回结果，generator函数调用实际返回一个generator对象。</p>
<hr>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>我们已经知道，可以直接作用关于<code>for</code>循环的数据类型有以下几种：一类是集合数据类型，如<code>list</code>,<code>tuple</code>,<code>dict</code>,<code>set</code>,<code>str</code>等；一类是<code>generator</code>，包括生成器和带<code>yield</code>的generator function。这些可以直接作用于<code>for</code>循环的对象统称为可迭代对象：<code>Iterable</code>。可以使用<code>isinstance()</code>来判断一个对象是否是<code>Iterable</code>对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance([],Iterable)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(&#123;&#125;,Iterable)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(<span class="string">'abc'</span>,Iterable)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance((x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)),Iterable)</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>而生成器不但可以作用于<code>for</code>循环，还可以被<code>next()</code>函数不断调用并返回下一个值，直到最后抛出<code>StopIteration</code>错误表示无法继续返回下一个值了。可以被<code>next()</code>函数调用并不断返回下一个值的对象称为迭代器：<code>Iterator</code>。</p>
<p>可以用<code>isinstance()</code>来判断一个对象是否是<code>Iterator</code>对象：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> collections <span class="keyword">import</span> Iterator</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance((x <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">10</span>)),Iterator)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="keyword">False</span></div></pre></td></tr></table></figure>
<p>生成器都是<code>Iterator</code>对象，但是<code>list</code>,<code>dict</code>,<code>str</code>却不是。把这些<code>Iterable</code>变为<code>Iterator</code>可以使用<code>iter()</code>函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(iter([]),Iterator)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>isinstance(iter(<span class="string">'adsaf'</span>),Iterator)</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>为什么<code>list</code>,<code>dict</code>,<code>str</code>不是<code>Iterator</code>？？？</p>
<p>这是因为Python的<code>Iterator</code>对象表示一个数据流，<code>Iterator</code>对象可以被<code>next()</code>函数调用并不断返回下一个数据，直到没有数据时抛出<code>StopIteration</code>错误。可以把这个数据流看做是一个有序的序列，但是我们却不能提前得知序列的长度，只能不断通过<code>next()</code>函数实现按需计算的下一个数据，所以<code>Iterator</code>的计算时惰性的，只有在需要的时候才会计算。<code>Iterator</code>甚至可以表示一个无限大的数据流，例如全体自然数，但是list是永远不可能存储全体的自然数的。</p>
<blockquote>
<p>小结<br>凡是可以用作<code>for</code>循环的对象都是<code>Iterable</code>类型；<br>凡是可作用关于<code>next()</code>函数的对象都是<code>Iterator</code>类型，他们表示一个惰性计算的序列；<br>集合数据类型如<code>list</code>，<code>dict</code>，<code>str</code>等都是<code>Iterable</code>,但是不是<code>Iterator</code>，不过可以通过<code>iter()</code>获得一个<code>Iterator</code>对象。</p>
<p>·Python上的<code>for</code>循环本质上是通过不断调用<code>next()</code>函数来实现的：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> x <span class="keyword">in</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]:</div><div class="line"><span class="meta">... </span>    <span class="keyword">pass</span></div><div class="line"><span class="meta">... </span>                <span class="comment">#等价的</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>it=iter([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>])</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="meta">... </span>    <span class="keyword">try</span>:</div><div class="line"><span class="meta">... </span>            x=next(it)</div><div class="line"><span class="meta">... </span>    <span class="keyword">except</span> StopIteration:</div><div class="line"><span class="meta">... </span>            <span class="keyword">break</span></div><div class="line">...</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
</blockquote>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/15.电子邮件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/15.电子邮件/" itemprop="url">15. 电子邮件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T15:10:22+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="电子邮件"><a href="#电子邮件" class="headerlink" title="电子邮件"></a>电子邮件</h1><p>电子邮件软件成为MUA：Mail User Agent—-邮件用户代理。E-mail从MUA发出去，不是直接到达对方电脑而是发到MTA(Mail Transfer Agent—邮件传输代理)，就是Email服务提供商，比如网易，新浪等。MTA会把email投递到MDA(Mail Delivery Agent—邮件投递代理)，存储在某个文件或特殊的数据库里也就是邮箱。要想获取邮件，必须通过MUA从MDA上获取到自己电脑上。</p>
<blockquote>
<p>发件人—&gt;MUA—&gt;MTA—&gt;MTA—&gt;若干个MTA—&gt;MDA&lt;—MUA&lt;—收件人</p>
</blockquote>
<p>要编写程序来发送和接收邮件，本质上就是：</p>
<blockquote>
<p>1、编写MUA把邮件发到MTA<br>2、编写MUA从MDA上收邮件</p>
</blockquote>
<p>发邮件时MUA和MTA使用的协议是SMTP：Simple Mail Transfer Protocol。<br>收邮件时，MUA和MDA使用的协议有两种：POP：Post Office Protocol，目前版本是3，俗称POP3；IMAP：Internet Message Access Protocol，目前版本是4，优点是不但能取邮件，还可以直接操作MDA上存储的邮件，比如从收件箱移到垃圾箱。</p>
<p>邮件客户端在发邮件时，会让你先配置SMTP服务器，也就是你要发到哪个MTA上。比如你在用163邮箱，就不能直接发送到新浪的MTA上，你要填163提供的SMTP服务器地址：<code>smtp.163.com</code>，还需要输入邮箱地址和邮箱口令来证明你是163用户，这样MUA才能正常地把Email通过SMTP协议发送到MTA。</p>
<p>从MDA收取邮件时，MDA服务器会要求验证邮箱口令，这样MUA才能顺利地通过POP或IMAP协议从MDA获取邮件。</p>
<h2 id="SMTP发送邮件"><a href="#SMTP发送邮件" class="headerlink" title="SMTP发送邮件"></a>SMTP发送邮件</h2><p>SMTP是发送邮件的协议，Python内置对SMTP的支持，可以发送纯文本邮件，HTML邮件及其附件。</p>
<p>Python对SMTP支持有<code>smtplib</code>和<code>email</code>两个模块，<code>email</code>负责构造邮件，<code>stmplib</code>负责发送邮件。首先，我们来构造一个最简单的纯文本邮件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>msg=MIMEText(<span class="string">'Hello, send by Python...'</span>,<span class="string">'plain'</span>,<span class="string">'utf-8'</span>)</div></pre></td></tr></table></figure></p>
<p>注意到构造<code>MIMEText</code>对象时，第一个参数就是邮件正文，第二个参数是MIME的subtype，传入<code>plain</code>表示纯文本，最终的MIME就是<code>text/plain</code>，最后一定要用<code>utf-8</code>编码保证多语言兼容性。然后通过SMTP发送出去：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">from_addr=input(<span class="string">'From:'</span>)</div><div class="line">password=input(<span class="string">'Password:'</span>)</div><div class="line"></div><div class="line">to_addr=input(<span class="string">'To:'</span>)</div><div class="line"></div><div class="line">smtp_server=input(<span class="string">'SMTP server: '</span>)</div><div class="line"></div><div class="line"><span class="keyword">import</span> smtplib</div><div class="line">server=smtplib.SMTP(smtp_server, <span class="number">25</span>)<span class="comment">#smtp默认的端口是25</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">server.login(from_addr, password)</div><div class="line">server.sendmail(from_addr,[to_addr],msg.as_string())</div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>我们用<code>set_debuglevel(1)</code>就可以打印出和SMTP服务器交互的所有信息。SMTP协议就是简单的文本命令和相应。<code>login()</code>方法用来登录SMTP服务器，<code>sendmail()</code>方法就是发邮件，由于可以一次发给对个人，所以传入一个<code>list</code>，邮件正文是一个<code>str</code>，<code>as_string()</code>把MIMEText对象编程<code>str</code>。收到的邮件的问题是没有主题收件人没有显示为友好的名字，且收到了邮件却提示你不在收件人中。这是因为邮件主题、如何显示发件人、收件人的信息并不是通过SMTP协议发给MTA，而是包含在发给MTA的文本中的，所以，我们必须把From、To、Subject添加到MIMEText中才是一封完整的邮件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> smtplib</div><div class="line"><span class="keyword">from</span> email <span class="keyword">import</span> encoders</div><div class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> Header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr, formataddr</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_format_addr</span><span class="params">(s)</span>:</span></div><div class="line">    name, addr = parseaddr(s)</div><div class="line">    <span class="keyword">return</span> formataddr((Header(name, <span class="string">'utf-8'</span>).encode(), addr))</div><div class="line"></div><div class="line">from_addr=input(<span class="string">'From:'</span>)</div><div class="line">password=input(<span class="string">'Password:'</span>)</div><div class="line">to_addr=input(<span class="string">'To:'</span>)</div><div class="line">smtp_server=input(<span class="string">'SMTP server: '</span>)</div><div class="line"></div><div class="line">msg=MIMEText(<span class="string">'hello, send by python...'</span>, <span class="string">'plain'</span> ,<span class="string">'utf-8'</span>)</div><div class="line">msg[<span class="string">'From'</span>] = _format_addr(<span class="string">'Python爱好者 &lt;%s&gt;'</span> % from_addr)</div><div class="line">msg[<span class="string">'To'</span>] = _format_addr(<span class="string">'管理员 &lt;%s&gt;'</span> % to_addr)</div><div class="line">msg[<span class="string">'Subject'</span>] = Header(<span class="string">'来自SMTP的问候……'</span>, <span class="string">'utf-8'</span>).encode()</div><div class="line"></div><div class="line">server = smtplib.SMTP(smtp_server, <span class="number">25</span>) <span class="comment"># SMTP协议默认端口是25</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">server.login(from_addr, password)</div><div class="line">server.sendmail(from_addr, [to_addr], msg.as_string())</div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>我们编写了一个函数<code>_format_addr()</code>来格式化一个邮件地址。注意不能简单地传入<code>name &lt;addr@example.com&gt;</code>,因为如果包含中文，需要通过<code>Header</code>对象编码。</p>
<p><code>msg[&#39;To&#39;]</code>发送的是字符串而不是list，如果有多个地址邮件，用，分隔即可。发送邮箱显示：<br><img src="/img/1478864121047.png" alt="Alt text"></p>
<p>你看到的收件人的名字可能不是我们传入的管理员，因为很多邮件服务商在显示邮件时会把收件人名字自动替换为用户注册的名字。我们插卡Email原始内容如下：</p>
<blockquote>
<p>From: =?utf-8?b?UHl0aG9u54ix5aW96ICF?= <a href="&#109;&#97;&#x69;&#x6c;&#116;&#x6f;&#x3a;&#120;&#x78;&#120;&#120;&#x78;&#x78;&#x40;&#49;&#54;&#51;&#46;&#x63;&#111;&#x6d;">&#120;&#x78;&#120;&#120;&#x78;&#x78;&#x40;&#49;&#54;&#51;&#46;&#x63;&#111;&#x6d;</a><br>To: =?utf-8?b?566h55CG5ZGY?= <a href="&#x6d;&#97;&#105;&#108;&#116;&#111;&#58;&#x78;&#120;&#120;&#x78;&#x78;&#120;&#x40;&#x71;&#113;&#46;&#99;&#x6f;&#109;">&#x78;&#120;&#120;&#x78;&#x78;&#120;&#x40;&#x71;&#113;&#46;&#99;&#x6f;&#109;</a><br>Subject: =?utf-8?b?5p2l6IeqU01UUOeahOmXruWAmeKApuKApg==?=</p>
</blockquote>
<h3 id="发送HTML邮件"><a href="#发送HTML邮件" class="headerlink" title="发送HTML邮件"></a>发送HTML邮件</h3><p>如果我们要发送HTML邮件而不是普通的纯文本文件怎么办，就在构造<code>MIMEText</code>对象时，把HTML字符串传进去，再把第二个参数由plain改为plain就可以了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msg=MIMEText(&apos;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&apos; + &apos;&lt;p&gt;send by &lt;a href=&quot;http://www.python.org&quot;&gt;Python&lt;/a&gt;...&lt;/p&gt;&apos;+&apos;&lt;/body&gt;&lt;/html&gt;&apos;, &apos;html&apos;, &apos;utf-8&apos;)</div></pre></td></tr></table></figure></p>
<p>再发送一遍邮件：<br><img src="/img/1478864651325.png" alt="Alt text"></p>
<h3 id="发送附件"><a href="#发送附件" class="headerlink" title="发送附件"></a>发送附件</h3><p>如果Email中要加上附件，可以把带附件的邮件看做包含若干部分的邮件：文本和各个附件本身，所以可以构造一个<code>MIMEMultipart</code>对象代表邮件本身，然后往里面加上一个<code>MIMEText</code>作为邮件正文，再继续往里面加上表示附件的<code>MIMEBase</code>对象即可：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 邮件对象:</span></div><div class="line">msg = MIMEMultipart()</div><div class="line">msg[<span class="string">'From'</span>] = _format_addr(<span class="string">'Python爱好者 &lt;%s&gt;'</span> % from_addr)</div><div class="line">msg[<span class="string">'To'</span>] = _format_addr(<span class="string">'管理员 &lt;%s&gt;'</span> % to_addr)</div><div class="line">msg[<span class="string">'Subject'</span>] = Header(<span class="string">'来自SMTP的问候……'</span>, <span class="string">'utf-8'</span>).encode()</div><div class="line"></div><div class="line"><span class="comment"># 邮件正文是MIMEText:</span></div><div class="line">msg.attach(MIMEText(<span class="string">'send with file...'</span>, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="comment"># 添加附件就是加上一个MIMEBase，从本地读取一个图片:</span></div><div class="line"><span class="keyword">with</span> open(<span class="string">'/Users/michael/Downloads/test.png'</span>, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</div><div class="line">    <span class="comment"># 设置附件的MIME和文件名，这里是png类型:</span></div><div class="line">    mime = MIMEBase(<span class="string">'image'</span>, <span class="string">'png'</span>, filename=<span class="string">'test.png'</span>)</div><div class="line">    <span class="comment"># 加上必要的头信息:</span></div><div class="line">    mime.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">'test.png'</span>)</div><div class="line">    mime.add_header(<span class="string">'Content-ID'</span>, <span class="string">'&lt;0&gt;'</span>)</div><div class="line">    mime.add_header(<span class="string">'X-Attachment-Id'</span>, <span class="string">'0'</span>)</div><div class="line">    <span class="comment"># 把附件的内容读进来:</span></div><div class="line">    mime.set_payload(f.read())</div><div class="line">    <span class="comment"># 用Base64编码:</span></div><div class="line">    encoders.encode_base64(mime)</div><div class="line">    <span class="comment"># 添加到MIMEMultipart:</span></div><div class="line">    msg.attach(mime)</div></pre></td></tr></table></figure></p>
<p> 发送结果：<br> <img src="/img/1478944551315.png" alt="Alt text"></p>
<h3 id="发送图片"><a href="#发送图片" class="headerlink" title="发送图片"></a>发送图片</h3><p>如果要把一个图片嵌入到邮件正文中，直接在HTML邮件中连接图片地址是不行的，我们需要按照发送附件的方法，把邮件作为附件添加进去，然后在HTML中通过引用<code>src=&quot;cid:0&quot;</code>就可以把附件作为图片嵌入。如果有多个图片，可以依次编号，然后引用不同的<code>cid:x</code>就可以。</p>
<p>把上面代码中加入<code>MIMEMultipart</code>的<code>MIMEText</code>从<code>plain</code>改为<code>html</code>，然后在适当的位置引用图片：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">msg.attach(MIMEText(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;'</span> +</div><div class="line">    <span class="string">'&lt;p&gt;&lt;img src="cid:0"&gt;&lt;/p&gt;'</span> +</div><div class="line">    <span class="string">'&lt;/body&gt;&lt;/html&gt;'</span>, <span class="string">'html'</span>, <span class="string">'utf-8'</span>))</div></pre></td></tr></table></figure></p>
<p>发送结果：<br><img src="/img/1478945851210.png" alt="Alt text"></p>
<h3 id="同时支持HTML和Plain格式"><a href="#同时支持HTML和Plain格式" class="headerlink" title="同时支持HTML和Plain格式"></a>同时支持HTML和Plain格式</h3><p>如果我们发送HTML邮件，收件人通过浏览器或者Outlook之类的软件是可以正常浏览邮件内容的，但是如果收件人的设备无法查看HTML邮件时，我们可以在发送HTML的同时再附加一个纯文本，如果收件人无法查看HTML格式的邮件，就可以自动降级查看纯文本邮件。</p>
<p>利用<code>MIMEMultipart</code>可以组合一个HTML和Plain，要注意指定subtype是<code>alternative</code>:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">msg = MIMEMultipart(<span class="string">'alternative'</span>)</div><div class="line">msg[<span class="string">'From'</span>] = ...</div><div class="line">msg[<span class="string">'To'</span>] = ...</div><div class="line">msg[<span class="string">'Subject'</span>] = ...</div><div class="line"></div><div class="line">msg.attach(MIMEText(<span class="string">'hello'</span>, <span class="string">'plain'</span>, <span class="string">'utf-8'</span>))</div><div class="line">msg.attach(MIMEText(<span class="string">'&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;'</span>, <span class="string">'html'</span>, <span class="string">'utf-8'</span>))</div><div class="line"><span class="comment"># 正常发送msg对象...</span></div></pre></td></tr></table></figure></p>
<h3 id="加密SMTP"><a href="#加密SMTP" class="headerlink" title="加密SMTP"></a>加密SMTP</h3><p>使用标准的25端口连接SMTP服务器时，使用的是明文传输，发送邮件的整个过程可能会被窃听。要更安全地发送邮件，可以加密SMTP会话，实际上就是先创建SSL安全连接，然后再使用SMTP协议发送邮件。</p>
<p>Gmail提供的SMTP服务必须要加密传输。首先知道Gmail的SMTP端口是587，修改代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">smtp_server = <span class="string">'smtp.gmail.com'</span></div><div class="line">smtp_port = <span class="number">587</span></div><div class="line">server = smtplib.SMTP(smtp_server, smtp_port)</div><div class="line">server.starttls()</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>只需要在创建SMTP对象后，立刻调用<code>starttls()</code>方法，就创建了安全链接。后面的代码和前面的发送邮件代码完全一样。</p>
<p>使用Python的smtplib发送邮件很简单，只要掌握了各种邮件类型的构造方法，正确设置好邮件头就可以顺利发出。构造一个邮件对象就是一个<code>Message</code>对象，如果构建一个<code>MIMEText</code>对象，就表示一个作为附件的图片，要把多个对象组合起来，就用<code>MIMEMultipart</code>，<code>MIMEBase</code>可以表示任何对象，继承关系如下：<br><img src="/img/1478946592016.png" alt="Alt text"></p>
<hr>
<h2 id="POP3收取邮件"><a href="#POP3收取邮件" class="headerlink" title="POP3收取邮件"></a>POP3收取邮件</h2><p>收邮件就是编写一个MUA作为客户端，从MDA把邮件获取到用户的电脑或者手机上。收取邮件最常用的协议是POP协议。Python内置了一个<code>poplib</code>模块，实现了POP3协议。</p>
<p>POP3收取的不是一个已经可以阅读的邮件本身，而是邮件的原始文本，这和SMTP一样，SMTP发送的也是经过编码后的一大段文本。要把POP3收取的文本变为可以阅读的邮件，还需要用<code>email</code>模块提供的各种类来解析原始文本，变成可阅读的邮件对象。收取邮件分为两部分：</p>
<blockquote>
<p>1、用<code>poplib</code>把邮件的原始文本下载到本地；<br>2、用<code>email</code>解析原始文本，还原为邮件对象。</p>
</blockquote>
<h3 id="通过POP3下载邮件"><a href="#通过POP3下载邮件" class="headerlink" title="通过POP3下载邮件"></a>通过POP3下载邮件</h3><p>POP3的协议本身很简单，以下面的代码为例，我们来获取最新的一封邮件内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">import</span> poplib</div><div class="line"></div><div class="line"><span class="comment">#输入邮箱地址，口令和POP3服务器地址：</span></div><div class="line">email = input(<span class="string">'Email:'</span>)</div><div class="line">password =input(<span class="string">'Password:'</span>)</div><div class="line">pop3_server = input(<span class="string">'POP3 server:'</span>)</div><div class="line"></div><div class="line"><span class="comment">#连接到POP3服务器</span></div><div class="line">server = poplib.POP3(pop3_server)</div><div class="line"><span class="comment">#可以打开或关闭调试信息</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line">print(server.getwelcome().decode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="comment">#身份认证</span></div><div class="line">server.user(email)</div><div class="line">server.pass_(password)</div><div class="line"></div><div class="line"><span class="comment">#start()返回邮件数量和占用空间</span></div><div class="line">print(<span class="string">'Messages: %s, Size: %s'</span> %server.stat())</div><div class="line"><span class="comment">#list()返回所有邮件的编号</span></div><div class="line">resp, mails, octets = server.list()</div><div class="line"></div><div class="line">print(mails)</div><div class="line"></div><div class="line"><span class="comment">#获取最新一封邮件，索引号从1开始</span></div><div class="line">index = len(mails)</div><div class="line">resp, lines, octets = server.retr(index)</div><div class="line">msg_content = <span class="string">b'\r\n'</span>.join(lines).decode(<span class="string">'utf-8'</span>)</div><div class="line"></div><div class="line">msg = Parser().parsestr(msg_content)</div><div class="line"></div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>
<p>用POP3协议很简单，要获取所有邮件，只需要循环使用<code>retr()</code>把每一封邮件内容拿到即可。</p>
<h3 id="解析邮件"><a href="#解析邮件" class="headerlink" title="解析邮件"></a>解析邮件</h3><p>解析邮件的过程和上一节构造邮件刚好相反，必须导入必要的模块：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> decode_header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr</div><div class="line"></div><div class="line"><span class="keyword">import</span> poplib</div></pre></td></tr></table></figure></p>
<p>一行代码可以把邮件内容解析为Message对象：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">msg = Parser().parsestr(msg_content)</div></pre></td></tr></table></figure></p>
<p>这个<code>Message</code>对象本身可能是一个<code>MIMEMultipart</code>对象，即包含嵌套的其他<code>MIMEBase</code>对象，嵌套可能还不止一层。所以我们要递归地打印出Message对象的层次结构：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># indent用于缩进显示:</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_info</span><span class="params">(msg, indent=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> indent == <span class="number">0</span>:</div><div class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> [<span class="string">'From'</span>, <span class="string">'To'</span>, <span class="string">'Subject'</span>]:</div><div class="line">            value = msg.get(header, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> value:</div><div class="line">                <span class="keyword">if</span> header==<span class="string">'Subject'</span>:</div><div class="line">                    value = decode_str(value)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    hdr, addr = parseaddr(value)</div><div class="line">                    name = decode_str(hdr)</div><div class="line">                    value = <span class="string">u'%s &lt;%s&gt;'</span> % (name, addr)</div><div class="line">            print(<span class="string">'%s%s: %s'</span> % (<span class="string">'  '</span> * indent, header, value))</div><div class="line">    <span class="keyword">if</span> (msg.is_multipart()):</div><div class="line">        parts = msg.get_payload()</div><div class="line">        <span class="keyword">for</span> n, part <span class="keyword">in</span> enumerate(parts):</div><div class="line">            print(<span class="string">'%spart %s'</span> % (<span class="string">'  '</span> * indent, n))</div><div class="line">            print(<span class="string">'%s--------------------'</span> % (<span class="string">'  '</span> * indent))</div><div class="line">            print_info(part, indent + <span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        content_type = msg.get_content_type()</div><div class="line">        <span class="keyword">if</span> content_type==<span class="string">'text/plain'</span> <span class="keyword">or</span> content_type==<span class="string">'text/html'</span>:</div><div class="line">            content = msg.get_payload(decode=<span class="keyword">True</span>)</div><div class="line">            charset = guess_charset(msg)</div><div class="line">            <span class="keyword">if</span> charset:</div><div class="line">                content = content.decode(charset)</div><div class="line">            print(<span class="string">'%sText: %s'</span> % (<span class="string">'  '</span> * indent, content + <span class="string">'...'</span>))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%sAttachment: %s'</span> % (<span class="string">'  '</span> * indent, content_type))</div></pre></td></tr></table></figure></p>
<p>邮件的Subject或者Email中包含的名字都是经过编码后的str，要正常显示，就必须decode：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_Str</span><span class="params">(s)</span>:</span></div><div class="line">	value, charset = decode_header(s)[<span class="number">0</span>]</div><div class="line">	<span class="keyword">if</span> charset:</div><div class="line">		value = value.decode(charset)</div><div class="line">	<span class="keyword">return</span> value</div></pre></td></tr></table></figure></p>
<p><code>decode_header()</code>返回一个list，因为像<code>Cc``Bcc</code>这样的字段可能包含多个邮件地址，所以解析出来的会有多个元素。上面的代码我们只取了第一个元素。文本邮件的内容也是str，还需要检测编码，否则非UTF-8编码的邮件都无法正常显示：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">gusee_charset</span><span class="params">(msg)</span>:</span></div><div class="line">	charset = msg.get_charset()</div><div class="line">	<span class="keyword">if</span> charset <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">		content_type = msg.get(<span class="string">'Content-Type'</span>, <span class="string">''</span>).lower()</div><div class="line">		pos = content_type.find(<span class="string">'charset='</span>)</div><div class="line">		<span class="keyword">if</span> pos &gt;= <span class="number">0</span>:</div><div class="line">			charset = content_type[pos + <span class="number">8</span>:].strip()</div><div class="line">	<span class="keyword">return</span> charset</div></pre></td></tr></table></figure></p>
<p>把上面的代码整理好，我们就可以来试试获取一封邮件。先往自己的邮箱发送一封邮件，然后用Python程序把它收到本地：<br><img src="/img/1478954102163.png" alt="Alt text"></p>
<p>源码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> email.parser <span class="keyword">import</span> Parser</div><div class="line"><span class="keyword">from</span> email.header <span class="keyword">import</span> decode_header</div><div class="line"><span class="keyword">from</span> email.utils <span class="keyword">import</span> parseaddr</div><div class="line"></div><div class="line"><span class="keyword">import</span> poplib</div><div class="line"></div><div class="line"><span class="comment"># 输入邮件地址, 口令和POP3服务器地址:</span></div><div class="line">email = input(<span class="string">'Email: '</span>)</div><div class="line">password = input(<span class="string">'Password: '</span>)</div><div class="line">pop3_server = input(<span class="string">'POP3 server: '</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">guess_charset</span><span class="params">(msg)</span>:</span></div><div class="line">    charset = msg.get_charset()</div><div class="line">    <span class="keyword">if</span> charset <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        content_type = msg.get(<span class="string">'Content-Type'</span>, <span class="string">''</span>).lower()</div><div class="line">        pos = content_type.find(<span class="string">'charset='</span>)</div><div class="line">        <span class="keyword">if</span> pos &gt;= <span class="number">0</span>:</div><div class="line">            charset = content_type[pos + <span class="number">8</span>:].strip()</div><div class="line">    <span class="keyword">return</span> charset</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">decode_str</span><span class="params">(s)</span>:</span></div><div class="line">    value, charset = decode_header(s)[<span class="number">0</span>]</div><div class="line">    <span class="keyword">if</span> charset:</div><div class="line">        value = value.decode(charset)</div><div class="line">    <span class="keyword">return</span> value</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_info</span><span class="params">(msg, indent=<span class="number">0</span>)</span>:</span></div><div class="line">    <span class="keyword">if</span> indent == <span class="number">0</span>:</div><div class="line">        <span class="keyword">for</span> header <span class="keyword">in</span> [<span class="string">'From'</span>, <span class="string">'To'</span>, <span class="string">'Subject'</span>]:</div><div class="line">            value = msg.get(header, <span class="string">''</span>)</div><div class="line">            <span class="keyword">if</span> value:</div><div class="line">                <span class="keyword">if</span> header==<span class="string">'Subject'</span>:</div><div class="line">                    value = decode_str(value)</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    hdr, addr = parseaddr(value)</div><div class="line">                    name = decode_str(hdr)</div><div class="line">                    value = <span class="string">u'%s &lt;%s&gt;'</span> % (name, addr)</div><div class="line">            print(<span class="string">'%s%s: %s'</span> % (<span class="string">'  '</span> * indent, header, value))</div><div class="line">    <span class="keyword">if</span> (msg.is_multipart()):</div><div class="line">        parts = msg.get_payload()</div><div class="line">        <span class="keyword">for</span> n, part <span class="keyword">in</span> enumerate(parts):</div><div class="line">            print(<span class="string">'%spart %s'</span> % (<span class="string">'  '</span> * indent, n))</div><div class="line">            print(<span class="string">'%s--------------------'</span> % (<span class="string">'  '</span> * indent))</div><div class="line">            print_info(part, indent + <span class="number">1</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        content_type = msg.get_content_type()</div><div class="line">        <span class="keyword">if</span> content_type==<span class="string">'text/plain'</span> <span class="keyword">or</span> content_type==<span class="string">'text/html'</span>:</div><div class="line">            content = msg.get_payload(decode=<span class="keyword">True</span>)</div><div class="line">            charset = guess_charset(msg)</div><div class="line">            <span class="keyword">if</span> charset:</div><div class="line">                content = content.decode(charset)</div><div class="line">            print(<span class="string">'%sText: %s'</span> % (<span class="string">'  '</span> * indent, content + <span class="string">'...'</span>))</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            print(<span class="string">'%sAttachment: %s'</span> % (<span class="string">'  '</span> * indent, content_type))</div><div class="line"></div><div class="line"><span class="comment"># 连接到POP3服务器:</span></div><div class="line">server = poplib.POP3(pop3_server)</div><div class="line"><span class="comment"># 可以打开或关闭调试信息:</span></div><div class="line">server.set_debuglevel(<span class="number">1</span>)</div><div class="line"><span class="comment"># 可选:打印POP3服务器的欢迎文字:</span></div><div class="line">print(server.getwelcome().decode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="comment"># 身份认证:</span></div><div class="line">server.user(email)</div><div class="line">server.pass_(password)</div><div class="line"><span class="comment"># stat()返回邮件数量和占用空间:</span></div><div class="line">print(<span class="string">'Messages: %s. Size: %s'</span> % server.stat())</div><div class="line"><span class="comment"># list()返回所有邮件的编号:</span></div><div class="line">resp, mails, octets = server.list()</div><div class="line"><span class="comment"># 可以查看返回的列表类似[b'1 82923', b'2 2184', ...]</span></div><div class="line">print(mails)</div><div class="line"><span class="comment"># 获取最新一封邮件, 注意索引号从1开始:</span></div><div class="line">index = len(mails)</div><div class="line">resp, lines, octets = server.retr(index)</div><div class="line"><span class="comment"># lines存储了邮件的原始文本的每一行,</span></div><div class="line"><span class="comment"># 可以获得整个邮件的原始文本:</span></div><div class="line">msg_content = <span class="string">b'\r\n'</span>.join(lines).decode(<span class="string">'utf-8'</span>)</div><div class="line"><span class="comment"># 稍后解析出邮件:</span></div><div class="line">msg = Parser().parsestr(msg_content)</div><div class="line">print_info(msg)</div><div class="line"><span class="comment"># 可以根据邮件索引号直接从服务器删除邮件:</span></div><div class="line"><span class="comment"># server.dele(index)</span></div><div class="line"><span class="comment"># 关闭连接:</span></div><div class="line">server.quit()</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/09/13.virtualenv&图形界面/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/09/13.virtualenv&图形界面/" itemprop="url">13. virtualenv&图形界面</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T15:08:02+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="virtualenv-amp-图形界面"><a href="#virtualenv-amp-图形界面" class="headerlink" title="virtualenv&amp;图形界面"></a>virtualenv&amp;图形界面</h1><h2 id="virtualenv"><a href="#virtualenv" class="headerlink" title="virtualenv"></a>virtualenv</h2><p>在开发Python应用程序的时候，系统安装的Python只有一个3.5版本。所有的第三方包都会被安装到Python3的<code>site-packages</code>目录下。</p>
<p>如果要同时开发多个应用程序，那么这些应用程序共用一个Python3.5，如果应用A需要jinja2.7，应用B需要jinja2.6，这时候需要用virtualenv来为一个应用创建一套隔离的Python运行环境。</p>
<p>第一步，创建项目文件夹myproject，在该文件夹中安装虚拟环境env：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;mkdir myproject</div><div class="line">D:\笔记\Python\Notepad++&gt;cd myproject</div><div class="line">D:\笔记\Python\Notepad++\myproject&gt;dir</div><div class="line"> 驱动器 D 中的卷是 文件</div><div class="line"> 卷的序列号是 <span class="number">0</span>BE3<span class="number">-0E5</span>C</div><div class="line"></div><div class="line"> D:\笔记\Python\Notepad++\myproject 的目录</div><div class="line"></div><div class="line"><span class="number">2016</span>/<span class="number">11</span>/<span class="number">06</span>  <span class="number">20</span>:<span class="number">01</span>    &lt;DIR&gt;          .</div><div class="line"><span class="number">2016</span>/<span class="number">11</span>/<span class="number">06</span>  <span class="number">20</span>:<span class="number">01</span>    &lt;DIR&gt;          ..</div><div class="line">               <span class="number">0</span> 个文件              <span class="number">0</span> 字节</div><div class="line">               <span class="number">2</span> 个目录 <span class="number">104</span>,<span class="number">178</span>,<span class="number">057</span>,<span class="number">216</span> 可用字节</div><div class="line"></div><div class="line">D:\笔记\Python\Notepad++\myproject&gt;virtualenv env</div><div class="line">Using base prefix <span class="string">'c:\\users\\cdxu0\\appdata\\local\\programs\\python\\python35'</span></div><div class="line">New python executable <span class="keyword">in</span> D:\笔记\Python\Notepad++\myproject\env\Scripts\python.exe</div><div class="line">Installing setuptools, pip, wheel...done.</div></pre></td></tr></table></figure></p>
<p>第二步，启动虚拟环境，安装所需库类。在windows中虚拟环境的启动使用命令：your_env_dir\Scripts\activate，默认情况下，virtualenv已经安装好了pip。在启动虚拟环境后直接使用pip install命令就可以为该虚拟环境安装库类。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++\myproject&gt;cd env\Scripts</div><div class="line"></div><div class="line">D:\笔记\Python\Notepad++\myproject\env\Scripts&gt;activate</div><div class="line"></div><div class="line">(env) D:\笔记\Python\Notepad++\myproject\env\Scripts&gt;pip install flask==<span class="number">0.9</span></div></pre></td></tr></table></figure></p>
<p>第三步，在虚拟环境中可以运行脚本等操作，离开虚拟环境，使用deactivate命令。</p>
<hr>
<h2 id="图形界面"><a href="#图形界面" class="headerlink" title="图形界面"></a>图形界面</h2><p>Python支持多种图形界面的第三方库，比如：Tk，wxWidgets ，Qt，GTK等。但是Python自带的库是支持Tk的TKinter，使用Tkinter，无需安装任何包就可以直接使用。</p>
<p>使用TKinter十分简单，第一步导入TKinter包的所有内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</div></pre></td></tr></table></figure></p>
<p>第二步从<code>Frame</code>派生一个<code>Application</code>类，这是所有Widget的父容器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(Frame)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,master=None)</span>:</span></div><div class="line">		Frame.__init__(self,master)</div><div class="line">		self.pack()</div><div class="line">		self.createWidgets()</div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">createWidgets</span><span class="params">(self)</span>:</span></div><div class="line">		self.helloLabel=Label(self, text=<span class="string">'Hello, world!'</span>)</div><div class="line">		self.helloLabel.pack()</div><div class="line">		self.quitButton=Button(self, text=<span class="string">'Quit'</span>, command=self.quit)</div><div class="line">		self.quitButton.pack()</div></pre></td></tr></table></figure></p>
<p>在GUI中，每个Button、Label、输入框等，都是一个Widget。Frame则是可以容纳其他Widget的Widget，所有的Widget组合起来就是一棵树。</p>
<p><code>pack()</code>方法把Widget加入到父容器中，并实现布局。<code>pack()</code>是最简单的布局，<code>grid()</code>可以实现更复杂的布局。</p>
<p>在<code>createWidgets()</code>方法中，我们创建一个<code>Label</code>和一个<code>Button</code>，当Button被点击时，触发<code>self.quit()</code>使得程序退出。</p>
<p>第三步，实例化<code>Application</code>，并启动消息循环：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>app=Application()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app.master.title(<span class="string">'Hello world!'</span>)</div><div class="line"><span class="string">''</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>app.mainloop()</div></pre></td></tr></table></figure></p>
<p>GUI程序的主线负责监听来自操作系统的消息，并依次处理每一条消息。因此，如果消息处理非常耗时，就需要新线程中处理。运行这个GUI程序：<br><img src="/img/1478439318915.png" alt="Alt text"></p>
<p>点击Quit按钮或者窗口的x结束程序。</p>
<h3 id="输入文本"><a href="#输入文本" class="headerlink" title="输入文本"></a>输入文本</h3><p>我们再对这个GUI程序改进一下，加入一个文本框，让用户可以输入文本，然后点按钮后，弹出消息对话框。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment">#-*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> tkinter <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> tkinter.messagebox <span class="keyword">as</span> messagebox</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span><span class="params">(Frame)</span>:</span></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,master=None)</span>:</span></div><div class="line">		Frame.__init__(self,master)</div><div class="line">		self.pack()</div><div class="line">		self.createWidgets()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">createWidgets</span><span class="params">(self)</span>:</span></div><div class="line">		self.nameInput=Entry(self)</div><div class="line">		self.nameInput.pack()</div><div class="line">		self.alterButton=Button(self, text=<span class="string">'Hello'</span>, command=self.hello)</div><div class="line">		self.alterButton.pack()</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(self)</span>:</span></div><div class="line">		name=self.nameInput.get() <span class="keyword">or</span> <span class="string">'world'</span></div><div class="line">		messagebox.showinfo(<span class="string">'Message'</span>,<span class="string">'Hello, %s'</span> %name)</div><div class="line"></div><div class="line">app=Application()</div><div class="line">app.master.title(<span class="string">'Hello World'</span>)</div><div class="line">app.mainloop()</div></pre></td></tr></table></figure></p>
<p>当用户点击按钮时，出发<code>hello()</code>,通过<code>self.nameInput.get()</code>获得用户输入的文本后，使用<code>tkMessageBox.showinfo()</code>可以弹出消息对话框：<br><img src="/img/1478440468867.png" alt="Alt text"><br><img src="/img/1478440493401.png" alt="Alt text"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/08/17.异步IO/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/08/17.异步IO/" itemprop="url">17. 异步IO</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-08T17:58:50+08:00">
                2017-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h1><p>在IO编程中我们知道CPU的速度远远快于磁盘网络等IO。在一个线程中，CPU执行代码的速度极快，然而一旦遇到IO操作，比如读写文件、发送网络数据时，就需要等待IO操作完成，才能进行下一步操作，这种情况称为同步IO。</p>
<p>在IO操作的过程中，当前线程被挂起，而其他需要CPU执行的代码就无法被当前线程执行了。因为一个IO操作就阻塞了当前线程，导致代码无法执行，所以我们必须使用多线程或者多进程并发执行代码，为多个用户服务。每个用户都会分配一个线程，如果遇到IO导致线程被挂起，其他用户的线程不受影响。</p>
<p>多线程和多进程的模型虽然解决了并发问题，但是系统不能无上限地增加线程。由于系统切换线程的开销也很大，所以，线程一旦过多，CPU的时间就花在线程切换上了，导致性能下降。</p>
<p>由于我们要解决的问题是CPU告诉执行能力和IO设备的龟速严重不匹配，多线程和多进程只是解决这一问题的一种方法。另一种方法是异步IO。当代码需要执行一个耗时的IO操作时，它只发出IO指令并不等待IO结果。然后去执行其他代码，一段时间后，当IO结果返回时，再通知CPU进行处理。</p>
<p>可以知道，普通顺序写的代码是无法完成异步IO的，异步IO模型需要一个消息循环，在消息循环中，主线程不断的重复着“读取消息-处理消息”这一过程：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">loop = get_event_loop()</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	event = loop.get_event()</div><div class="line">	process_event(event)</div></pre></td></tr></table></figure></p>
<p>消息模型其实早就应用在桌面程序中了，一个GUI程序的主线程就负责不停地读取消息并处理消息。所有的键盘、鼠标等消息都被发送到GUI程序的消息队列中，然后由GUI程序的主线程处理。由于GUI线程处理键盘鼠标等消息的速度非常快、所以用户感觉不到延迟。某些情况下，GUI线程会在一个消息处理的过程中遇到问题导致一次消息处理时间过长，此时用户会感觉到整个GUI程序停止响应了，敲键盘鼠标都没有反应。这种情况说明在消息模型中，处理一个消息必须非常迅速，否则主线程将无法及时处理消息队列中的其他消息，导致程序看上去停止响应。</p>
<p>当遇到IO操作时，代码只负责发送IO请求，不等待IO结果，然后直接结束本轮消息处理，进入下一轮操作处理过程。当IO操作完成后，将受到一条IO完成的消息，处理该消息时就可以直接获取IO操作的结果。</p>
<p>在发出IO请求到受到IO完成这段时间里面，同步IO模型下，主线程只能挂起，但是异步IO模型下，主线程并没有休息，而是在消息循环中继续处理其他消息。这样在异步IO下，一个线程就可以同时处理多个IO请求，并且没有切换线程的操作。对大多数IO密集型程序，异步IO会大大提高系统的多任务处理能力。</p>
<hr>
<h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h2><p>协程，又称微线程、 钎程。英文名Coroutine。</p>
<p>子程序或者成为函数，在所有语言中都是层级调用，比如A调用B，B在执行过程中又调用了C，C执行完毕返回，B执行完毕返回，A执行完毕。所以子程序调用是通过栈实现的，一个线程就是执行一个子程序。子程序调用总是一个入口一个返回，调用顺序是明确的。而协程的调用和子程序不同。</p>
<p>协程看上去也是子程序，但是在执行过程中，在子程序内部可中断，然后转而执行别的子程序，在适当的时候再返回来接着执行。注意在一个子程序中中断，去执行其他子程序，不是调用函数，有点类似CPU中断。比如子程序A、B：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">def A():</div><div class="line">    print(&apos;1&apos;)</div><div class="line">    print(&apos;2&apos;)</div><div class="line">    print(&apos;3&apos;)</div><div class="line"></div><div class="line">def B():</div><div class="line">    print(&apos;x&apos;)</div><div class="line">    print(&apos;y&apos;)</div><div class="line">    print(&apos;z&apos;)</div></pre></td></tr></table></figure></p>
<p>假设由协程执行，在执行A的过程中，可以随时中断，去执行B，B也可能在执行中中断再去执行A，结果可能是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">x</div><div class="line">y</div><div class="line">3</div><div class="line">z</div></pre></td></tr></table></figure></p>
<p>但是再A总是没有调用B的，所以协程的调用比起函数调用理解要难。</p>
<p>看起来A、B的执行有点像多线程，但协程的特点在于是一个线程执行。和多线程相比，协程最大的优势就是极高的执行效率。因为子程序切换不是线程切换，而是程序自身控制的 ，因此没有线程切换的开销，和多线程相比，线程数量越多，协程的性能优势就越明显。</p>
<p>第二大优势就是不休要多线程的锁机制，因为只有一个线程，也不存在同时写和变量冲突，在协程中控制共享资源不加锁，只需要判断状态就好了，所以执行效率比多线程高很多。</p>
<p>协程是一个线程执行，为了利用多核CPU，可以用多进程+协程，即充分利用多核，又充分发挥协程的高效率，可获得奇高的性能。</p>
<p>Python对协程的支持是通过generator实现的。</p>
<p>在generator中，我们不但可以通过<code>for</code>循环来迭代，还可以不断调用<code>next()</code>函数获取由<code>yield</code>语句返回下一个值。但是Python的<code>yield</code>不但可以返回一个值，还可以接收调用者发出的参数。</p>
<p>例如：传统的生产者-消费者模型就是一个线程写消息，一个线程取消息，通过锁机制控制队列和等待，但一不小心就可能死锁。如果改用协程，生产者生产消息后，直接通过yield跳转到消费者开始执行，等消费者执行完毕后，切换回生产者继续生产，效率极高：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">consumer</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    r=<span class="string">''</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="meta">... </span>            n = <span class="keyword">yield</span> r</div><div class="line"><span class="meta">... </span>            <span class="keyword">if</span> <span class="keyword">not</span>  n:</div><div class="line"><span class="meta">... </span>                    <span class="keyword">return</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'[CONSUMER] Consuming %s...'</span> % n )</div><div class="line"><span class="meta">... </span>            r=<span class="string">'200 OK'</span></div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">produce</span><span class="params">(c)</span>:</span></div><div class="line"><span class="meta">... </span>    c.send(<span class="keyword">None</span>)</div><div class="line"><span class="meta">... </span>    n=<span class="number">0</span></div><div class="line"><span class="meta">... </span>    <span class="keyword">while</span> n &lt; <span class="number">5</span>:</div><div class="line"><span class="meta">... </span>            n = n + <span class="number">1</span></div><div class="line"><span class="meta">... </span>            print(<span class="string">'[PRODUCER] Producing %s...'</span> %n)</div><div class="line"><span class="meta">... </span>            r = c.send(n)</div><div class="line"><span class="meta">... </span>            print(<span class="string">'[PRODUCER] Consumer return: %s'</span> % r )</div><div class="line"><span class="meta">... </span>    c.close()</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = consumer()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>produce(c)</div><div class="line">[PRODUCER] Producing <span class="number">1.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">1.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">2.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">2.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">3.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">3.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">4.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">4.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div><div class="line">[PRODUCER] Producing <span class="number">5.</span>..</div><div class="line">[CONSUMER] Consuming <span class="number">5.</span>..</div><div class="line">[PRODUCER] Consumer <span class="keyword">return</span>: <span class="number">200</span> OK</div></pre></td></tr></table></figure></p>
<p>注意到<code>consumer</code>函数是一个<code>generator</code>，把一个<code>consumer</code>传入<code>produce</code>后：</p>
<p>1、首先调用<code>c.send(None)</code>启动生成器；<br>2、一旦产生了东西，通过<code>c.send(n)</code>切换到<code>consumer</code>执行<br>3、<code>consumer</code>通过<code>yield</code>拿到消息，处理，又通过<code>yield</code>把结果传回。<br>4、<code>produce</code>拿到<code>consumer</code>处理的结果，继续生产下一条消息<br>5、<code>produce</code>决定不生产了，通过<code>c.close()</code>关闭<code>consumer</code>整个过程结束。</p>
<p>整个流程无锁，由一个线程执行，<code>produce</code>和<code>consumer</code>协作完成任务，所以称为协程。</p>
<hr>
<h2 id="asyncio"><a href="#asyncio" class="headerlink" title="asyncio"></a>asyncio</h2><p><code>asyncio</code>是python3.4版本引入的标准库，直接内置了对异步IO的支持。<code>asyncio</code>的编程模型就是一个消息循环。我们从<code>asyncio</code>模块中直接获取一个<code>Eventloop</code>的引用，然后把需要执行的协程扔到<code>Eventloop</code>中执行，就实现了异步IO。</p>
<p>用<code>asyncio</code>实现<code>Hello world</code>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> asyncio</div><div class="line">&gt;&gt;&gt;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>@asyncio.coroutine</div><div class="line"><span class="meta">... </span><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line"><span class="meta">... </span>    print(<span class="string">"Hello world!!"</span>)</div><div class="line"><span class="meta">... </span>    r=<span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</div><div class="line"><span class="meta">... </span>    print(<span class="string">"Hello again!"</span>)</div><div class="line">...</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop = asyncio.get_event_loop()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop.run_until_complete(hello())</div><div class="line">Hello world!!</div><div class="line">Hello again!</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>loop.close()</div></pre></td></tr></table></figure></p>
<p><code>@asyncio.coroutine</code>把一个generator标记为coroutine类型，然后，我们就把这个Coroutine扔到Eventloop中执行。</p>
<p><code>hello()</code>首先打印出<code>Hello world!!</code>，然后，<code>yield from</code>语法可以让我们方便的调用另一个<code>generator</code>。由于<code>asyncio.sleep()</code>也是一个Coroutine，所以线程不会等待<code>asyncio.sleep()</code>，而是直接中断并执行下一个消息循环。当<code>asyncio.sleep()</code>返回时，线程就可以从<code>yield from</code>拿到返回值，然后接着执行下一行语句。</p>
<p>把<code>asyncio.sleep(1)</code>看做一个耗时1秒的IO操作，在此期间，主线程并未等待，而是去执行<code>Eventloop</code>中其他可以执行的coroutine了，因此可以实现并发执行。</p>
<p>用Task封装两个<code>coroutine</code>：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">	print(<span class="string">'Hello world! (%s)'</span> % threading.currentThread())</div><div class="line">	<span class="keyword">yield</span> <span class="keyword">from</span> asyncio.sleep(<span class="number">1</span>)</div><div class="line">	print(<span class="string">'Hello again! (%s)'</span> % threading.currentThread())</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">tasks = [hello(), hello()]</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div><div class="line">loop.close()</div></pre></td></tr></table></figure></p>
<p>结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python 1.1.py</div><div class="line">Hello world! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">Hello world! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">#（停顿1s）</div><div class="line">Hello again! (&lt;_MainThread(MainThread, started 20036)&gt;)</div><div class="line">Hello again! (&lt;_MainThread(MainThread, started 20036)&gt;)</div></pre></td></tr></table></figure></p>
<p>由打印出来的当前线程可以看出，两个<code>continue</code>是由同一个线程并发执行的。如果把<code>asyncio.sleep()</code>换成真正的IO操作，则多个<code>coroutine</code>就可以由一个线程并发执行。我们用<code>asyncio</code>的异步网络连接来获取sina、sohu和163的网站首页：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="meta">@asyncio.coroutine</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">wget</span><span class="params">(host)</span>:</span></div><div class="line">	print(<span class="string">'wget %s...'</span> % host)</div><div class="line">	connect = asyncio.open_connection(host, <span class="number">80</span>)</div><div class="line">	reader, writer = <span class="keyword">yield</span> <span class="keyword">from</span> connect</div><div class="line">	header = <span class="string">'GET / HTTP/1.0\r\nHost: %s\r\n\r\n'</span> %host</div><div class="line">	writer.write(header.encode(<span class="string">'utf-8'</span>))</div><div class="line">	<span class="keyword">yield</span> <span class="keyword">from</span> writer.drain()</div><div class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">		line = <span class="keyword">yield</span> <span class="keyword">from</span> reader.readline()</div><div class="line">		<span class="keyword">if</span> line == <span class="string">b'\r\n'</span>:</div><div class="line">			<span class="keyword">break</span></div><div class="line">		print(<span class="string">'%s header &gt; %s'</span> %(host, line.decode(<span class="string">'utf-8'</span>).rstrip()))</div><div class="line">	writer.close()</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">tasks = [wget(host) <span class="keyword">for</span> host <span class="keyword">in</span>[<span class="string">'www.sina.com.cn'</span>, <span class="string">'www.sohu.com'</span>, <span class="string">'www.163.com'</span>]]</div><div class="line">loop.run_until_complete(asyncio.wait(tasks))</div><div class="line">loop.close()</div></pre></td></tr></table></figure></p>
<p>执行结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python <span class="number">1.2</span>.py</div><div class="line">wget www.sina.com.cn...</div><div class="line">wget www<span class="number">.163</span>.com...</div><div class="line">wget www.sohu.com...</div><div class="line">www.sina.com.cn header &gt; HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">www.sina.com.cn header &gt; Server: nginx</div><div class="line">www.sina.com.cn header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">29</span> GMT</div><div class="line">www.sina.com.cn header &gt; Content-Type: text/html</div><div class="line">www.sina.com.cn header &gt; Last-Modified: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">17</span>:<span class="number">02</span> GMT</div><div class="line">www.sina.com.cn header &gt; Vary: Accept-Encoding</div><div class="line">www.sina.com.cn header &gt; Expires: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">18</span>:<span class="number">29</span> GMT</div><div class="line">www.sina.com.cn header &gt; Cache-Control: max-age=<span class="number">60</span></div><div class="line">www.sina.com.cn header &gt; X-Powered-By: shci_v1<span class="number">.03</span></div><div class="line">www.sina.com.cn header &gt; Age: <span class="number">50</span></div><div class="line">www.sina.com.cn header &gt; Content-Length: <span class="number">595123</span></div><div class="line">www.sina.com.cn header &gt; X-Cache: HIT <span class="keyword">from</span> ja108<span class="number">-181.</span>sina.com.cn</div><div class="line">www.sina.com.cn header &gt; Connection: close</div><div class="line">www<span class="number">.163</span>.com header &gt; HTTP/<span class="number">1.0</span> <span class="number">302</span> Moved Temporarily</div><div class="line">www<span class="number">.163</span>.com header &gt; Server: Cdn Cache Server V2<span class="number">.0</span></div><div class="line">www<span class="number">.163</span>.com header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">21</span>:<span class="number">18</span> GMT</div><div class="line">www<span class="number">.163</span>.com header &gt; Content-Length: <span class="number">0</span></div><div class="line">www<span class="number">.163</span>.com header &gt; Location: http://www<span class="number">.163</span>.com/special/<span class="number">0077j</span>t/error_isp.html</div><div class="line">www<span class="number">.163</span>.com header &gt; Connection: close</div><div class="line">www.sohu.com header &gt; HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">www.sohu.com header &gt; Content-Type: text/html</div><div class="line">www.sohu.com header &gt; Content-Length: <span class="number">90665</span></div><div class="line">www.sohu.com header &gt; Connection: close</div><div class="line">www.sohu.com header &gt; Date: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">18</span>:<span class="number">29</span> GMT</div><div class="line">www.sohu.com header &gt; Server: SWS</div><div class="line">www.sohu.com header &gt; Vary: Accept-Encoding</div><div class="line">www.sohu.com header &gt; Cache-Control: no-transform, max-age=<span class="number">120</span></div><div class="line">www.sohu.com header &gt; Expires: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">20</span>:<span class="number">29</span> GMT</div><div class="line">www.sohu.com header &gt; Last-Modified: Mon, <span class="number">14</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">04</span>:<span class="number">28</span> GMT</div><div class="line">www.sohu.com header &gt; Content-Encoding: gzip</div><div class="line">www.sohu.com header &gt; X-RS: <span class="number">10511343.19686393</span><span class="number">.11189627</span></div><div class="line">www.sohu.com header &gt; FSS-Cache: HIT <span class="keyword">from</span> <span class="number">9580427.16723861</span><span class="number">.11355128</span></div><div class="line">www.sohu.com header &gt; FSS-Proxy: Powered by <span class="number">3944245.5451583</span><span class="number">.5718860</span></div></pre></td></tr></table></figure></p>
<p>三个连接是由一个线程通过Coroutine并发完成。</p>
<p><code>asyncio</code>提供了完善的异步IO支持，异步操作需要在<code>coroutine</code>中通过<code>yield from</code>完成，多个<code>coroutine</code>可以封装一组Task然后并发执行。</p>
<hr>
<h2 id="async-await"><a href="#async-await" class="headerlink" title="async/await"></a>async/await</h2><p>用<code>asyncio</code>提供的<code>@asyncio.coroutine</code>可以把一个generator标记为coroutine类型，然后在coroutine内部用<code>yield from</code>调用另一个coroutine实现异步操作。</p>
<p>为了简化并更好地标示异步IO，从python3.5开始引入了新的语法<code>async</code>和<code>await</code>，可以让Coroutine的代码更加简洁易读。</p>
<p><code>async</code>和<code>await</code>是针对coroutine的新语法，要使用新的语法，只需要做两步简单的替换：</p>
<blockquote>
<p>1、把<code>@asyncio.coroutine</code>替换为<code>async</code><br>2、把<code>yield from</code>替换为<code>await</code></p>
</blockquote>
<p>对比一下上一节的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#old</div><div class="line">@asyncio.coroutine</div><div class="line">def hello():</div><div class="line">	print(&apos;Hello world! (%s)&apos; % threading.currentThread())</div><div class="line">	yield from asyncio.sleep(1)</div><div class="line">	print(&apos;Hello again! (%s)&apos; % threading.currentThread())</div><div class="line"></div><div class="line">#new</div><div class="line">async def hello():</div><div class="line">	print(&apos;Hello world! (%s)&apos; % threading.currentThread())</div><div class="line">	await asyncio.sleep(1)</div><div class="line">	print(&apos;Hello again! (%s)&apos; % threading.currentThread())</div></pre></td></tr></table></figure></p>
<p>剩下代码保持不变。</p>
<hr>
<h2 id="aiohttp"><a href="#aiohttp" class="headerlink" title="aiohttp"></a>aiohttp</h2><p><code>asyncio</code>可以实现单线程并发IO操作。如果仅用在客户端，发挥的威力不大。如果把<code>asyncio</code>用在服务器端，例如Web服务器，由于HTTP连接就是IO操作，因此可以用单线程+<code>cortinue</code>实现多用户的高并发支持。</p>
<p><code>asyncio</code>实现了TCP、UDP、SSL等协议，<code>aiohttp</code>则是基于<code>asyncio</code>实现了HTTP框架。</p>
<p>安装<code>aiohttp</code>然后编写一个HTTP服务器，分别处理以下URL：</p>
<blockquote>
<p><code>/</code>-首页返回<code>b&#39;&lt;h1&gt;Index&lt;/h1&gt;&#39;</code><br><code>/hello/{name}</code>-根据URL参数返回文本<code>hello, %s!</code></p>
</blockquote>
<p>代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python3</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> asyncio</div><div class="line"></div><div class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</div><div class="line">    <span class="keyword">return</span> web.Response(body=<span class="string">b'&lt;h1&gt;Index&lt;/h1&gt;'</span>)</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</div><div class="line">    text = <span class="string">'&lt;h1&gt;hello, %s!&lt;/h1&gt;'</span> % request.match_info[<span class="string">'name'</span>]</div><div class="line">    <span class="keyword">return</span> web.Response(body=text.encode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(loop)</span>:</span></div><div class="line">    app = web.Application(loop=loop)</div><div class="line">    app.router.add_route(<span class="string">'GET'</span>, <span class="string">'/'</span>, index)</div><div class="line">    app.router.add_route(<span class="string">'GET'</span>, <span class="string">'/hello/&#123;name&#125;'</span>, hello)</div><div class="line">    srv = <span class="keyword">await</span> loop.create_server(app.make_handler(), <span class="string">'127.0.0.1'</span>, <span class="number">8000</span>)</div><div class="line">    print(<span class="string">'Server started at http://127.0.0.1:8000...'</span>)</div><div class="line">    <span class="keyword">return</span> srv</div><div class="line"></div><div class="line">loop = asyncio.get_event_loop()</div><div class="line">loop.run_until_complete(init(loop))</div><div class="line">loop.run_forever()</div></pre></td></tr></table></figure></p>
<p>注意<code>aiohttp</code>的初始化函数<code>init()</code>也是一个<code>coroutine</code>，<code>loop.creat_server()</code>则利用<code>asyncio</code>创建TCP服务。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/08/14.网络编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/08/14.网络编程/" itemprop="url">14. 网络编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-08T17:58:50+08:00">
                2017-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="网络编程"><a href="#网络编程" class="headerlink" title="网络编程"></a>网络编程</h1><p>现在几乎所有的程序都是网络程序，很少有单机版的程序了。计算机网络就是把各个计算机连接到一起，让网络中的计算机可以互相通信。网络编程就是如何在程序中实现两台计算机的通信。比如当你使用浏览器浏览新浪网时，你的计算机就和新浪的某台服务器通过互联网连接起来了，然后新浪的服务器把网页内容作为数据通过互联网传输到你的电脑。由于电脑上有很多软件，不同的程序连接的别的计算机也会不同。网络通信是两台计算机上的两个进程之间的通信。</p>
<p>网络编程对所有开发语言都是一样的。用Python进行网络编程，就是在Python程序本身这个进程内，连接别的服务器进程的通信端口进行通信。</p>
<h3 id="TCP-IP简介"><a href="#TCP-IP简介" class="headerlink" title="TCP/IP简介"></a>TCP/IP简介</h3><p>计算机wield联网，必须规定通信协议，早期的计算机网络，都是由各厂商自己规定一套协议，IBM、Apple和Micosoft都有各自的网络协议，互不兼容，同样的网络协议的计算机可以互相交流，不同协议的计算机就不可以。</p>
<p>为了实现所有不同类型的计算机都连接起来，互联网协议簇（Internet Protocol Suite）就是通用协议标准。最主要的两个协议是TCP协议和IP协议。</p>
<p>通信的时候，双方必须知道对方的标识，互联网中每一个计算机的唯一标识就是IP地址。如果一台计算机同时接入两个或两个以上的网络，比如路由器，它就会有两个或更多个IP地址，所以IP地址对应的实际上是计算机的网络接口，通常是网卡。</p>
<p>IP协议负责把数据从一台计算机通过网络发送到另一台计算机。数据被分割成一小块一小块，然后通过IP包发送出去。由于互联网链路复杂，两台计算机之间经常有多条线路，因此路由器就负责决定如何把一个IP包转发出去。IP报的特点是按块发送，途径多个路由，但不保证能到达，也不保证顺利到达。</p>
<p>TCP协议是建立在IP协议之上的。TCP协议负责在两台计算机之间建立可靠连接，保证数据包按顺序到达。TCP协议会通过握手建立连接，然后对每个IP包进行编号，确保对方按顺序收到，如果包丢了，就自动重发。</p>
<p>一个IP包除了包含要传输的数据外，还包含源IP地址和目的IP地址，源端口和目的端口。</p>
<p>在两台计算机通信时，只发IP地址是不够的，因为同一台计算机上跑着多个网络程序。一个IP包来了之后，到底是交给浏览器还是QQ就需要端口号来区分。每个网络程序都向操作系统申请唯一的端口号这样，两个进程在两台计算机之间建立的网络连接就需要各自的IP地址和各自的端口号。一个进程也可能同时与多个计算机建立链接，因此会申请很多端口。</p>
<h2 id="TCP编程"><a href="#TCP编程" class="headerlink" title="TCP编程"></a>TCP编程</h2><p>Socket是网络编程的一个抽象概念。通常我们用一个Socket表示打开了一个网络链接，而打开一个Socket需要知道目标计算机的IP地址和端口号，再指定协议类型即可。</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>大多数连接都是可靠的TCP连接。创建TCP连接时，主动发起连接的叫客户端，被动相应连接的叫服务器。当我们在浏览器中访问新浪时，我们自己的计算机就是客户端，浏览器会主动向新浪的服务器发起连接。如果一切顺利，新浪的服务器接受了我们的连接，一个TCP连接就建立起来了，后面的通信就是发送网页内容了。所以我们要创建一个基于TCP的Socket：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div><div class="line">s.connect((<span class="string">'www.sina.com.cn'</span>,<span class="number">80</span>))</div></pre></td></tr></table></figure></p>
<p>创建<code>Socket</code>时，<code>AF_INET</code>指定使用IPv4协议，如果要用更先进的IPv6，就指定为<code>AF_INET6</code>。<code>SOCK_STREAM</code>指定使用面向流的TCP协议，这样一个<code>Socket</code>对象就创建成功，但是还没有建立连接。</p>
<p>客户端要主动发起TCP连接，必须知道服务器的IP地址和端口号。IP地址可以用域名自动转换得到，端口号需要服务器来提供。服务器提供什么样的服务，端口号就必须固定下来。80端口是WEB服务的标准端口。端口号小于1024的是Internet标准服务的端口，端口号大于1024的可以任意使用。</p>
<p>建立TCP连接后，我们可以向新浪服务器发送请求，要求返回首页的内容：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.send(<span class="string">b'GET / HTTP/1.1\r\nHost: www.sina.com.cn\r\nConnection: close\r\n\r\n'</span>)</div></pre></td></tr></table></figure></p>
<p>TCP连接创建的是双向通道，双方都可以同时给对方发数据。但是谁先发谁后发怎么协调要根据具体的协议来决定。例如，HTTP协议规定客户端必须先发请求给服务器，服务器收到后才发数据给客户端。发送的文本格式必须符合HTTP标准，如果格式没问题，接下来就可以接收新浪返回的数据了：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">buffer=[]</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	d=s.recv(<span class="number">1024</span>)</div><div class="line">	<span class="keyword">if</span> d:</div><div class="line">		buffer.append(d)</div><div class="line">	<span class="keyword">else</span>:</div><div class="line">		<span class="keyword">break</span></div><div class="line">data=<span class="string">b''</span>.join(buffer)</div></pre></td></tr></table></figure></p>
<p>接收数据时，调用<code>recv(max)</code>方法，一次最多接收指定的字节数，因此在一个while循环中反复接收，直到<code>recv()</code>返回空数据，表示接收完毕，退出循环。</p>
<p>当我们接收完出局后，调用<code>close()</code>方法关闭Socket，这样一次完整的网络通信就结束了。接收到的数据包括HTTP头和网页本身，我们只需要把HTTP头和网页分离一下，吧HTTP头打印出来，网页内容保存到文件：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">header, html = data.split(<span class="string">b'\r\n\r\n'</span>, <span class="number">1</span>)</div><div class="line">print(header.decode(<span class="string">'utf-8'</span>))</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'sina.html'</span>,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">	f.write(html)</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">D:\笔记\Python\Notepad++&gt;python <span class="number">11.</span>py</div><div class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</div><div class="line">Server: nginx</div><div class="line">Date: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">24</span>:<span class="number">26</span> GMT</div><div class="line">Content-Type: text/html</div><div class="line">Last-Modified: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">13</span> GMT</div><div class="line">Vary: Accept-Encoding</div><div class="line">Expires: Mon, <span class="number">07</span> Nov <span class="number">2016</span> <span class="number">12</span>:<span class="number">25</span>:<span class="number">26</span> GMT</div><div class="line">Cache-Control: max-age=<span class="number">60</span></div><div class="line">X-Powered-By: shci_v1<span class="number">.03</span></div><div class="line">Age: <span class="number">31</span></div><div class="line">Content-Length: <span class="number">597288</span></div><div class="line">X-Cache: HIT <span class="keyword">from</span> ja180<span class="number">-183.</span>sina.com.cn</div><div class="line">Connection: close</div></pre></td></tr></table></figure></p>
<h3 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h3><p>和客户端相比，服务器编程要复杂一些。服务器进程首先要绑定一份端口并监听来自其他客户端的连接。服务器会打开固定端口监听，每来一个客户端连接，就创建该Socket连接。由于服务器会有大量来自客户端的连接，所以服务器要能够区分一个Socket连接是和那个客户端绑定的。一个Socket依赖四项：服务器地址、服务器端口、客户端地址、客户端端口来唯一确定一个Socket。</p>
<p>每个连接都需要一个新的进程或者线程来处理，否则服务器一次就只能服务一个客户端了。我们来编写一个简单的服务器程序，它接收客户端连接，把客户端发过来的字符串加上<code>Hello</code>再发回去。首先创建一个基于IPv4和TCP协议的Socket：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)</div></pre></td></tr></table></figure></p>
<p>然后，我们要绑定监听的地址和端口。服务器可能有多块网卡，可以绑定到某一块网卡的IP地址上，也可以用<code>0.0.0.0</code>绑定到所有的网络地址，还可以用<code>127.0.0.1</code>绑定到本机地址。</p>
<p>端口号需要预先指定。因为我们写的这个服务不是标准服务，所以用9999这个端口号，小于1024的端口号必须有管理员权限才能绑定：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">s.blind(<span class="string">'127.0.0.1'</span>,<span class="number">9999</span>)</div></pre></td></tr></table></figure></p>
<p>紧接着，调用<code>listen()</code>方法开始监听，传入的参数指定等待连接的最大数量：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">s.listen(<span class="number">5</span>)</div><div class="line">print(<span class="string">'Waiting for connection...'</span>)</div></pre></td></tr></table></figure></p>
<p>接下来，服务器程序通过一个永久循环来接受来自客户端的连接，<code>accept()</code>会等待并返回一个客户端的连接：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">	sock.addr=s.accept()</div><div class="line">	t=threading.Thread(target==tcplink,args=(sock, addr))</div><div class="line">	t.start()</div></pre></td></tr></table></figure></p>
<p>每个连接都必须创建新的线程或进程来处理，否则，单线程在处理连接的过程中无法接受其他客户端的连接：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">tcplink</span><span class="params">(sock, addr)</span>:</span></div><div class="line">	print(<span class="string">'Accecpt new connection from %s:%s...'</span> %addr)</div><div class="line">	sock.send(<span class="string">b'Welcome!'</span>)</div><div class="line">	<span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">		data=sock.recv(<span class="number">1024</span>)</div><div class="line">		time.sleep(<span class="number">1</span>)</div><div class="line">		<span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> data.decode(<span class="string">'utf-8'</span>) == <span class="string">'exit'</span>:</div><div class="line">			<span class="keyword">break</span></div><div class="line">		sock.send((<span class="string">'Hello, %s!'</span> %data.decode(<span class="string">'utf-8'</span>)).encode(<span class="string">'utf-8'</span>))</div><div class="line">		sock.close()</div><div class="line">		print(<span class="string">'Connection from %s:%s closed.'</span> %addr)</div></pre></td></tr></table></figure></p>
<p>建立连接后，服务器首先发一条欢迎信息，然后等待客户端数据，并加上Hello再发送给客户端，如果客户端发送了exit字符串，就直接关闭连接。要测试这个程序，我们还需要编写一个客户端程序：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div><div class="line"><span class="comment"># 建立连接:</span></div><div class="line">s.connect((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div><div class="line"><span class="comment"># 接收欢迎消息:</span></div><div class="line">print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</div><div class="line">    <span class="comment"># 发送数据:</span></div><div class="line">    s.send(data)</div><div class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line">s.send(<span class="string">b'exit'</span>)</div><div class="line">s.close()</div></pre></td></tr></table></figure></p>
<p>用TCP协议进行Socket编程在Python中十分简单，对于客户端，要主动连接服务器的IP和指定端口，对于服务器，要首先监听指定端口，然后对每一个新的连接，创建一个线程或进程来处理。通常，服务器会无限运行下去。</p>
<hr>
<p>##UDP 编程</p>
<p>TCP建立的是可靠的连接，并且通信双方都可以以流的形式发送数据。UDP是面向无连接的协议。使用UDP时，不需要建立连接，只需要知道对方的IP地址和端口号，就可以直接发数据包，但是能够到达就不知道了。UDP的有点在于速度快，对于不要求可靠到达的数据，就可以使用UDP协议。</p>
<p>和TCP类似，使用UDP的通信双方也分为客户端和服务器，服务器首先需要绑定端口：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line"><span class="comment"># 绑定端口:</span></div><div class="line">s.bind((<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div></pre></td></tr></table></figure></p>
<p>创建Socket时，<code>SOCK_DGRAM</code>指定了这个Socket的类型是UDP。绑定端口和TCP一样，但是不需要调用<code>listen()</code>方法，而是直接接收来自任何客户端的数据。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">print(<span class="string">'Bind UDP on 9999...'</span>)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">    <span class="comment"># 接收数据:</span></div><div class="line">    data, addr = s.recvfrom(<span class="number">1024</span>)</div><div class="line">    print(<span class="string">'Received from %s:%s.'</span> % addr)</div><div class="line">    s.sendto(<span class="string">b'Hello, %s!'</span> % data, addr)</div></pre></td></tr></table></figure></p>
<p><code>recvform()</code>方法返回数据和客户端的地址与端口，这样，服务器收到数据后，直接调用<code>sendto()</code>就可以把数据用UDP发送给客户端了。</p>
<p>客户端使用UDP时，首先仍然创建基于UDP的Socket，然后不需要调用<code>connect()</code>直接通过<code>sendto()</code>给服务器发送数据：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</div><div class="line"><span class="keyword">for</span> data <span class="keyword">in</span> [<span class="string">b'Michael'</span>, <span class="string">b'Tracy'</span>, <span class="string">b'Sarah'</span>]:</div><div class="line">    <span class="comment"># 发送数据:</span></div><div class="line">    s.sendto(data, (<span class="string">'127.0.0.1'</span>, <span class="number">9999</span>))</div><div class="line">    <span class="comment"># 接收数据:</span></div><div class="line">    print(s.recv(<span class="number">1024</span>).decode(<span class="string">'utf-8'</span>))</div><div class="line">s.close()</div></pre></td></tr></table></figure></p>
<p>从服务器接收数据仍然调用<code>recv()</code>方法。</p>
<p>UDP的使用与TCP类似，但是不需要建立连接。此外，服务器绑定UDP端口和TCP端口互不冲突，也就是说，UDP的9999端口与TCP的9999端口可以各自绑定。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/struts2总结 五--interceptor拦截器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/struts2总结 五--interceptor拦截器/" itemprop="url">struts2总结（五）--interceptor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T14:51:07+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="8-拦截器-interceptor"><a href="#8-拦截器-interceptor" class="headerlink" title="8 拦截器(interceptor)"></a>8 拦截器(interceptor)</h2><h3 id="8-1-Struts架构图"><a href="#8-1-Struts架构图" class="headerlink" title="8.1 Struts架构图"></a>8.1 Struts架构图</h3><p>  <img src="/img/struts_arch.jpg" alt="Alt text"></p>
<h3 id="8-2-Struts执行过程分析"><a href="#8-2-Struts执行过程分析" class="headerlink" title="8.2 Struts执行过程分析"></a>8.2 Struts执行过程分析</h3><p><img src="/img/struts.png" alt="Alt text"></p>
<blockquote>
<ul>
<li>拦截器：拦截器是struts2框架中提供的一种Java类</li>
<li>作用：<pre><code>* 可以拦截访问Action的请求
* 给这个Action加上新的丰富功能（上传，参数自动接收，类型自动转换等）需要配置之后，指明哪一个拦截器去拦截哪一个Action或者哪一些Action，这个拦截器才会去拦截我们的Action。
</code></pre></li>
<li>拦截器工作原理：<pre><code>1. 有一个拦截器的类（框架的或者自定义的）
2. 在配置文件中把这个拦截器类配置出来
3. 指明这个拦截器要拦截哪一个或者哪一些action
4. 客户端发送一个请求访问一个被拦截器拦截的Action
5. 这个请求首先会被struts2 的filter所拦截，filter会检查这个请求是不是请求的Action，如果是，会再检查这个Action有没有被定义的拦截器所拦截，如果有，那么把这个请求交给拦截器去处理
</code></pre></li>
</ul>
</blockquote>
<h3 id="8-3-Interceptor拦截器过程模拟"><a href="#8-3-Interceptor拦截器过程模拟" class="headerlink" title="8.3  Interceptor拦截器过程模拟"></a>8.3  Interceptor拦截器过程模拟</h3><ul>
<li>定义一个Interceptor接口，有一个intercept方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public interface Inteceptor &#123;</div><div class="line">    public void intercept(ActionInvocation actionInvocation);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>创建两个interceptor实现了interceptor接口：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class FirstInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(1);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-1);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class SecondInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(2);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>定义一个Action</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class SecondInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(2);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>定义ActionInvocation</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class ActionInvocation &#123;</div><div class="line">    List&lt;Inteceptor&gt; inteceptors = new ArrayList&lt;&gt;();</div><div class="line">    int index = -1;</div><div class="line">    Action a = new Action();</div><div class="line"></div><div class="line">    public ActionInvocation() &#123;</div><div class="line">        this.inteceptors.add(new FirstInterceptor());</div><div class="line">        this.inteceptors.add(new SecondInterceptor());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void invoke() &#123;</div><div class="line">        index++;</div><div class="line">        if (index &gt;= this.inteceptors.size()) &#123;</div><div class="line">            a.execute();</div><div class="line">        &#125; else &#123;</div><div class="line">            this.inteceptors.get(index).intercept(this);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>执行main文件:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        new ActionInvocation().invoke();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>运行结果为：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">execute</div><div class="line">-2</div><div class="line">-1</div></pre></td></tr></table></figure>
<blockquote>
<p>从而执行顺序为，首先main函数，创建ActionInvocation对象，初始化的时候讲两个Inteceptor加到interceptors这个列表中，调用其invoke()方法，当还有interceptor没有访问时，调用第一个interceptor的intercept方法，输出1，并调用ActionInvocation的invoke方法，此时会调用第二个Inteceptor的intercept方法，输出2，并调用ActionInvocation的invoke方法，此时不存在拦截器，执行Action输出execute，后面依次输出-2 -1， 完成这个模拟过程！</p>
</blockquote>
<h3 id="8-4-定义自己的拦截器"><a href="#8-4-定义自己的拦截器" class="headerlink" title="8.4 定义自己的拦截器"></a>8.4 定义自己的拦截器</h3><ul>
<li><p>struts2框架已经写好了很多个拦截器，同时也把这些拦截器配置在配置文件里面struts-default.xml中，除此之外，我们可以写自己的拦截器</p>
</li>
<li><p>首先实现一个Interceptor接口：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class MyInterceptor implements Interceptor &#123;</div><div class="line"></div><div class="line">	public void destroy() &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void init() &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String intercept(ActionInvocation invocation) throws Exception &#123;</div><div class="line">		long start = System.currentTimeMillis();</div><div class="line">		String r = invocation.invoke();</div><div class="line">		long end = System.currentTimeMillis();</div><div class="line">		System.out.println(&quot;action time = &quot; + (end - start));</div><div class="line">		return r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>然后在struts.xml文件中配置出这个拦截器：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;test&quot; namespace=&quot;/&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">		&lt;interceptors&gt;</div><div class="line">			&lt;interceptor name=&quot;my&quot; class=&quot;com.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">		&lt;/interceptors&gt;</div><div class="line"></div><div class="line">		&lt;action name=&quot;test&quot; class=&quot;com.action.TestAction&quot;&gt;</div><div class="line">			&lt;result&gt;/test.jsp&lt;/result&gt;</div><div class="line">			&lt;interceptor-ref name=&quot;my&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">			&lt;interceptor-ref name=&quot;defaultStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">		&lt;/action&gt;</div><div class="line"></div><div class="line">	&lt;/package&gt;</div></pre></td></tr></table></figure>
<h3 id="8-5-拦截器栈"><a href="#8-5-拦截器栈" class="headerlink" title="8.5 拦截器栈"></a>8.5 拦截器栈</h3><p>当一个Action需要被多个拦截器拦截的时候，正常情况下我们需要在这个Action中去引用要使用的多个拦截器，但是我们可以使用一个拦截器栈去包含那几个拦截器，然后直接在Action中引用这个拦截器栈就可以。</p>
<ul>
<li>一个拦截器栈可以包含多个拦截器</li>
<li>一个拦截器栈还可以包含其他拦截器栈</li>
<li>定义拦截器栈都要在<interceptors>标签中</interceptors></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;interceptors&gt;</div><div class="line">   &lt;interceptor name=&quot;myInterceptor&quot; class=&quot;com.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">   &lt;interceptor-stack name=&quot;myStack&quot;&gt;</div><div class="line">   &lt;!-- 这是我们自己定义的一个拦截器 --&gt;</div><div class="line">      &lt;interceptor-ref name=&quot;myInterceptor&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">     &lt;!-- 这是struts-default.xml文件中定义的一个拦截器 --&gt;</div><div class="line">      &lt;interceptor-ref name=&quot;params&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">     &lt;!-- 这是struts-default.xml文件中定义的一个拦截器栈 --&gt;</div><div class="line">    &lt;interceptor-ref name=&quot;basicStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">   &lt;/interceptor-stack&gt;</div><div class="line">  &lt;/interceptors&gt;</div></pre></td></tr></table></figure>
<h3 id="8-6-默认拦截器栈-拦截器"><a href="#8-6-默认拦截器栈-拦截器" class="headerlink" title="8.6 默认拦截器栈/拦截器"></a>8.6 默认拦截器栈/拦截器</h3><p>在一个package中，我们可以把一个拦截器或者拦截器栈的声明为一个默认的拦截器/拦截器栈。以后这个package中所有的Action都会被这个默认的拦截器/拦截器栈所拦截</p>
<ul>
<li>我们写的任何Action都会被一个叫做defaultStack的拦截器栈所拦截，这个拦截器栈包含了十几个拦截器，这些拦截器给我们的Action提供了很多丰富的功能，因为我们写的所有的package都是直接或者间接继承了struts-default.xml文件中的一个名字叫struts-default的package， struts-default包中又把名字叫做defaultStack的拦截器栈配置成了一个默认的拦截器栈，我们的package继承了这个，所有的Action都会被defaultStack所拦截。</li>
<li>但是如果我们指明了一个Action被我们所写的一个拦截器/拦截器栈所拦截，name这个Action就不会被defaultStack拦截了，所以我们需要在Action中主动的在声明这个Action被defaultStack所拦截，或者把defaultStack加入到我们自己定义的拦截器栈里面。</li>
<li>也可以专门定义一个package专门定义拦截器，拦截器栈，其他package继承这个拦截器栈package：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 在这个package中,我们只定义拦截器/拦截器栈 --&gt;</div><div class="line">    &lt;package name=&quot;MyInter&quot; extends=&quot;struts-default&quot; namespace=&quot;/&quot;&gt;</div><div class="line"></div><div class="line">    &lt;interceptors&gt;</div><div class="line">        &lt;interceptor name=&quot;myInterceptor&quot; class=&quot;com.briup.web.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">        &lt;interceptor-stack name=&quot;myStack&quot;&gt;</div><div class="line">            &lt;interceptor-ref name=&quot;myInterceptor&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">            &lt;!-- 这是struts-default.xml文件中定义的一个拦截器栈 --&gt;</div><div class="line">            &lt;interceptor-ref name=&quot;defaultStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">        &lt;/interceptor-stack&gt;</div><div class="line">    &lt;/interceptors&gt;</div><div class="line"></div><div class="line">    &lt;!-- 声明默认拦截器/拦截器栈 --&gt;</div><div class="line">    &lt;!-- 当前包中所有的action都会被这个myStack所拦截器 --&gt;</div><div class="line">    &lt;!-- 继承了当前包的其他包里面的所有action也会被这个myStack所拦截器 --&gt;</div><div class="line">    &lt;default-interceptor-ref name=&quot;myStack&quot;&gt;&lt;/default-interceptor-ref&gt;</div><div class="line"></div><div class="line">    &lt;/package&gt;</div></pre></td></tr></table></figure>
<h3 id="8-7-类型转换"><a href="#8-7-类型转换" class="headerlink" title="8.7 类型转换"></a>8.7 类型转换</h3><p>类型转换：解析HTTP请求参数，将HTTP请求参数赋值给Action属性，当其类型不一致时进行的类型转换操作。struts2完成了String和基本类型的类型转换，只要Action属性有get set 方法。同时其还支持自定义的类型转换。</p>
<p>struts2类型转换时通过Params拦截器进行转换的；如果转换失败，则conversionError拦截器拦截该异常，并封装到fieldError中，放入ActionContext中。</p>
<h4 id="8-7-1-基础类型转换："><a href="#8-7-1-基础类型转换：" class="headerlink" title="8.7.1 基础类型转换："></a>8.7.1 基础类型转换：</h4><p>testAction：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">public class TestAction extends ActionSupport&#123;</div><div class="line">    private String name;</div><div class="line">    private int age;</div><div class="line">    private Date d;</div><div class="line">    Set&lt;String&gt; interests;</div><div class="line">    Map&lt;String, String&gt; users;</div><div class="line"></div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setName(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int getAge() &#123;</div><div class="line">        return age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setAge(int age) &#123;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Date getD() &#123;</div><div class="line">        return d;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setD(Date d) &#123;</div><div class="line">        this.d = d;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Set&lt;String&gt; getInterests() &#123;</div><div class="line">        return interests;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setInterests(Set&lt;String&gt; interests) &#123;</div><div class="line">        this.interests = interests;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Map&lt;String, String&gt; getUsers() &#123;</div><div class="line">        return users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setUsers(Map&lt;String, String&gt; users) &#123;</div><div class="line">        this.users = users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String execute() throws Exception &#123;</div><div class="line">        return super.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>test.jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">name:&lt;s:property value=&quot;name&quot;/&gt;&lt;br/&gt;</div><div class="line">age:&lt;s:property value=&quot;age&quot;/&gt;&lt;br/&gt;</div><div class="line">date:&lt;s:property value=&quot;d&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:date name=&quot;d&quot; format=&quot;yyyy/MM/dd HH:mm:ss&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;interests&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;users&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h4 id="8-7-2自定义类型转换"><a href="#8-7-2自定义类型转换" class="headerlink" title="8.7.2自定义类型转换"></a>8.7.2自定义类型转换</h4><p>自定义类型转换器方法:</p>
<h5 id="继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换-Sting数组转换到Action属性。函数模板为："><a href="#继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换-Sting数组转换到Action属性。函数模板为：" class="headerlink" title="继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换,Sting数组转换到Action属性。函数模板为："></a>继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换,Sting数组转换到Action属性。函数模板为：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class MyPointConverter extends DefaultTypeConverter&#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Object convertValue(Object value, Class toType) &#123;</div><div class="line">		if(toType == Point.class) &#123;</div><div class="line">			Point p = new Point();</div><div class="line">			String[] strs = (String[])value;</div><div class="line">			String[] xy = strs[0].split(&quot;,&quot;);</div><div class="line">			p.x = Integer.parseInt(xy[0]);</div><div class="line">			p.y = Integer.parseInt(xy[1]);</div><div class="line">			return p;</div><div class="line">		&#125;</div><div class="line">		if(toType == String.class) &#123;</div><div class="line">			return value.toString();</div><div class="line">		&#125;</div><div class="line">		return super.convertValue(value, toType);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="继承StrutsTypeConverter"><a href="#继承StrutsTypeConverter" class="headerlink" title="继承StrutsTypeConverter"></a>继承StrutsTypeConverter</h5><ul>
<li>StrutsTypeConverter是DefaultTypeConverter的子类。在两个方向的类型转换上分别实现：</li>
</ul>
<p>MyPointerConverter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class MyPointConverter extends StrutsTypeConverter&#123;</div><div class="line">    @Override</div><div class="line">    public Object convertFromString(Map map, String[] strings, Class aClass) &#123;</div><div class="line">        Point point = new Point();</div><div class="line">        String[] strings1 = (String[])strings;</div><div class="line">        String[] xy = strings1[0].split(&quot;,&quot;);</div><div class="line">        point.x = Integer.parseInt(xy[0]);</div><div class="line">        point.y = Integer.parseInt(xy[1]);</div><div class="line">        return point;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String convertToString(Map map, Object o) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TestAction:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class TestAction extends ActionSupport&#123;</div><div class="line">    Point p;</div><div class="line">    List&lt;Point&gt; ps;</div><div class="line">    Map&lt;String, Point&gt; points;</div><div class="line"></div><div class="line">    public Point getP() &#123;</div><div class="line">        return p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setP(Point p) &#123;</div><div class="line">        this.p = p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public List&lt;Point&gt; getPs() &#123;</div><div class="line">        return ps;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPs(List&lt;Point&gt; ps) &#123;</div><div class="line">        this.ps = ps;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Map&lt;String, Point&gt; getPoints() &#123;</div><div class="line">        return points;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPoints(Map&lt;String, Point&gt; points) &#123;</div><div class="line">        this.points = points;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String execute() throws Exception &#123;</div><div class="line">        return super.execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">&lt;s:property value=&quot;p&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;ps&quot;/&gt;&lt;br/&gt;</div><div class="line">points:&lt;s:property value=&quot;points&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h5 id="注册方式："><a href="#注册方式：" class="headerlink" title="注册方式："></a>注册方式：</h5><ul>
<li>第一种配置方法为在具备类型转换文件中配置，局部类型转换文件命名为<code>ActionName-conversion.properties</code>,位置放在特定的Action目录下，文件内容格式为：<code>typeName=ConverClass</code>仅针对特定的Action的特定属性有效</li>
<li>第二种配置方法为全局类型转换文件中红配置，文件名为xwork-conversion.properties,在<code>WEB-INF\classes</code>下，文件内容格式为：<code>attributeName=ConvertClass</code>, 对某个类型都有效，比如对Point类型注册了类型转换器。</li>
<li><p>注解</p>
<h3 id="8-8-拦截器和过滤器的比较"><a href="#8-8-拦截器和过滤器的比较" class="headerlink" title="8.8 拦截器和过滤器的比较"></a>8.8 拦截器和过滤器的比较</h3></li>
<li>相同点：<ul>
<li>都是一种Java类</li>
<li>都能拦截客户端发给服务端的请求</li>
<li>拦截到请求之后都可以做一些相应的处理，最后还可以把这个请求放行</li>
<li>都需要实现各自相应的接口记忆在相应的配置文件中配置</li>
</ul>
</li>
<li><p>不同点：</p>
<ul>
<li>拦截器是Struts2框架中定义的，过滤器是web里面的对象，是J2EE标准定义的</li>
<li>拦截器只会拦截访问Action的请求，过滤器可以拦截所有的请求</li>
<li>拦截器定义在struts.xml文件中，过滤器定义在web.xml中</li>
<li>拦截器对象的创建、调用、销毁时struts2框架负责的，过滤器对象的创建、调用、销毁时服务器负责的。</li>
</ul>
<p><em>我们自己定义的filter也可以拦截struts2框架中的Action，需要在web.xml文件中把我们自己的filter配置在struts2的filter上面才可以，因为web.xml文件中的filter配置的先后顺序控制filter起作用的顺序，如果struts的filter先拦截到访问action的请求后，不会把这个请求交给下面的filter，而是交给它内部的拦截器。如果我们自己的filter拦截到请求之后，还是会交给下一个filter，也就是交给struts2的filter</em></p>
</li>
</ul>
<h2 id="9-注解Annotation"><a href="#9-注解Annotation" class="headerlink" title="9 注解Annotation"></a>9 注解Annotation</h2><h3 id="9-1-注解使用方式"><a href="#9-1-注解使用方式" class="headerlink" title="9.1 注解使用方式"></a>9.1 注解使用方式</h3><ol>
<li>引入支持struts2框架注解开发的jar包 struts2-convention-plugin-2.3.4.1</li>
<li>struts.xml <code>&lt;constant name=&quot;struts.convention.action.suffix&quot; value=&quot;Action&quot;/&gt;</code></li>
<li><p>Struts2使用注解开发需要遵循一定的规范：</p>
<ul>
<li>Action要必须继承ActionSupport父类</li>
<li>Action所在的包名必须以Action结尾</li>
<li>package-info.java <em>在这里配置这个包下所有的类都可以用</em></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> @Namespace(&quot;/&quot;)</div><div class="line">@ParentPackage(&quot;struts-default&quot;)</div><div class="line">@DefaultInterceptorRef(&quot;authStack&quot;)//authStack自定义的拦截器</div><div class="line"> package com.briup.action.manager;</div><div class="line">import org.apache.struts2.convention.annotation.Namespace;</div><div class="line">import org.apache.struts2.convention.annotation.ParentPackage;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="9-2-Action常用注解"><a href="#9-2-Action常用注解" class="headerlink" title="9.2 Action常用注解"></a>9.2 Action常用注解</h3><ul>
<li><p>Namespace Annotation</p>
<ul>
<li>通过在ActionClass上定义@Namespace(“/custom”)</li>
<li>通过package0info.java定义<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Namespace(&quot;/manager&quot;)</div><div class="line">@ParentPackage(&quot;default&quot;)</div><div class="line">@DefaultInterceptorRef(&quot;authStack&quot;)</div><div class="line">package com.example.actions;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Action Annotation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1. @Action(interceptorRefs=&#123;</div><div class="line">                @InterceptorRef(&quot;validation&quot;),</div><div class="line">                @InterceptorRef(&quot;defaultStack&quot;)</div><div class="line">            &#125;)</div><div class="line"></div><div class="line">2.      chain</div><div class="line">        @Action(&quot;foo&quot;)</div><div class="line">        public String foo() &#123;</div><div class="line">            return &quot;bar&quot;;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Action(&quot;foo-bar&quot;)</div><div class="line">        public String bar() &#123;</div><div class="line">            return SUCCESS;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Result Annotation</p>
<ul>
<li>全局， 整个类可以访问</li>
<li>局部， 某个方法可以访问<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> @Results(&#123;</div><div class="line">    @Result(name=&quot;failure&quot;, location=&quot;fail.jsp&quot;)</div><div class="line">&#125;)</div><div class="line">public class HelloWorld extends ActionSupport &#123;</div><div class="line">    @Action(value=&quot;/different/url&quot;,results=&#123;@Result(name=&quot;success&quot;, location=&quot;http://struts.apache.org&quot;, type=&quot;redirect&quot;)&#125;          )</div><div class="line">    public String execute() &#123;</div><div class="line">        return SUCCESS;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><em>参考：<a href="http://www.jianshu.com/p/a884504a8863" target="_blank" rel="external">http://www.jianshu.com/p/a884504a8863</a></em></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/struts2总结 四--异常处理和I18N/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/struts2总结 四--异常处理和I18N/" itemprop="url">struts2总结（四）--异常处理和I18N</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T14:13:34+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="6-声明式异常处理"><a href="#6-声明式异常处理" class="headerlink" title="6 声明式异常处理"></a>6 声明式异常处理</h2><p>通过配置的方式捕获指定类型异常，有ExceptionMappingInterceptor拦截器将异常信息（ExceptionHolder：exceptionStack， exception）压入栈顶，然后通过OGNL表达式在页面中获取异常。</p>
<ol>
<li><p>在Actoin中进行异常映射</p>
<ul>
<li>只对当前Action对应类型的异常起作用，在struts2配置文件Action内部节点使用exception-mapping来映射异常,当发生SQLException时，会返回“error”信息，并跳转到error.jsp页面：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;action name=&quot;*-*&quot; class=&quot;com.bbs.action.&#123;1&#125;Action&quot; method=&quot;&#123;2&#125;&quot;&gt;</div><div class="line">          &lt;result&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">          &lt;result name=&quot;input&quot;&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">          &lt;exception-mapping exception=&quot;java.sql.SQLException&quot; result=&quot;error&quot; /&gt;</div><div class="line">          &lt;result name=&quot;error&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">      &lt;/action&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>在package中进行全局异常映射</p>
<ul>
<li>针对所有Action对应类型的异常都起作用，可以通过OGNL在页面中获取异常信息需。</li>
<li>GLOBAL级别的声明式异常配置必须配置在所有的Action之前，同时，global-result节点需要配置在global-exception-mappings之前。</li>
<li>当捕获到一个异常对象时，如果同时存在Action和全局两种级别的映射信息，则优先使用Action级别。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;default&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">      &lt;global-results&gt;</div><div class="line">          &lt;result name=&quot;globleException&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">      &lt;/global-results&gt;</div><div class="line"></div><div class="line">      &lt;global-exception-mappings&gt;</div><div class="line">          &lt;exception-mapping result=&quot;globleException&quot; exception=&quot;java.lang.Exception&quot;/&gt;</div><div class="line">      &lt;/global-exception-mappings&gt;</div><div class="line">  &lt;/package&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用继承共用异常映射，多个package可以通过extends来公用异常映射：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;admin&quot; namespace=&quot;/admin&quot; extends=&quot;default&quot; &gt;</div><div class="line"></div><div class="line">       &lt;action name=&quot;index&quot;&gt;</div><div class="line">           &lt;result&gt;/admin/index.html&lt;/result&gt;</div><div class="line">       &lt;/action&gt;</div><div class="line"></div><div class="line">       &lt;action name=&quot;*-*&quot; class=&quot;com.action.&#123;1&#125;Action&quot; method=&quot;&#123;2&#125;&quot;&gt;</div><div class="line">           &lt;result&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">           &lt;result name=&quot;input&quot;&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">           &lt;result name=&quot;error&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">       &lt;/action&gt;</div><div class="line">&lt;/package&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Struts2中异常处理由拦截器实现（观察struts-default.xml）</p>
<ul>
<li>实际上Struts2的大多数功能都由拦截器实现</li>
</ul>
</li>
</ol>
<h2 id="7-I18N"><a href="#7-I18N" class="headerlink" title="7 I18N"></a>7 I18N</h2><ol>
<li><p>I18N原理<br>国际化，international。我们将程序中硬编码的文本转移到外部的资源文件（.properties）中期 ，针对每一种语言环境，编写一个资源文件。指定当前程序所用的语言环境，Java中的国际化处理机制能够自动找到对应的资源文件并读取内容。创建了两个资源文件，一个为bbs_en_US.properties,bbs_zh_CN.properties，需要注意的 是编码问题，IDEA中将File-Editor-Code Style-File Encodings-Transparent native-to-ascii conversion勾选上，就可以将中文自动转换成ASCII编码。</p>
<ul>
<li>ResourceBundle和Locale的概念</li>
<li>ResourceBundle:按语言查找顺序</li>
<li>Locale命令是将当前语言环境或全部公共语言环境的信息输出到标准输出上</li>
<li>资源文件:在Action所在的包或者任意一个父包中定义package.properties和package_language_COUTRY.properties资源文件</li>
</ul>
</li>
<li><p>Struts的资源文件</p>
<ul>
<li>Action – Package – App级</li>
<li>一般只用APP</li>
<li>struts.xml custom.i18n</li>
<li>动态语言切换</li>
<li>request_locale=en_US</li>
</ul>
</li>
<li><p>了解的不多，以后可以查教程<br><a href="http://www.yiibai.com/struts_2/struts_localization.html" target="_blank" rel="external">I18N</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/struts2总结 六--struts2项目开发流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/struts2总结 六--struts2项目开发流程/" itemprop="url">struts2总结（六）--Struts2项目开发流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T14:05:53+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>建立界面原型</li>
<li>建立struts.XHTML<ul>
<li>确定namespace</li>
<li>确定package</li>
<li>确定Result</li>
<li>将界面原型页面进行修改，匹配现有设置</li>
<li>测试</li>
<li>做好规划</li>
</ul>
</li>
<li>建立数据库</li>
<li>建立Model层</li>
<li>建立Service层<ul>
<li>使用JUnit进行单元测试</li>
</ul>
</li>
<li>开始开发</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/struts2总结 二--Result和OGNL表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/struts2总结 二--Result和OGNL表达式/" itemprop="url">struts2总结（二）--Result和OGNL表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T13:32:41+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="4-Result"><a href="#4-Result" class="headerlink" title="4 Result"></a>4 Result</h2><p>Result是Action执行结束之后返回的结果，result包含name和type属性，前者是返回的字符串，后者指定跳转的类型，默认为dispatcher。</p>
<h3 id="4-1-Result常用的四中类型"><a href="#4-1-Result常用的四中类型" class="headerlink" title="4.1 Result常用的四中类型"></a>4.1 Result常用的四中类型</h3><ol>
<li>dispatcher， 从一个Action里面服务器内部跳转到一个页面中, r1–&gt;r1.jsp</li>
<li>chain， 从一个Action里面服务器内部跳转到另一个Action中,r2–&gt;r2.jsp</li>
<li>redirect， 从一个Action里面客户端重定向到一个页面中, r3-&gt;r1-&gt;r1.jsp</li>
<li>redirectAction， 从一个Action里面客户端重定向到另一个Action中, r4-&gt;r2-&gt;r2.jsp<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;struts&gt;</div><div class="line">    &lt;constant name=&quot;struts.devMode&quot; value=&quot;true&quot; /&gt;</div><div class="line">    &lt;package name=&quot;resultTypes&quot; namespace=&quot;/r&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">	    &lt;action name=&quot;r1&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;dispatcher&quot;&gt;/r1.jsp&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r2&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;redirect&quot;&gt;/r2.jsp&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r3&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;chain&quot;&gt;r1&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r4&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;redirectAction&quot;&gt;r2&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">    &lt;/package&gt;</div><div class="line">&lt;/struts&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-2-全局结果集"><a href="#4-2-全局结果集" class="headerlink" title="4.2 全局结果集"></a>4.2 全局结果集</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;global-results&gt;</div><div class="line">    		&lt;result name=&quot;mainpage&quot;&gt;/main.jsp&lt;/result&gt;</div><div class="line">&lt;/global-results&gt;</div></pre></td></tr></table></figure>
<p>在其他任何Action中，不需要单独设置，所有返回mainpage字符串的Action会跳转到main.jsp页面。但是如果在某一个Action定义了mainpage字符串的跳转，全局跳转对这个acting失效。action结果集的优先级高于全局结果集。</p>
<h3 id="4-3-动态结果（了解）"><a href="#4-3-动态结果（了解）" class="headerlink" title="4.3 动态结果（了解）"></a>4.3 动态结果（了解）</h3><p>动态结果集表示在struts配置的时候，Action根据类型的不同，动态的决定返回的页面。首先需要在Action中定义两个成员变量，type和r, 其中type用于接收页面传入的参数，r用于保存Action传出的结果。<br>struts.xml为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;struts&gt;</div><div class="line">    &lt;constant name=&quot;struts.devMode&quot; value=&quot;true&quot; /&gt;</div><div class="line">    &lt;package name=&quot;user&quot; namespace=&quot;/user&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;user&quot; class=&quot;com.bjsxt.struts2.user.action.UserAction&quot;&gt;</div><div class="line">	    	&lt;result&gt;$&#123;r&#125;&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;	    </div><div class="line">    &lt;/package&gt;</div><div class="line"></div><div class="line">&lt;/struts&gt;</div></pre></td></tr></table></figure>
<p>index.jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">动态结果</div><div class="line">一定不要忘了为动态结果的保存值设置set get方法</div><div class="line">&lt;ol&gt;</div><div class="line">	&lt;li&gt;&lt;a href=&quot;user/user?type=1&quot;&gt;返回success&lt;/a&gt;&lt;/li&gt;</div><div class="line">	&lt;li&gt;&lt;a href=&quot;user/user?type=2&quot;&gt;返回error&lt;/a&gt;&lt;/li&gt;</div><div class="line">&lt;/ol&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<p>UserAction：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public class UserAction extends ActionSupport &#123;</div><div class="line">	private int type;</div><div class="line"></div><div class="line">	private String r;</div><div class="line"></div><div class="line">	public String getR() &#123;</div><div class="line">		return r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setR(String r) &#123;</div><div class="line">		this.r = r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public int getType() &#123;</div><div class="line">		return type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setType(int type) &#123;</div><div class="line">		this.type = type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public String execute() throws Exception &#123;</div><div class="line">		if(type == 1) r=&quot;/user_success.jsp&quot;;</div><div class="line">		else if (type == 2) r=&quot;/user_error.jsp&quot;;</div><div class="line">		return &quot;success&quot;;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-4-传递参数"><a href="#4-4-传递参数" class="headerlink" title="4.4 传递参数"></a>4.4 传递参数</h3><p>除了request，session，application来向页面传值之外，还可以通过ValueStack和ActionContext。</p>
<ul>
<li>ValueStack是一个接口， <code>ValueStack vs = context.getValueStack()</code>将值从Action传到页面，ActionContext是一个类，<code>ActionContext context = ActionContext.getContext()</code>来传值，在页面中农需要<code>&lt;s:debug /&gt;</code>标签来查看结果。</li>
<li>当Action进行跳转的时候，struts2框架会自动的把这个Action对象本身分别放到ValueStack和ActionContext中去。然后struts2将这两个对象传递给页面，在页面中可以通过这两个对象来拿到之前放进去的值。也可以在Action中拿到这两个对象手动放值:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ActionContext ac = ActionContext.getContext();</div><div class="line">ValueStack vs = ac.getValueStack();</div><div class="line">ac.put(&quot;ac&quot;,&quot;ac&quot;);</div><div class="line">User user = new User()；</div><div class="line">vs.push(user);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-4-1-ValueStack"><a href="#4-4-1-ValueStack" class="headerlink" title="4.4.1 ValueStack"></a>4.4.1 ValueStack</h4><ol>
<li>把一个对象放到值栈之后，文名从这个值栈中是拿不到这个对象的，但是文名可以直接拿到这个对象的属性及其属性值。</li>
<li>从值栈中拿值的时候，是从值栈的property name这一列来拿的，拿到的是property value之一列的值。</li>
<li>所以通过值栈来传递参数到页面需要将参数封装到一个对象中，将这个对象放到值栈中。</li>
<li>生命周期为request</li>
<li>创建一个新的值栈对象后，都会把这个对象放到ActionCon中去。</li>
</ol>
<h4 id="4-4-2-ActionContext"><a href="#4-4-2-ActionContext" class="headerlink" title="4.4.2 ActionContext"></a>4.4.2 ActionContext</h4><ol>
<li>向ActionContext中放值的时候是通过k-v的形式存放的，String-Object键值对，取值同样是通过key拿到value。</li>
<li>struts2框架默认向这个对象里面存放的对象很多，包括request，session，application，ValueStack，parameter等</li>
<li>每次请求都会创建一个新的ActionContext对象</li>
</ol>
<h4 id="4-4-3-取值方式"><a href="#4-4-3-取值方式" class="headerlink" title="4.4.3 取值方式"></a>4.4.3 取值方式</h4><ol>
<li><p>jsp内置对象取值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%=request.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div><div class="line">&lt;%=session.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div><div class="line">&lt;%=application.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>jstl标签+EL表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$&#123;requestScope.MyName &#125;&lt;br&gt;</div><div class="line"> $&#123;requestScope.name &#125;  &lt;br&gt;</div><div class="line"> $&#123;sessionScope.MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;applicationScope.MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;name &#125;  &lt;br&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>struts2标签+OGNL表达式<code>&lt;s:property value=&quot;OGNL&quot;</code></p>
</li>
</ol>
<blockquote>
<ul>
<li><p>从ValueStack中取值：这个value属性的值name,是一个OGNL表达式，表示取一个名字为name的property的值。从ValueStack中取值，如果存在重名的，默认取最上面的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;s:property value=&quot;name&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user.id&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user.name&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>从ActionContext中取值  #</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;s:property value=&quot;#action.name&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#msg&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.id&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.name&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.age&quot;/&gt;&lt;br&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h2 id="5-OGNL表达式"><a href="#5-OGNL表达式" class="headerlink" title="5 OGNL表达式"></a>5 OGNL表达式</h2><p>OGNL:Object-Graph Navigation Language，图对象导航语言，是struts2中默认的表达式语言。</p>
<h3 id="5-1-访问普通方法、属性、构造方法"><a href="#5-1-访问普通方法、属性、构造方法" class="headerlink" title="5.1 访问普通方法、属性、构造方法"></a>5.1 访问普通方法、属性、构造方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问值栈中的action的普通属性: username = &lt;s:property value=&quot;username&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通属性(get set方法)：&lt;s:property value=&quot;user.age&quot;/&gt; | &lt;s:property value=&quot;user[&apos;age&apos;]&quot;/&gt; | &lt;s:property value=&quot;user[\&quot;age\&quot;]&quot;/&gt; | wrong: &lt;%--&lt;s:property value=&quot;user[age]&quot;/&gt;--%&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通属性(get set方法): &lt;s:property value=&quot;cat.friend.name&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通方法：&lt;s:property value=&quot;password.length()&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通方法：&lt;s:property value=&quot;cat.miaomiao()&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中action的普通方法：&lt;s:property value=&quot;m()&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;hr /&gt;</div><div class="line">&lt;li&gt;访问普通类的构造方法：&lt;s:property value=&quot;new com.struts2.ognl.User(8)&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;hr /&gt;</div></pre></td></tr></table></figure>
<h3 id="5-2-访问静态方法、属性"><a href="#5-2-访问静态方法、属性" class="headerlink" title="5.2 访问静态方法、属性"></a>5.2 访问静态方法、属性</h3><p>struts2默认的<code>&lt;constant name=&quot;struts.ognl.allowStaticMethodAccess&quot; value=&quot;true&quot;&gt;&lt;/constant&gt;</code>为false，需要配置成true才可以访问静态方法、属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问静态方法：&lt;s:property value=&quot;@com.struts2.ognl.S@s()&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问静态属性：&lt;s:property value=&quot;@com.struts2.ognl.S@STR&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Math类的静态方法：&lt;s:property value=&quot;@@max(2,3)&quot; /&gt;&lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-3-访问集合元素："><a href="#5-3-访问集合元素：" class="headerlink" title="5.3 访问集合元素："></a>5.3 访问集合元素：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问List:&lt;s:property value=&quot;users&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中某个元素:&lt;s:property value=&quot;users[1]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中元素某个属性的集合:&lt;s:property value=&quot;users.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中元素某个属性的集合中的特定值:&lt;s:property value=&quot;users.&#123;age&#125;[0]&quot;/&gt; | &lt;s:property value=&quot;users[0].age&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Set:&lt;s:property value=&quot;dogs&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Set中某个元素:&lt;s:property value=&quot;dogs[1]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map:&lt;s:property value=&quot;dogMap&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中某个元素:&lt;s:property value=&quot;dogMap.dog101&quot;/&gt; | &lt;s:property value=&quot;dogMap[&apos;dog101&apos;]&quot;/&gt; | &lt;s:property value=&quot;dogMap[\&quot;dog101\&quot;]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中所有的key:&lt;s:property value=&quot;dogMap.keys&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中所有的value:&lt;s:property value=&quot;dogMap.values&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问容器的大小：&lt;s:property value=&quot;dogMap.size()&quot;/&gt; | &lt;s:property value=&quot;users.size&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-4-投影和过滤"><a href="#5-4-投影和过滤" class="headerlink" title="5.4 投影和过滤"></a>5.4 投影和过滤</h3><ul>
<li>“?#”：过滤所有符合条件的集合</li>
<li>“^#”：过滤第一个符合条件的元素</li>
<li>“$#”：过滤最后一个符合条件的元素</li>
<li>返回的是一个集合，可以使用索引取得集合中指定的元素。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;投影(过滤)：&lt;s:property value=&quot;users.&#123;?#this.age==1&#125;[0]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;^#this.age&gt;1&#125;.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;$#this.age&gt;1&#125;.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;$#this.age&gt;1&#125;.&#123;age&#125; == null&quot;/&gt;&lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-5-区分-和"><a href="#5-5-区分-和" class="headerlink" title="5.5 区分 %{} 和 ${}"></a>5.5 区分 %{} 和 ${}</h3><ul>
<li>%{}<br>%{}的主要作用是告诉标签的处理类将它包含的字符串按照OGNL表达式处理，类似eval函数</li>
<li>${}<br>${}的主要用于两方面：<ul>
<li>用于国际化资源文件中</li>
<li>用于Struts2配置文件中</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/09/07/struts2总结 三--Struts Tags/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/07/struts2总结 三--Struts Tags/" itemprop="url">struts2总结（三）--Struts Tags</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-07T10:28:13+08:00">
                2017-09-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="5-Struts-Tags"><a href="#5-Struts-Tags" class="headerlink" title="5 Struts Tags"></a>5 Struts Tags</h2><p>要在jsp中使用Struts2的标签，需要先引入<code>&lt;%@ taglib prefix=&quot;s&quot; uri=&quot;/struts-tags&quot; %&gt;</code></p>
<h3 id="5-1-通用标签"><a href="#5-1-通用标签" class="headerlink" title="5.1 通用标签"></a>5.1 通用标签</h3><ul>
<li><p>property</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;property: &lt;s:property value=&quot;username&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 取值为字符串: &lt;s:property value=&quot;&apos;username&apos;&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 设定默认值: &lt;s:property value=&quot;admin&quot; default=&quot;管理员&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 设定HTML: &lt;s:property value=&quot;&apos;&lt;hr/&gt;&apos;&quot; escape=&quot;false&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>set 将某个值放入指定范围内</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;set 设定adminName值（默认为request 和 ActionContext）: &lt;s:set var=&quot;adminName&quot; value=&quot;username&quot; /&gt;&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;set 从request取值: &lt;s:property value=&quot;#request.adminName&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 从ActionContext取值: &lt;s:property value=&quot;#adminName&quot; /&gt;&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;%--&lt;li&gt;set 设定范围: &lt;s:set name=&quot;adminPassword&quot; value=&quot;password&quot; scope=&quot;page&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 从相应范围取值: &lt;%=pageContext.getAttribute(&quot;adminPassword&quot;) %&gt;&lt;/li&gt;</div><div class="line">--%&gt;</div><div class="line">&lt;li&gt;set 设定var，范围为ActionContext: &lt;s:set var=&quot;adminPassword&quot; value=&quot;password&quot; scope=&quot;session&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 使用#取值: &lt;s:property value=&quot;#adminPassword&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;set 从相应范围取值: &lt;s:property value=&quot;#session.adminPassword&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>bean 实例化一个JavaBean</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;bean 定义bean,并使用param来设定新的属性值:</div><div class="line">        &lt;s:bean name=&quot;com.struts2.tags.Dog&quot; &gt;</div><div class="line">            &lt;s:param name=&quot;name&quot; value=&quot;&apos;pp&apos;&quot;&gt;&lt;/s:param&gt;</div><div class="line">            &lt;s:property value=&quot;name&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;/s:bean&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;bean 查看debug情况:</div><div class="line">        &lt;s:bean name=&quot;com.struts2.tags.Dog&quot; var=&quot;myDog&quot;&gt;</div><div class="line">            &lt;s:param name=&quot;name&quot; value=&quot;&apos;oudy&apos;&quot;&gt;&lt;/s:param&gt;</div><div class="line">        &lt;/s:bean&gt;</div><div class="line">        拿出值：</div><div class="line">        &lt;s:property value=&quot;#myDog.name&quot;/&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>include 将一JSP或者Servlet包含到当前页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;include _include1.html 包含静态英文文件</div><div class="line">       &lt;s:include value=&quot;/_include1.html&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div><div class="line"></div><div class="line">   &lt;li&gt;include _include2.html 包含静态中文文件</div><div class="line">       &lt;s:include value=&quot;/_include2.html&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div><div class="line"></div><div class="line">   &lt;li&gt;include _include1.html 包含静态英文文件，说明%用法</div><div class="line">       &lt;s:set var=&quot;incPage&quot; value=&quot;%&#123;&apos;/_include1.html&apos;&#125;&quot; /&gt;</div><div class="line">       &lt;s:include value=&quot;%&#123;#incPage&#125;&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>param 为其他标签提供参数</p>
</li>
<li>debug 辅助调试，查看值栈等信息<h3 id="5-2-控制标签"><a href="#5-2-控制标签" class="headerlink" title="5.2 控制标签"></a>5.2 控制标签</h3></li>
<li><p>if elseif else 用来控制选择输出的标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;if elseif else:</div><div class="line">    age = &lt;s:property value=&quot;#parameters.age[0]&quot; /&gt; &lt;br /&gt;</div><div class="line">    &lt;s:set var=&quot;age&quot; value=&quot;#parameters.age[0]&quot; /&gt;</div><div class="line">    &lt;s:if test=&quot;#age &lt; 0&quot;&gt;wrong age!&lt;/s:if&gt;</div><div class="line">    &lt;s:elseif test=&quot;#parameters.age[0] &lt; 20&quot;&gt;too young!&lt;/s:elseif&gt;</div><div class="line">    &lt;s:else&gt;yeah!&lt;/s:else&gt;&lt;br /&gt;</div><div class="line"></div><div class="line">    &lt;s:if test=&quot;#parameters.aaa == null&quot;&gt;null&lt;/s:if&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>iterator 迭代器，用于将集合迭代输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;遍历集合：&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;1, 2, 3&#125;&quot; &gt;</div><div class="line">        &lt;s:property/&gt; |</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;自定义变量：&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;&apos;aaa&apos;, &apos;bbb&apos;, &apos;ccc&apos;&#125;&quot; var=&quot;x&quot;&gt;</div><div class="line">        &lt;s:property value=&quot;#x.toUpperCase()&quot;/&gt; |</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;使用status:&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;&apos;aaa&apos;, &apos;bbb&apos;, &apos;ccc&apos;&#125;&quot; status=&quot;status&quot;&gt;</div><div class="line">        &lt;s:property/&gt; |</div><div class="line">        遍历过的元素总数：&lt;s:property value=&quot;#status.count&quot;/&gt; |</div><div class="line">        遍历过的元素索引：&lt;s:property value=&quot;#status.index&quot;/&gt; |</div><div class="line">        当前是偶数？：&lt;s:property value=&quot;#status.even&quot;/&gt; |</div><div class="line">        当前是奇数？：&lt;s:property value=&quot;#status.odd&quot;/&gt; |</div><div class="line">        是第一个元素吗？：&lt;s:property value=&quot;#status.first&quot;/&gt; |</div><div class="line">        是最后一个元素吗？：&lt;s:property value=&quot;#status.last&quot;/&gt;</div><div class="line">        &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line"></div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line">    &lt;s:iterator value=&quot;#&#123;1:&apos;a&apos;, 2:&apos;b&apos;, 3:&apos;c&apos;&#125;&quot; &gt;</div><div class="line">        &lt;s:property value=&quot;key&quot;/&gt; | &lt;s:property value=&quot;value&quot;/&gt; &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line">    &lt;s:iterator value=&quot;#&#123;1:&apos;a&apos;, 2:&apos;b&apos;, 3:&apos;c&apos;&#125;&quot; var=&quot;x&quot;&gt;</div><div class="line">        &lt;s:property value=&quot;#x.key&quot;/&gt; | &lt;s:property value=&quot;#x.value&quot;/&gt; &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line"></div><div class="line">    &lt;s:fielderror fieldName=&quot;fielderror.test&quot; theme=&quot;simple&quot;&gt;&lt;/s:fielderror&gt;</div><div class="line"></div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>subset 用于截取集合的部分元素，形成新的子集合</p>
<h3 id="5-3-UI标签"><a href="#5-3-UI标签" class="headerlink" title="5.3 UI标签"></a>5.3 UI标签</h3><p>Struts2中一共定义了4个主题，simple， XHTML（默认）， css_xhtml, ajax.</p>
<h3 id="5-4-AJAX标签"><a href="#5-4-AJAX标签" class="headerlink" title="5.4 AJAX标签"></a>5.4 AJAX标签</h3><p>后续可以查</p>
<h3 id="5-5-的区别"><a href="#5-5-的区别" class="headerlink" title="5.5 $ # % 的区别"></a>5.5 $ # % 的区别</h3></li>
<li><p>$用于i18n和struts配置文件</p>
</li>
<li>#取得ActionContext的值</li>
<li>%将原本的文本属性解析为OGNL，对本来是OGNL的属性不起作用</li>
</ul>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p>这部分用的不多，所以存了几个相关的比较全的博客地址，方便需要的时候去学习:<br><a href="http://blog.csdn.net/liujiahan629629/article/details/39274997" target="_blank" rel="external">Struts2标签小结</a><br><a href="http://www.cnblogs.com/lihuiyy/archive/2012/04/09/2439509.html" target="_blank" rel="external">UI标签</a><br><a href="http://blog.csdn.net/zklxuankai/article/details/8468815" target="_blank" rel="external">AJAX标签</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
