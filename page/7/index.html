<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/page/7/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/7/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/Spring1_Spring的核心/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/Spring1_Spring的核心/" itemprop="url">1_Spring的核心</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h1 id="Spring简介"><a href="#Spring简介" class="headerlink" title="Spring简介"></a>Spring简介</h1><hr>
<h2 id="Spring的根本使命是：简化Java的开发，采用了四种策略："><a href="#Spring的根本使命是：简化Java的开发，采用了四种策略：" class="headerlink" title="Spring的根本使命是：简化Java的开发，采用了四种策略："></a>Spring的根本使命是：简化Java的开发，采用了四种策略：</h2><ul>
<li>基于POJO的轻量级和最小浸入性编程,避免了大量的不必要的冗余代码</li>
<li>通过依赖注入和面向接口事项松耦合，每个对象负责管理与自己相互协作的对象的引用会造成高度的耦合性，测试比较复杂，另一种方式是采用依赖注入，对象的依赖关系将由负责协调系统中各个对象的第三方组件在创建对象时设定，对象无需自行创建或者管理器依赖关系，依赖关系会自动的注入到需要的对象中去。</li>
<li>基于切面和惯例进行声明式编程</li>
<li>通过切面和模板减少样式代码，如JDBC查询模板语句</li>
</ul>
<h2 id="Spring容器"><a href="#Spring容器" class="headerlink" title="Spring容器"></a>Spring容器</h2><ul>
<li>Spring应用中，对象存在于Spring容器中，容器创建对象，装配对象，配置对象，管理对象的声明周期。</li>
<li>Spring容器可以分为两种类型：<ul>
<li>Bean工厂：最简单的容器，提供基本的DI支持</li>
<li>应用上下文：基于beanFactory之上构建，提供面向应用的服务，可以从属性文件解析文本信息<ul>
<li>ClassPathXMLApplicationContext: 从类路径下的XML配置文件中加载上下文定义，把应用上下文定义文件当做类资源</li>
<li>FileSystemXmlApplocationcontext：读取文件系统下的XML配置文件并加载上下文定义</li>
<li>XmlWebApplocationContext：读取web应用下的XML配置文件并装载上下文定义。</li>
</ul>
</li>
</ul>
</li>
<li>Bean的生命周期：<ul>
<li>Spring对Bean进行实例化</li>
<li>Spring将值和Bean的引用注入进bean对应的属性中去</li>
<li>如果Bean实现了BeanNameAware接口，Spring将Bean的ID传递给setBeanName()接口方法</li>
<li>如果Bean实现了BeanFactoryAware接口，Spring将调用setBeanFactory()接口方法,将BeanFactory容器实例传入。</li>
<li>如果Bean实现了ApplicationContextAweare接口，Spring将调用他们的setApplicationContext()接口方法，将应用上下文的引用传入</li>
<li>如果Bean实现了BeanPostProcessor接口，Spring将调用他们的postProcessBeforeInitialization()接口方法</li>
<li>如果Bean实现了InitializingBean接口，Spring将调用他们的afterPropertiesSet()接口方法。类似的，如果Bean使用init-method声明了初始化方法，该方法也会被调用。</li>
<li>如果Bean实现了BeanPostProcessor接口，Spring将调用他们的postProcessAfterInitialization()接口方法</li>
<li>此时此刻，Bean已经准备就绪，可以被应用程序调用，Bean会一直驻留在应用上下文中，直到该应用上下文被销毁</li>
<li>如果Bean实现了DisposableBea接口，Spring将调用他们的destroy()接口方法。同样如果Bean使用destroy-method声明了销毁方法，该方法也会被调用。</li>
</ul>
</li>
</ul>
<h2 id="Spring的六大模块"><a href="#Spring的六大模块" class="headerlink" title="Spring的六大模块"></a>Spring的六大模块</h2><ul>
<li>核心Spring容器：负责Bean的创建，配置和管理。BeanFactory提供了依赖注入，应用上下文及其他企业服务。</li>
<li>AOP模块：对面向切面编程提供了丰富的支持。</li>
<li>数据访问与集成：JDBC和DAO层模块封装了数据库样板，提供了ORM模块，</li>
<li>Web和远程调用</li>
<li>测试</li>
</ul>
<hr>
<h1 id="装配Bean"><a href="#装配Bean" class="headerlink" title="装配Bean"></a>装配Bean</h1><hr>
<h2 id="声明Bean"><a href="#声明Bean" class="headerlink" title="声明Bean"></a>声明Bean</h2><h3 id="XML命名空间"><a href="#XML命名空间" class="headerlink" title="XML命名空间"></a>XML命名空间</h3><ul>
<li><p>Java自带了许多XML命名空间，通过这些命名空间可以配置Spring</p>
<ul>
<li>aop：为声明切面以及将@AspectJ注解的类代理为Spring切面提供了配置元素</li>
<li>beans：支持声明Bean和装配Bean，是Spring最核心也是最原始的命名空间</li>
<li>context：为配置Spring应用上下文提供了配置元素，包括自动检测和自动装配bean，注入非Spring直接管理的对象</li>
<li>jee：提供了与Java EE API的继承，例如JNDI和EJB</li>
<li>jms：为声明消息驱动的POJO提供了配置元素</li>
<li>lang：支持配置由Groovy、JRuby或BeanShell等脚本实现的Bean</li>
<li>mvc：启动Spring MVC的能力，例如面向注解的控制器、视图控制器和拦截器</li>
<li>oxm：支持Spring的对象到XML的映射配置</li>
<li>tx：提供声明式事务配置</li>
<li>util：提供各种各样的工具类元素，包括把集合配置为Bean，支持属性占位符元素</li>
</ul>
</li>
<li><p>创建Spring配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</div><div class="line">&gt;</div><div class="line">  &lt;!--Bean declarations go here --&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>beans 元素中放置所有的Spring配置文件。</p>
<h3 id="声明Bean-1"><a href="#声明Bean-1" class="headerlink" title="声明Bean"></a>声明Bean</h3><p>定义一个Perfomer接口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public interface Performer &#123;</div><div class="line">    void perform() throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>新建一个Bean,实现了Performer接口，从而可以进行表演扔袋子的节目：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Juggler implements Performer&#123;</div><div class="line">    private int beanBags = 3;</div><div class="line"></div><div class="line">    public Juggler() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Juggler(int beanBags) &#123;</div><div class="line">        this.beanBags = beanBags;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void perform() throws Exception &#123;</div><div class="line">        System.out.println(&quot;JUGGLING &quot; + beanBags + &quot; BEANBAGS&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Spring配置文件中声明一个Bean：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;duke&quot; class=&quot;com.springinaction.springidol.Juggler&quot; /&gt;</div></pre></td></tr></table></figure></p>
<p><bean>元素是Spring中最基本的配置单元，通过该元素，Spring可以创建一个对象，duke相当于Juggler的一个实例，main函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        ApplicationContext ctx = new ClassPathXmlApplicationContext(</div><div class="line">                &quot;com/springinaction/springidol/spring-idol.xml&quot;</div><div class="line">        );</div><div class="line">        Performer performer = (Performer) ctx.getBean(&quot;duke&quot;);</div><div class="line">        try &#123;</div><div class="line">            performer.perform();</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></bean></p>
<p>打印结果：<code>JUGGLING 3 BEANBAGS</code></p>
<h3 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h3><p>XML文件中，让duke成为可以抛15个袋子的杂技师：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;duke&quot; class=&quot;com.springinaction.springidol.Juggler&quot; &gt;</div><div class="line">  &lt;constructor-arg value=&quot;15&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>当不配置constructor-arg标签时，Spring将使用默认的构造方法，配置之后会使用另外的构造方法来实例化对象。</p>
<ul>
<li>构造器注入对象的引用<br>Poem接口：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public interface Poem &#123;</div><div class="line">    void recite();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注入对象引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class PoeticJuggler extends Juggler&#123;</div><div class="line">    private Poem poem;</div><div class="line"></div><div class="line">    public PoeticJuggler(Poem poem) &#123;</div><div class="line">        super();</div><div class="line">        this.poem = poem;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public PoeticJuggler(int beanBags, Poem poem) &#123;</div><div class="line">        super(beanBags);</div><div class="line">        this.poem = poem;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void perform() throws Exception &#123;</div><div class="line">        super.perform();</div><div class="line">        System.out.println(&quot;While reciting...&quot;);</div><div class="line">        poem.recite();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现Poem接口的类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Sonnet29 implements Poem&#123;</div><div class="line">    private static String[] LINES = &#123;</div><div class="line">            &quot;when I was young&quot;,</div><div class="line">            &quot;I am a boy.....&quot;,</div><div class="line">            &quot;end of the poem&quot;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    public Sonnet29() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void recite() &#123;</div><div class="line">        for (int i = 0; i &lt; LINES.length; i++)</div><div class="line">            System.out.println(LINES[i]);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>XML中进行配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;duke&quot; class=&quot;com.springinaction.springidol.PoeticJuggler&quot; &gt;</div><div class="line">  &lt;constructor-arg value=&quot;15&quot;/&gt;</div><div class="line">  &lt;constructor-arg ref=&quot;sonnet29&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;bean id=&quot;sonnet29&quot; class=&quot;com.springinaction.springidol.Sonnet29&quot;/&gt;</div></pre></td></tr></table></figure>
<p>这相当于执行了如下的Java语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Poem sonnet29 = new Sonnet29();</div><div class="line">Performer duke = new PoeticJuggler(15, sonnet29);</div></pre></td></tr></table></figure>
<p>打印输出为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">JUGGLING 15 BEANBAGS</div><div class="line">While reciting...</div><div class="line">when I was young</div><div class="line">I am a boy.....</div><div class="line">end of the poem</div></pre></td></tr></table></figure>
<ul>
<li>工厂方法构造Bean<br>Spring支持通过<bean>元素的factory-method属性来装配工厂创建的Bean,Stage实例如下,没有公开的构造方法：</bean></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Stage &#123;</div><div class="line">    public Stage() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //返回实例</div><div class="line">    public static Stage getInstance() &#123;</div><div class="line">        return StageSingletonHolder.instance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //延迟加载实例</div><div class="line">    private static class StageSingletonHolder &#123;</div><div class="line">        static Stage instance = new Stage();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!--通过工厂方法创建Bean--&gt;</div><div class="line">&lt;bean id=&quot;theStage&quot; class=&quot;com.springinaction.springidol.Stage&quot; factory-method=&quot;getInstance&quot;/&gt;</div></pre></td></tr></table></figure>
<h3 id="Bean的作用域"><a href="#Bean的作用域" class="headerlink" title="Bean的作用域"></a>Bean的作用域</h3><p>Spring的Bean作用域允许用户配置所创建的Bean属于哪一种作用域：</p>
<pre><code>* singleton：在每一个Spring容器中，一个Bean定义只有一个对象实例（默认）
* prototype：允许Bean的定义可以被实例化任意次
* request：在一次HTTP请求中，每个Bean定义对应一个实例。
* session：在依次HTTP Session中，每个Bean定义对应一个实例。
* global-session：在一个全局的HTTP Session中，每个Bean定义对应一个实例。
</code></pre><h3 id="初始化和销毁Bean"><a href="#初始化和销毁Bean" class="headerlink" title="初始化和销毁Bean"></a>初始化和销毁Bean</h3><p>实现开关灯的实体类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Auditorium &#123;</div><div class="line">    public void turnOnLights()&#123;</div><div class="line">        System.out.println(&quot;trun on the lights!!!!&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void trunOffLights() &#123;</div><div class="line">        System.out.println(&quot;turn off the lights!!!!&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>XML配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!--初始化和销毁bean--&gt;</div><div class="line">&lt;bean id=&quot;auditorium&quot; class=&quot;com.springinaction.springidol.Auditorium&quot; init-method=&quot;turnOnLights&quot; destroy-method=&quot;trunOffLights&quot; /&gt;</div></pre></td></tr></table></figure></p>
<p>Audiorium实例化后会立刻调用init-method，该Bean移除之后会调用destroy-method。</p>
<blockquote>
<p>默认的init-method和destroy-method：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</div><div class="line">       default-init-method=&quot;turnOnLights&quot;</div><div class="line">       default-destroy-method=&quot;trunOffLights&quot;</div><div class="line">&gt;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>为上下文所有的Bean配置默认的初始化和销毁方法。</p>
<h2 id="注入Bean属性"><a href="#注入Bean属性" class="headerlink" title="注入Bean属性"></a>注入Bean属性</h2><p>JavaBean的属性通常是私有的，Spring可以借助其set方法配置属性的值，实现setter注入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Instrumentalist implements Performer&#123;</div><div class="line"></div><div class="line">    public Instrumentalist() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void perform() throws Exception &#123;</div><div class="line">        System.out.println(&quot;Playing &quot; + song + &quot; : &quot;);</div><div class="line">        instrument.play();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private String song;</div><div class="line"></div><div class="line">    public String getSong() &#123;</div><div class="line">        return song;</div><div class="line">    &#125;</div><div class="line">    //注入歌曲</div><div class="line">    public void setSong(String song) &#123;</div><div class="line">        this.song = song;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String screanSong() &#123;</div><div class="line">        return song;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Instrument instrument;</div><div class="line">//    注入乐器</div><div class="line">    public void setInstrument(Instrument instrument) &#123;</div><div class="line">        this.instrument = instrument;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其有两个属性，song和Instrument,Instrument接口如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public interface Instrument &#123;</div><div class="line">    public void play();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>XML中配置其默认的构造方法生成Bean kenny:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;/&gt;</div></pre></td></tr></table></figure></p>
<p>此时kenny没有歌曲也没有乐器，需要对其进行注入属性。</p>
<h3 id="注入简单值"><a href="#注入简单值" class="headerlink" title="注入简单值"></a>注入简单值</h3><p>使用<property>元素配置Bean的属性。一旦Instrumentalist被实例化，Spring就会调用<property>元素所指定属性的setter方法为该属性注入值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;!--注入Bean属性--&gt;</div><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; &gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;Jingle Bells&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></property></property></p>
<h3 id="引用其他Bean"><a href="#引用其他Bean" class="headerlink" title="引用其他Bean"></a>引用其他Bean</h3><p>定义两个实现了Instrument接口的类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class saxophone implements Instrument&#123;</div><div class="line">    public saxophone() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void play() &#123;</div><div class="line">        System.out.println(&quot;tttttttoooooooo&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Piano implements Instrument&#123;</div><div class="line">    public Piano() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void play() &#123;</div><div class="line">        System.out.println(&quot;play the piano!!!&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Spring支持将其他Bean注入到当前Bean：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; &gt;</div><div class="line">    &lt;property name=&quot;song&quot; value=&quot;Jingle Bells&quot; /&gt;</div><div class="line">    &lt;property name=&quot;instrument&quot; ref=&quot;saxophone&quot;/&gt;</div><div class="line">    &lt;property name=&quot;instrument&quot; ref=&quot;piano&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;bean id=&quot;saxophone&quot; class=&quot;com.springinaction.springidol.saxophone&quot; /&gt;</div><div class="line">&lt;bean id=&quot;piano&quot; class=&quot;com.springinaction.springidol.Piano&quot; /&gt;</div></pre></td></tr></table></figure></p>
<ul>
<li>注入内部Bean<br>注入的Bean仅当前Bean可以使用，此时可以采用内部Bean的注入方法：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 内部BEAN --&gt;</div><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;Jingle Bells&quot; /&gt;</div><div class="line">  &lt;property name=&quot;instrument&quot;&gt;</div><div class="line">    &lt;bean class=&quot;com.springinaction.springidol.saxophone&quot; /&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>除了<property>标签外，<constructor-arg>标签同样可以注入内部Bean</constructor-arg></property></p>
<h3 id="Spring命名空间的P装配属性"><a href="#Spring命名空间的P装配属性" class="headerlink" title="Spring命名空间的P装配属性"></a>Spring命名空间的P装配属性</h3><p>XML声明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</div><div class="line">       default-init-method=&quot;turnOnLights&quot;</div><div class="line">       default-destroy-method=&quot;trunOffLights&quot;</div><div class="line">&gt;</div></pre></td></tr></table></figure></p>
<p>p标签和property功能类似，但是更加简洁：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; p:song = &quot;Jingle Bells&quot; p:instrument-ref=&quot;saxophone&quot;/&gt;</div></pre></td></tr></table></figure></p>
<h3 id="装配集合"><a href="#装配集合" class="headerlink" title="装配集合"></a>装配集合</h3><ul>
<li><list>：装配list类型的值，不允许重复</list></li>
<li><set>：装配set类型的值，不允许重复</set></li>
<li><map>：装配map类型的值，名称和值可以是任意类型</map></li>
<li><props>：装配properties类型的值，名称和值必须都是String类型</props></li>
</ul>
<p>属性实际定义的集合类型和选择<list>、<set>没有任何的关系。新建一人可以同时演奏多种乐器的实体类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">import java.util.Collection;</div><div class="line"></div><div class="line">public class OneManBand implements Performer&#123;</div><div class="line">    public OneManBand() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void perform() throws Exception &#123;</div><div class="line">        for (Instrument instrument : instruments) &#123;</div><div class="line">            instrument.play();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Collection&lt;Instrument&gt; instruments;</div><div class="line"></div><div class="line">    public void setInstruments(Collection&lt;Instrument&gt; instruments) &#123;</div><div class="line">        this.instruments = instruments;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></set></list></p>
<p>装配list Set Array分别为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;hank&quot; class=&quot;com.springinaction.springidol.OneManBand&quot;&gt;</div><div class="line">  &lt;property name=&quot;instruments&quot;&gt;</div><div class="line">    &lt;list&gt;</div><div class="line">      &lt;ref bean=&quot;saxophone&quot;/&gt;</div><div class="line">      &lt;ref bean=&quot;piano&quot;/&gt;</div><div class="line">    &lt;/list&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>list实际上可以包含另一个list作为其成员构成多维列表，无论<list>还是<set>都可以用来装配类型为Collection的任意实现或者数组的属性。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;hank2&quot; class=&quot;com.springinaction.springidol.OneManBand2&quot;&gt;</div><div class="line">  &lt;property name=&quot;instruments&quot;&gt;</div><div class="line">    &lt;map&gt;</div><div class="line">      &lt;entry key=&quot;PIANO&quot; value-ref=&quot;piano&quot;/&gt;</div><div class="line">      &lt;entry key=&quot;SAX&quot; value-ref=&quot;saxophone&quot;/&gt;</div><div class="line">    &lt;/map&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></set></list></p>
<p>装配map类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">import java.util.Collection;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">public class OneManBand2 implements Performer&#123;</div><div class="line">    public OneManBand2() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void perform() throws Exception &#123;</div><div class="line">        for (String key : instruments.keySet()) &#123;</div><div class="line">            System.out.println(key + &quot; : &quot;);</div><div class="line">            instruments.get(key).play();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Map&lt;String, Instrument&gt; instruments;</div><div class="line"></div><div class="line">    public void setInstruments(Map&lt;String, Instrument&gt; instruments) &#123;</div><div class="line">        this.instruments = instruments;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;hank2&quot; class=&quot;com.springinaction.springidol.OneManBand2&quot;&gt;</div><div class="line">  &lt;property name=&quot;instruments&quot;&gt;</div><div class="line">    &lt;map&gt;</div><div class="line">      &lt;entry key=&quot;PIANO&quot; value-ref=&quot;piano&quot;/&gt;</div><div class="line">      &lt;entry key=&quot;SAX&quot; value-ref=&quot;saxophone&quot;/&gt;</div><div class="line">    &lt;/map&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h2 id="使用表达式装配"><a href="#使用表达式装配" class="headerlink" title="使用表达式装配"></a>使用表达式装配</h2><p>Spring引入了表达式语言Spring Expression Language，SpEL通过运行期执行的表达式将值装配到Bean的属性和构造器参数中去。SpEL的特性包括：</p>
<pre><code>* 使用Bean的ID来引用Bean
* 调用方法和访问对象的属性
* 对值进行算数、关系和逻辑运算
* 正则表达式匹配
* 集合操作
</code></pre><h3 id="基本要素"><a href="#基本要素" class="headerlink" title="基本要素"></a>基本要素</h3><p> #{}会提示Spring这个标记里的内容时SpEL表达式，其格式可以为整型数，浮点数，科学计数法，字符串类型(单引号或者双引号都可以),bool类型</p>
<ul>
<li><p>字面值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;count&quot; value=&quot;#&#123;5&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;frequency&quot; value=&quot;#&#123;89.22&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;capacity&quot; value=&quot;#&#123;1e6&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;name&quot; value=&quot;#&#123;&quot;Chuck&quot;&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;name&quot; value=&quot;#&#123;&apos;Chuck&apos;&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;enable&quot; value=&quot;#&#123;false&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>引用Bean属性和方法<br>SpEL表达式不仅可以装配字面值，还可以装配Bean的属性和方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;carl&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;#&#123;kenny.song&#125;&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;carl&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;#&#123;songSelector.selectSong().toUpperCase()&#125;&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>返回值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;carl&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;#&#123;songSelector.selectSong().toUpperCase()&#125;&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>为NULL会报空指针错误，解决空指针错误的方法为使用null-safe存取器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;carl&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;#&#123;songSelector.selectSong()?.toUpperCase()&#125;&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<ul>
<li>操作类<br>T()运算符会调用类作用域的方法和常量。例如T(java.lang.Math)，该运算符可以调用指定类的静态方法和常量，当需要把PI装配到Bean中去：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;PI&quot; value=&quot;#&#123;T(java.lang.Math).PI&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="值操作"><a href="#值操作" class="headerlink" title="值操作"></a>值操作</h3><ul>
<li><p>运算符</p>
<ul>
<li><p>算数运算：+、-、<code>*</code>，/, %, ^</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;adjustedAmount&quot; value=&quot;#&#123;counter.total-20&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>关系运算：&lt;、&gt;、==、 &gt;=、 &lt;=、lt、 gt、 eq、 le、 ge</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;equal&quot; value=&quot;#&#123;counter.total == 100&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>逻辑运算：and、 or、 not、 |</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;largeCircle&quot; value=&quot;#&#123;shape.kind == &apos;circle&apos; and shape.perimeter gt 100000&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>条件运算：?:(ternary)、?:(Elvis)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;instrument&quot; value=&quot;#&#123;songSelector.selectSong()==&apos;Jingle Bells&apos;?piano:saxophone&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>正则表达式：matches</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;validEmail&quot; value=&quot;#&#123;admin.email matches &apos;[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.com&apos;&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h3 id="SpEL中筛选集合"><a href="#SpEL中筛选集合" class="headerlink" title="SpEL中筛选集合"></a>SpEL中筛选集合</h3><p>设定一个City类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class City &#123;</div><div class="line">    private String name;</div><div class="line">    private String state;</div><div class="line">    private int population;</div><div class="line"></div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setName(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getState() &#123;</div><div class="line">        return state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setState(String state) &#123;</div><div class="line">        this.state = state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int getPopulation() &#123;</div><div class="line">        return population;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPopulation(int population) &#123;</div><div class="line">        this.population = population;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>通过Spring的<util:list>元素定义一个City的List集合：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;util:list id=&quot;cities&quot;&gt;</div><div class="line">  &lt;bean class=&quot;com.springinaction.springidol.City&quot; p:name=&quot;Chicago&quot; p:state=&quot;IL&quot; p:population=&quot;285114&quot;/&gt;</div><div class="line">  &lt;bean class=&quot;com.springinaction.springidol.City&quot; p:name=&quot;Atlanta&quot; p:state=&quot;GA&quot; p:population=&quot;537958&quot;/&gt;</div><div class="line">  &lt;bean class=&quot;com.springinaction.springidol.City&quot; p:name=&quot;Dallas&quot; p:state=&quot;TX&quot; p:population=&quot;1279910&quot;/&gt;</div><div class="line">&lt;/util:list&gt;</div></pre></td></tr></table></figure></util:list></p>
<ul>
<li>访问集合成员：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;chosenCity&quot; value=&quot;#&#123;cities[1]&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;chosenCity&quot; value=&quot;#&#123;cities[T(java.lang.Math).random * cities.size()]&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>选择属性的方式：</p>
<ul>
<li>systemEnvironment：包含应用程序所在机器上的所有的环境变量，Propert集合<br><code>&lt;property name=&quot;homePath&quot; value=&quot;#{systemEnvironment[&#39;HOME&#39;]}&quot;/&gt;</code></li>
<li>systemProperties：包含了Java应用程序启动时所设置的所有的属性</li>
</ul>
<ul>
<li><p>查询集合成员<br>查询运算符<code>.?[]</code>，会创建一个新的集合存放符合条件的CITY：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;bigCities&quot; value=&quot;#&#123;cities.?[population gt 100000]&#125;&quot;/&gt;</div></pre></td></tr></table></figure>
<ul>
<li><code>.^[]</code>：从集合中查询出第一个匹配项</li>
<li><code>.$[]</code>：从集合中查询出最后一个匹配项</li>
</ul>
</li>
<li><p>投影集合<br><code>.![]</code>：从集合中的每一个成员中取出特定的属性放入一个新的集合中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;property name=&quot;CityName&quot; value=&quot;#&#123;cities.![name]&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;CityName&quot; value=&quot;#&#123;cities.![name + &apos;, &apos; + state]&#125;&quot;/&gt;</div><div class="line">&lt;property name=&quot;bigCities&quot; value=&quot;#&#123;cities.?[population gt 100000].![name + &apos;, &apos; + state]&#125;&quot; /&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h1 id="最小化Spring-XML配置"><a href="#最小化Spring-XML配置" class="headerlink" title="最小化Spring XML配置"></a>最小化Spring XML配置</h1><hr>
<p>Spring提供了几种技巧解决大量Bean下XML文件的配置：</p>
<ul>
<li>自动装配(autowiring)：有助于减少甚至消除配置<property>元素和<constructor-arg>元素，让Spring自动识别如何装配Bean的依赖关系。</constructor-arg></property></li>
<li>自动检测(autodiscovery)：比自动装配更进一步，让Spring能够自动识别哪些类需要被配置成Spring Bean，减少对<bean>的使用。</bean></li>
</ul>
<h2 id="自动装配Bean属性"><a href="#自动装配Bean属性" class="headerlink" title="自动装配Bean属性"></a>自动装配Bean属性</h2><h3 id="四种类型的自动装配"><a href="#四种类型的自动装配" class="headerlink" title="四种类型的自动装配"></a>四种类型的自动装配</h3><ul>
<li><p>byName：把与Bean的属性具有相同名字(ID)的其他Bean自动装配到Bean的对应属性中。如果没有和属性名字相匹配的Bean，则该属性不装配。<br>  kenny Bean中,使用property标签显式配置了instrument的属性，如果将saxophone Bean的名字改为instrument：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; &gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;Jingle Bells&quot; /&gt;</div><div class="line">  &lt;property name=&quot;instrument&quot; ref=&quot;saxophone&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>  等价于：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny3&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; autowire=&quot;byName&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;Jingle Bells&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;bean id=&quot;instrument&quot; class=&quot;com.springinaction.springidol.saxophone&quot;/&gt;</div></pre></td></tr></table></figure>
<p>  <em>byName自动装配遵循的一项约定：为属性自动装配ID与该属性的名字相同的Bean</em></p>
</li>
<li><p>byType：把与Bean的属性具有相同类型的其他Bean自动装配到Bean的对应属性中，如果没有跟属性的类型相匹配的Bean，则该属性不装配。<br>  与byName类似，不过是检查属性的类型，Spring会寻找哪一个Bean的类型与属性的类型相匹配，但是当Spring找到多个Bean的类型与属性相同时，会抛出错误，应用只允许一个与属性类型相同的Bean。解决方法是为：</p>
<pre><code>* 自动装配标示一个首选Bean,有且仅有一个Bean的primary=true
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;instrument&quot; class=&quot;com.springinaction.springidol.saxophone&quot; primary=&quot;true&quot;/&gt;</div></pre></td></tr></table></figure>

* 取消某个Bean自动装配的资格。
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;instrument&quot; class=&quot;com.springinaction.springidol.saxophone&quot; autowire-candidate=&quot;false&quot; /&gt;</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>constructor：把与Bean的构造器入参具有相同类型的其他Bean自动装配到Bean构造器对应入参中去。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;duke1&quot; class=&quot;com.springinaction.springidol.PoeticJuggler&quot; autowire=&quot;constructor&quot;/&gt;</div></pre></td></tr></table></figure>
<p>  Spring会去寻找和Bean的构造方法中的属性类型相同的Bean注入到当前Bean，局限性和byType一样。多个合适的Bean或者多个构造器都会出错。</p>
</li>
<li>autodetect：首先尝试用constructor进行自动装配，如果失败，再尝试用byType进行自动装配。</li>
</ul>
<h3 id="默认自动装配"><a href="#默认自动装配" class="headerlink" title="默认自动装配"></a>默认自动装配</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;beans ...  default-autowire=&quot;byType&quot;&gt;</div></pre></td></tr></table></figure>
<p>该参数的默认值为none,特定Bean可以设定其自动装配方式来覆盖默认的装配方式。</p>
<h3 id="混合使用自动装配和显示装配"><a href="#混合使用自动装配和显示装配" class="headerlink" title="混合使用自动装配和显示装配"></a>混合使用自动装配和显示装配</h3><p>对某个Bean选择了自动装配策略，同时也可以进行显示装配。可以通过显示装配来解决自动装配中存在的不确定的问题，覆盖掉其自动装配的值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;kenny4&quot; class=&quot;com.springinaction.springidol.Instrumentalist&quot; autowire=&quot;byType&quot;&gt;</div><div class="line">  &lt;property name=&quot;song&quot; value=&quot;Jingle Bell&quot; /&gt;</div><div class="line">  &lt;property name=&quot;instrument&quot;&gt;&lt;null /&gt;&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<ul>
<li><em>NOTE：不能混合使用constructor自动装配策略和<constructor-arg>元素</constructor-arg></em></li>
</ul>
<h2 id="使用注解装配"><a href="#使用注解装配" class="headerlink" title="使用注解装配"></a>使用注解装配</h2><p>Spring默认不使用注解，使用注解需要在XML中进行配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line">&lt;context:annotation-config /&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>Spring支持几种不同的用于自动装配的注解：</p>
<pre><code>* Spring自带的@Autowired注解
* JSR-330的@Inject注解
* JSR-250的@Resource注解
</code></pre><h3 id="使用-Autowired注解"><a href="#使用-Autowired注解" class="headerlink" title="使用@Autowired注解"></a>使用@Autowired注解</h3><p>对属性的setter方法添加注解：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Autowired</div><div class="line">public void setInstrument(Instrument instrument) &#123;</div><div class="line">    this.instrument = instrument;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Autowired注解可以用在setter方法，任意方法以及构造方法。当对构造器进行标注时，Autowired注解表示当创建Bean时，即使在Spring XML文件中没有使用<constructor-arg>元素配置Bean，该构造器也需要进行自动装配。我们也可以使用@AutoWired注解直接标注属性，并删除setter方法。@AutoWired存在问题在于没有Bean装配到注解属性或者多个Bean装配到注解属性：</constructor-arg></p>
<ul>
<li><p>可选的自动装配：@Autowired所标注的属性和参数必须是可装配的，如果没有Bean装配到所标注的属性和参数时，会报错。设定required参数来限定@Autowired，当没有找到可装载的Bean时，属性和参数的值为NULL。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Autowired(required = false)</div><div class="line">private Instrument instrument;</div></pre></td></tr></table></figure>
<p>  但是当其注解构造方法时，只能有一个构造器的required的值为true。</p>
</li>
<li><p>限定歧义性的依赖：当有同时满足装配的条件的多个Bean存在时，Spring会抛出NoSuchBeanDefineException错误，表明装配失败。使用@Qualifier注解来制定装配的具体Bean：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@AutoWired</div><div class="line">@Qualifier(&quot;guitar&quot;)</div><div class="line">private Instrument instrument;</div></pre></td></tr></table></figure>
<p>  XML配置也可以同样使用qualifier标签来缩小Bean搜索范围：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean class=&quot;com.springinaction.springidol.Piano&quot;&gt;</div><div class="line">  &lt;qualifier value=&quot;piano&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>自定义的限定器<br>  使用@Qualifier作为自定义注解的元注解：@</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Qualifier</div><div class="line">public @Interface StringedInstrument&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  这样就可以用@StringedInstrument注解来标注guitar</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@StringedInstrument</div><div class="line">public class Guitar implements Instrument&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  自动装配时对Instrument进行限定，从而查找所有被StringedInstrument标注的Bean，不能确定到一个Bean会再进行其他限定。</p>
<blockquote>
<p>使用@Autowired的缺点在于引入了对Spring注解的依赖，可以使用Java的@Inject注解来解决这个问题</p>
</blockquote>
</li>
</ul>
<h3 id="Inject注解"><a href="#Inject注解" class="headerlink" title="@Inject注解"></a><code>@</code>Inject注解</h3><p>与Spring的@Autowired注解类似，JCP的@Inject注解可以用来自动装配属性、方法和构造器；区别在于@Inject没有required属性，所有其所标注的依赖关系必须存在！</p>
<ul>
<li><p>限定@Inject使用注解@Named</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Inject</div><div class="line">@Named(&quot;guitar&quot;)</div><div class="line">private Instrument Instrument;</div></pre></td></tr></table></figure>
<blockquote>
<p>@Named注解表明选择了一个Bean，@Qualifier表明满足条件的Bean</p>
</blockquote>
</li>
<li><p>自定义的JSR-330 Qualifier</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Qualifier</div><div class="line">public @Interface StringedInstrument&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>  区别在于这里的@Qualifier来自JSR-330而不是Spring</p>
</li>
</ul>
<h3 id="注解中使用表达式"><a href="#注解中使用表达式" class="headerlink" title="注解中使用表达式"></a>注解中使用表达式</h3><p><code>@Value</code>可以用来装配String类型的值和基本类型的值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@value(&quot;Eruption&quot;)</div><div class="line">private String song;</div></pre></td></tr></table></figure></p>
<p>SpEL和注解结合,实现注解驱动的装配方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@value(&quot;#&#123;systemProperties.myFavoriteSong&#125;&quot;)</div><div class="line">private String song;</div></pre></td></tr></table></figure></p>
<h2 id="自动检测Bean"><a href="#自动检测Bean" class="headerlink" title="自动检测Bean"></a>自动检测Bean</h2><p><code>&lt;context:annotation-config&gt;</code>可以消除Bean里面的配置，<code>&lt;context:component-scan&gt;</code>还可以完成自动检测Bean的功能，从而XML中不需要创建Bean：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line">&lt;context:component-scan base-package=&quot;com.springinaction.springidol&quot;/&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<h3 id="标注Bean"><a href="#标注Bean" class="headerlink" title="标注Bean"></a>标注Bean</h3><p>context:component-scan默认查找构造型注解所标注的类：</p>
<ul>
<li><code>@Component</code> 通用的构造型注解，标示该类为Spring组件</li>
<li><code>@Controller</code> 标示该类定义为SpringMVC controller</li>
<li><code>@Repository</code> 标识将该类定义为数据仓库</li>
<li><code>@Service</code> 标识将该类定义为服务</li>
<li><code>@Component</code>也可以标注自定义注解</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">@Component</div><div class="line">public class Guitar implements Instrument&#123;</div><div class="line">    @Override</div><div class="line">    public void play() &#123;</div><div class="line">        System.out.println(&quot;ssss ddd fff .&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Spring扫描com.springinaction.springidol包时，会发现@Component注解标识的Guitar类，将其自动注册为Spring Bean。默认ID为guitar。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">import org.springframework.beans.factory.annotation.Autowired;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">@Component(&quot;eddie&quot;)</div><div class="line">public class Instrumentalist implements Performer&#123;</div><div class="line">...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="过滤组件扫描"><a href="#过滤组件扫描" class="headerlink" title="过滤组件扫描"></a>过滤组件扫描</h3><p>Spring默认会扫描包下的所有类的@Component注解来生成Bean，我们可以自己定义过滤规则来实现自动注册特定的类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan base-package=&quot;com.springinaction.springidol&quot;&gt;</div><div class="line">    &lt;context:include-filter type=&quot;assignable&quot; expression=&quot;com.springinaction.springidol.Instrument&quot;</div><div class="line">&lt;/context:component-scan&gt;</div></pre></td></tr></table></figure></p>
<p>可以自动将所有派生与Instrument的类注册到Spring Bean中。<br>过滤器类型包含5种：</p>
<ul>
<li>annotation：顾虑器扫描使用指定注解所标注的那些类，通过expression属性指定要扫描的注解</li>
<li>assignable：过滤器通过扫描派生于expression属性所指定的那些类</li>
<li>aspectj：过滤器扫描与expression属性所指定的AspectJ表达式所匹配的类</li>
<li>custom：使用自定义的org.springframework.core.type.TypeFilter实现类，该类由expression属性指定</li>
<li>regex：过滤器扫描类的名称与expression属性所指定的正则表达式所匹配的那些类。</li>
</ul>
<p>context:exclude-filter表示不注册那些类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;context:component-scan base-package=&quot;com.springinaction.springidol&quot;&gt;</div><div class="line">    &lt;context:include-filter type=&quot;assignable&quot; expression=&quot;com.springinaction.springidol.Instrument&quot;/&gt;</div><div class="line">    &lt;context:exclude-filter type=&quot;assignable&quot; expression=&quot;com.springinaction.springidol.Instrumentalist&quot;/&gt;</div><div class="line">&lt;/context:component-scan&gt;</div></pre></td></tr></table></figure></p>
<h2 id="使用Spring基于Java的配置"><a href="#使用Spring基于Java的配置" class="headerlink" title="使用Spring基于Java的配置"></a>使用Spring基于Java的配置</h2><h3 id="启动Java配置"><a href="#启动Java配置" class="headerlink" title="启动Java配置"></a>启动Java配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</div><div class="line">    &lt;context:component-scan base-package=&quot;com.springinaction.springidol&quot;/&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<p>context:component-scan会自动加载@Configuration注解的类。</p>
<h3 id="定义一个配置类"><a href="#定义一个配置类" class="headerlink" title="定义一个配置类"></a>定义一个配置类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">import org.springframework.context.annotation.Configuration;</div><div class="line"></div><div class="line">@Configuration</div><div class="line">public class SpringIdolConfig &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>@</code>Configuration注解会告知Spring，这个类将包含一个或者多个Bean的定义。</p>
<h3 id="声明一个Bean"><a href="#声明一个Bean" class="headerlink" title="声明一个Bean"></a>声明一个Bean</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">public Performer duke() &#123;</div><div class="line">    return new Juggler();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>等价于XML中配置<bean>标签。@Bean告知Spring这个方法将返回一个对象，该对象应该被注册到Spring应用上下文中的一个Bean。</bean></p>
<h3 id="使用Spring的基于Java的配置进行注入"><a href="#使用Spring的基于Java的配置进行注入" class="headerlink" title="使用Spring的基于Java的配置进行注入"></a>使用Spring的基于Java的配置进行注入</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">public Performer duke10() &#123;</div><div class="line">  return new Juggle(15);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">private Poem sonnet29()&#123;</div><div class="line">  return new sonnet29();</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Bean</div><div class="line">private Performer pueticDuke()&#123;</div><div class="line">  return new PoeticJuggler(sonnet29());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h1 id="面向切面的Spring"><a href="#面向切面的Spring" class="headerlink" title="面向切面的Spring"></a>面向切面的Spring</h1><p>两个概念：</p>
<ul>
<li>横切关注点：分布于应用中的多处的功能，例如安全、日志、事务管理等。</li>
<li>AOP：将横切关注点和业务逻辑进行分离</li>
</ul>
<h2 id="面向切面编程"><a href="#面向切面编程" class="headerlink" title="面向切面编程"></a>面向切面编程</h2><p>Spring中首先在一个地方定义通用功能，然后通过声明的方式定义一个功能以何种方式在何处应用，而无需修改受影响的类。横切关注点可以被模块化为特殊的类，这些类成为切面。其好处有两点：</p>
<ul>
<li>每个关注点集中与移除</li>
<li>服务模块更简洁</li>
</ul>
<h3 id="定义AOP术语"><a href="#定义AOP术语" class="headerlink" title="定义AOP术语"></a>定义AOP术语</h3><ul>
<li><p>通知(Advice)：通知定义了切面是什么以及如何使用。Spring切面可以应用的5中类型的通知：</p>
<ul>
<li>Before：在方法被调用之前调用通知</li>
<li>After：在方法完成之后调用通知，无论方法执行是否成功</li>
<li>After-retruning：在方法成功执行之后调用通知</li>
<li>After-throwing：在方法抛出异常后调用通知</li>
<li>Around：通知包裹了被通知的方法，在被通知的方法调用之前和调用之后执行自定义的行为。</li>
</ul>
</li>
<li><p>连接点(Joinpoint)：在应用执行过程中能够插入切面的一个点。</p>
</li>
<li>切点(Poincut)：指定了切面应用的范围。</li>
<li>切面(Aspect)：切面是切点和通知的结合。</li>
<li>引入(Introduction)：引用允许我们向现有的类添加新方法和属性。</li>
<li>织入(Weaving)：织入是将切面应用到目标对象来创建新的代理对象的过程。切面在指定的连接点被织入到目标对象中去。在目标对象的声明周期中有多个点可以进行织入：<ul>
<li>编译期：需要特殊的编译器，AspectJ的织入编译器就是以这种方式织入的。</li>
<li>类加载期：切面在目标类加载到JVM时被织入。这种方式需要特殊的类加载器(ClassLoader)，在引入之前增强该类的字节码。</li>
<li>运行期：切面在应用运行的某个时刻被织入。一般在织入切面时，AOP容器会为目标对象动态的创建一个代理对象。Spring AOP就是这样。</li>
</ul>
</li>
</ul>
<h3 id="Spring对AOP的支持"><a href="#Spring对AOP的支持" class="headerlink" title="Spring对AOP的支持"></a>Spring对AOP的支持</h3><p>Spring提供了4种AOP支持：</p>
<ul>
<li>基于代理的经典AOP</li>
<li><code>@AspectJ</code>注解驱动的切面</li>
<li>纯POJO切面</li>
<li>注入式AspectJ切面</li>
</ul>
<p>一些关键点：</p>
<ul>
<li>Spring通知是Java编写的</li>
<li>Spring在运行期间通知对象</li>
<li>Spring只支持方法连接点</li>
</ul>
<h2 id="使用切点选择连接点"><a href="#使用切点选择连接点" class="headerlink" title="使用切点选择连接点"></a>使用切点选择连接点</h2><p>Spring AOP中需要使用AspectJ的切点表达式语言来定义切点。</p>
<table>
<thead>
<tr>
<th style="text-align:left">AspectJ指示器</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">arg()</td>
<td style="text-align:center">限制连接点匹配参数为指定类型的执行方法</td>
</tr>
<tr>
<td style="text-align:left">@args()</td>
<td style="text-align:center">限制连接点匹配参数由指定注解的执行方法</td>
</tr>
<tr>
<td style="text-align:left">execution()</td>
<td style="text-align:center">用于匹配是连接点的执行方法</td>
</tr>
<tr>
<td style="text-align:left">this()</td>
<td style="text-align:center">限制连接点匹配AOP代理的Bean引用为指定类型的类</td>
</tr>
<tr>
<td style="text-align:left">target()</td>
<td style="text-align:center">限制连接点匹配目标对象为指定类型的类</td>
</tr>
<tr>
<td style="text-align:left">@target()</td>
<td style="text-align:center">限制连接点匹配特定的执行对象，这些对象对应的类要具备指定类型的注解</td>
</tr>
<tr>
<td style="text-align:left">within()</td>
<td style="text-align:center">限制连接点匹配指定的类型</td>
</tr>
<tr>
<td style="text-align:left">@within()</td>
<td style="text-align:center">限制连接点匹配指定注解所标注的类型</td>
</tr>
<tr>
<td style="text-align:left">@annotation()</td>
<td style="text-align:center">限制匹配带有指定注解连接点</td>
</tr>
</tbody>
</table>
<p>只有execution指示器是唯一的执行匹配，其他都是限制匹配。</p>
<h3 id="编写切点"><a href="#编写切点" class="headerlink" title="编写切点"></a>编写切点</h3><p><code>execution(* com.springinaction.springidol.Instrument.play(..))</code><br>我们使用execution()指示器去选择Instrument的play()方法。方法表达式以<em>开始，标示了方法返回值的类型，然后指定全限定类名和方法名，使用(..)标示切点选择任意的play方法。<br>如果需要限定匹配该包下的play方法，需要添加限定<br>`execution(</em> com.springinaction.springidol.Instrument.play(..)) and withi n(com.springinaction.springidol.*)`</p>
<h3 id="使用Spring的bean-指示器"><a href="#使用Spring的bean-指示器" class="headerlink" title="使用Spring的bean()指示器"></a>使用Spring的bean()指示器</h3><p>bean()指示器允许我们在切点表达式中使用Bean的ID来标识Bean。<br><code>execution(* com.springinaction.springidol.Instrument.play() and bean(eddie))</code>表示限定Bean的ID为Eddie。</p>
<h2 id="在XML中声明切面"><a href="#在XML中声明切面" class="headerlink" title="在XML中声明切面"></a>在XML中声明切面</h2><p>Spring的AOP配置元素简化了基于POJO切面的声明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">AOP配置元素</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><aop:advisor></aop:advisor></td>
<td style="text-align:left">定义AOP通知器</td>
</tr>
<tr>
<td style="text-align:left"><aop:after></aop:after></td>
<td style="text-align:left">定义AOP后置通知，不管通知的方法是否执行成功</td>
</tr>
<tr>
<td style="text-align:left"><aop:after-returning></aop:after-returning></td>
<td style="text-align:left">定义AOP After-retruning通知</td>
</tr>
<tr>
<td style="text-align:left"><aop:after-throwing></aop:after-throwing></td>
<td style="text-align:left">定义After-throwing通知</td>
</tr>
<tr>
<td style="text-align:left"><aop:around></aop:around></td>
<td style="text-align:left">定义AOP环绕通知</td>
</tr>
<tr>
<td style="text-align:left"><aop:aspect></aop:aspect></td>
<td style="text-align:left">定义切面</td>
</tr>
<tr>
<td style="text-align:left"><aop:aspect-autoproxy></aop:aspect-autoproxy></td>
<td style="text-align:left">启用@AspectJ注解驱动的切面</td>
</tr>
<tr>
<td style="text-align:left"><aop:before></aop:before></td>
<td style="text-align:left">定义AOP前置通知</td>
</tr>
<tr>
<td style="text-align:left"><aop:config></aop:config></td>
<td style="text-align:left">顶层的AOP配置元素，大多数的<aop:*>元素必须在<aop:config>元素内部</aop:config></aop:*></td>
</tr>
<tr>
<td style="text-align:left"><aop:declare-parents></aop:declare-parents></td>
<td style="text-align:left">为被通知的对象引入额外的接口，并透明的实现</td>
</tr>
<tr>
<td style="text-align:left"><aop:pointcut></aop:pointcut></td>
<td style="text-align:left">定义切点</td>
</tr>
</tbody>
</table>
<p>选秀节目需要装配观众，每一个选手都需要装配同样的观众，创建一个观众类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">package com.springinaction.springidol;</div><div class="line"></div><div class="line">public class Audience &#123;</div><div class="line">    //before perform</div><div class="line">    public void takeSeats() &#123;</div><div class="line">        System.out.println(&quot;The Audience is taking their seats!&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void turnOffCellPhone() &#123;</div><div class="line">        System.out.println(&quot;The audience is turning off their cell phones.&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //after perform</div><div class="line">    public void applaud() &#123;</div><div class="line">        System.out.println(&quot;Clap! Clap! Clap!&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //after perform failure</div><div class="line">    public void demandRefund() &#123;</div><div class="line">        System.out.println(&quot;We want our money back!&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将其注册为Spring上下文的一个Bean：<code>&lt;bean id=&quot;audience&quot; class=&quot;com.springinaction.springidol.Audience&quot;/&gt;</code></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/Redis-redis基础总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/Redis-redis基础总结/" itemprop="url">Redis-redis基础总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/redis/" itemprop="url" rel="index">
                    <span itemprop="name">redis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="redis简介"><a href="#redis简介" class="headerlink" title="redis简介"></a>redis简介</h1><p>redis是一个开源的，C语言编写的、支持网络交互的，可基于内存也可以持久化的key-value数据库，是当前最为热门的非关系型数据库。其官网为redis.io。</p>
<h2 id="redis的安装"><a href="#redis的安装" class="headerlink" title="redis的安装"></a>redis的安装</h2><ol>
<li>下载redis源码并解压缩</li>
<li>进入redis源码目录，make编译一下。</li>
<li>make install PREFIX=/usr/local/redis</li>
</ol>
<p>安装完毕，其目录如下：</p>
<blockquote>
<p>./redis-benchmark //用于进行redis性能测试的工具<br>  ./redis-check-dump //用于修复出问题的dump.rdb文件<br>  ./redis-cli //redis的客户端<br>  ./redis-server //redis的服务端<br>  ./redis-check-aof //用于修复出问题的AOF文件<br>  ./redis-sentinel //用于集群管理</p>
</blockquote>
<h2 id="redis的使用"><a href="#redis的使用" class="headerlink" title="redis的使用"></a>redis的使用</h2><p>./redis-server redis.conf 可指定配置文件并启动redis服务，默认端口号为6379。可以通过redis-cli或者可视化的客户端如redis management来远程登录操作服务器。</p>
<h1 id="redis的五种数据类型"><a href="#redis的五种数据类型" class="headerlink" title="redis的五种数据类型"></a>redis的五种数据类型</h1><ol>
<li>String</li>
</ol>
<p>字符串是redis最基本的数据类型，一个key对应一个value.String类型是二进制安全的。也就是说redis的String可以包含任何数据。比如JPG图片或者序列化的对象。String类型是redis最基本的数据类型，一个redis中字符串value最多可以是512M。</p>
<p>基本操作包括get、set、incr、decr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; set mynum &quot;2&quot;</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; get mynum</div><div class="line">&quot;2&quot;</div><div class="line">127.0.0.1:6379&gt; incr mynum</div><div class="line">(integer) 3</div><div class="line">127.0.0.1:6379&gt; get mynum</div><div class="line">&quot;3&quot;</div></pre></td></tr></table></figure>
<p>考虑到INCR等指令本身就具有原子操作的特性，可以利用redis的INCR，DECR等指令来实现原子计数，用这个特性来实现业务上的统计技术需求。</p>
<ol>
<li>Hash</li>
</ol>
<p>Hash是一个键值对集合,相当于一个key对应一个map，map中还有键值对。使用hash对key进行归类。</p>
<p>基本操作包括hset、hget。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; HMSET user:001 username antirez password P1pp0 age 34</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; HGETALL user:001</div><div class="line">1) &quot;username&quot;</div><div class="line">2) &quot;antirez&quot;</div><div class="line">3) &quot;password&quot;</div><div class="line">4) &quot;P1pp0&quot;</div><div class="line">5) &quot;age&quot;</div><div class="line">6) &quot;34&quot;</div><div class="line">127.0.0.1:6379&gt; HSET user:001 password 12345</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; HGETALL user:001</div><div class="line">1) &quot;username&quot;</div><div class="line">2) &quot;antirez&quot;</div><div class="line">3) &quot;password&quot;</div><div class="line">4) &quot;12345&quot;</div><div class="line">5) &quot;age&quot;</div><div class="line">6) &quot;34&quot;</div></pre></td></tr></table></figure>
<ol>
<li>List</li>
</ol>
<p>列表在低层的实现为链表，则其插入和删除的效率非常高。其存在的缺点在于链表中元素的定位比较慢。</p>
<p>其基本操作包括lpush,rpush,lrange等,也就是从左侧插入，右侧插入以及指定一个范围来提取元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; lpush mylist &quot;1&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; rpush mylist &quot;2&quot;</div><div class="line">(integer) 2</div><div class="line">127.0.0.1:6379&gt; lpush mylist &quot;0&quot;</div><div class="line">(integer) 3</div><div class="line">127.0.0.1:6379&gt; lrange mylist 0 1</div><div class="line">1) &quot;0&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</div><div class="line">1) &quot;0&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">3) &quot;2</div></pre></td></tr></table></figure>
<p>list的使用场景包括：</p>
<ul>
<li>利用lists来实现一个消息队列，可以确保消息的顺序执行。</li>
<li>利用LRANGE实现分页功能</li>
</ul>
<ol>
<li>Set</li>
</ol>
<p>集合和Java中的集合定义类似，无序，不重合。可以对集合进行添加，删除，取交集，取并集，取差集等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; sadd myset &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; sadd myset &quot;two&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; smembers myset</div><div class="line">1) &quot;one&quot;</div><div class="line">2) &quot;two&quot;</div><div class="line">127.0.0.1:6379&gt; sismember myset &quot;one&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; sismember myset &quot;three&quot;</div><div class="line">(integer) 0</div><div class="line">127.0.0.1:6379&gt; sadd yourset &quot;1&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; sadd yourset &quot;2&quot;</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; smembers yourset</div><div class="line">1) &quot;1&quot;</div><div class="line">2) &quot;2&quot;</div><div class="line">127.0.0.1:6379&gt; sunion myset yourset</div><div class="line">1) &quot;1&quot;</div><div class="line">2) &quot;one&quot;</div><div class="line">3) &quot;2&quot;</div><div class="line">4) &quot;two&quot;</div></pre></td></tr></table></figure>
<ol>
<li>zset</li>
</ol>
<p>有序集合，每个元素都关联一个score，据此来进行排序。常用操作有zrange,zadd,zreevrange,zrangebyscore等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; zadd myzset 1 baidu.com</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; zadd myzset 3 360.com</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; zadd myzset 2 google.com</div><div class="line">(integer) 1</div><div class="line">127.0.0.1:6379&gt; zrange myzset 0 -1 with scores</div><div class="line">1) &quot;baidu.com&quot;</div><div class="line">2) &quot;1&quot;</div><div class="line">3) &quot;google.com&quot;</div><div class="line">4) &quot;2&quot;</div><div class="line">5) &quot;360.com&quot;</div><div class="line">6) &quot;3&quot;</div><div class="line">127.0.0.1:6379&gt; zrange myzset 0 -1</div><div class="line">1) &quot;baidu.com&quot;</div><div class="line">2) &quot;google.com&quot;</div><div class="line">3) &quot;360.com&quot;</div></pre></td></tr></table></figure>
<h1 id="redis持久化"><a href="#redis持久化" class="headerlink" title="redis持久化"></a>redis持久化</h1><p>redis提供了两种持久化方案：RDB和AOF。</p>
<h2 id="RDB-Redis-Database"><a href="#RDB-Redis-Database" class="headerlink" title="RDB-Redis Database"></a>RDB-Redis Database</h2><ul>
<li><p>rdb是将redis某一个时刻的数据持久化到磁盘中，是一种快照式的持久化方法。redis在持久化过程中，会将数据都写入到一个临时文件中，待持久化过程都结束了，才会用这个临时文件替换上次持久化好的dump.rdb。保证快照文件试完整可用的，可以随时进行备份。</p>
</li>
<li><p>RDB进行持久化过程时，redis会单独fork一个子进程来进行持久化，而主进程不会进行任何的IO操作，从而保证了redis的高性能。</p>
<ul>
<li>fork的作用是复制一个和当前进程一样的进程。新进程的所有数据数值和原进程一致，但是是一个全新的进程，并作为原进程的子进程。</li>
</ul>
</li>
<li><p>RDB快照的触发方法</p>
<ul>
<li>配置文件中默认的快照配置，cp后重新使用。</li>
<li>命令save、bgsave，其中save时只保存，其他全部阻塞，bgsave会在后台进行快照操作，快照同时还可以响应客户端的请求，可以通过lastsave命令获取最后一次成功执行快照的时间。</li>
<li>使用flushall命令，不过里面是空的，无意义。</li>
</ul>
</li>
<li><p>RDB的优势和劣势</p>
<ul>
<li>优势：如果需要进行大规模的数据恢复，且对于数据恢复的完整性不是非常敏感，nameRDB方式要比AOF方式更加的高效。</li>
<li>劣势：RDB的缺点在于如果对于数据完整性要求比较高，则当redis故障时，会丢失掉最后一次快照后的所有数据。而如果持久化频率太高，会增加服务器的多余压力。同时fork时，内存中的数据被复制了一份，内存膨胀需要考虑。</li>
</ul>
</li>
</ul>
<h2 id="AOF-Append-Only-File"><a href="#AOF-Append-Only-File" class="headerlink" title="AOF-Append Only File"></a>AOF-Append Only File</h2><ul>
<li><p>AOF,只允许对文件追加。AOF采用的持久化方案是将执行过的写指令记录下来，在数据恢复时按照从前到后的顺序将指令都执行一遍。AOF的开启可以通过修改redis.conf中的appendonly yes来设置。此时，如果有写操作，都会追加到AOF文件的末尾。默认的AOF持久化策略为每秒种fsync一次，由于向磁盘中写一个指令对系统的压力很小，因此此时redis保持高效运行。而redis重启时根据日志文件顺次执行其指令来完成数据恢复。</p>
</li>
<li><p>redis出现故障，丢失的数据也就是这1s没有被同步的数据。同时在追加日志时，恰好遇到磁盘空间满，断电等情况导致日志写入不完整，此时redis提供了redis-check-aof工具来修复日志。</p>
<p>  如果AOF文件出现了被写坏的情况，可以通过以下步骤来修复：</p>
<pre><code>* 备份被写坏的AOF文件
* 运行redis-check-aof-fix进行修复
* 用diff -u来查看两个文件的差异，确认问题点
* 重启redis,加载修改后的AOF文件
</code></pre></li>
</ul>
<ul>
<li><p>重写机制：bgrewriteaof</p>
<ul>
<li><p>追加方式会导致AOF文件越来越大，因此redis提供了AOF文件重写机制，也就是当AOF文件的大小超过所设定的阈值时，redis会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集。比如，如果我们队一个字符串的值进行了1000次INCR，AOF中应该记录1000条指令，这时候我们完全可以用一个set的值，将其设置为正确的数据。同时AOF重写过程中，仍然是采用先写临时文件，全部完成后再替换的流程，所以断电、磁盘满等问题都不会影响AOF文件的可用性。</p>
</li>
<li><p>重写原理：</p>
<ul>
<li>重写时会fork一个新进程来将文件进行重写，先写临时文件然后rename覆盖。重写过程为遍历此时内存中的数据，每条数据有一条对应的set语句。重写AOF文件的操作并不是读取旧的AOF文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的AOF文件，类似于快照。</li>
</ul>
</li>
<li><p>重写触发条件：</p>
<ul>
<li>redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后的大小的一倍且文件大于64M时触发。</li>
</ul>
</li>
</ul>
</li>
<li><p>AOF的优势和劣势</p>
<ul>
<li><p>AOF的优势：</p>
<ul>
<li>每秒同步，异步操作，每秒记录，如果1s以内的宕机，有数据丢失</li>
<li>不需要同步</li>
</ul>
</li>
<li><p>AOF的缺陷主要有两个方面：</p>
<ul>
<li>同样数据规模的情况下，AOF文件要比RDB文件的体积大。</li>
<li>AOF方式的恢复速度也要慢于RDB方式。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="选择方案"><a href="#选择方案" class="headerlink" title="选择方案"></a>选择方案</h2><p>RDB持久化方式能够在指定时间间隔内对你的数据进行快照存储。而AOF持久化方式能记录每次对服务器写的操作，当服务器重启时重新执行这些命令来回复原始数据，AOF命令以redis协议追加保存每次写的操作到文件末尾。Redis还能对AOF文件进行后台重写，使得AOF文件不至于过大。</p>
<ul>
<li>两种方式都开启来提供更加可靠的持久化方案</li>
</ul>
<p>这种情况下，当redis重启时会优先载入AOF文件来回复原始的数据，因为在通常的情况下AOF文件保存的数据比RDB文件要更加完整。而RDB作为候选方案，对当前内存的数据进行定期的备份，来防范AOF可能存在的BUG。</p>
<ul>
<li>性能建议</li>
</ul>
<p>考虑到RDB做数据备份，建议在Slave上持久化RDB文件。</p>
<p>如果这时候Enable AOF，好处是最坏的情况下丢失的数据也不会超过2s，启动脚本简单的load自己的AOF文件就可以看，代价是带来了持续的IO，以及rewrite过程中将产生的新数据写到新文件造成的阻塞难以避免。在磁盘允许的情况下，应该尽量减少AOF重写的频率。</p>
<p>如果不Enable AOF，仅仅依靠主从复制来实现高可靠也是可以的。这样能节省一大笔IO操作，也减少了rewrite时带来的系统资源占用，但是如果master和slave同时坏掉，会丢失十几分钟的数据，启动脚本要比较Master、Slave中的RDB文件，载入比较新的哪一个。</p>
<h1 id="redis的主从复制"><a href="#redis的主从复制" class="headerlink" title="redis的主从复制"></a>redis的主从复制</h1><p>redis支持主从同步的，同时支持一主多从以及多级从结构。主从结构的优点在于：</p>
<ul>
<li>冗余备份</li>
<li>提升读性能。</li>
</ul>
<p>redis主从结构中，一般推荐关闭主服务器的数据持久化功能，只让从服务器进行数据持久化，这样可以提高主服务器的处理性能，。。</p>
<p>主从架构中，从服务器通常设置为只读模式，这样可以避免从服务器的数据被误修改。但是从服务器仍然可以接受config等指令，不应该将从服务器直接暴露到不安全的网络环境中。如果必须如此，需要考虑给其指令进行重命名，避免误操作。</p>
<h2 id="主从同步的配置方法"><a href="#主从同步的配置方法" class="headerlink" title="主从同步的配置方法"></a>主从同步的配置方法</h2><ol>
<li>配置的是Slave库。</li>
<li>从库配置：slaveof 主库ip 主库port， 每次与master断开之后，都需要进行重新连接，除非你配置进redis.conf中的info replication。</li>
<li>修改配置文件的细节操作：<ul>
<li>拷贝多个redis.conf文件</li>
<li>开启daemonize yes</li>
<li>pid文件名字</li>
<li>指定端口</li>
<li>log文件名称</li>
<li>dump.rdb文件名称。</li>
</ul>
</li>
</ol>
<h2 id="一主二仆的配置"><a href="#一主二仆的配置" class="headerlink" title="一主二仆的配置"></a>一主二仆的配置</h2><ul>
<li>初始化启动一个Master和两个Slave</li>
<li>查看日志包括主机，备份机的日志，以及info replication</li>
<li>上一个Slave可以是下一个Slave的Master，Slave同样可以接受其他Slave的连接和同步请求，那么该Slave作为了链条中的下一个的Master，可以有效减轻master的写压力。</li>
<li>中途变更转向时会清除之前的数据，重新拷贝最新的slaveof ip port</li>
<li>slaveof no one， 使得当前的数据库停止与其他数据库的同步，转成主数据库。</li>
</ul>
<h2 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h2><ol>
<li>Slave启动成功连接到master之后会发送一个sync命令。</li>
<li>Master接到命令后，调用bgsave指令来创建一个子进程专门进行数据持久化工作，也就是讲主服务器的数据写入RDB文件中。在数据持久化过程中，主服务器将执行的写指令都缓存在内存中。</li>
<li>bgsave指令完成之后，主服务器会将持久化好的RDB文件发送给服务器，从服务器接到此文件后会将其存储到磁盘上，然后再将读取到内存中。这个动作完成之后，主服务器会将这段时间缓存的写指令以redis协议的格式发送给从服务器。也就是全量复制和增量复制结合使用。</li>
</ol>
<ul>
<li>全量复制与增量复制<ul>
<li>全量复制：slave服务在接收到数据库文件数据之后，将其存盘并加载到内存中。</li>
<li>增量复制：master继续将新的收集到的修改命令依次传给slave，完成同步。</li>
</ul>
</li>
<li><p>多个从服务器同时发来SYNC指令，主服务器也只会执行一个bgsave，然后把持久化好的RDB文件发送给多个下游节点。redis2.8之前，从服务器和主服务器断开连接之后，都会进行一次主从之间的全量数据同步，2.8之后，redis支持效率更高的增量同步策略。</p>
</li>
<li><p>主服务器会在内存中维护一个缓冲区，缓冲区中存储着将要发给从服务器的内容。从服务器在与主服务器出现网络瞬间断开之后，从服务器会尝试与主服务器连接，一旦连接成功，从服务器就会把希望同步的主服务器ID和希望请求的数据偏移量位置发送给主服务器。主服务器接收到这种同步请求之后，首先会验证主服务器ID是否和自己的ID匹配，其次会检查请求的偏移量是否存在于自己的缓冲区中，如果两者都满足的话，主服务器会向服务器发送增量内容。</p>
</li>
</ul>
<h1 id="redis事务管理"><a href="#redis事务管理" class="headerlink" title="redis事务管理"></a>redis事务管理</h1><p>redis事务处理的基础为MULTI、EXEC、DISCARD、WATCH四个指令。</p>
<p>MULTI：用来组装一个事务，标记事务的开始<br>EXEC：用来执行一个事务<br>DISCARD：用来取消一个事务<br>WATCH：用来监视一些可以，一旦这些key在事务执行前被改变，则取消事务的执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">redis&gt; MULTI</div><div class="line">OK</div><div class="line">redis&gt; INCR user_id</div><div class="line">QUEUED</div><div class="line">redis&gt; INCR user_id</div><div class="line">QUEUED</div><div class="line">redis&gt; INCR user_id</div><div class="line">QUEUED</div><div class="line">redis&gt; PING</div><div class="line">QUEUED</div><div class="line">redis&gt; EXEC</div><div class="line">1) (integer) 1</div><div class="line">2) (integer) 2</div><div class="line">3) (integer) 3</div><div class="line">4) PONG</div></pre></td></tr></table></figure>
<ul>
<li><p>其中QUEUED表示我们在用MULTI组装事务时，每一个命令都会进入到内存队列中缓存起来，如果出现QUEUED则表示我们这个命令成功的插入了缓存队列，将来执行EXEC时，这些被QUEUED的命令都会被组装成一个事务来执行。</p>
</li>
<li><p>事务执行完成之后，如果redis开启了AOF持久化的话，那么一旦事务被成功执行，事务中的命令就会通过write命令一次性写入到磁盘中，如果写入过程中出现故障则会造成部分命令AOF持久化，此时可以使用redis-check-aof工具来修复这个问题，这个问题会将AOF文件中不完整的信息溢出，确保AOF文件完整可用。</p>
</li>
<li><p>事务遇到的错误分为：</p>
<ul>
<li><p>调用EXEC之前的错误：导致某个命令无法成功写入缓冲队列，调用redis会拒绝执行这个事务。</p>
<ul>
<li>语法错误</li>
<li><p>内存不足</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; multi</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; haha</div><div class="line">(error) ERR unknown command &apos;haha&apos;</div><div class="line">127.0.0.1:6379&gt; ping</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; exec</div><div class="line">(error) EXECABORT Transaction discarded because of previous errors.</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>调用EXEC之后的错误：redis会忽略这些错误，而是继续向下执行事务中的其他命令。也就是某一条命令失败并不会影响其他命令的执行。</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; multi</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set age 23</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; sadd age 15</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; set age 29</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; exec</div><div class="line">1) OK</div><div class="line">2) (error) WRONGTYPE Operation against a key holding the wrong kind of value</div><div class="line">3) OK</div><div class="line">127.0.0.1:6379&gt; get age</div><div class="line">&quot;29&quot;</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>WATCH指令可以使用类似于乐观锁的效果也就是CAS，WATCH本身作用是监视某些key是否被改动过，只要还没有真正的触发事务，WATCH都会监视指定的key，一旦发现某个key被修改了，在执行EXEC时就会返回nil，表示事务无法触发。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">  127.0.0.1:6379&gt; set age 23</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; watch age</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set age 24</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; multi</div><div class="line">OK</div><div class="line">127.0.0.1:6379&gt; set age 25</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; get age</div><div class="line">QUEUED</div><div class="line">127.0.0.1:6379&gt; exec</div><div class="line">(nil)</div></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/数据库/MySQL数据库优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/数据库/MySQL数据库优化/" itemprop="url">MySQL数据库优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/database/" itemprop="url" rel="index">
                    <span itemprop="name">database</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><p>学习了慕课网上的MySQL数据库优化课程，链接为：<a href="https://www.imooc.com/video/3688，" target="_blank" rel="external">https://www.imooc.com/video/3688，</a> 记录下自己学习过程中的收获。</p>
<ul>
<li><p>数据库优化的目的</p>
<ul>
<li>避免出现网页访问错误<ul>
<li>由于数据库连接超时产生页面5XX的错误</li>
<li>由于慢查询造成页面无法加载</li>
<li>由于阻塞造成数据无法提交</li>
</ul>
</li>
<li>增加数据库的稳定性<ul>
<li>许多数据库问题都是由于低效的查询引起的</li>
</ul>
</li>
<li>优化用户体验<ul>
<li>流畅页面的访问速度</li>
<li>良好的网站功能体验</li>
</ul>
</li>
</ul>
</li>
<li><p>数据库优化可以从哪几方面进行：(成本从低到高，效果从高到底)</p>
<ul>
<li>SQL及索引优化</li>
<li>数据库表结构优化</li>
<li>系统配置优化</li>
<li>硬件优化</li>
</ul>
</li>
</ul>
<h1 id="SQL语句优化"><a href="#SQL语句优化" class="headerlink" title="SQL语句优化"></a>SQL语句优化</h1><ul>
<li><p>如何发现有问题的SQL：使用MySQL慢查询日志对效率有问题的SQL进行监控</p>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &apos;slow_query_log&apos;;</div><div class="line">+----------------+-------+</div><div class="line">| Variable_name  | Value |</div><div class="line">+----------------+-------+</div><div class="line">| slow_query_log | ON    |</div><div class="line">+----------------+-------+</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show variables like &apos;slow%&apos;;</div><div class="line">+---------------------+--------------------------+</div><div class="line">| Variable_name       | Value                    |</div><div class="line">+---------------------+--------------------------+</div><div class="line">| slow_launch_time    | 2                        |</div><div class="line">| slow_query_log      | ON                       |</div><div class="line">| slow_query_log_file | DESKTOP-EKS47TB-slow.log |</div><div class="line">+---------------------+--------------------------+</div><div class="line">3 rows in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>慢查日志包含的内容：</p>
<ul>
<li>执行SQL的主机信息</li>
<li>SQL执行信息</li>
<li>SQL执行时间</li>
<li>SQL的内容</li>
</ul>
</li>
<li><p>慢查询日志分析工具</p>
<ul>
<li>mysqldumpslow</li>
<li>pt-query-digest<ul>
<li>查询次数多且每次查询占用时间长的SQL</li>
<li>IO大的SQL</li>
<li>未命中索引的SQL</li>
</ul>
</li>
</ul>
</li>
<li><p>explain查询和分析查询语句：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select customer_id, first_name, last_name from customer;</div><div class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</div><div class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |</div><div class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</div><div class="line">|  1 | SIMPLE      | customer | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  599 |   100.00 | NULL  |</div><div class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-------+</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
<ul>
<li>table 数据来自哪张表</li>
<li>type 连接使用的类型，最好到最坏的链接类型分别为const,eq_reg,ref,range,index,ALL.</li>
<li>possible_keys：显示可能应用在这张表上的索引</li>
<li>key：实际使用的索引</li>
<li>key_len：使用的索引长度</li>
<li>ref：显示索引哪一列被使用了，如果可能的话，是一个常数</li>
<li>rows：Mysql认为必须检查的用来返回请求的行数</li>
<li>extra<ul>
<li>Using filesort：查询需要优化，MySQL需要进行额外的步骤来发现如何对返回的行排序。它根据连接类型以及存储排序的键值和匹配条件的全部行的行指针来排序全部行。</li>
<li>Using temporary：需要优化，MySQL此时创建了一个临时表来存储结果，这通常发生在对不同的列集进行ORDER by上，而不是group by。</li>
</ul>
</li>
</ul>
<ul>
<li><p>Count()和Max()优化方法</p>
<ul>
<li><p>查询最后支付时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select max(payment_date) from payment \G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: payment</div><div class="line">   partitions: NULL</div><div class="line">         type: ALL</div><div class="line">possible_keys: NULL</div><div class="line">          key: NULL</div><div class="line">      key_len: NULL</div><div class="line">          ref: NULL</div><div class="line">         rows: 16086</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: NULL</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>在payment字段上创建索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">mysql&gt; create index idx_paydate on payment(payment_date);</div><div class="line">Query OK, 0 rows affected (0.06 sec)</div><div class="line">Records: 0  Duplicates: 0  Warnings: 0</div><div class="line"></div><div class="line">mysql&gt; explain select max(payment_date) from payment \G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: NULL</div><div class="line">   partitions: NULL</div><div class="line">         type: NULL</div><div class="line">possible_keys: NULL</div><div class="line">          key: NULL</div><div class="line">      key_len: NULL</div><div class="line">          ref: NULL</div><div class="line">         rows: NULL</div><div class="line">     filtered: NULL</div><div class="line">        Extra: Select tables optimized away</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>在一条SQL中同时查出2006年和2007年电影的数量-优化count()函数</p>
<ul>
<li><p>错误实例：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select count(release_year=&apos;2006&apos; or release_year=&apos;2007&apos;) from film;</div><div class="line">+---------------------------------------------------+</div><div class="line">| count(release_year=&apos;2006&apos; or release_year=&apos;2007&apos;) |</div><div class="line">+---------------------------------------------------+</div><div class="line">|                                              1000 |</div><div class="line">+---------------------------------------------------+</div><div class="line">1 row in set (0.01 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>正确的：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select count(release_year=&apos;2006&apos; or null) as &apos;2006电影数量&apos;, count(release_year=&apos;2007&apos; or null) as &apos;2007电影数量&apos; from film;</div><div class="line">+--------------+--------------+</div><div class="line">| 2006电影数量 | 2007电影数量 |</div><div class="line">+--------------+--------------+</div><div class="line">|         1000 |            0 |</div><div class="line">+--------------+--------------+</div><div class="line">1 row in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>  ‘count(*)计算空值，count(id)不计算空值’</p>
</li>
</ul>
</li>
<li><p>子查询优化</p>
<ul>
<li>通常情况下，需要把子查询优化为join查询，但在优化时要注意关联键是否有一对多的关系，要注意重复数据。</li>
</ul>
</li>
<li><p>优化group by查询,使用了临时表</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select actor.first_name, actor.last_name, COUNT(*) from sakila.film_actor inner join sakila.actor using(actor_id) group by film_actor.actor_id\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: actor</div><div class="line">   partitions: NULL</div><div class="line">         type: ALL</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: NULL</div><div class="line">      key_len: NULL</div><div class="line">          ref: NULL</div><div class="line">         rows: 200</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using temporary; Using filesort</div><div class="line">*************************** 2. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: film_actor</div><div class="line">   partitions: NULL</div><div class="line">         type: ref</div><div class="line">possible_keys: PRIMARY,idx_fk_film_id</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 2</div><div class="line">          ref: sakila.actor.actor_id</div><div class="line">         rows: 27</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using index</div><div class="line">2 rows in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
<p>  优化之后：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select actor.first_name, actor.last_name, c.cnt from sakila.actor inner join (select actor_id, COUNT(*) as cnt from sakila.film_actor group by actor_id) as c using(actor_id)\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: PRIMARY</div><div class="line">        table: actor</div><div class="line">   partitions: NULL</div><div class="line">         type: ALL</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: NULL</div><div class="line">      key_len: NULL</div><div class="line">          ref: NULL</div><div class="line">         rows: 200</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: NULL</div><div class="line">*************************** 2. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: PRIMARY</div><div class="line">        table: &lt;derived2&gt;</div><div class="line">   partitions: NULL</div><div class="line">         type: ref</div><div class="line">possible_keys: &lt;auto_key0&gt;</div><div class="line">          key: &lt;auto_key0&gt;</div><div class="line">      key_len: 2</div><div class="line">          ref: sakila.actor.actor_id</div><div class="line">         rows: 27</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: NULL</div><div class="line">*************************** 3. row ***************************</div><div class="line">           id: 2</div><div class="line">  select_type: DERIVED</div><div class="line">        table: film_actor</div><div class="line">   partitions: NULL</div><div class="line">         type: index</div><div class="line">possible_keys: PRIMARY,idx_fk_film_id</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 4</div><div class="line">          ref: NULL</div><div class="line">         rows: 5462</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using index</div><div class="line">3 rows in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
<ul>
<li><p>优化Limit查询：limit常用于分页处理，会伴随着order by从句使用，因此大多数时候会使用Filesorts这样会造成大量的IO问题。<br>  执行结果：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select film_id, description from sakila.film order by title limit 50, 5;</div><div class="line">+---------+---------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">| film_id | description                                                                                                                     |</div><div class="line">+---------+---------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">|      51 | A Insightful Panorama of a Forensic Psychologist And a Mad Cow who must Build a Mad Scientist in The First Manned Space Station |</div><div class="line">|      52 | A Thrilling Documentary of a Composer And a Monkey who must Find a Feminist in California                                       |</div><div class="line">|      53 | A Epic Drama of a Madman And a Cat who must Face a A Shark in An Abandoned Amusement Park                                       |</div><div class="line">|      54 | A Awe-Inspiring Drama of a Car And a Pastry Chef who must Chase a Crocodile in The First Manned Space Station                   |</div><div class="line">|      55 | A Awe-Inspiring Story of a Feminist And a Cat who must Conquer a Dog in A Monastery                                             |</div><div class="line">+---------+---------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">5 rows in set (0.00 sec)</div></pre></td></tr></table></figure>
<p>  执行计划：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select film_id, description from sakila.film order by title limit 50, 5\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: film</div><div class="line">   partitions: NULL</div><div class="line">         type: ALL</div><div class="line">possible_keys: NULL</div><div class="line">          key: NULL</div><div class="line">      key_len: NULL</div><div class="line">          ref: NULL</div><div class="line">         rows: 1000</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using filesort</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
<p>  可以看到使用了filesort方式，需要优化。</p>
<ul>
<li><p>使用有索引的列或者主键进行order by操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select film_id, description from sakila.film order by film_id limit 50, 5\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: film</div><div class="line">   partitions: NULL</div><div class="line">         type: index</div><div class="line">possible_keys: NULL</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 2</div><div class="line">          ref: NULL</div><div class="line">         rows: 55</div><div class="line">     filtered: 100.00</div><div class="line">        Extra: NULL</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
</li>
<li><p>记录上次返回的主键，在下一次查询时使用主键过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select film_id, description from sakila.film where film_id&gt;55 and film_id&lt;=60 order by film_id limit 1, 5\G</div><div class="line">*************************** 1. row ***************************</div><div class="line">           id: 1</div><div class="line">  select_type: SIMPLE</div><div class="line">        table: film</div><div class="line">   partitions: NULL</div><div class="line">         type: range</div><div class="line">possible_keys: PRIMARY</div><div class="line">          key: PRIMARY</div><div class="line">      key_len: 2</div><div class="line">          ref: NULL</div><div class="line">         rows: 5     </div><div class="line">     filtered: 100.00</div><div class="line">        Extra: Using where</div><div class="line">1 row in set, 1 warning (0.00 sec)</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h1><h2 id="如何选择合适的列创建索引"><a href="#如何选择合适的列创建索引" class="headerlink" title="如何选择合适的列创建索引"></a>如何选择合适的列创建索引</h2><ol>
<li>where从句，group by从句，order by从句，on从句中出现的列</li>
<li>索引字段越小越好</li>
<li>离散度大的列放到索引列的前面:下面的例子中，customer_id需要放在staff_id前面。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">mysql&gt; desc payment;</div><div class="line">+--------------+----------------------+------+-----+-------------------+-----------------------------+</div><div class="line">| Field        | Type                 | Null | Key | Default           | Extra                       |</div><div class="line">+--------------+----------------------+------+-----+-------------------+-----------------------------+</div><div class="line">| payment_id   | smallint(5) unsigned | NO   | PRI | NULL              | auto_increment              |</div><div class="line">| customer_id  | smallint(5) unsigned | NO   | MUL | NULL              |                             |</div><div class="line">| staff_id     | tinyint(3) unsigned  | NO   | MUL | NULL              |                             |</div><div class="line">| rental_id    | int(11)              | YES  | MUL | NULL              |                             |</div><div class="line">| amount       | decimal(5,2)         | NO   |     | NULL              |                             |</div><div class="line">| payment_date | datetime             | NO   | MUL | NULL              |                             |</div><div class="line">| last_update  | timestamp            | NO   |     | CURRENT_TIMESTAMP | on update CURRENT_TIMESTAMP |</div><div class="line">+--------------+----------------------+------+-----+-------------------+-----------------------------+</div><div class="line">7 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; select count(distinct customer_id), count(distinct staff_id) from payment;</div><div class="line">+-----------------------------+--------------------------+</div><div class="line">| count(distinct customer_id) | count(distinct staff_id) |</div><div class="line">+-----------------------------+--------------------------+</div><div class="line">|                         599 |                        2 |</div><div class="line">+-----------------------------+--------------------------+</div><div class="line">1 row in set (0.01 sec)</div></pre></td></tr></table></figure>
<h2 id="索引的维护及优化–重复及冗余索引"><a href="#索引的维护及优化–重复及冗余索引" class="headerlink" title="索引的维护及优化–重复及冗余索引"></a>索引的维护及优化–重复及冗余索引</h2><ol>
<li><p>重复索引是指相同的列以相同的顺序建立的同类型的索引。如：</p>
</li>
<li><p>冗余索引指的是多个索引的前缀列相同，或是在联合索引中包含了主键。</p>
</li>
<li><p>查询方法:</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mysql&gt; select a.table_schema as &apos;数据名&apos;,</div><div class="line">a.table_name as &apos;表名&apos;,</div><div class="line">a.index_name as &apos;索引1&apos;,</div><div class="line">a.column_name as &apos;重复列名&apos;</div><div class="line">from statistics a join statistics b</div><div class="line">on a.table_schema=b.table_schema</div><div class="line">and a.table_name = b.table_name</div><div class="line">and a.seq_in_index = b.seq_in_index</div><div class="line">and a.column_name = b. column_name</div><div class="line">where a.seq_in_index=1 and a.index_name &lt;&gt; b.index_name\G</div></pre></td></tr></table></figure>
</li>
<li><p>删除不使用的索引，MySQL只能查询慢查日志来分析。</p>
</li>
</ol>
<h1 id="数据库结构优化"><a href="#数据库结构优化" class="headerlink" title="数据库结构优化"></a>数据库结构优化</h1><h2 id="选择合适的数据类型"><a href="#选择合适的数据类型" class="headerlink" title="选择合适的数据类型"></a>选择合适的数据类型</h2><ol>
<li><p>使用可以存下你的数据的最小的数据类型</p>
</li>
<li><p>使用简单的数据类型，int要比varcahr类型在MySQL上面处理简单。</p>
</li>
<li><p>尽可能的使用not null定义字段。</p>
</li>
<li><p>尽量少用text类型，非用不可时最好考虑分表。</p>
</li>
</ol>
<h2 id="表的范式化和反范式话"><a href="#表的范式化和反范式话" class="headerlink" title="表的范式化和反范式话"></a>表的范式化和反范式话</h2><ol>
<li><p>范式话是指数据库设计的规范，目前说的范式话一般是指第三设计范式，也就是要求数据表中不存在非关键字段对任意候选关键字段的函数依赖则符合第三范式。</p>
<ul>
<li><p>不符合范式的问题：解决方法为对表进行拆分。</p>
<ul>
<li>数据冗余</li>
<li>数据的插入异常</li>
<li>数据的更新异常</li>
<li>数据的删除异常</li>
</ul>
</li>
</ul>
</li>
<li><p>反范式化是指为了查询效率的考虑把原来符合第三范式的表的适当增加冗余，以达到优化查询效率的目的，反范式化是一种以空间来换取时间的操作。</p>
</li>
</ol>
<h2 id="表的垂直拆分"><a href="#表的垂直拆分" class="headerlink" title="表的垂直拆分"></a>表的垂直拆分</h2><p>垂直拆分指的是把原有一个很多列的表拆分成多个表，这解决了表的宽度问题。拆分原则如下：</p>
<ol>
<li>不常用字段放入到一个表中</li>
<li>把大字段独立存放到一个表中</li>
<li>经常一起使用的字段放到一个表中</li>
</ol>
<h2 id="表的水平拆分"><a href="#表的水平拆分" class="headerlink" title="表的水平拆分"></a>表的水平拆分</h2><p>水平拆分是为了解决表的数据量过大的问题，水平拆分的表每一个表的结构都是完全一致的。</p>
<p>常用拆分方法为：对id进行hash运算，如果要拆分为100个子表，则对100取余，根据不同的结果将其存放到对应的表中。存在的挑战包括跨分区表进行数据查询，统计及后台报表操作。</p>
<h1 id="系统配置优化"><a href="#系统配置优化" class="headerlink" title="系统配置优化"></a>系统配置优化</h1><h2 id="操作系统配置优化"><a href="#操作系统配置优化" class="headerlink" title="操作系统配置优化"></a>操作系统配置优化</h2><p>数据库是基于操作系统的，目前大多数MySQL都是安装在Linux上，所以对于操作系统的一些参数配置也会影响到MySQL的性能。</p>
<ol>
<li>tcp支持的队列数</li>
<li>减少断开连接时，资源回收</li>
<li>打开文件数的限制，ulimit -a查询各位限制。</li>
<li>关闭iptables，selinux等防火墙</li>
</ol>
<h2 id="Mysql配置文件优化"><a href="#Mysql配置文件优化" class="headerlink" title="Mysql配置文件优化"></a>Mysql配置文件优化</h2><p>MySQL可以通过启动时指定配置参数和使用配置文件两种方式进行配置，在大多数情况下，配置文件位于/etc/my.cnf或是/etc/mysql/my.cnf。如果存在多个位置存在配置文件，后面的会对前面的进行覆盖。</p>
<ul>
<li><p>innodb_buffer_pool_size：配置Innodb的缓冲池，如果数据库中只有Innodb表，则推荐配置量为总内存的75%。</p>
</li>
<li><p>innodb_buffer_pool_instance：可以控制缓冲池的个数，默认一个</p>
</li>
<li><p>innodb_log_buffer_size：Innodb log 缓冲的大小，由于日志最长每秒刷新一次，一般不大</p>
</li>
<li><p>innodb_flush_log_at_trx_commit：关键参数，数据库多久将变更写入磁盘，对Innodb的IO效率影响很大。默认为1，每次提交都会将变更刷新到磁盘。0每次提交不刷新，每1s刷新到磁盘一次。2将每次提交刷新到缓冲区，每1s将缓冲区刷新到磁盘。一般设置为2。</p>
</li>
<li><p>innodb_read_io_threads,innodb_write_io_threads：Innodb读写的IO进程数，默认为4</p>
</li>
<li><p>innode_file_per_table：关键参数，控制Innodb每一个表使用独立的表空间。默认为OFF，也就是所有的表都会建立在共享表空间中。</p>
</li>
<li><p>innodb_stats_on_metadata：决定MySQL什么情况下会刷新innodb表的统计信息。</p>
</li>
</ul>
<p>第三方配置工具，Percona Tools</p>
<h1 id="服务器硬件优化"><a href="#服务器硬件优化" class="headerlink" title="服务器硬件优化"></a>服务器硬件优化</h1><ol>
<li>CPU：单核频率更高，MySQL对CPU服务器</li>
<li><p>磁盘IO：RAID</p>
<ul>
<li>RAID0：条带，多个磁盘链接成一个硬盘使用，IO最好，但是一个损坏，则所有数据丢失</li>
<li>RAID1：镜像，至少两个磁盘， 每组磁盘存储的数据相同。</li>
<li>RAID5：多个硬盘合并成一个逻辑盘使用，数据读写时会建立奇偶校验信息，并且奇偶校验信息和相对应的数据分别存储于不同的磁盘上。当RAID5的一个磁盘数据发生损坏后，利用剩下的数据的相应的奇偶校验信息取恢复被损坏的数据。</li>
<li>RAID1+0：RAID0和RAID1结合使用，数据库建议使用这个级别。</li>
</ul>
</li>
<li><p>SNA和NAT是否使用数据库：</p>
<ul>
<li>常用于高可用解决方案</li>
<li>顺序读写效率很高，但是随机读写很差</li>
<li>数据库随机读写的比率很高</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/算法/LRUCache实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/算法/LRUCache实现/" itemprop="url">LRUCache的Java实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="LRUCache简介"><a href="#LRUCache简介" class="headerlink" title="LRUCache简介"></a>LRUCache简介</h1><p>  没错，面试的时候让我写LRUCache，当时只知道需要一个HashMap和一个链表，但是考虑的问题不全名，也没有考虑到多线程的问题。回来以后学习了下LRUCache的一些Java实现，其实可以套用LinkedHashMap，很多方法都给实现好了，当然也可以使用HashMap+链表，但是后者写起来更加复杂，当时面试的情况，感觉是让我利用LinkedHashMap数据结构。</p>
<ul>
<li>首先缓存的大小是固定的，给缓存分配一个固定的大小。</li>
<li>每次读取缓存都会改变缓存的使用时间，将缓存的存在时间重新刷新。</li>
<li><p>需要在缓存满了后，将最近最久未使用的缓存删除，再添加最新的缓存。</p>
<p>熟悉LinkedHashMap的话可以继承LinkedHashMap来实现LRU缓存。因此需要去查看LinkedHashMap的源码。顺手写了一篇LinkedHashMap源码剖析，写的不是很深刻，不过可以了解其大概的实现方案。</p>
</li>
</ul>
<h1 id="LinkedHashMap实现LRUCache"><a href="#LinkedHashMap实现LRUCache" class="headerlink" title="LinkedHashMap实现LRUCache"></a>LinkedHashMap实现LRUCache</h1><p>LinkedHashMap自身实现了顺序存储，通过其初始化参数accessOrder可以指定其顺序方式，accessOrder为false时，采用默认的存储顺序，按照插入顺序存储，也就是一个FIFO缓冲实现，因为最老的总在最前面。而accessOrder为true时，采用的是访问顺序存储，也就是最近读取的数据放在最前面，最早读取的数据放在最后面。同时还有一个判断是否删除最老数据的方法，默认返回false，而我们需要当前缓存的长度小于链表长度时删除链表头的元素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">import java.util.LinkedHashMap;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/3</div><div class="line"> * 继承LinkedHashMap实现</div><div class="line"> */</div><div class="line">public class LRUCache1&lt;K, V&gt; extends LinkedHashMap&lt;K, V&gt; &#123;</div><div class="line">    //缓存的大小</div><div class="line">    private int cacheSize;</div><div class="line"></div><div class="line">    //初始化时保证LinkedHashMap的初始大小要大于CacheSize+1，否则会发生扩容</div><div class="line">    public LRUCache1(int cacheSize) &#123;</div><div class="line">        super(16, 0.75f, true);</div><div class="line">        this.cacheSize = cacheSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 重写该方法，当连表的size大于CacheSize时删除最老元素</div><div class="line">     * @param eldest</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    protected boolean removeEldestEntry(Map.Entry&lt;K, V&gt; eldest) &#123;</div><div class="line">        return size() &gt; cacheSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        StringBuilder sb = new StringBuilder();</div><div class="line">        for (Map.Entry&lt;K, V&gt; entry : entrySet()) &#123;</div><div class="line">            sb.append(String.format(&quot;%s:%s &quot;, entry.getKey(), entry.getValue()));</div><div class="line">        &#125;</div><div class="line">        return sb.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        LRUCache1&lt;String, String&gt; lruCache1 = new LRUCache1&lt;&gt;(6);</div><div class="line">        for (int i = 0; i &lt; 6; i++) &#123;</div><div class="line">            lruCache1.put(i+&quot;&quot;, i * i + &quot;&quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println(lruCache1.toString());</div><div class="line">        lruCache1.put(&quot;s&quot;, &quot;s&quot;);</div><div class="line">        System.out.println(lruCache1.toString());</div><div class="line">        lruCache1.put(&quot;2&quot;, &quot;2222&quot;);</div><div class="line">        System.out.println(lruCache1.toString());</div><div class="line">        lruCache1.get(1+&quot;&quot;);</div><div class="line">        System.out.println(lruCache1.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0:0 1:1 2:4 3:9 4:16 5:25</div><div class="line">1:1 2:4 3:9 4:16 5:25 s:s</div><div class="line">1:1 3:9 4:16 5:25 s:s 2:2222</div><div class="line">3:9 4:16 5:25 s:s 2:2222 1:1</div></pre></td></tr></table></figure>
<ul>
<li>继承实现方式，由于继承了Map接口，在多线程环境中使用时可以使用Collections.synchronizedMap()方法来实现线程安全操作。</li>
</ul>
<h1 id="LinkedHashMap的委托实现"><a href="#LinkedHashMap的委托实现" class="headerlink" title="LinkedHashMap的委托实现"></a>LinkedHashMap的委托实现</h1><p>不采用继承，而是采用委托的机制，需要自己进行线程同步来适应多线程场景。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line">import java.util.LinkedHashMap;</div><div class="line">import java.util.Map;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/3</div><div class="line"> * LinkedHashMap的委托方法</div><div class="line"> */</div><div class="line">public class LRUCache2&lt;K, V&gt; &#123;</div><div class="line">    //缓存大小</div><div class="line">    private final int CACHE_SIZE;</div><div class="line">    //默认加载因子</div><div class="line">    private final float DEFAULT_LOAD_FACTOR = 0.75f;</div><div class="line">    //缓存容器</div><div class="line">    private LinkedHashMap&lt;K, V&gt; map;</div><div class="line"></div><div class="line">    //初始化过程中,传入缓存的大小，根据缓存大小和默认factor来计算</div><div class="line">    // LinkedHashMap的初始容量，确保其不会产生扩容操作。</div><div class="line">    // 从而完成了map容器的初始化内容。</div><div class="line">    public LRUCache2(int cacheSize) &#123;</div><div class="line">        this.CACHE_SIZE = cacheSize;</div><div class="line">        int capacity = (int)Math.ceil(CACHE_SIZE / DEFAULT_LOAD_FACTOR) + 1;</div><div class="line">        map = new LinkedHashMap&lt;K,V&gt;(capacity, DEFAULT_LOAD_FACTOR, true) &#123;</div><div class="line">            @Override</div><div class="line">            protected boolean removeEldestEntry(Map.Entry eldest) &#123;</div><div class="line">                return size() &gt; CACHE_SIZE;</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程put方法，需要加锁</div><div class="line">     * @param key</div><div class="line">     * @param value</div><div class="line">     */</div><div class="line">    public synchronized void put (K key, V value) &#123;</div><div class="line">        map.put(key, value);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程get方法，需要加锁</div><div class="line">     * @param key</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public synchronized V get(K key) &#123;</div><div class="line">        return map.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程remove方法，需要加锁</div><div class="line">     * @param key</div><div class="line">     */</div><div class="line">    public synchronized void remove(K key) &#123;</div><div class="line">        map.remove(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程getAll方法，需要加锁</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public synchronized Set&lt;Map.Entry&lt;K, V&gt;&gt; getAll() &#123;</div><div class="line">        return map.entrySet();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程size方法，需要加锁</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public synchronized int size() &#123;</div><div class="line">        return map.size();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 多线程clear方法，需要加锁</div><div class="line">     */</div><div class="line">    public synchronized void clear() &#123;</div><div class="line">        map.clear();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        StringBuilder sb = new StringBuilder();</div><div class="line">        for (Map.Entry entry : map.entrySet()) &#123;</div><div class="line">            sb.append(String.format(&quot; %s:%s &quot;, entry.getKey(), entry.getValue()));</div><div class="line">        &#125;</div><div class="line">        return sb.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        LRUCache2&lt;Integer, String&gt; lruCache2 = new LRUCache2&lt;&gt;(5);</div><div class="line">        for (int i = 0; i &lt; 5; i++) &#123;</div><div class="line">            lruCache2.put(i,&quot;&quot; + i);</div><div class="line">        &#125;</div><div class="line">        System.out.println(lruCache2.toString());</div><div class="line">        lruCache2.put(5,&quot;5&quot;);</div><div class="line">        System.out.println(lruCache2.toString());</div><div class="line">        lruCache2.get(2);</div><div class="line">        System.out.println(lruCache2.toString());</div><div class="line">        lruCache2.put(6,&quot;6&quot;);</div><div class="line">        System.out.println(lruCache2.toString());</div><div class="line">        lruCache2.remove(4);</div><div class="line">        System.out.println(lruCache2.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1:1  2:2  3:3  4:4  5:5</div><div class="line">1:1  3:3  4:4  5:5  2:2</div><div class="line">3:3  4:4  5:5  2:2  6:6</div><div class="line">3:3  5:5  2:2  6:6</div></pre></td></tr></table></figure>
<h1 id="LRU-Cache的链表-HashMap实现"><a href="#LRU-Cache的链表-HashMap实现" class="headerlink" title="LRU Cache的链表+HashMap实现"></a>LRU Cache的链表+HashMap实现</h1><p>该方法可以理解为手动实现一个LinkedHashMap，同时需要自己处理所线程的问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line">import java.util.HashMap;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/3</div><div class="line"> * 链表+HashMap实现</div><div class="line"> */</div><div class="line">public class LRUCache3&lt;K, V&gt; &#123;</div><div class="line">    //缓存容量</div><div class="line">    private final int CACHE_SIZE;</div><div class="line">    //链表头</div><div class="line">    private Entry head;</div><div class="line">    //链表尾</div><div class="line">    private Entry tail;</div><div class="line">    //HashMap容器</div><div class="line">    private HashMap&lt;K, Entry&lt;K, V&gt;&gt; hashMap;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 初始化HashMap容器和cacheSize</div><div class="line">     * @param cacheSize 容量</div><div class="line">     */</div><div class="line">    public LRUCache3(int cacheSize) &#123;</div><div class="line">        this.CACHE_SIZE = cacheSize;</div><div class="line">        hashMap = new HashMap&lt;&gt;();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * put方法，加锁</div><div class="line">     * @param key</div><div class="line">     * @param value</div><div class="line">     */</div><div class="line">    public synchronized void put (K key, V value) &#123;</div><div class="line">        Entry entry = getEntry(key);</div><div class="line">        //hashmap中不存在key对应的entry时，新增</div><div class="line">        if (entry == null) &#123;</div><div class="line">            //判断是否需要删除最老的节点</div><div class="line">            if (hashMap.size() &gt;= CACHE_SIZE) &#123;</div><div class="line">                hashMap.remove(tail.key);</div><div class="line">                removeLast();</div><div class="line">            &#125;</div><div class="line">            entry = new Entry();</div><div class="line">            entry.key = key;</div><div class="line">        &#125;</div><div class="line">        //修改</div><div class="line">        entry.value = value;</div><div class="line">        moveToFirst(entry);</div><div class="line">        hashMap.put(key, entry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * get方法，多线程加锁</div><div class="line">     * @param key</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    public synchronized V get(K key) &#123;</div><div class="line">        Entry&lt;K, V&gt; entry = hashMap.get(key);</div><div class="line">        if (entry == null)</div><div class="line">            return null;</div><div class="line">        moveToFirst(entry);</div><div class="line">        return entry.value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * 删除</div><div class="line">     * @param key</div><div class="line">     */</div><div class="line">    public synchronized void remove(K key) &#123;</div><div class="line">        Entry entry = getEntry(key);</div><div class="line">        //从链表中删除</div><div class="line">        if (entry != null) &#123;</div><div class="line">            if (entry.pre != null)</div><div class="line">                entry.pre.next = entry.next;</div><div class="line">            if (entry.next != null)</div><div class="line">                entry.next.pre = entry.pre;</div><div class="line">            if (entry == head)</div><div class="line">                head = entry.next;</div><div class="line">            if (entry == tail)</div><div class="line">                tail = entry.pre;</div><div class="line">        &#125;</div><div class="line">        //从HashMap中删除</div><div class="line">        hashMap.remove(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //调整entry到链表头</div><div class="line">    private void moveToFirst(Entry entry) &#123;</div><div class="line">        if (entry == head)</div><div class="line">            return;</div><div class="line">        if (entry.pre!= null)</div><div class="line">            entry.pre.next = entry.next;</div><div class="line">        if (entry.next != null)</div><div class="line">            entry.next.pre = entry.pre;</div><div class="line">        if (head == null || tail == null) &#123;</div><div class="line">            head = tail = entry;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        entry.next = head;</div><div class="line">        head.pre = entry;</div><div class="line">        head = entry;</div><div class="line">        entry.pre = null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //移除链表尾的元素</div><div class="line">    private void removeLast() &#123;</div><div class="line">        if (tail != null) &#123;</div><div class="line">            tail = tail.pre;</div><div class="line">            if (tail == null)</div><div class="line">                head = null;</div><div class="line">            else</div><div class="line">                tail.next = null;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //从hashmap中获取key对应的Entry</div><div class="line">    private Entry&lt;K, V&gt; getEntry(K key) &#123;</div><div class="line">        return hashMap.get(key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        StringBuilder sb = new StringBuilder();</div><div class="line">        Entry entry = head;</div><div class="line">        while (entry != null) &#123;</div><div class="line">            sb.append(&quot;&quot;).append(entry.key).append(&quot;:&quot;).append(entry.value).append(&quot;  &quot;);</div><div class="line">            entry = entry.next;</div><div class="line">        &#125;</div><div class="line">        return sb.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Entry内部类，双链表实现</div><div class="line">     * @param &lt;K&gt;</div><div class="line">     * @param &lt;V&gt;</div><div class="line">     */</div><div class="line">    class Entry&lt;K,V&gt; &#123;</div><div class="line">        public Entry pre;</div><div class="line">        public Entry next;</div><div class="line">        public K key;</div><div class="line">        public V value;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        LRUCache3&lt;Integer, String&gt; lruCache3 = new LRUCache3&lt;&gt;(5);</div><div class="line">        for (int i = 0; i &lt; 5; i++) &#123;</div><div class="line">            lruCache3.put(i,&quot;&quot; + i);</div><div class="line">        &#125;</div><div class="line">        System.out.println(lruCache3.toString());</div><div class="line">        lruCache3.put(5,&quot;5&quot;);</div><div class="line">        System.out.println(lruCache3.toString());</div><div class="line">        lruCache3.get(2);</div><div class="line">        System.out.println(lruCache3.toString());</div><div class="line">        lruCache3.put(6,&quot;6&quot;);</div><div class="line">        System.out.println(lruCache3.toString());</div><div class="line">        lruCache3.remove(4);</div><div class="line">        System.out.println(lruCache3.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">4:4  3:3  2:2  1:1  0:0  </div><div class="line">5:5  4:4  3:3  2:2  1:1  </div><div class="line">2:2  5:5  4:4  3:3  1:1  </div><div class="line">6:6  2:2  5:5  4:4  3:3  </div><div class="line">6:6  2:2  5:5  3:3</div></pre></td></tr></table></figure>
<h1 id="继承LinkedHashMap实现FIFO缓存"><a href="#继承LinkedHashMap实现FIFO缓存" class="headerlink" title="继承LinkedHashMap实现FIFO缓存"></a>继承LinkedHashMap实现FIFO缓存</h1><p>FIFO缓存只需要继承LinkedHashMap采用其默认的输出顺序就可以。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">import java.util.LinkedHashMap;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/3</div><div class="line"> * 继承实现FIFO缓存</div><div class="line"> */</div><div class="line">public class FIFOCache&lt;K, V&gt; extends LinkedHashMap&lt;K, V&gt;&#123;</div><div class="line"></div><div class="line">    //缓存的大小</div><div class="line">    private int cacheSize;</div><div class="line"></div><div class="line">    //初始化时保证LinkedHashMap的初始大小要大于CacheSize+1，否则会发生扩容</div><div class="line">    public FIFOCache(int cacheSize) &#123;</div><div class="line">        super(16, 0.75f);</div><div class="line">        this.cacheSize = cacheSize;</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     * 重写该方法，当连表的size大于CacheSize时删除最新插入的元素</div><div class="line">     * @param eldest</div><div class="line">     * @return</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    protected boolean removeEldestEntry(Map.Entry&lt;K, V&gt; eldest) &#123;</div><div class="line">        return size() &gt; cacheSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        StringBuilder sb = new StringBuilder();</div><div class="line">        for (Map.Entry&lt;K, V&gt; entry : entrySet()) &#123;</div><div class="line">            sb.append(String.format(&quot;%s:%s &quot;, entry.getKey(), entry.getValue()));</div><div class="line">        &#125;</div><div class="line">        return sb.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        FIFOCache&lt;String, String&gt; f = new FIFOCache&lt;&gt;(6);</div><div class="line">        for (int i = 0; i &lt; 6; i++) &#123;</div><div class="line">            f.put(i+&quot;&quot;, i * i + &quot;&quot;);</div><div class="line">        &#125;</div><div class="line">        System.out.println(f.toString());</div><div class="line">        f.put(&quot;s&quot;, &quot;s&quot;);</div><div class="line">        System.out.println(f.toString());</div><div class="line">        f.put(&quot;5&quot;, &quot;2222&quot;);</div><div class="line">        System.out.println(f.toString());</div><div class="line">        f.get(1 + &quot;&quot;);</div><div class="line">        System.out.println(f.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0:0 1:1 2:4 3:9 4:16 5:25</div><div class="line">1:1 2:4 3:9 4:16 5:25 s:s</div><div class="line">1:1 2:4 3:9 4:16 5:2222 s:s</div><div class="line">1:1 2:4 3:9 4:16 5:2222 s:s</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/mybatis总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/mybatis总结/" itemprop="url">mybatis总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/mybatis/" itemprop="url" rel="index">
                    <span itemprop="name">mybatis</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、mybatis简介"><a href="#一、mybatis简介" class="headerlink" title="一、mybatis简介"></a>一、mybatis简介</h1><p>MyBatis 本是apache的一个开源项目iBatis, 2010年这个项目由apache software foundation 迁移到了google code，并且改名为MyBatis 。2013年11月迁移到Github。     MyBatis是一个优秀的持久层框架，它对jdbc的操作数据库的过程进行封装，使开发者只需要关注 SQL 本身，而不需要花费精力去处理例如注册驱动、创建connection、创建statement、手动设置参数、结果集检索等jdbc繁杂的过程代码。<br>Mybatis通过xml或注解的方式将要执行的各种statement（statement、preparedStatement、CallableStatement）配置起来，并通过java对象和statement中的sql进行映射生成最终执行的sql语句，最后由mybatis框架执行sql并将结果映射成java对象并返回。</p>
<h1 id="二、mybatis入门"><a href="#二、mybatis入门" class="headerlink" title="二、mybatis入门"></a>二、mybatis入门</h1><h2 id="1、使用jdbc操作数据库存在的问题"><a href="#1、使用jdbc操作数据库存在的问题" class="headerlink" title="1、使用jdbc操作数据库存在的问题"></a>1、使用jdbc操作数据库存在的问题</h2><ul>
<li><p>JDBC编程步骤：</p>
<ol>
<li><p>加载数据库驱动</p>
</li>
<li><p>创建并获取数据库连接</p>
</li>
<li><p>创建jdbc statement对象</p>
</li>
<li><p>设置SQL语句</p>
</li>
<li><p>传递SQL语句参数</p>
</li>
<li><p>执行statement获取结果</p>
</li>
<li><p>解析SQL执行结果</p>
</li>
<li><p>释放资源</p>
</li>
</ol>
</li>
<li><p>jdbc程序</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.jdbc;</div><div class="line"></div><div class="line">import java.sql.*;</div><div class="line"></div><div class="line">public class JDBCTest &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Connection connection = null;</div><div class="line">        PreparedStatement preparedStatement = null;</div><div class="line">        ResultSet resultSet = null;</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            //加载数据库驱动</div><div class="line">            Class.forName(&quot;com.mysql.jdbc.Driver&quot;);</div><div class="line"></div><div class="line">            //通过驱动管理类获取数据库链接</div><div class="line">            connection =  DriverManager.getConnection(&quot;jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf-8&quot;, &quot;root&quot;, &quot;linux&quot;);</div><div class="line">            //定义sql语句 ?表示占位符</div><div class="line">            String sql = &quot;select * from user where username = ?&quot;;</div><div class="line">            //获取预处理statement</div><div class="line">            preparedStatement = connection.prepareStatement(sql);</div><div class="line">            //设置参数，第一个参数为sql语句中参数的序号（从1开始），第二个参数为设置的参数值</div><div class="line">            preparedStatement.setString(1, &quot;王五&quot;);</div><div class="line">            //向数据库发出sql执行查询，查询出结果集</div><div class="line">            resultSet =  preparedStatement.executeQuery();</div><div class="line">            //遍历查询结果集</div><div class="line">            while(resultSet.next())&#123;</div><div class="line">                System.out.println(resultSet.getString(&quot;id&quot;)+&quot;  &quot;+resultSet.getString(&quot;username&quot;));</div><div class="line">            &#125;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;finally&#123;</div><div class="line">            //释放资源</div><div class="line">            if(resultSet!=null)&#123;</div><div class="line">                try &#123;</div><div class="line">                    resultSet.close();</div><div class="line">                &#125; catch (SQLException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if(preparedStatement!=null)&#123;</div><div class="line">                try &#123;</div><div class="line">                    preparedStatement.close();</div><div class="line">                &#125; catch (SQLException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if(connection!=null)&#123;</div><div class="line">                try &#123;</div><div class="line">                    connection.close();</div><div class="line">                &#125; catch (SQLException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>jdbc存在的问题</p>
<ol>
<li><p>数据库连接创建，释放频繁造成系统资源浪费从而影响系统性能，可以使用数据库连接池技术来解决这个问题。</p>
</li>
<li><p>SQL语句在代码中硬编码，不便于维护，实际应用中修改SQL语句需要修改java代码，不便于修改。</p>
</li>
<li><p>使用preparedStatement语句向占位符传参存在硬编码，实际上SQL语句的where条件不固定，修改困难</p>
</li>
<li><p>对结果集存在硬编码（查询列名），SQL变化导致解析代码变化，系统不易维护，将数据库记录封装成pojo对象解析比较方便。</p>
</li>
</ol>
</li>
</ul>
<h2 id="2、mybatis架构"><a href="#2、mybatis架构" class="headerlink" title="2、mybatis架构"></a>2、mybatis架构</h2><p> <img src="/img/mybatis-1.jpg" alt="Alt text"></p>
<ol>
<li><p>mybatis配置</p>
<ul>
<li>SqlMapConfig.xml为mybatis的全局配置文件，配置了mybatis的运行环境等信息。</li>
<li>mapper.xml为SQL映射文件，文件中配置了操作数据库的SQL语句，需要加载在SQLMapConfig.xml文件中。</li>
</ul>
</li>
<li><p>通过mybatis环境等配置信息构造SqlSessioNFactory，也就是会话工厂。</p>
</li>
<li><p>由会话工厂创建SqlSession，操作数据库需要通过会话来实现。</p>
</li>
<li><p>mybatis低层自定义了Executor执行器操作数据库，Execotor接口有两个实现，一个是基本执行器，一个是缓存执行器。</p>
</li>
<li><p>MappedStatement也是mybatis的一个低层封装对象，它包装了mybatis配置信息及SQL映射信息等。mapper.xml文件中一个SQL对应一个MappedStatement对象，SQL的id即MappedStatement的id。</p>
</li>
<li><p>MappedStatement对sql执行输入参数进行定义，包括HashMap、基本类型、pojo，Executor通过Mapped Statement在执行sql前将输入的java对象映射至sql中，输入参数映射就是jdbc编程中对preparedStatement设置参数。</p>
</li>
<li><p>MappedStatement对sql执行输出结果进行定义，包括HashMap、基本类型、pojo，Executor通过Mapped Statement在执行sql后将输出结果映射至java对象中，输出结果映射过程相当于jdbc编程中对结果的解析处理过程。</p>
</li>
</ol>
<h2 id="3、mybatis的入门程序"><a href="#3、mybatis的入门程序" class="headerlink" title="3、mybatis的入门程序"></a>3、mybatis的入门程序</h2><h3 id="1、mybatis下载"><a href="#1、mybatis下载" class="headerlink" title="1、mybatis下载"></a>1、mybatis下载</h3><p>mybatis的代码由GitHub管理，地址为：<a href="https://github.com/mybatis/mybatis-3/releases" target="_blank" rel="external">https://github.com/mybatis/mybatis-3/releases</a></p>
<p>文件结构为：</p>
<p><img src="/img/mybatis-2.png" alt="Alt text"></p>
<h3 id="2、实现的功能"><a href="#2、实现的功能" class="headerlink" title="2、实现的功能"></a>2、实现的功能</h3><ul>
<li><p>根据用户id查询一个用户信息</p>
</li>
<li><p>根据用户名称模糊查询用户信息列表</p>
</li>
<li><p>添加用户</p>
</li>
<li><p>更新用户</p>
</li>
<li><p>删除用户</p>
</li>
</ul>
<h3 id="3、工程搭建"><a href="#3、工程搭建" class="headerlink" title="3、工程搭建"></a>3、工程搭建</h3><ol>
<li><p>使用IDEA 2017.2 创建Java工程，jdk为1.8.0_141</p>
</li>
<li><p>添加jar包，包括mybatis核心包，依赖包，数据库驱动包</p>
<p> <img src="/img/mybatis-3.png" alt="Alt text"></p>
</li>
<li><p>日志的打印：mybatis默认使用log4j输出日志信息，在classpath下创建log4j.properties：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"># Global logging configuration</div><div class="line">log4j.rootLogger=DEBUG, stdout</div><div class="line"># Console output...</div><div class="line">log4j.appender.stdout=org.apache.log4j.ConsoleAppender</div><div class="line">log4j.appender.stdout.layout=org.apache.log4j.PatternLayout</div><div class="line">log4j.appender.stdout.layout.ConversionPattern=%5p [%t] - %m%n</div></pre></td></tr></table></figure>
</li>
<li><p>SqlMapConfig.xml文件：配置了数据源，事务管理</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div class="line">&lt;!DOCTYPE configuration</div><div class="line">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</div><div class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</div><div class="line">&lt;configuration&gt;</div><div class="line">    &lt;!-- 和spring整合后 environments配置将废除--&gt;</div><div class="line">    &lt;environments default=&quot;development&quot;&gt;</div><div class="line">        &lt;environment id=&quot;development&quot;&gt;</div><div class="line">            &lt;!-- 使用jdbc事务管理--&gt;</div><div class="line">            &lt;transactionManager type=&quot;JDBC&quot; /&gt;</div><div class="line">            &lt;!-- 数据库连接池--&gt;</div><div class="line">            &lt;dataSource type=&quot;POOLED&quot;&gt;</div><div class="line">                &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</div><div class="line">            &lt;/dataSource&gt;</div><div class="line">        &lt;/environment&gt;</div><div class="line">    &lt;/environments&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>po类的编写：po类作为mybatis进行SQL映射使用，po类通常与数据表对应，User.java如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.pojo;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class User &#123;</div><div class="line">	private int id;</div><div class="line">	private String username;// 用户姓名</div><div class="line">	private String sex;// 性别</div><div class="line">	private Date birthday;// 生日</div><div class="line">	private String address;// 地址</div><div class="line">  //omit the getter and setter...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>编写SQL映射文件：User.xml, namespace用于隔离SQL语句</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div class="line">&lt;!DOCTYPE mapper</div><div class="line">        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</div><div class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</div><div class="line">&lt;!--命名空间的作用为SQL隔离--&gt;</div><div class="line">&lt;mapper namespace=&quot;test&quot;&gt;</div><div class="line"></div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>加载映射文件，将User.xml添加在SQLMapConfig.xml中：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;mappers&gt;</div><div class="line">  &lt;mapper resource=&quot;User.xml&quot;/&gt;</div><div class="line">&lt;/mappers&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4、根据id查询用户信息"><a href="#4、根据id查询用户信息" class="headerlink" title="4、根据id查询用户信息"></a>4、根据id查询用户信息</h3><ol>
<li><p>在user.xml中添加SQL语句：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;!--根据id获取用户信息--&gt;</div><div class="line">&lt;!--parameterType指定传入参数类型，</div><div class="line">    resultMap指定结果集类型</div><div class="line">    #&#123;&#125;为占位符，如果传入的是基本类型，#&#123;&#125;中的变量名称可以随意指定</div><div class="line"> --&gt;</div><div class="line">&lt;select id=&quot;findUserById&quot; parameterType=&quot;java.lang.Integer&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">    select * from user where id = #&#123;id&#125;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试程序：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">private SqlSessionFactory sqlSessionFactory;</div><div class="line"></div><div class="line">@Before</div><div class="line">public void createSqlSessionFactory() throws IOException &#123;</div><div class="line">    //配置文件</div><div class="line">    String resource = &quot;SqlMapConfig.xml&quot;;</div><div class="line">    InputStream inputStream = Resources.getResourceAsStream(resource);</div><div class="line">    //使用SqlSessionFactoryBuilder从XML配置文件中创建</div><div class="line">    sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Test</div><div class="line">public void testFindUserById() &#123;</div><div class="line">    SqlSession sqlSession = null;</div><div class="line"></div><div class="line">    try &#123;</div><div class="line">        //创建会话</div><div class="line">        sqlSession = sqlSessionFactory.openSession();</div><div class="line">        //第一个参数，namespace+id</div><div class="line">        User user = sqlSession.selectOne(&quot;test.findUserById&quot;, 1);</div><div class="line"></div><div class="line">        System.out.println(user);</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125; finally &#123;</div><div class="line">        if (sqlSession != null) &#123;</div><div class="line">            sqlSession.close();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="5、根据用户名查询用户信息"><a href="#5、根据用户名查询用户信息" class="headerlink" title="5、根据用户名查询用户信息"></a>5、根据用户名查询用户信息</h3><ol>
<li><p>在url.xml中添加SQL语句：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;!--如果返回结果为集合，则可以调用session中的selectList方法，resultType仍然为--&gt;</div><div class="line">&lt;!--$&#123;&#125;拼接符，如果传入的是基本类型，其内部的变量名称必须为value--&gt;</div><div class="line">&lt;!--拼接符有SQL注入的风险，慎重使用，--&gt;</div><div class="line">&lt;select id=&quot;findUserByUserName&quot; parameterType=&quot;java.lang.String&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">  select * from user where username like &apos;%$&#123;value&#125;%&apos;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试程序:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">private SqlSessionFactory sqlSessionFactory;</div><div class="line"></div><div class="line">@Before</div><div class="line">public void createSqlSessionFactory() throws IOException &#123;</div><div class="line">    //配置文件</div><div class="line">    String resource = &quot;SqlMapConfig.xml&quot;;</div><div class="line">    InputStream inputStream = Resources.getResourceAsStream(resource);</div><div class="line">    //使用SqlSessionFactoryBuilder从XML配置文件中创建</div><div class="line">    sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Test</div><div class="line">public void testFindUserByUserName() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    List&lt;User&gt; users = sqlSession.selectList(&quot;test.findUserByUserName&quot;, &quot;王&quot;);</div><div class="line">    for (User user : users) &#123;</div><div class="line">        System.out.println(user);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="6、概念比较"><a href="#6、概念比较" class="headerlink" title="6、概念比较"></a>6、概念比较</h3><ol>
<li><p>#{}和${}</p>
<ul>
<li><p>#{}表示一个占位符号，通过#{}可以实现preparedStatement向占位符中设置值，自动进行java类型和jdbc类型转换，#{}可以有效防止SQL注入。#{}可以接收简单类型值或pojo属性值。如果parameterType传输单个简单类型值，#{}括号中可以是value或其他属性。</p>
</li>
<li><p>${}表示拼接字符串，通过${}可以将parameterType 传入的内容拼接在sql中且不进行jdbc类型转换， ${}可以接收简单类型值或pojo属性值，如果parameterType传输单个简单类型值，${}括号中只能是value。</p>
</li>
</ul>
</li>
<li><p>parameterType和resultType</p>
<ul>
<li><p>parameterType：指定输入参数类型，mybatis通过OGNL表达式从对象中获取参数值拼接在SQL中。</p>
</li>
<li><p>resultType：指定输出结果类型，mybatis将SQL查询结果的一行记录数据映射为resultType指定类型的对象。</p>
</li>
</ul>
</li>
<li><p>selectOne和selectList</p>
<ul>
<li><p>selectOne：查询一条记录，使用其查询多条记录会抛出异常</p>
</li>
<li><p>selectList：查询一条或者多条记录</p>
</li>
</ul>
</li>
</ol>
<h3 id="7、添加用户"><a href="#7、添加用户" class="headerlink" title="7、添加用户"></a>7、添加用户</h3><ol>
<li><p>在SQLMapConfig.xml中添加：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;!--如果从传入的是pojo类型，name#&#123;&#125;中对应的属.属性--&gt;</div><div class="line">&lt;!--如果要返回数据库自增组件，可以使用select last_insert_id()函数--&gt;</div><div class="line">&lt;insert id=&quot;insertUser&quot; parameterType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">    &lt;!--执行数据库函数，返回最近增加的自增主键id</div><div class="line">    keyProperty：将返回的主键放入传入的参数的ID中保存</div><div class="line">    order:当前函数相对于insert语句的执行顺序</div><div class="line">    resultType：keyProperty中的数据的类型</div><div class="line">    --&gt;</div><div class="line">    &lt;selectKey keyProperty=&quot;id&quot; order=&quot;AFTER&quot; resultType=&quot;java.lang.Integer&quot;&gt;</div><div class="line">      select last_insert_id()</div><div class="line">    &lt;/selectKey&gt;</div><div class="line">    insert into user (username, birthday, sex, address) values (#&#123;username&#125;, #&#123;birthday&#125;, #&#123;sex&#125;, #&#123;address&#125;)</div><div class="line">&lt;/insert&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试程序</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">//omit the before</div><div class="line">@Test</div><div class="line">public void testInsertUser() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    //创建插入数据库的用户对象</div><div class="line">    User user = new User();</div><div class="line">    user.setUsername(&quot;aaa&quot;);</div><div class="line">    user.setBirthday(new Date());</div><div class="line">    user.setSex(&quot;1&quot;);</div><div class="line">    user.setAddress(&quot;北京&quot;);</div><div class="line">    System.out.println(user);</div><div class="line">    //执行SQL语句插入对象</div><div class="line">    sqlSession.insert(&quot;test.insertUser&quot;, user);</div><div class="line">    //提交事务,mybatis会自动开启事务，需要手动提交事务</div><div class="line">    sqlSession.commit();</div><div class="line"></div><div class="line">    System.out.println(user);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>uuid实现主键：AFTER改为BEFORE,则在插入之前生成UUID并保存到数据库中</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;insert  id=&quot;insertUser&quot; parameterType=&quot;cn.itcast.mybatis.po.User&quot;&gt;</div><div class="line">&lt;selectKey resultType=&quot;java.lang.String&quot; order=&quot;BEFORE&quot;</div><div class="line">keyProperty=&quot;id&quot;&gt;</div><div class="line">select uuid()</div><div class="line">&lt;/selectKey&gt;</div><div class="line">insert into user(id,username,birthday,sex,address)</div><div class="line">		 values(#&#123;id&#125;,#&#123;username&#125;,#&#123;birthday&#125;,#&#123;sex&#125;,#&#123;address&#125;)</div><div class="line">&lt;/insert&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="8、删除用户"><a href="#8、删除用户" class="headerlink" title="8、删除用户"></a>8、删除用户</h3><ol>
<li><p>在SQLMapConfig.xml中添加：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;delete id=&quot;deleteUserById&quot; parameterType=&quot;java.lang.Integer&quot;&gt;</div><div class="line">  delete from user where id=#&#123;id&#125;</div><div class="line">&lt;/delete&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试程序</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//omit the before</div><div class="line">@Test</div><div class="line">public void testDeleteUserById() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    //删除</div><div class="line">    sqlSession.delete(&quot;test.deleteUserById&quot;, 28);</div><div class="line">    //提交</div><div class="line">    sqlSession.commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="9、修改用户"><a href="#9、修改用户" class="headerlink" title="9、修改用户"></a>9、修改用户</h3><ol>
<li><p>在SQLMapConfig.xml中添加：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;update id=&quot;updateUserById&quot; parameterType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">  update user set username = #&#123;username&#125; where id = #&#123;id&#125;</div><div class="line">&lt;/update&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试程序</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testUpdateUserById() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line"></div><div class="line">    User user = new User();</div><div class="line">    user.setId(29);</div><div class="line">    user.setUsername(&quot;王麻子&quot;);</div><div class="line"></div><div class="line">    sqlSession.update(&quot;test.updateUserById&quot;, user);</div><div class="line"></div><div class="line">    sqlSession.commit();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="10、mybatis解决jdbc编程的问题"><a href="#10、mybatis解决jdbc编程的问题" class="headerlink" title="10、mybatis解决jdbc编程的问题"></a>10、mybatis解决jdbc编程的问题</h3><ol>
<li><p>数据库连接创建，释放频繁造成系统资源浪费从而影响系统性能，可以使用数据库连接池技术来解决这个问题。</p>
<p> 解决：<em>在SQLMapConfig.xml中配置数据连接池，使用连接池管理数据库连接</em></p>
</li>
<li><p>SQL语句在代码中硬编码，不便于维护，实际应用中修改SQL语句需要修改java代码，不便于修改。</p>
<p> 解决：<em>将SQL语句配置在XXmapper.xml文件中与java程序分离</em></p>
</li>
<li><p>使用preparedStatement语句向占位符传参存在硬编码，实际上SQL语句的where条件不固定，修改困难</p>
<p> 解决：<em>mybatis自动将java对象映射至SQL语句，通过statement中的parameterType定义输入参数的类型</em></p>
</li>
<li><p>对结果集存在硬编码（查询列名），SQL变化导致解析代码变化，系统不易维护，将数据库记录封装成pojo对象解析比较方便。</p>
<p> 解决：<em>mybatis自动将SQL执行结果映射至java对象，通过statement的resultType定义输出结果的类型</em></p>
</li>
</ol>
<h3 id="11、mybatis和hibernate的区别"><a href="#11、mybatis和hibernate的区别" class="headerlink" title="11、mybatis和hibernate的区别"></a>11、mybatis和hibernate的区别</h3><ol>
<li><p>Mybatis和hibernate不同，它不完全是一个ORM框架，因为MyBatis需要程序员自己编写Sql语句，不过mybatis可以通过XML或注解方式灵活配置要运行的sql语句，并将java对象和sql语句映射生成最终执行的sql，最后将sql执行的结果再映射生成java对象。</p>
</li>
<li><p>Mybatis学习门槛低，简单易学，程序员直接编写原生态sql，可严格控制sql执行性能，灵活度高，非常适合对关系数据模型要求不高的软件开发，例如互联网软件、企业运营类软件等，因为这类软件需求变化频繁，一但需求变化要求成果输出迅速。但是灵活的前提是mybatis无法做到数据库无关性，如果需要实现支持多种数据库的软件则需要自定义多套sql映射文件，工作量大。</p>
</li>
<li><p>Hibernate对象/关系映射能力强，数据库无关性好，对于关系模型要求高的软件（例如需求固定的定制化软件）如果用hibernate开发可以节省很多代码，提高效率。但是Hibernate的学习门槛高，要精通门槛更高，而且怎么设计O/R映射，在性能和对象模型之间如何权衡，以及怎样用好Hibernate需要具有很强的经验和能力才行。</p>
</li>
</ol>
<h1 id="三、DAO的开发方法"><a href="#三、DAO的开发方法" class="headerlink" title="三、DAO的开发方法"></a>三、DAO的开发方法</h1><p>使用mybatis开发DAO，有两种方法，原始DAO方法和Mapper接口开发方法</p>
<h2 id="1、需求"><a href="#1、需求" class="headerlink" title="1、需求"></a>1、需求</h2><ul>
<li><p>根据用户id查询一个用户信息</p>
</li>
<li><p>根据用户名称模糊查询用户信息列表</p>
</li>
<li><p>添加用户信息</p>
</li>
</ul>
<h2 id="2、SqlSession的使用范围"><a href="#2、SqlSession的使用范围" class="headerlink" title="2、SqlSession的使用范围"></a>2、SqlSession的使用范围</h2><p>SqlSession中封装了对数据库的操作，如：查询、插入、更新、删除等。通过SqlSessionFactory创建SqlSession，而SqlSessionFactory是通过SqlSessionFactoryBuilder进行创建。</p>
<ol>
<li><p>SqlSessionFactoryBuilder：用于创建SqlSessionFacoty，SqlSessionFacoty一旦创建完成就不需要SqlSessionFactoryBuilder了，因为SqlSession是通过SqlSessionFactory生产，所以可以将SqlSessionFactoryBuilder当成一个工具类使用，最佳使用范围是方法范围即方法体内局部变量。</p>
</li>
<li><p>SqlSessionFactory：SQLSessionFactory是一个接口，接口中定义了openSession的不同重载方法，SqlSessionFactory的最佳使用范围是整个运行期间，一旦创建之后可以重复使用，通常以单例模式管理SqlSessionFactory。</p>
</li>
<li><p>SqlSession: SqlSession是一个面向用户的接口,sqlSession中定义了数据库操作方法。每个线程都应该有它自己的SqlSession实例。SqlSession的实例不能共享使用，它也是线程不安全的。因此最佳的范围是请求或方法范围。绝对不能将SqlSession实例的引用放在一个类的静态字段或实例字段中。打开一个 SqlSession；使用完毕就要关闭它。通常把这个关闭操作放到 finally 块中以确保每次都能执行关闭。</p>
</li>
</ol>
<h2 id="3、原始DAO开发方式（需要编写接口和实现类）"><a href="#3、原始DAO开发方式（需要编写接口和实现类）" class="headerlink" title="3、原始DAO开发方式（需要编写接口和实现类）"></a>3、原始DAO开发方式（需要编写接口和实现类）</h2><ul>
<li><p>映射文件：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div class="line">&lt;!DOCTYPE mapper</div><div class="line">        PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</div><div class="line">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</div><div class="line">&lt;!--命名空间的作用为SQL隔离--&gt;</div><div class="line">&lt;mapper namespace=&quot;test&quot;&gt;</div><div class="line">    &lt;!--根据id获取用户信息--&gt;</div><div class="line">    &lt;select id=&quot;findUserById&quot; parameterType=&quot;java.lang.Integer&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">        select * from user where id = #&#123;id&#125;</div><div class="line">    &lt;/select&gt;</div><div class="line"></div><div class="line">    &lt;select id=&quot;findUserByUserName&quot; parameterType=&quot;java.lang.String&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">      select * from user where username like &apos;%$&#123;value&#125;%&apos;</div><div class="line">    &lt;/select&gt;</div><div class="line"></div><div class="line">    &lt;insert id=&quot;insertUser&quot; parameterType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">        &lt;selectKey keyProperty=&quot;id&quot; order=&quot;AFTER&quot; resultType=&quot;java.lang.Integer&quot;&gt;</div><div class="line">          select last_insert_id()</div><div class="line">        &lt;/selectKey&gt;</div><div class="line">        insert into user (username, birthday, sex, address) values (#&#123;username&#125;, #&#123;birthday&#125;, #&#123;sex&#125;, #&#123;address&#125;)</div><div class="line">    &lt;/insert&gt;</div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Dao接口:</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.dao;</div><div class="line"></div><div class="line">import cn.itheima.pojo.User;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public interface UserDao &#123;</div><div class="line">    public User findUserById(Integer id);</div><div class="line"></div><div class="line">    public List&lt;User&gt; findUserByUserName(String username);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>实现类：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.dao;</div><div class="line"></div><div class="line">import cn.itheima.pojo.User;</div><div class="line">import org.apache.ibatis.session.SqlSession;</div><div class="line">import org.apache.ibatis.session.SqlSessionFactory;</div><div class="line">import org.junit.Test;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class UserDaoImpl implements UserDao&#123;</div><div class="line"></div><div class="line">    private SqlSessionFactory sqlSessionFactory;</div><div class="line">    //通过构造方法注入</div><div class="line">    public UserDaoImpl(SqlSessionFactory sqlSessionFactory) &#123;</div><div class="line">        this.sqlSessionFactory = sqlSessionFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    @Override</div><div class="line">    public User findUserById(Integer id) &#123;</div><div class="line">        //sqlSession是县城不安全的，所以他是最佳使用范围在方法体内</div><div class="line">        SqlSession openSession = sqlSessionFactory.openSession();</div><div class="line">        User user = openSession.selectOne(&quot;test.findUserById&quot;, id);</div><div class="line">        return user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public List&lt;User&gt; findUserByUserName(String username) &#123;</div><div class="line"></div><div class="line">        SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line"></div><div class="line">        List&lt;User&gt; users = sqlSession.selectList(&quot;test.findUserByUserName&quot;, username);</div><div class="line"></div><div class="line">        return users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>测试：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">package test.cn.itheima.dao;</div><div class="line"></div><div class="line">import cn.itheima.dao.UserDao;</div><div class="line">import cn.itheima.dao.UserDaoImpl;</div><div class="line">import cn.itheima.pojo.User;</div><div class="line">import org.apache.ibatis.io.Resources;</div><div class="line">import org.apache.ibatis.session.SqlSessionFactory;</div><div class="line">import org.apache.ibatis.session.SqlSessionFactoryBuilder;</div><div class="line">import org.junit.Test;</div><div class="line">import org.junit.Before;</div><div class="line">import org.junit.After;</div><div class="line"></div><div class="line">import java.io.InputStream;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">/**</div><div class="line">* UserDaoImpl Tester.</div><div class="line">*</div><div class="line">* @author &lt;Authors name&gt;</div><div class="line">* @since &lt;pre&gt;一月 24, 2018&lt;/pre&gt;</div><div class="line">* @version 1.0</div><div class="line">*/</div><div class="line">public class UserDaoImplTest &#123;</div><div class="line">    private SqlSessionFactory sqlSessionFactory;</div><div class="line">    private UserDao userDao;</div><div class="line">@Before</div><div class="line">public void before() throws Exception &#123;</div><div class="line">    String resource = &quot;SqlMapConfig.xml&quot;;</div><div class="line">    InputStream inputStream = Resources.getResourceAsStream(resource);</div><div class="line">    sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">    userDao = new UserDaoImpl(sqlSessionFactory);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@After</div><div class="line">public void after() throws Exception &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line">*</div><div class="line">* Method: findUserById(Integer id)</div><div class="line">*</div><div class="line">*/</div><div class="line">@Test</div><div class="line">public void testFindUserById() throws Exception &#123;</div><div class="line"></div><div class="line">    User user = userDao.findUserById(1);</div><div class="line">    System.out.println(user);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line">*</div><div class="line">* Method: findUserByUserName(String username)</div><div class="line">*</div><div class="line">*/</div><div class="line">@Test</div><div class="line">public void testFindUserByUserName() throws Exception &#123;</div><div class="line"></div><div class="line">    List&lt;User&gt; users = userDao.findUserByUserName(&quot;王&quot;);</div><div class="line">    for (User user : users) &#123;</div><div class="line">        System.out.println(user);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4、动态代理方法"><a href="#4、动态代理方法" class="headerlink" title="4、动态代理方法"></a>4、动态代理方法</h2><h3 id="1、开发规范"><a href="#1、开发规范" class="headerlink" title="1、开发规范"></a>1、开发规范</h3><p>  Mapper接口开发方法只需要程序员编写Mapper接口，由mybatis框架根据接口定义创建接口的动态代理对象，代理对象的方法体同上班DAO接口实现类方法。Mapper接口需要遵守以下规范：</p>
<ol>
<li><p>Mapper.xml文件中的namespace与mapper接口的类路径相同</p>
</li>
<li><p>Mapper接口方法名和Mapper.xml中定义的每个statement的id相同</p>
</li>
<li><p>Mapper接口方法的输入参数类型和mapper.xml中定义的每个sql的parameterType的类型相同</p>
</li>
<li><p>Mapper接口方法的输出参数类型和mapper.xml中定义的每个sql的resultType类型相同。</p>
</li>
</ol>
<h3 id="2、Mapper-xml（映射文件）"><a href="#2、Mapper-xml（映射文件）" class="headerlink" title="2、Mapper.xml（映射文件）"></a>2、Mapper.xml（映射文件）</h3><p>定义mapper映射文件UserMapper.xml，需要修改namespace的值为UserMapper接口路径，经UserMapper.xml放在mapper路径下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div class="line">&lt;!DOCTYPE mapper</div><div class="line">PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</div><div class="line">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</div><div class="line">&lt;mapper namespace=&quot;cn.itcast.mybatis.mapper.UserMapper&quot;&gt;</div><div class="line">&lt;!-- 根据id获取用户信息 --&gt;</div><div class="line">	&lt;select id=&quot;findUserById&quot; parameterType=&quot;int&quot; resultType=&quot;cn.itcast.mybatis.po.User&quot;&gt;</div><div class="line">		select * from user where id = #&#123;id&#125;</div><div class="line">	&lt;/select&gt;</div><div class="line">&lt;!-- 自定义条件查询用户列表 --&gt;</div><div class="line">	&lt;select id=&quot;findUserByUsername&quot; parameterType=&quot;java.lang.String&quot;</div><div class="line">			resultType=&quot;cn.itcast.mybatis.po.User&quot;&gt;</div><div class="line">	   select * from user where username like &apos;%$&#123;value&#125;%&apos;</div><div class="line">	&lt;/select&gt;</div><div class="line">&lt;!-- 添加用户 --&gt;</div><div class="line">	&lt;insert id=&quot;insertUser&quot; parameterType=&quot;cn.itcast.mybatis.po.User&quot;&gt;</div><div class="line">	&lt;selectKey keyProperty=&quot;id&quot; order=&quot;AFTER&quot; resultType=&quot;java.lang.Integer&quot;&gt;</div><div class="line">		select LAST_INSERT_ID()</div><div class="line">	&lt;/selectKey&gt;</div><div class="line">	  insert into user(username,birthday,sex,address)</div><div class="line">	  values(#&#123;username&#125;,#&#123;birthday&#125;,#&#123;sex&#125;,#&#123;address&#125;)</div><div class="line">	&lt;/insert&gt;</div><div class="line"></div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>
<h3 id="3、Mapper-java（接口文件）"><a href="#3、Mapper-java（接口文件）" class="headerlink" title="3、Mapper.java（接口文件）"></a>3、Mapper.java（接口文件）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Public interface UserMapper &#123;</div><div class="line">	//根据用户id查询用户信息</div><div class="line">	public User findUserById(int id) throws Exception;</div><div class="line">	//查询用户列表</div><div class="line">	public List&lt;User&gt; findUserByUsername(String username) throws Exception;</div><div class="line">	//添加用户信息</div><div class="line">	public void insertUser(User user)throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接口定义有如下特点：</p>
<ol>
<li><p>Mapper接口名和Mapper.xml中定义的statement的id相同</p>
</li>
<li><p>Mapper接口方法的输入参数类型和mapper.xml中定义的statement的parameterType的类型相同。</p>
</li>
<li><p>Mapper接口方法的输出参数类型和mapper.xml中定义的statement的resultType的类型相同</p>
</li>
</ol>
<h3 id="4、在SQLMapConfig-xml中配置映射文件"><a href="#4、在SQLMapConfig-xml中配置映射文件" class="headerlink" title="4、在SQLMapConfig.xml中配置映射文件"></a>4、在SQLMapConfig.xml中配置映射文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 加载映射文件 --&gt;</div><div class="line">&lt;mappers&gt;</div><div class="line">  &lt;mapper resource=&quot;mapper/UserMapper.xml&quot;/&gt;</div><div class="line">&lt;/mappers&gt;</div></pre></td></tr></table></figure>
<h3 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">Public class UserMapperTest extends TestCase &#123;</div><div class="line"></div><div class="line">	private SqlSessionFactory sqlSessionFactory;</div><div class="line"></div><div class="line">	protected void setUp() throws Exception &#123;</div><div class="line">		//mybatis配置文件</div><div class="line">		String resource = &quot;sqlMapConfig.xml&quot;;</div><div class="line">		InputStream inputStream = Resources.getResourceAsStream(resource);</div><div class="line">		//使用SqlSessionFactoryBuilder创建sessionFactory</div><div class="line">		sqlSessionFactory = new SqlSessionFactoryBuilder().build(inputStream);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	Public void testFindUserById() throws Exception &#123;</div><div class="line">		//获取session</div><div class="line">		SqlSession session = sqlSessionFactory.openSession();</div><div class="line">		//获取mapper接口的代理对象</div><div class="line">		UserMapper userMapper = session.getMapper(UserMapper.class);</div><div class="line">		//调用代理对象方法</div><div class="line">		User user = userMapper.findUserById(1);</div><div class="line">		System.out.println(user);</div><div class="line">		//关闭session</div><div class="line">		session.close();</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	@Test</div><div class="line">	public void testFindUserByUsername() throws Exception &#123;</div><div class="line">		SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">		UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line">		List&lt;User&gt; list = userMapper.findUserByUsername(&quot;张&quot;);</div><div class="line">		System.out.println(list.size());</div><div class="line"></div><div class="line">	&#125;</div><div class="line">Public void testInsertUser() throws Exception &#123;</div><div class="line">		//获取session</div><div class="line">		SqlSession session = sqlSessionFactory.openSession();</div><div class="line">		//获取mapper接口的代理对象</div><div class="line">		UserMapper userMapper = session.getMapper(UserMapper.class);</div><div class="line">		//要添加的数据</div><div class="line">		User user = new User();</div><div class="line">		user.setUsername(&quot;张三&quot;);</div><div class="line">		user.setBirthday(new Date());</div><div class="line">		user.setSex(&quot;1&quot;);</div><div class="line">		user.setAddress(&quot;北京市&quot;);</div><div class="line">		//通过mapper接口添加用户</div><div class="line">		userMapper.insertUser(user);</div><div class="line">		//提交</div><div class="line">		session.commit();</div><div class="line">		//关闭session</div><div class="line">		session.close();</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6、小结"><a href="#6、小结" class="headerlink" title="6、小结"></a>6、小结</h3><ol>
<li><p>selectOne和selectList:动态代理对象调用sqlSession.selectOne()和sqlSession.selectList()是根据mapper接口的返回值决定，如果返回list则调用selectList方法，如果返回单个对象则调用selectOne方法。</p>
</li>
<li><p>namespace：mybatis官方推荐使用mapper代理方法开发mapper接口，程序员不用编写mapper接口实现类，使用mapper代理方法时，输入参数可以使用pojo包装对象或map对象，保证dao的通用性。</p>
</li>
</ol>
<h1 id="四、SqlMapConfig-xml文件说明"><a href="#四、SqlMapConfig-xml文件说明" class="headerlink" title="四、SqlMapConfig.xml文件说明"></a>四、SqlMapConfig.xml文件说明</h1><h2 id="1、配置内容："><a href="#1、配置内容：" class="headerlink" title="1、配置内容："></a>1、配置内容：</h2><ul>
<li><p>properties（属性）</p>
</li>
<li><p>settings（全局配置参数）</p>
</li>
<li><p>typeAliases（类型别名）</p>
</li>
<li><p>typeHandlers（类型处理器）</p>
</li>
<li><p>objectFactory（对象工厂）</p>
</li>
<li><p>plugins（插件）</p>
</li>
<li><p>environments（环境集合属性对象）</p>
</li>
<li><p>environment（环境子属性对象）</p>
</li>
<li><p>transactionManager（事务管理）</p>
</li>
<li><p>dataSource（数据源）</p>
</li>
<li><p>mappers（映射器）</p>
</li>
</ul>
<h2 id="2、properties-属性"><a href="#2、properties-属性" class="headerlink" title="2、properties(属性)"></a>2、properties(属性)</h2><p>SqlMapConfig.xml可以引用java属性文件中的配置信息，创建db.properties保存数据库属性：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jdbc.driver=com.mysql.jdbc.Driver</div><div class="line">jdbc.url=jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf-8</div><div class="line">jdbc.username=root</div><div class="line">jdbc.password=linux</div></pre></td></tr></table></figure></p>
<p>修改SqlMapConfig.xml中引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">    &lt;!--加载db.properties中的参数--&gt;</div><div class="line">    &lt;properties resource=&quot;db.properties&quot;/&gt;</div><div class="line"></div><div class="line">    &lt;!-- 和spring整合后 environments配置将废除--&gt;</div><div class="line">    &lt;environments default=&quot;development&quot;&gt;</div><div class="line">        &lt;environment id=&quot;development&quot;&gt;</div><div class="line">            &lt;!-- 使用jdbc事务管理--&gt;</div><div class="line">            &lt;transactionManager type=&quot;JDBC&quot; /&gt;</div><div class="line">            &lt;!-- 数据库连接池--&gt;</div><div class="line">            &lt;dataSource type=&quot;POOLED&quot;&gt;</div><div class="line">                &lt;property name=&quot;driver&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</div><div class="line">                &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</div><div class="line">            &lt;/dataSource&gt;</div><div class="line">        &lt;/environment&gt;</div><div class="line">    &lt;/environments&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<p><em>其属性读取顺序为：</em></p>
<ol>
<li>在properties元素体内定义的属性会首先被读取</li>
<li>然后会读取properties元素中的resource或url加载的属性，它会覆盖已经读取的同名属性。</li>
</ol>
<h2 id="3、typeAliases-类型别名"><a href="#3、typeAliases-类型别名" class="headerlink" title="3、typeAliases(类型别名)"></a>3、typeAliases(类型别名)</h2><h3 id="1、mybatis支持别名："><a href="#1、mybatis支持别名：" class="headerlink" title="1、mybatis支持别名："></a>1、mybatis支持别名：</h3><table>
<thead>
<tr>
<th>别名</th>
<th>映射的类型</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_byte</code></td>
<td>byte</td>
</tr>
<tr>
<td><code>_long</code></td>
<td>long</td>
</tr>
<tr>
<td><code>_short</code></td>
<td>short</td>
</tr>
<tr>
<td><code>_int</code></td>
<td>int</td>
</tr>
<tr>
<td><code>_integer</code></td>
<td>int</td>
</tr>
<tr>
<td><code>_double</code></td>
<td>double</td>
</tr>
<tr>
<td><code>_float</code></td>
<td>float</td>
</tr>
<tr>
<td><code>_boolean</code></td>
<td>boolean</td>
</tr>
<tr>
<td><code>string</code></td>
<td>String</td>
</tr>
<tr>
<td><code>byte</code></td>
<td>Byte</td>
</tr>
<tr>
<td><code>long</code></td>
<td>Long</td>
</tr>
<tr>
<td><code>short</code></td>
<td>Short</td>
</tr>
<tr>
<td><code>int</code></td>
<td>Integer</td>
</tr>
<tr>
<td><code>integer</code></td>
<td>Integer</td>
</tr>
<tr>
<td><code>double</code></td>
<td>Double</td>
</tr>
<tr>
<td><code>float</code></td>
<td>Float</td>
</tr>
<tr>
<td><code>boolean</code></td>
<td>Boolean</td>
</tr>
<tr>
<td><code>date</code></td>
<td>Date</td>
</tr>
<tr>
<td><code>decimal</code></td>
<td>BigDecimal</td>
</tr>
<tr>
<td><code>bigdecimal</code></td>
<td>BigDecimal</td>
</tr>
<tr>
<td><code>map</code></td>
<td>Map</td>
</tr>
</tbody>
</table>
<h3 id="2、自定义别名：在SqlMapConfig-xml中配置："><a href="#2、自定义别名：在SqlMapConfig-xml中配置：" class="headerlink" title="2、自定义别名：在SqlMapConfig.xml中配置："></a>2、自定义别名：在SqlMapConfig.xml中配置：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!--别名--&gt;</div><div class="line">    &lt;typeAliases&gt;</div><div class="line">        &lt;!--定义单个pojo类别名 type 类的全路径名， alias别名--&gt;</div><div class="line">        &lt;typeAlias type=&quot;cn.itheima.pojo.User&quot; alias=&quot;user&quot;/&gt;</div><div class="line">        &lt;!--使用包扫描的方式数量定义别名，定以后别名等于类名，不区分大小写，建议按照Java命名规则来--&gt;</div><div class="line">        &lt;package name=&quot;cn.itheima.pojo&quot;/&gt;</div><div class="line">    &lt;/typeAliases&gt;</div></pre></td></tr></table></figure>
<h2 id="4、Mappers-映射器"><a href="#4、Mappers-映射器" class="headerlink" title="4、Mappers(映射器)"></a>4、Mappers(映射器)</h2><ol>
<li><p><mapper resource=" ">: 使用相对于类路径的资源,如：<mapper resource="sqlmap/User.xml"></mapper></mapper></p>
</li>
<li><p><mapper class=" ">:使用mapper接口类路径,如：<mapper class="cn.itcast.mybatis.mapper.UserMapper"></mapper></mapper></p>
</li>
</ol>
<p><em>注意：此种方法要求mapper接口名称和mapper映射文件名称相同，且放在同一个目录中。</em></p>
<ol>
<li><package name>:注册指定包下的所有mapper接口,如：<package name="cn.itcast.mybatis.mapper"></package></package></li>
</ol>
<p><em>注意：此种方法要求mapper接口名称和mapper映射文件名称相同，且放在同一个目录中。</em></p>
<h2 id="5、传递pojo包装类内容-输入类型的一种"><a href="#5、传递pojo包装类内容-输入类型的一种" class="headerlink" title="5、传递pojo包装类内容(输入类型的一种)"></a>5、传递pojo包装类内容(输入类型的一种)</h2><p>开发中通过pojo传递查询条件，查询条件是综合的查询条件，不仅包括用户查询条件，还包括其它的查询条件（比如将用户购买商品信息也作为查询条件），这时可以使用包装对象传递输入参数。Pojo类中包含pojo。</p>
<p>需求：根据用户名查询用户信息，查询条件放到QueryVo的user属性中。</p>
<ol>
<li><p>QueryVo:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.pojo;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class QueryVo &#123;</div><div class="line">    private User user;</div><div class="line"></div><div class="line">    private List&lt;Integer&gt; ids;</div><div class="line"></div><div class="line">    public List&lt;Integer&gt; getIds() &#123;</div><div class="line">        return ids;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setIds(List&lt;Integer&gt; ids) &#123;</div><div class="line">        this.ids = ids;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public User getUser() &#123;</div><div class="line">        return user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setUser(User user) &#123;</div><div class="line">        this.user = user;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>sql语句</p>
<p> <code>select * from user where username like &#39;%王%&#39;</code></p>
</li>
<li><p>Mapper文件</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserByVo&quot; parameterType=&quot;cn.itheima.pojo.QueryVo&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">    select * from user where username LIKE &apos;%$&#123;user.username&#125;%&apos; AND sex=#&#123;user.sex&#125;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>接口</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;User&gt; findUserByVo(QueryVo queryVo);</div></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void findUserByVo() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">    QueryVo queryVo = new QueryVo();</div><div class="line">    User user = new User();</div><div class="line">    user.setUsername(&quot;王&quot;);</div><div class="line">    user.setSex(&quot;1&quot;);</div><div class="line">    queryVo.setUser(user);</div><div class="line"></div><div class="line"></div><div class="line">    List&lt;User&gt; users = userMapper.findUserByVo(queryVo);</div><div class="line"></div><div class="line">    System.out.println(users);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="6、resultType-输出类型"><a href="#6、resultType-输出类型" class="headerlink" title="6、resultType(输出类型)"></a>6、resultType(输出类型)</h2><h3 id="1、输出简单类型"><a href="#1、输出简单类型" class="headerlink" title="1、输出简单类型"></a>1、输出简单类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserCount&quot; resultType=&quot;java.lang.Long&quot;&gt;</div><div class="line">    select count(*) from user</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public Long findUserCount();</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testFindUserCount() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line">    System.out.println(userMapper.findUserCount());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2、输出pojo对象或者pojo对象列表"><a href="#2、输出pojo对象或者pojo对象列表" class="headerlink" title="2、输出pojo对象或者pojo对象列表"></a>2、输出pojo对象或者pojo对象列表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserById&quot; parameterType=&quot;java.lang.Integer&quot; resultType=&quot;user&quot;&gt;</div><div class="line">    select * from user where id = #&#123;id&#125;</div><div class="line">&lt;/select&gt;</div><div class="line"></div><div class="line">&lt;select id=&quot;findUserByUserName&quot; parameterType=&quot;java.lang.String&quot; resultType=&quot;User&quot;&gt;</div><div class="line">    select * from user where username like &apos;%$&#123;value&#125;%&apos;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public User findUserById(Integer id);</div><div class="line">//    动态代理模式中，如果返回结果集WieList，mybatis会在生成实现类的时候自动调用selectList方法</div><div class="line">public List&lt;User&gt; findUserByUserName(String username);</div></pre></td></tr></table></figure>
<h2 id="7、resultMap"><a href="#7、resultMap" class="headerlink" title="7、resultMap"></a>7、resultMap</h2><p>  resultType可以指定pojo将查询结果映射为pojo，但需要pojo的属性名和sql查询的列名一致方可映射成功。如果sql查询字段名和pojo的属性名不一致，可以通过resultMap将字段名和属性名作一个对应关系 ，resultMap实质上还需要将查询结果映射到pojo对象中。resultMap可以实现将查询结果映射为复杂类型的pojo，比如在查询结果映射对象中包括pojo和list实现一对一查询和一对多查询。</p>
<ol>
<li><p>Mapper.xml的定义:使用resultMap来指定输出内容映射</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findOrdersAndUser2&quot; resultMap=&quot;orderAndUserResultMap&quot;&gt;</div><div class="line">    select a.*, b.id uid, username, birthday, sex, address</div><div class="line">    from orders a, user b</div><div class="line">    where a.user_id = b.id</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>定义resultMap</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;!--一对一，手动映射--&gt;</div><div class="line">&lt;!--id resultMap的唯一标识，type为将查询出的数据放入这个指定的对象</div><div class="line">    手动映射需要制定数据库中表的字段名与java中Pojo类的属性名称的对应关系</div><div class="line">--&gt;</div><div class="line">&lt;resultMap id=&quot;orderAndUserResultMap&quot; type=&quot;cn.itheima.pojo.Orders&quot;&gt;</div><div class="line">    &lt;!--id标签制定主键字段对应关系， column为数据库中的字段名，property为pojo类的属性名--&gt;</div><div class="line">    &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;</div><div class="line">    &lt;!--result标签制定非主键列的对应关系--&gt;</div><div class="line">    &lt;result column=&quot;user_id&quot; property=&quot;userId&quot;/&gt;</div><div class="line">    &lt;result column=&quot;number&quot; property=&quot;number&quot;/&gt;</div><div class="line">    &lt;result column=&quot;createtime&quot; property=&quot;createtime&quot;/&gt;</div><div class="line">    &lt;result column=&quot;note&quot; property=&quot;note&quot;/&gt;</div><div class="line">    &lt;!--user对象的映射关系的指定</div><div class="line">    property：指定将数据放入Orders中的user属性中，</div><div class="line">    type为user的类型</div><div class="line">    --&gt;</div><div class="line">    &lt;association property=&quot;user&quot; javaType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">        &lt;id column=&quot;uid&quot; property=&quot;id&quot;/&gt;</div><div class="line">        &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</div><div class="line">        &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</div><div class="line">        &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</div><div class="line">        &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</div><div class="line">    &lt;/association&gt;</div><div class="line">&lt;/resultMap&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Mapper接口定义</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;Orders&gt; findOrdersAndUser2();</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="五、动态sql"><a href="#五、动态sql" class="headerlink" title="五、动态sql"></a>五、动态sql</h1><p>通过mybatis提供的各种标签方法实现动态拼接SQL。</p>
<h2 id="1、if"><a href="#1、if" class="headerlink" title="1、if"></a>1、if</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserByUserNameAndSex&quot; parameterType=&quot;cn.itheima.pojo.User&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">    select * from user</div><div class="line">    where 1=1</div><div class="line">    &lt;if test=&quot;id!=null&quot;&gt;</div><div class="line">    and id=#&#123;id&#125;</div><div class="line">    &lt;/if&gt;</div><div class="line">    &lt;if test=&quot;username!=null and username!=&apos;&apos;&quot;&gt;</div><div class="line">    and username like &apos;%$&#123;username&#125;%&apos;</div><div class="line">    &lt;/if&gt;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<p><em>空字符串校验</em></p>
<h2 id="2、where"><a href="#2、where" class="headerlink" title="2、where"></a>2、where</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserByUserNameAndSex&quot; parameterType=&quot;cn.itheima.pojo.User&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">    select * from user</div><div class="line">    &lt;where&gt;</div><div class="line">    &lt;if test=&quot;id!=null and id!=&apos;&apos;&quot;&gt;</div><div class="line">    and id=#&#123;id&#125;</div><div class="line">    &lt;/if&gt;</div><div class="line">    &lt;if test=&quot;username!=null and username!=&apos;&apos;&quot;&gt;</div><div class="line">    and username like &apos;%$&#123;username&#125;%&apos;</div><div class="line">    &lt;/if&gt;</div><div class="line">    &lt;/where&gt;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<p><em>会自动向SQL语句中添加where关键字，会去掉第一个条件的and关键字</em></p>
<h2 id="3、foreach"><a href="#3、foreach" class="headerlink" title="3、foreach"></a>3、foreach</h2><p>向SQL传递数组或List，mybatis使用foreach解析，需求在传入多个id查询用户信息时需要。</p>
<ul>
<li><p>需要在Vo中定义list属性ids存储多个用户id，并添加getter、setter方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private List&lt;Integer&gt; ids;</div><div class="line"></div><div class="line">    public List&lt;Integer&gt; getIds() &#123;</div><div class="line">        return ids;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setIds(List&lt;Integer&gt; ids) &#123;</div><div class="line">        this.ids = ids;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>mapper.xml中的编写：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;select id=&quot;findUserByIds&quot; parameterType=&quot;cn.itheima.pojo.QueryVo&quot; resultType=&quot;user&quot;&gt;</div><div class="line">  select * from user</div><div class="line">  &lt;where&gt;</div><div class="line">      &lt;if test=&quot;ids != null and ids.size &gt; 0&quot;&gt;</div><div class="line">          &lt;!--foreach：循环传入的集合参数</div><div class="line">              collection:传入的集合的变量名称</div><div class="line">              item:每次循环将循环出的数据放入这个变量中</div><div class="line">              open:循环开始拼接的字符串</div><div class="line">              close:循环结束拼接的字符串</div><div class="line">              seperator:循环中拼接的字符串</div><div class="line">          --&gt;</div><div class="line">          &lt;foreach collection=&quot;ids&quot; item=&quot;id&quot; open=&quot;and id in (&quot; close=&quot;)&quot; separator=&quot;,&quot;&gt;</div><div class="line">              #&#123;id&#125;</div><div class="line">          &lt;/foreach&gt;</div><div class="line">      &lt;/if&gt;</div><div class="line">  &lt;/where&gt;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testFindUserByIds() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">    QueryVo vo = new QueryVo();</div><div class="line">    List&lt;Integer&gt; ids = new ArrayList&lt;&gt;();</div><div class="line">    ids.add(1);</div><div class="line">    ids.add(10);</div><div class="line">    ids.add(16);</div><div class="line">    ids.add(28);</div><div class="line">    ids.add(22);</div><div class="line"></div><div class="line">    vo.setIds(ids);</div><div class="line"></div><div class="line">    List&lt;User&gt; users = userMapper.findUserByIds(vo);</div><div class="line"></div><div class="line">    for (User user : users) &#123;</div><div class="line">        System.out.println(&quot;===============&quot; + user + &quot;===============&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4、sql片段"><a href="#4、sql片段" class="headerlink" title="4、sql片段"></a>4、sql片段</h2><p>sql中可将重复的SQL提取出来，使用时用include引用即可，从而达到SQL重用的目的：<br>    <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;!--封装SQL条件，封装后可以重用，id为SQL的唯一标示--&gt;</div><div class="line">&lt;sql id=&quot;user_Where&quot;&gt;</div><div class="line">    &lt;!--会自动向SQL语句中添加where关键字，</div><div class="line">        会去掉第一个条件的and关键字--&gt;</div><div class="line">    &lt;where&gt;</div><div class="line">        &lt;if test=&quot;username != null and username != &apos;&apos;&quot;&gt;</div><div class="line">            and username like &apos;%$&#123;username&#125;%&apos;</div><div class="line">        &lt;/if&gt;</div><div class="line">        &lt;if test=&quot;sex != null and sex != &apos;&apos;&quot;&gt;</div><div class="line">            and sex=#&#123;sex&#125;</div><div class="line">        &lt;/if&gt;</div><div class="line">    &lt;/where&gt;</div><div class="line">&lt;/sql&gt;</div><div class="line">......</div><div class="line">&lt;select id=&quot;findUserByUserNameAndSex&quot; parameterType=&quot;cn.itheima.pojo.User&quot; resultType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">     select * from user</div><div class="line">    &lt;!--调用SQL条件--&gt;</div><div class="line">     &lt;include refid=&quot;user_Where&quot;/&gt;</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure></p>
<h1 id="六、关联查询"><a href="#六、关联查询" class="headerlink" title="六、关联查询"></a>六、关联查询</h1><h2 id="1、商品订单数据模型"><a href="#1、商品订单数据模型" class="headerlink" title="1、商品订单数据模型"></a>1、商品订单数据模型</h2><p><img src="/img/mybatis-4.png" alt="Alt text"></p>
<h2 id="2、一对一关联"><a href="#2、一对一关联" class="headerlink" title="2、一对一关联"></a>2、一对一关联</h2><p>需求：查询所有订单信息，关联查询下单用户信息。由于一个订单信息只能由一个用户下单，所以从查询订单信息出发关联查询用户信息为一对一查询。如果从用户信息出发查询用户下的订单为一对多查询。</p>
<h3 id="方法一：使用resultType，定义订单信息po类，此po类中包括了订单信息和用户信息。"><a href="#方法一：使用resultType，定义订单信息po类，此po类中包括了订单信息和用户信息。" class="headerlink" title="方法一：使用resultType，定义订单信息po类，此po类中包括了订单信息和用户信息。"></a>方法一：使用resultType，定义订单信息po类，此po类中包括了订单信息和用户信息。</h3><ol>
<li><p>SQL语句</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select a.*, b.id uid, username, birthday, sex, address</div><div class="line">from orders a, user b</div><div class="line">where a.user_id = b.id</div></pre></td></tr></table></figure>
</li>
<li><p>定义po类：po类应该包含sql查询的所有字段</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.pojo;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">public class CustomOrders extends Orders&#123;</div><div class="line">    private int uid;</div><div class="line">    private String username;// 用户姓名</div><div class="line">    private String sex;// 性别</div><div class="line">    private Date birthday;// 生日</div><div class="line">    private String address;// 地址</div><div class="line"></div><div class="line">    //omit...</div></pre></td></tr></table></figure>
<p>   OrdersCustomer类继承Orders类后包括了Orders类的所有字段，只需要定义用户的信息字段即可。</p>
</li>
<li><p>Mapper.xml中</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;!--一对一，自动映射 --&gt;</div><div class="line">&lt;select id=&quot;findOrdersAndUser1&quot; resultType=&quot;cn.itheima.pojo.CustomOrders&quot;&gt;</div><div class="line">    select a.*, b.id uid, username, birthday, sex, address</div><div class="line">    from orders a, user b</div><div class="line">    where a.user_id = b.id</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Mapper接口</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;CustomOrders&gt; findOrdersAndUser1();</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testFindOrdersAndUser1() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">    List&lt;CustomOrders&gt; customOrders = userMapper.findOrdersAndUser1();</div><div class="line"></div><div class="line">    for (CustomOrders customOrders1 : customOrders) &#123;</div><div class="line">        System.out.println(&quot;===============&quot; + customOrders1 + &quot;===============&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>小结：<br>定义专门的po类作为输出类型，其中定义了SQL查询结果集的所有字段，此方法比较简单，企业中使用普遍。</p>
</li>
</ol>
<h3 id="方法二：使用resultMap，定义专门的resultMap用于映射一对一查询"><a href="#方法二：使用resultMap，定义专门的resultMap用于映射一对一查询" class="headerlink" title="方法二：使用resultMap，定义专门的resultMap用于映射一对一查询"></a>方法二：使用resultMap，定义专门的resultMap用于映射一对一查询</h3><ol>
<li><p>SQL语句</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select a.*, b.id uid, username, birthday, sex, address</div><div class="line">from orders a, user b</div><div class="line">where a.user_id = b.id</div></pre></td></tr></table></figure>
</li>
<li><p>定义po类：在Orders类中加入User属性，User属性中用于存储关联查询的用户信息，因为订单关联查询是一对一关系，所以这里使用单个User对象存储关联查询的用户信息。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.pojo;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class Orders &#123;</div><div class="line">  private Integer id;</div><div class="line"></div><div class="line">  private Integer userId;</div><div class="line"></div><div class="line">  private String number;</div><div class="line"></div><div class="line">  private Date createtime;</div><div class="line"></div><div class="line">  private String note;</div><div class="line"></div><div class="line">  private User user;</div><div class="line">  //omit...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Mapper.xml中</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;resultMap id=&quot;orderAndUserResultMap&quot; type=&quot;cn.itheima.pojo.Orders&quot;&gt;</div><div class="line">    &lt;!--id标签制定主键字段对应关系， column为数据库中的字段名，property为pojo类的属性名--&gt;</div><div class="line">    &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;</div><div class="line">    &lt;!--result标签制定非主键列的对应关系--&gt;</div><div class="line">    &lt;result column=&quot;user_id&quot; property=&quot;userId&quot;/&gt;</div><div class="line">    &lt;result column=&quot;number&quot; property=&quot;number&quot;/&gt;</div><div class="line">    &lt;result column=&quot;createtime&quot; property=&quot;createtime&quot;/&gt;</div><div class="line">    &lt;result column=&quot;note&quot; property=&quot;note&quot;/&gt;</div><div class="line">    &lt;!--user对象的映射关系的指定</div><div class="line">    property：指定将数据放入Orders中的user属性中，</div><div class="line">    type为user的类型</div><div class="line">    --&gt;</div><div class="line">    &lt;association property=&quot;user&quot; javaType=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">        &lt;id column=&quot;uid&quot; property=&quot;id&quot;/&gt;</div><div class="line">        &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</div><div class="line">        &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</div><div class="line">        &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</div><div class="line">        &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</div><div class="line">    &lt;/association&gt;</div><div class="line">&lt;/resultMap&gt;</div><div class="line"></div><div class="line">&lt;select id=&quot;findOrdersAndUser2&quot; resultMap=&quot;orderAndUserResultMap&quot;&gt;</div><div class="line">    select a.*, b.id uid, username, birthday, sex, address</div><div class="line">    from orders a, user b</div><div class="line">    where a.user_id = b.id</div><div class="line">&lt;/select&gt;</div></pre></td></tr></table></figure>
<ul>
<li>association：表示进行关联查询单条记录</li>
<li>property：表示关联查询的结果存储在cn.itcast.mybatis.po.Orders的user属性中</li>
<li>javaType：表示关联查询的结果类型</li>
<li><id property="id" column="user_id">：查询结果的user_id列对应关联对象的id属性，这里是<id>表示user_id是关联查询对象的唯一标识。</id></id></li>
<li><result property="username" column="username">：查询结果的username列对应关联对象的username属性</result></li>
</ul>
</li>
</ol>
<ol>
<li><p>Mapper接口</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;Orders&gt; findOrdersAndUser2();</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testFindOrdersAndUser2() throws Exception &#123;</div><div class="line">    SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">    UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">    List&lt;Orders&gt; orders = userMapper.findOrdersAndUser2();</div><div class="line"></div><div class="line">    System.out.println(orders);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>小结：使用association完成关联查询，将关联查询信息映射到pojo对象中。</p>
</li>
</ol>
<h2 id="3、一对多查询"><a href="#3、一对多查询" class="headerlink" title="3、一对多查询"></a>3、一对多查询</h2><p>需求：查询所有用户信息及用户关联的订单信息，用户信息和订单信息为一对多关系。使用resultMap实现：</p>
<ol>
<li><p>SQL语句</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select a.*, b.id oid, user_id, number, createtime</div><div class="line">from user a, orders b where a.id = b.user_id</div></pre></td></tr></table></figure>
</li>
<li><p>定义po类：在User类中加入List<orders> orders属性。</orders></p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.pojo;</div><div class="line"></div><div class="line">import java.util.Date;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class User &#123;</div><div class="line">  private int id;</div><div class="line">  private String username;// 用户姓名</div><div class="line">  private String sex;// 性别</div><div class="line">  private Date birthday;// 生日</div><div class="line">  private String address;// 地址</div><div class="line"></div><div class="line">  private List&lt;Orders&gt; ordersList;</div><div class="line">   //omit....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Mapper.xml中</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;resultMap id=&quot;userAndOrdersResultMap&quot; type=&quot;cn.itheima.pojo.User&quot;&gt;</div><div class="line">       &lt;id column=&quot;id&quot; property=&quot;id&quot;/&gt;</div><div class="line">       &lt;result column=&quot;username&quot; property=&quot;username&quot;/&gt;</div><div class="line">       &lt;result column=&quot;sex&quot; property=&quot;sex&quot;/&gt;</div><div class="line">       &lt;result column=&quot;birthday&quot; property=&quot;birthday&quot;/&gt;</div><div class="line">       &lt;result column=&quot;address&quot; property=&quot;address&quot;/&gt;</div><div class="line">       &lt;!--订单集合--&gt;</div><div class="line">       &lt;!--collection指定对应的集合关系映射</div><div class="line">           property：将数据放入指定的User对象的OrdersList集合属性中</div><div class="line">           ofType: 指定OrderList中的泛型类型</div><div class="line">       --&gt;</div><div class="line">       &lt;collection property=&quot;ordersList&quot; ofType=&quot;cn.itheima.pojo.Orders&quot;&gt;</div><div class="line">           &lt;id column=&quot;oid&quot; property=&quot;id&quot;/&gt;</div><div class="line">           &lt;result column=&quot;user_id&quot; property=&quot;userId&quot;/&gt;</div><div class="line">           &lt;result column=&quot;number&quot; property=&quot;number&quot;/&gt;</div><div class="line">           &lt;result column=&quot;createtime&quot; property=&quot;createtime&quot;/&gt;</div><div class="line">       &lt;/collection&gt;</div><div class="line">   &lt;/resultMap&gt;</div><div class="line"></div><div class="line">   &lt;select id=&quot;findUserAndOrders&quot; resultMap=&quot;userAndOrdersResultMap&quot;&gt;</div><div class="line">       select a.*, b.id oid, user_id, number, createtime</div><div class="line">       from user a, orders b where a.id = b.user_id</div><div class="line">   &lt;/select&gt;</div></pre></td></tr></table></figure>
<ul>
<li>collections:定义了用户关联的订单信息，表示关联查询结果集</li>
<li>property：关联查询的结果集存储在User对象上的那个属性</li>
<li>ofType：指定关联查询的结果集中的对象类型及List中的对象类型。此处可以使用别名也可以使用全限定名</li>
<li><id property="id" column="oid">：查询结果的oid列对应关联对象的id属性，这里是<id>表示oid是关联查询对象的唯一标识。</id></id></li>
<li><result property="userId" column="user_id">：查询结果的userId列对应关联对象的user_id属性</result></li>
</ul>
</li>
</ol>
<ol>
<li><p>Mapper接口</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;User&gt; findUserAndOrders();</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">@Test</div><div class="line">public void testFindUserAndOrders() throws Exception &#123;</div><div class="line">  SqlSession sqlSession = sqlSessionFactory.openSession();</div><div class="line">  UserMapper userMapper = sqlSession.getMapper(UserMapper.class);</div><div class="line"></div><div class="line">  List&lt;User&gt; users = userMapper.findUserAndOrders();</div><div class="line"></div><div class="line">  System.out.println(users);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="七、Spring整合mybatis"><a href="#七、Spring整合mybatis" class="headerlink" title="七、Spring整合mybatis"></a>七、Spring整合mybatis</h1><h2 id="1、整合思路"><a href="#1、整合思路" class="headerlink" title="1、整合思路"></a>1、整合思路</h2><ol>
<li><p>SqlSessionFactory对象应该放入Spring容器中作为单例存在。</p>
</li>
<li><p>传统dao的开发方式中，应该从Spring容器中获取SqlSession对象。</p>
</li>
<li><p>Mapper代理形式中，应该从Spring容器中直接获得mapper对象。</p>
</li>
<li><p>数据库的链接记忆数据库连接池事务都交给spring容器来完成。</p>
</li>
</ol>
<h2 id="2、整合需要的jar包"><a href="#2、整合需要的jar包" class="headerlink" title="2、整合需要的jar包"></a>2、整合需要的jar包</h2><ol>
<li><p>Spring的jar包</p>
</li>
<li><p>mybatis的jar包</p>
</li>
<li><p>spring+mybatis的整合包</p>
</li>
<li><p>MySQL数据库驱动包</p>
</li>
<li><p>数据库连接池的jar包</p>
<p><img src="/img/mybatis-5.png" alt="Alt text"></p>
</li>
</ol>
<h2 id="3、整合的步骤"><a href="#3、整合的步骤" class="headerlink" title="3、整合的步骤"></a>3、整合的步骤</h2><ol>
<li><p>创建一个java工程</p>
</li>
<li><p>导入jar包</p>
</li>
<li><p>mybatis配置文件SQLMapConfig.xml</p>
</li>
<li><p>编写Spring配置文件，包括数据库连接及连接池、事务管理、SqlSessionFactory对象，配置到Spring容器中、，mapper代理对象或者dao实现类配置到Spring容器中。</p>
</li>
<li><p>编写dao或者mapper文件</p>
</li>
<li><p>测试</p>
</li>
</ol>
<h3 id="1、SqlMapConfig-xml"><a href="#1、SqlMapConfig-xml" class="headerlink" title="1、SqlMapConfig.xml"></a>1、SqlMapConfig.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</div><div class="line">&lt;!DOCTYPE configuration</div><div class="line">        PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;</div><div class="line">        &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;</div><div class="line">&lt;configuration&gt;</div><div class="line">    &lt;!--别名--&gt;</div><div class="line">    &lt;typeAliases&gt;</div><div class="line">        &lt;!--定义单个pojo类别名 type 类的全路径名， alias别名--&gt;</div><div class="line">        &lt;typeAlias type=&quot;cn.itheima.pojo.User&quot; alias=&quot;user&quot;/&gt;</div><div class="line">        &lt;!--使用包扫描的方式数量定义别名，定以后别名等于类名，不区分大小写，建议按照Java命名规则来--&gt;</div><div class="line">        &lt;package name=&quot;cn.itheima.pojo&quot;/&gt;</div><div class="line">    &lt;/typeAliases&gt;</div><div class="line">    &lt;mappers&gt;</div><div class="line">        &lt;mapper resource=&quot;User.xml&quot;/&gt;</div><div class="line">        &lt;!--使用class属性引入接口的全路径名称，使用规则</div><div class="line">        1、接口名称和映射文件名称除了扩展名之外完全相同，</div><div class="line">        2、接口和映射文件要放在同一个目录下</div><div class="line">        --&gt;</div><div class="line">        &lt;!--&lt;mapper class=&quot;UserMapper&quot;/&gt;--&gt;</div><div class="line"></div><div class="line">        &lt;!--使用包扫描的方式批量引入Mapper接口</div><div class="line">        1、接口名称和映射文件名称除了扩展名之外完全相同，</div><div class="line">        2、接口和映射文件要放在同一个目录下--&gt;</div><div class="line">        &lt;package name=&quot;cn.itheima.mapper&quot;/&gt;</div><div class="line">    &lt;/mappers&gt;</div><div class="line"></div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h3 id="2、applicationContext-xml"><a href="#2、applicationContext-xml" class="headerlink" title="2、applicationContext.xml"></a>2、applicationContext.xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</div><div class="line">       xmlns:context=&quot;http://www.springframework.org/schema/context&quot; xmlns:p=&quot;http://www.springframework.org/schema/p&quot;</div><div class="line">       xmlns:aop=&quot;http://www.springframework.org/schema/aop&quot; xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;</div><div class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd&quot;&gt;</div><div class="line"></div><div class="line">    &lt;!-- 加载配置文件 --&gt;</div><div class="line">    &lt;context:property-placeholder location=&quot;classpath:db.properties&quot; /&gt;</div><div class="line">    &lt;!-- 数据库连接池 --&gt;</div><div class="line">    &lt;bean id=&quot;dataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;</div><div class="line">        &lt;property name=&quot;driverClassName&quot; value=&quot;$&#123;jdbc.driver&#125;&quot; /&gt;</div><div class="line">        &lt;property name=&quot;url&quot; value=&quot;$&#123;jdbc.url&#125;&quot; /&gt;</div><div class="line">        &lt;property name=&quot;username&quot; value=&quot;$&#123;jdbc.username&#125;&quot; /&gt;</div><div class="line">        &lt;property name=&quot;password&quot; value=&quot;$&#123;jdbc.password&#125;&quot; /&gt;</div><div class="line">        &lt;property name=&quot;maxActive&quot; value=&quot;10&quot; /&gt;</div><div class="line">        &lt;property name=&quot;maxIdle&quot; value=&quot;5&quot; /&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">    &lt;!-- mapper配置 --&gt;</div><div class="line">    &lt;!-- 让spring管理sqlsessionfactory 使用mybatis和spring整合包中的 --&gt;</div><div class="line">    &lt;bean id=&quot;sqlSessionFactory&quot; class=&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;&gt;</div><div class="line">        &lt;!-- 数据库连接池 --&gt;</div><div class="line">        &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</div><div class="line">        &lt;!-- 加载mybatis的全局配置文件 --&gt;</div><div class="line">        &lt;property name=&quot;configLocation&quot; value=&quot;classpath:SqlMapConfig.xml&quot; /&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;!--配置原生DAO实现--&gt;</div><div class="line">    &lt;!--&lt;bean id=&quot;userDao&quot; class=&quot;cn.itheima.dao.UserDaoImpl&quot;&gt;--&gt;</div><div class="line">        &lt;!--&lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;--&gt;</div><div class="line">    &lt;!--&lt;/bean&gt;--&gt;</div><div class="line"></div><div class="line">    &lt;!--Mapper接口代理的实现--&gt;</div><div class="line">    &lt;!--&lt;bean id=&quot;userMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;--&gt;</div><div class="line">        &lt;!--&amp;lt;!&amp;ndash;接口路径名&amp;ndash;&amp;gt;--&gt;</div><div class="line">        &lt;!--&lt;property name=&quot;mapperInterface&quot; value=&quot;UserMapper&quot;/&gt;--&gt;</div><div class="line">        &lt;!--&lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;--&gt;</div><div class="line">    &lt;!--&lt;/bean&gt;--&gt;</div><div class="line"></div><div class="line">    &lt;!--使用包扫描的方式引入Mapper--&gt;</div><div class="line">    &lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</div><div class="line">        &lt;!--指定要扫描的包的全路径名称，如果有多个包，用英文逗号分隔--&gt;</div><div class="line">       &lt;!--扫描后引用的时候使用类名首字母小写--&gt;</div><div class="line">        &lt;property name=&quot;basePackage&quot; value=&quot;cn.itheima.mapper&quot;/&gt;</div><div class="line">    &lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h3 id="3、db-properties"><a href="#3、db-properties" class="headerlink" title="3、db.properties"></a>3、db.properties</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">jdbc.driver=com.mysql.jdbc.Driver</div><div class="line">jdbc.url=jdbc:mysql://localhost:3306/mybatis?characterEncoding=utf-8</div><div class="line">jdbc.username=root</div><div class="line">jdbc.password=linux</div></pre></td></tr></table></figure>
<h2 id="4、DAO的开发"><a href="#4、DAO的开发" class="headerlink" title="4、DAO的开发"></a>4、DAO的开发</h2><p>三种dao的实现方式：</p>
<ol>
<li><p>传统dao的开发方式</p>
</li>
<li><p>使用mapper代理形式开发方式</p>
</li>
<li><p>使用扫描包配置mapper代理</p>
</li>
</ol>
<h3 id="1、使用传统dao的开发方式"><a href="#1、使用传统dao的开发方式" class="headerlink" title="1、使用传统dao的开发方式"></a>1、使用传统dao的开发方式</h3><p>接口+实现类来完成。dao实现类需要继承SqlSessionDaoSupport.</p>
<ol>
<li><p>实现类：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.dao;</div><div class="line"></div><div class="line">import cn.itheima.pojo.User;</div><div class="line">import org.apache.ibatis.session.SqlSession;</div><div class="line">import org.mybatis.spring.support.SqlSessionDaoSupport;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class UserDaoImpl extends SqlSessionDaoSupport implements UserDao&#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public User findUserById(Integer id) &#123;</div><div class="line">        //sqlSession是线程不安全的，所以他是最佳使用范围在方法体内</div><div class="line">        SqlSession openSession = this.getSqlSession();</div><div class="line">        User user = openSession.selectOne(&quot;test.findUserById&quot;, id);</div><div class="line">        return user;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public List&lt;User&gt; findUserByUserName(String username) &#123;</div><div class="line"></div><div class="line">        SqlSession sqlSession = this.getSqlSession();</div><div class="line"></div><div class="line">        List&lt;User&gt; users = sqlSession.selectList(&quot;test.findUserByUserName&quot;, username);</div><div class="line"></div><div class="line">        return users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>配置DAO：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;!--配置原生DAO实现--&gt;</div><div class="line">&lt;bean id=&quot;userDao&quot; class=&quot;cn.itheima.dao.UserDaoImpl&quot;&gt;</div><div class="line">    &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.test;</div><div class="line"></div><div class="line">import cn.itheima.dao.UserDao;</div><div class="line">import cn.itheima.pojo.User;</div><div class="line">import org.junit.Before;</div><div class="line">import org.junit.Test;</div><div class="line">import org.springframework.context.ApplicationContext;</div><div class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line">public class UserDaoTest &#123;</div><div class="line">    private ApplicationContext applicationContext;</div><div class="line"></div><div class="line">    @Before</div><div class="line">    public void setUp() throws Exception &#123;</div><div class="line">        String configLocation = &quot;applicationContext.xml&quot;;</div><div class="line">        applicationContext = new ClassPathXmlApplicationContext(configLocation);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testFindUserById() throws Exception &#123;</div><div class="line">        //获取DAO对象，getBean中的字符串为配置文件中声明的</div><div class="line">        UserDao userDao = (UserDao) applicationContext.getBean(&quot;userDao&quot;);</div><div class="line"></div><div class="line">        User user = userDao.findUserById(1);</div><div class="line"></div><div class="line">        System.out.println(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="2、Mapper代理形式开发dao"><a href="#2、Mapper代理形式开发dao" class="headerlink" title="2、Mapper代理形式开发dao"></a>2、Mapper代理形式开发dao</h3><p>按照代理的要求，编写映射文件和接口，放置在同一个路径下。</p>
<ol>
<li><p>配置</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;!--Mapper接口代理的实现--&gt;</div><div class="line">&lt;bean id=&quot;userMapper&quot; class=&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;&gt;</div><div class="line">    &amp;lt;!&amp;ndash;接口路径名&amp;ndash;&amp;gt;</div><div class="line">    &lt;property name=&quot;mapperInterface&quot; value=&quot;UserMapper&quot;/&gt;</div><div class="line">    &lt;property name=&quot;sqlSessionFactory&quot; ref=&quot;sqlSessionFactory&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>测试</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.test;</div><div class="line"></div><div class="line">import cn.itheima.mapper.UserMapper;</div><div class="line">import cn.itheima.pojo.User;</div><div class="line">import cn.itheima.pojo.UserExample;</div><div class="line">import org.junit.Before;</div><div class="line">import org.junit.Test;</div><div class="line">import org.springframework.context.ApplicationContext;</div><div class="line">import org.springframework.context.support.ClassPathXmlApplicationContext;</div><div class="line"></div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class UserMapperTest &#123;</div><div class="line">    private ApplicationContext applicationContext;</div><div class="line"></div><div class="line">    @Before</div><div class="line">    public void setUp() throws Exception &#123;</div><div class="line">        String configLocation = &quot;applicationContext.xml&quot;;</div><div class="line">        applicationContext = new ClassPathXmlApplicationContext(configLocation);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">//    @Test</div><div class="line">//    public void testFindUserById() throws Exception &#123;</div><div class="line">//        //获取DAO对象，getBean中的字符串为配置文件中声明的</div><div class="line">//        UserMapper userMapper = (UserMapper) applicationContext.getBean(&quot;userMapper&quot;);</div><div class="line">//</div><div class="line">//        User user = userMapper.findUserById(1);</div><div class="line">//</div><div class="line">//        System.out.println(user);</div><div class="line">//    &#125;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testFindUserById() throws Exception &#123;</div><div class="line">        //获取DAO对象，getBean中的字符串为配置文件中声明的</div><div class="line">        UserMapper userMapper = (UserMapper) applicationContext.getBean(&quot;userMapper&quot;);</div><div class="line"></div><div class="line">        User user = userMapper.selectByPrimaryKey(1);</div><div class="line"></div><div class="line">        System.out.println(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Test</div><div class="line">    public void testFindUserAndSex() throws Exception&#123;</div><div class="line">        //获取DAO对象，getBean中的字符串为配置文件中声明的</div><div class="line">        UserMapper userMapper = (UserMapper) applicationContext.getBean(&quot;userMapper&quot;);</div><div class="line"></div><div class="line">        //创建UserExample对象</div><div class="line">        UserExample userExample = new UserExample();</div><div class="line">        //创建查询条件封装对象</div><div class="line">        UserExample.Criteria criteria = userExample.createCriteria();</div><div class="line">        //输入条件</div><div class="line">        criteria.andUsernameLike(&quot;%王%&quot;);</div><div class="line">        criteria.andSexEqualTo(&quot;1&quot;);</div><div class="line"></div><div class="line">        List&lt;User&gt; user = userMapper.selectByExample(userExample);</div><div class="line"></div><div class="line">        System.out.println(user);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3、使用包扫描的方式配置mapper"><a href="#3、使用包扫描的方式配置mapper" class="headerlink" title="3、使用包扫描的方式配置mapper"></a>3、使用包扫描的方式配置mapper</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;!--使用包扫描的方式引入Mapper--&gt;</div><div class="line">&lt;bean class=&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;&gt;</div><div class="line">    &lt;!--指定要扫描的包的全路径名称，如果有多个包，用英文逗号分隔--&gt;</div><div class="line">   &lt;!--扫描后引用的时候使用类名首字母小写--&gt;</div><div class="line">    &lt;property name=&quot;basePackage&quot; value=&quot;cn.itheima.mapper&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p><em>每个mapper代理对象的id就是类名首字母小写</em></p>
<h1 id="八、mybatis逆向工程"><a href="#八、mybatis逆向工程" class="headerlink" title="八、mybatis逆向工程"></a>八、mybatis逆向工程</h1><p>使用官方网站的mapper自动生成工具mybatis-generator-core-1.3.2来生成po类和mapper映射文件。</p>
<p>作用:mybatis官方提供逆向工程,可以使用它通过数据库中的表来自动生成Mapper接口和映射文件(单表增删改查)和Po类.</p>
<p>需要导入的jar包包括：</p>
<p><img src="/img/mybatis-6.png" alt="Alt text"></p>
<h2 id="1、mapper生成配置文件"><a href="#1、mapper生成配置文件" class="headerlink" title="1、mapper生成配置文件"></a>1、mapper生成配置文件</h2><p>在generatorConfig.xml中配置mapper生成的详细信息，需要注意：</p>
<ol>
<li><p>添加要生成的数据库表</p>
</li>
<li><p>po文件所在的包路径</p>
</li>
<li><p>mapper文件所在的包路径</p>
</li>
</ol>
<p>配置文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE generatorConfiguration</div><div class="line">        PUBLIC &quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</div><div class="line">        &quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;&gt;</div><div class="line"></div><div class="line">&lt;generatorConfiguration&gt;</div><div class="line">    &lt;context id=&quot;testTables&quot; targetRuntime=&quot;MyBatis3&quot;&gt;</div><div class="line">        &lt;commentGenerator&gt;</div><div class="line">            &lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</div><div class="line">            &lt;property name=&quot;suppressAllComments&quot; value=&quot;true&quot; /&gt;</div><div class="line">        &lt;/commentGenerator&gt;</div><div class="line">        &lt;!--数据库连接的信息：驱动类、连接地址、用户名、密码 --&gt;</div><div class="line">        &lt;jdbcConnection driverClass=&quot;com.mysql.jdbc.Driver&quot;</div><div class="line">                        connectionURL=&quot;jdbc:mysql://localhost:3306/springmvc&quot; userId=&quot;root&quot;</div><div class="line">                        password=&quot;linux&quot;&gt;</div><div class="line">        &lt;/jdbcConnection&gt;</div><div class="line">        &lt;!-- &lt;jdbcConnection driverClass=&quot;oracle.jdbc.OracleDriver&quot;</div><div class="line">            connectionURL=&quot;jdbc:oracle:thin:@127.0.0.1:1521:yycg&quot;</div><div class="line">            userId=&quot;yycg&quot;</div><div class="line">            password=&quot;yycg&quot;&gt;</div><div class="line">        &lt;/jdbcConnection&gt; --&gt;</div><div class="line"></div><div class="line">        &lt;!-- 默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer，为 true时把JDBC DECIMAL 和</div><div class="line">            NUMERIC 类型解析为java.math.BigDecimal --&gt;</div><div class="line">        &lt;javaTypeResolver&gt;</div><div class="line">            &lt;property name=&quot;forceBigDecimals&quot; value=&quot;false&quot; /&gt;</div><div class="line">        &lt;/javaTypeResolver&gt;</div><div class="line"></div><div class="line">        &lt;!-- targetProject:生成PO类的位置 --&gt;</div><div class="line">        &lt;javaModelGenerator targetPackage=&quot;cn.itheima.pojo&quot;</div><div class="line">                            targetProject=&quot;.\src&quot;&gt;</div><div class="line">            &lt;!-- enableSubPackages:是否让schema作为包的后缀 --&gt;</div><div class="line">            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</div><div class="line">            &lt;!-- 从数据库返回的值被清理前后的空格 --&gt;</div><div class="line">            &lt;property name=&quot;trimStrings&quot; value=&quot;true&quot; /&gt;</div><div class="line">        &lt;/javaModelGenerator&gt;</div><div class="line">        &lt;!-- targetProject:mapper映射文件生成的位置 --&gt;</div><div class="line">        &lt;sqlMapGenerator targetPackage=&quot;cn.itheima.dao&quot;</div><div class="line">                         targetProject=&quot;.\src&quot;&gt;</div><div class="line">            &lt;!-- enableSubPackages:是否让schema作为包的后缀 --&gt;</div><div class="line">            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</div><div class="line">        &lt;/sqlMapGenerator&gt;</div><div class="line">        &lt;!-- targetPackage：mapper接口生成的位置 --&gt;</div><div class="line">        &lt;javaClientGenerator type=&quot;XMLMAPPER&quot;</div><div class="line">                             targetPackage=&quot;cn.itheima.dao&quot;</div><div class="line">                             targetProject=&quot;.\src&quot;&gt;</div><div class="line">            &lt;!-- enableSubPackages:是否让schema作为包的后缀 --&gt;</div><div class="line">            &lt;property name=&quot;enableSubPackages&quot; value=&quot;false&quot; /&gt;</div><div class="line">        &lt;/javaClientGenerator&gt;</div><div class="line">        &lt;!-- 指定数据库表 --&gt;</div><div class="line">        &lt;table tableName=&quot;items&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;!--&lt;table tableName=&quot;orders&quot;&gt;&lt;/table&gt;--&gt;</div><div class="line">        &lt;!--&lt;table tableName=&quot;orderdetail&quot;&gt;&lt;/table&gt;--&gt;</div><div class="line">        &lt;table tableName=&quot;user&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;!-- &lt;table schema=&quot;&quot; tableName=&quot;sys_user&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;table schema=&quot;&quot; tableName=&quot;sys_role&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;table schema=&quot;&quot; tableName=&quot;sys_permission&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;table schema=&quot;&quot; tableName=&quot;sys_user_role&quot;&gt;&lt;/table&gt;</div><div class="line">        &lt;table schema=&quot;&quot; tableName=&quot;sys_role_permission&quot;&gt;&lt;/table&gt; --&gt;</div><div class="line"></div><div class="line">        &lt;!-- 有些表的字段需要指定java类型</div><div class="line">         &lt;table schema=&quot;&quot; tableName=&quot;&quot;&gt;</div><div class="line">            &lt;columnOverride column=&quot;&quot; javaType=&quot;&quot; /&gt;</div><div class="line">        &lt;/table&gt; --&gt;</div><div class="line">    &lt;/context&gt;</div><div class="line">&lt;/generatorConfiguration&gt;</div></pre></td></tr></table></figure>
<h2 id="2、使用java类生成mapper文件"><a href="#2、使用java类生成mapper文件" class="headerlink" title="2、使用java类生成mapper文件"></a>2、使用java类生成mapper文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">import org.mybatis.generator.api.MyBatisGenerator;</div><div class="line">import org.mybatis.generator.config.Configuration;</div><div class="line">import org.mybatis.generator.config.xml.ConfigurationParser;</div><div class="line">import org.mybatis.generator.internal.DefaultShellCallback;</div><div class="line"></div><div class="line">import java.io.File;</div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class StartServer &#123;</div><div class="line"></div><div class="line">    public void generator() throws Exception&#123;</div><div class="line">        List&lt;String&gt; warnings = new ArrayList&lt;String&gt;();</div><div class="line">        boolean overwrite = true;</div><div class="line">        File configFile = new File(&quot;generator.xml&quot;);</div><div class="line">        ConfigurationParser cp = new ConfigurationParser(warnings);</div><div class="line">        Configuration config = cp.parseConfiguration(configFile);</div><div class="line">        DefaultShellCallback callback = new DefaultShellCallback(overwrite);</div><div class="line">        MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config,</div><div class="line">                callback, warnings);</div><div class="line">        myBatisGenerator.generate(null);</div><div class="line">    &#125;</div><div class="line">    public static void main(String[] args) throws Exception &#123;</div><div class="line">        try &#123;</div><div class="line">            StartServer startServer = new StartServer();</div><div class="line">            startServer.generator();</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="3、将生成的mapper文件拷贝到指定目录"><a href="#3、将生成的mapper文件拷贝到指定目录" class="headerlink" title="3、将生成的mapper文件拷贝到指定目录"></a>3、将生成的mapper文件拷贝到指定目录</h2><p><em>注意：mapper xml文件和mapper.java文件在一个目录内且文件名相同。</em></p>
<h2 id="4、测试mapper接口"><a href="#4、测试mapper接口" class="headerlink" title="4、测试mapper接口"></a>4、测试mapper接口</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">package cn.itheima.dao;</div><div class="line"></div><div class="line">import cn.itheima.pojo.Items;</div><div class="line">import cn.itheima.pojo.ItemsExample;</div><div class="line">import java.util.List;</div><div class="line">import org.apache.ibatis.annotations.Param;</div><div class="line"></div><div class="line">public interface ItemsMapper &#123;</div><div class="line">    int countByExample(ItemsExample example);</div><div class="line"></div><div class="line">    int deleteByExample(ItemsExample example);</div><div class="line"></div><div class="line">    int deleteByPrimaryKey(Integer id);</div><div class="line"></div><div class="line">    int insert(Items record);</div><div class="line"></div><div class="line">    int insertSelective(Items record);</div><div class="line"></div><div class="line">    List&lt;Items&gt; selectByExampleWithBLOBs(ItemsExample example);</div><div class="line"></div><div class="line">    List&lt;Items&gt; selectByExample(ItemsExample example);</div><div class="line"></div><div class="line">    Items selectByPrimaryKey(Integer id);</div><div class="line"></div><div class="line">    int updateByExampleSelective(@Param(&quot;record&quot;) Items record, @Param(&quot;example&quot;) ItemsExample example);</div><div class="line"></div><div class="line">    int updateByExampleWithBLOBs(@Param(&quot;record&quot;) Items record, @Param(&quot;example&quot;) ItemsExample example);</div><div class="line"></div><div class="line">    int updateByExample(@Param(&quot;record&quot;) Items record, @Param(&quot;example&quot;) ItemsExample example);</div><div class="line"></div><div class="line">    int updateByPrimaryKeySelective(Items record);</div><div class="line"></div><div class="line">    int updateByPrimaryKeyWithBLOBs(Items record);</div><div class="line"></div><div class="line">    int updateByPrimaryKey(Items record);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="5、注意事项"><a href="#5、注意事项" class="headerlink" title="5、注意事项"></a>5、注意事项</h2><ol>
<li><p>Mapper文件内容时追加不是覆盖。所以XXXMapper.xml文件已经存在时，如果进行重新生成则mapper.xml文件内容不被覆盖而是进行内容追加，结果导致mybatis解析失败。<br><em>解决方法：删除原来已经生成的mapper xml文件再进行生成。Mybatis自动生成的po及mapper.java文件不是内容而是直接覆盖没有此问题。</em></p>
</li>
<li><p>Table Schema问题：</p>
</li>
</ol>
<p>下边是关于针对oracle数据库表生成代码的schema问题：</p>
<p>Schma即数据库模式，oracle中一个用户对应一个schema，可以理解为用户就是schema。<br>当Oralce数据库存在多个schema可以访问相同的表名时，使用mybatis生成该表的mapper.xml将会出现mapper.xml内容重复的问题，结果导致mybatis解析错误。<br>解决方法：在table中填写schema，如下：</p>
<p><table schema="XXXX" tablename=" "><br>XXXX即为一个schema的名称，生成后将mapper.xml的schema前缀批量去掉，如果不去掉当oracle用户变更了sql语句将查询失败。<br>快捷操作方式：mapper.xml文件中批量替换：“from XXXX.”为空</table></p>
<p>Oracle查询对象的schema可从dba_objects中查询，如下：<br>select * from dba_objects</p>
<h1 id="九、总结"><a href="#九、总结" class="headerlink" title="九、总结"></a>九、总结</h1><ol>
<li><p>mybatis是一个持久层框架, 作用是跟数据库交互完成增删改查</p>
</li>
<li><p>原生Dao实现(需要接口和实现类)</p>
</li>
<li><p>动态代理方式(只需要接口)<br>  mapper接口代理实现编写规则:</p>
<ol>
<li>映射文件中namespace要等于接口的全路径名称</li>
<li>映射文件中sql语句id要等于接口的方法名称</li>
<li>映射文件中传入参数类型要等于接口方法的传入参数类型</li>
<li>映射文件中返回结果集类型要等于接口方法的返回值类型</li>
</ol>
</li>
<li><p>#{}占位符:占位<br> 如果传入的是基本类型,那么#{}中的变量名称可以随意写<br> 如果传入的参数是pojo类型,那么#{}中的变量名称必须是pojo中的属性.属性.属性…</p>
</li>
<li><p>${}拼接符:字符串原样拼接<br> 如果传入的是基本类型,那么${}中的变量名必须是value<br> 如果传入的参数是pojo类型,那么${}中的变量名称必须是pojo中的属性.属性.属性…<br> 注意:使用拼接符有可能造成sql注入,在页面输入的时候可以加入校验,不可输入sql关键字,不可输入空格</p>
</li>
<li><p>映射文件:</p>
<ol>
<li>传入参数类型通过parameterType属性指定</li>
<li>返回结果集类型通过resultType属性指定</li>
</ol>
</li>
<li><p>hibernate和mybatis区别:</p>
<ul>
<li>hibernate:它是一个标准的orm框架,比较重量级,学习成本高.<br>  优点:高度封装,使用起来不用写sql,开发的时候,会减低开发周期.<br>  缺点:sql语句无法优化<br>  应用场景:oa(办公自动化系统), erp(企业的流程系统)等,还有一些政府项目,<pre><code>总的来说,在用于量不大,并发量小的时候使用.
</code></pre></li>
<li>mybatis:它不是一个orm框架, 它是对jdbc的轻量级封装, 学习成本低,比较简单<br>  有点:学习成本低, sql语句可以优化, 执行效率高,速度快<br>  缺点:编码量较大,会拖慢开发周期<br>  应用场景: 互联网项目,比如电商,P2p等<pre><code>总的来说是用户量较大,并发高的项目.
</code></pre></li>
</ul>
</li>
<li><p>输入映射(就是映射文件中可以传入哪些参数类型)</p>
<ul>
<li>1)基本类型<ul>
<li>2)pojo类型</li>
<li>3)Vo类型</li>
</ul>
</li>
</ul>
</li>
<li><p>输出映射(返回的结果集可以有哪些类型)</p>
<ul>
<li>1)基本类型</li>
<li>2)pojo类型</li>
<li>3)List类型</li>
</ul>
</li>
<li><p>动态sql:动态的拼接sql语句,因为sql中where条件有可能多也有可能少</p>
<ul>
<li>1)where:可以自动添加where关键字,还可以去掉第一个条件的and关键字</li>
<li>2)if:判断传入的参数是否为空</li>
<li>3)foreach:循环遍历传入的集合参数</li>
<li>4)sql:封装查询条件,以达到重用的目的</li>
</ul>
</li>
<li><p>对单个对象的映射关系:</p>
<ul>
<li>1)自动关联(偷懒的办法):可以自定义一个大而全的pojo类,然后自动映射其实是根据数据库总的字段名称和pojo中的属性名称对应.</li>
<li>2)手动关联: 需要指定数据库中表的字段名称和java的pojo类中的属性名称的对应关系.使用association标签</li>
</ul>
</li>
<li><p>对集合对象的映射关系<br>  只能使用手动映射:指定表中字段名称和pojo中属性名称的对应关系使用collection标签</p>
</li>
<li><p>spring和mybatis整合<br>  整合后会话工厂都归spring管理</p>
<pre><code>*     1)原生Dao实现:
         需要在spring配置文件中指定dao实现类
         dao实现类需要继承SqlSessionDaoSupport超类
         在dao实现类中不要手动关闭会话,不要自己提交事务.
*     2)Mapper接口代理实现:
         在spring配置文件中可以使用包扫描的方式,一次性的将所有mapper加载
</code></pre></li>
<li><p>逆向工程:自动生成Pojo类,还可以自动生成Mapper接口和映射文件</p>
<pre><code>注意:生成的方式是追加而不是覆盖,所以不可以重复生成,重复生成的文件有问题.
    如果想重复生成将原来生成的文件删除
</code></pre></li>
</ol>
<blockquote>
<p>概念区分：</p>
<ol>
<li>pojo:不按mvc分层,只是java bean有一些属性,还有get set方法</li>
<li>domain:不按mvc分层,只是java bean有一些属性,还有get set方法</li>
<li>po:用在持久层,还可以再增加或者修改的时候,从页面直接传入action中,它里面的java bean 类名等于表名,<br> 属性名等于表的字段名,还有对应的get set方法</li>
<li>vo: view object表现层对象,主要用于在高级查询中从页面接收传过来的各种参数.好处是扩展性强</li>
<li>bo: 用在servie层,现在企业基本不用.</li>
</ol>
</blockquote>
<p>这些po,vo, bo,pojo可以用在各种层面吗?</p>
<p>可以,也就是po用在表现层,vo用在持久层不报错,因为都是普通的java bean没有语法错误.<br>但是在企业最好不要混着用,因为这些都是设计的原则,混着用比较乱.不利于代码维护.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/JDK源码之HashMap和ConcurrentHashMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/JDK源码之HashMap和ConcurrentHashMap/" itemprop="url">JDK源码之HashMap和ConcurrentHashMap理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h1><ul>
<li><p>hashhMap本质是数组+链表。根据key取得hash值，然后计算出数组下标，如果多个key对应到同一个下标，就用链表连接起来，最新插入的数据在链表头。</p>
</li>
<li><p>HashMap继承AbstractHashMap，实现了Map，Cloneable，Serializable接口</p>
</li>
<li><p>HashMap设计线程不安全的。</p>
</li>
<li><p>对键值对的描述，Node：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;</div><div class="line">        final int hash;</div><div class="line">        final K key;</div><div class="line">        V value;</div><div class="line">        Node&lt;K,V&gt; next;</div><div class="line"></div><div class="line">        Node(int hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">            this.hash = hash;</div><div class="line">            this.key = key;</div><div class="line">            this.value = value;</div><div class="line">            this.next = next;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>hashmap中键值对的存储形式为链表节点，hasCode相同的节点位于一个桶中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public final int hashCode() &#123;</div><div class="line">     return Objects.hashCode(key) ^ Objects.hashCode(value);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h2 id="红黑树"><a href="#红黑树" class="headerlink" title="红黑树"></a>红黑树</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">static final class TreeNode&lt;K,V&gt; extends LinkedHashMap.Entry&lt;K,V&gt; &#123;</div><div class="line">    TreeNode&lt;K,V&gt; parent;  // red-black tree links</div><div class="line">    TreeNode&lt;K,V&gt; left;</div><div class="line">    TreeNode&lt;K,V&gt; right;</div><div class="line">    TreeNode&lt;K,V&gt; prev;    // needed to unlink next upon deletion</div><div class="line">    boolean red;</div><div class="line">    TreeNode(int hash, K key, V val, Node&lt;K,V&gt; next) &#123;</div><div class="line">        super(hash, key, val, next);</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="HashMap构造函数"><a href="#HashMap构造函数" class="headerlink" title="HashMap构造函数"></a>HashMap构造函数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public HashMap(int initialCapacity, float loadFactor) &#123;</div><div class="line">    if (initialCapacity &lt; 0)</div><div class="line">        throw new IllegalArgumentException(&quot;Illegal initial capacity: &quot; +</div><div class="line">                                           initialCapacity);</div><div class="line">    if (initialCapacity &gt; MAXIMUM_CAPACITY)</div><div class="line">        initialCapacity = MAXIMUM_CAPACITY;</div><div class="line">    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))</div><div class="line">        throw new IllegalArgumentException(&quot;Illegal load factor: &quot; +</div><div class="line">                                           loadFactor);</div><div class="line">    this.loadFactor = loadFactor;</div><div class="line">    this.threshold = tableSizeFor(initialCapacity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HashMap的构造方法中的三个重要的参数：</p>
<ul>
<li>capacity:容量，表示数组容量大小</li>
<li>loadFactor:比例，扩容用</li>
<li>threshold：最多容纳的Entry数=capacity*loadFactory，如果当前元素个数多于这个就要扩容（capacity扩容为2倍）<ul>
<li>static final int TREEIFY_THRESHOLD： JDK1.8 新加，Entry链表最大长度，当桶中节点数目大于该长度时，将链表转成红黑树存储；</li>
<li>static final int UNTREEIFY_THRESHOLD：JDK1.8 新加，当桶中节点数小于该长度，将红黑树转为链表存储；</li>
<li>static final int DEFAULT_INITIAL_CAPACITY: 默认键值队个数为16</li>
</ul>
</li>
</ul>
<h2 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public V get(Object key) &#123;</div><div class="line">       Node&lt;K,V&gt; e;</div><div class="line">       return (e = getNode(hash(key), key)) == null ? null : e.value;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   final Node&lt;K,V&gt; getNode(int hash, Object key) &#123;</div><div class="line">           Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; int n; K k;</div><div class="line">           if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;</div><div class="line">               (first = tab[(n - 1) &amp; hash]) != null) &#123;</div><div class="line">               if (first.hash == hash &amp;&amp; // always check first node</div><div class="line">                   ((k = first.key) == key || (key != null &amp;&amp; key.equals(k))))</div><div class="line">                   return first;</div><div class="line">               if ((e = first.next) != null) &#123;</div><div class="line">                   if (first instanceof TreeNode)</div><div class="line">                       return ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</div><div class="line">                   do &#123;</div><div class="line">                       if (e.hash == hash &amp;&amp;</div><div class="line">                           ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))</div><div class="line">                           return e;</div><div class="line">                   &#125; while ((e = e.next) != null);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           return null;</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<p>先查找对应桶的首元素，然后根据红黑树结构OR链表结构对应查找。</p>
<h2 id="put方法"><a href="#put方法" class="headerlink" title="put方法"></a>put方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">public V put(K key, V value) &#123;</div><div class="line">    return putVal(hash(key), key, value, false, true);</div><div class="line">&#125;</div><div class="line"></div><div class="line">final V putVal(int hash, K key, V value, boolean onlyIfAbsent,</div><div class="line">               boolean evict) &#123;</div><div class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i;</div><div class="line">    if ((tab = table) == null || (n = tab.length) == 0)</div><div class="line">        n = (tab = resize()).length;</div><div class="line">    if ((p = tab[i = (n - 1) &amp; hash]) == null)</div><div class="line">        tab[i] = newNode(hash, key, value, null);</div><div class="line">    else &#123;</div><div class="line">        Node&lt;K,V&gt; e; K k;</div><div class="line">        if (p.hash == hash &amp;&amp;</div><div class="line">            ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))</div><div class="line">            e = p;</div><div class="line">        else if (p instanceof TreeNode)</div><div class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(this, tab, hash, key, value);</div><div class="line">        else &#123;</div><div class="line">            for (int binCount = 0; ; ++binCount) &#123;</div><div class="line">                if ((e = p.next) == null) &#123;</div><div class="line">                    p.next = newNode(hash, key, value, null);</div><div class="line">                    if (binCount &gt;= TREEIFY_THRESHOLD - 1) // -1 for 1st</div><div class="line">                        treeifyBin(tab, hash);</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">                if (e.hash == hash &amp;&amp;</div><div class="line">                    ((k = e.key) == key || (key != null &amp;&amp; key.equals(k))))</div><div class="line">                    break;</div><div class="line">                p = e;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (e != null) &#123; // existing mapping for key</div><div class="line">            V oldValue = e.value;</div><div class="line">            if (!onlyIfAbsent || oldValue == null)</div><div class="line">                e.value = value;</div><div class="line">            afterNodeAccess(e);</div><div class="line">            return oldValue;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ++modCount;</div><div class="line">    if (++size &gt; threshold)</div><div class="line">        resize();</div><div class="line">    afterNodeInsertion(evict);</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>散列分布策略：键值对的槽位 = （容量-1） * hash(key)</p>
<ul>
<li>键值对槽位是键值对在tab数组的索引，本质为其hash值对容量取余，但是位运算更快。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">static final int hash(Object key) &#123;</div><div class="line">int h;</div><div class="line">return (key == null) ? 0 : (h = key.hashCode()) ^ (h &gt;&gt;&gt; 16);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>HashMap更新和新增的核心思想：</p>
<ul>
<li>根据键值对key的hashCode计算键值对的HashMap中的槽位</li>
<li>判断是否空桶或者发生Hash冲突</li>
<li>解决hash冲突：根据桶组织形式是红黑树或者链表进行对应插入操作，链表插入操作完成之后，检查是否超过链表阈值，超过将链表转换成红黑树</li>
<li>最后检查键值对总数是否超过阈值，超过阈值调用resize（）进行rehash操作。</li>
</ul>
</li>
</ul>
<h2 id="resize方法"><a href="#resize方法" class="headerlink" title="resize方法"></a>resize方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">final Node&lt;K,V&gt;[] resize() &#123;</div><div class="line">       Node&lt;K,V&gt;[] oldTab = table;</div><div class="line">       int oldCap = (oldTab == null) ? 0 : oldTab.length;</div><div class="line">       int oldThr = threshold;</div><div class="line">       int newCap, newThr = 0;</div><div class="line">       if (oldCap &gt; 0) &#123;</div><div class="line">           if (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</div><div class="line">               threshold = Integer.MAX_VALUE;</div><div class="line">               return oldTab;</div><div class="line">           &#125;</div><div class="line">           else if ((newCap = oldCap &lt;&lt; 1) &lt; MAXIMUM_CAPACITY &amp;&amp;</div><div class="line">                    oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</div><div class="line">               newThr = oldThr &lt;&lt; 1; // double threshold</div><div class="line">       &#125;</div><div class="line">       else if (oldThr &gt; 0) // initial capacity was placed in threshold</div><div class="line">           newCap = oldThr;</div><div class="line">       else &#123;               // zero initial threshold signifies using defaults</div><div class="line">           newCap = DEFAULT_INITIAL_CAPACITY;</div><div class="line">           newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</div><div class="line">       &#125;</div><div class="line">       if (newThr == 0) &#123;</div><div class="line">           float ft = (float)newCap * loadFactor;</div><div class="line">           newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (float)MAXIMUM_CAPACITY ?</div><div class="line">                     (int)ft : Integer.MAX_VALUE);</div><div class="line">       &#125;</div><div class="line">       threshold = newThr;</div><div class="line">       @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</div><div class="line">           Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])new Node[newCap];</div><div class="line">       table = newTab;</div><div class="line">       if (oldTab != null) &#123;</div><div class="line">           for (int j = 0; j &lt; oldCap; ++j) &#123;</div><div class="line">               Node&lt;K,V&gt; e;</div><div class="line">               if ((e = oldTab[j]) != null) &#123;</div><div class="line">                   oldTab[j] = null;</div><div class="line">                   if (e.next == null)</div><div class="line">                       newTab[e.hash &amp; (newCap - 1)] = e;</div><div class="line">                   else if (e instanceof TreeNode)</div><div class="line">                       ((TreeNode&lt;K,V&gt;)e).split(this, newTab, j, oldCap);</div><div class="line">                   else &#123; // preserve order</div><div class="line">                       Node&lt;K,V&gt; loHead = null, loTail = null;</div><div class="line">                       Node&lt;K,V&gt; hiHead = null, hiTail = null;</div><div class="line">                       Node&lt;K,V&gt; next;</div><div class="line">                       do &#123;</div><div class="line">                           next = e.next;</div><div class="line">                           if ((e.hash &amp; oldCap) == 0) &#123;</div><div class="line">                               if (loTail == null)</div><div class="line">                                   loHead = e;</div><div class="line">                               else</div><div class="line">                                   loTail.next = e;</div><div class="line">                               loTail = e;</div><div class="line">                           &#125;</div><div class="line">                           else &#123;</div><div class="line">                               if (hiTail == null)</div><div class="line">                                   hiHead = e;</div><div class="line">                               else</div><div class="line">                                   hiTail.next = e;</div><div class="line">                               hiTail = e;</div><div class="line">                           &#125;</div><div class="line">                       &#125; while ((e = next) != null);</div><div class="line">                       if (loTail != null) &#123;</div><div class="line">                           loTail.next = null;</div><div class="line">                           newTab[j] = loHead;</div><div class="line">                       &#125;</div><div class="line">                       if (hiTail != null) &#123;</div><div class="line">                           hiTail.next = null;</div><div class="line">                           newTab[j + oldCap] = hiHead;</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       return newTab;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>当键值对总数超过阈值时，HashMap通过resize方法实现重散列rehash，容量增加为原来的2倍。</li>
</ul>
<h2 id="remove方法"><a href="#remove方法" class="headerlink" title="remove方法"></a>remove方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">public V remove(Object key) &#123;</div><div class="line">    Node&lt;K,V&gt; e;</div><div class="line">    return (e = removeNode(hash(key), key, null, false, true)) == null ?</div><div class="line">        null : e.value;</div><div class="line">&#125;</div><div class="line">final Node&lt;K,V&gt; removeNode(int hash, Object key, Object value,</div><div class="line">                               boolean matchValue, boolean movable) &#123;</div><div class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, index;</div><div class="line">        if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;</div><div class="line">            (p = tab[index = (n - 1) &amp; hash]) != null) &#123;</div><div class="line">            Node&lt;K,V&gt; node = null, e; K k; V v;</div><div class="line">            if (p.hash == hash &amp;&amp;</div><div class="line">                ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))</div><div class="line">                node = p;</div><div class="line">            else if ((e = p.next) != null) &#123;</div><div class="line">                if (p instanceof TreeNode)</div><div class="line">                    node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</div><div class="line">                else &#123;</div><div class="line">                    do &#123;</div><div class="line">                        if (e.hash == hash &amp;&amp;</div><div class="line">                            ((k = e.key) == key ||</div><div class="line">                             (key != null &amp;&amp; key.equals(k)))) &#123;</div><div class="line">                            node = e;</div><div class="line">                            break;</div><div class="line">                        &#125;</div><div class="line">                        p = e;</div><div class="line">                    &#125; while ((e = e.next) != null);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (node != null &amp;&amp; (!matchValue || (v = node.value) == value ||</div><div class="line">                                 (value != null &amp;&amp; value.equals(v)))) &#123;</div><div class="line">                if (node instanceof TreeNode)</div><div class="line">                    ((TreeNode&lt;K,V&gt;)node).removeTreeNode(this, tab, movable);</div><div class="line">                else if (node == p)</div><div class="line">                    tab[index] = node.next;</div><div class="line">                else</div><div class="line">                    p.next = node.next;</div><div class="line">                ++modCount;</div><div class="line">                --size;</div><div class="line">                afterNodeRemoval(node);</div><div class="line">                return node;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h1 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h1><ul>
<li>在HashMap的基础上，ConcurrentHashMap放弃了分段锁机制，利用CAS+Synchronized来保证并发更新的安全，低层依然采用数组+链表+红黑树的存储结构</li>
</ul>
<h1 id="重要属性"><a href="#重要属性" class="headerlink" title="重要属性"></a>重要属性</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * The array of bins. Lazily initialized upon first insertion.</div><div class="line"> * Size is always a power of two. Accessed directly by iterators.</div><div class="line"> */</div><div class="line">transient volatile Node&lt;K,V&gt;[] table;</div></pre></td></tr></table></figure>
<p>table:默认为null，懒加载，初始化发生在第一次插入的时候，默认大小16，大小总为2的幂次方，用来存储节点数据，可以由迭代器直接调用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * The next table to use; non-null only while resizing.</div><div class="line"> */</div><div class="line">private transient volatile Node&lt;K,V&gt;[] nextTable;</div></pre></td></tr></table></figure>
<p>nextTable:默认为null，扩容时新生成的数组，其大小为原数组的两倍。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Table initialization and resizing control.  When negative, the</div><div class="line"> * table is being initialized or resized: -1 for initialization,</div><div class="line"> * else -(1 + the number of active resizing threads).  Otherwise,</div><div class="line"> * when table is null, holds the initial table size to use upon</div><div class="line"> * creation, or 0 for default. After initialization, holds the</div><div class="line"> * next element count value upon which to resize the table.</div><div class="line"> */</div><div class="line">private transient volatile int sizeCtl;</div></pre></td></tr></table></figure>
<p>sizeCtl:默认为0，用来控制table初始化和扩容操作，-1表示table正在初始化，-N表示有N-1个线程正在进行扩容操作。如果table未被初始化，表示table需要初始化的大小，如果table初始化完成，表示table的容量，默认为0.75</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;</div><div class="line">    final int hash;</div><div class="line">    final K key;</div><div class="line">    volatile V val;</div><div class="line">    volatile Node&lt;K,V&gt; next;</div><div class="line"></div><div class="line">    Node(int hash, K key, V val, Node&lt;K,V&gt; next) &#123;</div><div class="line">        this.hash = hash;</div><div class="line">        this.key = key;</div><div class="line">        this.val = val;</div><div class="line">        this.next = next;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>Node:保存key,value以及key的hash值的数据结构，val和next由violate修饰，保证并发可见性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">static final class ForwardingNode&lt;K,V&gt; extends Node&lt;K,V&gt; &#123;</div><div class="line">        final Node&lt;K,V&gt;[] nextTable;</div><div class="line">        ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</div><div class="line">            super(MOVED, null, null, null);</div><div class="line">            this.nextTable = tab;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ForwardingNode：特殊的Node节点，hash值为-1，其中存储nextTable的引用，只有table发生扩容时才有用，作为一个占位符放在table中表示当前节点为null或者已经被移动。</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public ConcurrentHashMap(int initialCapacity) &#123;</div><div class="line">    if (initialCapacity &lt; 0)</div><div class="line">        throw new IllegalArgumentException();</div><div class="line">    int cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; 1)) ?</div><div class="line">               MAXIMUM_CAPACITY :</div><div class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; 1) + 1));</div><div class="line">    this.sizeCtl = cap;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>会自动调整输入的证书为2的幂次方。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">private static final int tableSizeFor(int c) &#123;</div><div class="line">    int n = c - 1;</div><div class="line">    n |= n &gt;&gt;&gt; 1;</div><div class="line">    n |= n &gt;&gt;&gt; 2;</div><div class="line">    n |= n &gt;&gt;&gt; 4;</div><div class="line">    n |= n &gt;&gt;&gt; 8;</div><div class="line">    n |= n &gt;&gt;&gt; 16;</div><div class="line">    return (n &lt; 0) ? 1 : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于初始化在第一次插入数据时进行，则要确保只有一次初始化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">   * Initializes table, using the size recorded in sizeCtl.</div><div class="line">   */</div><div class="line">  private final Node&lt;K,V&gt;[] initTable() &#123;</div><div class="line">      Node&lt;K,V&gt;[] tab; int sc;</div><div class="line">      while ((tab = table) == null || tab.length == 0) &#123;</div><div class="line">          if ((sc = sizeCtl) &lt; 0)</div><div class="line">              Thread.yield(); // lost initialization race; just spin</div><div class="line">          else if (U.compareAndSwapInt(this, SIZECTL, sc, -1)) &#123;</div><div class="line">              try &#123;</div><div class="line">                  if ((tab = table) == null || tab.length == 0) &#123;</div><div class="line">                      int n = (sc &gt; 0) ? sc : DEFAULT_CAPACITY;</div><div class="line">                      @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">                      Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])new Node&lt;?,?&gt;[n];</div><div class="line">                      table = tab = nt;</div><div class="line">                      sc = n - (n &gt;&gt;&gt; 2);</div><div class="line">                  &#125;</div><div class="line">              &#125; finally &#123;</div><div class="line">                  sizeCtl = sc;</div><div class="line">              &#125;</div><div class="line">              break;</div><div class="line">          &#125;</div><div class="line">      &#125;</div><div class="line">      return tab;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>sizeCtl默认值为0，如果ConcurrentHashMap实例化时有传参数，sizeCtl会是一个2的幂次方的值。所以和自行第一次put操作的线程会执行compareAndSwapInt方法修改sizeCtl值为-1，有且只有一个线程能够修改成功，其他线程通过Thread.yield()让出CPU时间片等待table初始化完成。</p>
<h2 id="put方法-1"><a href="#put方法-1" class="headerlink" title="put方法"></a>put方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line">public V put(K key, V value) &#123;</div><div class="line">    return putVal(key, value, false);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/** Implementation for put and putIfAbsent */</div><div class="line">final V putVal(K key, V value, boolean onlyIfAbsent) &#123;</div><div class="line">    if (key == null || value == null) throw new NullPointerException();</div><div class="line">    int hash = spread(key.hashCode());</div><div class="line">    int binCount = 0;</div><div class="line">    for (Node&lt;K,V&gt;[] tab = table;;) &#123;</div><div class="line">        Node&lt;K,V&gt; f; int n, i, fh;</div><div class="line">        if (tab == null || (n = tab.length) == 0)</div><div class="line">            tab = initTable();</div><div class="line">        else if ((f = tabAt(tab, i = (n - 1) &amp; hash)) == null) &#123;</div><div class="line">            if (casTabAt(tab, i, null,</div><div class="line">                         new Node&lt;K,V&gt;(hash, key, value, null)))</div><div class="line">                break;                   // no lock when adding to empty bin</div><div class="line">        &#125;</div><div class="line">        else if ((fh = f.hash) == MOVED)</div><div class="line">            tab = helpTransfer(tab, f);</div><div class="line">        else &#123;</div><div class="line">            V oldVal = null;</div><div class="line">            synchronized (f) &#123;</div><div class="line">                if (tabAt(tab, i) == f) &#123;</div><div class="line">                    if (fh &gt;= 0) &#123;</div><div class="line">                        binCount = 1;</div><div class="line">                        for (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</div><div class="line">                            K ek;</div><div class="line">                            if (e.hash == hash &amp;&amp;</div><div class="line">                                ((ek = e.key) == key ||</div><div class="line">                                 (ek != null &amp;&amp; key.equals(ek)))) &#123;</div><div class="line">                                oldVal = e.val;</div><div class="line">                                if (!onlyIfAbsent)</div><div class="line">                                    e.val = value;</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line">                            Node&lt;K,V&gt; pred = e;</div><div class="line">                            if ((e = e.next) == null) &#123;</div><div class="line">                                pred.next = new Node&lt;K,V&gt;(hash, key,</div><div class="line">                                                          value, null);</div><div class="line">                                break;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    else if (f instanceof TreeBin) &#123;</div><div class="line">                        Node&lt;K,V&gt; p;</div><div class="line">                        binCount = 2;</div><div class="line">                        if ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</div><div class="line">                                                       value)) != null) &#123;</div><div class="line">                            oldVal = p.val;</div><div class="line">                            if (!onlyIfAbsent)</div><div class="line">                                p.val = value;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            if (binCount != 0) &#123;</div><div class="line">                if (binCount &gt;= TREEIFY_THRESHOLD)</div><div class="line">                    treeifyBin(tab, i);</div><div class="line">                if (oldVal != null)</div><div class="line">                    return oldVal;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    addCount(1L, binCount);</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>put采用CAS+synchronized实现并发插入或更新操作。</p>
<ol>
<li>hash算法获取key的hash值</li>
<li>table中定位索引的位置，n为table的大小</li>
<li>获取table中对应索引的元素f，Unsafe.getObjectVolatile来确保获取的数据为最新的。</li>
<li>f为空，说明该位置第一次插入节点，用Unsafe.compareAndSwapObject插入Node节点。如果CAS成功，说明Node节点已经插入，随后检查当前容量是否需要扩容。如果CAS失败，说明有其他线程提前插入了节点，自旋重新尝试在这个位置插入节点。</li>
<li>如果f的值为-1，说明f是当前ForwardingNode节点，意味着有其他线程进行扩容，则一起进行扩容操作。</li>
<li>其余情况把新的Node节点按照链或者红黑树的方式插入到合适的位置，这个过程采用同步内置锁实现。</li>
</ol>
<h2 id="table扩容"><a href="#table扩容" class="headerlink" title="table扩容"></a>table扩容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">private final void addCount(long x, int check) &#123;</div><div class="line">       CounterCell[] as; long b, s;</div><div class="line">       if ((as = counterCells) != null ||</div><div class="line">           !U.compareAndSwapLong(this, BASECOUNT, b = baseCount, s = b + x)) &#123;</div><div class="line">           CounterCell a; long v; int m;</div><div class="line">           boolean uncontended = true;</div><div class="line">           if (as == null || (m = as.length - 1) &lt; 0 ||</div><div class="line">               (a = as[ThreadLocalRandom.getProbe() &amp; m]) == null ||</div><div class="line">               !(uncontended =</div><div class="line">                 U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</div><div class="line">               fullAddCount(x, uncontended);</div><div class="line">               return;</div><div class="line">           &#125;</div><div class="line">           if (check &lt;= 1)</div><div class="line">               return;</div><div class="line">           s = sumCount();</div><div class="line">       &#125;</div><div class="line">       if (check &gt;= 0) &#123;</div><div class="line">           Node&lt;K,V&gt;[] tab, nt; int n, sc;</div><div class="line">           while (s &gt;= (long)(sc = sizeCtl) &amp;&amp; (tab = table) != null &amp;&amp;</div><div class="line">                  (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</div><div class="line">               int rs = resizeStamp(n);</div><div class="line">               if (sc &lt; 0) &#123;</div><div class="line">                   if ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + 1 ||</div><div class="line">                       sc == rs + MAX_RESIZERS || (nt = nextTable) == null ||</div><div class="line">                       transferIndex &lt;= 0)</div><div class="line">                       break;</div><div class="line">                   if (U.compareAndSwapInt(this, SIZECTL, sc, sc + 1))</div><div class="line">                       transfer(tab, nt);</div><div class="line">               &#125;</div><div class="line">               else if (U.compareAndSwapInt(this, SIZECTL, sc,</div><div class="line">                                            (rs &lt;&lt; RESIZE_STAMP_SHIFT) + 2))</div><div class="line">                   transfer(tab, null);</div><div class="line">               s = sumCount();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>当table容量不足时，及table的元素数量达到容量阈值sizeCtl，需要经table扩容：</p>
<ol>
<li>构建一个nextTable,大小为table的两倍<ul>
<li>通过Unsafe.compareAndSwapInt修改sizeCtl的值，保证只有一个线程能够输出化nextTable,扩容后数组长度为原来的两倍，但是容量是原来的1.5。</li>
</ul>
</li>
<li>把table的数据复制到nextTable中<ul>
<li>首先根据运算得到遍历的次数i,然后利用tabAt方法获得i位置的元素f,初始化一个forwardNode实例fwd。</li>
<li>如果f == null，则在table的i位置放入fwd。</li>
<li>如果f是链表的头节点，就构造一个反序链表，把他们分别放在nextTable的i和i+n的位置上，移动完成，采用Unsafe.putObjectVolatile方法给table原位置赋值fwd。</li>
<li>如果f是TreeBin节点，也做一个反序处理，并判断是否需要untreeify，把处理的结果分别放在nextTable的i和i+n的位置上，移动完成，同样采用Unsafe.putObjectVolatile方法给table原位置赋值fwd</li>
</ul>
</li>
</ol>
<h2 id="get方法-1"><a href="#get方法-1" class="headerlink" title="get方法"></a>get方法</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public V get(Object key) &#123;</div><div class="line">       Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; int n, eh; K ek;</div><div class="line">       int h = spread(key.hashCode());</div><div class="line">       if ((tab = table) != null &amp;&amp; (n = tab.length) &gt; 0 &amp;&amp;</div><div class="line">           (e = tabAt(tab, (n - 1) &amp; h)) != null) &#123;</div><div class="line">           if ((eh = e.hash) == h) &#123;</div><div class="line">               if ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek)))</div><div class="line">                   return e.val;</div><div class="line">           &#125;</div><div class="line">           else if (eh &lt; 0)</div><div class="line">               return (p = e.find(h, key)) != null ? p.val : null;</div><div class="line">           while ((e = e.next) != null) &#123;</div><div class="line">               if (e.hash == h &amp;&amp;</div><div class="line">                   ((ek = e.key) == key || (ek != null &amp;&amp; key.equals(ek))))</div><div class="line">                   return e.val;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       return null;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<ul>
<li>ConcurrentHashMap是一个并发散列表的实现，它允许完全并发的读取，并且支持给定数量的并发更新。相比于HashTable和同步包装的HashMap，适用一个全局的锁来同步不同线程的并发访问，同一时间点，只能有一个线程持有锁，也就是说在同一个时间点，只有一个线程能访问容器，这虽然保证了多线程的并发访问安全，但是同时也和导致对容器的访问变成串行的了。1.6中采用ReentrantLock分段锁的方式，使用多个线程在不同的segment上进行写操作不会发生阻塞行为。1.8中采用内置锁synchronized。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/JDK源码之LinkedHashMap源码剖析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/JDK源码之LinkedHashMap源码剖析/" itemprop="url">JDK源码之LinkedHashMap源码剖析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>LinkedHashMap继承了HashMap类并实现了Map接口，其内部维护了一个双向链表，在每次插入数据或者修改访问数据，在双链表中会存在相应的增删高的操作，从而实现将无序的HashMap通过双链表将其管理为有序状态的map类型。</p>
<h1 id="内部节点"><a href="#内部节点" class="headerlink" title="内部节点"></a>内部节点</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">static class Entry&lt;K,V&gt; extends HashMap.Node&lt;K,V&gt; &#123;</div><div class="line">    Entry&lt;K,V&gt; before, after;</div><div class="line">    Entry(int hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">        super(hash, key, value, next);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LinkedHashMap中的节点Entry继承了HashMap中内部类Node，为其添加两个链表以实现节点之间的有序存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//Hashmap中的节点</div><div class="line">static class Node&lt;K,V&gt; implements Map.Entry&lt;K,V&gt; &#123;</div><div class="line">        final int hash;</div><div class="line">        final K key;</div><div class="line">        V value;</div><div class="line">        Node&lt;K,V&gt; next;</div><div class="line"></div><div class="line">        Node(int hash, K key, V value, Node&lt;K,V&gt; next) &#123;</div><div class="line">            this.hash = hash;</div><div class="line">            this.key = key;</div><div class="line">            this.value = value;</div><div class="line">            this.next = next;</div><div class="line">        &#125;</div><div class="line">        //omit</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>同时存在两个成员变量，head和tail指向双链表的首尾两端，以及一个accessOrder，accessOrder指定双链表的迭代顺序，如果其为true，则采用访问顺序，如果为false，则采用插入顺序。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * The head (eldest) of the doubly linked list.</div><div class="line"> */</div><div class="line">transient LinkedHashMap.Entry&lt;K,V&gt; head;</div><div class="line"></div><div class="line">/**</div><div class="line"> * The tail (youngest) of the doubly linked list.</div><div class="line"> */</div><div class="line">transient LinkedHashMap.Entry&lt;K,V&gt; tail;</div><div class="line">/**</div><div class="line"> * The iteration ordering method for this linked hash map: &lt;tt&gt;true&lt;/tt&gt;</div><div class="line"> * for access-order, &lt;tt&gt;false&lt;/tt&gt; for insertion-order.</div><div class="line"> *</div><div class="line"> * @serial</div><div class="line"> */</div><div class="line">final boolean accessOrder;</div></pre></td></tr></table></figure>
<h1 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 构造一个按照插入顺序迭代的Hashmap对象，并指定初始容量和扩展因子</div><div class="line"> * @param  initialCapacity the initial capacity</div><div class="line"> * @param  loadFactor      the load factor</div><div class="line"> * @throws IllegalArgumentException if the initial capacity is negative</div><div class="line"> *         or the load factor is nonpositive</div><div class="line"> */</div><div class="line">public LinkedHashMap(int initialCapacity, float loadFactor) &#123;</div><div class="line">    super(initialCapacity, loadFactor);</div><div class="line">    accessOrder = false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 构造一个按照插入顺序迭代的Hashmap对象，并指定初始容量，使用默认的扩展因子0.75</div><div class="line"> * @param  initialCapacity the initial capacity</div><div class="line"> * @throws IllegalArgumentException if the initial capacity is negative</div><div class="line"> */</div><div class="line">public LinkedHashMap(int initialCapacity) &#123;</div><div class="line">    super(initialCapacity);</div><div class="line">    accessOrder = false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 构造一个按照插入顺序迭代的Hashmap对象，使用默认的初始容量16和扩展因子0.75</div><div class="line"> */</div><div class="line">public LinkedHashMap() &#123;</div><div class="line">    super();</div><div class="line">    accessOrder = false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 通过一个map构造一个按照插入顺序迭代的Hashmap对象，</div><div class="line"> * 初始容量为大于map的值,扩展因子0.75</div><div class="line"> *</div><div class="line"> * @param  m the map whose mappings are to be placed in this map</div><div class="line"> * @throws NullPointerException if the specified map is null</div><div class="line"> */</div><div class="line">public LinkedHashMap(Map&lt;? extends K, ? extends V&gt; m) &#123;</div><div class="line">    super();</div><div class="line">    accessOrder = false;</div><div class="line">    //批量插入一个map到本集合中</div><div class="line">    putMapEntries(m, false);</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> * 构造一个按照插入顺序迭代的Hashmap对象，并指定初始容量和扩展因子，和迭代顺序</div><div class="line"> *</div><div class="line"> * @param  initialCapacity the initial capacity</div><div class="line"> * @param  loadFactor      the load factor</div><div class="line"> * @param  accessOrder     the ordering mode - &lt;tt&gt;true&lt;/tt&gt; for</div><div class="line"> *         access-order, &lt;tt&gt;false&lt;/tt&gt; for insertion-order</div><div class="line"> * @throws IllegalArgumentException if the initial capacity is negative</div><div class="line"> *         or the load factor is nonpositive</div><div class="line"> */</div><div class="line">public LinkedHashMap(int initialCapacity,</div><div class="line">                     float loadFactor,</div><div class="line">                     boolean accessOrder) &#123;</div><div class="line">    super(initialCapacity, loadFactor);</div><div class="line">    this.accessOrder = accessOrder;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="新增节点"><a href="#新增节点" class="headerlink" title="新增节点"></a>新增节点</h1><ul>
<li>LinkedHashMap添加节点采用的是HashMap中的put方法。在putVal方法中调用了newNode()方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">final V putVal(int hash, K key, V value, boolean onlyIfAbsent,</div><div class="line">                   boolean evict) &#123;</div><div class="line">        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; int n, i;</div><div class="line">        if ((tab = table) == null || (n = tab.length) == 0)</div><div class="line">            n = (tab = resize()).length;</div><div class="line">        if ((p = tab[i = (n - 1) &amp; hash]) == null)</div><div class="line">            tab[i] = newNode(hash, key, value, null);</div><div class="line">        else &#123;</div><div class="line">          //omit...</div><div class="line">        &#125;</div><div class="line">        ++modCount;</div><div class="line">        if (++size &gt; threshold)</div><div class="line">            resize();</div><div class="line">        afterNodeInsertion(evict);</div><div class="line">        return null;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ul>
<li>LinkedHashMap重写了构建节点newNode()方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Node&lt;K,V&gt; newNode(int hash, K key, V value, Node&lt;K,V&gt; e) &#123;</div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; p =</div><div class="line">        new LinkedHashMap.Entry&lt;K,V&gt;(hash, key, value, e);</div><div class="line">    linkNodeLast(p);</div><div class="line">    return p;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>每次构建新节点时，通过linkNodeLast(p)将新节点链接在内部双向链表的尾部。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// link at the end of list</div><div class="line">private void linkNodeLast(LinkedHashMap.Entry&lt;K,V&gt; p) &#123;</div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; last = tail;</div><div class="line">    tail = p;</div><div class="line">    if (last == null)</div><div class="line">        head = p;</div><div class="line">    else &#123;</div><div class="line">        p.before = last;</div><div class="line">        last.after = p;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>putVal方法中最后调用了afterNodeInsertion(evict),很容易发现，在HashMap中这个方法是空的，而LinkedHashMap中重写了这些方法，用于对相应操作之后对双链表的修改。如果是按照</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// hashMao中的预留函数</div><div class="line">// Callbacks to allow LinkedHashMap post-actions</div><div class="line">void afterNodeAccess(Node&lt;K,V&gt; p) &#123; &#125;</div><div class="line">void afterNodeInsertion(boolean evict) &#123; &#125;</div><div class="line">void afterNodeRemoval(Node&lt;K,V&gt; p) &#123; &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">void afterNodeInsertion(boolean evict) &#123; // possibly remove eldest</div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; first;</div><div class="line">    //判断是否需要移除最老的值</div><div class="line">    if (evict &amp;&amp; (first = head) != null &amp;&amp; removeEldestEntry(first)) &#123;</div><div class="line">        K key = first.key;</div><div class="line">        removeNode(hash(key), key, null, false, true);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">//默认是不移除的，但是如果要实现缓存，需要删除最老的值。实现LRUCache需要重写该方法</div><div class="line">protected boolean removeEldestEntry(Map.Entry&lt;K,V&gt; eldest) &#123;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Demo展示：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public class LinkedHashMapDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Map&lt;Integer,String&gt; map = new LinkedHashMap&lt;&gt;();</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            map.put(i, &quot;&quot; + i);</div><div class="line">            System.out.println(map.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;1=1&#125;</div><div class="line">&#123;1=1, 2=2&#125;</div><div class="line">&#123;1=1, 2=2, 3=3&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5, 6=6&#125;</div></pre></td></tr></table></figure>
<h1 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h1><ul>
<li>LinkedHashMap没有重写删除节点，调用HashMap中的删除方法。删除之后通过调用重写之后的afterNodeRemoveal()这个回调方法来对双链表进行调整。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//删除节点e时，需要相应调整双链表</div><div class="line">void afterNodeRemoval(Node&lt;K,V&gt; e) &#123; // unlink</div><div class="line">   LinkedHashMap.Entry&lt;K,V&gt; p =</div><div class="line">       (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</div><div class="line">   //链表节点中只有e一个节点</div><div class="line">   p.before = p.after = null;</div><div class="line">   //e为头节点</div><div class="line">   if (b == null)</div><div class="line">       head = a;</div><div class="line">   else</div><div class="line">       b.after = a;</div><div class="line">   //e为尾节点</div><div class="line">   if (a == null)</div><div class="line">       tail = b;</div><div class="line">   else</div><div class="line">       a.before = b;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Demo展示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class LinkedHashMapDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Map&lt;Integer,String&gt; map = new LinkedHashMap&lt;&gt;();</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            map.put(i, &quot;&quot; + i);</div><div class="line">            System.out.println(map.toString());</div><div class="line">        &#125;</div><div class="line">        map.remove(6);</div><div class="line">        System.out.println(map.toString());</div><div class="line">        map.remove(3);</div><div class="line">        System.out.println(map.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;1=1, 2=2&#125;</div><div class="line">&#123;1=1, 2=2, 3=3&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5, 6=6&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5&#125;</div><div class="line">&#123;1=1, 2=2, 4=4, 5=5&#125;</div></pre></td></tr></table></figure>
<h1 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h1><ul>
<li>没错，LinkedHashMap重写了get方法及getOrDefaul方法,比较简单，就是查找，查找完之后，如果迭代顺序采用是访问顺序，则需要调用函数afterNodeAccess来调整双向链表。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public V get(Object key) &#123;</div><div class="line">    Node&lt;K,V&gt; e;</div><div class="line">    if ((e = getNode(hash(key), key)) == null)</div><div class="line">        return null;</div><div class="line">    if (accessOrder)</div><div class="line">        afterNodeAccess(e);</div><div class="line">    return e.value;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public V getOrDefault(Object key, V defaultValue) &#123;</div><div class="line">   Node&lt;K,V&gt; e;</div><div class="line">   if ((e = getNode(hash(key), key)) == null)</div><div class="line">       return defaultValue;</div><div class="line">   if (accessOrder)</div><div class="line">       afterNodeAccess(e);</div><div class="line">   return e.value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">//将访问过的节点移动至内部的双向链表的尾部。</div><div class="line">void afterNodeAccess(Node&lt;K,V&gt; e) &#123; // move node to last</div><div class="line">    LinkedHashMap.Entry&lt;K,V&gt; last;</div><div class="line">    if (accessOrder &amp;&amp; (last = tail) != e) &#123;</div><div class="line">        LinkedHashMap.Entry&lt;K,V&gt; p =</div><div class="line">            (LinkedHashMap.Entry&lt;K,V&gt;)e, b = p.before, a = p.after;</div><div class="line">        p.after = null;</div><div class="line">        if (b == null)</div><div class="line">            head = a;</div><div class="line">        else</div><div class="line">            b.after = a;</div><div class="line">        if (a != null)</div><div class="line">            a.before = b;</div><div class="line">        else</div><div class="line">            last = b;</div><div class="line">        if (last == null)</div><div class="line">            head = p;</div><div class="line">        else &#123;</div><div class="line">            p.before = last;</div><div class="line">            last.after = p;</div><div class="line">        &#125;</div><div class="line">        tail = p;</div><div class="line">        ++modCount;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>Demo展示</p>
<ul>
<li><p>按照插入顺序输出</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class LinkedHashMapDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Map&lt;Integer,String&gt; map = new LinkedHashMap&lt;&gt;();</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            map.put(i, &quot;&quot; + i);</div><div class="line">        &#125;</div><div class="line">        System.out.println(map.toString());</div><div class="line">        map.get(3);</div><div class="line">        map.get(6);</div><div class="line">        System.out.println(map);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5, 6=6&#125;</div><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5, 6=6&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>按照访问顺序输出，accessOrder=true</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class LinkedHashMapDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Map&lt;Integer,String&gt; orderMap = new LinkedHashMap&lt;Integer, String &gt;(16,0.75f, true);</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            orderMap.put(i, &quot;&quot; + i);</div><div class="line">        &#125;</div><div class="line">        System.out.println(orderMap.toString());</div><div class="line">        orderMap.get(3);</div><div class="line">        System.out.println(orderMap);</div><div class="line">        orderMap.get(1);</div><div class="line">        System.out.println(orderMap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;1=1, 2=2, 3=3, 4=4, 5=5, 6=6&#125;</div><div class="line">&#123;1=1, 2=2, 4=4, 5=5, 6=6, 3=3&#125;</div><div class="line">&#123;2=2, 4=4, 5=5, 6=6, 3=3, 1=1&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="containsValue方法"><a href="#containsValue方法" class="headerlink" title="containsValue方法"></a>containsValue方法</h2><p>HashMap中的containsValue方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public boolean containsValue(Object value) &#123;</div><div class="line">    Node&lt;K,V&gt;[] tab; V v;</div><div class="line">    if ((tab = table) != null &amp;&amp; size &gt; 0) &#123;</div><div class="line">        for (int i = 0; i &lt; tab.length; ++i) &#123;</div><div class="line">            for (Node&lt;K,V&gt; e = tab[i]; e != null; e = e.next) &#123;</div><div class="line">                if ((v = e.value) == value ||</div><div class="line">                    (value != null &amp;&amp; value.equals(v)))</div><div class="line">                    return true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>LinkedHashMap中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public boolean containsValue(Object value) &#123;</div><div class="line">    for (LinkedHashMap.Entry&lt;K,V&gt; e = head; e != null; e = e.after) &#123;</div><div class="line">        V v = e.value;</div><div class="line">        if (v == value || (value != null &amp;&amp; value.equals(v)))</div><div class="line">            return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然，后者的实现更加的高效。</p>
<h1 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h1><p>LinkedHashMap中重写了entrySet()方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">public Set&lt;Map.Entry&lt;K,V&gt;&gt; entrySet() &#123;</div><div class="line">    Set&lt;Map.Entry&lt;K,V&gt;&gt; es;</div><div class="line">    return (es = entrySet) == null ? (entrySet = new LinkedEntrySet()) : es;</div><div class="line">&#125;</div><div class="line"></div><div class="line">final class LinkedEntrySet extends AbstractSet&lt;Map.Entry&lt;K,V&gt;&gt; &#123;</div><div class="line">    public final int size()                 &#123; return size; &#125;</div><div class="line">    public final void clear()               &#123; LinkedHashMap.this.clear(); &#125;</div><div class="line">    public final Iterator&lt;Map.Entry&lt;K,V&gt;&gt; iterator() &#123;</div><div class="line">        return new LinkedEntryIterator();</div><div class="line">    &#125;</div><div class="line">    public final boolean contains(Object o) &#123;</div><div class="line">        if (!(o instanceof Map.Entry))</div><div class="line">            return false;</div><div class="line">        Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</div><div class="line">        Object key = e.getKey();</div><div class="line">        Node&lt;K,V&gt; candidate = getNode(hash(key), key);</div><div class="line">        return candidate != null &amp;&amp; candidate.equals(e);</div><div class="line">    &#125;</div><div class="line">    public final boolean remove(Object o) &#123;</div><div class="line">        if (o instanceof Map.Entry) &#123;</div><div class="line">            Map.Entry&lt;?,?&gt; e = (Map.Entry&lt;?,?&gt;) o;</div><div class="line">            Object key = e.getKey();</div><div class="line">            Object value = e.getValue();</div><div class="line">            return removeNode(hash(key), key, value, true, true) != null;</div><div class="line">        &#125;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">    public final Spliterator&lt;Map.Entry&lt;K,V&gt;&gt; spliterator() &#123;</div><div class="line">        return Spliterators.spliterator(this, Spliterator.SIZED |</div><div class="line">                                        Spliterator.ORDERED |</div><div class="line">                                        Spliterator.DISTINCT);</div><div class="line">    &#125;</div><div class="line">    public final void forEach(Consumer&lt;? super Map.Entry&lt;K,V&gt;&gt; action) &#123;</div><div class="line">        if (action == null)</div><div class="line">            throw new NullPointerException();</div><div class="line">        int mc = modCount;</div><div class="line">        for (LinkedHashMap.Entry&lt;K,V&gt; e = head; e != null; e = e.after)</div><div class="line">            action.accept(e);</div><div class="line">        if (modCount != mc)</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>重写之后迭代LinkedHashMap就是从内部维护的双链表的表头开始循环输出。</li>
</ul>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li>LinkedHashMap继承HashMap，只需要重写几个方法，来改变其迭代遍历的顺序。同时在插入数据，访问数据，修改数据，会增加双链表上的节点或者调整顺序，来决定迭代时的输出顺序。</li>
<li>相应操作的回调函数，HashMap中有相应的空方法，也就意味着LinkedHashMap只需要重写这几个回调函数，而不用重写插入和删除方法。</li>
<li>LinkedhashMap重写了get方法。</li>
<li>LinkedHashMap优化了containsValue方法，提高其遍历性能。</li>
</ul>
<p>测试代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">import java.util.LinkedHashMap;</div><div class="line">import java.util.Map;</div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/4</div><div class="line"> */</div><div class="line">public class LinkedHashMapDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Map&lt;Integer,String&gt; map = new LinkedHashMap&lt;&gt;();</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            map.put(i, &quot;&quot; + i);</div><div class="line">//            System.out.println(map.toString());</div><div class="line">        &#125;</div><div class="line">        System.out.println(map.toString());</div><div class="line">//        map.remove(6);</div><div class="line">//        System.out.println(map.toString());</div><div class="line">//        map.remove(3);</div><div class="line">//        System.out.println(map.toString());</div><div class="line">        map.get(3);</div><div class="line">        map.get(6);</div><div class="line">        System.out.println(map);</div><div class="line"></div><div class="line">        Map&lt;Integer,String&gt; orderMap = new LinkedHashMap&lt;Integer, String &gt;(16,0.75f, true);</div><div class="line">        for (int i = 1; i &lt; 7; i++) &#123;</div><div class="line">            orderMap.put(i, &quot;&quot; + i);</div><div class="line">        &#125;</div><div class="line">        System.out.println(orderMap.toString());</div><div class="line">        orderMap.get(3);</div><div class="line">        System.out.println(orderMap);</div><div class="line">        orderMap.get(1);</div><div class="line">        System.out.println(orderMap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/JDK1.8新特性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/JDK1.8新特性/" itemprop="url">JDK1.8 新特性</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="/img/jdk1.8.png" alt="Alt text"></p>
<h1 id="接口的默认方法"><a href="#接口的默认方法" class="headerlink" title="接口的默认方法"></a>接口的默认方法</h1><p>Java8允许我们给接口添加一个非抽象的方法实现，只需要使用default关键字即可，这个特征被称作扩展方法。</p>
<p>首先我们定义一个接口，该接口有一个抽象方法print和一个具体方法defaultPrint();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public interface InterfaceEnhancement &#123;</div><div class="line">    void print();</div><div class="line">    default void defaultPrint(String string) &#123;</div><div class="line">        System.out.println( string + &quot;接口可以添加default修饰的非抽象方法了&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现了该接口一个类如下，并对其进行调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">class InterfaceEnhancementDemo implements InterfaceEnhancement &#123;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void print() &#123;</div><div class="line">        System.out.println(&quot;实现类实现了InterfaceEnhancement中的print方法&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        InterfaceEnhancementDemo IED = new InterfaceEnhancementDemo();</div><div class="line">        IED.print();</div><div class="line">        IED.defaultPrint(&quot;传给接口中的方法的字符串&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">实现类实现了InterfaceEnhancement中的print方法</div><div class="line">传给接口中的方法的字符串接口可以添加default修饰的非抽象方法了</div></pre></td></tr></table></figure>
<p>考虑到Java中只有单继承，如果需要给一个类赋予新特性，通常是使用接口来实现。允许接口中写具体的实现方法，实现对接口功能的扩展，避免了单继承的弊端。</p>
<h1 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h1><p>Java中对字符串进行排序，可以通过传入一个List对象和一个比较器来制定顺序排列。如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class LambdaDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        List&lt;String&gt; strings = Arrays.asList(&quot;1&quot;,&quot;2&quot;,&quot;3&quot;,&quot;11&quot;,&quot;12&quot;,&quot;5&quot;);</div><div class="line">        System.out.println(strings.toString());</div><div class="line">        Collections.sort(strings, new Comparator&lt;String&gt;() &#123;</div><div class="line">            @Override</div><div class="line">            public int compare(String o1, String o2) &#123;</div><div class="line">                return o1.compareTo(o2);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        System.out.println(strings.toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Lambda表达式提供了更加简洁的写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Collections.sort(strings, (o1, o2) -&gt; o1.compareTo(o2));</div><div class="line">//或者</div><div class="line">Collections.sort(strings, String::compareTo);</div></pre></td></tr></table></figure>
<h1 id="函数式接口"><a href="#函数式接口" class="headerlink" title="函数式接口"></a>函数式接口</h1><p>每一个Lambda表达式对应着一个类型，通常是接口类型。函数式接口指的是仅仅只包含一个抽象方法的接口，每一个该类型的lambda表达式都会被匹配到这个抽象方法中，该接口也可以添加默认方法。</p>
<p>因此实际上，我们可以把Lambda当成任意只包含一个抽象方法的接口类型，确保你的接口一定达到这个要求，只需要给接口添加@FunctionalInterface注解，编译时会检查接口中是否只存在一个抽象方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface FunctionalInterfaceDemo&lt;K,V&gt; &#123;</div><div class="line">    V get(K key);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class FITest &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        FunctionalInterfaceDemo&lt;String, String&gt; functionalInterfaceDemo = key -&gt; key + &quot;12&quot;;</div><div class="line">        String result = functionalInterfaceDemo.get(&quot;functionInterface&quot;);</div><div class="line">        System.out.println(result);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上不添加注解，程序也是可以正确执行的。而将Lambda表达式映射到一个但方法的接口上，在其他语言中已经有实现了。单一方法的接口使得Lambda表达式更加的简洁。</p>
<h1 id="方法与构造函数引用"><a href="#方法与构造函数引用" class="headerlink" title="方法与构造函数引用"></a>方法与构造函数引用</h1><p>Java中允许你使用<code>::</code>关键字来传递方法或者构造函数的引用，下面有一个实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public class Person &#123;</div><div class="line">    String name;</div><div class="line">    int age;</div><div class="line"></div><div class="line">    Person()&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Person(String name, int age) &#123;</div><div class="line">        this.name = name;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public interface PersonFactory&lt;P extends Person&gt; &#123;</div><div class="line">    P create(String name, int age);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class PersonTest &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        PersonFactory&lt;Person&gt; personPersonFactory = Person::new;</div><div class="line">        Person person = personPersonFactory.create(&quot;Peter&quot;, 18);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出Person::new获取Person类的构造函数的引用，Java编译器会根据create方法的签名来选取合适的构造方法。</p>
<h1 id="Lambda作用域"><a href="#Lambda作用域" class="headerlink" title="Lambda作用域"></a>Lambda作用域</h1><p>Lambda表达式中访问外层作用域和匿名方法中的方式类似，可以直接访问final修饰的外层局部变量，实例的字段及静态变量。</p>
<h2 id="访问局部变量"><a href="#访问局部变量" class="headerlink" title="访问局部变量"></a>访问局部变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class LocalDemo &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        final int num = 123;</div><div class="line">        FunctionalInterfaceDemo&lt;String, String&gt; functionalInterfaceDemo = key -&gt; key + num;</div><div class="line">        System.out.println(functionalInterfaceDemo.get(&quot;123&quot;));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>final不强制要求添加</li>
<li>不添加final，num也不能被后面的程序修改，隐式的final。</li>
</ul>
<h2 id="访问字段和静态变量"><a href="#访问字段和静态变量" class="headerlink" title="访问字段和静态变量"></a>访问字段和静态变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class FieldAndStaticFieldDemo &#123;</div><div class="line">    static int staticNum;</div><div class="line">    int normalNum;</div><div class="line"></div><div class="line">    void testScope() &#123;</div><div class="line">        FunctionalInterfaceDemo&lt;Integer, Integer&gt; f = (key) -&gt; &#123;</div><div class="line">            normalNum = 513;</div><div class="line">            return key +12;</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        FunctionalInterfaceDemo&lt;Integer, Integer&gt; f1 = (key) -&gt; &#123;</div><div class="line">            staticNum = 1234455;</div><div class="line">            return key + 12;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="访问接口的默认方法"><a href="#访问接口的默认方法" class="headerlink" title="访问接口的默认方法"></a>访问接口的默认方法</h1><p>JDK1.8中包含了很多内建的函数式接口，如之前常用的Comparator或者Runnable接口，这些接口都增加了@FunctionInterface注解以便可以使用Lambda表达式。同样提供了很多全新的Lambda接口。</p>
<ul>
<li>Predicate接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Predicate&lt;T&gt; &#123;</div><div class="line">    boolean test(T t);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该接口只有一个参数，返回boolean类型的值。改接口包含多种默认方式来将Predicate组合成其他复杂的逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Predicate&lt;String&gt; predicate = s -&gt; s.length() &gt; 0;</div><div class="line">System.out.println(predicate.test(&quot;foo&quot;));</div><div class="line">System.out.println(predicate.negate().test(&quot;foo&quot;));</div><div class="line"></div><div class="line">Predicate&lt;Boolean&gt; nonNull = Objects::nonNull;</div><div class="line">Predicate&lt;Boolean&gt; isNull = Objects::isNull;</div></pre></td></tr></table></figure>
<ul>
<li>Function接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Function&lt;T, R&gt; &#123;</div><div class="line">    R apply(T t);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>只有一个参数并且返回一个结果，附带了一些组合方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Function&lt;String, Integer&gt; function = Integer::valueOf;</div><div class="line">Function&lt;String, String&gt; function1 = s -&gt; s + 11;</div></pre></td></tr></table></figure>
<ul>
<li>Supplier接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Supplier&lt;T&gt; &#123;</div><div class="line">    T get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>返回一个任意范式的值。</p>
<ul>
<li>Consumer接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Consumer&lt;T&gt; &#123;</div><div class="line">    void accept(T t);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Comparator接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@FunctionalInterface</div><div class="line">public interface Comparator&lt;T&gt; &#123;</div><div class="line">    int compare(T o1, T o2);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Optional接口</li>
</ul>
<p>不是函数式接口，是用来放置空指针异常的辅助类型。</p>
<ul>
<li>Stream接口</li>
</ul>
<p>表示能应用中哎一组元素上一次执行的操作序列。Stream操作分为中间操作或者最终操作两种，最终操作返回以特定类型的计算结果，而中间操作返回Stream本身。可以将多个操作穿起来。Stream创建过程中需要指定一个数据源。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class StreamFuture &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        List&lt;String&gt; stringCollection = new ArrayList&lt;&gt;();</div><div class="line">        stringCollection.add(&quot;ddd2&quot;);</div><div class="line">        stringCollection.add(&quot;aaa2&quot;);</div><div class="line">        stringCollection.add(&quot;bbb1&quot;);</div><div class="line">        stringCollection.add(&quot;aaa1&quot;);</div><div class="line">        stringCollection.add(&quot;bbb3&quot;);</div><div class="line">        stringCollection.add(&quot;ccc&quot;);</div><div class="line">        stringCollection.add(&quot;bbb2&quot;);</div><div class="line">        stringCollection.add(&quot;ddd1&quot;);</div><div class="line">        System.out.println(stringCollection.toString());</div><div class="line">        //Filter过滤</div><div class="line">        stringCollection.stream().filter(s -&gt; s.startsWith(&quot;b&quot;)).forEach(System.out::println);</div><div class="line">        //Sort排序</div><div class="line">        stringCollection.stream().sorted().filter(s -&gt; s.startsWith(&quot;b&quot;)).forEach(System.out::println);</div><div class="line">        // map操作</div><div class="line">        stringCollection.stream().map(String::toUpperCase).sorted().forEach(System.out::println);</div><div class="line">        //Match 匹配操作</div><div class="line">        System.out.println(stringCollection.stream().anyMatch(s -&gt; s.startsWith(&quot;a&quot;)));</div><div class="line">        System.out.println(stringCollection.stream().allMatch(s -&gt; s.length() &gt; 0));</div><div class="line">        System.out.println(stringCollection.stream().noneMatch(s -&gt; s.startsWith(&quot;h&quot;)));</div><div class="line">        // count计数</div><div class="line">        long count = stringCollection.stream().filter(s -&gt; s.startsWith(&quot;b&quot;)).count();</div><div class="line">        System.out.println(count);</div><div class="line">        // reduce规约</div><div class="line">        Optional&lt;String&gt; reduce = stringCollection.stream().sorted().reduce((s1,s2) -&gt; s1 + &quot;##&quot; + s2);</div><div class="line">        reduce.ifPresent(System.out::println);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<pre><code>* Filter过滤：通过一个Predicate接口来过滤并只保留符合条件的元素，该操作属于中间操作，所以在过滤后可以将结果来应用其他Stream操作。forEach需要一个函数来对过滤后的 元素依次执行。forEach时一个最终操作，不能在其之后再执行Stream操作。

* Sort排序：排序是一个中间操作。

* Map映射：中间操作map，会将元素根据指定的Function接口来依次将元素转换成另外的对象，如将小写转换成大写

* Match匹配：检测指定的Predicate是否匹配整个Stream，最终操作。

* Count计数，最终操作，返回Stream中元素的个数，返回值为long

* Reduce规约，将stream中的多个元素规约为一个元素，通过Optional接口来接收结果
</code></pre><p>上述的输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">[ddd2, aaa2, bbb1, aaa1, bbb3, ccc, bbb2, ddd1]</div><div class="line">bbb1</div><div class="line">bbb3</div><div class="line">bbb2</div><div class="line">bbb1</div><div class="line">bbb2</div><div class="line">bbb3</div><div class="line">AAA1</div><div class="line">AAA2</div><div class="line">BBB1</div><div class="line">BBB2</div><div class="line">BBB3</div><div class="line">CCC</div><div class="line">DDD1</div><div class="line">DDD2</div><div class="line">true</div><div class="line">true</div><div class="line">true</div><div class="line">3</div><div class="line">aaa1##aaa2##bbb1##bbb2##bbb3##ccc##ddd1##ddd2</div></pre></td></tr></table></figure>
<h1 id="并行Stream"><a href="#并行Stream" class="headerlink" title="并行Stream"></a>并行Stream</h1><p>多个线程并行计算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">public class MultiStreams &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        List&lt;String&gt; strings = new ArrayList&lt;&gt;(1000000);</div><div class="line">        for (int i = 0 ; i &lt; strings.size(); i++) &#123;</div><div class="line">            UUID uuid = UUID.randomUUID();</div><div class="line">            strings.add(uuid.toString());</div><div class="line">        &#125;</div><div class="line">        //串行计算</div><div class="line">        long time1 = System.nanoTime();</div><div class="line">        strings.stream().sorted();</div><div class="line">        long end1 = System.nanoTime();</div><div class="line">        long mills = TimeUnit.NANOSECONDS.toMillis(end1 - time1);</div><div class="line">        System.out.println(&quot;串行Stream排序1000万个数的时间为&quot; + mills + &quot;ms&quot;);</div><div class="line"></div><div class="line">        //并行计算</div><div class="line">        long time2 = System.nanoTime();</div><div class="line">        strings.stream().sorted();</div><div class="line">        long end2 = System.nanoTime();</div><div class="line">        long mill2 = TimeUnit.NANOSECONDS.toMillis(end2 - time2);</div><div class="line">        System.out.println(&quot;串行Stream排序1000万个数的时间为&quot; + mill2 + &quot;ms&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">串行Stream排序1000万个数的时间为1ms</div><div class="line">串行Stream排序1000万个数的时间为0ms</div></pre></td></tr></table></figure>
<p>实际上，并行计算不一定会快于串行运算，影响的因素很多：</p>
<ul>
<li>数据大小输入数据的大小会影响并行化处理对性能的提升。将问题分解之后并行化处理， 再将结果合并会带来额外的开销。 因此只有数据足够大、 每个数据处理管道花费的时间足够多<br>时， 并行化处理才有意义。</li>
<li>源数据结构，每个管道的操作都基于一些初始数据源，通常是集合。将不同的数据源分割相对容易,这里的开销影响了在管道中并行处理数据时到底能带来多少性能上的提升。</li>
<li>装箱,处理基本类型比处理装箱类型要快。</li>
<li>核的数量，极端情况下，只有一个核，因此完全没必要并行化。显然，拥有的核越多，获得潜在性能提升的幅度就越大。在实践中，核的数量不单指你的机器上有多少核，更是指运行时你的机器能使用多少核。这也就是说同时运行的其他进程，或者线程关联性（强制线程在某些核或CPU上运行）会影响性能。</li>
<li>单元处理开销，比如数据大小，这是一场并行执行花费时间和分解合并操作开销之间的战争。花在流中每个元素身上的时间越长，并行操作带来的性能提升越明显。</li>
</ul>
<h1 id="Date-API"><a href="#Date-API" class="headerlink" title="Date API"></a>Date API</h1><p>Java8中包含了一组全新的时间日期API，简单介绍下：</p>
<ul>
<li>Clock时钟：访问当前日期和时间的方法，对时区敏感。</li>
<li>Timezones时区：ZoneID来标志时区。</li>
<li>LocalTime本地时间：没有时区信息的时间</li>
<li>LocalDate本地日期</li>
<li>LocalDateTime：本地日期时间</li>
</ul>
<h1 id="Annotation注解"><a href="#Annotation注解" class="headerlink" title="Annotation注解"></a>Annotation注解</h1><ul>
<li>Java8中吃吃了多重注解。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@interface Hints &#123;</div><div class="line">    Hint[] value();</div><div class="line">&#125;</div><div class="line">@Repeatable(Hints.class)</div><div class="line">@interface Hint &#123;</div><div class="line">    String value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Java8中允许一个类型的注解使用多次</li>
</ul>
<p>使用包装类当容器来存多个注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Hints(&#123;@Hint(&quot;hint1&quot;), @Hint(&quot;hint2&quot;)&#125;)</div><div class="line">class Person &#123;&#125;</div></pre></td></tr></table></figure>
<p>使用多重注解</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Hint(&quot;hint1&quot;)</div><div class="line">@Hint(&quot;hint2&quot;)</div><div class="line">class Person &#123;&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/JDK源码之ArrayList源码剖析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/JDK源码之ArrayList源码剖析/" itemprop="url">JDK源码之ArrayList源码剖析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ArrayList是Java集合类中一个非常重要的实现类，低层实现为数组，在随机存储方面性能很高，但是在增删数据方面性能一般。平常使用的很多，但是还没有系统的取读取其源码。</p>
<h1 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt;</div><div class="line">        implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</div><div class="line">&#123;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><p>ArrayLis继承了AbstractList抽象类</p>
</li>
<li><p>ArrayList实现了List接口，RandomAccess接口，Cloneable接口和Serializable接口。</p>
<ul>
<li><p>List接口：一开始以为List接口都是很熟悉的东西，结果注释了下源码，发现还是有很多新加的特性，比如可分割迭代器这种，从来没有用过，不过今天的重点不在这里。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">public interface List&lt;E&gt; extends Collection&lt;E&gt; &#123;</div><div class="line">    //返回列表的长度</div><div class="line">    int size();</div><div class="line">    //列表是否为空</div><div class="line">    boolean isEmpty();</div><div class="line">    //列表中是否包含某个元素</div><div class="line">    boolean contains(Object o);</div><div class="line">    //获取列表的迭代器</div><div class="line">    Iterator&lt;E&gt; iterator();</div><div class="line">    //将列表转换成一个Object数组</div><div class="line">    Object[] toArray();</div><div class="line">    //将列表转换成任意类型的数组</div><div class="line">    &lt;T&gt; T[] toArray(T[] a);</div><div class="line">    //向列表中添加元素e</div><div class="line">    boolean add(E e);</div><div class="line">    //从列表中移除元素o</div><div class="line">    boolean remove(Object o);</div><div class="line">    //看列表中是否包含另一个集合的全部元素</div><div class="line">    boolean containsAll(Collection&lt;?&gt; c);</div><div class="line">    //将一个集合加入到列表中</div><div class="line">    boolean addAll(Collection&lt;? extends E&gt; c);</div><div class="line">    //将一个集合在指定位置加入到列表中</div><div class="line">    boolean addAll(int index, Collection&lt;? extends E&gt; c);</div><div class="line">    //将列表中属于另一个集合的元素都移除</div><div class="line">    boolean removeAll(Collection&lt;?&gt; c);</div><div class="line">    //移除所有不在另一个集合中的元素，取交集</div><div class="line">    boolean retainAll(Collection&lt;?&gt; c);</div><div class="line">    //对所有元素进行统一操作</div><div class="line">    default void replaceAll(UnaryOperator&lt;E&gt; operator) &#123;</div><div class="line">        Objects.requireNonNull(operator);</div><div class="line">        final ListIterator&lt;E&gt; li = this.listIterator();</div><div class="line">        while (li.hasNext()) &#123;</div><div class="line">            li.set(operator.apply(li.next()));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //根据给定的比较器对列表进行排序</div><div class="line">    @SuppressWarnings(&#123;&quot;unchecked&quot;, &quot;rawtypes&quot;&#125;)</div><div class="line">    default void sort(Comparator&lt;? super E&gt; c) &#123;</div><div class="line">        Object[] a = this.toArray();</div><div class="line">        Arrays.sort(a, (Comparator) c);</div><div class="line">        ListIterator&lt;E&gt; i = this.listIterator();</div><div class="line">        for (Object e : a) &#123;</div><div class="line">            i.next();</div><div class="line">            i.set((E) e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //清空列表</div><div class="line">    void clear();</div><div class="line">    // 判断两个列表是否相等</div><div class="line">    boolean equals(Object o);</div><div class="line">    //返回列表的哈希值</div><div class="line">    int hashCode();</div><div class="line">    //获取index位置的元素</div><div class="line">    E get(int index);</div><div class="line">    //将index位置元素的值设定为element</div><div class="line">    E set(int index, E element);</div><div class="line">    //在指定位置添加元素</div><div class="line">    void add(int index, E element);</div><div class="line">    //移除index位置的元素</div><div class="line">    E remove(int index);</div><div class="line">    //元素o的最靠前的下标</div><div class="line">    int indexOf(Object o);</div><div class="line">    //元素o最靠后的下标</div><div class="line">    int lastIndexOf(Object o);</div><div class="line">    //返回迭代器列表</div><div class="line">    ListIterator&lt;E&gt; listIterator();</div><div class="line">    //返回指定位置之后的迭代器列表</div><div class="line">    ListIterator&lt;E&gt; listIterator(int index);</div><div class="line">    //返回字列表</div><div class="line">    List&lt;E&gt; subList(int fromIndex, int toIndex);</div><div class="line">    //返回并行迭代器列表</div><div class="line">    @Override</div><div class="line">    default Spliterator&lt;E&gt; spliterator() &#123;</div><div class="line">        return Spliterators.spliterator(this, Spliterator.ORDERED);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>RandomAccess接口：是一个空的接口，目的是为了标明实现该接口的List是否支持随机访问，支持的话访问会更加高效。Java中有很多空接口是为了起到标记的作用，看ArrayList源码时需要注意这一点的作用。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface RandomAccess &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Cloneable接口：目的是为了表明实现了该接口的对象可以调用clone方法来实现对象的复制，设计模式中原型模式就是用的这个特性，该特性jdk1.0就已经支持了，可以说很Java了。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface Cloneable &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Serializable接口：序列化接口是为了标记一个对象的状态是否能序列化到文件，提供了一种内存中对象的保存和加载机制，也是个标记接口。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">public interface Serializable &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>可以看出，ArrayList除了三个标记接口外，最重要的还是List接口方法的实现。</p>
<h1 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">//序列化接口的VersionID，序列化时记录到文件中，反序列化过程中进行版本校验。</div><div class="line">private static final long serialVersionUID = 8683452581122892189L;</div><div class="line"></div><div class="line">//ArrayList初始的列表大小</div><div class="line">private static final int DEFAULT_CAPACITY = 10;</div><div class="line"></div><div class="line">//共享的空数组</div><div class="line">private static final Object[] EMPTY_ELEMENTDATA = &#123;&#125;;</div><div class="line"></div><div class="line"> //共享空数组，专门给默认大小使用的。</div><div class="line">private static final Object[] DEFAULTCAPACITY_EMPTY_ELEMENTDATA = &#123;&#125;;</div><div class="line"></div><div class="line"> //ArrayList数据保存的位置，不参与序列化</div><div class="line">transient Object[] elementData; // non-private to simplify nested class access</div><div class="line"></div><div class="line">//ArrayList中元素的个数</div><div class="line">private int size;</div></pre></td></tr></table></figure>
<h1 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h1><p>总结来说，ArrayList的构造方法有啥三个，默认长度的，指定长度的，根据集合类生成的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">// 创建一个指定大小的ArrayList</div><div class="line">public ArrayList(int initialCapacity) &#123;</div><div class="line">    if (initialCapacity &gt; 0) &#123;</div><div class="line">        this.elementData = new Object[initialCapacity];</div><div class="line">    &#125; else if (initialCapacity == 0) &#123;</div><div class="line">        this.elementData = EMPTY_ELEMENTDATA;</div><div class="line">    &#125; else &#123;</div><div class="line">        throw new IllegalArgumentException(&quot;Illegal Capacity: &quot;+</div><div class="line">                                           initialCapacity);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 创建一个默认大小（10）的ArrayList</div><div class="line">public ArrayList() &#123;</div><div class="line">    this.elementData = DEFAULTCAPACITY_EMPTY_ELEMENTDATA;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 根据给定的集合，创建包含该集合的所有元素的ArrayList</div><div class="line">public ArrayList(Collection&lt;? extends E&gt; c) &#123;</div><div class="line">    // 将给定集合元素存储到elementData数组中</div><div class="line">    elementData = c.toArray();</div><div class="line">    if ((size = elementData.length) != 0) &#123;</div><div class="line">        // 返回的不是Object数组时，进行数组复制操作</div><div class="line">        if (elementData.getClass() != Object[].class)</div><div class="line">            elementData = Arrays.copyOf(elementData, size, Object[].class);</div><div class="line">    &#125; else &#123;</div><div class="line">        // 空数组时，为elementData赋值</div><div class="line">        this.elementData = EMPTY_ELEMENTDATA;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="trimToSize-方法"><a href="#trimToSize-方法" class="headerlink" title="trimToSize()方法"></a>trimToSize()方法</h1><p>该方法是将ArrayList的容量设置为当前size的大小。目的是为了缩减ArrayList的存储空间，ArrayList的容量为开辟的数组长度，size为存进去的元素个数。当我们只需要对ArrayList做查询操作，而不需要进行新增操作，则可以trim节省内存空间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public void trimToSize() &#123;</div><div class="line">    // 继承自AbstractList，防止多线程操作情况下，List发生结构性变化。</div><div class="line">    modCount++;</div><div class="line">    if (size &lt; elementData.length) &#123;</div><div class="line">        elementData = (size == 0)</div><div class="line">          ? EMPTY_ELEMENTDATA</div><div class="line">          : Arrays.copyOf(elementData, size);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>JDK源码里面三元表达式用的比较多，if判断用的比较少，以后需要多使用三元表达式，很简洁直观。</p>
<h1 id="size-方法"><a href="#size-方法" class="headerlink" title="size()方法"></a>size()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 返回列表中的元素个数</div><div class="line">public int size() &#123;</div><div class="line">    return size;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="isEmpty-方法"><a href="#isEmpty-方法" class="headerlink" title="isEmpty()方法"></a>isEmpty()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 判断ArrayList是否为空</div><div class="line">public boolean isEmpty() &#123;</div><div class="line">    return size == 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="contains-Object-o-方法"><a href="#contains-Object-o-方法" class="headerlink" title="contains(Object o)方法"></a>contains(Object o)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//调用indexof方法来判断一个对象是否在ArrayList中</div><div class="line">public boolean contains(Object o) &#123;</div><div class="line">    return indexOf(o) &gt;= 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="indexOf-Object-o-方法"><a href="#indexOf-Object-o-方法" class="headerlink" title="indexOf(Object o) 方法"></a>indexOf(Object o) 方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">//判断一个元素是否在列表中，如果存在，返回第一个靠前位置的下标，如果不存在，返回-1。</div><div class="line">public int indexOf(Object o) &#123;</div><div class="line">    // 如果传入的对象为null,则看有没有对象为null在列表中</div><div class="line">    if (o == null) &#123;</div><div class="line">        for (int i = 0; i &lt; size; i++)</div><div class="line">            if (elementData[i]==null)</div><div class="line">                return i;</div><div class="line">    // 调用Object的equals方法来进行比较两个元素是否相等</div><div class="line">    &#125; else &#123;</div><div class="line">        for (int i = 0; i &lt; size; i++)</div><div class="line">            if (o.equals(elementData[i]))</div><div class="line">                return i;</div><div class="line">    &#125;</div><div class="line">    return -1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="lastIndexOf-Object-o-方法"><a href="#lastIndexOf-Object-o-方法" class="headerlink" title="lastIndexOf(Object o) 方法"></a>lastIndexOf(Object o) 方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">//找到一个元素在列表中最后一个出现的索引并返回，没找到返回-1，和indexOf方法，只是遍历数组时倒叙遍历而已，不赘述。</div><div class="line">public int lastIndexOf(Object o) &#123;</div><div class="line">    if (o == null) &#123;</div><div class="line">        for (int i = size-1; i &gt;= 0; i--)</div><div class="line">            if (elementData[i]==null)</div><div class="line">                return i;</div><div class="line">    &#125; else &#123;</div><div class="line">        for (int i = size-1; i &gt;= 0; i--)</div><div class="line">            if (o.equals(elementData[i]))</div><div class="line">                return i;</div><div class="line">    &#125;</div><div class="line">    return -1;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="clone-方法"><a href="#clone-方法" class="headerlink" title="clone()方法"></a>clone()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">// clone方法是Object类的方法，返回当前ArrayList的一个副本</div><div class="line">public Object clone() &#123;</div><div class="line">    try &#123;</div><div class="line">        // v为赋值的实例属性</div><div class="line">        ArrayList&lt;?&gt; v = (ArrayList&lt;?&gt;) super.clone();</div><div class="line">        //数据和modCount赋值</div><div class="line">        v.elementData = Arrays.copyOf(elementData, size);</div><div class="line">        v.modCount = 0;</div><div class="line">        return v;</div><div class="line">    &#125; catch (CloneNotSupportedException e) &#123;</div><div class="line">        // this shouldn&apos;t happen, since we are Cloneable</div><div class="line">        throw new InternalError(e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="toArray-方法"><a href="#toArray-方法" class="headerlink" title="toArray()方法"></a>toArray()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//返回一个Object数组，直接调用Arrays中的copyof方法</div><div class="line">public Object[] toArray() &#123;</div><div class="line">    return Arrays.copyOf(elementData, size);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="toArray-T-a-方法"><a href="#toArray-T-a-方法" class="headerlink" title="toArray(T[] a)方法"></a>toArray(T[] a)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 将ArrayList中的元素赋值到一个数组中去</div><div class="line">@SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">public &lt;T&gt; T[] toArray(T[] a) &#123;</div><div class="line">    if (a.length &lt; size)</div><div class="line">        // 如果a的长度小于ArrayList的长度，返回一个包含ArrayList所有元素的数组</div><div class="line">        return (T[]) Arrays.copyOf(elementData, size, a.getClass());</div><div class="line">    // 将ArrayList额elementData数组复制到a数组，然后将a数组的size位置赋值为空。</div><div class="line">    System.arraycopy(elementData, 0, a, 0, size);</div><div class="line">    if (a.length &gt; size)</div><div class="line">        a[size] = null;</div><div class="line">    return a;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="get-int-index-方法"><a href="#get-int-index-方法" class="headerlink" title="get(int index)方法"></a>get(int index)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// 获取指定下标的元素并返回，可以看出get方法其实就是两个方法的封装</div><div class="line">public E get(int index) &#123;</div><div class="line">    rangeCheck(index);</div><div class="line"></div><div class="line">    return elementData(index);</div><div class="line">&#125;</div><div class="line"></div><div class="line"> // 检查index是否超出了ArrayList的size。</div><div class="line">private void rangeCheck(int index) &#123;</div><div class="line">    if (index &gt;= size)</div><div class="line">        throw new IndexOutOfBoundsException(outOfBoundsMsg(index));</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 从elementData中返回index位置的元素。</div><div class="line">@SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">E elementData(int index) &#123;</div><div class="line">    return (E) elementData[index];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="set-int-index-E-element-方法"><a href="#set-int-index-E-element-方法" class="headerlink" title="set(int index, E element)方法"></a>set(int index, E element)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 将指定index下的元素设置为element，并返回旧的值。</div><div class="line">public E set(int index, E element) &#123;</div><div class="line">    // index的范围检验</div><div class="line">    rangeCheck(index);</div><div class="line">    // 获取旧的值</div><div class="line">    E oldValue = elementData(index);</div><div class="line">    // 更新elementData中的值</div><div class="line">    elementData[index] = element;</div><div class="line">    return oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="add-E-e-方法"><a href="#add-E-e-方法" class="headerlink" title="add(E e)方法"></a>add(E e)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 将元素e添加到ArrayList的末尾</div><div class="line">public boolean add(E e) &#123;</div><div class="line">    // 校验size+1是否超过了ArrayList的大小</div><div class="line">    ensureCapacityInternal(size + 1);  // Increments modCount!!</div><div class="line">    // 在elementData中赋值</div><div class="line">    elementData[size++] = e;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>add之前，首先需要检查是否存在数组越界的问题，这个由ensureCapacityInternal来确保，如果发生了越界则进行扩容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">// 验证minCapacity是否需要扩容</div><div class="line">private void ensureCapacityInternal(int minCapacity) &#123;</div><div class="line">    // elementData为默认的空值时，也就是第一次插入元素，最小容量为两者的较大值</div><div class="line">    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) &#123;</div><div class="line">        minCapacity = Math.max(DEFAULT_CAPACITY, minCapacity);</div><div class="line">    &#125;</div><div class="line">    // 验证是否需要对elementData进行扩容</div><div class="line">    ensureExplicitCapacity(minCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private void ensureExplicitCapacity(int minCapacity) &#123;</div><div class="line">    modCount++;</div><div class="line"></div><div class="line">    // 需要进行扩容，调用grow方法进行扩容</div><div class="line">    if (minCapacity - elementData.length &gt; 0)</div><div class="line">        grow(minCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// elementData的最大值</div><div class="line">private static final int MAX_ARRAY_SIZE = Integer.MAX_VALUE - 8;</div><div class="line"></div><div class="line">// 进行必要的扩容操作，确保elementData可以存放所有的元素</div><div class="line">private void grow(int minCapacity) &#123;</div><div class="line">    // overflow-conscious code</div><div class="line">    int oldCapacity = elementData.length;</div><div class="line">    // 新的容量为原来容量的1.5倍</div><div class="line">    int newCapacity = oldCapacity + (oldCapacity &gt;&gt; 1);</div><div class="line">    // 不够的话，直接将需要的元素数设置为数组长度</div><div class="line">    if (newCapacity - minCapacity &lt; 0)</div><div class="line">        newCapacity = minCapacity;</div><div class="line">    if (newCapacity - MAX_ARRAY_SIZE &gt; 0)</div><div class="line">        newCapacity = hugeCapacity(minCapacity);</div><div class="line">    // 将原来的数组元素复制到新的数组中</div><div class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private static int hugeCapacity(int minCapacity) &#123;</div><div class="line">    if (minCapacity &lt; 0) // overflow</div><div class="line">        throw new OutOfMemoryError();</div><div class="line">    return (minCapacity &gt; MAX_ARRAY_SIZE) ?</div><div class="line">        Integer.MAX_VALUE :</div><div class="line">        MAX_ARRAY_SIZE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="add-int-index-E-element-方法"><a href="#add-int-index-E-element-方法" class="headerlink" title="add(int index, E element)方法"></a>add(int index, E element)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 在指定位置index处添加指定元素element</div><div class="line">public void add(int index, E element) &#123;</div><div class="line">    // 检查index是否小于elementData的长度</div><div class="line">    rangeCheckForAdd(index);</div><div class="line">    // 检查elementData中添加一个元素是否需要扩容</div><div class="line">    ensureCapacityInternal(size + 1);  // Increments modCount!!</div><div class="line">    // 将elementData数组index位置之后的元素向后移动，在index位置添加element，size++</div><div class="line">    System.arraycopy(elementData, index, elementData, index + 1,</div><div class="line">                     size - index);</div><div class="line">    elementData[index] = element;</div><div class="line">    size++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="remove-int-index-方法"><a href="#remove-int-index-方法" class="headerlink" title="remove(int index)方法"></a>remove(int index)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// 移除指定index位置的元素并返回该元素</div><div class="line">public E remove(int index) &#123;</div><div class="line">    // 检查index是否小于elementData长度</div><div class="line">    rangeCheck(index);</div><div class="line"></div><div class="line">    modCount++;</div><div class="line">    // 旧值</div><div class="line">    E oldValue = elementData(index);</div><div class="line"></div><div class="line">    int numMoved = size - index - 1;</div><div class="line">    if (numMoved &gt; 0)</div><div class="line">        // 将index位置的元素顺次向前移动一位</div><div class="line">        System.arraycopy(elementData, index+1, elementData, index,</div><div class="line">                         numMoved);</div><div class="line">    elementData[--size] = null; // clear to let GC do its work</div><div class="line">    // 返回旧值</div><div class="line">    return oldValue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="remove-Object-o-方法"><a href="#remove-Object-o-方法" class="headerlink" title="remove(Object o)方法"></a>remove(Object o)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">// 从ArrayList中删除从0开始第一个遇到的o元素，成功返回true，失败返回false</div><div class="line">public boolean remove(Object o) &#123;</div><div class="line">    if (o == null) &#123;</div><div class="line">        for (int index = 0; index &lt; size; index++)</div><div class="line">            if (elementData[index] == null) &#123;</div><div class="line">                fastRemove(index);</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        for (int index = 0; index &lt; size; index++)</div><div class="line">            // 找到o的下标</div><div class="line">            if (o.equals(elementData[index])) &#123;</div><div class="line">                // 移除元素index</div><div class="line">                fastRemove(index);</div><div class="line">                return true;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 快速移除index下标处的元素</div><div class="line">private void fastRemove(int index) &#123;</div><div class="line">    modCount++;</div><div class="line">    int numMoved = size - index - 1;</div><div class="line">    if (numMoved &gt; 0)</div><div class="line">        // 将index位置的元素顺次向前移动一位</div><div class="line">        System.arraycopy(elementData, index+1, elementData, index,</div><div class="line">                         numMoved);</div><div class="line">    elementData[--size] = null; // clear to let GC do its work</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="clear-方法"><a href="#clear-方法" class="headerlink" title="clear()方法"></a>clear()方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 从ArrayList中移除所有元素</div><div class="line">public void clear() &#123;</div><div class="line">    modCount++;</div><div class="line"></div><div class="line">    // 将elementData中所有元素设置为空</div><div class="line">    for (int i = 0; i &lt; size; i++)</div><div class="line">        elementData[i] = null;</div><div class="line"></div><div class="line">    size = 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="addAll-Collection-lt-extends-E-gt-c-方法"><a href="#addAll-Collection-lt-extends-E-gt-c-方法" class="headerlink" title="addAll(Collection&lt;? extends E&gt; c)方法"></a>addAll(Collection&lt;? extends E&gt; c)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 将指定集合c中的所有元素都添加到列表尾部，成功返回true，失败返回false</div><div class="line">public boolean addAll(Collection&lt;? extends E&gt; c) &#123;</div><div class="line">    // 将集合c转换成数组a存储</div><div class="line">    Object[] a = c.toArray();</div><div class="line">    int numNew = a.length;</div><div class="line">    // 扩容检查</div><div class="line">    ensureCapacityInternal(size + numNew);  // Increments modCount</div><div class="line">    // 将数组a添加到elementData数组之后</div><div class="line">    System.arraycopy(a, 0, elementData, size, numNew);</div><div class="line">    size += numNew;</div><div class="line">    return numNew != 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="addAll-int-index-Collection-lt-extends-E-gt-c-方法"><a href="#addAll-int-index-Collection-lt-extends-E-gt-c-方法" class="headerlink" title="addAll(int index, Collection&lt;? extends E&gt; c)方法"></a>addAll(int index, Collection&lt;? extends E&gt; c)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">// 将指定集合c中的所有元素都添加到列表指定位置index只有，成功返回true，失败返回false</div><div class="line">public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123;</div><div class="line">    // index合法性检查</div><div class="line">    rangeCheckForAdd(index);</div><div class="line"></div><div class="line">    Object[] a = c.toArray();</div><div class="line">    int numNew = a.length;</div><div class="line">    // 扩容检查</div><div class="line">    ensureCapacityInternal(size + numNew);  // Increments modCount</div><div class="line">    // 原数组需要移动的数量</div><div class="line">    int numMoved = size - index;</div><div class="line">    if (numMoved &gt; 0)</div><div class="line">        // 将原数组index位置之后的元素，后移newNum个位置</div><div class="line">        System.arraycopy(elementData, index, elementData, index + numNew,</div><div class="line">                         numMoved);</div><div class="line">    // 将数组a复制到index位置之后的空间</div><div class="line">    System.arraycopy(a, 0, elementData, index, numNew);</div><div class="line">    // size更新</div><div class="line">    size += numNew;</div><div class="line">    return numNew != 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="removeAll-Collection-lt-gt-c"><a href="#removeAll-Collection-lt-gt-c" class="headerlink" title="removeAll(Collection&lt;?&gt; c)"></a>removeAll(Collection&lt;?&gt; c)</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">// 从ArrayList中移除集合c中的所有元素</div><div class="line">public boolean removeAll(Collection&lt;?&gt; c) &#123;</div><div class="line">    Objects.requireNonNull(c);</div><div class="line">    return batchRemove(c, false);</div><div class="line">&#125;</div><div class="line"></div><div class="line">private boolean batchRemove(Collection&lt;?&gt; c, boolean complement) &#123;</div><div class="line">    final Object[] elementData = this.elementData;</div><div class="line">    int r = 0, w = 0;</div><div class="line">    boolean modified = false;</div><div class="line">    try &#123;</div><div class="line">        for (; r &lt; size; r++)</div><div class="line">            // 将ArrayList和c的交集元素保存或者丢弃，到局部变量elementData，最后一个下标为w</div><div class="line">            if (c.contains(elementData[r]) == complement)</div><div class="line">                elementData[w++] = elementData[r];</div><div class="line">    &#125; finally &#123;</div><div class="line">        // 出现异常，没有完全遍历完</div><div class="line">        if (r != size) &#123;</div><div class="line">            // 将r右边的元素直接复制到w右边</div><div class="line">            System.arraycopy(elementData, r,</div><div class="line">                             elementData, w,</div><div class="line">                             size - r);</div><div class="line">            w += size - r;</div><div class="line">        &#125;</div><div class="line">        if (w != size) &#123;</div><div class="line">            // 将w下标之后的元素设置为null</div><div class="line">            for (int i = w; i &lt; size; i++)</div><div class="line">                elementData[i] = null;</div><div class="line">            modCount += size - w;</div><div class="line">            size = w;</div><div class="line">            modified = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return modified;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="retainAll-Collection-lt-gt-c-方法"><a href="#retainAll-Collection-lt-gt-c-方法" class="headerlink" title="retainAll(Collection&lt;?&gt; c) 方法"></a>retainAll(Collection&lt;?&gt; c) 方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// 取并集</div><div class="line">public boolean retainAll(Collection&lt;?&gt; c) &#123;</div><div class="line">    // 非空检查</div><div class="line">    Objects.requireNonNull(c);</div><div class="line">    // 返回差集</div><div class="line">    return batchRemove(c, true);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="序列化与反序列化"><a href="#序列化与反序列化" class="headerlink" title="序列化与反序列化"></a>序列化与反序列化</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">// 序列化方法，将列表状态写入数据流中</div><div class="line">private void writeObject(java.io.ObjectOutputStream s)</div><div class="line">    throws java.io.IOException&#123;</div><div class="line">    // Write out element count, and any hidden stuff</div><div class="line">    int expectedModCount = modCount;</div><div class="line">    s.defaultWriteObject();</div><div class="line"></div><div class="line">    // Write out size as capacity for behavioural compatibility with clone()</div><div class="line">    s.writeInt(size);</div><div class="line"></div><div class="line">    // Write out all elements in the proper order.</div><div class="line">    for (int i=0; i&lt;size; i++) &#123;</div><div class="line">        s.writeObject(elementData[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (modCount != expectedModCount) &#123;</div><div class="line">        throw new ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 反序列化方法</div><div class="line">private void readObject(java.io.ObjectInputStream s)</div><div class="line">    throws java.io.IOException, ClassNotFoundException &#123;</div><div class="line">    elementData = EMPTY_ELEMENTDATA;</div><div class="line"></div><div class="line">    // Read in size, and any hidden stuff</div><div class="line">    s.defaultReadObject();</div><div class="line"></div><div class="line">    // Read in capacity</div><div class="line">    s.readInt(); // ignored</div><div class="line"></div><div class="line">    if (size &gt; 0) &#123;</div><div class="line">        // be like clone(), allocate array based upon size not capacity</div><div class="line">        ensureCapacityInternal(size);</div><div class="line"></div><div class="line">        Object[] a = elementData;</div><div class="line">        // Read in all elements in the proper order.</div><div class="line">        for (int i=0; i&lt;size; i++) &#123;</div><div class="line">            a[i] = s.readObject();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="listIterator-int-index-方法"><a href="#listIterator-int-index-方法" class="headerlink" title="listIterator(int index)方法"></a>listIterator(int index)方法</h1><p>这部分内容没有仔细去看，暂不注解，后面会进行完善。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line">// 获取列表指定位置的迭代器对象</div><div class="line">public ListIterator&lt;E&gt; listIterator(int index) &#123;</div><div class="line">    if (index &lt; 0 || index &gt; size)</div><div class="line">        throw new IndexOutOfBoundsException(&quot;Index: &quot;+index);</div><div class="line">    return new ListItr(index);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 获取list开头的迭代器对象</div><div class="line">public ListIterator&lt;E&gt; listIterator() &#123;</div><div class="line">    return new ListItr(0);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Itr 内部类</div><div class="line">private class Itr implements Iterator&lt;E&gt; &#123;</div><div class="line">    int cursor;       // index of next element to return</div><div class="line">    int lastRet = -1; // index of last element returned; -1 if no such</div><div class="line">    int expectedModCount = modCount;</div><div class="line"></div><div class="line">    public boolean hasNext() &#123;</div><div class="line">        return cursor != size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public E next() &#123;</div><div class="line">        checkForComodification();</div><div class="line">        int i = cursor;</div><div class="line">        if (i &gt;= size)</div><div class="line">            throw new NoSuchElementException();</div><div class="line">        Object[] elementData = ArrayList.this.elementData;</div><div class="line">        if (i &gt;= elementData.length)</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        cursor = i + 1;</div><div class="line">        return (E) elementData[lastRet = i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void remove() &#123;</div><div class="line">        if (lastRet &lt; 0)</div><div class="line">            throw new IllegalStateException();</div><div class="line">        checkForComodification();</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            ArrayList.this.remove(lastRet);</div><div class="line">            cursor = lastRet;</div><div class="line">            lastRet = -1;</div><div class="line">            expectedModCount = modCount;</div><div class="line">        &#125; catch (IndexOutOfBoundsException ex) &#123;</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public void forEachRemaining(Consumer&lt;? super E&gt; consumer) &#123;</div><div class="line">        Objects.requireNonNull(consumer);</div><div class="line">        final int size = ArrayList.this.size;</div><div class="line">        int i = cursor;</div><div class="line">        if (i &gt;= size) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        final Object[] elementData = ArrayList.this.elementData;</div><div class="line">        if (i &gt;= elementData.length) &#123;</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        &#125;</div><div class="line">        while (i != size &amp;&amp; modCount == expectedModCount) &#123;</div><div class="line">            consumer.accept((E) elementData[i++]);</div><div class="line">        &#125;</div><div class="line">        // update once at end of iteration to reduce heap write traffic</div><div class="line">        cursor = i;</div><div class="line">        lastRet = i - 1;</div><div class="line">        checkForComodification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    final void checkForComodification() &#123;</div><div class="line">        if (modCount != expectedModCount)</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// ListItr内部类</div><div class="line">private class ListItr extends Itr implements ListIterator&lt;E&gt; &#123;</div><div class="line">    // 构造方法</div><div class="line">    ListItr(int index) &#123;</div><div class="line">        super();</div><div class="line">        cursor = index;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 是否有上一个迭代对象</div><div class="line">    public boolean hasPrevious() &#123;</div><div class="line">        return cursor != 0;</div><div class="line">    &#125;</div><div class="line">    // 获取当前迭代对象的下标</div><div class="line">    public int nextIndex() &#123;</div><div class="line">        return cursor;</div><div class="line">    &#125;</div><div class="line">    // 获取上一个迭代对象的下标</div><div class="line">    public int previousIndex() &#123;</div><div class="line">        return cursor - 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    public E previous() &#123;</div><div class="line">        checkForComodification();</div><div class="line">        int i = cursor - 1;</div><div class="line">        if (i &lt; 0)</div><div class="line">            throw new NoSuchElementException();</div><div class="line">        Object[] elementData = ArrayList.this.elementData;</div><div class="line">        if (i &gt;= elementData.length)</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        cursor = i;</div><div class="line">        return (E) elementData[lastRet = i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void set(E e) &#123;</div><div class="line">        if (lastRet &lt; 0)</div><div class="line">            throw new IllegalStateException();</div><div class="line">        checkForComodification();</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            ArrayList.this.set(lastRet, e);</div><div class="line">        &#125; catch (IndexOutOfBoundsException ex) &#123;</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void add(E e) &#123;</div><div class="line">        checkForComodification();</div><div class="line"></div><div class="line">        try &#123;</div><div class="line">            int i = cursor;</div><div class="line">            ArrayList.this.add(i, e);</div><div class="line">            cursor = i + 1;</div><div class="line">            lastRet = -1;</div><div class="line">            expectedModCount = modCount;</div><div class="line">        &#125; catch (IndexOutOfBoundsException ex) &#123;</div><div class="line">            throw new ConcurrentModificationException();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="subList-int-fromIndex-int-toIndex-方法"><a href="#subList-int-fromIndex-int-toIndex-方法" class="headerlink" title="subList(int fromIndex, int toIndex)方法"></a>subList(int fromIndex, int toIndex)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">// 从列表中取出指定位置的子列表</div><div class="line">public List&lt;E&gt; subList(int fromIndex, int toIndex) &#123;</div><div class="line">    // 起点和终点的下标检查</div><div class="line">    subListRangeCheck(fromIndex, toIndex, size);</div><div class="line">    // 调用SubList内部类来实现字列表的实现</div><div class="line">    return new SubList(this, 0, fromIndex, toIndex);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 起点和终点的下标检查</div><div class="line">static void subListRangeCheck(int fromIndex, int toIndex, int size) &#123;</div><div class="line">    if (fromIndex &lt; 0)</div><div class="line">        throw new IndexOutOfBoundsException(&quot;fromIndex = &quot; + fromIndex);</div><div class="line">    if (toIndex &gt; size)</div><div class="line">        throw new IndexOutOfBoundsException(&quot;toIndex = &quot; + toIndex);</div><div class="line">    if (fromIndex &gt; toIndex)</div><div class="line">        throw new IllegalArgumentException(&quot;fromIndex(&quot; + fromIndex +</div><div class="line">                                           &quot;) &gt; toIndex(&quot; + toIndex + &quot;)&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// SubList内部类，对ArrayList数组直接进行增删改查，只是为其限定了边界</div><div class="line">private class SubList extends AbstractList&lt;E&gt; implements RandomAccess &#123;</div><div class="line">    private final AbstractList&lt;E&gt; parent;</div><div class="line">    private final int parentOffset;</div><div class="line">    private final int offset;</div><div class="line">    int size;</div><div class="line">    // 构造方法，父列表，偏移量，fromIndex，toIndex</div><div class="line">    SubList(AbstractList&lt;E&gt; parent,</div><div class="line">            int offset, int fromIndex, int toIndex) &#123;</div><div class="line">        this.parent = parent;</div><div class="line">        this.parentOffset = fromIndex;</div><div class="line">        this.offset = offset + fromIndex;</div><div class="line">        this.size = toIndex - fromIndex;</div><div class="line">        this.modCount = ArrayList.this.modCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public E set(int index, E e) &#123;</div><div class="line">        rangeCheck(index);</div><div class="line">        checkForComodification();</div><div class="line">        E oldValue = ArrayList.this.elementData(offset + index);</div><div class="line">        ArrayList.this.elementData[offset + index] = e;</div><div class="line">        return oldValue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public E get(int index) &#123;</div><div class="line">        rangeCheck(index);</div><div class="line">        checkForComodification();</div><div class="line">        return ArrayList.this.elementData(offset + index);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int size() &#123;</div><div class="line">        checkForComodification();</div><div class="line">        return this.size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void add(int index, E e) &#123;</div><div class="line">        rangeCheckForAdd(index);</div><div class="line">        checkForComodification();</div><div class="line">        parent.add(parentOffset + index, e);</div><div class="line">        this.modCount = parent.modCount;</div><div class="line">        this.size++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public E remove(int index) &#123;</div><div class="line">        rangeCheck(index);</div><div class="line">        checkForComodification();</div><div class="line">        E result = parent.remove(parentOffset + index);</div><div class="line">        this.modCount = parent.modCount;</div><div class="line">        this.size--;</div><div class="line">        return result;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    protected void removeRange(int fromIndex, int toIndex) &#123;</div><div class="line">        checkForComodification();</div><div class="line">        parent.removeRange(parentOffset + fromIndex,</div><div class="line">                           parentOffset + toIndex);</div><div class="line">        this.modCount = parent.modCount;</div><div class="line">        this.size -= toIndex - fromIndex;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean addAll(Collection&lt;? extends E&gt; c) &#123;</div><div class="line">        return addAll(this.size, c);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public boolean addAll(int index, Collection&lt;? extends E&gt; c) &#123;</div><div class="line">        rangeCheckForAdd(index);</div><div class="line">        int cSize = c.size();</div><div class="line">        if (cSize==0)</div><div class="line">            return false;</div><div class="line"></div><div class="line">        checkForComodification();</div><div class="line">        parent.addAll(parentOffset + index, c);</div><div class="line">        this.modCount = parent.modCount;</div><div class="line">        this.size += cSize;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="forEach-Consumer-lt-super-E-gt-action-方法"><a href="#forEach-Consumer-lt-super-E-gt-action-方法" class="headerlink" title="forEach(Consumer&lt;? super E&gt; action)方法"></a>forEach(Consumer&lt;? super E&gt; action)方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// Collection方法中的增强型for循环</div><div class="line">@Override</div><div class="line">public void forEach(Consumer&lt;? super E&gt; action) &#123;</div><div class="line">    Objects.requireNonNull(action);</div><div class="line">    final int expectedModCount = modCount;</div><div class="line">    @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">    final E[] elementData = (E[]) this.elementData;</div><div class="line">    final int size = this.size;</div><div class="line">    for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123;</div><div class="line">        action.accept(elementData[i]);</div><div class="line">    &#125;</div><div class="line">    if (modCount != expectedModCount) &#123;</div><div class="line">        throw new ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Sort方法"><a href="#Sort方法" class="headerlink" title="Sort方法"></a>Sort方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// 传入比较器，对ArrayList进行排序</div><div class="line">@Override</div><div class="line">@SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">public void sort(Comparator&lt;? super E&gt; c) &#123;</div><div class="line">    final int expectedModCount = modCount;</div><div class="line">    Arrays.sort((E[]) elementData, 0, size, c);</div><div class="line">    if (modCount != expectedModCount) &#123;</div><div class="line">        throw new ConcurrentModificationException();</div><div class="line">    &#125;</div><div class="line">    modCount++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/Java虚拟机_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/Java虚拟机_2/" itemprop="url">垃圾收集器和内存分配策略</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/JVM/" itemprop="url" rel="index">
                    <span itemprop="name">JVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h1><ul>
<li><p>垃圾收集器的历史要远早于Java，不过我们很多人都是通过Java才了解垃圾收集器的。学习垃圾收集器可以更好进行内存泄漏，内存溢出的排查，以及高并发场景下垃圾收集成为系统性能瓶颈。</p>
</li>
<li><p>垃圾收集器关注的问题很简单：</p>
<pre><code>哪些垃圾需要回收？--who
什么时候回收？-- when
怎么回收？--how
</code></pre></li>
<li><p>程序计数器，虚拟机栈，本地方法栈是线程私有的，也就是和线程的生命周期一致，栈帧随着方法的执行进行进栈和出栈操作，内存分配和回收具有确定性，不需要考虑垃圾回收问题。方法区和Java堆则需要在运行时才确定需要的内存大小，从而需要我们动态的分配内存和垃圾收集。</p>
</li>
</ul>
<h2 id="那些垃圾需要回收？-who"><a href="#那些垃圾需要回收？-who" class="headerlink" title="那些垃圾需要回收？-who"></a>那些垃圾需要回收？-who</h2><p>已经“死掉”的对象需要回收，对象死掉的概念是指没有引用他的对象了。</p>
<ol>
<li><p>引用计数法：给对象中添加一个引用计数器，当有一个地方引用他时，计数器+1，当引用失效时，计数器-1，当计数器为0时，对象死掉。java中并没有采用这种机制。</p>
<ul>
<li>优点：实现简单，判定效率高</li>
<li><p>缺点：循环引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class ReferenceCountingGC &#123;</div><div class="line"></div><div class="line">	public Object instance = null;</div><div class="line"></div><div class="line">	private static final int _1MB = 1024 * 1024;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 这个成员属性的唯一意义就是占点内存，以便在能在GC日志中看清楚是否有回收过</div><div class="line">	 */</div><div class="line">	private byte[] bigSize = new byte[2 * _1MB];</div><div class="line"></div><div class="line">	public static void testGC() &#123;</div><div class="line">		ReferenceCountingGC objA = new ReferenceCountingGC();</div><div class="line">		ReferenceCountingGC objB = new ReferenceCountingGC();</div><div class="line">		objA.instance = objB;</div><div class="line">		objB.instance = objA;</div><div class="line"></div><div class="line">		objA = null;</div><div class="line">		objB = null;</div><div class="line"></div><div class="line">		// 假设在这行发生GC，objA和objB是否能被回收？</div><div class="line">		System.gc();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">0.137: [GC (System.gc()) [PSYoungGen: 9344K-&gt;808K(76288K)] 9344K-&gt;816K(251392K), 0.0029826 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</div><div class="line">0.140: [Full GC (System.gc()) [PSYoungGen: 808K-&gt;0K(76288K)] [ParOldGen: 8K-&gt;662K(175104K)] 816K-&gt;662K(251392K), [Metaspace: 3464K-&gt;3464K(1056768K)], 0.0046314 secs] [Times: user=0.03 sys=0.00, real=0.02 secs]</div><div class="line">Heap</div><div class="line"> PSYoungGen      total 76288K, used 655K [0x000000076b380000, 0x0000000770880000, 0x00000007c0000000)</div><div class="line">  eden space 65536K, 1% used [0x000000076b380000,0x000000076b423ee8,0x000000076f380000)</div><div class="line">  from space 10752K, 0% used [0x000000076f380000,0x000000076f380000,0x000000076fe00000)</div><div class="line">  to   space 10752K, 0% used [0x000000076fe00000,0x000000076fe00000,0x0000000770880000)</div><div class="line"> ParOldGen       total 175104K, used 662K [0x00000006c1a00000, 0x00000006cc500000, 0x000000076b380000)</div><div class="line">  object space 175104K, 0% used [0x00000006c1a00000,0x00000006c1aa5b78,0x00000006cc500000)</div><div class="line"> Metaspace       used 3470K, capacity 4496K, committed 4864K, reserved 1056768K</div><div class="line">  class space    used 381K, capacity 388K, committed 512K, reserved 1048576K</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>可达性分析算法：起始点为GC Root Set中的GC Roots对象，由GC Root向下的路径成为引用链，当一个对象和GC Roots没有引用链连接时，此对象死掉。</p>
<p><img src="/img/jvm-3.png" alt="Alt text"></p>
<p>Java中可以作为GC Roots的对象包括：</p>
<ul>
<li>虚拟机栈(栈帧中的本地变量表)中引用的对象</li>
<li>方法区中静态属性引用的对象</li>
<li>方法区中常亮引用的对象</li>
<li>本地方法栈中JNI（Native方法）引用的对象</li>
</ul>
</li>
<li><p>引用的类型</p>
</li>
</ol>
<p>Java1.2之前，reference类型的数据中存储的数值代表的是一个内存的起始地址，则称为一个引用。对象只存在被引用和不被引用两种状态。</p>
<ul>
<li>强引用：程序代码中普遍存在的</li>
<li>软引用：描述一些还有用但不是必须的对象，系统内存溢出前会对其进行二次垃圾回收</li>
<li>弱引用：描述非必须的对象，垃圾回收时直接回收</li>
<li>虚引用：不影响其生存，回收时可以收到一个系统通知</li>
</ul>
<ol>
<li><p>对象死亡的过程</p>
<ol>
<li>可达性分析后，对没有和GC Roots相连接的引用链的对象会被标记一次，同时对其进行一次筛选，筛选条件为此对象是否有必要执行finalize()方法，当对象没有重写finalize()方法或者finalize()方法被虚拟机调用过，则不执行finalize()方法。</li>
<li><p>有必要执行finalize()方法的对象会被放到F-Queue对象中，等待虚拟机的Finalizer线程去执行finalize()方法，GC会对F-Queue对象进行小范围标记，如果对象在finalize()方法中和引用链连接上，则会被移出队列，否则被真正回收。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 对象可以在被GC时自我拯救</div><div class="line"> * 这种自救机会只有一次，因为一个对象的finalize()方法最多只会被系统调用一遍</div><div class="line"> */</div><div class="line">public class FinalizeEscapeGC &#123;</div><div class="line">    public static FinalizeEscapeGC SAVE_HOOK = null;</div><div class="line"></div><div class="line">    public void isAlive() &#123;</div><div class="line">        System.out.println(&quot; I am alive !&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected void finalize() throws Throwable &#123;</div><div class="line">        super.finalize();</div><div class="line">        System.out.println(&quot;finalize method executed!&quot;);</div><div class="line">        FinalizeEscapeGC.SAVE_HOOK = this;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) throws InterruptedException &#123;</div><div class="line">        SAVE_HOOK = new FinalizeEscapeGC();</div><div class="line">        //对象第一次拯救自己</div><div class="line">        SAVE_HOOK = null;</div><div class="line">        System.gc();</div><div class="line">        //finalize()优先级很低，暂停0.5s等待</div><div class="line">        Thread.sleep(500);</div><div class="line">        if (SAVE_HOOK != null)</div><div class="line">            SAVE_HOOK.isAlive();</div><div class="line">        else</div><div class="line">            System.out.println(&quot;no, I am dead!&quot;);</div><div class="line">        //第二次自救失败</div><div class="line">        SAVE_HOOK = null;</div><div class="line">        System.gc();</div><div class="line">        //finalize()优先级很低，暂停0.5s等待</div><div class="line">        Thread.sleep(500);</div><div class="line">        if (SAVE_HOOK != null)</div><div class="line">            SAVE_HOOK.isAlive();</div><div class="line">        else</div><div class="line">            System.out.println(&quot;no, I am dead!&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">finalize method executed!</div><div class="line"> I am alive !</div><div class="line">no, I am dead!</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>回收方法区</p>
</li>
</ol>
<p>虽然虚拟机规范中没有要求在方法区进行垃圾回收，但是方法区存在垃圾回收，回收效率很低。回收的内容为废弃常亮和无用的类。</p>
<ul>
<li>回收废弃常亮：看和GC Roots之间是否存在引用链</li>
<li>回收无用类：<ol>
<li>该类的所有实例都已经被回收</li>
<li>加载该类的ClassLoader已经被回收</li>
<li>该类对应的Java.lang.Class对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li>
</ol>
</li>
</ul>
<h2 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h2><ol>
<li><p>标记-清除算法(Mark-Sweep):首先标记所有需要回收的对象，标记完成后统一回收被标记对象。</p>
<ul>
<li><p>存在两个不足：</p>
<ol>
<li>效率问题：标记和清除两个过程的效率都不高</li>
<li>空间问题：标记清除之后会产生大量不连续的内存碎片，会导致存放大对象时没有足够的空间而提前出发垃圾清楚</li>
</ol>
<p><img src="/img/jvm-4.png" alt="Alt text"></p>
</li>
</ul>
</li>
</ol>
<ol>
<li><p>复制算法(Copint)：将内存分成一样的两块，每次只使用一块，当一块用完了就进行垃圾回收，并将还存活的对象复制到第二块硬盘上并整理顺序。每次回收针对的是一半内存空间，同时也没有了空间碎片的问题</p>
<p> <img src="/img/jvm-5.png" alt="Alt text"></p>
<ul>
<li>存在的问题是内存空间变为一半。实际上，新生的对象98%是朝生夕死的，所以不需要1:1来划分内存空间。而是将新生代内存化为一块Eden空间和两块Survivor空间，比例为8:1:1。</li>
<li>每次使用Eden空间和其中一块Survivor空间，回收时将Eden和Survivor空间中还存活的对象复制到另一块Survivor中，然后清除Eden和Survivor空间。</li>
<li>如果空间不够的话，需要老年代进行分配担保</li>
</ul>
</li>
<li><p>标记-整理算法(Mark-Compact)：标记过程和之前相同，整理过程将存活对象移动到一边，根据整理边界回收剩余空间内的对象，适用于老年代的垃圾收集</p>
<p> <img src="/img/jvm-6.png" alt="Alt text"></p>
</li>
<li><p>分代收集算法：将Java堆对象根据存货周期划分为新生代和老年代，新生代采用复制算法，老年代给新生代做分配担保，由于老年代的对象存活率高，所以老年代采用标记-整理或者标记-清除算法。</p>
</li>
</ol>
<h2 id="HotSpot的算法实现"><a href="#HotSpot的算法实现" class="headerlink" title="HotSpot的算法实现"></a>HotSpot的算法实现</h2><ol>
<li>枚举根节点：可作为根节点的主要在全局性的引用(常亮或者静态属性)与执行上下文(栈帧中的本地变量表)，可达性分析时需要停止一切的Java程序执行，Stop the world，在Oop中保存着对象引用的地址。</li>
<li>安全点：程序执行过程中并不是所有位置都可以停下来GC，让系统中的所有线程到安全点的方式有两种：<ul>
<li>抢先式中断：所有线程中断，如果有线程不在安全点上，则恢复线程，让其跑到安全点上再中断</li>
<li>主动式中断：设置一个标志，各个线程执行时去轮询这个标志，发现中断标志位真时就自己中断挂起，轮询标志的地方和安全点是重合的。</li>
</ul>
</li>
<li>安全区域：<ul>
<li>解决线程处于休眠状态无法响应JVM的中断请求的情况。</li>
<li>安全区域指在一段代码中，引用关系不会发生变化</li>
<li>线程执行Safe Region中的代码时，会标识自己已经进入Safe Region，可以随时进行GC，如果线程离开安全区域时，会先检查枚举根节点或者GC是否完成，未完成则需要等待。</li>
</ul>
</li>
</ol>
<h2 id="垃圾收集器-1"><a href="#垃圾收集器-1" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><p>Java虚拟机规范中对垃圾收集器如何实现并没有规定，因此诞生了多种多样的垃圾收集器，适合各自的应用场景。HotSpot虚拟机中的垃圾收集器包括对新生代回收的Serial，ParNew，Parallel Scavenge，对老年代回收的CMS，Serial Old(MSC), Parallel Old及G1。</p>
<ol>
<li><p>Serial收集器</p>
<ul>
<li>最基本，历史最悠久的单线程收集器</li>
<li>GC过程中必须停止整个程序的运行，Stop the World</li>
<li>优点:简单而高效，适用Client模式下工作的虚拟机</li>
</ul>
<p><img src="/img/jvm-7.png" alt="Alt text"></p>
</li>
<li><p>ParNew收集器</p>
<ul>
<li>Serial收集器的多线程版本</li>
<li>运行在Server模式的虚拟机中首选的新生代收集器—重要原因是，其是除了Serial外唯一能和CMS收集器配合工作。<br><img src="/img/jvm-8.png" alt="Alt text"></li>
</ul>
</li>
<li><p>Parallel Scavenge收集器</p>
<ul>
<li>新生代收集器，复制算法，并行的多线程收集器</li>
<li>收集器的关注点不是尽可能缩短垃圾收集时用户线程的停顿时间，而是尽可能达到一个可控制的吞吐量(吞吐量=运行代码时间/(运行代码时间+GC时间))</li>
<li>吞吐量优先收集器，</li>
<li>GC自适应调节策略<br><img src="/img/jvm-9.png" alt="Alt text"></li>
</ul>
</li>
<li><p>Serial Old收集器</p>
<ul>
<li>单线程</li>
<li>老年代</li>
<li>标记-整理（Mark-Compact）算法</li>
<li>适用Client模式的虚拟机，如果要用在Server模式下，有两个用途，一个是与Parallel Scavenge搭配适用，一个是作为CMS收集器的后备预案，在并发收集失败时使用。<br><img src="/img/jvm-7.png" alt="Alt text"></li>
</ul>
</li>
</ol>
<ol>
<li><p>Parallel Old收集器</p>
<ul>
<li>Parallel Scavenge老年代版本</li>
<li>多线程+标记-整理算法</li>
<li>在注重吞吐量和CPU资源敏感的场合，可以优先考虑和Parallel Scavenge搭配使用。<br><img src="/img/jvm-9.png" alt="Alt text"></li>
</ul>
</li>
<li><p>CMS收集器：Concurrent Mark Sweep</p>
<ul>
<li>以获取最短回收停顿时间为目标的收集器</li>
<li>标记-清除算法</li>
<li>运作过程：<ol>
<li>初始标记(CMS initial mark)     – stop the world, 标记GC Roots能直接关联到的对象，速度很快</li>
<li>并发标记(CMS concurrent mark)  – stop the world，进行GC Roots Tracing，</li>
<li>重新标记(CMS remark)，修正标记期间因为用户线程运行而改变的对象的标记记录，时间长于初始标记但短于并发标记</li>
<li>并发清除(CMS concurrent sweep)，清除标记的对象<br><img src="/img/jvm-10.png" alt="Alt text"></li>
</ol>
</li>
<li>缺点：<ul>
<li>CMS对CPU资源敏感，默认回收线程数是：（CPU数量+3）/4</li>
<li>CMS收集器无法处理浮动垃圾（Floating Garbage，并发清除阶段产生的垃圾,当前GC无法清除，需要下次GC才可以清除），会导致Concurrent Mode Failure而引发另一次Full GC。老年代需要保留足够的空间给用户线程使用，当CMS运行期间预留的内存空间不够时会发生Concurrent Mode Failure，这时候需要临时调用Serial Old来进行Full GC，停顿时间很长。</li>
<li>产生内存碎片问题，解决方法，CMS进行Full GC时，先进行碎片整理，或者进行若干次不整理的GC时，进行一次碎片整理的GC。</li>
</ul>
</li>
</ul>
</li>
<li><p>G1收集器：Garbage First</p>
<ul>
<li>并行与并发</li>
<li>分代收集</li>
<li>空间整合：marking-compact</li>
<li>可预测的停顿</li>
<li>G1将整个堆划分为很多Region，新生代和老年代都是由很多Region组成，G1后台维护一个列表，列表中记录了各个Region里面的垃圾价值大小（回收获得的空间和回收需要时间），GC时，优先回收价值最大的Region，保证G1在有限的时间内获得最高的回收效率。RememberSet避免全堆扫描。</li>
<li>运作过程：<ol>
<li>initial marking</li>
<li>concurrent marking</li>
<li>final marking</li>
<li>live data counting and evacuation<br><img src="/img/jvm-11.png" alt="Alt text"></li>
</ol>
</li>
</ul>
</li>
</ol>
<h1 id="内存分配与回收策略"><a href="#内存分配与回收策略" class="headerlink" title="内存分配与回收策略"></a>内存分配与回收策略</h1><ol>
<li>对象优先在Eden区生成</li>
<li>大对象直接进入老年代，如字符串和数组</li>
<li>长期存活的对象将进入老年代</li>
<li>动态对象年龄判定，如果Survivor中相同年龄所有对象大小的总和大于Survivor空间的一半，则大于或等于该年龄的对象将直接进入老年代。</li>
<li>空间分配担保：Minor GC之前检查老年代最大可用连续空间是否大于新生代所有对象总和或者大于新生代晋升老年代的历次平均大小，进行Minor GC,否则进行Full GC</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">104</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
