<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/5/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/算法/数据结构-两个栈实现一个队列以及两个队列实现一个栈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/算法/数据结构-两个栈实现一个队列以及两个队列实现一个栈/" itemprop="url">数据结构-两个栈实现一个队列和两个队列实现一个栈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据结构/" itemprop="url" rel="index">
                    <span itemprop="name">数据结构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="两个栈实现一个队列"><a href="#两个栈实现一个队列" class="headerlink" title="两个栈实现一个队列"></a>两个栈实现一个队列</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">import java.util.Stack;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/13</div><div class="line"> */</div><div class="line">public class TwoStackImpQueue &#123;</div><div class="line">    private Stack&lt;Integer&gt; stack1 = new Stack&lt;&gt;();</div><div class="line">    private Stack&lt;Integer&gt; stack2 = new Stack&lt;&gt;();</div><div class="line"></div><div class="line">    public void push(int node) &#123;</div><div class="line">        stack1.push(node);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Integer pop() &#123;</div><div class="line">        if (stack2.size() &lt;= 0) &#123;</div><div class="line">            while (stack1.size() &gt; 0) &#123;</div><div class="line">                stack2.push(stack1.pop());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (stack2.isEmpty()) &#123;</div><div class="line">            try &#123;</div><div class="line">                throw new Exception(&quot;queue is empty&quot;);</div><div class="line">            &#125; catch (Exception e)&#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return stack2.pop();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="两个队列实现一个栈"><a href="#两个队列实现一个栈" class="headerlink" title="两个队列实现一个栈"></a>两个队列实现一个栈</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/13</div><div class="line"> */</div><div class="line">public class TwoListImpStack &#123;</div><div class="line">    private Queue&lt;Integer&gt; list1 = new LinkedList&lt;&gt;();</div><div class="line">    private Queue&lt;Integer&gt; list2 = new LinkedList&lt;&gt;();</div><div class="line"></div><div class="line">    public void push(int node) &#123;</div><div class="line">        if (list1.isEmpty() &amp;&amp; list2.isEmpty())&#123;</div><div class="line">            list1.add(node);</div><div class="line">        &#125; else if (list1.isEmpty()) &#123;</div><div class="line">            list2.add(node);</div><div class="line">        &#125; else &#123;</div><div class="line">            list2.add(node);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Integer pop() &#123;</div><div class="line">        if (list1.isEmpty() &amp;&amp; list2.isEmpty())&#123;</div><div class="line">            try &#123;</div><div class="line">                throw new Exception(&quot;stack is Empty!&quot;);</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125; else if (list1.isEmpty()) &#123;</div><div class="line">            while (list2.size() &gt; 1) &#123;</div><div class="line">                list1.add(list2.poll());</div><div class="line">            &#125;</div><div class="line">            return list2.poll();</div><div class="line">        &#125; else &#123;</div><div class="line">            while (list1.size() &gt; 1) &#123;</div><div class="line">                list2.add(list1.poll());</div><div class="line">            &#125;</div><div class="line">            return list1.poll();</div><div class="line">        &#125;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/算法/算法之BFS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/算法/算法之BFS/" itemprop="url">算法-BFS</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">algorithms</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="完美平方数"><a href="#完美平方数" class="headerlink" title="完美平方数"></a>完美平方数</h1><p>DP解法和图论解法，掌握DP的为准，参考图论解法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">package leetcode.BFSGraphic;</div><div class="line"></div><div class="line">import java.util.HashMap;</div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class PerfectSquares_279 &#123;</div><div class="line">    public int numSquares(int n) &#123;</div><div class="line">        Queue&lt;Pair&gt; queue = new LinkedList&lt;&gt;();</div><div class="line">        queue.offer(new Pair(n, 0));</div><div class="line">        boolean[] visited = new boolean[n+1];</div><div class="line">        visited[n] = true;</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            Pair pair = queue.poll();</div><div class="line">            int num = pair.num;</div><div class="line">            int step = pair.step;</div><div class="line">            if (num == 0)</div><div class="line">                return step;</div><div class="line">            for (int i = 1; num - i * i &gt;= 0; i++) &#123;</div><div class="line">                if (!visited[num-i*i]) &#123;</div><div class="line">                    queue.offer(new Pair(num - i * i, step + 1));</div><div class="line">                    visited[num - i * i] = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return n;</div><div class="line">    &#125;</div><div class="line">    /**</div><div class="line">     * num:当前数</div><div class="line">     * step:n到num需要的步数</div><div class="line">     */</div><div class="line">    class Pair &#123;</div><div class="line">        int num;</div><div class="line">        int step;</div><div class="line">        public Pair(int num, int step) &#123;</div><div class="line">            this.num = num;</div><div class="line">            this.step = step;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="WordLadder"><a href="#WordLadder" class="headerlink" title="WordLadder"></a>WordLadder</h1><p>注释很清楚了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">package leetcode.BFSGraphic;</div><div class="line"></div><div class="line">import java.util.*;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class WordLadder_127 &#123;</div><div class="line">    /*</div><div class="line">        beginSet开始存放beginword，然后将经过一次变更字母之后可以编程的wordList中的字符串</div><div class="line">        放入beginSet，直到出现变换成最终的字符串。</div><div class="line">     */</div><div class="line">    public int ladderLength(String beginWord, String endWord, List&lt;String&gt; wordList) &#123;</div><div class="line">        Set&lt;String&gt; dict = new HashSet&lt;&gt;(wordList), qs = new HashSet&lt;&gt;(), qe = new HashSet&lt;&gt;(), vis = new HashSet&lt;&gt;();</div><div class="line">        qs.add(beginWord);</div><div class="line">        if (dict.contains(endWord))</div><div class="line">            qe.add(endWord); // all transformed words must be in dict (including endWord)</div><div class="line">        for (int len = 2; !qs.isEmpty(); len++) &#123;</div><div class="line">            Set&lt;String&gt; nq = new HashSet&lt;&gt;();</div><div class="line">            for (String w : qs) &#123;</div><div class="line">                for (int j = 0; j &lt; w.length(); j++) &#123;</div><div class="line">                    char[] ch = w.toCharArray();</div><div class="line">                    for (char c = &apos;a&apos;; c &lt;= &apos;z&apos;; c++) &#123;</div><div class="line">                        if (c == w.charAt(j))</div><div class="line">                            continue; // beginWord and endWord not the same, so bypass itself</div><div class="line">                        ch[j] = c;</div><div class="line">                        String nb = String.valueOf(ch);</div><div class="line">                        if (qe.contains(nb))</div><div class="line">                            return len; // meet from two ends</div><div class="line">                        if (dict.contains(nb) &amp;&amp; vis.add(nb))</div><div class="line">                            nq.add(nb); // not meet yet, vis is safe to use</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            qs = (nq.size() &lt; qe.size()) ? nq : qe; // switch to small one to traverse from other end</div><div class="line">            qe = (qs == nq) ? qe : nq;</div><div class="line">        &#125;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/多线程并发编程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/多线程并发编程/" itemprop="url">多线程并发编程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/concurrent-programming/" itemprop="url" rel="index">
                    <span itemprop="name">concurrent programming</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="并发基础知识与核心知识"><a href="#并发基础知识与核心知识" class="headerlink" title="并发基础知识与核心知识"></a>并发基础知识与核心知识</h1><h2 id="并发与高并发"><a href="#并发与高并发" class="headerlink" title="并发与高并发"></a>并发与高并发</h2><ul>
<li>并发：同时拥有两个或者多个线程，如果程序在单核处理器上运行，多个线程将交替的换入或者换出内存，这些线程是同时存在的，每个线程处于执行过程中的某个状态，如果运行在多核处理器上，此时程序中的每个线程将被分到一个处理器核上，因此可以同时运行。</li>
<li>高并发：high concurrency是互联网分布式系统架构设计中必须考虑的因素之一，它通常是指通过设计保证系统能够同时并行处理很多请求。</li>
</ul>
<h2 id="CPU多级缓存"><a href="#CPU多级缓存" class="headerlink" title="CPU多级缓存"></a>CPU多级缓存</h2><p><img src="/img/markdown-img-paste-20181030193947869.png" alt="CPU多级缓存"></p>
<ul>
<li>CPU的频率远远快与主存的速度，在处理器的时钟周期内，CPU需要等待主存，为了最大限度的利用CPU的性能，引入了Cache，环节CPU和内存之间速度的不匹配。</li>
<li><p>缓存的意义：</p>
<ul>
<li><p>时间局部性：如果某个数据被访问，那么在不久的将来它很可能再次被访问</p>
</li>
<li><p>空间局部性：如果某个数据被访问，那么与它相邻的数据很快也可能被访问</p>
</li>
</ul>
</li>
<li><p>缓存一致性-MESI：</p>
<ul>
<li><p>用于保证多个CPU cache之间缓存共享数据的一致性</p>
</li>
<li><p><img src="/img/markdown-img-paste-20181030195647642.png" alt></p>
<ul>
<li><p>M：修改，该缓存行只被缓存在缓存中，与CPU之间的数据是不同的，需要重新写入主存</p>
</li>
<li><p>E：独享，该缓存行只被缓存在缓存中，与CPU之间的数据一致</p>
</li>
<li><p>S：共享，该缓存行可能被多个CPU进行缓存</p>
</li>
<li><p>I：无效，有其他CPU修改了该缓存航</p>
</li>
<li><p>local read</p>
</li>
<li><p>local write</p>
</li>
<li><p>remote read</p>
</li>
<li><p>remote write</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>乱序执行优化：处理器为提高运算速度而做出违背代码原有顺序的优化</p>
</li>
<li><p>Java内存模型</p>
<ul>
<li><p>Heap：运行时数据区，可以动态分配内存大小，GC负责，存取速度相对较慢</p>
</li>
<li><p>Stack：存取速度较快，大小固定</p>
</li>
<li><p>当两个线程同时调用同一个对象的同一个方法，两个线程则拥有这个对象的私有拷贝</p>
<p><img src="/img/markdown-img-paste-20181030201239548.png" alt></p>
<p><img src="/img/markdown-img-paste-20181030202501137.png" alt="内存模型抽象图"></p>
</li>
<li><p>同步操作与规则：</p>
<ul>
<li><p>操作：</p>
<ul>
<li><p>lock：作用于主内存的变量，把一个变量标识为一个线程独占状态</p>
</li>
<li><p>unlock：作用于主内存的变量，把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定。</p>
</li>
<li><p>read：作用于主内存的变量，把一个变量值从主内存传输到线程的工作内存中，以便随后的load使用</p>
</li>
<li><p>load：作用于工作内存的变量，把read操作从主内存中得到的变量值放入到工作内存的变量副本中</p>
</li>
<li><p>use：作用于工作内存的变量，将工作内存中的一个变量值传递给执行引擎</p>
</li>
<li><p>assign：作用于工作内存的变量，把一个从执行引擎接收到的值赋值给工作内存的变量</p>
</li>
<li><p>store：作用于工作内存的变量，把工作内存中的一个变量的值传送到主内存中，以便随后的写入操作</p>
</li>
<li><p>write：作用于主内存的变量，把store操作从工作内存的中一个变量的值传送到主内存的变量中</p>
</li>
<li><p><img src="/img/markdown-img-paste-20181030203010624.png" alt></p>
</li>
</ul>
</li>
<li><p>规则：</p>
<ul>
<li><p>如果要把一个变量从主内存中复制到工作内存，就需要按顺序的执行read和load操作，如果把变量从工作内存中同步回主内存中，就要按顺序地执行store和write操作。但Java内存模型只要求上述操作必须按顺序执行，而没有保证必须是连续执行</p>
</li>
<li><p>不允许read和load，store和write操作之一单独出现</p>
</li>
<li><p>不允许一个线程丢弃它最近的assign操作，即变量在工作内存中改变了之后必须同步到主内存中</p>
</li>
<li><p>不允许一个线程无原因的把数据从工作内存同步回主内存中</p>
</li>
<li><p>一个新的变量只能在主内存中诞生，不允许在工作内存中直接使用一个未被初始化的变量。也就是对一个变量实施use和store操作之前，必须先执行过了assign和load操作</p>
</li>
<li><p>一个变量在同一时刻只允许一条线程对其进行lock操作，但是咯擦卡操作可以被同一条线程重复多次执行，多次lock之后，只有执行相同次数的unlock操作，变量才会被解锁。</p>
</li>
<li><p>如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前需要重新执行load或assign操作初始化变量的值</p>
</li>
<li><p>如果一个变量事先没有被lock操作锁定，则不允许对它执行unlock操作，也不允许unlock一个被其他线程锁定的变量</p>
</li>
<li><p>对一个变量执行unlock操作之前，必须先把此变量同步到主内存中</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>并发的优势</p>
<ul>
<li><p>速度：同时处理多个请求，相应更快，复杂的操作可以分成多个进程同时进行</p>
</li>
<li><p>设计：程序设计在某些情况下会更简单，也可以有更多的选择</p>
</li>
<li><p>资源利用：CPU能够在等待IO的时候做一些其他事情</p>
</li>
</ul>
</li>
<li><p>并发的风险：</p>
<ul>
<li><p>安全性：多个线程共享数据时可能会产生与预期不相符的结果</p>
</li>
<li><p>活跃性：某个操作无法继续进行下去的时候，就会发生活跃性的问题，比如死锁问题，饥饿问题等</p>
</li>
<li><p>性能：线程过多会使得CPU频繁切换线程，调度时间增多，同步机制，消耗过多的内存</p>
</li>
</ul>
</li>
</ul>
<h1 id="并发的线程安全处理"><a href="#并发的线程安全处理" class="headerlink" title="并发的线程安全处理"></a>并发的线程安全处理</h1><h2 id="并发模拟"><a href="#并发模拟" class="headerlink" title="并发模拟"></a>并发模拟</h2><ul>
<li><p>PostMan</p>
</li>
<li><p>Apache Bench</p>
</li>
<li><p>JMeter</p>
</li>
<li><p>Semaphore、countdownLatch</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrencyTest</span> </span>&#123;</div><div class="line">    <span class="comment">// 请求总数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</div><div class="line">    <span class="comment">// 线程总数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> count = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ExecutorService es = Executors.newCachedThreadPool();</div><div class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</div><div class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientTotal; i++) &#123;</div><div class="line">            es.execute(() -&gt; &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    semaphore.acquire();</div><div class="line">                    add();</div><div class="line">                    semaphore.release();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    log.error(<span class="string">"exception"</span>, e);</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                countDownLatch.countDown();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        countDownLatch.await();</div><div class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>, count);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</div><div class="line">        count++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="线程安全性"><a href="#线程安全性" class="headerlink" title="线程安全性"></a>线程安全性</h2><p>当多个线程访问某个类时，不管运行时环境采用何种调度方式，或者这些进程将如何交替执行，并且在主调代码中不需要任何额外的同步或者协同，这个类都将表现出正确的行为，那么这个类时线程安全的。</p>
<ul>
<li><p>原子性：提供了互斥访问，同一个时刻只有一个线程对它进行操作</p>
<ul>
<li><p>Atomic包：CAS完成原子性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Slf</span>4j</div><div class="line"><span class="meta">@ThreadSafe</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountExample2</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">10</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        ExecutorService es = Executors.newCachedThreadPool();</div><div class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</div><div class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span>  i = <span class="number">0</span>; i &lt; clientTotal; i++) &#123;</div><div class="line">            es.execute(() -&gt; &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    semaphore.acquire();</div><div class="line">                    add();</div><div class="line">                    semaphore.release();</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    log.error(<span class="string">"exception"</span>, e);</div><div class="line">                &#125;</div><div class="line">                countDownLatch.countDown();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        countDownLatch.await();</div><div class="line">        es.shutdown();</div><div class="line">        log.info(<span class="string">"count: &#123;&#125;"</span>, count);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</div><div class="line">        count.incrementAndGet();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//21:20:18.403 [main] INFO com.imooc.concurentcy.example.count.CountExample2 - count: 5000</span></div></pre></td></tr></table></figure>
<ul>
<li><p>AtomicXXX：CAS、Unsafe.compareAndSwapInt</p>
</li>
<li><p>AtomicLong、LongAddr</p>
</li>
<li><p>AtomicReference、AtomicReferenceFieldUpdater</p>
</li>
<li><p>AtomicStampReference：CAS的ABA问题</p>
</li>
</ul>
</li>
<li><p>锁</p>
<ul>
<li><p>synchronized，关键字，依赖JVM，不可中断的锁，适合竞争不激烈，可读性好</p>
<ul>
<li><p>修饰代码块，作用于调用的对象</p>
</li>
<li><p>修饰方法，整个方法，作用于对象</p>
</li>
<li><p>修饰静态方法，整个静态方法，作用于所有对象</p>
</li>
<li><p>修饰类，作用于所有对象</p>
</li>
</ul>
</li>
<li><p>Lock：依赖特殊的CPU指令，可中断锁，多样化同步，适合竞争激烈时能维持常态</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>可见性：一个线程对主内存的数据的修改可以及时的被其他线程观察到</p>
<ul>
<li><p>导致共享变量在线程间不可见的原因</p>
<ul>
<li><p>线程交叉执行</p>
</li>
<li><p>重排序结合线程交叉执行</p>
</li>
<li><p>共享变量更新后的值没有在工作内存与主内存间及时更新</p>
</li>
</ul>
</li>
<li><p>JMM关于synchronized的规定：</p>
<ul>
<li><p>线程解锁前，必须把共享变量的值，刷新到主内存中</p>
</li>
<li><p>线程加锁时，将清空工作内存中共享变量的值，从而使用共享变量时需要从主内存中重新读取最新的值</p>
</li>
</ul>
</li>
<li><p>volatile，通过内存屏障和禁止重排序优化来实现：</p>
<ul>
<li><p>对volatile变量写操作时，会在写操作后加入一条store屏障指令，将本地内存中的共享变量值刷新到主内存</p>
</li>
<li><p>对volatile变量读操作时，会在读操作前键入一条load屏障指令，从主内存中读取共享变量</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>有序性：一个线程观察其他线程中的指令的执行顺序，由于指令重排序的存在，该观察结果一般杂乱无序</p>
<ul>
<li><p>Java内存模型中，允许编译器和处理器对指令进行重排序，但是重排序过程不会影响到单线程程序的执行，但是会影响多线程并发执行的正确性</p>
</li>
<li><p>volatile，synchronized，Lock</p>
</li>
<li><p>Happenes-Before原则</p>
<ul>
<li><p>程序次序原则：一个程序内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作</p>
</li>
<li><p>锁定规则：一个unlock操作线性发生于后面对同一个锁的Lock操作</p>
</li>
<li><p>volatile变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作</p>
</li>
<li><p>传递规则：如果操作A先行发生于操作B，操作B先行发生于操作C，操作A先与操作C</p>
</li>
<li><p>线程启动规则：Thread对象的start方法先行发生于此线程的每一个动作</p>
</li>
<li><p>线程中断规则：对线程的interrupt方法的调用先行发生于被中断线程的代码检测到的中断事件的发生</p>
</li>
<li><p>线程终结规则：线程中所有的操作都先行发生于线程的终止检测</p>
</li>
<li><p>对象终结规则：一个对象的初始化完成先行发生于finalize()方法的开始</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="安全发布对象"><a href="#安全发布对象" class="headerlink" title="安全发布对象"></a>安全发布对象</h2><ol>
<li><p>发布对象：使一个对象能够被当前范围之外的代码所使用</p>
</li>
<li><p>对象逸出：一种错误的发布，一个对象没有构造完成就被其他线程所见</p>
</li>
<li><p>安全发布对象</p>
<ul>
<li><p>在静态初始化函数中初始化一个对象的引用</p>
</li>
<li><p>将对象的引用保存到volatile类型域或者AtomicReference对象中</p>
</li>
<li><p>将对象的引用保存到某个正确构造对象的final类型域中</p>
</li>
<li><p>将对象的引用保存到一个由锁保护的域中</p>
</li>
</ul>
</li>
</ol>
<h2 id="线程安全策略"><a href="#线程安全策略" class="headerlink" title="线程安全策略"></a>线程安全策略</h2><ol>
<li><p>不可变对象–String类型</p>
<ul>
<li><p>条件</p>
<ul>
<li><p>对象创建以后其状态不能修改</p>
</li>
<li><p>对象所有的域都是final类型</p>
</li>
<li><p>对象时正确创建的，创建过程中this引用没有逸出</p>
</li>
</ul>
</li>
<li><p>final关键字</p>
<ul>
<li><p>修饰类：不能被继承，String，Integer，Long</p>
</li>
<li><p>修饰方法：锁定方法不能被继承类修改，早期效率更高</p>
</li>
<li><p>修饰变量：</p>
<ul>
<li><p>基本数据类型变量，数值在初始化之后不可被修改</p>
</li>
<li><p>引用类型变量，初始化之后不能再指向另外一个对象，对象里面的值时可以进行修改的</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImmutableExample1</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer a = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String b = <span class="string">"2"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;Integer, Integer&gt; map = Maps.newHashMap();</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</div><div class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</div><div class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"><span class="comment">//        a = 2;</span></div><div class="line"><span class="comment">//        b = "a";</span></div><div class="line"><span class="comment">//        map = Maps.newTreeMap();</span></div><div class="line">        log.info(<span class="string">"&#123;&#125;"</span>, map.get(<span class="number">1</span>));</div><div class="line">        map.put(<span class="number">1</span>,<span class="number">4</span>);</div><div class="line">        log.info(<span class="string">"&#123;&#125;"</span>, map.get(<span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> a)</span> </span>&#123;</div><div class="line"><span class="comment">//        a = 1;</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * 17:04:10.511 [main] INFO com.imooc.concurentcy.example.immutable.ImmutableExample1 - 2</span></div><div class="line"><span class="comment"> * 17:04:10.517 [main] INFO com.imooc.concurentcy.example.immutable.ImmutableExample1 - 4</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>Collections.unmodifiableXXX:Collection, List, Set, Map…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImmutableExample2</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Integer a = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String b = <span class="string">"2"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, Integer&gt; map = Maps.newHashMap();</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        map.put(<span class="number">1</span>,<span class="number">2</span>);</div><div class="line">        map.put(<span class="number">3</span>,<span class="number">4</span>);</div><div class="line">        map.put(<span class="number">5</span>,<span class="number">6</span>);</div><div class="line">        map = Collections.unmodifiableMap(map);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"><span class="comment">//        a = 2;</span></div><div class="line"><span class="comment">//        b = "a";</span></div><div class="line"><span class="comment">//        map = Maps.newTreeMap();</span></div><div class="line">        log.info(<span class="string">"&#123;&#125;"</span>, map.get(<span class="number">1</span>));</div><div class="line">        map.put(<span class="number">1</span>,<span class="number">4</span>);</div><div class="line">        log.info(<span class="string">"&#123;&#125;"</span>, map.get(<span class="number">1</span>));</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Exception in thread "main" java.lang.UnsupportedOperationException</span></div><div class="line"><span class="comment"> * 17:02:41.546 [main] INFO com.imooc.concurentcy.example.immutable.ImmutableExample2 - 2</span></div><div class="line"><span class="comment"> * 	at java.util.Collections$UnmodifiableMap.put(Collections.java:1457)</span></div><div class="line"><span class="comment"> * 	at com.imooc.concurentcy.example.immutable.ImmutableExample2.main(ImmutableExample2.java:34)</span></div><div class="line"><span class="comment"> */</span></div></pre></td></tr></table></figure>
</li>
<li><p>Guava：ImmutableXXX:Collection, List, Set, Map…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ImmutableExample3</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableList list = ImmutableList.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableSet set = ImmutableSet.copyOf(list);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer, Integer&gt; map = ImmutableMap.of(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>);</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ImmutableMap&lt;Integer, Integer&gt; map2 = ImmutableMap.&lt;Integer, Integer&gt;builder().put(<span class="number">1</span>,<span class="number">2</span>)</div><div class="line">            .put(<span class="number">3</span>,<span class="number">4</span>).put(<span class="number">5</span>,<span class="number">6</span>).build();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line"><span class="comment">//        list.add(4);</span></div><div class="line"><span class="comment">//        Exception in thread "main" java.lang.UnsupportedOperationException</span></div><div class="line"><span class="comment">//        at com.google.common.collect.ImmutableCollection.add(ImmutableCollection.java:222)</span></div><div class="line"><span class="comment">//        at com.imooc.concurentcy.example.immutable.ImmutableExample3.main(ImmutableExample3.java:26)</span></div><div class="line">        map.put(<span class="number">6</span>,<span class="number">7</span>);</div><div class="line">        map2.put(<span class="number">7</span>,<span class="number">8</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>线程封闭</p>
<ul>
<li><p>Ad-hoc线程封闭：程序控制是实现</p>
</li>
<li><p>堆栈封闭：局部变量，无并发问题</p>
</li>
<li><p>ThreadLocal线程封闭</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestHolder</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ThreadLocal&lt;Long&gt; requesetHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Long id)</span> </span>&#123;</div><div class="line">        requesetHolder.set(id);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> requesetHolder.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>&#123;</div><div class="line">        requesetHolder.remove();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>线程不安全的类与写法</p>
<ul>
<li><p>StringBuilder-&gt;StringBuffer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Slf</span>4j</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringExample1</span> </span>&#123;</div><div class="line">    <span class="comment">// 请求总数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> clientTotal = <span class="number">5000</span>;</div><div class="line"></div><div class="line">    <span class="comment">// 同时并发执行的线程数</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> threadTotal = <span class="number">200</span>;</div><div class="line"></div><div class="line"><span class="comment">//    public static StringBuilder  sb = new StringBuilder();</span></div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> StringBuffer  sb = <span class="keyword">new</span> StringBuffer();</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        ExecutorService executorService = Executors.newCachedThreadPool();</div><div class="line">        <span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(threadTotal);</div><div class="line">        <span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(clientTotal);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clientTotal ; i++) &#123;</div><div class="line">            executorService.execute(() -&gt; &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    semaphore.acquire();</div><div class="line">                    update();</div><div class="line">                    semaphore.release();</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                    log.error(<span class="string">"exception"</span>, e);</div><div class="line">                &#125;</div><div class="line">                countDownLatch.countDown();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        countDownLatch.await();</div><div class="line">        executorService.shutdown();</div><div class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>, sb.length());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</div><div class="line">        sb.append(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>SimpleDateFormate-JodaTime</p>
</li>
<li><p>ArrayList，HashSet，HashMap等集合类</p>
</li>
</ul>
</li>
<li><p>同步容器</p>
<ul>
<li><p>Vector,Stack</p>
</li>
<li><p>HashTable:key和value不能为null</p>
</li>
<li><p>Collections.synchronizedXXX(List, Set, Map)</p>
</li>
</ul>
</li>
<li><p>并发容器</p>
<ul>
<li><p>ArrayList-&gt;CopyOnWriteArrayList</p>
<ul>
<li><p>读写分离</p>
</li>
<li><p>保证最终一致性</p>
</li>
<li><p>通过另外开辟空间来解决并发冲突</p>
</li>
</ul>
</li>
<li><p>HashSet,TreeSet-&gt;CopyOnWriteArraySet,ConcurrentSkipListSet</p>
</li>
<li><p>HashMap,TreeMap-&gt;ConcurrentHashMap,ConcurrentSkipListMap</p>
</li>
<li><p>JUC的实际构成：<br><img src="/img/markdown-img-paste-20181101154059310.png" alt></p>
</li>
</ul>
</li>
</ol>
<h2 id="J-U-C之AQS"><a href="#J-U-C之AQS" class="headerlink" title="J.U.C之AQS"></a>J.U.C之AQS</h2><h3 id="AQS-AbstractQueuedSynchronizer"><a href="#AQS-AbstractQueuedSynchronizer" class="headerlink" title="AQS-AbstractQueuedSynchronizer"></a>AQS-AbstractQueuedSynchronizer</h3><p><img src="/img/markdown-img-paste-20181101155018876.png" alt></p>
<ul>
<li><p>使用Node实现FIFO队列，可以用于构建锁或者其他同步装置的基础框架</p>
</li>
<li><p>利用一个int类型表示状态</p>
</li>
<li><p>使用方法是继承</p>
</li>
<li><p>子类通过继承并通过实现其方法管理其状态，也就是acquire方法和release方法</p>
</li>
<li><p>可以同时实现排他锁和共享锁模式</p>
</li>
</ul>
<h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><h3 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h3><ol>
<li><p>ReentrantLock和synchronized的区别</p>
<ul>
<li><p>可重入性，都可以</p>
</li>
<li><p>锁的实现，synchronized是依赖于JVM</p>
</li>
<li><p>性能：优化之后差不多</p>
</li>
<li><p>功能区别</p>
</li>
</ul>
</li>
<li><p>ReenTrantLock独有的功能：</p>
<ul>
<li><p>可以执行公平锁还是非公平锁</p>
</li>
<li><p>提供一个Condition类，可以分组唤醒需要唤醒的线程</p>
</li>
<li><p>可以终端等待锁的线程的机制</p>
</li>
</ul>
</li>
<li><p>StampLock–读，写，乐观读三种模式</p>
</li>
</ol>
<h3 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h3><h3 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h3><ul>
<li><p>Callable和Runnable接口对比</p>
<ul>
<li><p>run,call</p>
</li>
<li><p>返回值</p>
</li>
</ul>
</li>
<li><p>Future接口–获取线程运行状态和结果</p>
</li>
<li><p>FutureTask</p>
<ul>
<li><p>Runnable</p>
</li>
<li><p>Future</p>
</li>
</ul>
</li>
</ul>
<h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>阻塞队列中的操作：</p>
<p><img src="/img/markdown-img-paste-20181102152907971.png" alt></p>
<ul>
<li><p>ArrayBlockingQueue</p>
</li>
<li><p>DelayQueue</p>
</li>
<li><p>LinkedBlockingQueue</p>
</li>
<li><p>PriorityBlockingQueue</p>
</li>
<li><p>SynchronousQueue</p>
</li>
</ul>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><ul>
<li><p>new Thread的弊端</p>
<ul>
<li><p>性能差</p>
</li>
<li><p>线程缺乏统一管理，可能无限制的新建线程，相互竞争，有可能OOM</p>
</li>
<li><p>缺少更多功能，</p>
</li>
</ul>
</li>
<li><p>线程池的好处</p>
<ul>
<li><p>重用存在的线程，减少对象的创建，销毁的开销，性能好</p>
</li>
<li><p>可以有效的控制最大并发线程数，提高系统资源利用率，同时可以避免过多资源竞争，避免阻塞</p>
</li>
<li><p>提供定期执行，定时执行，单线程，并发数控制等功能</p>
</li>
</ul>
</li>
<li><p>ThreadPoolExecutor</p>
<ul>
<li><p>corePoolSize</p>
</li>
<li><p>maximumPoolSize</p>
</li>
<li><p>workQueue-阻塞队列</p>
</li>
<li><p>keepAliveTime</p>
</li>
<li><p>unit</p>
</li>
<li><p>threadFactory</p>
</li>
<li><p>rejectHandler</p>
</li>
</ul>
</li>
<li><p>线程池的状态</p>
<ul>
<li><p>running</p>
</li>
<li><p>shutdown</p>
</li>
<li><p>stop</p>
</li>
<li><p>tidying</p>
</li>
<li><p>terminated</p>
</li>
</ul>
<p><img src="/img/markdown-img-paste-20181102155642312.png" alt="线程池状态"></p>
</li>
<li><p>提供的方法</p>
<ul>
<li><p>execute</p>
</li>
<li><p>submit 有返回值 execute+future</p>
</li>
<li><p>shutdown</p>
</li>
<li><p>shutdownNow</p>
</li>
<li><p>getTaskCount：获取一致性和未执行的任务总数</p>
</li>
<li><p>getCompletedTaskCount</p>
</li>
<li><p>getPoolSize</p>
</li>
<li><p>getActiveCount</p>
</li>
</ul>
</li>
<li><p>四种线程池</p>
<ul>
<li><p>Executors.newCachedThreadPool</p>
</li>
<li><p>Executors.newFixedThreadPool</p>
</li>
<li><p>Executors.newScheduledhreadPool</p>
</li>
<li><p>Executors.newSingleThreadExecutor</p>
</li>
</ul>
</li>
<li><p>合理配置</p>
<ul>
<li><p>CPU密集型任务，需要尽量压榨CPU，参考值可以设置为CPU的核数+1</p>
</li>
<li><p>IO密集型任务，参考值可以设置为2*CPU的核数</p>
</li>
</ul>
</li>
</ul>
<h2 id="并发扩展"><a href="#并发扩展" class="headerlink" title="并发扩展"></a>并发扩展</h2><h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><ul>
<li><p>必要条件</p>
<ul>
<li><p>互斥条件</p>
</li>
<li><p>请求和保持条件：对已经获取的资源不释放</p>
</li>
<li><p>不剥夺条件</p>
</li>
<li><p>环路等待条件：循环等待</p>
</li>
</ul>
</li>
<li><p>死锁实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeadLock</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> flag = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object o1 = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object o2 = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        log.info(<span class="string">"flag : &#123;&#125;"</span>, flag);</div><div class="line">        <span class="keyword">if</span> (flag == <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (o1) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">500</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">synchronized</span> (o2) &#123;</div><div class="line">                    log.info(<span class="string">"1"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (flag == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (o2) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    Thread.sleep(<span class="number">500</span>);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">synchronized</span> (o1) &#123;</div><div class="line">                    log.info(<span class="string">"0"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        DeadLock td1 = <span class="keyword">new</span> DeadLock();</div><div class="line">        DeadLock td2 = <span class="keyword">new</span> DeadLock();</div><div class="line">        td1.flag = <span class="number">1</span>;</div><div class="line">        td2.flag = <span class="number">0</span>;</div><div class="line">        <span class="comment">//td1,td2都处于可执行状态，但JVM线程调度先执行哪个线程是不确定的。</span></div><div class="line">        <span class="comment">//td2的run()可能在td1的run()之前运行</span></div><div class="line">        <span class="keyword">new</span> Thread(td1).start();</div><div class="line">        <span class="keyword">new</span> Thread(td2).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>死锁避免方法：</p>
<ul>
<li><p>加锁顺序</p>
</li>
<li><p>加锁时限，超时释放机制</p>
</li>
<li><p>死锁检测</p>
</li>
</ul>
</li>
</ul>
<h2 id="多线程并发的最佳实践"><a href="#多线程并发的最佳实践" class="headerlink" title="多线程并发的最佳实践"></a>多线程并发的最佳实践</h2><ul>
<li><p>使用本地变量</p>
</li>
<li><p>使用不可变类</p>
</li>
<li><p>最小化锁的作用于范围：s = 1 / (1 - a + a / n);</p>
</li>
<li><p>使用线程池的Executor,而不是直接new Thread</p>
</li>
<li><p>宁可使用同步也不要使用线程的wait和notify方法</p>
</li>
<li><p>使用blockingQueue实现生产-消费模式</p>
</li>
<li><p>使用并发集合而不是使用加了锁的同步集合</p>
</li>
<li><p>使用Semaphore创建有界的访问</p>
</li>
<li><p>宁可使用同步代码块，也不使用同步的方法</p>
</li>
<li><p>避免使用静态变量</p>
</li>
</ul>
<h1 id="高并发处理思路及手段"><a href="#高并发处理思路及手段" class="headerlink" title="高并发处理思路及手段"></a>高并发处理思路及手段</h1><h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><ul>
<li><p>垂直扩容：提高系统部件能力，如加大内存</p>
</li>
<li><p>水平扩容：增加更多系统成员来实现，如增加机器</p>
</li>
<li><p>数据库扩容</p>
<ul>
<li><p>读操作扩展：memcache，redis,CDN缓存等</p>
</li>
<li><p>写操作扩展：Cassandra,Hbase等</p>
</li>
</ul>
</li>
</ul>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><ul>
<li><p>缓存特征</p>
<ul>
<li><p>缓存命中率：命中数 / (命中数+未命中数)</p>
</li>
<li><p>最大空间：缓存清空策略</p>
<ul>
<li><p>FIFO：淘汰最先创建的数据</p>
</li>
<li><p>LFU：最少使用次数，清除使用次数最少的数据</p>
</li>
<li><p>LRU：淘汰最远使用的数据的时间戳-热点数据</p>
</li>
<li><p>过期时间：过期时间最长的</p>
</li>
<li><p>Random：随机淘汰</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>影响缓存命中率的因素</p>
<ul>
<li><p>业务场景和业务需求-读写</p>
</li>
<li><p>缓存的设计(粒度和过期策略)</p>
</li>
<li><p>缓存的容量和基础设施</p>
</li>
<li><p>缓存节点故障等问题–一致性哈希算法</p>
</li>
</ul>
</li>
<li><p>缓存分类和应用场景：</p>
<ul>
<li><p>本地缓存：编程实现，Guava Cache</p>
</li>
<li><p>分布式缓存：Memcached，Redis</p>
</li>
</ul>
</li>
<li><p>Redis</p>
<p><img src="/img/markdown-img-paste-20181102185614826.png" alt="redis核心对象"></p>
</li>
<li><p>高并发场景下存在的问题</p>
<ul>
<li><p>缓存一致性</p>
<p><img src="/img/markdown-img-paste-2018110219583022.png" alt></p>
</li>
<li><p>缓存并发问题</p>
<p><img src="/img/markdown-img-paste-20181102195850302.png" alt></p>
</li>
<li><p>缓存穿透问题</p>
<p><img src="/img/markdown-img-paste-20181102195945446.png" alt></p>
<ul>
<li>缓存空对象</li>
</ul>
</li>
<li><p>缓存雪崩现象</p>
<p><img src="/img/markdown-img-paste-20181102200153487.png" alt></p>
</li>
</ul>
</li>
</ul>
<h2 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h2><ul>
<li><p>消息队列特性</p>
<ul>
<li><p>业务无关：只做消息分发</p>
</li>
<li><p>FIFO：先到先出</p>
</li>
<li><p>容灾：节点的动态增删和消息的持久化</p>
</li>
<li><p>性能：吞吐量提升，系统内部通信效率提高</p>
</li>
</ul>
</li>
<li><p>消息队列的好处</p>
<ul>
<li><p>业务解耦</p>
</li>
<li><p>最终一致性</p>
</li>
<li><p>广播</p>
</li>
<li><p>错峰与流控</p>
</li>
</ul>
</li>
<li><p>队列实例</p>
<ul>
<li><p>Kafka</p>
<p><img src="/img/markdown-img-paste-2018110315153084.png" alt></p>
<ul>
<li><p>高性能，跨语言，分布式发布订阅消息队列系统</p>
</li>
<li><p>快速持久化,O(1)</p>
</li>
<li><p>高吞吐</p>
</li>
<li><p>分布式系统</p>
</li>
<li><p>支持Hadoop数据加载</p>
</li>
</ul>
</li>
<li><p>RabbitMQ</p>
<p><img src="/img/markdown-img-paste-20181103151950629.png" alt></p>
</li>
</ul>
</li>
</ul>
<h2 id="应用拆分-解决单个服务器处理上限的问题"><a href="#应用拆分-解决单个服务器处理上限的问题" class="headerlink" title="应用拆分-解决单个服务器处理上限的问题"></a>应用拆分-解决单个服务器处理上限的问题</h2><ul>
<li><p>应用拆分原则</p>
<ul>
<li><p>业务优先</p>
</li>
<li><p>循序渐进</p>
</li>
<li><p>兼顾技术：重构，分层</p>
</li>
<li><p>可靠测试</p>
</li>
</ul>
</li>
<li><p>拆分过程中的关注点</p>
<ul>
<li><p>应用之间的通信：RPC or 消息队列 or …</p>
</li>
<li><p>应用之间的数据库设计：每个应用单独库</p>
</li>
<li><p>避免事务操作跨应用</p>
</li>
</ul>
</li>
<li><p>应用拆分</p>
<ul>
<li><p>服务化-Dubbo</p>
<p><img src="/img/markdown-img-paste-20181103155755996.png" alt="dubbo架构"></p>
</li>
<li><p>微服务-springcloud</p>
<p><img src="/img/markdown-img-paste-20181103155932871.png" alt="微服务架构"></p>
</li>
</ul>
</li>
</ul>
<h2 id="应用限流"><a href="#应用限流" class="headerlink" title="应用限流"></a>应用限流</h2><ul>
<li><p>算法</p>
<ul>
<li><p>计数器法-滑动窗口的低精度情况</p>
<p><img src="/img/markdown-img-paste-2018110316453581.png" alt="计数器法"></p>
</li>
<li><p>滑动窗口</p>
<p><img src="/img/markdown-img-paste-20181103164650199.png" alt="滑动窗口"></p>
</li>
<li><p>漏桶算法-leaky Bucket</p>
<p><img src="/img/markdown-img-paste-20181103164807626.png" alt="漏桶算法"></p>
</li>
<li><p>令牌桶算法-token Bucket-允许流量一定程度的突发</p>
<p><img src="/img/markdown-img-paste-2018110316490416.png" alt="令牌桶算法"></p>
</li>
</ul>
</li>
</ul>
<h2 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h2><ul>
<li><p>服务降级：设置默认返回，解决处理不了的请求。</p>
<ul>
<li><p>自动降级：超时，失败次数，故障，限流</p>
</li>
<li><p>人工降级：秒杀，双11大促等</p>
</li>
</ul>
</li>
<li><p>服务熔断：过载保护</p>
</li>
</ul>
<h2 id="数据库分库分表"><a href="#数据库分库分表" class="headerlink" title="数据库分库分表"></a>数据库分库分表</h2><ul>
<li><p>数据库瓶颈</p>
<ul>
<li><p>单个库的数据量上限（1-2T)</p>
</li>
<li><p>单个数据库服务压力过大，读写瓶颈：多个库</p>
</li>
<li><p>单个表的数据量过大：分表</p>
</li>
</ul>
</li>
<li><p>数据库切库</p>
<ul>
<li>读写分离，降低主库的压力，多个从库通过负载均衡来调节</li>
</ul>
</li>
<li><p>数据库分表-单个表的数据量过大</p>
<ul>
<li><p>横向分表：同样结构的不同数据的表，id取模划分</p>
</li>
<li><p>纵向分表：将本来可以在一个表的内容认为的划分为多个表，根据不同列的数据的活跃数量等进行分配</p>
</li>
</ul>
</li>
</ul>
<h2 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h2><ul>
<li><p>任务调度系统分布式：elastic-job + zookeeper</p>
</li>
<li><p>主备切换：Apache curator + zookeeper分布式锁实现</p>
</li>
<li><p>监控报警机制</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/Zookeeper分布式专题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/Zookeeper分布式专题/" itemprop="url">Zookeeper分布式专题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/" itemprop="url" rel="index">
                    <span itemprop="name">分布式</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式/zookeeper/" itemprop="url" rel="index">
                    <span itemprop="name">zookeeper</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zookeeper简介"><a href="#zookeeper简介" class="headerlink" title="zookeeper简介"></a>zookeeper简介</h1><ul>
<li>中间件，提供协调服务</li>
<li>作用于分布式系统，发挥其优势，可以为大数据服务</li>
<li><p>支持java，提供java和c语言的客户端API</p>
</li>
<li><p>特性：</p>
<ol>
<li>一致性：数据一致性，数据按照顺序分批入库</li>
<li>原子性：事物要么成功，要么失败，不会局部化执行</li>
<li>单一视图：客户端连接集群中的任一个zk节点，数据都是一致的</li>
<li>可靠性：每次对zk的操作状态都会保存在服务端</li>
<li>实时性：客户端可以读取到zk服务端的最新数据</li>
</ol>
</li>
</ul>
<h2 id="分布式系统"><a href="#分布式系统" class="headerlink" title="分布式系统"></a>分布式系统</h2><ul>
<li>多个计算机组成一个整体，一个整体一致对外并且处理同一请求</li>
<li>内部的每台计算机都可以通信，restful/rpc</li>
<li>客户端到服务端的一次请求到响应结束会经历多台计算机</li>
</ul>
<h1 id="zookeeper的安装"><a href="#zookeeper的安装" class="headerlink" title="zookeeper的安装"></a>zookeeper的安装</h1><h2 id="jdk安装"><a href="#jdk安装" class="headerlink" title="jdk安装"></a>jdk安装</h2><ol>
<li>下载linux的jdk1.8,上传服务器</li>
<li>解压缩jdk，配置jdk</li>
<li><p>测试：java -version</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ubuntu@VM-0-8-ubuntu:~$ java -version</div><div class="line">java version &quot;1.8.0_181&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.8.0_181-b13)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)</div></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="zookeeper基本数据模型"><a href="#zookeeper基本数据模型" class="headerlink" title="zookeeper基本数据模型"></a>zookeeper基本数据模型</h1><ul>
<li>zk的数据模型可以理解为linux的目录文件</li>
<li>每一个节点称为znode，可以有子节点，也可以有数据</li>
<li>每一个节点分为临时节点和永久节点，临时节点在客户端断开后消失</li>
<li>每一个zk节点都有各自的版本号，可以通过命令行显示节点信息</li>
<li>当节点的数据发生变化，该节点的版本号就会累加</li>
<li>删除修改过的节点，版本号不匹配则会报错</li>
<li>每个zk节点存储的数据不宜过大，几k即可</li>
<li>节点可以设置权限acl，可以通过权限来限制用户的访问</li>
</ul>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><ul>
<li>客户端连接</li>
<li>查看znode</li>
<li>关闭连接</li>
</ul>
<h2 id="zk的作用"><a href="#zk的作用" class="headerlink" title="zk的作用"></a>zk的作用</h2><ul>
<li>master节点选举，主节点挂了之后，从节点会接收工作，并且保证这个节点时唯一的，也就是所谓的首脑模式，从而保证集群的高可用。</li>
<li>统一配置文件管理，只需要一台服务器，可以把相同的配置文件同步更新到其他的服务器，在云计算中使用的很多。</li>
<li>发布与订阅，类似于MQ，dubbo发布者将数据存在znode，订阅者会读取这个数据。</li>
<li>提供分布式锁，用于分布式环境中不同进程之间争夺资源，类似于多线程中的锁。</li>
<li>集群管理，保证集群中数据的强一致性。</li>
</ul>
<h1 id="zk基本特性"><a href="#zk基本特性" class="headerlink" title="zk基本特性"></a>zk基本特性</h1><ul>
<li><p>./zkCli.sh打开客户端</p>
</li>
<li><p>ls</p>
</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017195401356.png" alt></p>
<ul>
<li>ls2</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017195429318.png" alt></p>
<ul>
<li>get</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017195553887.png" alt></p>
<ul>
<li>stat</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017195526564.png" alt></p>
<p>参数信息：</p>
<ul>
<li>cZid：节点id</li>
<li>ctime：创建时间</li>
<li>mZid：修改节点的id</li>
<li>mTime</li>
<li>pZxid：子节点id</li>
<li>cversion：子节点version</li>
<li>dataVersion：当前节点数据的版本号</li>
<li>aclVersion：权限版本号</li>
<li>ephemeralOwner：</li>
<li>dataLength：</li>
<li>numChildren：子节点的个数</li>
</ul>
<h2 id="session的基本原理"><a href="#session的基本原理" class="headerlink" title="session的基本原理"></a>session的基本原理</h2><ul>
<li>客户端和服务端之间的连接存在session</li>
<li>每个session都可以设置一个超时时间</li>
<li>心跳结束，session就过期</li>
<li>session过期，临时节点znode会被抛弃</li>
<li>心跳机制：客户端向服务端的ping包请求</li>
</ul>
<h2 id="create命令"><a href="#create命令" class="headerlink" title="create命令"></a>create命令</h2><ul>
<li>创建持久化节点</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017200354365.png" alt></p>
<ul>
<li>创建临时节点</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017200449517.png" alt></p>
<ul>
<li>创建顺序节点</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017200805341.png" alt></p>
<h2 id="set命令"><a href="#set命令" class="headerlink" title="set命令"></a>set命令</h2><p><img src="assets/markdown-img-paste-20181017201052567.png" alt></p>
<ul>
<li>根据版本号实现乐观锁</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017201144595.png" alt></p>
<h2 id="delete命令"><a href="#delete命令" class="headerlink" title="delete命令"></a>delete命令</h2><ul>
<li>不设置版本号</li>
</ul>
<p><img src="assets/markdown-img-paste-2018101720133103.png" alt></p>
<ul>
<li>设置版本号需要版本号匹配才可以删除</li>
</ul>
<p><img src="assets/markdown-img-paste-20181017201438164.png" alt></p>
<h2 id="watcher机制"><a href="#watcher机制" class="headerlink" title="watcher机制"></a>watcher机制</h2><ul>
<li>针对每一个节点的操作，都会有一个监督者，也就是watcher</li>
<li>当监控的某一个对象（znode）发生了变化，则出发watcher事件</li>
<li>zk中的watcher是一次性的，触发后就会被立即销毁</li>
<li>父节点，子节点，增删改查都能够触发其watcher</li>
<li>针对不同类型的操作，触发的watcher事件也是不同的<ul>
<li>子节点创建事件</li>
<li>子节点删除事件</li>
<li>子节点数据变化事件</li>
</ul>
</li>
</ul>
<h2 id="watcher命令行"><a href="#watcher命令行" class="headerlink" title="watcher命令行"></a>watcher命令行</h2><ul>
<li><p>watcher事件类型</p>
<ul>
<li>创建父节点触发：NodeCreated<br><img src="assets/markdown-img-paste-20181017202244131.png" alt></li>
<li>修改父节点数据触发：NodeDataChanged<br><img src="assets/markdown-img-paste-20181017202411972.png" alt></li>
<li>删除节点触发：NodeDeleted<br><img src="assets/markdown-img-paste-20181017202630988.png" alt></li>
<li>ls为父节点设置watcher，创建子节点触发：NodeChildrenChanged<br><img src="assets/markdown-img-paste-20181017202829923.png" alt></li>
<li>ls为父节点设置watcher，删除子节点触发：NodeChildrenChanged<br><img src="assets/markdown-img-paste-20181017202933755.png" alt></li>
<li>ls为父节点设置watcher，修改子节点不触发任何事件<br><img src="assets/markdown-img-paste-20181017203123310.png" alt></li>
</ul>
</li>
<li><p>watcher使用场景</p>
<ul>
<li>统一资源配置</li>
</ul>
</li>
</ul>
<h2 id="ACL-Acess-Control-Lists-权限控制"><a href="#ACL-Acess-Control-Lists-权限控制" class="headerlink" title="ACL(Acess Control Lists)权限控制"></a>ACL(Acess Control Lists)权限控制</h2><ul>
<li>针对节点可以设置相关读写等权限，目的为了保障数据安全性</li>
<li>权限permissions可以指定不同的权限范围以及角色</li>
</ul>
<h3 id="ACL命令行"><a href="#ACL命令行" class="headerlink" title="ACL命令行"></a>ACL命令行</h3><ul>
<li>getAcl：获取某个节点的acl权限信息</li>
<li>setAcl：设置某个节点的acl权限信息</li>
<li>addauth：输入认证权限信息，注册时输入明文密码登录，但是在zk的系统中，密码以加密形式存在。</li>
<li>zk的acl通过【scheme:id:permissions】来构成权限列表<ul>
<li>scheme：代表采用的某种权限机制<ul>
<li>world:world下只有一个id，也就是只有一个用户anyone，任何人都可以访问该节点</li>
<li>auth:代表认证登录，需要注册用户有权限就可以，明文密码登录</li>
<li>digest:需要对密码加密才能访问</li>
<li>ip:当设置ip为指定的ip地址，此时限制ip进行访问</li>
<li>super：代表超级管理员，拥有所有的权限</li>
</ul>
</li>
<li>id：代表允许访问的用户</li>
<li>permissions：权限组合字符串<ul>
<li>crdwa：权限字符串</li>
<li>create：创建子节点</li>
<li>read：获取节点、子节点</li>
<li>write：设置节点数据</li>
<li>delete：删除子节点</li>
<li>admin：设置权限</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol>
<li>world:anyone:cdrwa</li>
</ol>
<p><img src="assets/markdown-img-paste-20181018120809334.png" alt></p>
<p><img src="assets/markdown-img-paste-2018101812272445.png" alt></p>
<ol>
<li>auth:user:pwd:cdrwa</li>
<li>digest:user:BASE64(SHA1(pwd)):cdrwa</li>
<li>addauth digest user:pwd</li>
</ol>
<p><img src="assets/markdown-img-paste-20181018130237413.png" alt></p>
<h1 id="zk集群"><a href="#zk集群" class="headerlink" title="zk集群"></a>zk集群</h1><h2 id="集群搭建的注意点"><a href="#集群搭建的注意点" class="headerlink" title="集群搭建的注意点"></a>集群搭建的注意点</h2><ul>
<li>配置文件myid 1/2/3对应server.1.2.3</li>
<li>通过./zkCli.sh -server [ip]:[port]检测集群是否配置成功</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/算法/一致性哈希算法及其Java实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/算法/一致性哈希算法及其Java实现/" itemprop="url">一致性哈希及其Java实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Consistent-Hash/" itemprop="url" rel="index">
                    <span itemprop="name">Consistent Hash</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一致性哈希概念"><a href="#一致性哈希概念" class="headerlink" title="一致性哈希概念"></a>一致性哈希概念</h1><ul>
<li>维基百科的定义</li>
</ul>
<p>一致哈希 是一种特殊的哈希算法。在使用一致哈希算法后，哈希表槽位数（大小）的改变平均只需要对K/n 个关键字重新映射，其中K是关键字的数量，n是槽位数量。然而在传统的哈希表中，添加或删除一个槽位的几乎需要对所有关键字进行重新映射。</p>
<p>一致性哈希算法提出了动态变化的Cache环境中，判定哈希算法好坏的四个定义：</p>
<ol>
<li>平衡性：哈希的结果尽可能分布到所有的缓存中，充分利用缓存空间。</li>
<li>单调性：举例说吧，本来有ABC三个缓存，数据1存储在B中，现在添加了D缓存进去，则数据1只会分布在B或者D中，不会分配到AC中。</li>
<li>分散性：分散性是同一个数据被映射到不同的缓存中，需要避免</li>
<li>负载：一个缓冲区被多个用户映射为不同的内容，需要降低缓冲的负载。</li>
</ol>
<h1 id="传统哈希算法"><a href="#传统哈希算法" class="headerlink" title="传统哈希算法"></a>传统哈希算法</h1><p>针对分布式场景，假定有1000W个数据项，100个存储接待你，一个数据的存储位置为该数据的Hash值对服务器数量取余，这样可以将数据尽可能的分散到各个服务器上。</p>
<p>  <img src="/img/cons-Hash-1.png" alt="Alt text"></p>
<p>这种哈希方案的优点是每个节点的的数据量是相仿的，相对均衡，但是当在集群里面增加一台服务器，或者减少一台服务器的话，几乎所有的缓存都会失效，需要重新哈希。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/18\</div><div class="line"> * 传统哈希方法</div><div class="line"> * 100000000个数据项，100个存储节点</div><div class="line"> */</div><div class="line">public class NormalHashMethod &#123;</div><div class="line">    //数据数</div><div class="line">    public static final int NUMBER_OF_DATA = 10000000;</div><div class="line">    //节点数</div><div class="line">    public static final int NUMBER_OF_NODE = 100;</div><div class="line">    //节点中存放的数据个数</div><div class="line">    private static int[] record = new int[NUMBER_OF_NODE];</div><div class="line"></div><div class="line">    //将节点放入对应的服务器中</div><div class="line">    public static void hashProcess() &#123;</div><div class="line">        for (int i = 0; i &lt; NUMBER_OF_DATA; i++) &#123;</div><div class="line">            int result = getHash(i+&quot;&quot;);</div><div class="line">            record[result%100]++;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;平均节点中的数据量： &quot; + NUMBER_OF_DATA/NUMBER_OF_NODE);</div><div class="line">        System.out.println(&quot;最多的一个节点的数量： &quot; + getMax(record));</div><div class="line">        System.out.println(&quot;最少的一个节点的数量： &quot; + getMin(record));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //添加一个节点或者减少一个节点时，需要移动的节点数</div><div class="line">    public static void afterAddOrDeleteOneNode() &#123;</div><div class="line">        int count = 0;</div><div class="line">        int count1 = 0;</div><div class="line">        //对所有数据进行hash，对新的服务器数量取余</div><div class="line">        for (int i = 0; i &lt; NUMBER_OF_DATA; i++) &#123;</div><div class="line">            int result = getHash(i+&quot;&quot;);</div><div class="line">            if (result % NUMBER_OF_NODE != result % (NUMBER_OF_NODE + 1))</div><div class="line">                count++;</div><div class="line">            if (result % NUMBER_OF_NODE != result % (NUMBER_OF_NODE - 1))</div><div class="line">                count1++;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;添加一个节点数据移动的数量： &quot; + count);</div><div class="line">        System.out.println(&quot;减少一个节点数据移动的数量： &quot; + count1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //使用FNV1_32_HASH算法</div><div class="line">    private static int getHash(String str) &#123;</div><div class="line">        final int p = 16777619;</div><div class="line">        int hash = (int) 2166136261L;</div><div class="line">        for (int i = 0; i &lt; str.length(); i++)</div><div class="line">            hash = (hash ^ str.charAt(i)) * p;</div><div class="line">        hash += hash &lt;&lt; 13;</div><div class="line">        hash ^= hash &gt;&gt; 7;</div><div class="line">        hash += hash &lt;&lt; 3;</div><div class="line">        hash ^= hash &gt;&gt; 17;</div><div class="line">        hash += hash &lt;&lt; 5;</div><div class="line"></div><div class="line">        // 如果算出来的值为负数则取其绝对值</div><div class="line">        if (hash &lt; 0)</div><div class="line">            hash = Math.abs(hash);</div><div class="line">        return hash;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int getMax(int[] arr) &#123;</div><div class="line">        int max = arr[0];</div><div class="line">        for (int x = 1; x &lt; arr.length; x++) &#123;</div><div class="line">            if (arr[x] &gt; max)</div><div class="line">                max = arr[x];</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        return max;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int getMin(int[] arr) &#123;</div><div class="line">        int min = arr[0];</div><div class="line">        for (int x = 1; x &lt; arr.length; x++) &#123;</div><div class="line">            if (arr[x] &lt; min)</div><div class="line">                min = arr[x];</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        return min;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        hashProcess();</div><div class="line">        afterAddOrDeleteOneNode();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的例子中是用普通哈希方法来做的，输出结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">平均节点中的数据量： 100000</div><div class="line">最多的一个节点的数量： 100653</div><div class="line">最少的一个节点的数量： 99160</div><div class="line">添加一个节点数据移动的数量： 9900492</div><div class="line">减少一个节点数据移动的数量： 9899656</div></pre></td></tr></table></figure>
<p>可以看出，一共1000万个数据，添加或者减少一个节点，进行重新哈希，则990万个数据需要改变存储位置。也就是说990万个缓存不能命中，实际场景中这明显是不能接受的，因此提出了一致性哈希来解决这个问题。</p>
<h1 id="一致性哈希"><a href="#一致性哈希" class="headerlink" title="一致性哈希"></a>一致性哈希</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><ul>
<li>唤醒hash空间：按照常用的hash算法来将对应的key哈希到一个具有2^32次方个桶的空间中，也就是0-2^32-1的数字空间中，将其收尾相连，形成一个环空间。</li>
</ul>
<p>Hash(object1) = key1；<br>Hash(object2) = key2；<br>Hash(object3) = key3；<br>Hash(object4) = key4；</p>
<p>  <img src="/img/cons-Hash-2.png" alt="Alt text"></p>
<ul>
<li><p>将数据通过一定的哈希算法处理后映射到环上</p>
<p><img src="/img/cons-Hash-3.png" alt="Alt text"></p>
</li>
<li><p>将服务器通过哈希算法映射到环上,和数据的哈希算法是一样的，环上的数据，顺时针遇到的第一个服务器就是该数据的存储位置。假定有三个服务器节点。</p>
</li>
</ul>
<p>Hash(NODE1) = KEY1;<br>Hash(NODE2) = KEY2;<br>Hash(NODE3) = KEY3;</p>
<p>  <img src="/img/cons-Hash-4.png" alt="Alt text"></p>
<p>由于哈希环是不会变更的，因此一个数据可以快速的知道他的真正的存储位置。</p>
<h2 id="服务器的删除与添加"><a href="#服务器的删除与添加" class="headerlink" title="服务器的删除与添加"></a>服务器的删除与添加</h2><p>不同于传统哈希求余方法，一致性哈希算法在增加或者删除服务器节点是，需要换位置的节点很少，性能很高。</p>
<ol>
<li><p>删除服务器节点,如果NODE2出现故障，则从集群里面溢出，那么object3会迁移到Node3中，其他数据的位置不变。</p>
<p><img src="/img/cons-Hash-5.png" alt="Alt text"></p>
</li>
<li><p>添加服务器节点，向集群里面添加新的 首先将其映射到环中，通过顺时针迁移的规则，object2会迁移到NODE4中，其他对象不会发生改变。数据迁移的数量很小，很适合分布式集群。</p>
<p><img src="/img/cons-Hash-6.png" alt="Alt text"></p>
</li>
<li><p>java示范</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line">import java.util.Objects;</div><div class="line">import java.util.SortedMap;</div><div class="line">import java.util.TreeMap;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/18\</div><div class="line"> * 一致性哈希方法</div><div class="line"> * 100000000个数据项，100个存储节点</div><div class="line"> */</div><div class="line">public class ConsistentHashMethod &#123;</div><div class="line">    public static final int NUMBER_OF_DATA = 10000000;</div><div class="line">    public static final int NUMBER_OF_NODE = 100;</div><div class="line">    //记录服务器要添加的环上的位置，默认为均匀分布的</div><div class="line">    private static int[] servers = new int[NUMBER_OF_NODE];</div><div class="line">    //key-服务器的哈希值，value表示服务器的位置</div><div class="line">    private static SortedMap&lt;Integer, Integer&gt; sortedMap = new TreeMap&lt;&gt;();</div><div class="line">    //记录每个服务器节点放置的数据数</div><div class="line">    private static int[] record = new int[NUMBER_OF_NODE];</div><div class="line"></div><div class="line">    //初始化，将服务器放入环中</div><div class="line">    public static void init() &#123;</div><div class="line">        int div = (Integer.MAX_VALUE) / NUMBER_OF_NODE;</div><div class="line">        for (int i = 0; i &lt; 100; i++) &#123;</div><div class="line">            servers[i] = i * div;</div><div class="line">        &#125;</div><div class="line">        //将所有服务器放入SortedMap中</div><div class="line">        for (int i = 0; i &lt; servers.length; i++) &#123;</div><div class="line">            int hash = getHash(servers[i] + &quot;&quot;);</div><div class="line">            sortedMap.put(hash, servers[i]);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void hashProcess() &#123;</div><div class="line">        int div = 21474836;</div><div class="line">        for (int i = 0; i &lt; NUMBER_OF_DATA; i++) &#123;</div><div class="line">            int hash = getHash(i+&quot;&quot;);</div><div class="line">            //得到大于该Hash值的所有Map</div><div class="line">            SortedMap&lt;Integer, Integer&gt; subMap = sortedMap.tailMap(hash);</div><div class="line">            //将节点放入对应的服务器中</div><div class="line">            if (subMap.isEmpty()) &#123;</div><div class="line">                Integer index = sortedMap.firstKey();</div><div class="line">                record[sortedMap.get(index) / div]++;</div><div class="line">            &#125; else &#123;</div><div class="line">                Integer index = subMap.firstKey();</div><div class="line">                record[sortedMap.get(index)/div]++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;平均节点中的数据量： &quot; + NUMBER_OF_DATA/NUMBER_OF_NODE);</div><div class="line">        System.out.println(&quot;最多的一个节点的数量： &quot; + getMax(record));</div><div class="line">        System.out.println(&quot;最少的一个节点的数量： &quot; + getMin(record));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void afterAddOneNode() &#123;</div><div class="line">        int count = 0;</div><div class="line">        int div1 = (Integer.MAX_VALUE) / NUMBER_OF_NODE;</div><div class="line">        SortedMap&lt;Integer, Integer&gt; addNode = new TreeMap&lt;&gt;(sortedMap);</div><div class="line">        addNode.put(getHash(&quot;2333&quot;), 2333);</div><div class="line">        for (int i = 0; i &lt; NUMBER_OF_DATA; i++) &#123;</div><div class="line">            int hash = getHash(i + &quot;&quot;);</div><div class="line">            SortedMap&lt;Integer, Integer&gt; sub = sortedMap.tailMap(hash);</div><div class="line">            SortedMap&lt;Integer, Integer&gt; sub1 = addNode.tailMap(hash);</div><div class="line">            if (sub.isEmpty() &amp;&amp; sub1.isEmpty() ) &#123;</div><div class="line">                count++;</div><div class="line">            &#125;</div><div class="line">            if (!sub.isEmpty() &amp;&amp; !sub1.isEmpty() &amp;&amp; !Objects.equals(sub.firstKey(), sub1.firstKey())) &#123;</div><div class="line">                count++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;添加一个节点数据移动的数量： &quot; + count);</div><div class="line">    &#125;</div><div class="line">    //使用FNV1_32_HASH算法</div><div class="line">    private static int getHash(String str) &#123;</div><div class="line">        final int p = 16777619;</div><div class="line">        int hash = (int) 2166136261L;</div><div class="line">        for (int i = 0; i &lt; str.length(); i++)</div><div class="line">            hash = (hash ^ str.charAt(i)) * p;</div><div class="line">        hash += hash &lt;&lt; 13;</div><div class="line">        hash ^= hash &gt;&gt; 7;</div><div class="line">        hash += hash &lt;&lt; 3;</div><div class="line">        hash ^= hash &gt;&gt; 17;</div><div class="line">        hash += hash &lt;&lt; 5;</div><div class="line"></div><div class="line">        // 如果算出来的值为负数则取其绝对值</div><div class="line">        if (hash &lt; 0)</div><div class="line">            hash = Math.abs(hash);</div><div class="line">        return hash;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int getMax(int[] arr) &#123;</div><div class="line">        int max = arr[0];</div><div class="line">        for (int x = 1; x &lt; arr.length; x++) &#123;</div><div class="line">            if (arr[x] &gt; max)</div><div class="line">                max = arr[x];</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        return max;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int getMin(int[] arr) &#123;</div><div class="line">        int min = arr[0];</div><div class="line">        for (int x = 1; x &lt; arr.length; x++) &#123;</div><div class="line">            if (arr[x] &lt; min)</div><div class="line">                min = arr[x];</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        return min;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        init();</div><div class="line">        hashProcess();</div><div class="line">        afterAddOneNode();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">平均节点中的数据量： 100000</div><div class="line">最多的一个节点的数量： 479784</div><div class="line">最少的一个节点的数量： 1367</div><div class="line">添加一个节点数据移动的数量： 138303</div></pre></td></tr></table></figure>
<p>可以看出添加一个节点之后，要修改的数据只有十万个，效率很高。</p>
<h2 id="虚拟节点"><a href="#虚拟节点" class="headerlink" title="虚拟节点"></a>虚拟节点</h2><p>上面可以明确看出，一致性哈希算法满足了单调性和负载均衡的特性以及一般hash算法的分散性，平衡性的体现通过虚拟节点来实现。哈希算法是不保证平衡的，如值部署了NODE1和NODE3的情况，object1存储到NODE1中，其他的都存到NODE3中，这样就非常不平衡了。因此引入了虚拟节点。</p>
<ul>
<li><p>虚拟节点：实际上是及其在哈希空间中的复制品，一个实际的节点对应了若干个虚拟节点，这样对应个数也成为复制个数，虚拟节点在哈希空间中以哈希值排列。新建两个复制节点之后可以看到节点分配变得很均衡。</p>
<p><img src="/img/cons-Hash-7.png" alt="Alt text"></p>
</li>
</ul>
<p>其中涉及了哈希虚拟节点到实际节点的转换，其实只是一个简单的映射：</p>
<p>  <img src="/img/cons-Hash-8.png" alt="Alt text"></p>
<p>而在实际的场景中，可以通过对真实节点进行编号来生成相应的虚拟节点。如真实节点的IP为192.168.10.11，则虚拟节点可以设置为192.168.10.11#1,192.168.10.11#2。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/struts2总结 四--异常处理和I18N/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/struts2总结 四--异常处理和I18N/" itemprop="url">struts2总结（四）--异常处理和I18N</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="6-声明式异常处理"><a href="#6-声明式异常处理" class="headerlink" title="6 声明式异常处理"></a>6 声明式异常处理</h2><p>通过配置的方式捕获指定类型异常，有ExceptionMappingInterceptor拦截器将异常信息（ExceptionHolder：exceptionStack， exception）压入栈顶，然后通过OGNL表达式在页面中获取异常。</p>
<ol>
<li><p>在Actoin中进行异常映射</p>
<ul>
<li>只对当前Action对应类型的异常起作用，在struts2配置文件Action内部节点使用exception-mapping来映射异常,当发生SQLException时，会返回“error”信息，并跳转到error.jsp页面：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;action name=&quot;*-*&quot; class=&quot;com.bbs.action.&#123;1&#125;Action&quot; method=&quot;&#123;2&#125;&quot;&gt;</div><div class="line">          &lt;result&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">          &lt;result name=&quot;input&quot;&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">          &lt;exception-mapping exception=&quot;java.sql.SQLException&quot; result=&quot;error&quot; /&gt;</div><div class="line">          &lt;result name=&quot;error&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">      &lt;/action&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>在package中进行全局异常映射</p>
<ul>
<li>针对所有Action对应类型的异常都起作用，可以通过OGNL在页面中获取异常信息需。</li>
<li>GLOBAL级别的声明式异常配置必须配置在所有的Action之前，同时，global-result节点需要配置在global-exception-mappings之前。</li>
<li>当捕获到一个异常对象时，如果同时存在Action和全局两种级别的映射信息，则优先使用Action级别。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;default&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">      &lt;global-results&gt;</div><div class="line">          &lt;result name=&quot;globleException&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">      &lt;/global-results&gt;</div><div class="line"></div><div class="line">      &lt;global-exception-mappings&gt;</div><div class="line">          &lt;exception-mapping result=&quot;globleException&quot; exception=&quot;java.lang.Exception&quot;/&gt;</div><div class="line">      &lt;/global-exception-mappings&gt;</div><div class="line">  &lt;/package&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用继承共用异常映射，多个package可以通过extends来公用异常映射：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;admin&quot; namespace=&quot;/admin&quot; extends=&quot;default&quot; &gt;</div><div class="line"></div><div class="line">       &lt;action name=&quot;index&quot;&gt;</div><div class="line">           &lt;result&gt;/admin/index.html&lt;/result&gt;</div><div class="line">       &lt;/action&gt;</div><div class="line"></div><div class="line">       &lt;action name=&quot;*-*&quot; class=&quot;com.action.&#123;1&#125;Action&quot; method=&quot;&#123;2&#125;&quot;&gt;</div><div class="line">           &lt;result&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">           &lt;result name=&quot;input&quot;&gt;/admin/&#123;1&#125;-&#123;2&#125;.jsp&lt;/result&gt;</div><div class="line">           &lt;result name=&quot;error&quot;&gt;/error.jsp&lt;/result&gt;</div><div class="line">       &lt;/action&gt;</div><div class="line">&lt;/package&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>Struts2中异常处理由拦截器实现（观察struts-default.xml）</p>
<ul>
<li>实际上Struts2的大多数功能都由拦截器实现</li>
</ul>
</li>
</ol>
<h2 id="7-I18N"><a href="#7-I18N" class="headerlink" title="7 I18N"></a>7 I18N</h2><ol>
<li><p>I18N原理<br>国际化，international。我们将程序中硬编码的文本转移到外部的资源文件（.properties）中期 ，针对每一种语言环境，编写一个资源文件。指定当前程序所用的语言环境，Java中的国际化处理机制能够自动找到对应的资源文件并读取内容。创建了两个资源文件，一个为bbs_en_US.properties,bbs_zh_CN.properties，需要注意的 是编码问题，IDEA中将File-Editor-Code Style-File Encodings-Transparent native-to-ascii conversion勾选上，就可以将中文自动转换成ASCII编码。</p>
<ul>
<li>ResourceBundle和Locale的概念</li>
<li>ResourceBundle:按语言查找顺序</li>
<li>Locale命令是将当前语言环境或全部公共语言环境的信息输出到标准输出上</li>
<li>资源文件:在Action所在的包或者任意一个父包中定义package.properties和package_language_COUTRY.properties资源文件</li>
</ul>
</li>
<li><p>Struts的资源文件</p>
<ul>
<li>Action – Package – App级</li>
<li>一般只用APP</li>
<li>struts.xml custom.i18n</li>
<li>动态语言切换</li>
<li>request_locale=en_US</li>
</ul>
</li>
<li><p>了解的不多，以后可以查教程<br><a href="http://www.yiibai.com/struts_2/struts_localization.html" target="_blank" rel="external">I18N</a></p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/struts2总结 五--interceptor拦截器/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/struts2总结 五--interceptor拦截器/" itemprop="url">struts2总结（五）--interceptor</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="8-拦截器-interceptor"><a href="#8-拦截器-interceptor" class="headerlink" title="8 拦截器(interceptor)"></a>8 拦截器(interceptor)</h2><h3 id="8-1-Struts架构图"><a href="#8-1-Struts架构图" class="headerlink" title="8.1 Struts架构图"></a>8.1 Struts架构图</h3><p>  <img src="/img/struts_arch.jpg" alt="Alt text"></p>
<h3 id="8-2-Struts执行过程分析"><a href="#8-2-Struts执行过程分析" class="headerlink" title="8.2 Struts执行过程分析"></a>8.2 Struts执行过程分析</h3><p><img src="/img/struts.png" alt="Alt text"></p>
<blockquote>
<ul>
<li>拦截器：拦截器是struts2框架中提供的一种Java类</li>
<li>作用：<pre><code>* 可以拦截访问Action的请求
* 给这个Action加上新的丰富功能（上传，参数自动接收，类型自动转换等）需要配置之后，指明哪一个拦截器去拦截哪一个Action或者哪一些Action，这个拦截器才会去拦截我们的Action。
</code></pre></li>
<li>拦截器工作原理：<pre><code>1. 有一个拦截器的类（框架的或者自定义的）
2. 在配置文件中把这个拦截器类配置出来
3. 指明这个拦截器要拦截哪一个或者哪一些action
4. 客户端发送一个请求访问一个被拦截器拦截的Action
5. 这个请求首先会被struts2 的filter所拦截，filter会检查这个请求是不是请求的Action，如果是，会再检查这个Action有没有被定义的拦截器所拦截，如果有，那么把这个请求交给拦截器去处理
</code></pre></li>
</ul>
</blockquote>
<h3 id="8-3-Interceptor拦截器过程模拟"><a href="#8-3-Interceptor拦截器过程模拟" class="headerlink" title="8.3  Interceptor拦截器过程模拟"></a>8.3  Interceptor拦截器过程模拟</h3><ul>
<li>定义一个Interceptor接口，有一个intercept方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public interface Inteceptor &#123;</div><div class="line">    public void intercept(ActionInvocation actionInvocation);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>创建两个interceptor实现了interceptor接口：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class FirstInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(1);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-1);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class SecondInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(2);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>定义一个Action</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class SecondInterceptor implements Inteceptor&#123;</div><div class="line">    @Override</div><div class="line">    public void intercept(ActionInvocation actionInvocation) &#123;</div><div class="line">        System.out.println(2);</div><div class="line">        actionInvocation.invoke();</div><div class="line">        System.out.println(-2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>定义ActionInvocation</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.List;</div><div class="line"></div><div class="line">public class ActionInvocation &#123;</div><div class="line">    List&lt;Inteceptor&gt; inteceptors = new ArrayList&lt;&gt;();</div><div class="line">    int index = -1;</div><div class="line">    Action a = new Action();</div><div class="line"></div><div class="line">    public ActionInvocation() &#123;</div><div class="line">        this.inteceptors.add(new FirstInterceptor());</div><div class="line">        this.inteceptors.add(new SecondInterceptor());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void invoke() &#123;</div><div class="line">        index++;</div><div class="line">        if (index &gt;= this.inteceptors.size()) &#123;</div><div class="line">            a.execute();</div><div class="line">        &#125; else &#123;</div><div class="line">            this.inteceptors.get(index).intercept(this);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>执行main文件:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public class Main &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        new ActionInvocation().invoke();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>运行结果为：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1</div><div class="line">2</div><div class="line">execute</div><div class="line">-2</div><div class="line">-1</div></pre></td></tr></table></figure>
<blockquote>
<p>从而执行顺序为，首先main函数，创建ActionInvocation对象，初始化的时候讲两个Inteceptor加到interceptors这个列表中，调用其invoke()方法，当还有interceptor没有访问时，调用第一个interceptor的intercept方法，输出1，并调用ActionInvocation的invoke方法，此时会调用第二个Inteceptor的intercept方法，输出2，并调用ActionInvocation的invoke方法，此时不存在拦截器，执行Action输出execute，后面依次输出-2 -1， 完成这个模拟过程！</p>
</blockquote>
<h3 id="8-4-定义自己的拦截器"><a href="#8-4-定义自己的拦截器" class="headerlink" title="8.4 定义自己的拦截器"></a>8.4 定义自己的拦截器</h3><ul>
<li><p>struts2框架已经写好了很多个拦截器，同时也把这些拦截器配置在配置文件里面struts-default.xml中，除此之外，我们可以写自己的拦截器</p>
</li>
<li><p>首先实现一个Interceptor接口：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class MyInterceptor implements Interceptor &#123;</div><div class="line"></div><div class="line">	public void destroy() &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void init() &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public String intercept(ActionInvocation invocation) throws Exception &#123;</div><div class="line">		long start = System.currentTimeMillis();</div><div class="line">		String r = invocation.invoke();</div><div class="line">		long end = System.currentTimeMillis();</div><div class="line">		System.out.println(&quot;action time = &quot; + (end - start));</div><div class="line">		return r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>然后在struts.xml文件中配置出这个拦截器：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;package name=&quot;test&quot; namespace=&quot;/&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">		&lt;interceptors&gt;</div><div class="line">			&lt;interceptor name=&quot;my&quot; class=&quot;com.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">		&lt;/interceptors&gt;</div><div class="line"></div><div class="line">		&lt;action name=&quot;test&quot; class=&quot;com.action.TestAction&quot;&gt;</div><div class="line">			&lt;result&gt;/test.jsp&lt;/result&gt;</div><div class="line">			&lt;interceptor-ref name=&quot;my&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">			&lt;interceptor-ref name=&quot;defaultStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">		&lt;/action&gt;</div><div class="line"></div><div class="line">	&lt;/package&gt;</div></pre></td></tr></table></figure>
<h3 id="8-5-拦截器栈"><a href="#8-5-拦截器栈" class="headerlink" title="8.5 拦截器栈"></a>8.5 拦截器栈</h3><p>当一个Action需要被多个拦截器拦截的时候，正常情况下我们需要在这个Action中去引用要使用的多个拦截器，但是我们可以使用一个拦截器栈去包含那几个拦截器，然后直接在Action中引用这个拦截器栈就可以。</p>
<ul>
<li>一个拦截器栈可以包含多个拦截器</li>
<li>一个拦截器栈还可以包含其他拦截器栈</li>
<li>定义拦截器栈都要在<interceptors>标签中</interceptors></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;interceptors&gt;</div><div class="line">   &lt;interceptor name=&quot;myInterceptor&quot; class=&quot;com.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">   &lt;interceptor-stack name=&quot;myStack&quot;&gt;</div><div class="line">   &lt;!-- 这是我们自己定义的一个拦截器 --&gt;</div><div class="line">      &lt;interceptor-ref name=&quot;myInterceptor&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">     &lt;!-- 这是struts-default.xml文件中定义的一个拦截器 --&gt;</div><div class="line">      &lt;interceptor-ref name=&quot;params&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">     &lt;!-- 这是struts-default.xml文件中定义的一个拦截器栈 --&gt;</div><div class="line">    &lt;interceptor-ref name=&quot;basicStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">   &lt;/interceptor-stack&gt;</div><div class="line">  &lt;/interceptors&gt;</div></pre></td></tr></table></figure>
<h3 id="8-6-默认拦截器栈-拦截器"><a href="#8-6-默认拦截器栈-拦截器" class="headerlink" title="8.6 默认拦截器栈/拦截器"></a>8.6 默认拦截器栈/拦截器</h3><p>在一个package中，我们可以把一个拦截器或者拦截器栈的声明为一个默认的拦截器/拦截器栈。以后这个package中所有的Action都会被这个默认的拦截器/拦截器栈所拦截</p>
<ul>
<li>我们写的任何Action都会被一个叫做defaultStack的拦截器栈所拦截，这个拦截器栈包含了十几个拦截器，这些拦截器给我们的Action提供了很多丰富的功能，因为我们写的所有的package都是直接或者间接继承了struts-default.xml文件中的一个名字叫struts-default的package， struts-default包中又把名字叫做defaultStack的拦截器栈配置成了一个默认的拦截器栈，我们的package继承了这个，所有的Action都会被defaultStack所拦截。</li>
<li>但是如果我们指明了一个Action被我们所写的一个拦截器/拦截器栈所拦截，name这个Action就不会被defaultStack拦截了，所以我们需要在Action中主动的在声明这个Action被defaultStack所拦截，或者把defaultStack加入到我们自己定义的拦截器栈里面。</li>
<li>也可以专门定义一个package专门定义拦截器，拦截器栈，其他package继承这个拦截器栈package：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 在这个package中,我们只定义拦截器/拦截器栈 --&gt;</div><div class="line">    &lt;package name=&quot;MyInter&quot; extends=&quot;struts-default&quot; namespace=&quot;/&quot;&gt;</div><div class="line"></div><div class="line">    &lt;interceptors&gt;</div><div class="line">        &lt;interceptor name=&quot;myInterceptor&quot; class=&quot;com.briup.web.interceptor.MyInterceptor&quot;&gt;&lt;/interceptor&gt;</div><div class="line">        &lt;interceptor-stack name=&quot;myStack&quot;&gt;</div><div class="line">            &lt;interceptor-ref name=&quot;myInterceptor&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">            &lt;!-- 这是struts-default.xml文件中定义的一个拦截器栈 --&gt;</div><div class="line">            &lt;interceptor-ref name=&quot;defaultStack&quot;&gt;&lt;/interceptor-ref&gt;</div><div class="line">        &lt;/interceptor-stack&gt;</div><div class="line">    &lt;/interceptors&gt;</div><div class="line"></div><div class="line">    &lt;!-- 声明默认拦截器/拦截器栈 --&gt;</div><div class="line">    &lt;!-- 当前包中所有的action都会被这个myStack所拦截器 --&gt;</div><div class="line">    &lt;!-- 继承了当前包的其他包里面的所有action也会被这个myStack所拦截器 --&gt;</div><div class="line">    &lt;default-interceptor-ref name=&quot;myStack&quot;&gt;&lt;/default-interceptor-ref&gt;</div><div class="line"></div><div class="line">    &lt;/package&gt;</div></pre></td></tr></table></figure>
<h3 id="8-7-类型转换"><a href="#8-7-类型转换" class="headerlink" title="8.7 类型转换"></a>8.7 类型转换</h3><p>类型转换：解析HTTP请求参数，将HTTP请求参数赋值给Action属性，当其类型不一致时进行的类型转换操作。struts2完成了String和基本类型的类型转换，只要Action属性有get set 方法。同时其还支持自定义的类型转换。</p>
<p>struts2类型转换时通过Params拦截器进行转换的；如果转换失败，则conversionError拦截器拦截该异常，并封装到fieldError中，放入ActionContext中。</p>
<h4 id="8-7-1-基础类型转换："><a href="#8-7-1-基础类型转换：" class="headerlink" title="8.7.1 基础类型转换："></a>8.7.1 基础类型转换：</h4><p>testAction：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">public class TestAction extends ActionSupport&#123;</div><div class="line">    private String name;</div><div class="line">    private int age;</div><div class="line">    private Date d;</div><div class="line">    Set&lt;String&gt; interests;</div><div class="line">    Map&lt;String, String&gt; users;</div><div class="line"></div><div class="line">    public String getName() &#123;</div><div class="line">        return name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setName(String name) &#123;</div><div class="line">        this.name = name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public int getAge() &#123;</div><div class="line">        return age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setAge(int age) &#123;</div><div class="line">        this.age = age;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Date getD() &#123;</div><div class="line">        return d;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setD(Date d) &#123;</div><div class="line">        this.d = d;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Set&lt;String&gt; getInterests() &#123;</div><div class="line">        return interests;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setInterests(Set&lt;String&gt; interests) &#123;</div><div class="line">        this.interests = interests;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Map&lt;String, String&gt; getUsers() &#123;</div><div class="line">        return users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setUsers(Map&lt;String, String&gt; users) &#123;</div><div class="line">        this.users = users;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String execute() throws Exception &#123;</div><div class="line">        return super.execute();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>test.jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">name:&lt;s:property value=&quot;name&quot;/&gt;&lt;br/&gt;</div><div class="line">age:&lt;s:property value=&quot;age&quot;/&gt;&lt;br/&gt;</div><div class="line">date:&lt;s:property value=&quot;d&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:date name=&quot;d&quot; format=&quot;yyyy/MM/dd HH:mm:ss&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;interests&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;users&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h4 id="8-7-2自定义类型转换"><a href="#8-7-2自定义类型转换" class="headerlink" title="8.7.2自定义类型转换"></a>8.7.2自定义类型转换</h4><p>自定义类型转换器方法:</p>
<h5 id="继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换-Sting数组转换到Action属性。函数模板为："><a href="#继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换-Sting数组转换到Action属性。函数模板为：" class="headerlink" title="继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换,Sting数组转换到Action属性。函数模板为："></a>继承DefaultTypeConverter，重写convertValue方法，这个方法的功能是完成双向转换,Sting数组转换到Action属性。函数模板为：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class MyPointConverter extends DefaultTypeConverter&#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Object convertValue(Object value, Class toType) &#123;</div><div class="line">		if(toType == Point.class) &#123;</div><div class="line">			Point p = new Point();</div><div class="line">			String[] strs = (String[])value;</div><div class="line">			String[] xy = strs[0].split(&quot;,&quot;);</div><div class="line">			p.x = Integer.parseInt(xy[0]);</div><div class="line">			p.y = Integer.parseInt(xy[1]);</div><div class="line">			return p;</div><div class="line">		&#125;</div><div class="line">		if(toType == String.class) &#123;</div><div class="line">			return value.toString();</div><div class="line">		&#125;</div><div class="line">		return super.convertValue(value, toType);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="继承StrutsTypeConverter"><a href="#继承StrutsTypeConverter" class="headerlink" title="继承StrutsTypeConverter"></a>继承StrutsTypeConverter</h5><ul>
<li>StrutsTypeConverter是DefaultTypeConverter的子类。在两个方向的类型转换上分别实现：</li>
</ul>
<p>MyPointerConverter:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class MyPointConverter extends StrutsTypeConverter&#123;</div><div class="line">    @Override</div><div class="line">    public Object convertFromString(Map map, String[] strings, Class aClass) &#123;</div><div class="line">        Point point = new Point();</div><div class="line">        String[] strings1 = (String[])strings;</div><div class="line">        String[] xy = strings1[0].split(&quot;,&quot;);</div><div class="line">        point.x = Integer.parseInt(xy[0]);</div><div class="line">        point.y = Integer.parseInt(xy[1]);</div><div class="line">        return point;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String convertToString(Map map, Object o) &#123;</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TestAction:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">public class TestAction extends ActionSupport&#123;</div><div class="line">    Point p;</div><div class="line">    List&lt;Point&gt; ps;</div><div class="line">    Map&lt;String, Point&gt; points;</div><div class="line"></div><div class="line">    public Point getP() &#123;</div><div class="line">        return p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setP(Point p) &#123;</div><div class="line">        this.p = p;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public List&lt;Point&gt; getPs() &#123;</div><div class="line">        return ps;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPs(List&lt;Point&gt; ps) &#123;</div><div class="line">        this.ps = ps;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public Map&lt;String, Point&gt; getPoints() &#123;</div><div class="line">        return points;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setPoints(Map&lt;String, Point&gt; points) &#123;</div><div class="line">        this.points = points;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String execute() throws Exception &#123;</div><div class="line">        return super.execute();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">&lt;s:property value=&quot;p&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;s:property value=&quot;ps&quot;/&gt;&lt;br/&gt;</div><div class="line">points:&lt;s:property value=&quot;points&quot;/&gt;&lt;br/&gt;</div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<h5 id="注册方式："><a href="#注册方式：" class="headerlink" title="注册方式："></a>注册方式：</h5><ul>
<li>第一种配置方法为在具备类型转换文件中配置，局部类型转换文件命名为<code>ActionName-conversion.properties</code>,位置放在特定的Action目录下，文件内容格式为：<code>typeName=ConverClass</code>仅针对特定的Action的特定属性有效</li>
<li>第二种配置方法为全局类型转换文件中红配置，文件名为xwork-conversion.properties,在<code>WEB-INF\classes</code>下，文件内容格式为：<code>attributeName=ConvertClass</code>, 对某个类型都有效，比如对Point类型注册了类型转换器。</li>
<li><p>注解</p>
<h3 id="8-8-拦截器和过滤器的比较"><a href="#8-8-拦截器和过滤器的比较" class="headerlink" title="8.8 拦截器和过滤器的比较"></a>8.8 拦截器和过滤器的比较</h3></li>
<li>相同点：<ul>
<li>都是一种Java类</li>
<li>都能拦截客户端发给服务端的请求</li>
<li>拦截到请求之后都可以做一些相应的处理，最后还可以把这个请求放行</li>
<li>都需要实现各自相应的接口记忆在相应的配置文件中配置</li>
</ul>
</li>
<li><p>不同点：</p>
<ul>
<li>拦截器是Struts2框架中定义的，过滤器是web里面的对象，是J2EE标准定义的</li>
<li>拦截器只会拦截访问Action的请求，过滤器可以拦截所有的请求</li>
<li>拦截器定义在struts.xml文件中，过滤器定义在web.xml中</li>
<li>拦截器对象的创建、调用、销毁时struts2框架负责的，过滤器对象的创建、调用、销毁时服务器负责的。</li>
</ul>
<p><em>我们自己定义的filter也可以拦截struts2框架中的Action，需要在web.xml文件中把我们自己的filter配置在struts2的filter上面才可以，因为web.xml文件中的filter配置的先后顺序控制filter起作用的顺序，如果struts的filter先拦截到访问action的请求后，不会把这个请求交给下面的filter，而是交给它内部的拦截器。如果我们自己的filter拦截到请求之后，还是会交给下一个filter，也就是交给struts2的filter</em></p>
</li>
</ul>
<h2 id="9-注解Annotation"><a href="#9-注解Annotation" class="headerlink" title="9 注解Annotation"></a>9 注解Annotation</h2><h3 id="9-1-注解使用方式"><a href="#9-1-注解使用方式" class="headerlink" title="9.1 注解使用方式"></a>9.1 注解使用方式</h3><ol>
<li>引入支持struts2框架注解开发的jar包 struts2-convention-plugin-2.3.4.1</li>
<li>struts.xml <code>&lt;constant name=&quot;struts.convention.action.suffix&quot; value=&quot;Action&quot;/&gt;</code></li>
<li><p>Struts2使用注解开发需要遵循一定的规范：</p>
<ul>
<li>Action要必须继承ActionSupport父类</li>
<li>Action所在的包名必须以Action结尾</li>
<li>package-info.java <em>在这里配置这个包下所有的类都可以用</em></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> @Namespace(&quot;/&quot;)</div><div class="line">@ParentPackage(&quot;struts-default&quot;)</div><div class="line">@DefaultInterceptorRef(&quot;authStack&quot;)//authStack自定义的拦截器</div><div class="line"> package com.briup.action.manager;</div><div class="line">import org.apache.struts2.convention.annotation.Namespace;</div><div class="line">import org.apache.struts2.convention.annotation.ParentPackage;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="9-2-Action常用注解"><a href="#9-2-Action常用注解" class="headerlink" title="9.2 Action常用注解"></a>9.2 Action常用注解</h3><ul>
<li><p>Namespace Annotation</p>
<ul>
<li>通过在ActionClass上定义@Namespace(“/custom”)</li>
<li>通过package0info.java定义<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@Namespace(&quot;/manager&quot;)</div><div class="line">@ParentPackage(&quot;default&quot;)</div><div class="line">@DefaultInterceptorRef(&quot;authStack&quot;)</div><div class="line">package com.example.actions;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>Action Annotation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1. @Action(interceptorRefs=&#123;</div><div class="line">                @InterceptorRef(&quot;validation&quot;),</div><div class="line">                @InterceptorRef(&quot;defaultStack&quot;)</div><div class="line">            &#125;)</div><div class="line"></div><div class="line">2.      chain</div><div class="line">        @Action(&quot;foo&quot;)</div><div class="line">        public String foo() &#123;</div><div class="line">            return &quot;bar&quot;;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Action(&quot;foo-bar&quot;)</div><div class="line">        public String bar() &#123;</div><div class="line">            return SUCCESS;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>Result Annotation</p>
<ul>
<li>全局， 整个类可以访问</li>
<li>局部， 某个方法可以访问<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> @Results(&#123;</div><div class="line">    @Result(name=&quot;failure&quot;, location=&quot;fail.jsp&quot;)</div><div class="line">&#125;)</div><div class="line">public class HelloWorld extends ActionSupport &#123;</div><div class="line">    @Action(value=&quot;/different/url&quot;,results=&#123;@Result(name=&quot;success&quot;, location=&quot;http://struts.apache.org&quot;, type=&quot;redirect&quot;)&#125;          )</div><div class="line">    public String execute() &#123;</div><div class="line">        return SUCCESS;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p><em>参考：<a href="http://www.jianshu.com/p/a884504a8863" target="_blank" rel="external">http://www.jianshu.com/p/a884504a8863</a></em></p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/struts2总结 六--struts2项目开发流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/struts2总结 六--struts2项目开发流程/" itemprop="url">struts2总结（六）--Struts2项目开发流程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li>建立界面原型</li>
<li>建立struts.XHTML<ul>
<li>确定namespace</li>
<li>确定package</li>
<li>确定Result</li>
<li>将界面原型页面进行修改，匹配现有设置</li>
<li>测试</li>
<li>做好规划</li>
</ul>
</li>
<li>建立数据库</li>
<li>建立Model层</li>
<li>建立Service层<ul>
<li>使用JUnit进行单元测试</li>
</ul>
</li>
<li>开始开发</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/struts2总结 二--Result和OGNL表达式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/struts2总结 二--Result和OGNL表达式/" itemprop="url">struts2总结（二）--Result和OGNL表达式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="4-Result"><a href="#4-Result" class="headerlink" title="4 Result"></a>4 Result</h2><p>Result是Action执行结束之后返回的结果，result包含name和type属性，前者是返回的字符串，后者指定跳转的类型，默认为dispatcher。</p>
<h3 id="4-1-Result常用的四中类型"><a href="#4-1-Result常用的四中类型" class="headerlink" title="4.1 Result常用的四中类型"></a>4.1 Result常用的四中类型</h3><ol>
<li>dispatcher， 从一个Action里面服务器内部跳转到一个页面中, r1–&gt;r1.jsp</li>
<li>chain， 从一个Action里面服务器内部跳转到另一个Action中,r2–&gt;r2.jsp</li>
<li>redirect， 从一个Action里面客户端重定向到一个页面中, r3-&gt;r1-&gt;r1.jsp</li>
<li>redirectAction， 从一个Action里面客户端重定向到另一个Action中, r4-&gt;r2-&gt;r2.jsp<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;struts&gt;</div><div class="line">    &lt;constant name=&quot;struts.devMode&quot; value=&quot;true&quot; /&gt;</div><div class="line">    &lt;package name=&quot;resultTypes&quot; namespace=&quot;/r&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line">	    &lt;action name=&quot;r1&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;dispatcher&quot;&gt;/r1.jsp&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r2&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;redirect&quot;&gt;/r2.jsp&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r3&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;chain&quot;&gt;r1&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;r4&quot;&gt;</div><div class="line">	    	&lt;result type=&quot;redirectAction&quot;&gt;r2&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;</div><div class="line"></div><div class="line">    &lt;/package&gt;</div><div class="line">&lt;/struts&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="4-2-全局结果集"><a href="#4-2-全局结果集" class="headerlink" title="4.2 全局结果集"></a>4.2 全局结果集</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;global-results&gt;</div><div class="line">    		&lt;result name=&quot;mainpage&quot;&gt;/main.jsp&lt;/result&gt;</div><div class="line">&lt;/global-results&gt;</div></pre></td></tr></table></figure>
<p>在其他任何Action中，不需要单独设置，所有返回mainpage字符串的Action会跳转到main.jsp页面。但是如果在某一个Action定义了mainpage字符串的跳转，全局跳转对这个acting失效。action结果集的优先级高于全局结果集。</p>
<h3 id="4-3-动态结果（了解）"><a href="#4-3-动态结果（了解）" class="headerlink" title="4.3 动态结果（了解）"></a>4.3 动态结果（了解）</h3><p>动态结果集表示在struts配置的时候，Action根据类型的不同，动态的决定返回的页面。首先需要在Action中定义两个成员变量，type和r, 其中type用于接收页面传入的参数，r用于保存Action传出的结果。<br>struts.xml为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;struts&gt;</div><div class="line">    &lt;constant name=&quot;struts.devMode&quot; value=&quot;true&quot; /&gt;</div><div class="line">    &lt;package name=&quot;user&quot; namespace=&quot;/user&quot; extends=&quot;struts-default&quot;&gt;</div><div class="line"></div><div class="line">	    &lt;action name=&quot;user&quot; class=&quot;com.bjsxt.struts2.user.action.UserAction&quot;&gt;</div><div class="line">	    	&lt;result&gt;$&#123;r&#125;&lt;/result&gt;</div><div class="line">	    &lt;/action&gt;	    </div><div class="line">    &lt;/package&gt;</div><div class="line"></div><div class="line">&lt;/struts&gt;</div></pre></td></tr></table></figure>
<p>index.jsp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;body&gt;</div><div class="line">动态结果</div><div class="line">一定不要忘了为动态结果的保存值设置set get方法</div><div class="line">&lt;ol&gt;</div><div class="line">	&lt;li&gt;&lt;a href=&quot;user/user?type=1&quot;&gt;返回success&lt;/a&gt;&lt;/li&gt;</div><div class="line">	&lt;li&gt;&lt;a href=&quot;user/user?type=2&quot;&gt;返回error&lt;/a&gt;&lt;/li&gt;</div><div class="line">&lt;/ol&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div></pre></td></tr></table></figure>
<p>UserAction：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public class UserAction extends ActionSupport &#123;</div><div class="line">	private int type;</div><div class="line"></div><div class="line">	private String r;</div><div class="line"></div><div class="line">	public String getR() &#123;</div><div class="line">		return r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setR(String r) &#123;</div><div class="line">		this.r = r;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public int getType() &#123;</div><div class="line">		return type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setType(int type) &#123;</div><div class="line">		this.type = type;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public String execute() throws Exception &#123;</div><div class="line">		if(type == 1) r=&quot;/user_success.jsp&quot;;</div><div class="line">		else if (type == 2) r=&quot;/user_error.jsp&quot;;</div><div class="line">		return &quot;success&quot;;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="4-4-传递参数"><a href="#4-4-传递参数" class="headerlink" title="4.4 传递参数"></a>4.4 传递参数</h3><p>除了request，session，application来向页面传值之外，还可以通过ValueStack和ActionContext。</p>
<ul>
<li>ValueStack是一个接口， <code>ValueStack vs = context.getValueStack()</code>将值从Action传到页面，ActionContext是一个类，<code>ActionContext context = ActionContext.getContext()</code>来传值，在页面中农需要<code>&lt;s:debug /&gt;</code>标签来查看结果。</li>
<li>当Action进行跳转的时候，struts2框架会自动的把这个Action对象本身分别放到ValueStack和ActionContext中去。然后struts2将这两个对象传递给页面，在页面中可以通过这两个对象来拿到之前放进去的值。也可以在Action中拿到这两个对象手动放值:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ActionContext ac = ActionContext.getContext();</div><div class="line">ValueStack vs = ac.getValueStack();</div><div class="line">ac.put(&quot;ac&quot;,&quot;ac&quot;);</div><div class="line">User user = new User()；</div><div class="line">vs.push(user);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="4-4-1-ValueStack"><a href="#4-4-1-ValueStack" class="headerlink" title="4.4.1 ValueStack"></a>4.4.1 ValueStack</h4><ol>
<li>把一个对象放到值栈之后，文名从这个值栈中是拿不到这个对象的，但是文名可以直接拿到这个对象的属性及其属性值。</li>
<li>从值栈中拿值的时候，是从值栈的property name这一列来拿的，拿到的是property value之一列的值。</li>
<li>所以通过值栈来传递参数到页面需要将参数封装到一个对象中，将这个对象放到值栈中。</li>
<li>生命周期为request</li>
<li>创建一个新的值栈对象后，都会把这个对象放到ActionCon中去。</li>
</ol>
<h4 id="4-4-2-ActionContext"><a href="#4-4-2-ActionContext" class="headerlink" title="4.4.2 ActionContext"></a>4.4.2 ActionContext</h4><ol>
<li>向ActionContext中放值的时候是通过k-v的形式存放的，String-Object键值对，取值同样是通过key拿到value。</li>
<li>struts2框架默认向这个对象里面存放的对象很多，包括request，session，application，ValueStack，parameter等</li>
<li>每次请求都会创建一个新的ActionContext对象</li>
</ol>
<h4 id="4-4-3-取值方式"><a href="#4-4-3-取值方式" class="headerlink" title="4.4.3 取值方式"></a>4.4.3 取值方式</h4><ol>
<li><p>jsp内置对象取值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;%=request.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div><div class="line">&lt;%=session.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div><div class="line">&lt;%=application.getAttribute(&quot;name&quot;) %&gt;&lt;br&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>jstl标签+EL表达式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$&#123;requestScope.MyName &#125;&lt;br&gt;</div><div class="line"> $&#123;requestScope.name &#125;  &lt;br&gt;</div><div class="line"> $&#123;sessionScope.MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;applicationScope.MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;MyName &#125;  &lt;br&gt;</div><div class="line"> $&#123;name &#125;  &lt;br&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>struts2标签+OGNL表达式<code>&lt;s:property value=&quot;OGNL&quot;</code></p>
</li>
</ol>
<blockquote>
<ul>
<li><p>从ValueStack中取值：这个value属性的值name,是一个OGNL表达式，表示取一个名字为name的property的值。从ValueStack中取值，如果存在重名的，默认取最上面的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;s:property value=&quot;name&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user.id&quot;/&gt;</div><div class="line">&lt;s:property value=&quot;user.name&quot;/&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>从ActionContext中取值  #</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;s:property value=&quot;#action.name&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#msg&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.id&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.name&quot;/&gt;&lt;br&gt;</div><div class="line"> &lt;s:property value=&quot;#user.age&quot;/&gt;&lt;br&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</blockquote>
<h2 id="5-OGNL表达式"><a href="#5-OGNL表达式" class="headerlink" title="5 OGNL表达式"></a>5 OGNL表达式</h2><p>OGNL:Object-Graph Navigation Language，图对象导航语言，是struts2中默认的表达式语言。</p>
<h3 id="5-1-访问普通方法、属性、构造方法"><a href="#5-1-访问普通方法、属性、构造方法" class="headerlink" title="5.1 访问普通方法、属性、构造方法"></a>5.1 访问普通方法、属性、构造方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问值栈中的action的普通属性: username = &lt;s:property value=&quot;username&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通属性(get set方法)：&lt;s:property value=&quot;user.age&quot;/&gt; | &lt;s:property value=&quot;user[&apos;age&apos;]&quot;/&gt; | &lt;s:property value=&quot;user[\&quot;age\&quot;]&quot;/&gt; | wrong: &lt;%--&lt;s:property value=&quot;user[age]&quot;/&gt;--%&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通属性(get set方法): &lt;s:property value=&quot;cat.friend.name&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通方法：&lt;s:property value=&quot;password.length()&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中对象的普通方法：&lt;s:property value=&quot;cat.miaomiao()&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问值栈中action的普通方法：&lt;s:property value=&quot;m()&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;hr /&gt;</div><div class="line">&lt;li&gt;访问普通类的构造方法：&lt;s:property value=&quot;new com.struts2.ognl.User(8)&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;hr /&gt;</div></pre></td></tr></table></figure>
<h3 id="5-2-访问静态方法、属性"><a href="#5-2-访问静态方法、属性" class="headerlink" title="5.2 访问静态方法、属性"></a>5.2 访问静态方法、属性</h3><p>struts2默认的<code>&lt;constant name=&quot;struts.ognl.allowStaticMethodAccess&quot; value=&quot;true&quot;&gt;&lt;/constant&gt;</code>为false，需要配置成true才可以访问静态方法、属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问静态方法：&lt;s:property value=&quot;@com.struts2.ognl.S@s()&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问静态属性：&lt;s:property value=&quot;@com.struts2.ognl.S@STR&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Math类的静态方法：&lt;s:property value=&quot;@@max(2,3)&quot; /&gt;&lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-3-访问集合元素："><a href="#5-3-访问集合元素：" class="headerlink" title="5.3 访问集合元素："></a>5.3 访问集合元素：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;访问List:&lt;s:property value=&quot;users&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中某个元素:&lt;s:property value=&quot;users[1]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中元素某个属性的集合:&lt;s:property value=&quot;users.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问List中元素某个属性的集合中的特定值:&lt;s:property value=&quot;users.&#123;age&#125;[0]&quot;/&gt; | &lt;s:property value=&quot;users[0].age&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Set:&lt;s:property value=&quot;dogs&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Set中某个元素:&lt;s:property value=&quot;dogs[1]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map:&lt;s:property value=&quot;dogMap&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中某个元素:&lt;s:property value=&quot;dogMap.dog101&quot;/&gt; | &lt;s:property value=&quot;dogMap[&apos;dog101&apos;]&quot;/&gt; | &lt;s:property value=&quot;dogMap[\&quot;dog101\&quot;]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中所有的key:&lt;s:property value=&quot;dogMap.keys&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问Map中所有的value:&lt;s:property value=&quot;dogMap.values&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;访问容器的大小：&lt;s:property value=&quot;dogMap.size()&quot;/&gt; | &lt;s:property value=&quot;users.size&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-4-投影和过滤"><a href="#5-4-投影和过滤" class="headerlink" title="5.4 投影和过滤"></a>5.4 投影和过滤</h3><ul>
<li>“?#”：过滤所有符合条件的集合</li>
<li>“^#”：过滤第一个符合条件的元素</li>
<li>“$#”：过滤最后一个符合条件的元素</li>
<li>返回的是一个集合，可以使用索引取得集合中指定的元素。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;投影(过滤)：&lt;s:property value=&quot;users.&#123;?#this.age==1&#125;[0]&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;^#this.age&gt;1&#125;.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;$#this.age&gt;1&#125;.&#123;age&#125;&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;投影：&lt;s:property value=&quot;users.&#123;$#this.age&gt;1&#125;.&#123;age&#125; == null&quot;/&gt;&lt;/li&gt;</div></pre></td></tr></table></figure>
<h3 id="5-5-区分-和"><a href="#5-5-区分-和" class="headerlink" title="5.5 区分 %{} 和 ${}"></a>5.5 区分 %{} 和 ${}</h3><ul>
<li>%{}<br>%{}的主要作用是告诉标签的处理类将它包含的字符串按照OGNL表达式处理，类似eval函数</li>
<li>${}<br>${}的主要用于两方面：<ul>
<li>用于国际化资源文件中</li>
<li>用于Struts2配置文件中</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/java/struts2总结 三--Struts Tags/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/java/struts2总结 三--Struts Tags/" itemprop="url">struts2总结（三）--Struts Tags</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/Struts2/" itemprop="url" rel="index">
                    <span itemprop="name">Struts2</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="5-Struts-Tags"><a href="#5-Struts-Tags" class="headerlink" title="5 Struts Tags"></a>5 Struts Tags</h2><p>要在jsp中使用Struts2的标签，需要先引入<code>&lt;%@ taglib prefix=&quot;s&quot; uri=&quot;/struts-tags&quot; %&gt;</code></p>
<h3 id="5-1-通用标签"><a href="#5-1-通用标签" class="headerlink" title="5.1 通用标签"></a>5.1 通用标签</h3><ul>
<li><p>property</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;property: &lt;s:property value=&quot;username&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 取值为字符串: &lt;s:property value=&quot;&apos;username&apos;&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 设定默认值: &lt;s:property value=&quot;admin&quot; default=&quot;管理员&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;property 设定HTML: &lt;s:property value=&quot;&apos;&lt;hr/&gt;&apos;&quot; escape=&quot;false&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>set 将某个值放入指定范围内</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;set 设定adminName值（默认为request 和 ActionContext）: &lt;s:set var=&quot;adminName&quot; value=&quot;username&quot; /&gt;&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;set 从request取值: &lt;s:property value=&quot;#request.adminName&quot; /&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 从ActionContext取值: &lt;s:property value=&quot;#adminName&quot; /&gt;&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;%--&lt;li&gt;set 设定范围: &lt;s:set name=&quot;adminPassword&quot; value=&quot;password&quot; scope=&quot;page&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 从相应范围取值: &lt;%=pageContext.getAttribute(&quot;adminPassword&quot;) %&gt;&lt;/li&gt;</div><div class="line">--%&gt;</div><div class="line">&lt;li&gt;set 设定var，范围为ActionContext: &lt;s:set var=&quot;adminPassword&quot; value=&quot;password&quot; scope=&quot;session&quot;/&gt;&lt;/li&gt;</div><div class="line">&lt;li&gt;set 使用#取值: &lt;s:property value=&quot;#adminPassword&quot;/&gt; &lt;/li&gt;</div><div class="line">&lt;li&gt;set 从相应范围取值: &lt;s:property value=&quot;#session.adminPassword&quot;/&gt; &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>bean 实例化一个JavaBean</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;bean 定义bean,并使用param来设定新的属性值:</div><div class="line">        &lt;s:bean name=&quot;com.struts2.tags.Dog&quot; &gt;</div><div class="line">            &lt;s:param name=&quot;name&quot; value=&quot;&apos;pp&apos;&quot;&gt;&lt;/s:param&gt;</div><div class="line">            &lt;s:property value=&quot;name&quot;/&gt;</div><div class="line"></div><div class="line">        &lt;/s:bean&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;bean 查看debug情况:</div><div class="line">        &lt;s:bean name=&quot;com.struts2.tags.Dog&quot; var=&quot;myDog&quot;&gt;</div><div class="line">            &lt;s:param name=&quot;name&quot; value=&quot;&apos;oudy&apos;&quot;&gt;&lt;/s:param&gt;</div><div class="line">        &lt;/s:bean&gt;</div><div class="line">        拿出值：</div><div class="line">        &lt;s:property value=&quot;#myDog.name&quot;/&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>include 将一JSP或者Servlet包含到当前页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;include _include1.html 包含静态英文文件</div><div class="line">       &lt;s:include value=&quot;/_include1.html&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div><div class="line"></div><div class="line">   &lt;li&gt;include _include2.html 包含静态中文文件</div><div class="line">       &lt;s:include value=&quot;/_include2.html&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div><div class="line"></div><div class="line">   &lt;li&gt;include _include1.html 包含静态英文文件，说明%用法</div><div class="line">       &lt;s:set var=&quot;incPage&quot; value=&quot;%&#123;&apos;/_include1.html&apos;&#125;&quot; /&gt;</div><div class="line">       &lt;s:include value=&quot;%&#123;#incPage&#125;&quot;&gt;&lt;/s:include&gt;</div><div class="line">   &lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>param 为其他标签提供参数</p>
</li>
<li>debug 辅助调试，查看值栈等信息<h3 id="5-2-控制标签"><a href="#5-2-控制标签" class="headerlink" title="5.2 控制标签"></a>5.2 控制标签</h3></li>
<li><p>if elseif else 用来控制选择输出的标签</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;if elseif else:</div><div class="line">    age = &lt;s:property value=&quot;#parameters.age[0]&quot; /&gt; &lt;br /&gt;</div><div class="line">    &lt;s:set var=&quot;age&quot; value=&quot;#parameters.age[0]&quot; /&gt;</div><div class="line">    &lt;s:if test=&quot;#age &lt; 0&quot;&gt;wrong age!&lt;/s:if&gt;</div><div class="line">    &lt;s:elseif test=&quot;#parameters.age[0] &lt; 20&quot;&gt;too young!&lt;/s:elseif&gt;</div><div class="line">    &lt;s:else&gt;yeah!&lt;/s:else&gt;&lt;br /&gt;</div><div class="line"></div><div class="line">    &lt;s:if test=&quot;#parameters.aaa == null&quot;&gt;null&lt;/s:if&gt;</div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>iterator 迭代器，用于将集合迭代输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&lt;li&gt;遍历集合：&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;1, 2, 3&#125;&quot; &gt;</div><div class="line">        &lt;s:property/&gt; |</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;自定义变量：&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;&apos;aaa&apos;, &apos;bbb&apos;, &apos;ccc&apos;&#125;&quot; var=&quot;x&quot;&gt;</div><div class="line">        &lt;s:property value=&quot;#x.toUpperCase()&quot;/&gt; |</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line">&lt;li&gt;使用status:&lt;br /&gt;</div><div class="line">    &lt;s:iterator value=&quot;&#123;&apos;aaa&apos;, &apos;bbb&apos;, &apos;ccc&apos;&#125;&quot; status=&quot;status&quot;&gt;</div><div class="line">        &lt;s:property/&gt; |</div><div class="line">        遍历过的元素总数：&lt;s:property value=&quot;#status.count&quot;/&gt; |</div><div class="line">        遍历过的元素索引：&lt;s:property value=&quot;#status.index&quot;/&gt; |</div><div class="line">        当前是偶数？：&lt;s:property value=&quot;#status.even&quot;/&gt; |</div><div class="line">        当前是奇数？：&lt;s:property value=&quot;#status.odd&quot;/&gt; |</div><div class="line">        是第一个元素吗？：&lt;s:property value=&quot;#status.first&quot;/&gt; |</div><div class="line">        是最后一个元素吗？：&lt;s:property value=&quot;#status.last&quot;/&gt;</div><div class="line">        &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line"></div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line">    &lt;s:iterator value=&quot;#&#123;1:&apos;a&apos;, 2:&apos;b&apos;, 3:&apos;c&apos;&#125;&quot; &gt;</div><div class="line">        &lt;s:property value=&quot;key&quot;/&gt; | &lt;s:property value=&quot;value&quot;/&gt; &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line">    &lt;s:iterator value=&quot;#&#123;1:&apos;a&apos;, 2:&apos;b&apos;, 3:&apos;c&apos;&#125;&quot; var=&quot;x&quot;&gt;</div><div class="line">        &lt;s:property value=&quot;#x.key&quot;/&gt; | &lt;s:property value=&quot;#x.value&quot;/&gt; &lt;br /&gt;</div><div class="line">    &lt;/s:iterator&gt;</div><div class="line">&lt;/li&gt;</div><div class="line"></div><div class="line">&lt;li&gt;</div><div class="line"></div><div class="line">    &lt;s:fielderror fieldName=&quot;fielderror.test&quot; theme=&quot;simple&quot;&gt;&lt;/s:fielderror&gt;</div><div class="line"></div><div class="line">&lt;/li&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>subset 用于截取集合的部分元素，形成新的子集合</p>
<h3 id="5-3-UI标签"><a href="#5-3-UI标签" class="headerlink" title="5.3 UI标签"></a>5.3 UI标签</h3><p>Struts2中一共定义了4个主题，simple， XHTML（默认）， css_xhtml, ajax.</p>
<h3 id="5-4-AJAX标签"><a href="#5-4-AJAX标签" class="headerlink" title="5.4 AJAX标签"></a>5.4 AJAX标签</h3><p>后续可以查</p>
<h3 id="5-5-的区别"><a href="#5-5-的区别" class="headerlink" title="5.5 $ # % 的区别"></a>5.5 $ # % 的区别</h3></li>
<li><p>$用于i18n和struts配置文件</p>
</li>
<li>#取得ActionContext的值</li>
<li>%将原本的文本属性解析为OGNL，对本来是OGNL的属性不起作用</li>
</ul>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p>这部分用的不多，所以存了几个相关的比较全的博客地址，方便需要的时候去学习:<br><a href="http://blog.csdn.net/liujiahan629629/article/details/39274997" target="_blank" rel="external">Struts2标签小结</a><br><a href="http://www.cnblogs.com/lihuiyy/archive/2012/04/09/2439509.html" target="_blank" rel="external">UI标签</a><br><a href="http://blog.csdn.net/zklxuankai/article/details/8468815" target="_blank" rel="external">AJAX标签</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">99</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
