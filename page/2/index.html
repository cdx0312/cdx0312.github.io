<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/13/golang/源码解读/sync/mutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/13/golang/源码解读/sync/mutex/" itemprop="url">go源码解读-sync.Mutex</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-13T10:10:06+08:00">
                2020-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h2><ul>
<li>sync包提供了互斥量，Once, WaitGroup来保证多线程并发安全</li>
<li>比较简单的同步通过sync包，比较复杂的同步建议通过channel来实现</li>
</ul>
<h3 id="Mutex结构体"><a href="#Mutex结构体" class="headerlink" title="Mutex结构体"></a>Mutex结构体</h3><ul>
<li>Mutex实际上是互斥锁</li>
<li>Mutex的初始化状态就是一个没加锁的互斥锁</li>
<li>Mutex在被加锁之后不允许被复制，也就是带有状态的Mutex不能被复制，否则会给原来的临界数据复制出一把锁</li>
<li>Mutex包含两个字段<ul>
<li>state</li>
<li>sema</li>
</ul>
</li>
<li>Mutex现在有两种状态，normal和starvation<ul>
<li>normal状态下，goroutine是在一个FIFO的队列中排队等待锁的，也就是按照锁的请求时间依次获取锁。但是被唤醒的goroutine并不会立刻拥有mutex，而是需要与新到达的goroutine进行竞争，由于新到达的goroutine已经加载在内存中，所以被唤醒的goroutine大概率会竞争失败，竞争失败之后被唤醒的goroutine会被防止到FIFO的队首。如果一个被唤醒的goroutine在1ms内获取mutex失败，则mutex状态设置为starvation</li>
<li>starvation状态下，mutex在被当前持有的线程解锁之后，FIFO队列首的goroutine被唤醒并直接拥有改mutex，新到达的goroutine不再尝试获取mutex,也不再自选等待获取锁，而是直接排到队列的队尾</li>
<li>如果一个goroutine获取到mutex，如果这个goroutine是队列中的最后一个goroutine或者goroutine等待时间小于1ms，则mutex状态变为noraml状态</li>
<li>normal状态下性能更好，starvation状态下更加公平，不存在插队和多次获取的情况</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</div><div class="line">	state <span class="keyword">int32</span></div><div class="line">	sema  <span class="keyword">uint32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span>      <span class="comment">// 锁定状态 001</span></div><div class="line">	mutexWoken                   <span class="comment">// 唤醒状态 010</span></div><div class="line">	mutexStarving                <span class="comment">// 饥饿状态 100</span></div><div class="line">	mutexWaiterShift = <span class="literal">iota</span>      <span class="comment">// 向右偏移3位之后的值记录等待该mutex的goroutine数量</span></div><div class="line">	starvationThresholdNs = <span class="number">1e6</span>  <span class="comment">// normal到starvation状态的阈值 1ms</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="Mutex实现了Locker接口"><a href="#Mutex实现了Locker接口" class="headerlink" title="Mutex实现了Locker接口"></a>Mutex实现了Locker接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Locker <span class="keyword">interface</span> &#123;</div><div class="line">	Lock()</div><div class="line">	Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>lock方法对mutex加锁</li>
<li>如果mutex已经被加锁，尝试加锁的goroutine将会被阻塞直到获取到该锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 如果mutex没有被加过锁,则用原子方法CAS修改mutex的状态为mutexLocked，直接返回结果即可</span></div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</div><div class="line">		<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">			race.Acquire(unsafe.Pointer(m))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> waitStartTime <span class="keyword">int64</span></div><div class="line">	starving := <span class="literal">false</span></div><div class="line">	awoke := <span class="literal">false</span></div><div class="line">	iter := <span class="number">0</span></div><div class="line">	old := m.state</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 如果当前mutex的状态为starvation，则当前线程不再自旋等待mutex</span></div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</div><div class="line">			<span class="comment">// Active spinning makes sense.</span></div><div class="line">			<span class="comment">// Try to set mutexWoken flag to inform Unlock</span></div><div class="line">			<span class="comment">// to not wake other blocked goroutines.</span></div><div class="line">      <span class="comment">// awork为false,mutex为非awoke状态，有等待状态的goroutine且CAS更改awoke位成功，则将awoke设置为true</span></div><div class="line">			<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</div><div class="line">				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</div><div class="line">				awoke = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">      <span class="comment">// 实际的自旋等待操作，更新iter和old的值</span></div><div class="line">			runtime_doSpin()</div><div class="line">			iter++</div><div class="line">			old = m.state</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="built_in">new</span> := old</div><div class="line">    <span class="comment">// 如果mutex为starvation状态的话，当前的goroutine需要去队列中排队</span></div><div class="line">		<span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexLocked</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 当前goroutine为starvation状态并且为非锁定状态，设置mutex状态为starvation</span></div><div class="line">		<span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexStarving</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// awoke为true,在等待队列中唤醒一个goroutine</span></div><div class="line">		<span class="keyword">if</span> awoke &#123;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</div><div class="line">				throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">new</span> &amp;^= mutexWoken</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 将新的mutex状态值通过CAS复制给state</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">      <span class="comment">// 如果old的状态为000，则直接退出，已经完成了上锁操作</span></div><div class="line">			<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// If we were already waiting before, queue at the front of the queue.</span></div><div class="line">			queueLifo := waitStartTime != <span class="number">0</span></div><div class="line">			<span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</div><div class="line">				waitStartTime = runtime_nanotime()</div><div class="line">			&#125;</div><div class="line">      <span class="comment">// 阻塞获取mutex，这个地方会一直阻塞，直到获取到mutex锁</span></div><div class="line">			runtime_SemacquireMutex(&amp;m.sema, queueLifo)</div><div class="line">      <span class="comment">// 获取到锁之后，根据获取锁的等待时间，设置mutex的运行状态是否为starvation</span></div><div class="line">			starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</div><div class="line">			old = m.state</div><div class="line">      <span class="comment">// 设置mutex的starvation状态</span></div><div class="line">			<span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</div><div class="line">					throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">				&#125;</div><div class="line">				delta := <span class="keyword">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</div><div class="line">				<span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</div><div class="line">					delta -= mutexStarving</div><div class="line">				&#125;</div><div class="line">				atomic.AddInt32(&amp;m.state, delta)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			awoke = <span class="literal">true</span></div><div class="line">			iter = <span class="number">0</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Acquire(unsafe.Pointer(m))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// runtime包中的，返回当前时刻自旋等待是否有意义</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runtime_canSpin</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span></div></pre></td></tr></table></figure>
<ul>
<li>Unlock完成解锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 快速解锁</span></div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = m.state</div><div class="line">		race.Release(unsafe.Pointer(m))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 快速重置mutexLocked位置为0，完成之后很可能被其他goroutine抢走锁</span></div><div class="line">	<span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</div><div class="line">		throw(<span class="string">"sync: unlock of unlocked mutex"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果mutex为normal状态，走stravtion分支即可</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">		old := <span class="built_in">new</span></div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">      <span class="comment">// 如果没有等待的goroutine，直接返回即可</span></div><div class="line">			<span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 有等待的goroutine，则会减少等待数量并且唤醒一个goroutine进行竞争mutex</span></div><div class="line">			<span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</div><div class="line">			<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">				runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// starvation分支直接将mutex交给FIFO队列首部的goroutine</span></div><div class="line">    <span class="comment">// 通过runtime_Semrelease唤醒等待的goroutine</span></div><div class="line">		runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/goroutine&channel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/goroutine&channel/" itemprop="url">goroutine&channel学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T17:37:17+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="goroutine-amp-channel"><a href="#goroutine-amp-channel" class="headerlink" title="goroutine &amp; channel"></a>goroutine &amp; channel</h2><ul>
<li>不需要共享内存来通信，而是通过通信来共享内存。</li>
</ul>
<h3 id="1-channel关键的概念总结"><a href="#1-channel关键的概念总结" class="headerlink" title="1. channel关键的概念总结"></a>1. channel关键的概念总结</h3><ul>
<li>通道（channel），就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。 数据的所有权（可以读写数据的能力）也因此被传递。</li>
<li>channel零值nil</li>
<li>channel只能传递一种类型的数据</li>
<li>channel实际上是类型化消息的队列，使数据得以传输。它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</li>
<li>channel是引用类型，make来初始化 <code>ch1 := make(chan string)</code></li>
<li>通信操作符<code>&lt;-</code><ul>
<li><code>ch &lt;-int1</code> 写入</li>
<li><code>int2 := &lt;- ch</code> 写出</li>
<li><code>&lt;-ch</code> 写出</li>
</ul>
</li>
<li><p>channel的收发都是原子操作</p>
</li>
<li><p>channel默认是同步且无缓冲的：接收者接收数据之前，发送不会结束。channel的发送和接收操作都是在对方准备好之前是阻塞的</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump(ch1)       <span class="comment">// pump hangs</span></div><div class="line">    fmt.Println(&lt;-ch1) <span class="comment">// prints only 0</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 0</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-通过channel进行协程同步"><a href="#2-通过channel进行协程同步" class="headerlink" title="2. 通过channel进行协程同步"></a>2. 通过channel进行协程同步</h3><pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Println(&lt;-in)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    out &lt;- <span class="number">2</span></div><div class="line">    <span class="keyword">go</span> f1(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h3 id="3-channel可以用来完成协程间的通信"><a href="#3-channel可以用来完成协程间的通信" class="headerlink" title="3. channel可以用来完成协程间的通信"></a>3. channel可以用来完成协程间的通信</h3><ul>
<li><code>ch1 := make(chan string, buf)</code> buf为个数</li>
<li>在缓冲满载之前，给通道发送数据是不会被阻塞的</li>
<li>在缓冲空之前，读取是不会阻塞的</li>
<li>协程通过在channel中放置一个值来发出处理结束的信号</li>
<li><p>信号量是实现互斥锁常见的同步机制</p>
<ul>
<li>带缓冲通道的容量和要同步的资源容量相同</li>
<li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li>
<li><p>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    stream := pump()</div><div class="line">    <span class="keyword">go</span> suck(stream)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(&lt;-ch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>channel可以用for关键字循环</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    suck(pump())</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>channel可以指定数据流动方向</p>
<ul>
<li>只接收：<code>var recv_noly &lt;-chan int</code></li>
<li>只发送：<code>var send_only chan&lt;- int</code></li>
</ul>
</li>
<li><p>channel关闭 <code>defer close(ch)</code></p>
</li>
<li><p>使用select切换协程,select 被称为通信开关,select可以处理多个通信中的一个</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump1(ch1)</div><div class="line">    <span class="keyword">go</span> pump2(ch2)</div><div class="line">    <span class="keyword">go</span> suck(ch1, ch2)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i * <span class="number">2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i + <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch1, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch1:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 1: %d\n"</span>, v)</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch2:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 2: %d\n"</span>, v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>goroutine recover机制，保证一个协程出错会继续执行其他的协程</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(workChan &lt;-<span class="keyword">chan</span> *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> work := <span class="keyword">range</span> workChan &#123;</div><div class="line">        <span class="keyword">go</span> safelyDo(work)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">safelyDo</span><span class="params">(work *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err := revocer(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">""</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    do(work)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4-channel通信方式和传统共享内存方式的对比"><a href="#4-channel通信方式和传统共享内存方式的对比" class="headerlink" title="4. channel通信方式和传统共享内存方式的对比"></a>4. channel通信方式和传统共享内存方式的对比</h2><ul>
<li>使用共享内存来进行同步：<ul>
<li>首先定义一个结构体处理一个任务</li>
<li>各个任务组成任务池来共享内存，引入锁机制</li>
<li>任务数量巨大，则锁机制的开销会导致效率急剧下降</li>
</ul>
</li>
<li><p>channel方式</p>
<ul>
<li>使用一个通道接受需要处理的任务，一个通道接受处理完成的任务及其结果。worker在协程中启动，数量N可以调整</li>
<li>不使用锁的机制，因为从通道获取到新任务不存在竞争关系</li>
<li><p>我理解实际上锁机制是实现在了channel中，一个channel的获取是原子性的，从而提高性能</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Worker的写法, Master -&gt; Workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;- in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用锁的情景：</p>
<ul>
<li>访问共享数据结构中的缓存信息</li>
<li>保存应用程序上下文和状态信息数据</li>
</ul>
</li>
<li>使用通道的情景<ul>
<li>与异步操作的结果进行交互</li>
<li>分发任务</li>
<li>传递数据所有权</li>
</ul>
</li>
</ul>
<h2 id="5-int-channel实现惰性生成器"><a href="#5-int-channel实现惰性生成器" class="headerlink" title="5. int channel实现惰性生成器"></a>5. int channel实现惰性生成器</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> resume <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">integers</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    yield := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    count := <span class="number">0</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            yield &lt;- count</div><div class="line">            count++</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> yield</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateInteger</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    resume = integers()</div><div class="line">    <span class="keyword">return</span> &lt;- resume</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>使用空接口，闭包和高阶函数可以实现一个通用的惰性生产期的工厂函数</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> EvalFunc <span class="function"><span class="keyword">func</span><span class="params">(Any)</span> <span class="params">(Any, Any)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">BuildLazyEvaluator</span><span class="params">(evalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">    retValChan := <span class="built_in">make</span>(<span class="keyword">chan</span> Any)</div><div class="line">    loopFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">var</span> actState Any = initState</div><div class="line">        <span class="keyword">var</span> retVal</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            retVal, actState = evalFunc(actState)</div><div class="line">            retValChan &lt;- retVal</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    retFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> &lt;- retValChan</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> loopFunc()</div><div class="line">    <span class="keyword">return</span> retFunc</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildLazyIntEvaluator</span><span class="params">(evalFunc EvalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    ef := BuildLazyIntEvaluator(evalFunc, initState)</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> ef().(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    evenFunc := <span class="function"><span class="keyword">func</span><span class="params">(state Any)</span> <span class="params">(Any, Any)</span></span> &#123;</div><div class="line">        os := state.(<span class="keyword">int</span>)</div><div class="line">        ns := os + <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> os, ns</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    even := BuildLazyIntEvaluator(evenFunc, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        fmt.</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-带缓冲的channel可以用于降频"><a href="#6-带缓冲的channel可以用于降频" class="headerlink" title="6. 带缓冲的channel可以用于降频"></a>6. 带缓冲的channel可以用于降频</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line"><span class="comment">//    ...</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">    process(r)</div><div class="line">    &lt;- sem</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        request := &lt;- service</div><div class="line">        <span class="keyword">go</span> handler(request)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>链式协程，海量协程的创建和运行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ngoroutine = flag.Int(<span class="string">"n"</span>, <span class="number">100000</span>, <span class="string">"how many goroutines"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;- right</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">var</span> left, right <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="literal">nil</span>, leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *ngoroutine; i++ &#123;</div><div class="line">        left, right = right, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">    &#125;</div><div class="line">    right &lt;- <span class="number">0</span></div><div class="line">    x := &lt;-leftmost</div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="并行化大量数据的计算"><a href="#并行化大量数据的计算" class="headerlink" title="并行化大量数据的计算"></a>并行化大量数据的计算</h2><ul>
<li><p>串行处理流水线</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SerialProcessData</span><span class="params">(in &lt;- <span class="keyword">chan</span> *Data, out <span class="keyword">chan</span> &lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> in &#123;</div><div class="line">        tmpA := PreproceeData(data)</div><div class="line">        tmpB := ProcessStepA(tmpA)</div><div class="line">        tmpC := ProcessStepB(tmpB)</div><div class="line">        out &lt;- PostProcessData(tmpC)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>并行计算</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParallelProcessData</span><span class="params">(in &lt;-<span class="keyword">chan</span> *Data, out <span class="keyword">chan</span>&lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="comment">// make channels:</span></div><div class="line">    preOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepAOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepBOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepCOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    <span class="comment">// start parallel computations:</span></div><div class="line">    <span class="keyword">go</span> PreprocessData(in, preOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepA(preOut,StepAOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepB(StepAOut,StepBOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepC(StepBOut,StepCOut)</div><div class="line">    <span class="keyword">go</span> PostProcessData(StepCOut,out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="8-使用channel并发访问对象"><a href="#8-使用channel并发访问对象" class="headerlink" title="8. 使用channel并发访问对象"></a>8. 使用channel并发访问对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name   <span class="keyword">string</span></div><div class="line">	salary <span class="keyword">float64</span></div><div class="line">	chF    <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, salary <span class="keyword">float64</span>)</span> *<span class="title">Person</span></span> &#123;</div><div class="line">	p := &amp;Person&#123;name, salary, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>)&#125;</span></div><div class="line"><span class="function">	<span class="title">go</span> <span class="title">p</span>.<span class="title">backend</span><span class="params">()</span></span></div><div class="line"><span class="function">	<span class="title">return</span> <span class="title">p</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(p *Person)</span> <span class="title">backend</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> f := <span class="keyword">range</span> p.chF &#123;</div><div class="line">		f()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">SetSalary</span><span class="params">(sal <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; p.salary = sal &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Retrieve salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Salary</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	fChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">float64</span>)</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fChan &lt;- p.salary &#125;</div><div class="line">	<span class="keyword">return</span> &lt;-fChan</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"Person - name is: "</span> + p.Name + <span class="string">" - salary is: "</span> + strconv.FormatFloat(p.Salary(), <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">64</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	bs := NewPerson(<span class="string">"Smith Bill"</span>, <span class="number">2500.5</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">	bs.SetSalary(<span class="number">4000.25</span>)</div><div class="line">	fmt.Println(<span class="string">"Salary changed:"</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/go-interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/go-interface/" itemprop="url">golang interface学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T17:36:31+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>go中的接口使用隐式实现的</li>
<li>LSP里式替换-一个类型可以自由的使用另一个满足相同接口的类型来进行替换</li>
<li>接口类型具体描述了一系列方法的集合，一个实现了这些方法的具体类型时这个接口类型的实例</li>
<li><p>go标准库存在大量的单方法接口的命名习惯</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io</div><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</div><div class="line">    Close() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接口内嵌，关注的是内嵌的方法，和组合的设计模式思想类似</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReadWriterCloser <span class="keyword">interface</span> &#123;</div><div class="line">    Reader</div><div class="line">    Writer</div><div class="line">    Closer</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>一个类型持有一个方法，对于一个具体类型T，其一些方法的接收者可以是T也可以是T的指针，是因为比那一起隐式的获取了变量的地址。但是实际上T类型的值是不拥有所有*T指针的方法，这样就可能其实现更少的接口</p>
<ul>
<li><p>IntSet类型的String方法的接收者是一个指针类型，则不能在一个不能寻址的IntSet值上调用这个方法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">type IntSet struct &#123;/* ... */&#125;</div><div class="line">func (*IntSet) String() string</div><div class="line">var _ = IntSet&#123;&#125;.String() // compile error : String requires *IntSet receiver</div></pre></td></tr></table></figure>
</li>
<li><p>但是可以在一个IntSet值上调用这个方法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var s IntSet</div><div class="line">var _ = s.String() // ok</div></pre></td></tr></table></figure>
</li>
<li><p>同时只有IntSet类型有String类型，也只有IntSet类型实现了fmt.Stringer接口</p>
</li>
</ul>
</li>
<li><p>接口类型封装和隐藏了具体类型和它的值，及时具体类型有其他方法也只有接口类型暴露出来的方法会被调用，也就是说一个具体的类型可以实现很多的接口，在调用的时候看持有这个变量的类型时哪个接口，就可以调用该接口的方法，而其他接口在该类型中实现的方法是被隐藏的。</p>
</li>
<li><p>空接口interface{}可以承接任意的值</p>
</li>
<li><p>每一个具体类型的组基于他们相同的行为可以表示成一个接口类型，不需要修改具体类型的定义，这个地方感觉还是组合的思想</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 出售数字文化产品如音乐，书籍，电影等</span></div><div class="line"><span class="keyword">type</span> Artifact <span class="keyword">interface</span> &#123;</div><div class="line">    Title() <span class="keyword">string</span></div><div class="line">    Creator() []<span class="keyword">string</span></div><div class="line">    Created() time.Time</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Text <span class="keyword">interface</span> &#123;</div><div class="line">    Pages() <span class="keyword">int</span></div><div class="line">    Words() <span class="keyword">int</span></div><div class="line">    PageSize() <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Audio <span class="keyword">interface</span> &#123;</div><div class="line">    Stream() (io.Readerclose, error)</div><div class="line">    RunningTime() time.Duration</div><div class="line">    Format() <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Video <span class="keyword">interface</span> &#123;</div><div class="line">    Stream() (io.ReadCloser, error)</div><div class="line">    RunningTime() time.Duration</div><div class="line">    Format() <span class="keyword">string</span></div><div class="line">    Resolution() (x, y <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="flag-Value接口"><a href="#flag-Value接口" class="headerlink" title="flag.Value接口"></a>flag.Value接口</h2><h3 id="flag-Duration方法"><a href="#flag-Duration方法" class="headerlink" title="flag.Duration方法"></a>flag.Duration方法</h3><ul>
<li>flag可以为程序预设命令行参数，会有一个参数缺省默认值</li>
<li>flag.Duration函数创建一个time.Duration类型的标记变量并且允许用户通过多种用户友好的方式来设置这个值的大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> period = flag.Duration(<span class="string">"period"</span>, <span class="number">1</span> * time.Second, <span class="string">"Sleep duration"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	fmt.Printf(<span class="string">"Sleeping for %v..."</span>, *period)</div><div class="line">	time.Sleep(*period)</div><div class="line">	fmt.Println(<span class="string">"end"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>首先看flag.Duration方法，返回的是一个地址指着</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Duration</span><span class="params">(name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span> *<span class="title">time</span>.<span class="title">Duration</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> CommandLine.Duration(name, value, usage)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>然后看CommandLine的结构体和其Duration方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> CommandLine = NewFlagSet(os.Args[<span class="number">0</span>], ExitOnError)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFlagSet</span><span class="params">(name <span class="keyword">string</span>, errorHandling ErrorHandling)</span> *<span class="title">FlagSet</span></span> &#123;</div><div class="line">	f := &amp;FlagSet&#123;</div><div class="line">		name:          name,</div><div class="line">		errorHandling: errorHandling,</div><div class="line">	&#125;</div><div class="line">	f.Usage = f.defaultUsage</div><div class="line">	<span class="keyword">return</span> f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Duration</span><span class="params">(name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span> *<span class="title">time</span>.<span class="title">Duration</span></span> &#123;</div><div class="line">	p := <span class="built_in">new</span>(time.Duration)</div><div class="line">	f.DurationVar(p, name, value, usage)</div><div class="line">	<span class="keyword">return</span> p</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">DurationVar</span><span class="params">(p *time.Duration, name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	f.Var(newDurationValue(value, p), name, usage)</div><div class="line">&#125;</div><div class="line"><span class="comment">// 真正实现值注入的地方</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Var</span><span class="params">(value Value, name <span class="keyword">string</span>, usage <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// Remember the default value as a string; it won't change.</span></div><div class="line">	flag := &amp;Flag&#123;name, usage, value, value.String()&#125;</div><div class="line">	_, alreadythere := f.formal[name]</div><div class="line">	<span class="keyword">if</span> alreadythere &#123;</div><div class="line">		<span class="keyword">var</span> msg <span class="keyword">string</span></div><div class="line">		<span class="keyword">if</span> f.name == <span class="string">""</span> &#123;</div><div class="line">			msg = fmt.Sprintf(<span class="string">"flag redefined: %s"</span>, name)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			msg = fmt.Sprintf(<span class="string">"%s flag redefined: %s"</span>, f.name, name)</div><div class="line">		&#125;</div><div class="line">		fmt.Fprintln(f.Output(), msg)</div><div class="line">		<span class="built_in">panic</span>(msg) <span class="comment">// Happens only if flags are declared with identical names</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> f.formal == <span class="literal">nil</span> &#123;</div><div class="line">		f.formal = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Flag)</div><div class="line">	&#125;</div><div class="line">	f.formal[name] = flag</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上所有的Flag值保存在FlagSet结构体中的formal（map[string] *Flag）中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FlagSet <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Usage is the function called when an error occurs while parsing flags.</span></div><div class="line">	Usage <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">	<span class="title">name</span>          <span class="title">string</span></span></div><div class="line"><span class="function">	<span class="title">parsed</span>        <span class="title">bool</span></span></div><div class="line"><span class="function">	<span class="title">actual</span>        <span class="title">map</span>[<span class="title">string</span>]*<span class="title">Flag</span></span></div><div class="line"><span class="function">	<span class="title">formal</span>        <span class="title">map</span>[<span class="title">string</span>]*<span class="title">Flag</span></span></div><div class="line"><span class="function">	<span class="title">args</span>          []<span class="title">string</span> // <span class="title">arguments</span> <span class="title">after</span> <span class="title">flags</span></span></div><div class="line"><span class="function">	<span class="title">errorHandling</span> <span class="title">ErrorHandling</span></span></div><div class="line"><span class="function">	<span class="title">output</span>        <span class="title">io</span>.<span class="title">Writer</span> // <span class="title">nil</span> <span class="title">means</span> <span class="title">stderr</span>; <span class="title">use</span> <span class="title">out</span><span class="params">()</span> <span class="title">accessor</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">// <span class="title">A</span> <span class="title">Flag</span> <span class="title">represents</span> <span class="title">the</span> <span class="title">state</span> <span class="title">of</span> <span class="title">a</span> <span class="title">flag</span>.</span></div><div class="line"><span class="function"><span class="title">type</span> <span class="title">Flag</span> <span class="title">struct</span></span> &#123;</div><div class="line">	Name     <span class="keyword">string</span> <span class="comment">// name as it appears on command line</span></div><div class="line">	Usage    <span class="keyword">string</span> <span class="comment">// help message</span></div><div class="line">	Value    Value  <span class="comment">// value as set</span></div><div class="line">	DefValue <span class="keyword">string</span> <span class="comment">// default value (as text); for usage message</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Value is the interface to the dynamic value stored in a flag.</span></div><div class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span> &#123;</div><div class="line">	String() <span class="keyword">string</span></div><div class="line">	Set(<span class="keyword">string</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="flag-Parse-方法"><a href="#flag-Parse-方法" class="headerlink" title="flag.Parse()方法"></a>flag.Parse()方法</h3><ul>
<li>首先看Parse()方法的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Ignore errors; CommandLine is set for ExitOnError.</span></div><div class="line">	CommandLine.Parse(os.Args[<span class="number">1</span>:])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// flags初始化默认值之后，flag值使用之前，实际上是从命令行读取参数值对默认值进行覆盖操作</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Parse</span><span class="params">(arguments []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	f.parsed = <span class="literal">true</span></div><div class="line">	f.args = arguments</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		seen, err := f.parseOne()</div><div class="line">		<span class="keyword">if</span> seen &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">switch</span> f.errorHandling &#123;</div><div class="line">		<span class="keyword">case</span> ContinueOnError:</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		<span class="keyword">case</span> ExitOnError:</div><div class="line">			os.Exit(<span class="number">2</span>)</div><div class="line">		<span class="keyword">case</span> PanicOnError:</div><div class="line">			<span class="built_in">panic</span>(err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">parseOne</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(f.args) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	s := f.args[<span class="number">0</span>]</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">2</span> || s[<span class="number">0</span>] != <span class="string">'-'</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	numMinuses := <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> s[<span class="number">1</span>] == <span class="string">'-'</span> &#123;</div><div class="line">		numMinuses++</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">2</span> &#123; <span class="comment">// "--" terminates the flags</span></div><div class="line">			f.args = f.args[<span class="number">1</span>:]</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	name := s[numMinuses:]</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> || name[<span class="number">0</span>] == <span class="string">'-'</span> || name[<span class="number">0</span>] == <span class="string">'='</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"bad flag syntax: %s"</span>, s)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// it's a flag. does it have an argument?</span></div><div class="line">	f.args = f.args[<span class="number">1</span>:]</div><div class="line">	hasValue := <span class="literal">false</span></div><div class="line">	value := <span class="string">""</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(name); i++ &#123; <span class="comment">// equals cannot be first</span></div><div class="line">		<span class="keyword">if</span> name[i] == <span class="string">'='</span> &#123;</div><div class="line">			value = name[i+<span class="number">1</span>:]</div><div class="line">			hasValue = <span class="literal">true</span></div><div class="line">			name = name[<span class="number">0</span>:i]</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	m := f.formal</div><div class="line">	flag, alreadythere := m[name] <span class="comment">// BUG</span></div><div class="line">	<span class="keyword">if</span> !alreadythere &#123;</div><div class="line">		<span class="keyword">if</span> name == <span class="string">"help"</span> || name == <span class="string">"h"</span> &#123; <span class="comment">// special case for nice help message.</span></div><div class="line">			f.usage()</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, ErrHelp</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"flag provided but not defined: -%s"</span>, name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> fv, ok := flag.Value.(boolFlag); ok &amp;&amp; fv.IsBoolFlag() &#123; <span class="comment">// special case: doesn't need an arg</span></div><div class="line">		<span class="keyword">if</span> hasValue &#123;</div><div class="line">			<span class="keyword">if</span> err := fv.Set(value); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid boolean value %q for -%s: %v"</span>, value, name, err)</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := fv.Set(<span class="string">"true"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid boolean flag %s: %v"</span>, name, err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// It must have a value, which might be the next argument.</span></div><div class="line">		<span class="comment">// 在这里进行解析替换</span></div><div class="line">		<span class="keyword">if</span> !hasValue &amp;&amp; <span class="built_in">len</span>(f.args) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// value is the next arg</span></div><div class="line">			hasValue = <span class="literal">true</span></div><div class="line">			value, f.args = f.args[<span class="number">0</span>], f.args[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !hasValue &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"flag needs an argument: -%s"</span>, name)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// set设置</span></div><div class="line">		<span class="keyword">if</span> err := flag.Value.Set(value); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid value %q for flag -%s: %v"</span>, value, name, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> f.actual == <span class="literal">nil</span> &#123;</div><div class="line">		f.actual = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Flag)</div><div class="line">	&#125;</div><div class="line">	f.actual[name] = flag</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Duration的Set方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *durationValue)</span> <span class="title">Set</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	v, err := time.ParseDuration(s)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		err = errParse</div><div class="line">	&#125;</div><div class="line">	*d = durationValue(v)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseDuration</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(Duration, error)</span></span> &#123;</div><div class="line">	<span class="comment">// [-+]?([0-9]*(\.[0-9]*)?[a-z]+)+</span></div><div class="line">	orig := s</div><div class="line">	<span class="keyword">var</span> d <span class="keyword">int64</span></div><div class="line">	neg := <span class="literal">false</span></div><div class="line"></div><div class="line">	<span class="comment">// Consume [-+]?</span></div><div class="line">	<span class="keyword">if</span> s != <span class="string">""</span> &#123;</div><div class="line">		c := s[<span class="number">0</span>]</div><div class="line">		<span class="keyword">if</span> c == <span class="string">'-'</span> || c == <span class="string">'+'</span> &#123;</div><div class="line">			neg = c == <span class="string">'-'</span></div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Special case: if all that is left is "0", this is zero.</span></div><div class="line">	<span class="keyword">if</span> s == <span class="string">"0"</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> s != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">var</span> (</div><div class="line">			v, f  <span class="keyword">int64</span>       <span class="comment">// integers before, after decimal point</span></div><div class="line">			scale <span class="keyword">float64</span> = <span class="number">1</span> <span class="comment">// value = v + f/scale</span></div><div class="line">		)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">		<span class="comment">// The next character must be [0-9.]</span></div><div class="line">		<span class="keyword">if</span> !(s[<span class="number">0</span>] == <span class="string">'.'</span> || <span class="string">'0'</span> &lt;= s[<span class="number">0</span>] &amp;&amp; s[<span class="number">0</span>] &lt;= <span class="string">'9'</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Consume [0-9]*</span></div><div class="line">		pl := <span class="built_in">len</span>(s)</div><div class="line">		v, s, err = leadingInt(s)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		pre := pl != <span class="built_in">len</span>(s) <span class="comment">// whether we consumed anything before a period</span></div><div class="line"></div><div class="line">		<span class="comment">// Consume (\.[0-9]*)?</span></div><div class="line">		post := <span class="literal">false</span></div><div class="line">		<span class="keyword">if</span> s != <span class="string">""</span> &amp;&amp; s[<span class="number">0</span>] == <span class="string">'.'</span> &#123;</div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">			pl := <span class="built_in">len</span>(s)</div><div class="line">			f, scale, s = leadingFraction(s)</div><div class="line">			post = pl != <span class="built_in">len</span>(s)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !pre &amp;&amp; !post &#123;</div><div class="line">			<span class="comment">// no digits (e.g. ".s" or "-.s")</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Consume unit.</span></div><div class="line">		i := <span class="number">0</span></div><div class="line">		<span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">			c := s[i]</div><div class="line">			<span class="keyword">if</span> c == <span class="string">'.'</span> || <span class="string">'0'</span> &lt;= c &amp;&amp; c &lt;= <span class="string">'9'</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: missing unit in duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		u := s[:i]</div><div class="line">		s = s[i:]</div><div class="line">		unit, ok := unitMap[u]</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: unknown unit "</span> + u + <span class="string">" in duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> v &gt; (<span class="number">1</span>&lt;&lt;<span class="number">63</span><span class="number">-1</span>)/unit &#123;</div><div class="line">			<span class="comment">// overflow</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		v *= unit</div><div class="line">		<span class="keyword">if</span> f &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// float64 is needed to be nanosecond accurate for fractions of hours.</span></div><div class="line">			<span class="comment">// v &gt;= 0 &amp;&amp; (f*unit/scale) &lt;= 3.6e+12 (ns/h, h is the largest unit)</span></div><div class="line">			v += <span class="keyword">int64</span>(<span class="keyword">float64</span>(f) * (<span class="keyword">float64</span>(unit) / scale))</div><div class="line">			<span class="keyword">if</span> v &lt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// overflow</span></div><div class="line">				<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		d += v</div><div class="line">		<span class="keyword">if</span> d &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// overflow</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> neg &#123;</div><div class="line">		d = -d</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> Duration(d), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="接口值"><a href="#接口值" class="headerlink" title="接口值"></a>接口值</h2><ul>
<li>接口值指一个具体的类型和那个类型的值，也称为接口的动态类型和动态值</li>
<li>go中提供类型信息的值实际上是类型描述符，类型时编译期的概念</li>
<li>接口的零值指的是期类型和值的部分都是nil</li>
<li>不包含任何值的nil接口和一个刚好包含nil指针的接口值是不同的</li>
</ul>
<h2 id="go中排序算法的实现"><a href="#go中排序算法的实现" class="headerlink" title="go中排序算法的实现"></a>go中排序算法的实现</h2><h3 id="sort接口"><a href="#sort接口" class="headerlink" title="sort接口"></a>sort接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sort</div><div class="line"><span class="comment">// 排序接口只规定了三个方法，序列长度，两个元素的比较结果，交换两个元素的方式</span></div><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">	Len() <span class="keyword">int</span></div><div class="line">	Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">	Swap(i, j <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="go中排序函数的实现"><a href="#go中排序函数的实现" class="headerlink" title="go中排序函数的实现"></a>go中排序函数的实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 实现了前面Interface的结构体都可以进行排序，go中排序使用的是改进后的快排</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	quickSort(data, <span class="number">0</span>, n, maxDepth(n))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 堆排序最大深度</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">maxDepth</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> depth <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> i := n; i &gt; <span class="number">0</span>; i &gt;&gt;= <span class="number">1</span> &#123;</div><div class="line">		depth++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> depth * <span class="number">2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSort</span><span class="params">(data Interface, a, b, maxDepth <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> b-a &gt; <span class="number">12</span> &#123; <span class="comment">// Use ShellSort for slices &lt;= 12 elements</span></div><div class="line">		<span class="keyword">if</span> maxDepth == <span class="number">0</span> &#123;</div><div class="line">		    <span class="comment">// 进行堆排序</span></div><div class="line">			heapSort(data, a, b)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		maxDepth--</div><div class="line">		<span class="comment">// 获取pivot，进行快排</span></div><div class="line">		mlo, mhi := doPivot(data, a, b)</div><div class="line">		<span class="comment">// Avoiding recursion on the larger subproblem guarantees</span></div><div class="line">		<span class="comment">// a stack depth of at most lg(b-a).</span></div><div class="line">		<span class="keyword">if</span> mlo-a &lt; b-mhi &#123;</div><div class="line">			quickSort(data, a, mlo, maxDepth)</div><div class="line">			a = mhi <span class="comment">// i.e., quickSort(data, mhi, b)</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			quickSort(data, mhi, b, maxDepth)</div><div class="line">			b = mlo <span class="comment">// i.e., quickSort(data, a, mlo)</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b-a &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="comment">// 希尔排序</span></div><div class="line">		<span class="comment">// It could be written in this simplified form cause b-a &lt;= 12</span></div><div class="line">		<span class="keyword">for</span> i := a + <span class="number">6</span>; i &lt; b; i++ &#123;</div><div class="line">			<span class="keyword">if</span> data.Less(i, i<span class="number">-6</span>) &#123;</div><div class="line">				data.Swap(i, i<span class="number">-6</span>)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		insertionSort(data, a, b)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>interface是一种类型</li>
<li>interfacde{}是空接口，和Java中Object类似，所有的结构体都实现了空接口</li>
<li>如果一个类型实现了一个interface的所有方法，则该类型实现了该接口</li>
<li>interface变量存储的是实现结构体的值，并且只会暴露接口公开的值和方法</li>
<li>判断interface存储的类型可以使用断言来实现。value, ok := interfaceObject.(assertType)</li>
<li><p>interface的接收者是类型值还是指针在定义的时候没有严格规定，但是go语言实际上是只支持值传递。golang的语法糖会将函数里调用的指针进行隐式的转换成值，但是反过来是不行的。函数调用优先使用指针就OK了。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">type I interface &#123;</div><div class="line">	Get() int</div><div class="line">	Set(int)</div><div class="line">&#125;</div><div class="line"></div><div class="line">type SS struct &#123;</div><div class="line">	Age int</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (s SS) Get() int &#123;</div><div class="line">	return s.Age</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (s SS) Set(age int) &#123;</div><div class="line">	s.Age = age</div><div class="line">&#125;</div><div class="line"></div><div class="line">func f(i I) &#123;</div><div class="line">	i.Set(10)</div><div class="line">	fmt.Println(i.Get())</div><div class="line">&#125;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">	ss := SS&#123;&#125;</div><div class="line">	f(&amp;ss) //指针参数，无论函数的接收者是值还是指针都不会保存</div><div class="line">	f(ss)  //值参数，函数的接收者是值不会报错，是指针会编译报错</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/源码解读/io/io/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/源码解读/io/io/" itemprop="url">go源码解读-io包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T09:56:01+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="io包中的接口定义"><a href="#io包中的接口定义" class="headerlink" title="io包中的接口定义"></a>io包中的接口定义</h2><ul>
<li>io包中提供了IO操作相关的一系列接口</li>
<li>io包可以理解对os包中底层操作的封装</li>
<li>由于是对底层进行封装，除非特殊提及，否则io包下的函数是线程不安全的</li>
</ul>
<h3 id="Reader接口"><a href="#Reader接口" class="headerlink" title="Reader接口"></a>Reader接口</h3><ul>
<li>Reader接口只包含一个Read方法</li>
<li>Read方法最多读取len(p)个字节到p中，返回读取到p中的字节数及过程中的错误</li>
<li>Read方法读取过程中出错，会返回已经读取到的字节数</li>
<li>Read出错的时候可以返回已经读取到的字节数和nil错误或者返回遇到的错误，而再下次调用Read方法的时候返回0, err即可</li>
<li>Read方法的调用者需要先处理n&gt;0的情况下的数据，而后考虑err的值，防止读取的数据丢失</li>
<li>Read方法不鼓励返回0，nil样式的返回值，除非len(p) == 0</li>
<li>p不能作为实现Reader接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">	Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Writer接口"><a href="#Writer接口" class="headerlink" title="Writer接口"></a>Writer接口</h3><ul>
<li>Writer接口只包含Write方法</li>
<li>Write方法完成从p中写入len(p)个字节到数据流中，返回的是写入的字节数及遇到的错误</li>
<li>Write方法如果返回的<code>n&lt;len(p)</code>，则必须返回个非空的错误</li>
<li>Write方法不允许调整p中的数据，临时调整也不可以</li>
<li>p不能作为实现Writer接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">	Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Closer接口"><a href="#Closer接口" class="headerlink" title="Closer接口"></a>Closer接口</h3><ul>
<li>Closer接口只包含Close方法</li>
<li>Closer接口返回关闭对象中遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</div><div class="line">	Close() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Seeker接口"><a href="#Seeker接口" class="headerlink" title="Seeker接口"></a>Seeker接口</h3><ul>
<li>Seeker接口只含有一个Seek方法</li>
<li>Seek方法根据whence的值计算出下一个读取或者写入的偏移量<ul>
<li>SeekStart对起始文件的偏移量</li>
<li>SeekCurrent对当前索引的偏移量</li>
<li>SeekEnd对结尾的偏移量</li>
</ul>
</li>
<li>Seek方法返回相对于起始位置的偏移量，和遇到的错误</li>
<li>实际上返回的偏移量小于文件的起始索引会产生错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	SeekStart   = <span class="number">0</span> <span class="comment">// seek relative to the origin of the file</span></div><div class="line">	SeekCurrent = <span class="number">1</span> <span class="comment">// seek relative to the current offset</span></div><div class="line">	SeekEnd     = <span class="number">2</span> <span class="comment">// seek relative to the end</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Seeker <span class="keyword">interface</span> &#123;</div><div class="line">	Seek(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>) (<span class="keyword">int64</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="组合接口"><a href="#组合接口" class="headerlink" title="组合接口"></a>组合接口</h3><ul>
<li>对于上述的接口进行组合会产生一系列新的接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReadWriter is the interface that groups the basic Read and Write methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadCloser is the interface that groups the basic Read and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteCloser is the interface that groups the basic Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> WriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteCloser is the interface that groups the basic Read, Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadSeeker is the interface that groups the basic Read and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteSeeker is the interface that groups the basic Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> WriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteSeeker is the interface that groups the basic Read, Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderFrom接口"><a href="#ReaderFrom接口" class="headerlink" title="ReaderFrom接口"></a>ReaderFrom接口</h3><ul>
<li>ReaderFrom接口只包含ReadFrom方法</li>
<li>ReadFrom方法从r中读取数据直到遇到EOF或者error</li>
<li>ReadFrom方法返回读取到的字节数和遇到的错误</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderFrom <span class="keyword">interface</span> &#123;</div><div class="line">	ReadFrom(r Reader) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteTo接口"><a href="#WriteTo接口" class="headerlink" title="WriteTo接口"></a>WriteTo接口</h3><ul>
<li>WriteTo接口只包含WriteTo方法</li>
<li>WriteTo方法向w中写入数据，直到没有数据可以写入或者遇到了错误</li>
<li>WriteTo方法返回写入的字节数和遇到的问题</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterTo <span class="keyword">interface</span> &#123;</div><div class="line">	WriteTo(w Writer) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderAt接口"><a href="#ReaderAt接口" class="headerlink" title="ReaderAt接口"></a>ReaderAt接口</h3><ul>
<li>ReaderAt接口只包含ReadAt方法</li>
<li>ReadAt方法在实现的结构体的输入流中，在偏移量offset的位置读取len(p)个字节数据导p中</li>
<li>ReadAt方法在读取到的字节小于len(p)时会返回一个非空错误来解释为什么没有读取完全，这个地方的要求比Reader接口更加严格</li>
<li>ReadAt方法在调用过程中会占据p的全部内存空间，即使读取到的n小于p的长度</li>
<li>ReadAt如果读取到的数据小于len(p),则ReadAt方法会等待更多的数据到来或者返回一个错误，这个地方要求也是比Reader更加严格</li>
<li>ReadAt如果读取完最后一个数据之后，刚好读取了len(p)个字节，则可以返回的err为nil或者EOF</li>
<li>ReadAt方法如果读取的是一个实现了Seek接口的结构体，那么ReadAt的offset和seek的offset不应该相互影响</li>
<li>读取的数据流可以支持多个ReadAt方法并发读取，也就是ReadAt是线程安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderAt <span class="keyword">interface</span> &#123;</div><div class="line">	ReadAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteAt接口"><a href="#WriteAt接口" class="headerlink" title="WriteAt接口"></a>WriteAt接口</h3><ul>
<li>WriterAt接口只包含WriteAt方法</li>
<li>WriteAt方法完成向数据流的写入，写入的起点为输入流的offset位置</li>
<li>WriteAt方法返回向数据流写入的数据和遇到的错误</li>
<li>WriteAt方法当写入的数据小于len(p)时，返回的错误不能为nil</li>
<li>WriteAt方法写入的数据流实现了Seek方法，则Seek方法的offset和WriteAt方法的offset互不影响</li>
<li>在数据流不溢出的情况下，WriteAt方法可以并发写入，是线程安全的<br>-</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterAt <span class="keyword">interface</span> &#123;</div><div class="line">	WriteAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteReader接口"><a href="#ByteReader接口" class="headerlink" title="ByteReader接口"></a>ByteReader接口</h3><ul>
<li>ByteReader接口只包含ReadByte方法</li>
<li>ReadByte方法读取一个字节，返回从input数据流中读取到的下一个字节或者遇到的错误</li>
<li>如果返回了一个错误，则input数据流没有字节被读取消费掉，并且返回的字节值为undefined</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadByte() (<span class="keyword">byte</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteScanner接口"><a href="#ByteScanner接口" class="headerlink" title="ByteScanner接口"></a>ByteScanner接口</h3><ul>
<li>ByteScanner接口封装了ByteReader接口和UnreadByte方法</li>
<li>UnreadByte方法在ReadByte方法之后调用，会重置ReadByte方法的操作</li>
<li>如果在没调用ReadByte方法时，调用UnreadByte方法会报错</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteScanner <span class="keyword">interface</span> &#123;</div><div class="line">	ByteReader</div><div class="line">	UnreadByte() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteWriter接口"><a href="#ByteWriter接口" class="headerlink" title="ByteWriter接口"></a>ByteWriter接口</h3><ul>
<li>ByteWriter接口只包含WriteByte方法</li>
<li>WriteByte方法完成对数据流的字节写入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteByte(c <span class="keyword">byte</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneReader接口"><a href="#RuneReader接口" class="headerlink" title="RuneReader接口"></a>RuneReader接口</h3><ul>
<li>RuneReader接口包含ReadRune方法</li>
<li>Readrune方法从数据流中读取一个UTF-8编码的Unicode字符，返回读取到的字符，字符的大小和遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadRune() (r <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneScanner接口"><a href="#RuneScanner接口" class="headerlink" title="RuneScanner接口"></a>RuneScanner接口</h3><ul>
<li>RuneScanner接口封装了RuneReader接口和UnreadRune方法</li>
<li>UnreadRune方法实际上是重置ReadRune方法的操作，需要在ReadRune方法之后调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneScanner <span class="keyword">interface</span> &#123;</div><div class="line">	RuneReader</div><div class="line">	UnreadRune() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="StringWriter接口"><a href="#StringWriter接口" class="headerlink" title="StringWriter接口"></a>StringWriter接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> StringWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteString(s <span class="keyword">string</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="io包中的错误定义"><a href="#io包中的错误定义" class="headerlink" title="io包中的错误定义"></a>io包中的错误定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrShortWrite = errors.New(<span class="string">"short write"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrShortBuffer = errors.New(<span class="string">"short buffer"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> EOF = errors.New(<span class="string">"EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrUnexpectedEOF = errors.New(<span class="string">"unexpected EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrNoProgress = errors.New(<span class="string">"multiple Read calls return no data or error"</span>)</div></pre></td></tr></table></figure>
<h2 id="io包中定义的结构体"><a href="#io包中定义的结构体" class="headerlink" title="io包中定义的结构体"></a>io包中定义的结构体</h2><h3 id="LimitedReader"><a href="#LimitedReader" class="headerlink" title="LimitedReader"></a>LimitedReader</h3><ul>
<li>LimitedReader读入数据到R中，限制读入的字节数为N</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> LimitedReader <span class="keyword">struct</span> &#123;</div><div class="line">	R Reader <span class="comment">// underlying reader</span></div><div class="line">	N <span class="keyword">int64</span>  <span class="comment">// max bytes remaining</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitReader</span><span class="params">(r Reader, n <span class="keyword">int64</span>)</span> <span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;LimitedReader&#123;r, n&#125; &#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LimitedReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.N &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; l.N &#123;</div><div class="line">		p = p[<span class="number">0</span>:l.N]</div><div class="line">	&#125;</div><div class="line">	n, err = l.R.Read(p)</div><div class="line">	l.N -= <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SectionReader"><a href="#SectionReader" class="headerlink" title="SectionReader"></a>SectionReader</h3><ul>
<li>SectionReader完成数据的部分读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> SectionReader <span class="keyword">struct</span> &#123;</div><div class="line">	r     ReaderAt</div><div class="line">	base  <span class="keyword">int64</span></div><div class="line">	off   <span class="keyword">int64</span></div><div class="line">	limit <span class="keyword">int64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSectionReader</span><span class="params">(r ReaderAt, off <span class="keyword">int64</span>, n <span class="keyword">int64</span>)</span> *<span class="title">SectionReader</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;SectionReader&#123;r, off, off, off + n&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.off &gt;= s.limit &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> max := s.limit - s.off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">	&#125;</div><div class="line">	n, err = s.r.ReadAt(p, s.off)</div><div class="line">	s.off += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Seeker接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errWhence</div><div class="line">	<span class="keyword">case</span> SeekStart:</div><div class="line">		offset += s.base</div><div class="line">	<span class="keyword">case</span> SeekCurrent:</div><div class="line">		offset += s.off</div><div class="line">	<span class="keyword">case</span> SeekEnd:</div><div class="line">		offset += s.limit</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> offset &lt; s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errOffset</div><div class="line">	&#125;</div><div class="line">	s.off = offset</div><div class="line">	<span class="keyword">return</span> offset - s.base, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现ReaderAt接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">ReadAt</span><span class="params">(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> || off &gt;= s.limit-s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	off += s.base</div><div class="line">	<span class="keyword">if</span> max := s.limit - off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">		n, err = s.r.ReadAt(p, off)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			err = EOF</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> n, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.r.ReadAt(p, off)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 返回section的字节尺寸</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> s.limit - s.base &#125;</div></pre></td></tr></table></figure>
<h2 id="常用工具类方法"><a href="#常用工具类方法" class="headerlink" title="常用工具类方法"></a>常用工具类方法</h2><ul>
<li>WriteString函数将字符串s写入到w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteString</span><span class="params">(w Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">		<span class="keyword">return</span> sw.WriteString(s)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> w.Write([]<span class="keyword">byte</span>(s))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadAtLeast函数从r中读取数据导buf中，同时规定了最少读取的字节数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Reader, buf []<span class="keyword">byte</span>, min <span class="keyword">int</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(buf) &lt; min &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, ErrShortBuffer</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> n &lt; min &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">var</span> nn <span class="keyword">int</span></div><div class="line">		nn, err = r.Read(buf[n:])</div><div class="line">		n += nn</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &gt;= min &#123;</div><div class="line">		err = <span class="literal">nil</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &gt; <span class="number">0</span> &amp;&amp; err == EOF &#123;</div><div class="line">		err = ErrUnexpectedEOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadFull一次性读取len(buf)个数到buf中，实际上是对ReadAtLeast的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFull</span><span class="params">(r Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ReadAtLeast(r, buf, <span class="built_in">len</span>(buf))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Copy方法完成将src的数据复制到dst中，直到遇到EOF或者错误</li>
<li>Copy成功的话会返回nil，而不是EOF</li>
<li>如果src实现了WriteTo方法，则会优先调用，否则会调用dst的ReadFrom方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyBuffer和Copy是一致的，只是增加了缓冲区</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> buf != <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(buf) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"empty buffer in io.CopyBuffer"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>copyBuffer是实际上的Copy和CopyBuffer的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">copyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 如果src实现了WriteTo接口，则调用其WroteTo方法完成写入</span></div><div class="line">	<span class="keyword">if</span> wt, ok := src.(WriterTo); ok &#123;</div><div class="line">		<span class="keyword">return</span> wt.WriteTo(dst)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 如果dst实现了ReaderFrom接口，则调用ReadFrom方法完成写入</span></div><div class="line">	<span class="keyword">if</span> rt, ok := dst.(ReaderFrom); ok &#123;</div><div class="line">		<span class="keyword">return</span> rt.ReadFrom(src)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 缓冲区大小确定</span></div><div class="line">	<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">		size := <span class="number">32</span> * <span class="number">1024</span></div><div class="line">		<span class="keyword">if</span> l, ok := src.(*LimitedReader); ok &amp;&amp; <span class="keyword">int64</span>(size) &gt; l.N &#123;</div><div class="line">			<span class="keyword">if</span> l.N &lt; <span class="number">1</span> &#123;</div><div class="line">				size = <span class="number">1</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				size = <span class="keyword">int</span>(l.N)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 读取到buf中</span></div><div class="line">		nr, er := src.Read(buf)</div><div class="line">		<span class="keyword">if</span> nr &gt; <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 写入操作</span></div><div class="line">			nw, ew := dst.Write(buf[<span class="number">0</span>:nr])</div><div class="line">			<span class="keyword">if</span> nw &gt; <span class="number">0</span> &#123;</div><div class="line">				written += <span class="keyword">int64</span>(nw)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ew != <span class="literal">nil</span> &#123;</div><div class="line">				err = ew</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> nr != nw &#123;</div><div class="line">				err = ErrShortWrite</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> er != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> er != EOF &#123;</div><div class="line">				err = er</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> written, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyN完成从src复制N个字节数据到dst</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyN</span><span class="params">(dst Writer, src Reader, n <span class="keyword">int64</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	written, err = Copy(dst, LimitReader(src, n))</div><div class="line">	<span class="keyword">if</span> written == n &#123;</div><div class="line">		<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> written &lt; n &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ioutil中的工具类"><a href="#ioutil中的工具类" class="headerlink" title="ioutil中的工具类"></a>ioutil中的工具类</h2><h3 id="ReadAll函数"><a href="#ReadAll函数" class="headerlink" title="ReadAll函数"></a>ReadAll函数</h3><ul>
<li>ReadAll函数将r中的数据读取出来并返回</li>
<li>成功读取返回的err为nil</li>
<li>readAll函数实际上是利用bytes.Buffer完成数据的读取的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> readAll(r, bytes.MinRead)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf bytes.Buffer</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		e := <span class="built_in">recover</span>()</div><div class="line">		<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</div><div class="line">			err = panicErr</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(e)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">  <span class="comment">// 防止capacity溢出</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="keyword">int</span>(capacity)) == capacity &#123;</div><div class="line">		buf.Grow(<span class="keyword">int</span>(capacity))</div><div class="line">	&#125;</div><div class="line">	_, err = buf.ReadFrom(r)</div><div class="line">	<span class="keyword">return</span> buf.Bytes(), err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadFile函数"><a href="#ReadFile函数" class="headerlink" title="ReadFile函数"></a>ReadFile函数</h3><ul>
<li>ReadFile完成对指定文件的读取并且返回其数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filename <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件</span></div><div class="line">	f, err := os.Open(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">var</span> n <span class="keyword">int64</span> = bytes.MinRead</div><div class="line"></div><div class="line">	<span class="keyword">if</span> fi, err := f.Stat(); err == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// 确定读取的size，比文件的大小稍微多一些</span></div><div class="line">		<span class="keyword">if</span> size := fi.Size() + bytes.MinRead; size &gt; n &#123;</div><div class="line">			n = size</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用readAll方法来完成数据的读取</span></div><div class="line">	<span class="keyword">return</span> readAll(f, n)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteFile函数"><a href="#WriteFile函数" class="headerlink" title="WriteFile函数"></a>WriteFile函数</h3><ul>
<li>WriteFile将数据写入到名称为filename的文件中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFile</span><span class="params">(filename <span class="keyword">string</span>, data []<span class="keyword">byte</span>, perm os.FileMode)</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件，如果不存在，则创建</span></div><div class="line">	f, err := os.OpenFile(filename, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, perm)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 数据的追加写入</span></div><div class="line">	n, err := f.Write(data)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; n &lt; <span class="built_in">len</span>(data) &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 关闭文件</span></div><div class="line">	<span class="keyword">if</span> err1 := f.Close(); err == <span class="literal">nil</span> &#123;</div><div class="line">		err = err1</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadDir函数"><a href="#ReadDir函数" class="headerlink" title="ReadDir函数"></a>ReadDir函数</h3><ul>
<li>ReadDir函数读取dirname下的文件或者路径并返回</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadDir</span><span class="params">(dirname <span class="keyword">string</span>)</span> <span class="params">([]os.FileInfo, error)</span></span> &#123;</div><div class="line">	f, err := os.Open(dirname)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	list, err := f.Readdir(<span class="number">-1</span>)</div><div class="line">	f.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	sort.Slice(list, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> list[i].Name() &lt; list[j].Name() &#125;)</div><div class="line">	<span class="keyword">return</span> list, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NopCloser"><a href="#NopCloser" class="headerlink" title="NopCloser"></a>NopCloser</h3><ul>
<li>NopCloser返回带Close方法的Reader</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NopCloser</span><span class="params">(r io.Reader)</span> <span class="title">io</span>.<span class="title">ReadCloser</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> nopCloser&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> nopCloser <span class="keyword">struct</span> &#123;</div><div class="line">	io.Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nopCloser)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="Discard"><a href="#Discard" class="headerlink" title="Discard"></a>Discard</h3><ul>
<li>Discard的写入操作都会被忽略</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Discard实际上是通过devNull来构建的</span></div><div class="line"><span class="keyword">var</span> Discard io.Writer = devNull(<span class="number">0</span>)</div><div class="line"><span class="comment">// devNull结构体本身是个int数据</span></div><div class="line"><span class="keyword">type</span> devNull <span class="keyword">int</span></div><div class="line"><span class="comment">// 实现了Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了StringWriter接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了ReaderFrom接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	bufp := blackHolePool.Get().(*[]<span class="keyword">byte</span>)</div><div class="line">	readSize := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		readSize, err = r.Read(*bufp)</div><div class="line">		n += <span class="keyword">int64</span>(readSize)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			blackHolePool.Put(bufp)</div><div class="line">			<span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">				<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> blackHolePool = sync.Pool&#123;</div><div class="line">	New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">		b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8192</span>)</div><div class="line">		<span class="keyword">return</span> &amp;b</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Pipe函数"><a href="#Pipe函数" class="headerlink" title="Pipe函数"></a>Pipe函数</h2><ul>
<li>Pipe在内存中创建了个管道，可以用于连接需要io.Reader和io.Writer的代码</li>
<li>读写会相互阻塞，除非一个写入被多次读取的场景存在</li>
<li>Pipe是并发安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pipe</span><span class="params">()</span> <span class="params">(*PipeReader, *PipeWriter)</span></span> &#123;</div><div class="line">	p := &amp;pipe&#123;</div><div class="line">		wrCh: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</div><div class="line">		rdCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>),</div><div class="line">		done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;PipeReader&#123;p&#125;, &amp;PipeWriter&#123;p&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PipeReader和PipeWriter"><a href="#PipeReader和PipeWriter" class="headerlink" title="PipeReader和PipeWriter"></a>PipeReader和PipeWriter</h3><ul>
<li>PipeReader是管道读的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeReader <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Read</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.Read(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Closer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.CloseRead(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>PipeWriter是管道写的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeWriter <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Write</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.Write(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io。Close方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.CloseWrite(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pipe结构体"><a href="#pipe结构体" class="headerlink" title="pipe结构体"></a>pipe结构体</h3><ul>
<li>实际上Pipe是对pipe的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> pipe <span class="keyword">struct</span> &#123;</div><div class="line">	wrMu sync.Mutex <span class="comment">// 保障写入的安全</span></div><div class="line">	wrCh <span class="keyword">chan</span> []<span class="keyword">byte</span> <span class="comment">// 写入的数据</span></div><div class="line">	rdCh <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 读取到的数量的byte数</span></div><div class="line"></div><div class="line">	once sync.Once <span class="comment">// 保证pipe只被关闭一次</span></div><div class="line">	done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// pipe关闭通道信息</span></div><div class="line">	rerr atomicError <span class="comment">// 读错误</span></div><div class="line">	werr atomicError <span class="comment">// 写错误</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Reader接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 判断要读取的通道是否已经关闭</span></div><div class="line">  <span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 将数据写入b中，并将写入的字节数写入rdCh通道中</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> bw := &lt;-p.wrCh:</div><div class="line">		nr := <span class="built_in">copy</span>(b, bw)</div><div class="line">		p.rdCh &lt;- nr</div><div class="line">		<span class="keyword">return</span> nr, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Writer接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Write</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 保证写入的时候安全，且pipe没有关闭</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.writeCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		p.wrMu.Lock()</div><div class="line">		<span class="keyword">defer</span> p.wrMu.Unlock()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 写入数据</span></div><div class="line">	<span class="keyword">for</span> once := <span class="literal">true</span>; once || <span class="built_in">len</span>(b) &gt; <span class="number">0</span>; once = <span class="literal">false</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> p.wrCh &lt;- b:</div><div class="line">			nw := &lt;-p.rdCh</div><div class="line">			b = b[nw:]</div><div class="line">			n += nw</div><div class="line">		<span class="keyword">case</span> &lt;-p.done:</div><div class="line">			<span class="keyword">return</span> n, p.writeCloseError()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe的Close方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseRead</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = ErrClosedPipe</div><div class="line">	&#125;</div><div class="line">	p.rerr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseWrite</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	p.werr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="multi"><a href="#multi" class="headerlink" title="multi"></a>multi</h2><h3 id="MultiReader-将多个Reader的内容写入p"><a href="#MultiReader-将多个Reader的内容写入p" class="headerlink" title="MultiReader 将多个Reader的内容写入p"></a>MultiReader 将多个Reader的内容写入p</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiReader</span><span class="params">(readers ...Reader)</span> <span class="title">Reader</span></span> &#123;</div><div class="line">	r := <span class="built_in">make</span>([]Reader, <span class="built_in">len</span>(readers))</div><div class="line">	<span class="built_in">copy</span>(r, readers)</div><div class="line">	<span class="keyword">return</span> &amp;multiReader&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiReader <span class="keyword">struct</span> &#123;</div><div class="line">	readers []Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mr *multiReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">    <span class="comment">// flat嵌套</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(mr.readers) == <span class="number">1</span> &#123;</div><div class="line">			<span class="keyword">if</span> r, ok := mr.readers[<span class="number">0</span>].(*multiReader); ok &#123;</div><div class="line">				mr.readers = r.readers</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		n, err = mr.readers[<span class="number">0</span>].Read(p)</div><div class="line">		<span class="keyword">if</span> err == EOF &#123;</div><div class="line">      <span class="comment">// 避免nl panic</span></div><div class="line">			mr.readers[<span class="number">0</span>] = eofReader&#123;&#125; <span class="comment">// permit earlier GC</span></div><div class="line">			mr.readers = mr.readers[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n &gt; <span class="number">0</span> || err != EOF &#123;</div><div class="line">			<span class="keyword">if</span> err == EOF &amp;&amp; <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// Don't return EOF yet. More readers remain.</span></div><div class="line">				err = <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 避免nil panic</span></div><div class="line"><span class="keyword">type</span> eofReader <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eofReader)</span> <span class="title">Read</span><span class="params">([]<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MultiWriter-将p的内容写入多个数据流中"><a href="#MultiWriter-将p的内容写入多个数据流中" class="headerlink" title="MultiWriter 将p的内容写入多个数据流中"></a>MultiWriter 将p的内容写入多个数据流中</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiWriter</span><span class="params">(writers ...Writer)</span> <span class="title">Writer</span></span> &#123;</div><div class="line">	allWriters := <span class="built_in">make</span>([]Writer, <span class="number">0</span>, <span class="built_in">len</span>(writers))</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> writers &#123;</div><div class="line">		<span class="keyword">if</span> mw, ok := w.(*multiWriter); ok &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, mw.writers...)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, w)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;multiWriter&#123;allWriters&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiWriter <span class="keyword">struct</span> &#123;</div><div class="line">	writers []Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		n, err = w.Write(p)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> p []<span class="keyword">byte</span> <span class="comment">// lazily initialized if/when needed</span></div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">			n, err = sw.WriteString(s)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</div><div class="line">				p = []<span class="keyword">byte</span>(s)</div><div class="line">			&#125;</div><div class="line">			n, err = w.Write(p)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(s) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/sort/sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/sort/sort/" itemprop="url">go源码解读-sort</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T17:38:20+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Interface接口"><a href="#Interface接口" class="headerlink" title="Interface接口"></a>Interface接口</h2><ul>
<li>实现了Interface接口的结构体，可以调用sort.Sort进行排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">  <span class="comment">// 长度获取方法</span></div><div class="line">	Len() <span class="keyword">int</span></div><div class="line">  <span class="comment">// 大小比较方法</span></div><div class="line">	Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">  <span class="comment">// 元素交换方法</span></div><div class="line">	Swap(i, j <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Sort函数"><a href="#Sort函数" class="headerlink" title="Sort函数"></a>Sort函数</h2><ul>
<li>Sort函数完成对传入的Interface类型数据data的排序</li>
<li>实际上调用的是quickSort方法来完成排序的</li>
<li>maxDepth函数返回数据的深度，用于确定排序算法是快排还是堆排列，分割值为2*ceil(lg(n+1))</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	quickSort(data, <span class="number">0</span>, n, maxDepth(n))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">maxDepth</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> depth <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> i := n; i &gt; <span class="number">0</span>; i &gt;&gt;= <span class="number">1</span> &#123;</div><div class="line">		depth++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> depth * <span class="number">2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>quickSort函数完成Interface的排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSort</span><span class="params">(data Interface, a, b, maxDepth <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> b-a &gt; <span class="number">12</span> &#123;</div><div class="line">		<span class="keyword">if</span> maxDepth == <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 堆排序</span></div><div class="line">			heapSort(data, a, b)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		maxDepth--</div><div class="line">    <span class="comment">// 计算基准值，进行快速排序</span></div><div class="line">		mlo, mhi := doPivot(data, a, b)</div><div class="line">		<span class="keyword">if</span> mlo-a &lt; b-mhi &#123;</div><div class="line">			quickSort(data, a, mlo, maxDepth)</div><div class="line">			a = mhi <span class="comment">// i.e., quickSort(data, mhi, b)</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			quickSort(data, mhi, b, maxDepth)</div><div class="line">			b = mlo <span class="comment">// i.e., quickSort(data, a, mlo)</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 排序长度小于12时用Shell排序</span></div><div class="line">	<span class="keyword">if</span> b-a &gt; <span class="number">1</span> &#123;</div><div class="line">    <span class="comment">// Gap=6进行一次希尔排序</span></div><div class="line">		<span class="keyword">for</span> i := a + <span class="number">6</span>; i &lt; b; i++ &#123;</div><div class="line">			<span class="keyword">if</span> data.Less(i, i<span class="number">-6</span>) &#123;</div><div class="line">				data.Swap(i, i<span class="number">-6</span>)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// shell排序完之后用插入排序</span></div><div class="line">		insertionSort(data, a, b)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 插入排序</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertionSort</span><span class="params">(data Interface, a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := a + <span class="number">1</span>; i &lt; b; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := i; j &gt; a &amp;&amp; data.Less(j, j<span class="number">-1</span>); j-- &#123;</div><div class="line">			data.Swap(j, j<span class="number">-1</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pivot函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doPivot</span><span class="params">(data Interface, lo, hi <span class="keyword">int</span>)</span> <span class="params">(midlo, midhi <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	m := <span class="keyword">int</span>(<span class="keyword">uint</span>(lo+hi) &gt;&gt; <span class="number">1</span>) <span class="comment">// Written like this to avoid integer overflow.</span></div><div class="line">	<span class="keyword">if</span> hi-lo &gt; <span class="number">40</span> &#123;</div><div class="line">		<span class="comment">// Tukey's ``Ninther,'' median of three medians of three.</span></div><div class="line">		s := (hi - lo) / <span class="number">8</span></div><div class="line">		medianOfThree(data, lo, lo+s, lo+<span class="number">2</span>*s)</div><div class="line">		medianOfThree(data, m, m-s, m+s)</div><div class="line">		medianOfThree(data, hi<span class="number">-1</span>, hi<span class="number">-1</span>-s, hi<span class="number">-1</span><span class="number">-2</span>*s)</div><div class="line">	&#125;</div><div class="line">	medianOfThree(data, lo, m, hi<span class="number">-1</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Invariants are:</span></div><div class="line">	<span class="comment">//	data[lo] = pivot (set up by ChoosePivot)</span></div><div class="line">	<span class="comment">//	data[lo &lt; i &lt; a] &lt; pivot</span></div><div class="line">	<span class="comment">//	data[a &lt;= i &lt; b] &lt;= pivot</span></div><div class="line">	<span class="comment">//	data[b &lt;= i &lt; c] unexamined</span></div><div class="line">	<span class="comment">//	data[c &lt;= i &lt; hi-1] &gt; pivot</span></div><div class="line">	<span class="comment">//	data[hi-1] &gt;= pivot</span></div><div class="line">	pivot := lo</div><div class="line">	a, c := lo+<span class="number">1</span>, hi<span class="number">-1</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> ; a &lt; c &amp;&amp; data.Less(a, pivot); a++ &#123;</div><div class="line">	&#125;</div><div class="line">	b := a</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; !data.Less(pivot, b); b++ &#123; <span class="comment">// data[b] &lt;= pivot</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; data.Less(pivot, c<span class="number">-1</span>); c-- &#123; <span class="comment">// data[c-1] &gt; pivot</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> b &gt;= c &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// data[b] &gt; pivot; data[c-1] &lt;= pivot</span></div><div class="line">		data.Swap(b, c<span class="number">-1</span>)</div><div class="line">		b++</div><div class="line">		c--</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// If hi-c&lt;3 then there are duplicates (by property of median of nine).</span></div><div class="line">	<span class="comment">// Let's be a bit more conservative, and set border to 5.</span></div><div class="line">	protect := hi-c &lt; <span class="number">5</span></div><div class="line">	<span class="keyword">if</span> !protect &amp;&amp; hi-c &lt; (hi-lo)/<span class="number">4</span> &#123;</div><div class="line">		<span class="comment">// Lets test some points for equality to pivot</span></div><div class="line">		dups := <span class="number">0</span></div><div class="line">		<span class="keyword">if</span> !data.Less(pivot, hi<span class="number">-1</span>) &#123; <span class="comment">// data[hi-1] = pivot</span></div><div class="line">			data.Swap(c, hi<span class="number">-1</span>)</div><div class="line">			c++</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !data.Less(b<span class="number">-1</span>, pivot) &#123; <span class="comment">// data[b-1] = pivot</span></div><div class="line">			b--</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// m-lo = (hi-lo)/2 &gt; 6</span></div><div class="line">		<span class="comment">// b-lo &gt; (hi-lo)*3/4-1 &gt; 8</span></div><div class="line">		<span class="comment">// ==&gt; m &lt; b ==&gt; data[m] &lt;= pivot</span></div><div class="line">		<span class="keyword">if</span> !data.Less(m, pivot) &#123; <span class="comment">// data[m] = pivot</span></div><div class="line">			data.Swap(m, b<span class="number">-1</span>)</div><div class="line">			b--</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// if at least 2 points are equal to pivot, assume skewed distribution</span></div><div class="line">		protect = dups &gt; <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> protect &#123;</div><div class="line">		<span class="comment">// Protect against a lot of duplicates</span></div><div class="line">		<span class="comment">// Add invariant:</span></div><div class="line">		<span class="comment">//	data[a &lt;= i &lt; b] unexamined</span></div><div class="line">		<span class="comment">//	data[b &lt;= i &lt; c] = pivot</span></div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; !data.Less(b<span class="number">-1</span>, pivot); b-- &#123; <span class="comment">// data[b] == pivot</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; data.Less(a, pivot); a++ &#123; <span class="comment">// data[a] &lt; pivot</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> a &gt;= b &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// data[a] == pivot; data[b-1] &lt; pivot</span></div><div class="line">			data.Swap(a, b<span class="number">-1</span>)</div><div class="line">			a++</div><div class="line">			b--</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Swap pivot into middle</span></div><div class="line">	data.Swap(pivot, b<span class="number">-1</span>)</div><div class="line">	<span class="keyword">return</span> b - <span class="number">1</span>, c</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// medianOfThree moves the median of the three values data[m0], data[m1], data[m2] into data[m1].</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">medianOfThree</span><span class="params">(data Interface, m1, m0, m2 <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// sort 3 elements</span></div><div class="line">	<span class="keyword">if</span> data.Less(m1, m0) &#123;</div><div class="line">		data.Swap(m1, m0)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// data[m0] &lt;= data[m1]</span></div><div class="line">	<span class="keyword">if</span> data.Less(m2, m1) &#123;</div><div class="line">		data.Swap(m2, m1)</div><div class="line">		<span class="comment">// data[m0] &lt;= data[m2] &amp;&amp; data[m1] &lt; data[m2]</span></div><div class="line">		<span class="keyword">if</span> data.Less(m1, m0) &#123;</div><div class="line">			data.Swap(m1, m0)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// now data[m0] &lt;= data[m1] &lt;= data[m2]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>堆排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">heapSort</span><span class="params">(data Interface, a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	first := a</div><div class="line">	lo := <span class="number">0</span></div><div class="line">	hi := b - a</div><div class="line"></div><div class="line">	<span class="comment">// Build heap with greatest element at top.</span></div><div class="line">	<span class="keyword">for</span> i := (hi - <span class="number">1</span>) / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		siftDown(data, i, hi, first)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Pop elements, largest first, into end of data.</span></div><div class="line">	<span class="keyword">for</span> i := hi - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		data.Swap(first, first+i)</div><div class="line">		siftDown(data, lo, i, first)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">siftDown</span><span class="params">(data Interface, lo, hi, first <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	root := lo</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		child := <span class="number">2</span>*root + <span class="number">1</span></div><div class="line">		<span class="keyword">if</span> child &gt;= hi &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> child+<span class="number">1</span> &lt; hi &amp;&amp; data.Less(first+child, first+child+<span class="number">1</span>) &#123;</div><div class="line">			child++</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !data.Less(first+root, first+child) &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		data.Swap(first+root, first+child)</div><div class="line">		root = child</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="字符串排序举例"><a href="#字符串排序举例" class="headerlink" title="字符串排序举例"></a>字符串排序举例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> p[i] &lt; p[j] &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; p[i], p[j] = p[j], p[i] &#125;</div><div class="line"></div><div class="line"><span class="comment">// Sort is a convenience method.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Sort</span><span class="params">()</span></span> &#123; Sort(p) &#125;</div></pre></td></tr></table></figure>
<h2 id="工具类函数"><a href="#工具类函数" class="headerlink" title="工具类函数"></a>工具类函数</h2><ul>
<li>IsSorted判断data是否是有序的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsSorted</span><span class="params">(data Interface)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	<span class="keyword">for</span> i := n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> data.Less(i, i<span class="number">-1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Reverse对data进行倒序排列</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reverse</span><span class="params">(data Interface)</span> <span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;reverse&#123;data&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> reverse <span class="keyword">struct</span> &#123;</div><div class="line">	Interface</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 重写Interface的Less方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r reverse)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.Interface.Less(j, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Stable函数在排序过程中保持相等数据的原始顺序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stable</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	stable(data, data.Len())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">stable</span><span class="params">(data Interface, n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	blockSize := <span class="number">20</span> <span class="comment">// must be &gt; 0</span></div><div class="line">	a, b := <span class="number">0</span>, blockSize</div><div class="line">	<span class="keyword">for</span> b &lt;= n &#123;</div><div class="line">		insertionSort(data, a, b)</div><div class="line">		a = b</div><div class="line">		b += blockSize</div><div class="line">	&#125;</div><div class="line">	insertionSort(data, a, n)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> blockSize &lt; n &#123;</div><div class="line">		a, b = <span class="number">0</span>, <span class="number">2</span>*blockSize</div><div class="line">		<span class="keyword">for</span> b &lt;= n &#123;</div><div class="line">			symMerge(data, a, a+blockSize, b)</div><div class="line">			a = b</div><div class="line">			b += <span class="number">2</span> * blockSize</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> m := a + blockSize; m &lt; n &#123;</div><div class="line">			symMerge(data, a, m, n)</div><div class="line">		&#125;</div><div class="line">		blockSize *= <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/strings/strings/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/strings/strings/" itemprop="url">go源码解读-strings包的工具函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T16:58:15+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="strings包中的常用函数"><a href="#strings包中的常用函数" class="headerlink" title="strings包中的常用函数"></a>strings包中的常用函数</h2><h3 id="Contains类函数"><a href="#Contains类函数" class="headerlink" title="Contains类函数"></a>Contains类函数</h3><ul>
<li>Contains函数返回字符串s中是否存在substr，具体实现的Index方法和bytes包中的实现类似，也是用了Rabin-Karp search进行字符匹配查找</li>
<li>ContainsAny函数返回字符串s中是否存在chars中任意一个字符，实现中使用ASCiiSet的方法</li>
<li>ContainsRune函数返回字符串s中是否包含字符r,通过Index方法实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Contains reports whether substr is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Contains</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Index(s, substr) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ContainsAny reports whether any Unicode code points in chars are within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexAny(s, chars) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// Avoid scanning all of s.</span></div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(s[i]) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">for</span> _, m := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> c == m &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// makeASCIISet creates a set of ASCII characters and reports whether all</span></div><div class="line"><span class="comment">// characters in chars are ASCII.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeASCIISet</span><span class="params">(chars <span class="keyword">string</span>)</span> <span class="params">(as asciiSet, ok <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(chars); i++ &#123;</div><div class="line">		c := chars[i]</div><div class="line">		<span class="keyword">if</span> c &gt;= utf8.RuneSelf &#123;</div><div class="line">			<span class="keyword">return</span> as, <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		as[c&gt;&gt;<span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(c&amp;<span class="number">31</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> as, <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ContainsRune reports whether the Unicode code point r is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsRune</span><span class="params">(s <span class="keyword">string</span>, r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexRune(s, r) &gt;= <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><ul>
<li>Fields函数将字符串按照空白字符进行切割，返回字符串数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fields</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	wasSpace := <span class="number">1</span></div><div class="line">	<span class="comment">// setBits is used to track which bits are set in the bytes of s.</span></div><div class="line">	setBits := <span class="keyword">uint8</span>(<span class="number">0</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		r := s[i]</div><div class="line">		setBits |= r</div><div class="line">		isSpace := <span class="keyword">int</span>(asciiSpace[r])</div><div class="line">		n += wasSpace &amp; ^isSpace</div><div class="line">		wasSpace = isSpace</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// ASCII编码的快捷返回</span></div><div class="line">	<span class="keyword">if</span> setBits &lt; utf8.RuneSelf &#123; <span class="comment">// ASCII fast path</span></div><div class="line">		a := <span class="built_in">make</span>([]<span class="keyword">string</span>, n)</div><div class="line">		na := <span class="number">0</span></div><div class="line">		fieldStart := <span class="number">0</span></div><div class="line">		i := <span class="number">0</span></div><div class="line">		<span class="comment">// Skip spaces in the front of the input.</span></div><div class="line">		<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">			i++</div><div class="line">		&#125;</div><div class="line">		fieldStart = i</div><div class="line">		<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &#123;</div><div class="line">			<span class="keyword">if</span> asciiSpace[s[i]] == <span class="number">0</span> &#123;</div><div class="line">				i++</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			a[na] = s[fieldStart:i]</div><div class="line">			na++</div><div class="line">			i++</div><div class="line">			<span class="comment">// Skip spaces in between fields.</span></div><div class="line">			<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">				i++</div><div class="line">			&#125;</div><div class="line">			fieldStart = i</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> fieldStart &lt; <span class="built_in">len</span>(s) &#123; <span class="comment">// Last field might end at EOF.</span></div><div class="line">			a[na] = s[fieldStart:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> a</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用FieldsFunc来完成字符串的分割操作</span></div><div class="line">	<span class="keyword">return</span> FieldsFunc(s, unicode.IsSpace)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FieldsFunc</span><span class="params">(s <span class="keyword">string</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>) []<span class="title">string</span></span> &#123;</div><div class="line">  <span class="comment">// 分割起点终点索引值</span></div><div class="line">	<span class="keyword">type</span> span <span class="keyword">struct</span> &#123;</div><div class="line">		start <span class="keyword">int</span></div><div class="line">		end   <span class="keyword">int</span></div><div class="line">	&#125;</div><div class="line">	spans := <span class="built_in">make</span>([]span, <span class="number">0</span>, <span class="number">32</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Find the field start and end indices.</span></div><div class="line">	wasField := <span class="literal">false</span></div><div class="line">	fromIndex := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i, <span class="keyword">rune</span> := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> f(<span class="keyword">rune</span>) &#123;</div><div class="line">			<span class="keyword">if</span> wasField &#123;</div><div class="line">				spans = <span class="built_in">append</span>(spans, span&#123;start: fromIndex, end: i&#125;)</div><div class="line">				wasField = <span class="literal">false</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> !wasField &#123;</div><div class="line">				fromIndex = i</div><div class="line">				wasField = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Last field might end at EOF.</span></div><div class="line">	<span class="keyword">if</span> wasField &#123;</div><div class="line">		spans = <span class="built_in">append</span>(spans, span&#123;fromIndex, <span class="built_in">len</span>(s)&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 返回结果值</span></div><div class="line">	a := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(spans))</div><div class="line">	<span class="keyword">for</span> i, span := <span class="keyword">range</span> spans &#123;</div><div class="line">		a[i] = s[span.start:span.end]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> a</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Has函数"><a href="#Has函数" class="headerlink" title="Has函数"></a>Has函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasPrefix tests whether the string s begins with prefix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, prefix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(prefix) &amp;&amp; s[<span class="number">0</span>:<span class="built_in">len</span>(prefix)] == prefix</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HasSuffix tests whether the string s ends with suffix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasSuffix</span><span class="params">(s, suffix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(suffix) &amp;&amp; s[<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix):] == suffix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Join函数"><a href="#Join函数" class="headerlink" title="Join函数"></a>Join函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Join</span><span class="params">(a []<span class="keyword">string</span>, sep <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> <span class="built_in">len</span>(a) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span></div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> a[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 计算结果需要的内存大小</span></div><div class="line">	n := <span class="built_in">len</span>(sep) * (<span class="built_in">len</span>(a) - <span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a); i++ &#123;</div><div class="line">		n += <span class="built_in">len</span>(a[i])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 构建strings.Builder并分配内存</span></div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line">	b.Grow(n)</div><div class="line">  <span class="comment">// 将字符串数组s和sep逐个写入</span></div><div class="line">	b.WriteString(a[<span class="number">0</span>])</div><div class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> a[<span class="number">1</span>:] &#123;</div><div class="line">		b.WriteString(sep)</div><div class="line">		b.WriteString(s)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 返回结果</span></div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Last类函数"><a href="#Last类函数" class="headerlink" title="Last类函数"></a>Last类函数</h3><ul>
<li>LastIndex函数返回最后一个匹配的substr的索引值，使用了Rabin-Karp算法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndex</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(substr)</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> n == <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s)</div><div class="line">	<span class="keyword">case</span> n == <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> LastIndexByte(s, substr[<span class="number">0</span>])</div><div class="line">	<span class="keyword">case</span> n == <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">if</span> substr == s &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> n &gt; <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Rabin-Karp search from the end of the string</span></div><div class="line">	hashss, pow := hashStrRev(substr)</div><div class="line">	last := <span class="built_in">len</span>(s) - n</div><div class="line">	<span class="keyword">var</span> h <span class="keyword">uint32</span></div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= last; i-- &#123;</div><div class="line">		h = h*primeRK + <span class="keyword">uint32</span>(s[i])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> h == hashss &amp;&amp; s[last:] == substr &#123;</div><div class="line">		<span class="keyword">return</span> last</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := last - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		h *= primeRK</div><div class="line">		h += <span class="keyword">uint32</span>(s[i])</div><div class="line">		h -= pow * <span class="keyword">uint32</span>(s[i+n])</div><div class="line">		<span class="keyword">if</span> h == hashss &amp;&amp; s[i:i+n] == substr &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LastIndexAny函数返回s中找到的最后一个chars中任意一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(s[i]) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s); i &gt; <span class="number">0</span>; &#123;</div><div class="line">		r, size := utf8.DecodeLastRuneInString(s[:i])</div><div class="line">		i -= size</div><div class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> r == c &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LastIndexByte返回s中匹配的最后一个字节c的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexByte</span><span class="params">(s <span class="keyword">string</span>, c <span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> s[i] == c &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Map函数"><a href="#Map函数" class="headerlink" title="Map函数"></a>Map函数</h3><ul>
<li>Map函数根据映射规则函数mapping，完成对字符串s的字符替换</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(mapping <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">rune</span>, <span class="title">s</span> <span class="title">string</span>) <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> s &#123;</div><div class="line">		r := mapping(c)</div><div class="line">		<span class="keyword">if</span> r == c &amp;&amp; c != utf8.RuneError &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> width <span class="keyword">int</span></div><div class="line">		<span class="keyword">if</span> c == utf8.RuneError &#123;</div><div class="line">			c, width = utf8.DecodeRuneInString(s[i:])</div><div class="line">			<span class="keyword">if</span> width != <span class="number">1</span> &amp;&amp; r == c &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			width = utf8.RuneLen(c)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		b.Grow(<span class="built_in">len</span>(s) + utf8.UTFMax)</div><div class="line">		b.WriteString(s[:i])</div><div class="line">		<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">			b.WriteRune(r)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		s = s[i+width:]</div><div class="line">		<span class="keyword">break</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> b.Cap() == <span class="number">0</span> &#123; <span class="comment">// didn't call b.Grow above</span></div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> s &#123;</div><div class="line">		r := mapping(c)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> r &lt; utf8.RuneSelf &#123;</div><div class="line">				b.WriteByte(<span class="keyword">byte</span>(r))</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// r is not a ASCII rune.</span></div><div class="line">				b.WriteRune(r)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Repeat函数"><a href="#Repeat函数" class="headerlink" title="Repeat函数"></a>Repeat函数</h3><ul>
<li>Repeat函数将字符串s复制count遍并组合到一起</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(s <span class="keyword">string</span>, count <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> count == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> count &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: negative Repeat count"</span>)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(s)*count/count != <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: Repeat count causes overflow"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	n := <span class="built_in">len</span>(s) * count</div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line">	b.Grow(n)</div><div class="line">	b.WriteString(s)</div><div class="line">	<span class="keyword">for</span> b.Len() &lt; n &#123;</div><div class="line">		<span class="keyword">if</span> b.Len() &lt;= n/<span class="number">2</span> &#123;</div><div class="line">			b.WriteString(b.String())</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			b.WriteString(b.String()[:n-b.Len()])</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h3><ul>
<li>Replace方法完成对字符串的替换并制定替换的个数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Replace</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> old == <span class="built_in">new</span> || n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Compute number of replacements.</span></div><div class="line">	<span class="keyword">if</span> m := Count(s, old); m == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &lt; <span class="number">0</span> || m &lt; n &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Apply replacements to buffer.</span></div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)+n*(<span class="built_in">len</span>(<span class="built_in">new</span>)-<span class="built_in">len</span>(old)))</div><div class="line">	w := <span class="number">0</span></div><div class="line">	start := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		j := start</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(old) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</div><div class="line">				_, wid := utf8.DecodeRuneInString(s[start:])</div><div class="line">				j += wid</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			j += Index(s[start:], old)</div><div class="line">		&#125;</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], s[start:j])</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], <span class="built_in">new</span>)</div><div class="line">		start = j + <span class="built_in">len</span>(old)</div><div class="line">	&#125;</div><div class="line">	w += <span class="built_in">copy</span>(t[w:], s[start:])</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(t[<span class="number">0</span>:w])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReplaceAll</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Replace(s, old, <span class="built_in">new</span>, <span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Split方法"><a href="#Split方法" class="headerlink" title="Split方法"></a>Split方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Split</span><span class="params">(s, sep <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, <span class="number">-1</span>) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfter</span><span class="params">(s, sep <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), <span class="number">-1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfterN</span><span class="params">(s, sep <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), n)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitN</span><span class="params">(s, sep <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, n) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Split类函数实际上都是对genSplit函数的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">genSplit</span><span class="params">(s, sep <span class="keyword">string</span>, sepSave, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> sep == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> explode(s, n)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		n = Count(s, sep) + <span class="number">1</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	a := <span class="built_in">make</span>([]<span class="keyword">string</span>, n)</div><div class="line">	n--</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i &lt; n &#123;</div><div class="line">		m := Index(s, sep)</div><div class="line">		<span class="keyword">if</span> m &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		a[i] = s[:m+sepSave]</div><div class="line">		s = s[m+<span class="built_in">len</span>(sep):]</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	a[i] = s</div><div class="line">	<span class="keyword">return</span> a[:i+<span class="number">1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Title函数"><a href="#Title函数" class="headerlink" title="Title函数"></a>Title函数</h3><ul>
<li>Title对Map进行了封装，将空白字符的下一个字符进行大写处理</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Title</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	prev := <span class="string">' '</span></div><div class="line">	<span class="keyword">return</span> Map(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">rune</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> isSeparator(prev) &#123;</div><div class="line">				prev = r</div><div class="line">				<span class="keyword">return</span> unicode.ToTitle(r)</div><div class="line">			&#125;</div><div class="line">			prev = r</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;,</div><div class="line">		s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>To类方法和Trim类方法和bytes包中的类似，没有本质区别，不再赘述</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/strings/search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/strings/search/" itemprop="url">go源码解读-strings.stringFinder</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T16:28:51+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="stringFinder"><a href="#stringFinder" class="headerlink" title="stringFinder"></a>stringFinder</h2><ul>
<li>stringFinder 结构体来完成在一个文本中查找指定的字符串</li>
<li>采用Boyer-Moore字符串查找算法，简单来说每次字符串后移的位数为坏字符规则和好后缀规则的较大值</li>
<li>参考 <a href="https://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html" target="_blank" rel="external">https://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html</a></li>
<li>stringFinder包含三个参数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> stringFinder <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// 待查找的目标字符串</span></div><div class="line">	pattern <span class="keyword">string</span></div><div class="line">  <span class="comment">// 坏字符对应的偏移量，索引为对应的字节</span></div><div class="line">	badCharSkip [<span class="number">256</span>]<span class="keyword">int</span></div><div class="line">  <span class="comment">// 好字符偏移量，索引表示有几个匹配的字符</span></div><div class="line">	goodSuffixSkip []<span class="keyword">int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="makeStringFinder函数"><a href="#makeStringFinder函数" class="headerlink" title="makeStringFinder函数"></a>makeStringFinder函数</h3><ul>
<li>完成构建badCharSkip和goodSuffixSkip的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeStringFinder</span><span class="params">(pattern <span class="keyword">string</span>)</span> *<span class="title">stringFinder</span></span> &#123;</div><div class="line">	f := &amp;stringFinder&#123;</div><div class="line">		pattern:        pattern,</div><div class="line">		goodSuffixSkip: <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(pattern)),</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// last is the index of the last character in the pattern.</span></div><div class="line">	last := <span class="built_in">len</span>(pattern) - <span class="number">1</span></div><div class="line"></div><div class="line">	<span class="comment">// Build bad character table.</span></div><div class="line">	<span class="comment">// Bytes not in the pattern can skip one pattern's length.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> f.badCharSkip &#123;</div><div class="line">		f.badCharSkip[i] = <span class="built_in">len</span>(pattern)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// The loop condition is &lt; instead of &lt;= so that the last byte does not</span></div><div class="line">	<span class="comment">// have a zero distance to itself. Finding this byte out of place implies</span></div><div class="line">	<span class="comment">// that it is not in the last position.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; last; i++ &#123;</div><div class="line">		f.badCharSkip[pattern[i]] = last - i</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Build good suffix table.</span></div><div class="line">	<span class="comment">// First pass: set each value to the next index which starts a prefix of</span></div><div class="line">	<span class="comment">// pattern.</span></div><div class="line">	lastPrefix := last</div><div class="line">	<span class="keyword">for</span> i := last; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> HasPrefix(pattern, pattern[i+<span class="number">1</span>:]) &#123;</div><div class="line">			lastPrefix = i + <span class="number">1</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// lastPrefix is the shift, and (last-i) is len(suffix).</span></div><div class="line">		f.goodSuffixSkip[i] = lastPrefix + last - i</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Second pass: find repeats of pattern's suffix starting from the front.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; last; i++ &#123;</div><div class="line">		lenSuffix := longestCommonSuffix(pattern, pattern[<span class="number">1</span>:i+<span class="number">1</span>])</div><div class="line">		<span class="keyword">if</span> pattern[i-lenSuffix] != pattern[last-lenSuffix] &#123;</div><div class="line">			<span class="comment">// (last-i) is the shift, and lenSuffix is len(suffix).</span></div><div class="line">			f.goodSuffixSkip[last-lenSuffix] = lenSuffix + last - i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 最长相同字符的数量，从后向前</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">longestCommonSuffix</span><span class="params">(a, b <span class="keyword">string</span>)</span> <span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(a) &amp;&amp; i &lt; <span class="built_in">len</span>(b); i++ &#123;</div><div class="line">		<span class="keyword">if</span> a[<span class="built_in">len</span>(a)<span class="number">-1</span>-i] != b[<span class="built_in">len</span>(b)<span class="number">-1</span>-i] &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上移动的位数是从两个里面取最大值，next方法如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *stringFinder)</span> <span class="title">next</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	i := <span class="built_in">len</span>(f.pattern) - <span class="number">1</span></div><div class="line">	<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(text) &#123;</div><div class="line">		<span class="comment">// Compare backwards from the end until the first unmatching character.</span></div><div class="line">		j := <span class="built_in">len</span>(f.pattern) - <span class="number">1</span></div><div class="line">		<span class="keyword">for</span> j &gt;= <span class="number">0</span> &amp;&amp; text[i] == f.pattern[j] &#123;</div><div class="line">			i--</div><div class="line">			j--</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> j &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> i + <span class="number">1</span> <span class="comment">// match</span></div><div class="line">		&#125;</div><div class="line">		i += max(f.badCharSkip[text[i]], f.goodSuffixSkip[j])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> a &gt; b &#123;</div><div class="line">		<span class="keyword">return</span> a</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/strings/replace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/strings/replace/" itemprop="url">go源码解读-strings.Compare、strings.Replace</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T11:14:43+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Compare"><a href="#Compare" class="headerlink" title="Compare"></a>Compare</h2><ul>
<li>Compare只是提供一个方法，考虑性能的时候不建议调用</li>
<li>建议使用内建操作符<code>== &gt; &lt;</code>进行字符串的比较，效率更高，性能更好</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Compare</span><span class="params">(a, b <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> a == b &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> a &lt; b &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> +<span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h2><h3 id="replacer接口"><a href="#replacer接口" class="headerlink" title="replacer接口"></a>replacer接口</h3><ul>
<li>抽象出来的所有replace方法都需要实现的接口</li>
<li>包含Replace方法和WriteString方法</li>
<li>Replace方法完成s中字符串的替换</li>
<li>WriteString方法在将s写入w中完成s字符串的替换操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> replacer <span class="keyword">interface</span> &#123;</div><div class="line">	Replace(s <span class="keyword">string</span>) <span class="keyword">string</span></div><div class="line">	WriteString(w io.Writer, s <span class="keyword">string</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Replace结构体"><a href="#Replace结构体" class="headerlink" title="Replace结构体"></a>Replace结构体</h3><ul>
<li>Replacer结构体完成字符串切片的替换,第一个字符串是旧的，第二个是匹配到替换为新的字符串</li>
<li>Replacer是线程安全的，可以用于并发编程中，通过once参数来实现</li>
<li>NewReplacer完成Replacer结构体的初始化</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Replacer <span class="keyword">struct</span> &#123;</div><div class="line">	once   sync.Once <span class="comment">// guards buildOnce method</span></div><div class="line">	r      replacer</div><div class="line">	oldnew []<span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReplacer</span><span class="params">(oldnew ...<span class="keyword">string</span>)</span> *<span class="title">Replacer</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(oldnew)%<span class="number">2</span> == <span class="number">1</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.NewReplacer: odd argument count"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Replacer&#123;oldnew: <span class="built_in">append</span>([]<span class="keyword">string</span>(<span class="literal">nil</span>), oldnew...)&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Replace本身实现了replacer接口</li>
<li>实际上的替换操作是通过其参数r来完成的</li>
<li>r.once.Do保证参数函数只被执行一次</li>
<li>buildOnce函数完成对参数r的赋值，以及参数oldNew的置空操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	r.once.Do(r.buildOnce)</div><div class="line">	<span class="keyword">return</span> r.r.Replace(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	r.once.Do(r.buildOnce)</div><div class="line">	<span class="keyword">return</span> r.r.WriteString(w, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">buildOnce</span><span class="params">()</span></span> &#123;</div><div class="line">	r.r = r.build()</div><div class="line">	r.oldnew = <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="build方法"><a href="#build方法" class="headerlink" title="build方法"></a>build方法</h3><ul>
<li>build函数完成Replace中r的构造，根据oldnew内容的不通进行筛选<ul>
<li>如果替换的新旧字符串长度为2，且被替换的字符串的长度&gt;1，makeSingleStringReplacer完成替换</li>
<li>如果被替换的字符串不是单字节数据，则调用函数makeGenericReplacer构建通用的替换器</li>
<li>如果只是字节之间的替换，构造器为byteReplacer即可</li>
<li>如果是将单个字节替换为string字符串的情况，则byteStringReplacer可以完成替换能力</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Replacer)</span> <span class="title">build</span><span class="params">()</span> <span class="title">replacer</span></span> &#123;</div><div class="line">	oldnew := b.oldnew</div><div class="line">  <span class="comment">// 如果替换的新旧字符串长度为2，且被替换的字符串的长度&gt;1，makeSingleStringReplacer完成替换</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(oldnew) == <span class="number">2</span> &amp;&amp; <span class="built_in">len</span>(oldnew[<span class="number">0</span>]) &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> makeSingleStringReplacer(oldnew[<span class="number">0</span>], oldnew[<span class="number">1</span>])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	allNewBytes := <span class="literal">true</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">    <span class="comment">// 如果被替换的字符串不是单字节数据，则调用函数makeGenericReplacer构建通用的替换器</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(oldnew[i]) != <span class="number">1</span> &#123;</div><div class="line">			<span class="keyword">return</span> makeGenericReplacer(oldnew)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(oldnew[i+<span class="number">1</span>]) != <span class="number">1</span> &#123;</div><div class="line">			allNewBytes = <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果只是字节之间的替换，构造器为byteReplacer即可</span></div><div class="line">	<span class="keyword">if</span> allNewBytes &#123;</div><div class="line">		r := byteReplacer&#123;&#125;</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> r &#123;</div><div class="line">			r[i] = <span class="keyword">byte</span>(i)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> i := <span class="built_in">len</span>(oldnew) - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">2</span> &#123;</div><div class="line">			o := oldnew[i][<span class="number">0</span>]</div><div class="line">			n := oldnew[i+<span class="number">1</span>][<span class="number">0</span>]</div><div class="line">			r[o] = n</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> &amp;r</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果是将单个字节替换为string字符串的情况，则byteStringReplacer可以完成替换能力</span></div><div class="line">	r := byteStringReplacer&#123;toReplace: <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(oldnew)/<span class="number">2</span>)&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(oldnew) - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">2</span> &#123;</div><div class="line">		o := oldnew[i][<span class="number">0</span>]</div><div class="line">		n := oldnew[i+<span class="number">1</span>]</div><div class="line">		<span class="keyword">if</span> r.replacements[o] == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="comment">// 这个地方用string([]byte&#123;o&#125;)是为了处理o为utf8编码的情况</span></div><div class="line">			r.toReplace = <span class="built_in">append</span>(r.toReplace, <span class="keyword">string</span>([]<span class="keyword">byte</span>&#123;o&#125;))</div><div class="line">		&#125;</div><div class="line">		r.replacements[o] = []<span class="keyword">byte</span>(n)</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="byteReplacer结构体"><a href="#byteReplacer结构体" class="headerlink" title="byteReplacer结构体"></a>byteReplacer结构体</h3><ul>
<li>byteReplacer结构体完成单个ASCII编码字节的替换</li>
<li>Replace方法利用一个256大小的字节数组来完成字节的替换工作</li>
<li>WriteString完成替换，并将替换之后的数据写入到w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> byteReplacer [<span class="number">256</span>]<span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span> <span class="comment">// 懒初始化</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r[b] != b &#123;</div><div class="line">			<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">				buf = []<span class="keyword">byte</span>(s)</div><div class="line">			&#125;</div><div class="line">			buf[i] = r[b]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// TODO(bradfitz): use io.WriteString with slices of s, avoiding allocation.</span></div><div class="line">	bufsize := <span class="number">32</span> &lt;&lt; <span class="number">10</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; bufsize &#123;</div><div class="line">		bufsize = <span class="built_in">len</span>(s)</div><div class="line">	&#125;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</div><div class="line">		ncopy := <span class="built_in">copy</span>(buf, s)</div><div class="line">		s = s[ncopy:]</div><div class="line">    <span class="comment">// 替换操作</span></div><div class="line">		<span class="keyword">for</span> i, b := <span class="keyword">range</span> buf[:ncopy] &#123;</div><div class="line">			buf[i] = r[b]</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 写入操作</span></div><div class="line">		wn, err := w.Write(buf[:ncopy])</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="singleStringReplacer结构体"><a href="#singleStringReplacer结构体" class="headerlink" title="singleStringReplacer结构体"></a>singleStringReplacer结构体</h3><ul>
<li>singleStringReplacer结构体包含两个参数<ul>
<li>finder结构体用于进行字符串的查找</li>
<li>value是查找到的字符串替换为的值</li>
</ul>
</li>
<li>makeSingleStringReplacer完成singleStringReplacer的构建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> singleStringReplacer <span class="keyword">struct</span> &#123;</div><div class="line">	finder *stringFinder</div><div class="line">	<span class="comment">// value is the new string that replaces that pattern when it's found.</span></div><div class="line">	value <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSingleStringReplacer</span><span class="params">(pattern <span class="keyword">string</span>, value <span class="keyword">string</span>)</span> *<span class="title">singleStringReplacer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;singleStringReplacer&#123;finder: makeStringFinder(pattern), value: value&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Replace方法完成字符串的匹配替换</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *singleStringReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span></div><div class="line">	i, matched := <span class="number">0</span>, <span class="literal">false</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 返回匹配到的起始位置</span></div><div class="line">		match := r.finder.next(s[i:])</div><div class="line">		<span class="keyword">if</span> match == <span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		matched = <span class="literal">true</span></div><div class="line">    <span class="comment">// 写入buf</span></div><div class="line">		buf = <span class="built_in">append</span>(buf, s[i:i+match]...)</div><div class="line">		buf = <span class="built_in">append</span>(buf, r.value...)</div><div class="line">		i += match + <span class="built_in">len</span>(r.finder.pattern)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !matched &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	buf = <span class="built_in">append</span>(buf, s[i:]...)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteString将匹配之后的结果写入w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *singleStringReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	<span class="keyword">var</span> i, wn <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		match := r.finder.next(s[i:])</div><div class="line">		<span class="keyword">if</span> match == <span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		wn, err = sw.WriteString(s[i : i+match])</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		wn, err = sw.WriteString(r.value)</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		i += match + <span class="built_in">len</span>(r.finder.pattern)</div><div class="line">	&#125;</div><div class="line">	wn, err = sw.WriteString(s[i:])</div><div class="line">	n += wn</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStringWriter</span><span class="params">(w io.Writer)</span> <span class="title">io</span>.<span class="title">StringWriter</span></span> &#123;</div><div class="line">	sw, ok := w.(io.StringWriter)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		sw = stringWriter&#123;w&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> sw</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// stringWriter实现了io.Writer接口</span></div><div class="line"><span class="keyword">type</span> stringWriter <span class="keyword">struct</span> &#123;</div><div class="line">	w io.Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w stringWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.w.Write([]<span class="keyword">byte</span>(s))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="byteStringReplacer-结构体"><a href="#byteStringReplacer-结构体" class="headerlink" title="byteStringReplacer 结构体"></a>byteStringReplacer 结构体</h3><ul>
<li>byteStringReplacer完成字节替换成字符串的操作的结构体<ul>
<li>replacements记录字符和字符串之间的替换映射关系</li>
<li>toReplace记录待替换的字符数组，以[]string格式记录</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> byteStringReplacer <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// 替换规则</span></div><div class="line">	replacements [<span class="number">256</span>][]<span class="keyword">byte</span></div><div class="line">  <span class="comment">// 待替换的字符串数组，实际上记录的是单个字符的字符串数组</span></div><div class="line">	toReplace []<span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> countCutOff = <span class="number">8</span></div></pre></td></tr></table></figure>
<ul>
<li>Replace方法替换中会根据字符串的长度采用效率更高的方法来确认替换后的字符串需要的空间</li>
<li>然后遍历完成替换操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteStringReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	newSize := <span class="built_in">len</span>(s)</div><div class="line">	anyChanges := <span class="literal">false</span></div><div class="line">	<span class="comment">// Is it faster to use Count?</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.toReplace)*countCutOff &lt;= <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="keyword">for</span> _, x := <span class="keyword">range</span> r.toReplace &#123;</div><div class="line">			<span class="keyword">if</span> c := Count(s, x); c != <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// The -1 is because we are replacing 1 byte with len(replacements[b]) bytes.</span></div><div class="line">				newSize += c * (<span class="built_in">len</span>(r.replacements[x[<span class="number">0</span>]]) - <span class="number">1</span>)</div><div class="line">				anyChanges = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">			b := s[i]</div><div class="line">			<span class="keyword">if</span> r.replacements[b] != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="comment">// See above for explanation of -1</span></div><div class="line">				newSize += <span class="built_in">len</span>(r.replacements[b]) - <span class="number">1</span></div><div class="line">				anyChanges = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !anyChanges &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, newSize)</div><div class="line">	j := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r.replacements[b] != <span class="literal">nil</span> &#123;</div><div class="line">			j += <span class="built_in">copy</span>(buf[j:], r.replacements[b])</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			buf[j] = b</div><div class="line">			j++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteString则直接进行循环替换并写入w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteStringReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	last := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r.replacements[b] == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> last != i &#123;</div><div class="line">			nw, err := sw.WriteString(s[last:i])</div><div class="line">			n += nw</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> n, err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		last = i + <span class="number">1</span></div><div class="line">		nw, err := w.Write(r.replacements[b])</div><div class="line">		n += nw</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> last != <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="keyword">var</span> nw <span class="keyword">int</span></div><div class="line">		nw, err = sw.WriteString(s[last:])</div><div class="line">		n += nw</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="genericReplacer结构体"><a href="#genericReplacer结构体" class="headerlink" title="genericReplacer结构体"></a>genericReplacer结构体</h3><ul>
<li>genericReplacer实际上是完整的通用算法，其余的各种分支是效率更高的快捷替换方法</li>
<li>genericReplacer包含三个参数<ul>
<li>root节点，，类型时trieNode，Trie树的根节点</li>
<li>tableSize int类型 trie树的查找表大小</li>
<li>mapping 完成字节到trie树索引的映射</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> genericReplacer <span class="keyword">struct</span> &#123;</div><div class="line">	root trieNode</div><div class="line">	<span class="comment">// tableSize is the size of a trie node's lookup table. It is the number</span></div><div class="line">	<span class="comment">// of unique key bytes.</span></div><div class="line">	tableSize <span class="keyword">int</span></div><div class="line">	<span class="comment">// mapping maps from key bytes to a dense index for trieNode.table.</span></div><div class="line">	mapping [<span class="number">256</span>]<span class="keyword">byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="trieNode结构体"><a href="#trieNode结构体" class="headerlink" title="trieNode结构体"></a>trieNode结构体</h4><ul>
<li>trieNode是trie树的一个节点，含有5个参数<ul>
<li>value为节点key/value对中的值，如果当前节点不是一个完整的key的话，value为空</li>
<li>priority 优先值，当前节点为完整路径时大于0，否则优先级为0</li>
<li>prefix,next，如果这两个非空，则当前节点有一个子节点</li>
<li>table，如果table非空，则其中记录了所有的子节点</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> trieNode <span class="keyword">struct</span> &#123;</div><div class="line">	value <span class="keyword">string</span></div><div class="line">	priority <span class="keyword">int</span></div><div class="line">	prefix <span class="keyword">string</span></div><div class="line">	next   *trieNode</div><div class="line">	table []*trieNode</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>trieNode的add方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *trieNode)</span> <span class="title">add</span><span class="params">(key, val <span class="keyword">string</span>, priority <span class="keyword">int</span>, r *genericReplacer)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> key == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> t.priority == <span class="number">0</span> &#123;</div><div class="line">			t.value = val</div><div class="line">			t.priority = priority</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> t.prefix != <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// n记录key和t.prefix的最大相同的前缀，也就是n之前是匹配的，n之后是不匹配的</span></div><div class="line">		<span class="keyword">var</span> n <span class="keyword">int</span></div><div class="line">		<span class="keyword">for</span> ; n &lt; <span class="built_in">len</span>(t.prefix) &amp;&amp; n &lt; <span class="built_in">len</span>(key); n++ &#123;</div><div class="line">			<span class="keyword">if</span> t.prefix[n] != key[n] &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n == <span class="built_in">len</span>(t.prefix) &#123;</div><div class="line">      <span class="comment">// 如果n和t.prefix的长度相等，也就是说key之后的部分都是没有的索引值</span></div><div class="line">			t.next.add(key[n:], val, priority, r)</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 首字母就不同，这时候需要在root节点创建个新的查找表</span></div><div class="line">			<span class="keyword">var</span> prefixNode *trieNode</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(t.prefix) == <span class="number">1</span> &#123;</div><div class="line">				prefixNode = t.next</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				prefixNode = &amp;trieNode&#123;</div><div class="line">					prefix: t.prefix[<span class="number">1</span>:],</div><div class="line">					next:   t.next,</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			keyNode := <span class="built_in">new</span>(trieNode)</div><div class="line">			t.table = <span class="built_in">make</span>([]*trieNode, r.tableSize)</div><div class="line">			t.table[r.mapping[t.prefix[<span class="number">0</span>]]] = prefixNode</div><div class="line">			t.table[r.mapping[key[<span class="number">0</span>]]] = keyNode</div><div class="line">			t.prefix = <span class="string">""</span></div><div class="line">			t.next = <span class="literal">nil</span></div><div class="line">			keyNode.add(key[<span class="number">1</span>:], val, priority, r)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 插入节点数据</span></div><div class="line">			next := &amp;trieNode&#123;</div><div class="line">				prefix: t.prefix[n:],</div><div class="line">				next:   t.next,</div><div class="line">			&#125;</div><div class="line">			t.prefix = t.prefix[:n]</div><div class="line">			t.next = next</div><div class="line">			next.add(key[n:], val, priority, r)</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> t.table != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// 插入已经存在table列表中心的节点</span></div><div class="line">		m := r.mapping[key[<span class="number">0</span>]]</div><div class="line">		<span class="keyword">if</span> t.table[m] == <span class="literal">nil</span> &#123;</div><div class="line">			t.table[m] = <span class="built_in">new</span>(trieNode)</div><div class="line">		&#125;</div><div class="line">		t.table[m].add(key[<span class="number">1</span>:], val, priority, r)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 创建根节点</span></div><div class="line">		t.prefix = key</div><div class="line">		t.next = <span class="built_in">new</span>(trieNode)</div><div class="line">		t.next.add(<span class="string">""</span>, val, priority, r)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Replace方法"><a href="#Replace方法" class="headerlink" title="Replace方法"></a>Replace方法</h4><ul>
<li>Replace方法实际上是对WriteString方法的调用，将s替换之后的结果写入到buf中</li>
<li>buf实际上是对io.Writer接口的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>(appendSliceWriter, <span class="number">0</span>, <span class="built_in">len</span>(s))</div><div class="line">	r.WriteString(&amp;buf, s)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> appendSliceWriter []<span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="comment">// Write writes to the buffer to satisfy io.Writer.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *appendSliceWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	*w = <span class="built_in">append</span>(*w, p...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteString writes to the buffer without string-&gt;[]byte-&gt;string allocations.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *appendSliceWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	*w = <span class="built_in">append</span>(*w, s...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WriteString方法"><a href="#WriteString方法" class="headerlink" title="WriteString方法"></a>WriteString方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	<span class="keyword">var</span> last, wn <span class="keyword">int</span></div><div class="line">	<span class="keyword">var</span> prevMatchEmpty <span class="keyword">bool</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="built_in">len</span>(s); &#123;</div><div class="line">		<span class="keyword">if</span> i != <span class="built_in">len</span>(s) &amp;&amp; r.root.priority == <span class="number">0</span> &#123;</div><div class="line">			index := <span class="keyword">int</span>(r.mapping[s[i]])</div><div class="line">			<span class="keyword">if</span> index == r.tableSize || r.root.table[index] == <span class="literal">nil</span> &#123;</div><div class="line">				i++</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		val, keylen, match := r.lookup(s[i:], prevMatchEmpty)</div><div class="line">		prevMatchEmpty = match &amp;&amp; keylen == <span class="number">0</span></div><div class="line">		<span class="keyword">if</span> match &#123;</div><div class="line">			wn, err = sw.WriteString(s[last:i])</div><div class="line">			n += wn</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			wn, err = sw.WriteString(val)</div><div class="line">			n += wn</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			i += keylen</div><div class="line">			last = i</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> last != <span class="built_in">len</span>(s) &#123;</div><div class="line">		wn, err = sw.WriteString(s[last:])</div><div class="line">		n += wn</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 查找方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">lookup</span><span class="params">(s <span class="keyword">string</span>, ignoreRoot <span class="keyword">bool</span>)</span> <span class="params">(val <span class="keyword">string</span>, keylen <span class="keyword">int</span>, found <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	bestPriority := <span class="number">0</span></div><div class="line">	node := &amp;r.root</div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> node != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> node.priority &gt; bestPriority &amp;&amp; !(ignoreRoot &amp;&amp; node == &amp;r.root) &#123;</div><div class="line">			bestPriority = node.priority</div><div class="line">			val = node.value</div><div class="line">			keylen = n</div><div class="line">			found = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> s == <span class="string">""</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> node.table != <span class="literal">nil</span> &#123;</div><div class="line">			index := r.mapping[s[<span class="number">0</span>]]</div><div class="line">			<span class="keyword">if</span> <span class="keyword">int</span>(index) == r.tableSize &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			node = node.table[index]</div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">			n++</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> node.prefix != <span class="string">""</span> &amp;&amp; HasPrefix(s, node.prefix) &#123;</div><div class="line">			n += <span class="built_in">len</span>(node.prefix)</div><div class="line">			s = s[<span class="built_in">len</span>(node.prefix):]</div><div class="line">			node = node.next</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 创建通用的替换器，实际上是完成trie树的构建</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeGenericReplacer</span><span class="params">(oldnew []<span class="keyword">string</span>)</span> *<span class="title">genericReplacer</span></span> &#123;</div><div class="line">	r := <span class="built_in">new</span>(genericReplacer)</div><div class="line">	<span class="comment">// Find each byte used, then assign them each an index.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">		key := oldnew[i]</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="built_in">len</span>(key); j++ &#123;</div><div class="line">			r.mapping[key[j]] = <span class="number">1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> r.mapping &#123;</div><div class="line">		r.tableSize += <span class="keyword">int</span>(b)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> index <span class="keyword">byte</span></div><div class="line">	<span class="keyword">for</span> i, b := <span class="keyword">range</span> r.mapping &#123;</div><div class="line">		<span class="keyword">if</span> b == <span class="number">0</span> &#123;</div><div class="line">			r.mapping[i] = <span class="keyword">byte</span>(r.tableSize)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.mapping[i] = index</div><div class="line">			index++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Ensure root node uses a lookup table (for performance).</span></div><div class="line">	r.root.table = <span class="built_in">make</span>([]*trieNode, r.tableSize)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">		r.root.add(oldnew[i], oldnew[i+<span class="number">1</span>], <span class="built_in">len</span>(oldnew)-i, r)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/strings/reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/strings/reader/" itemprop="url">go源码解读-strings.Reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T10:32:25+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h2><h3 id="strings-Reader结构体"><a href="#strings-Reader结构体" class="headerlink" title="strings.Reader结构体"></a>strings.Reader结构体</h3><ul>
<li>Reader结构体包三个参数<ul>
<li>s,带读取的字符串</li>
<li>i,当前读取到的字符索引值</li>
<li>prevRune上一个读取到的字符索引值</li>
<li>Reader结构体的零值和从空字符串读取创建Reader是等价的</li>
<li>Reader结构体实现了io.Reader, io.ReaderAt, io.Seeker, io.WriterTo,io.ByteScanner, and io.RuneScanner等接口</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">struct</span> &#123;</div><div class="line">	s        <span class="keyword">string</span></div><div class="line">	i        <span class="keyword">int64</span> <span class="comment">// current reading index</span></div><div class="line">	prevRune <span class="keyword">int</span>   <span class="comment">// index of previous rune; or &lt; 0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 结构体初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReader</span><span class="params">(s <span class="keyword">string</span>)</span> *<span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;Reader&#123;s, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>
<h3 id="结构体的方法"><a href="#结构体的方法" class="headerlink" title="结构体的方法"></a>结构体的方法</h3><ul>
<li>Len方法返回字符串s未读取部分的字节数</li>
<li>Size方法返回字符串s的字节数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(<span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) - r.i)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Read方法，从字符串s中读取数据到b中，读取到字节数为len(b)和len(s[s.r:])之间的较小值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadAt方法读取s[off:]之后的字节切片到字符串到b中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadAt</span><span class="params">(b []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// cannot modify state - see io.ReaderAt</span></div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.ReadAt: negative offset"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> off &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[off:])</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="built_in">len</span>(b) &#123;</div><div class="line">		err = io.EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadByte方法从s中读取i指向的字节</li>
<li>UnreadByte方法将reader的索引值i–，还原读取一个字节之前的状态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadByte</span><span class="params">()</span> <span class="params">(<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	b := r.s[r.i]</div><div class="line">	r.i++</div><div class="line">	<span class="keyword">return</span> b, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadByte</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadByte: at beginning of string"</span>)</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	r.i--</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadRune方法从s中读取i指向的字符</li>
<li>UnreadRune方法完成对ReadRune方法的重置</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadRune</span><span class="params">()</span> <span class="params">(ch <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		r.prevRune = <span class="number">-1</span></div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="keyword">int</span>(r.i)</div><div class="line">	<span class="keyword">if</span> c := r.s[r.i]; c &lt; utf8.RuneSelf &#123;</div><div class="line">		r.i++</div><div class="line">		<span class="keyword">return</span> <span class="keyword">rune</span>(c), <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	ch, size = utf8.DecodeRuneInString(r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(size)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadRune: at beginning of string"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.prevRune &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadRune: previous operation was not ReadRune"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = <span class="keyword">int64</span>(r.prevRune)</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Seek方法根据whence设定下一个读取的字符的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">var</span> abs <span class="keyword">int64</span></div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">case</span> io.SeekStart:</div><div class="line">		abs = offset</div><div class="line">	<span class="keyword">case</span> io.SeekCurrent:</div><div class="line">		abs = r.i + offset</div><div class="line">	<span class="keyword">case</span> io.SeekEnd:</div><div class="line">		abs = <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) + offset</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.Seek: invalid whence"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> abs &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.Seek: negative position"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = abs</div><div class="line">	<span class="keyword">return</span> abs, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriterTo方法将w中的数据写入到reader中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">WriteTo</span><span class="params">(w io.Writer)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	s := r.s[r.i:]</div><div class="line">	m, err := io.WriteString(w, s)</div><div class="line">	<span class="keyword">if</span> m &gt; <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.Reader.WriteTo: invalid WriteString count"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i += <span class="keyword">int64</span>(m)</div><div class="line">	n = <span class="keyword">int64</span>(m)</div><div class="line">	<span class="keyword">if</span> m != <span class="built_in">len</span>(s) &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Reset方法完成Reader的重置操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Reset</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123; *r = Reader&#123;s, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/errors/errors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/errors/errors/" itemprop="url">go源码解读-errors包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T10:12:58+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h2><ul>
<li>go语言的errors包比较简单，实际上就是基于内建函数的实现</li>
<li>内建接口error，该接口只含有一个Error方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</div><div class="line">	Error() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上可以根据需要实现error接口来封装自己的error</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MyError is an error implementation that includes a time and message.</span></div><div class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</div><div class="line">	When time.Time</div><div class="line">	What <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v: %v"</span>, e.When, e.What)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>errors包中的实现也只是对一个内部结构体errorString的简单封装</li>
<li>包含初始化函数和Error方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns an error that formats as the given text.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;errorString&#123;text&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// errorString is a trivial implementation of error.</span></div><div class="line"><span class="keyword">type</span> errorString <span class="keyword">struct</span> &#123;</div><div class="line">	s <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errorString)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> e.s</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">110</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">36</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
