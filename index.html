<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/the-way-to-go-advanced/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/16/the-way-to-go-advanced/" itemprop="url">the way to go advaced</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T14:22:48+08:00">
                2020-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第12章-读写数据"><a href="#第12章-读写数据" class="headerlink" title="第12章 读写数据"></a>第12章 读写数据</h1><h2 id="12-1-读取用户的输入"><a href="#12-1-读取用户的输入" class="headerlink" title="12.1 读取用户的输入"></a>12.1 读取用户的输入</h2><ul>
<li>fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止</li>
<li>fmt.Scanf第一个参数用来格式化字符串</li>
<li>fmt.Sscan从字符串读取</li>
<li>bufio.Reader缓冲读，读到指定字符输出一次</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">inputReader := bufio.NewReader(os.Stdin)</div><div class="line">fmt.Println(<span class="string">"Please enter your name:"</span>)</div><div class="line">input, err := inputReader.ReadString(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure>
<h2 id="12-2-文件读写"><a href="#12-2-文件读写" class="headerlink" title="12.2 文件读写"></a>12.2 文件读写</h2><h3 id="12-2-1-读文件"><a href="#12-2-1-读文件" class="headerlink" title="12.2.1 读文件"></a>12.2.1 读文件</h3><ul>
<li>go语言中os.File类型的指针叫做文件句柄</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    inputFile, inputError := os.Open(<span class="string">"input.dat"</span>)</div><div class="line">    <span class="keyword">if</span> inputError != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"An error occurred on opening the inputfile\n Does the file exist?\n Have you got acces to it?\n"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> inputFile.Close()</div><div class="line">    inputReader := bufio.NewReader(inputFile)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        inputString, readerError := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> readerError == io.EOF &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"The input was: %s"</span>, inputString)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>将整个文件的内容读到一个字符串里边去 - ioutil.ReadFile(),第一个返回值是[]byte，第二个是error</li>
<li>带缓冲的读取 - bufio.Reader.Read()</li>
<li>按列读取文件中的数据，空格分隔，fmt.Fscanln(file, str1 str2 str3)</li>
</ul>
<h3 id="12-2-2-compress包：读取压缩文件"><a href="#12-2-2-compress包：读取压缩文件" class="headerlink" title="12.2.2 compress包：读取压缩文件"></a>12.2.2 compress包：读取压缩文件</h3><ul>
<li>compress包支持的压缩文件格式为bzip2,flate,gzip,lzw,zlib</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fz, err := gzip.NewReader(fi)</div></pre></td></tr></table></figure>
<h3 id="12-2-3-写文件"><a href="#12-2-3-写文件" class="headerlink" title="12.2.3 写文件"></a>12.2.3 写文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">outputFile, outputError := os.OpenFile(<span class="string">"output.dat"</span>, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</div><div class="line"><span class="keyword">if</span> outputError != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> outputFile.Close()</div><div class="line">outputWriter := bufio.NewWriter(outputFile)</div><div class="line">outputString := <span class="string">"Hello hello hello"</span></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">    outputWriter.WriteString(outputString)</div><div class="line">&#125;</div><div class="line">outputWrite.Flush()</div></pre></td></tr></table></figure>
<ul>
<li>os.O_RDONLY</li>
<li>os.O_WRONLY</li>
<li>os.O_CREATE：不存在创建</li>
<li>os.O_TRUNC：存在截断长度为0，类似清空</li>
<li>使用os.Stdout.WriteString(“string”) 可以输出到屏幕</li>
</ul>
<h2 id="12-3-文件拷贝"><a href="#12-3-文件拷贝" class="headerlink" title="12.3 文件拷贝"></a>12.3 文件拷贝</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    CopyFile(<span class="string">"target.txt"</span>, <span class="string">"source.txt"</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">    src, err := os.Open(srcName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> src.Close()</div><div class="line"></div><div class="line">    dst, err := os.Create(dstName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> dst.Close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> io.Copy(dst, src)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-4-从命令行读取参数"><a href="#12-4-从命令行读取参数" class="headerlink" title="12.4 从命令行读取参数"></a>12.4 从命令行读取参数</h2><h3 id="12-4-1-os包"><a href="#12-4-1-os包" class="headerlink" title="12.4.1 os包"></a>12.4.1 os包</h3><ul>
<li>os包中的os.Args来处理命令行参数，在程序启动后读取命令行输入的参数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    who := <span class="string">"Alice"</span></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</div><div class="line">        who += strings.Join(os.Args[<span class="number">1</span>:], <span class="string">" "</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"hello"</span>, who)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="12-4-2-flag包"><a href="#12-4-2-flag包" class="headerlink" title="12.4.2 flag包"></a>12.4.2 flag包</h3><ul>
<li>flag包可以用来替换变量</li>
<li>flag.Parse()扫描参数列表或者常量列表</li>
<li>flag.Arg(0) 第一个参数</li>
</ul>
<h2 id="12-5-buffer读取文件"><a href="#12-5-buffer读取文件" class="headerlink" title="12.5 buffer读取文件"></a>12.5 buffer读取文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(r *bufio.Reader)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf, err := r.ReadBytes(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Fprintf(os.Stdout, <span class="string">"%s"</span>, buf)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    <span class="keyword">if</span> flag.NArgs() == <span class="number">0</span> &#123;</div><div class="line">        cat(bufio.NewReader(os.Stdin))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; flag.NArg(); i++ &#123;</div><div class="line">        f, err := os.Open(flag.Arg(i))</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        cat(bufio.NewReader(f))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-6-用切片读写文件"><a href="#12-6-用切片读写文件" class="headerlink" title="12.6 用切片读写文件"></a>12.6 用切片读写文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *os.File)</span></span> &#123;</div><div class="line">    <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">    <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">switch</span> nr, err := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">        <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">            fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading: %s\n"</span>, err.Error())</div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">        <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">if</span> nw, ew := os.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">                fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing: %s\n"</span>, ew.Error())</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-7-defer关闭文件"><a href="#12-7-defer关闭文件" class="headerlink" title="12.7 defer关闭文件"></a>12.7 defer关闭文件</h2><p>函数退出前会执行文件关闭</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">data</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    f, _ := os.Open(name, os.O_RDONLY, <span class="number">0</span>)</div><div class="line">    <span class="keyword">defer</span> f.Close()</div><div class="line">    contents, _ := ioutil.ReadAll(f)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(contents)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-8-fmt-Fprintf"><a href="#12-8-fmt-Fprintf" class="headerlink" title="12.8 fmt.Fprintf"></a>12.8 fmt.Fprintf</h2><p>接口概念阐述例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// unbuffered</span></div><div class="line">    fmt.Fprintf(os.Stdout, <span class="string">"%s\n"</span>, <span class="string">"hello world! - unbuffered"</span>)</div><div class="line">    <span class="comment">// buffered: os.Stdout implements io.Writer</span></div><div class="line">    buf := bufio.NewWriter(os.Stdout)</div><div class="line">    <span class="comment">// and now so does buf.</span></div><div class="line">    fmt.Fprintf(buf, <span class="string">"%s\n"</span>, <span class="string">"hello world! - buffered"</span>)</div><div class="line">    buf.Flush()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>函数签名：<code>func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)</code></p>
</li>
<li><p>第一个参数必须实现io.Writer接口</p>
</li>
</ul>
<h2 id="12-9-json数据格式"><a href="#12-9-json数据格式" class="headerlink" title="12.9 json数据格式"></a>12.9 json数据格式</h2><ul>
<li><p>编码格式JSON，XML，gob等</p>
</li>
<li><p>术语</p>
<ul>
<li>数据结构-&gt;指定格式=序列化或者编码-传输之前</li>
<li>指定格式-&gt;数据结构=反序列化或者解码-传输之后</li>
</ul>
</li>
<li><p>序列化是将内存中的数据结构转换成指定格式</p>
</li>
<li><p>json.Marshal() - 编码，web中使用json.MarshalforHTML()</p>
</li>
<li><p>JSON和go类型对应：</p>
<ul>
<li>bool-boolean</li>
<li>float64-number</li>
<li>string-string</li>
<li>nil-null</li>
</ul>
</li>
<li><p>编码要求：</p>
<ul>
<li>JSON 对象只支持字符串类型的 key；要编码一个 Go map 类型，map 必须是 map[string]T（T是 json 包中支持的任何类型）</li>
<li>Channel，复杂类型和函数类型不能被编码</li>
<li>不支持循环数据结构；它将引起序列化进入一个无限循环</li>
<li>指针可以被编码，实际上是对指针指向的值进行编码（或者指针是 nil）</li>
</ul>
</li>
<li><p>反序列化</p>
<ul>
<li>json.Unmarshal(json, &amp;v)</li>
</ul>
</li>
<li><p>编码和解码流</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewEncoder</span><span class="params">(r io.Writer)</span> *<span class="title">Encoder</span></span></div></pre></td></tr></table></figure>
<ul>
<li>json到文件 encode</li>
<li>文件到json decode</li>
</ul>
<h2 id="12-10-XML数据格式"><a href="#12-10-XML数据格式" class="headerlink" title="12.10 XML数据格式"></a>12.10 XML数据格式</h2><ul>
<li>encoding/xml包含了xml解析器来解析xml内容</li>
<li>marshal()，unMarshal()完成数据结构和xml内容的转换</li>
<li>xml中的标签<ul>
<li>StartElement</li>
<li>Chardata</li>
<li>EndElement</li>
<li>Comment</li>
<li>Directive</li>
<li>ProcInst</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    input := <span class="string">"&lt;Person&gt;&lt;FirstName&gt;Laura&lt;/FirstName&gt;&lt;LastName&gt;Lynn&lt;/LastName&gt;&lt;/Person&gt;"</span></div><div class="line">    inputReader := strings.NewReader(input)</div><div class="line">    p := xml.NewDecoder(inputReader)</div><div class="line">    <span class="keyword">for</span> t, err = p.Token(); err == <span class="literal">nil</span>; t, err = p.Token() &#123;</div><div class="line">        <span class="keyword">switch</span> token := t.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> xml.StartElement:</div><div class="line">            name := token.Name.Local</div><div class="line">            fmt.Printf(<span class="string">"Token name: %s\n"</span>, name)</div><div class="line">            <span class="keyword">for</span> _, attr := <span class="keyword">range</span> token.Attr &#123;</div><div class="line">                attrName := attr.Name.Local</div><div class="line">                attrValue := attr.Value</div><div class="line">                fmt.Printf(<span class="string">"An attribute is: %s %s\n"</span>, attrName, attrValue)</div><div class="line">                <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">        <span class="keyword">case</span> xml.EndElement:</div><div class="line">            fmt.Println(<span class="string">"End of token"</span>)</div><div class="line">        <span class="keyword">case</span> xml.CharData:</div><div class="line">            content := <span class="keyword">string</span>([]<span class="keyword">byte</span>(token))</div><div class="line">            fmt.Printf(<span class="string">"This is the content: %v\n"</span>, content)</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Gob传输数据"><a href="#Gob传输数据" class="headerlink" title="Gob传输数据"></a>Gob传输数据</h2><ul>
<li>Gob是go自己的以二进制形式序列化和反序列化程序数据的格式</li>
<li>Gob通常用于远程调用参数和结果的传输，机器和程序之间的数据传输</li>
<li>Gob只用于go语言中</li>
<li>Gob 文件或流是完全自描述的：里面包含的所有类型都有一个对应的描述，并且总是可以用 Go 解码，而不需要了解文件的内容。</li>
<li>可导出字段会被编码，零值会被忽略</li>
<li>Gob 使用通用的 io.Writer 接口，通过 NewEncoder() 函数创建 Encoder 对象并调用 Encode()；相反的过程使用通用的 io.Reader 接口，通过 NewDecoder() 函数创建 Decoder 对象并调用 Decode()</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> P <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y, Z <span class="keyword">int</span></div><div class="line">    Name    <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Q <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y *<span class="keyword">int32</span></div><div class="line">    Name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// Initialize the encoder and decoder.  Normally enc and dec would be</span></div><div class="line">    <span class="comment">// bound to network connections and the encoder and decoder would</span></div><div class="line">    <span class="comment">// run in different processes.</span></div><div class="line">    <span class="keyword">var</span> network bytes.Buffer   <span class="comment">// Stand-in for a network connection</span></div><div class="line">    enc := gob.NewEncoder(&amp;network) <span class="comment">// Will write to network.</span></div><div class="line">    dec := gob.NewDecoder(&amp;network)    <span class="comment">// Will read from network.</span></div><div class="line">    <span class="comment">// Encode (send) the value.</span></div><div class="line">    err := enc.Encode(P&#123;<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">"Pythagoras"</span>&#125;)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"encode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Decode (receive) the value.</span></div><div class="line">    <span class="keyword">var</span> q Q</div><div class="line">    err = dec.Decode(&amp;q)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"decode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"%q: &#123;%d,%d&#125;\n"</span>, q.Name, *q.X, *q.Y)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编码到文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> &#123;</div><div class="line">    Type             <span class="keyword">string</span></div><div class="line">    City             <span class="keyword">string</span></div><div class="line">    Country          <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> VCard <span class="keyword">struct</span> &#123;</div><div class="line">    FirstName    <span class="keyword">string</span></div><div class="line">    LastName    <span class="keyword">string</span></div><div class="line">    Addresses    []*Address</div><div class="line">    Remark        <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> content    <span class="keyword">string</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    pa := &amp;Address&#123;<span class="string">"private"</span>, <span class="string">"Aartselaar"</span>,<span class="string">"Belgium"</span>&#125;</div><div class="line">    wa := &amp;Address&#123;<span class="string">"work"</span>, <span class="string">"Boom"</span>, <span class="string">"Belgium"</span>&#125;</div><div class="line">    vc := VCard&#123;<span class="string">"Jan"</span>, <span class="string">"Kersschot"</span>, []*Address&#123;pa,wa&#125;, <span class="string">"none"</span>&#125;</div><div class="line">    <span class="comment">// fmt.Printf("%v: \n", vc) // &#123;Jan Kersschot [0x126d2b80 0x126d2be0] none&#125;:</span></div><div class="line">    <span class="comment">// using an encoder:</span></div><div class="line">    file, _ := os.OpenFile(<span class="string">"vcard.gob"</span>, os.O_CREATE|os.O_WRONLY, <span class="number">0666</span>)</div><div class="line">    <span class="keyword">defer</span> file.Close()</div><div class="line">    enc := gob.NewEncoder(file)</div><div class="line">    err := enc.Encode(vc)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Println(<span class="string">"Error in encoding gob"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-12-go中的密码学"><a href="#12-12-go中的密码学" class="headerlink" title="12.12 go中的密码学"></a>12.12 go中的密码学</h2><ul>
<li>hash 包：实现了 adler32、crc32、crc64 和 fnv 校验；</li>
<li>crypto 包：实现了其它的 hash 算法，比如 md4、md5、sha1 等。以及完整地实现了 aes、blowfish、rc4、rsa、xtea 等加密算法。</li>
<li>sha1</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    hasher := sha1.New()</div><div class="line">    io.WriteString(hasher, <span class="string">"test"</span>)</div><div class="line">    b := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, hasher.Sum(b))</div><div class="line">    fmt.Printf(<span class="string">"Result: %d\n"</span>, hasher.Sum(b))</div><div class="line">    <span class="comment">//</span></div><div class="line">    hasher.Reset()</div><div class="line">    data := []<span class="keyword">byte</span>(<span class="string">"We shall overcome!"</span>)</div><div class="line">    n, err := hasher.Write(data)</div><div class="line">    <span class="keyword">if</span> n!=<span class="built_in">len</span>(data) || err!=<span class="literal">nil</span> &#123;</div><div class="line">        log.Printf(<span class="string">"Hash write error: %v / %v"</span>, n, err)</div><div class="line">    &#125;</div><div class="line">    checksum := hasher.Sum(b)</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, checksum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第13章-错误处理与测试"><a href="#第13章-错误处理与测试" class="headerlink" title="第13章 错误处理与测试"></a>第13章 错误处理与测试</h1><ul>
<li>go没有try-catch-finally机制</li>
<li>go有defer-panic-and-recover机制</li>
<li>永远不要忽略错误，否则可能会导致程序崩溃！！</li>
<li>普通错误通过返回值来返回</li>
<li>真正的异常用panic和recover来处理</li>
<li>产生错误的函数会返回两个变量，一个值和一个错误码；如果后者是 nil 就是成功，非 nil 就是发生了错误。</li>
<li>为了防止发生错误时正在执行的函数（如果有必要的话甚至会是整个程序）被中止，在调用函数后必须检查错误。</li>
</ul>
<h2 id="13-1-错误处理"><a href="#13-1-错误处理" class="headerlink" title="13.1 错误处理"></a>13.1 错误处理</h2><ul>
<li>go中的error接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</div><div class="line">    Error() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="13-1-1-定义错误"><a href="#13-1-1-定义错误" class="headerlink" title="13.1.1 定义错误"></a>13.1.1 定义错误</h3><ul>
<li>新建：<code>err := errors.New(&quot;error string&quot;)</code></li>
<li>自定义error</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PathError records an error and the operation and file path that caused it.</span></div><div class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</div><div class="line">    Op <span class="keyword">string</span>    <span class="comment">// "open", "unlink", etc.</span></div><div class="line">    Path <span class="keyword">string</span>  <span class="comment">// The associated file.</span></div><div class="line">    Err error  <span class="comment">// Returned by the system call.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PathError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> e.Op + <span class="string">" "</span> + e.Path + <span class="string">": "</span>+ e.Err.Error()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>错误类型以<code>Error</code>结尾，错误变量以<code>err</code>或者<code>Err</code>开头</li>
</ul>
<h3 id="13-1-2-用fmt创建错误对象"><a href="#13-1-2-用fmt创建错误对象" class="headerlink" title="13.1.2 用fmt创建错误对象"></a>13.1.2 用fmt创建错误对象</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Errorf(<span class="string">"math: square root of negative number %g"</span>, f)</div></pre></td></tr></table></figure>
<h2 id="13-2-运行时异常和panic"><a href="#13-2-运行时异常和panic" class="headerlink" title="13.2 运行时异常和panic"></a>13.2 运行时异常和panic</h2><ul>
<li>运行时异常：数组越界，断言失败等会触发panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Starting the program</div><div class="line"><span class="built_in">panic</span>: A severe error occurred: stopping the program!</div><div class="line"><span class="built_in">panic</span> PC=<span class="number">0x4f</span>3038</div><div class="line">runtime.<span class="built_in">panic</span>+<span class="number">0x99</span> /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">1032</span></div><div class="line">       runtime.<span class="built_in">panic</span>(<span class="number">0x442938</span>, <span class="number">0x4f</span>08e8)</div><div class="line">main.main+<span class="number">0xa5</span> E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.<span class="keyword">go</span>:<span class="number">8</span></div><div class="line">       main.main()</div><div class="line">runtime.mainstart+<span class="number">0xf</span> <span class="number">386</span>/asm.s:<span class="number">84</span></div><div class="line">       runtime.mainstart()</div><div class="line">runtime.goexit /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">148</span></div><div class="line">       runtime.goexit()</div><div class="line">---- Error run E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.exe with code Crashed</div><div class="line">---- Program exited with code <span class="number">-1073741783</span></div></pre></td></tr></table></figure>
<ul>
<li>Go panicking：在多层嵌套的函数调用中调用 panic，可以马上中止当前函数的执行，所有的 defer 语句都会保证执行并把控制权交还给接收到 panic 的函数调用者。这样向上冒泡直到最顶层，并执行（每层的） defer，在栈顶处程序崩溃，并在命令行中用传给 panic 的值报告错误情况：这个终止过程就是 panicking</li>
</ul>
<h2 id="13-3-recover"><a href="#13-3-recover" class="headerlink" title="13.3 recover"></a>13.3 recover</h2><ul>
<li>recover用于从panic中恢复，停止终止过程，恢复正常执行</li>
<li>recover中能在defer修饰的函数中使用，用来取得panic调用中传递过来的错误值，如果是正常执行，调用recover会返回nil，不会生效</li>
<li>panic 会导致栈被展开直到 defer 修饰的 recover() 被调用或者程序中止。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, err)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g() <span class="comment">//   possible runtime-error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>recover和catch很像</li>
<li>defer-panic-recover 在某种意义上也是一种像 if，for 这样的控制流机制</li>
</ul>
<h2 id="13-4-自定义包中的错误处理和panicking"><a href="#13-4-自定义包中的错误处理和panicking" class="headerlink" title="13.4 自定义包中的错误处理和panicking"></a>13.4 自定义包中的错误处理和panicking</h2><ul>
<li>最佳实践<ul>
<li>在包的内部，总是应该从panic中recover，不允许显式的超出包范围的panic()</li>
<li>向包的调用者返回错误值，而不是panic</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// parse.go</span></div><div class="line"><span class="keyword">package</span> parse</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">    <span class="string">"strconv"</span></div><div class="line">)</div><div class="line"><span class="comment">// A ParseError indicates an error in converting a word into an integer.</span></div><div class="line"><span class="keyword">type</span> ParseError <span class="keyword">struct</span> &#123;</div><div class="line">    Index <span class="keyword">int</span>      <span class="comment">// The index into the space-separated list of words.</span></div><div class="line">    Word  <span class="keyword">string</span>   <span class="comment">// The word that generated the parse error.</span></div><div class="line">    Err error <span class="comment">// The raw error that precipitated this error, if any.</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// String returns a human-readable error message.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ParseError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"pkg parse: error parsing %q as int"</span>, e.Word)</div><div class="line">&#125;</div><div class="line"><span class="comment">// Parse parses the space-separated words in in put as integers.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">            err, ok = r.(error)</div><div class="line">            <span class="keyword">if</span> !ok &#123;</div><div class="line">                err = fmt.Errorf(<span class="string">"pkg: %v"</span>, r)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fields := strings.Fields(input)</div><div class="line">    numbers = fields2numbers(fields)</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fields2numbers</span><span class="params">(fields []<span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(fields) == <span class="number">0</span> &#123;</div><div class="line">        <span class="built_in">panic</span>(<span class="string">"no words to parse"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> idx, field := <span class="keyword">range</span> fields &#123;</div><div class="line">        num, err := strconv.Atoi(field)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="built_in">panic</span>(&amp;ParseError&#123;idx, field, err&#125;)</div><div class="line">        &#125;</div><div class="line">        numbers = <span class="built_in">append</span>(numbers, num)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// panic_package.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"./parse/parse"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> examples = []<span class="keyword">string</span>&#123;</div><div class="line">            <span class="string">"1 2 3 4 5"</span>,</div><div class="line">            <span class="string">"100 50 25 12.5 6.25"</span>,</div><div class="line">            <span class="string">"2 + 2 = 4"</span>,</div><div class="line">            <span class="string">"1st class"</span>,</div><div class="line">            <span class="string">""</span>,</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> _, ex := <span class="keyword">range</span> examples &#123;</div><div class="line">        fmt.Printf(<span class="string">"Parsing %q:\n  "</span>, ex)</div><div class="line">        nums, err := parse.Parse(ex)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(err) <span class="comment">// here String() method from ParseError is used</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(nums)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-5-一种用闭包处理错误的模式"><a href="#13-5-一种用闭包处理错误的模式" class="headerlink" title="13.5 一种用闭包处理错误的模式"></a>13.5 一种用闭包处理错误的模式</h2><ul>
<li>每当函数返回时，我们检查是否有错误发生，会很繁琐</li>
<li>defer/panic/recover和闭包可以优雅的解决这个问题，但是要求所有函数都是同一种签名才可以</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    f()</div><div class="line">    fmt.Println(<span class="string">"Returned normally from f."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(<span class="string">"Recovered in f"</span>, r)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fmt.Println(<span class="string">"Calling g."</span>)</div><div class="line">    g(<span class="number">0</span>)</div><div class="line">    fmt.Println(<span class="string">"Returned normally from g."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Panicking!"</span>)</div><div class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v"</span>, i))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"Defer in g"</span>, i)</div><div class="line">    fmt.Println(<span class="string">"Printing in g"</span>, i)</div><div class="line">    g(i + <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">Calling g.</span></div><div class="line"><span class="comment">Printing in g 0</span></div><div class="line"><span class="comment">Printing in g 1</span></div><div class="line"><span class="comment">Printing in g 2</span></div><div class="line"><span class="comment">Printing in g 3</span></div><div class="line"><span class="comment">Panicking!</span></div><div class="line"><span class="comment">Defer in g 3</span></div><div class="line"><span class="comment">Defer in g 2</span></div><div class="line"><span class="comment">Defer in g 1</span></div><div class="line"><span class="comment">Defer in g 0</span></div><div class="line"><span class="comment">Recovered in f 4</span></div><div class="line"><span class="comment">Returned normally from f.</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="13-6-启动外部命令和程序"><a href="#13-6-启动外部命令和程序" class="headerlink" title="13.6 启动外部命令和程序"></a>13.6 启动外部命令和程序</h2><ul>
<li>os包又一个StartProcess函数可以调用或者启动外部系统命令和二进制可执行文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// exec.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os/exec"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"><span class="comment">// 1) os.StartProcess //</span></div><div class="line"><span class="comment">/*********************/</span></div><div class="line"><span class="comment">/* Linux: */</span></div><div class="line">    env := os.Environ()</div><div class="line">    procAttr := &amp;os.ProcAttr&#123;</div><div class="line">               Env: env,</div><div class="line">               Files: []*os.File&#123;</div><div class="line">                   os.Stdin,</div><div class="line">                   os.Stdout,</div><div class="line">                   os.Stderr,</div><div class="line">               &#125;,</div><div class="line">           &#125;</div><div class="line">    <span class="comment">// 1st example: list files</span></div><div class="line">    pid, err := os.StartProcess(<span class="string">"/bin/ls"</span>, []<span class="keyword">string</span>&#123;<span class="string">"ls"</span>, <span class="string">"-l"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line">    <span class="comment">// 2nd example: show all processes</span></div><div class="line">    pid, err = os.StartProcess(<span class="string">"/bin/ps"</span>, []<span class="keyword">string</span>&#123;<span class="string">"-e"</span>, <span class="string">"-opid,ppid,comm"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line"><span class="comment">/* Output 1st:</span></div><div class="line"><span class="comment">The process id is &amp;&#123;2054 0&#125;total 2056</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo 1157555 2011-07-04 16:48 Mieken_exec</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo    2124 2011-07-04 16:48 Mieken_exec.go</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo   18528 2011-07-04 16:48 Mieken_exec_go_.6</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo  913920 2011-06-03 16:13 panic.exe</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo     180 2011-04-11 20:39 panic.go</span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="comment">// 2) exec.Run //</span></div><div class="line"><span class="comment">/***************/</span></div><div class="line"><span class="comment">// Linux:  OK, but not for ls ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls", "-l")  // no error, but doesn't show anything ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls")          // no error, but doesn't show anything ?</span></div><div class="line">    cmd := exec.Command(<span class="string">"gedit"</span>)  <span class="comment">// this opens a gedit-window</span></div><div class="line">    err = cmd.Run()</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Error %v executing command!"</span>, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The command is %v"</span>, cmd)</div><div class="line"><span class="comment">// The command is &amp;&#123;/bin/ls [ls -l] []  &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0xf840000210 &lt;nil&gt; true [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [] [] 0xf8400128c0&#125;</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// in Windows: uitvoering: Error fork/exec /bin/ls: The system cannot find the path specified. starting process!</span></div></pre></td></tr></table></figure>
<h2 id="13-7-go中的单元测试和基准测试"><a href="#13-7-go中的单元测试和基准测试" class="headerlink" title="13.7 go中的单元测试和基准测试"></a>13.7 go中的单元测试和基准测试</h2><ul>
<li>testing包是用来进行自动化测试，日志和错误报告的</li>
<li>单元测试文件名为<code>*_test.go</code>，测试文件不会被普通的go编译器编译，不会被部署，只会被gotest编译</li>
<li><code>func TestAbcde(t *testing.T)</code></li>
<li>测试失败<ul>
<li><code>Fail</code> 失败继续执行</li>
<li><code>FailNow</code>失败终止执行，继续执行下一个文件</li>
<li><code>Log</code> 打印到错误日志</li>
<li><code>Fatal</code> Log+FailNow</li>
</ul>
</li>
<li>基准测试函数 <code>BenchmarkReverse()</code> 用<code>go test -test.bench=.*</code>来执行基准函数</li>
</ul>
<h2 id="13-8-测试实例"><a href="#13-8-测试实例" class="headerlink" title="13.8 测试实例"></a>13.8 测试实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> even</div><div class="line"><span class="keyword">import</span> <span class="string">"testing"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEven</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Even(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 must be even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Even(<span class="number">7</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 7 is not even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOdd</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Odd(<span class="number">11</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 11 must be odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Odd(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 is not odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试用例需要覆盖<ul>
<li>正常的用例</li>
<li>反面的用例</li>
<li>边界检查用例</li>
</ul>
</li>
</ul>
<h2 id="13-9-用测试数据表驱动测试"><a href="#13-9-用测试数据表驱动测试" class="headerlink" title="13.9 用测试数据表驱动测试"></a>13.9 用测试数据表驱动测试</h2><ul>
<li>将测试的输入数据和期望的结果写在一起组成一个数据表，数据表中的每条记录都是一个含有输入和期望值的完整测试用例</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> tests = []<span class="keyword">struct</span>&#123;     <span class="comment">// Test table</span></div><div class="line">    in  <span class="keyword">string</span></div><div class="line">    out <span class="keyword">string</span></div><div class="line">&#125;&#123;</div><div class="line">    &#123;<span class="string">"in1"</span>, <span class="string">"exp1"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in2"</span>, <span class="string">"exp2"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in3"</span>, <span class="string">"exp3"</span>&#125;,</div><div class="line">...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFunction</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">        s := FuncToBeTested(tt.in)</div><div class="line">        <span class="keyword">if</span> s != tt.out &#123;</div><div class="line">            t.Errorf(<span class="string">"%d. %q =&gt; %q, wanted: %q"</span>, i, tt.in, s, tt.out)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-10-性能调试：分析并优化go程序"><a href="#13-10-性能调试：分析并优化go程序" class="headerlink" title="13.10 性能调试：分析并优化go程序"></a>13.10 性能调试：分析并优化go程序</h2><h3 id="13-10-1-时间和内存消耗"><a href="#13-10-1-时间和内存消耗" class="headerlink" title="13.10.1 时间和内存消耗"></a>13.10.1 时间和内存消耗</h3><ul>
<li><code>/usr/bin/time -f &#39;%Uu %Ss %er %MkB %C&#39; goprogexec</code> 用户时间，系统时间，实际时间，最大内存占用</li>
</ul>
<h3 id="13-10-2-go-test调试"><a href="#13-10-2-go-test调试" class="headerlink" title="13.10.2 go test调试"></a>13.10.2 go test调试</h3><ul>
<li>go test -x -v -cpuprofile=prof.out -file x_test.go</li>
</ul>
<h3 id="13-10-3-pprof调试"><a href="#13-10-3-pprof调试" class="headerlink" title="13.10.3 pprof调试"></a>13.10.3 pprof调试</h3><ul>
<li>pprof运行时报告数据</li>
<li>有用的命令<ul>
<li>topN - 分析结果中最开头的N份样本</li>
<li>web - 调用统计，浏览器打开</li>
<li>list - 代码行数和执行消耗时间</li>
</ul>
</li>
</ul>
<h2 id="第14章-协程和通道"><a href="#第14章-协程和通道" class="headerlink" title="第14章 协程和通道"></a>第14章 协程和通道</h2><p>不需要共享内存来通信，而是通过通信来共享内存。</p>
<h3 id="14-1-并发，并行和协程"><a href="#14-1-并发，并行和协程" class="headerlink" title="14.1 并发，并行和协程"></a>14.1 并发，并行和协程</h3><ul>
<li>不要使用全局变量或者共享内存，会给你代码在并发运算时带来风险</li>
<li>go中使用goroutine进行并发运算</li>
<li>协程和操作系统的线程不是一对一的关系，协程是根据一个或多个线程的可用性，映射（多路复用，执行于）在他们之上的；协程调度器在 Go 运行时很好的完成了这个工作。</li>
<li>协程工作在相同的地址空间中，所以共享内存的方式一定是同步的</li>
<li>go使用channel来同步协程</li>
<li>当系统调用阻塞协程时，其他协程会继续在其他线程上工作</li>
<li>协程比线程更轻量级，4K的内存就可以创建一个协程</li>
<li>协程通过关键字go来创建</li>
<li>协程的栈会根据需要进行伸缩，不会溢出，结束会自动退出清理</li>
<li>main可以看做一个协程</li>
<li>init函数中可以运行协程</li>
<li>并发程序可能并行，也可能不是</li>
<li>并行是一种通过多处理器来提高速度的能力</li>
<li><p>go中设置GOMASXPROCS来支持多个系统线程的应用，n个核设置GOMAXPROCS=n-1</p>
</li>
<li><p>Go 协程意味着并行（或者可以以并行的方式部署），协程一般来说不是这样的</p>
</li>
<li>Go 协程通过通道来通信；协程通过让出和恢复操作来通信</li>
</ul>
<h3 id="14-2-协程间的通信"><a href="#14-2-协程间的通信" class="headerlink" title="14.2 协程间的通信"></a>14.2 协程间的通信</h3><h3 id="14-2-1-概念"><a href="#14-2-1-概念" class="headerlink" title="14.2.1 概念"></a>14.2.1 概念</h3><ul>
<li>通道（channel），就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。 数据的所有权（可以读写数据的能力）也因此被传递。</li>
<li>channel未初始化未nil</li>
<li>channel只能传递一种类型的数据</li>
<li>channel实际上是类型化消息的队列，使数据得以传输。它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</li>
<li>channel是引用类型，make来初始化 <code>ch1 := make(chan string)</code></li>
</ul>
<h3 id="14-2-2-通信操作符-lt"><a href="#14-2-2-通信操作符-lt" class="headerlink" title="14.2.2 通信操作符&lt;-"></a>14.2.2 通信操作符<code>&lt;-</code></h3><ul>
<li>数据是按照箭头的方向流动的<ul>
<li><code>ch &lt;-int1</code></li>
<li><code>int2 := &lt;- ch</code></li>
<li><code>&lt;-ch</code></li>
</ul>
</li>
<li>channel的收发都是原子操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    <span class="keyword">go</span> getData(ch)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokyo"</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></div><div class="line">    <span class="comment">// time.Sleep(2e9)</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input = &lt;-ch</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>协程的同步：<ul>
<li>main() 等待了 1 秒让两个协程完成，如果不这样，sendData() 就没有机会输出。</li>
<li>getData() 使用了无限循环：它随着 sendData() 的发送完成和 ch 变空也结束了。</li>
<li>如果我们移除一个或所有 go 关键字，程序无法运行，Go 运行时会抛出 panic：</li>
</ul>
</li>
</ul>
<h3 id="14-2-3-通道阻塞"><a href="#14-2-3-通道阻塞" class="headerlink" title="14.2.3 通道阻塞"></a>14.2.3 通道阻塞</h3><ul>
<li>通道默认是同步且无缓冲的：接收者接收数据之前，发送不会结束。通道的发送和接收操作都是在对方准备好之前是阻塞的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump(ch1)       <span class="comment">// pump hangs</span></div><div class="line">    fmt.Println(&lt;-ch1) <span class="comment">// prints only 0</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 0</span></div></pre></td></tr></table></figure>
<h3 id="14-2-4-通过channel进行协程同步"><a href="#14-2-4-通过channel进行协程同步" class="headerlink" title="14.2.4 通过channel进行协程同步"></a>14.2.4 通过channel进行协程同步</h3><ul>
<li>通过channel，两个协程在通信中的某刻同步交换数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Println(&lt;-in)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    out &lt;- <span class="number">2</span></div><div class="line">    <span class="keyword">go</span> f1(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-5-同步通道-使用带缓冲的通道"><a href="#14-2-5-同步通道-使用带缓冲的通道" class="headerlink" title="14.2.5 同步通道-使用带缓冲的通道"></a>14.2.5 同步通道-使用带缓冲的通道</h3><ul>
<li><code>ch1 := make(chan string, buf)</code> buf为个数</li>
<li>在缓冲满载之前，给通道发送数据是不会被阻塞的</li>
<li>在缓冲空之前，读取是不会阻塞的</li>
</ul>
<h3 id="14-2-6-协程中用通道输出结果"><a href="#14-2-6-协程中用通道输出结果" class="headerlink" title="14.2.6 协程中用通道输出结果"></a>14.2.6 协程中用通道输出结果</h3><p>用通道来完成阻塞</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> sum(bigArray, ch) <span class="comment">// bigArray puts the calculated sum on ch</span></div><div class="line"><span class="comment">// .. do something else for a while</span></div><div class="line">sum := &lt;- ch <span class="comment">// wait for, and retrieve the sum</span></div></pre></td></tr></table></figure>
<h3 id="14-2-7-信号量模式"><a href="#14-2-7-信号量模式" class="headerlink" title="14.2.7 信号量模式"></a>14.2.7 信号量模式</h3><ul>
<li>协程通过在通道中放置一个值来处理结束的信号</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">compute</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</div><div class="line">    ch &lt;- someComputation() <span class="comment">// when it completes, signal on the channel.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// allocate a channel.</span></div><div class="line">    <span class="keyword">go</span> compute(ch)        <span class="comment">// stat something in a goroutines</span></div><div class="line">    doSomethingElseForAWhile()</div><div class="line">    result := &lt;- ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-实现并行的for循环"><a href="#14-2-8-实现并行的for循环" class="headerlink" title="14.2.8 实现并行的for循环"></a>14.2.8 实现并行的for循环</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> data &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">(i <span class="keyword">int</span>, v <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">        doSomething(i, v)</div><div class="line">        ...</div><div class="line">    &#125; (i, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-用带缓冲通道实现一个信号量"><a href="#14-2-8-用带缓冲通道实现一个信号量" class="headerlink" title="14.2.8 用带缓冲通道实现一个信号量"></a>14.2.8 用带缓冲通道实现一个信号量</h3><ul>
<li>信号量是实现互斥锁常见的同步机制<ul>
<li>带缓冲通道的容量和要同步的资源容量相同</li>
<li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li>
<li>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    stream := pump()</div><div class="line">    <span class="keyword">go</span> suck(stream)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(&lt;-ch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-10-给通道使用for循环"><a href="#14-2-10-给通道使用for循环" class="headerlink" title="14.2.10 给通道使用for循环"></a>14.2.10 给通道使用for循环</h3><ul>
<li>for-range</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">    fmt.Printf(<span class="string">"The value is %v\n"</span>, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    suck(pump())</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-2-11-通道的方向"><a href="#14-2-11-通道的方向" class="headerlink" title="14.2.11 通道的方向"></a>14.2.11 通道的方向</h2><ul>
<li>只接收：<code>var recv_noly &lt;-chan int</code></li>
<li>只发送：<code>var send_only chan&lt;- int</code></li>
</ul>
<h2 id="14-3-协程的同步：关闭通道-测试阻塞的通道"><a href="#14-3-协程的同步：关闭通道-测试阻塞的通道" class="headerlink" title="14.3 协程的同步：关闭通道-测试阻塞的通道"></a>14.3 协程的同步：关闭通道-测试阻塞的通道</h2><ul>
<li>通道可以被显示的关闭</li>
<li>发送者需要关闭通道，接收者不需要</li>
<li>关闭方法：defer close(ch)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    getData(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokio"</span></div><div class="line">    <span class="built_in">close</span>(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input, open := &lt;-ch</div><div class="line">        <span class="keyword">if</span> !open &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>for-range来读取通道会检测通道是否会关闭</li>
</ul>
<h2 id="14-4-使用select切换协程"><a href="#14-4-使用select切换协程" class="headerlink" title="14.4 使用select切换协程"></a>14.4 使用select切换协程</h2><ul>
<li>select 被称为通信开关</li>
<li>select可以处理多个通信中的一个</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump1(ch1)</div><div class="line">    <span class="keyword">go</span> pump2(ch2)</div><div class="line">    <span class="keyword">go</span> suck(ch1, ch2)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i * <span class="number">2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i + <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch1, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch1:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 1: %d\n"</span>, v)</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch2:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 2: %d\n"</span>, v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-5-通道、超时和计时器"><a href="#14-5-通道、超时和计时器" class="headerlink" title="14.5 通道、超时和计时器"></a>14.5 通道、超时和计时器</h2><ul>
<li>time.Ticker结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ticker <span class="keyword">struct</span> &#123;</div><div class="line">    C &lt;-<span class="keyword">chan</span> Time <span class="comment">// the channel on which the ticks are delivered.</span></div><div class="line">    <span class="comment">// contains filtered or unexported fields</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以返回一个通道并且不关闭</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rate_per_sec := <span class="number">10</span></div><div class="line"><span class="keyword">var</span> dur Duration = <span class="number">1e9</span></div><div class="line">chRate := time.Tick(dur)</div><div class="line"><span class="keyword">for</span> req := <span class="keyword">range</span> requests &#123;</div><div class="line">    &lt;- chRate</div><div class="line">    <span class="keyword">go</span> client.Call(<span class="string">"Service.Method"</span>, req, ...)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现了按照指定频率处理请求</p>
<ul>
<li>Timer和Ticker类似，但是只会发送一次时间，可以应用在超时模式中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">    timeout&lt;-<span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line"></div><div class="line">    <span class="keyword">case</span> &lt;-timeout</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-6-协程和恢复"><a href="#14-6-协程和恢复" class="headerlink" title="14.6 协程和恢复"></a>14.6 协程和恢复</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(workChan &lt;-<span class="keyword">chan</span> *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> work := <span class="keyword">range</span> workChan &#123;</div><div class="line">        <span class="keyword">go</span> safelyDo(work)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">safelyDo</span><span class="params">(work *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err := revocer(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">""</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    do(work)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>一个协程发生panic会继续执行其他的协程</em></p>
<h2 id="14-7-新旧模型对比"><a href="#14-7-新旧模型对比" class="headerlink" title="14.7 新旧模型对比"></a>14.7 新旧模型对比</h2><h3 id="旧模式-使用共享内存来进行同步"><a href="#旧模式-使用共享内存来进行同步" class="headerlink" title="旧模式 - 使用共享内存来进行同步"></a>旧模式 - 使用共享内存来进行同步</h3><ul>
<li>首先定义一个结构体处理一个任务</li>
<li>各个任务组成任务池来共享内存，引入锁机制</li>
<li>任务数量巨大，则锁机制的开销会导致效率急剧下降</li>
</ul>
<h3 id="新模式-使用通道"><a href="#新模式-使用通道" class="headerlink" title="新模式 - 使用通道"></a>新模式 - 使用通道</h3><ul>
<li>使用一个通道接受需要处理的任务，一个通道接受处理完成的任务及其结果。worker在协程中启动，数量N可以调整</li>
<li>不使用锁的机制，因为从通道获取到新任务不存在竞争关系</li>
<li>我理解实际上锁机制是实现在了channel中，一个channel的获取是原子性的，从而提高性能</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Worker的写法, Master -&gt; Workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;- in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用锁的情景：<ul>
<li>访问共享数据结构中的缓存信息</li>
<li>保存应用程序上下文和状态信息数据</li>
</ul>
</li>
<li>使用通道的情景<ul>
<li>与异步操作的结果进行交互</li>
<li>分发任务</li>
<li>传递数据所有权</li>
</ul>
</li>
</ul>
<h2 id="14-8-惰性生成器的实现"><a href="#14-8-惰性生成器的实现" class="headerlink" title="14.8 惰性生成器的实现"></a>14.8 惰性生成器的实现</h2><ul>
<li>生成器是指当被调用时返回一个序列中下一个值的函数，也被称为惰性求值</li>
<li>int channel实现的生成器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> resume <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">integers</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    yield := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    count := <span class="number">0</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            yield &lt;- count</div><div class="line">            count++</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> yield</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateInteger</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    resume = integers()</div><div class="line">    <span class="keyword">return</span> &lt;- resume</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用空接口，闭包和高阶函数可以实现一个通用的惰性生产期的工厂函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> EvalFunc <span class="function"><span class="keyword">func</span><span class="params">(Any)</span> <span class="params">(Any, Any)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">BuildLazyEvaluator</span><span class="params">(evalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">    retValChan := <span class="built_in">make</span>(<span class="keyword">chan</span> Any)</div><div class="line">    loopFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">var</span> actState Any = initState</div><div class="line">        <span class="keyword">var</span> retVal</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            retVal, actState = evalFunc(actState)</div><div class="line">            retValChan &lt;- retVal</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    retFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> &lt;- retValChan</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> loopFunc()</div><div class="line">    <span class="keyword">return</span> retFunc</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildLazyIntEvaluator</span><span class="params">(evalFunc EvalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    ef := BuildLazyIntEvaluator(evalFunc, initState)</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> ef().(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    evenFunc := <span class="function"><span class="keyword">func</span><span class="params">(state Any)</span> <span class="params">(Any, Any)</span></span> &#123;</div><div class="line">        os := state.(<span class="keyword">int</span>)</div><div class="line">        ns := os + <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> os, ns</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    even := BuildLazyIntEvaluator(evenFunc, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        fmt.</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-9-实现Future模式"><a href="#14-9-实现Future模式" class="headerlink" title="14.9 实现Future模式"></a>14.9 实现Future模式</h2><ul>
<li>Future指的是你使用某一个值之前需要先对其进行计算，因此可以提前计算好</li>
<li>求两个矩阵的乘积的逆 -&gt; 先逆运算再乘</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseProduct</span><span class="params">(a, b Matrix)</span></span> &#123;</div><div class="line">    a_inv_future := InverseFuture(a)</div><div class="line">    b_inv_future := InverseFuture(b)</div><div class="line">    a_inv := &lt;- a_inv_future</div><div class="line">    b_inv := &lt;- b_inv_future</div><div class="line">    <span class="keyword">return</span> Product(a_inv, b_inv)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseFuture</span><span class="params">(a Matrix)</span> <span class="title">chan</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">    future := <span class="built_in">make</span>(<span class="keyword">chan</span> Matrix)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        future &lt;- Inverse(a)</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> future</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-10-复用"><a href="#14-10-复用" class="headerlink" title="14.10 复用"></a>14.10 复用</h2><h3 id="CS模式"><a href="#CS模式" class="headerlink" title="CS模式"></a>CS模式</h3><ul>
<li>go中服务器通常会在协程中执行向客户端的响应，故而会对每一个客户端请求启动一个协程，常见操作为客户端请求包含一个通道，服务器向这个通道中发送响应</li>
<li>使用协程可以大大提高QPS</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> binOp <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">run</span><span class="params">(op binOp, req *Request)</span></span> &#123;</div><div class="line">    req.replyc &lt;- op(req.a, req.b)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span> <span class="params">(op binOp, service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        req := &lt;- service</div><div class="line">        <span class="keyword">go</span> run(op, req)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="title">chan</span> *<span class="title">Request</span></span> &#123;</div><div class="line">    reqChan := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(op, reqChan)</div><div class="line">    <span class="keyword">return</span> reqChan</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    adder := startServer(<span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;<span class="keyword">return</span> a + b&#125;)</div><div class="line">    <span class="keyword">const</span> N = <span class="number">100</span></div><div class="line">    <span class="keyword">var</span> reqs [n]Request</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; N; i++ &#123;</div><div class="line">        req := &amp;reqs[i]</div><div class="line">        req.a = i</div><div class="line">        req.b = i + N</div><div class="line">        req.replyc = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        adder &lt;- req</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通过信号通道关闭服务器"><a href="#通过信号通道关闭服务器" class="headerlink" title="通过信号通道关闭服务器"></a>通过信号通道关闭服务器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="params">(service <span class="keyword">chan</span> *Request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    service = <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    quit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">    <span class="keyword">go</span> server(op, service, quit)</div><div class="line">    <span class="keyword">return</span> service, quit</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(op binOp, service <span class="keyword">chan</span> *request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> req := &lt;-service:</div><div class="line">                <span class="keyword">go</span> run(op, req)</div><div class="line">            <span class="keyword">case</span> &lt;- quit:</div><div class="line">                <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-11-限制同时处理的请求数-带缓冲的通道"><a href="#14-11-限制同时处理的请求数-带缓冲的通道" class="headerlink" title="14.11 限制同时处理的请求数 - 带缓冲的通道"></a>14.11 限制同时处理的请求数 - 带缓冲的通道</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line"><span class="comment">//    ...</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">    process(r)</div><div class="line">    &lt;- sem</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        request := &lt;- service</div><div class="line">        <span class="keyword">go</span> handler(request)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-12-链式协程"><a href="#14-12-链式协程" class="headerlink" title="14.12 链式协程"></a>14.12 链式协程</h2><ul>
<li>海量协程的创建和运行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ngoroutine = flag.Int(<span class="string">"n"</span>, <span class="number">100000</span>, <span class="string">"how many goroutines"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;- right</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">var</span> left, right <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="literal">nil</span>, leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *ngoroutine; i++ &#123;</div><div class="line">        left, right = right, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">    &#125;</div><div class="line">    right &lt;- <span class="number">0</span></div><div class="line">    x := &lt;-leftmost</div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-13-在多核心上并行运算"><a href="#14-13-在多核心上并行运算" class="headerlink" title="14.13 在多核心上并行运算"></a>14.13 在多核心上并行运算</h2><ul>
<li>信号量模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span> &#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU)</div><div class="line">    DOAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-14并行化大量数据的计算"><a href="#14-14并行化大量数据的计算" class="headerlink" title="14.14并行化大量数据的计算"></a>14.14并行化大量数据的计算</h2><ul>
<li>串行处理流水线</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SerialProcessData</span><span class="params">(in &lt;- <span class="keyword">chan</span> *Data, out <span class="keyword">chan</span> &lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> in &#123;</div><div class="line">        tmpA := PreproceeData(data)</div><div class="line">        tmpB := ProcessStepA(tmpA)</div><div class="line">        tmpC := ProcessStepB(tmpB)</div><div class="line">        out &lt;- PostProcessData(tmpC)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParallelProcessData</span><span class="params">(in &lt;-<span class="keyword">chan</span> *Data, out <span class="keyword">chan</span>&lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="comment">// make channels:</span></div><div class="line">    preOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepAOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepBOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepCOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    <span class="comment">// start parallel computations:</span></div><div class="line">    <span class="keyword">go</span> PreprocessData(in, preOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepA(preOut,StepAOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepB(StepAOut,StepBOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepC(StepBOut,StepCOut)</div><div class="line">    <span class="keyword">go</span> PostProcessData(StepCOut,out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-15-漏桶算法"><a href="#14-15-漏桶算法" class="headerlink" title="14.15 漏桶算法"></a>14.15 漏桶算法</h2><ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">client</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">var</span> b *Buffer</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> b = &lt;- freeList</div><div class="line">                <span class="comment">// got one</span></div><div class="line">            <span class="keyword">default</span>: b = <span class="built_in">new</span>(Buffer)</div><div class="line">        &#125;</div><div class="line">        loadInto(b)</div><div class="line">        serverChan &lt;- b</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        b := &lt;-serverChan       <span class="comment">// Wait for work.</span></div><div class="line">        process(b)</div><div class="line">        <span class="comment">// Reuse buffer if there's room.</span></div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> freeList &lt;- b:</div><div class="line">                <span class="comment">// Reuse buffer if free slot on freeList; nothing more to do</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Free list full, just carry on: the buffer is 'dropped'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-16-对go协程进行基准测试"><a href="#14-16-对go协程进行基准测试" class="headerlink" title="14.16 对go协程进行基准测试"></a>14.16 对go协程进行基准测试</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">" sync"</span>, testing.Benchmark(BenchmarkChannelSync).String())</div><div class="line">	fmt.Println(<span class="string">"buffered"</span>, testing.Benchmark(BenchmarkChannelBuffered).String())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelSync</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelBuffered</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-17-使用通道并发访问对象"><a href="#14-17-使用通道并发访问对象" class="headerlink" title="14.17 使用通道并发访问对象"></a>14.17 使用通道并发访问对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name   <span class="keyword">string</span></div><div class="line">	salary <span class="keyword">float64</span></div><div class="line">	chF    <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, salary <span class="keyword">float64</span>)</span> *<span class="title">Person</span></span> &#123;</div><div class="line">	p := &amp;Person&#123;name, salary, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>)&#125;</span></div><div class="line"><span class="function">	<span class="title">go</span> <span class="title">p</span>.<span class="title">backend</span><span class="params">()</span></span></div><div class="line"><span class="function">	<span class="title">return</span> <span class="title">p</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(p *Person)</span> <span class="title">backend</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> f := <span class="keyword">range</span> p.chF &#123;</div><div class="line">		f()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">SetSalary</span><span class="params">(sal <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; p.salary = sal &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Retrieve salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Salary</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	fChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">float64</span>)</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fChan &lt;- p.salary &#125;</div><div class="line">	<span class="keyword">return</span> &lt;-fChan</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"Person - name is: "</span> + p.Name + <span class="string">" - salary is: "</span> + strconv.FormatFloat(p.Salary(), <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">64</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	bs := NewPerson(<span class="string">"Smith Bill"</span>, <span class="number">2500.5</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">	bs.SetSalary(<span class="number">4000.25</span>)</div><div class="line">	fmt.Println(<span class="string">"Salary changed:"</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第15章-网络，模板和网页应用"><a href="#第15章-网络，模板和网页应用" class="headerlink" title="第15章 网络，模板和网页应用"></a>第15章 网络，模板和网页应用</h1><h2 id="15-1-tcp服务器"><a href="#15-1-tcp服务器" class="headerlink" title="15.1 tcp服务器"></a>15.1 tcp服务器</h2><ul>
<li>服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        conn, err := listener.Accept()</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">go</span> doServerStuff(conn)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doServerStuff</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</div><div class="line">        <span class="built_in">len</span>, err := conn.Read(buf)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(<span class="string">"%v"</span>, <span class="keyword">string</span>(buf[:<span class="built_in">len</span>]))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//打开连接:</span></div><div class="line">	conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">//由于目标计算机积极拒绝而无法创建连接</span></div><div class="line">		fmt.Println(<span class="string">"Error dialing"</span>, err.Error())</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 终止程序</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	inputReader := bufio.NewReader(os.Stdin)</div><div class="line">	fmt.Println(<span class="string">"First, what is your name?"</span>)</div><div class="line">	clientName, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">	<span class="comment">// fmt.Printf("CLIENTNAME %s", clientName)</span></div><div class="line">	trimmedClient := strings.Trim(clientName, <span class="string">"\r\n"</span>) <span class="comment">// Windows 平台下用 "\r\n"，Linux平台下使用 "\n"</span></div><div class="line">	<span class="comment">// 给服务器发送信息直到程序退出：</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"What to send to the server? Type Q to quit."</span>)</div><div class="line">		input, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">		trimmedInput := strings.Trim(input, <span class="string">"\r\n"</span>)</div><div class="line">		<span class="comment">// fmt.Printf("input:--%s--", input)</span></div><div class="line">		<span class="comment">// fmt.Printf("trimmedInput:--%s--", trimmedInput)</span></div><div class="line">		<span class="keyword">if</span> trimmedInput == <span class="string">"Q"</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		_, err = conn.Write([]<span class="keyword">byte</span>(trimmedClient + <span class="string">" says: "</span> + trimmedInput))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>改进后的tcp_server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> maxRead = <span class="number">25</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	<span class="keyword">if</span> flag.NArg() != <span class="number">2</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"usage: host port"</span>)</div><div class="line">	&#125;</div><div class="line">	hostAndPort := fmt.Sprintf(<span class="string">"%s:%s"</span>, flag.Arg(<span class="number">0</span>), flag.Arg(<span class="number">1</span>))</div><div class="line">	listener := initServer(hostAndPort)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		conn, err := listener.Accept()</div><div class="line">		checkError(err, <span class="string">"Accept: "</span>)</div><div class="line">		<span class="keyword">go</span> connectionHandler(conn)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initServer</span><span class="params">(hostAndPort <span class="keyword">string</span>)</span> *<span class="title">net</span>.<span class="title">TCPListener</span></span> &#123;</div><div class="line">	serverAddr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, hostAndPort)</div><div class="line">	checkError(err, <span class="string">"Resolving address:port failed: `"</span> + hostAndPort + <span class="string">"'"</span>)</div><div class="line">	listener, err := net.ListenTCP(<span class="string">"tcp"</span>, serverAddr)</div><div class="line">	checkError(err, <span class="string">"ListenTCP: "</span>)</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Listening to:    "</span>, listener.Addr().String())</div><div class="line">	<span class="keyword">return</span> listener</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">connectionHandler</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">	connFrom := conn.RemoteAddr().String()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Connection from: "</span>, connFrom)</div><div class="line">	sayHello(conn)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">var</span> ibuf []<span class="keyword">byte</span> = <span class="built_in">make</span>([]<span class="keyword">byte</span>, maxRead + <span class="number">1</span>)</div><div class="line">		length, err := conn.Read(ibuf[<span class="number">0</span>:maxRead])</div><div class="line">		ibuf[maxRead] = <span class="number">0</span> <span class="comment">// to prevent overflow</span></div><div class="line">		<span class="keyword">switch</span> err &#123;</div><div class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">		   handleMsg(length, err, ibuf)</div><div class="line">		<span class="keyword">case</span> syscall.EAGAIN:  <span class="comment">// try again</span></div><div class="line">		   <span class="keyword">continue</span></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			    <span class="keyword">goto</span> DISCONNECT</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">DISCONNECT:</div><div class="line">	err := conn.Close()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Closed connection: "</span>, connFrom)</div><div class="line">	checkError(err, <span class="string">"Close: "</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">(to net.Conn)</span></span> &#123;</div><div class="line">	obuf := []<span class="keyword">byte</span>&#123;<span class="string">'L'</span>, <span class="string">'e'</span>, <span class="string">'t'</span>, <span class="string">'\''</span>, <span class="string">'s'</span>, <span class="string">' '</span>, <span class="string">'G'</span>, <span class="string">'O'</span>, <span class="string">'!'</span>, <span class="string">'\n'</span>&#125;</div><div class="line">	wrote, err := to.Write(obuf)</div><div class="line">	checkError(err, <span class="string">"Write: wrote "</span> + <span class="keyword">string</span>(wrote) + <span class="string">" bytes."</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMsg</span><span class="params">(length <span class="keyword">int</span>, err error, msg []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> length &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&lt;"</span>, length, <span class="string">":"</span>)</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">			<span class="keyword">if</span> msg[i] == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			fmt.Printf(<span class="string">"%c"</span>, msg[i])</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&gt;"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkError</span><span class="params">(error error, info <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ERROR: "</span> + info + <span class="string">" "</span> + error.Error())  <span class="comment">// terminate goprogram</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-2-简单的网页服务器"><a href="#15-2-简单的网页服务器" class="headerlink" title="15.2 简单的网页服务器"></a>15.2 简单的网页服务器</h2><ul>
<li>net/http包</li>
<li>http.ListenAndServer</li>
<li>http.URL</li>
<li>http.Request</li>
<li>request.FormValue</li>
<li>request.ParseForm</li>
<li>http.HandlerFunc 具体函数 - 对应路径，类似于controller</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Inside HelloServer handler"</span>)</div><div class="line">	fmt.Fprintf(w, <span class="string">"Hello,"</span>+req.URL.Path[<span class="number">1</span>:])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, HelloServer)</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>http.ListenAndServerTLS - https</li>
</ul>
<h2 id="15-3-访问并读取页面"><a href="#15-3-访问并读取页面" class="headerlink" title="15.3 访问并读取页面"></a>15.3 访问并读取页面</h2><ul>
<li><code>http.Head()</code>来请求URL</li>
<li><code>http.Get()</code>获取Body中的网页内容</li>
<li><code>http.Redirect(w RespoonseWriter, r *Request, url string, code int)</code> 浏览器重定向URL</li>
<li><code>http.NotFound(w ResponseWriter, r *Request)</code> 404</li>
<li><code>http.Error(w ResponseWriter, r *Request)</code> 错误信息和错误码</li>
<li><code>http.Request</code></li>
<li><p><code>req.Method</code></p>
</li>
<li><p>go定义的HTTP状态码</p>
<ul>
<li>http.StatusContinue               = 100</li>
<li>http.StatusOK                       = 200</li>
<li>http.StatusFound                   = 302</li>
<li>http.StatusBadRequest            = 400</li>
<li>http.StatusUnauthorized        = 401</li>
<li>http.StatusForbidden            = 403</li>
<li>http.StatusNotFound             = 404</li>
<li>http.StatusInternalServerError    = 500</li>
</ul>
</li>
</ul>
<h2 id="15-4-网页应用"><a href="#15-4-网页应用" class="headerlink" title="15.4 网页应用"></a>15.4 网页应用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> form = <span class="string">`</span></div><div class="line"><span class="string">	&lt;html&gt;&lt;body&gt;</span></div><div class="line"><span class="string">		&lt;form action="#" method="post" name="bar"&gt;</span></div><div class="line"><span class="string">			&lt;input type="text" name="in" /&gt;</span></div><div class="line"><span class="string">			&lt;input type="submit" value="submit"/&gt;</span></div><div class="line"><span class="string">		&lt;/form&gt;</span></div><div class="line"><span class="string">	&lt;/body&gt;&lt;/html&gt;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SimpleServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	io.WriteString(w, <span class="string">"&lt;h1&gt;hello, world&lt;/h1&gt;"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FormServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>)</div><div class="line">	<span class="keyword">switch</span> request.Method &#123;</div><div class="line">	<span class="keyword">case</span> <span class="string">"GET"</span>:</div><div class="line">		io.WriteString(w, form)</div><div class="line">	<span class="keyword">case</span> <span class="string">"POST"</span>:</div><div class="line">		io.WriteString(w, request.FormValue(<span class="string">"in"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/test1"</span>, SimpleServer)</div><div class="line">	http.HandleFunc(<span class="string">"/test2"</span>, FormServer)</div><div class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":8088"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-5-网页应用健壮"><a href="#15-5-网页应用健壮" class="headerlink" title="15.5 网页应用健壮"></a>15.5 网页应用健壮</h2><ul>
<li>使用闭包的错误处理模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> HandleFnc <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">logPanics</span><span class="params">(function HandlerFunc)</span> <span class="title">HandlerFnc</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">                log...</div><div class="line">            &#125;</div><div class="line">        &#125;()</div><div class="line">        function(writer, request)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-6-模板技术动态生成页面"><a href="#15-6-模板技术动态生成页面" class="headerlink" title="15.6 模板技术动态生成页面"></a>15.6 模板技术动态生成页面</h2><ul>
<li>模板缓存</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"regexp"</span></div><div class="line">	<span class="string">"text/template"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> lenPath = <span class="built_in">len</span>(<span class="string">"/view/"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> titleValidator = regexp.MustCompile(<span class="string">"^[a-zA-Z0-9]+$"</span>)</div><div class="line"><span class="keyword">var</span> templates = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*template.Template)</div><div class="line"><span class="keyword">var</span> err error</div><div class="line"></div><div class="line"><span class="keyword">type</span> Page <span class="keyword">struct</span> &#123;</div><div class="line">	Title <span class="keyword">string</span></div><div class="line">	Body  []<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, tmpl := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"edit"</span>, <span class="string">"view"</span>&#125; &#123;</div><div class="line">		templates[tmpl] = template.Must(template.ParseFiles(tmpl + <span class="string">".html"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/view/"</span>, makeHandler(viewHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/edit/"</span>, makeHandler(editHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/save/"</span>, makeHandler(saveHandler))</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeHandler</span><span class="params">(fn <span class="keyword">func</span>(http.ResponseWriter, *http.Request, <span class="keyword">string</span>)</span>) <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		title := r.URL.Path[lenPath:]</div><div class="line">		<span class="keyword">if</span> !titleValidator.MatchString(title) &#123;</div><div class="line">			http.NotFound(w, r)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		fn(w, r, title)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">viewHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// page not found</span></div><div class="line">		http.Redirect(w, r, <span class="string">"/edit/"</span>+title, http.StatusFound)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"view"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">editHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		p = &amp;Page&#123;Title: title&#125;</div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"edit"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	body := r.FormValue(<span class="string">"body"</span>)</div><div class="line">	p := &amp;Page&#123;Title: title, Body: []<span class="keyword">byte</span>(body)&#125;</div><div class="line">	err := p.save()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	http.Redirect(w, r, <span class="string">"/view/"</span>+title, http.StatusFound)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">renderTemplate</span><span class="params">(w http.ResponseWriter, tmpl <span class="keyword">string</span>, p *Page)</span></span> &#123;</div><div class="line">	err := templates[tmpl].Execute(w, p)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Page)</span> <span class="title">save</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	filename := p.Title + <span class="string">".txt"</span></div><div class="line">	<span class="comment">// file created with read-write permissions for the current user only</span></div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filename, p.Body, <span class="number">0600</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">(title <span class="keyword">string</span>)</span> <span class="params">(*Page, error)</span></span> &#123;</div><div class="line">	filename := title + <span class="string">".txt"</span></div><div class="line">	body, err := ioutil.ReadFile(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Page&#123;Title: title, Body: body&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-7-template包-先不看"><a href="#15-7-template包-先不看" class="headerlink" title="15.7 template包 - 先不看"></a>15.7 template包 - 先不看</h2><h2 id="15-8-多功能网页服务器"><a href="#15-8-多功能网页服务器" class="headerlink" title="15.8 多功能网页服务器"></a>15.8 多功能网页服务器</h2><h2 id="15-9-RPC远程调用"><a href="#15-9-RPC远程调用" class="headerlink" title="15.9 RPC远程调用"></a>15.9 RPC远程调用</h2><ul>
<li><p>net/rpc包实现互相通信</p>
</li>
<li><p>rpc_object</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> rpc_objects</div><div class="line"></div><div class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</div><div class="line">	N, M <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Args)</span> <span class="title">Multiply</span><span class="params">(args *Args, reply *<span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	*reply = args.N * args.M</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	calc := <span class="built_in">new</span>(rpc_objects.Args)</div><div class="line">	rpc.Register(calc)</div><div class="line">	rpc.HandleHTTP()</div><div class="line">	listener, e := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</div><div class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Starting RPC-server -listen error:"</span>, e)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> http.Serve(listener, <span class="literal">nil</span>)</div><div class="line">	time.Sleep(<span class="number">1000e9</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>rpc_client</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> serverAddress = <span class="string">"localhost"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	client, err := rpc.DialHTTP(<span class="string">"tcp"</span>, serverAddress + <span class="string">":1234"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Error dialing:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Synchronous call</span></div><div class="line">	args := &amp;rpc_objects.Args&#123;<span class="number">7</span>, <span class="number">8</span>&#125;</div><div class="line">	<span class="keyword">var</span> reply <span class="keyword">int</span></div><div class="line">	err = client.Call(<span class="string">"Args.Multiply"</span>, args, &amp;reply)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Args error:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Args: %d * %d = %d"</span>, args.N, args.M, reply)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-10-基于网络的通道-netchan"><a href="#15-10-基于网络的通道-netchan" class="headerlink" title="15.10 基于网络的通道 netchan"></a>15.10 基于网络的通道 netchan</h2><ul>
<li>netchan包实现了类型安全的网络通道：允许一个通道两端出现由网络连接的不同计算机</li>
<li><p>一组导出器会按名称发布一组通道，导入器连接到导出的机器，并按照名称导入这些通道</p>
</li>
<li><p>发送端</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">exp, err := netchan.NewExporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Exporter: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err := exp.Export(<span class="string">"sendmyType"</span>, ch, netchan.Send)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Send Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接收端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">imp, err := netchan.NewImporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Importer: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err = imp.Import(<span class="string">"sendmyType"</span>, ch, netchan.Receive)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Receive Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-11-websocket"><a href="#15-11-websocket" class="headerlink" title="15.11 websocket"></a>15.11 websocket</h2><ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"new connection\n"</span>)</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">100</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">" =&gt; closing connection\n"</span>)</div><div class="line">	ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.Handle(<span class="string">"/websocket"</span>, websocket.Handler(server))</div><div class="line">	err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ListenAndServe: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	ws, err := websocket.Dial(<span class="string">"ws://localhost:12345/websocket"</span>, <span class="string">""</span>,</div><div class="line">		<span class="string">"http://localhost/"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"Dial: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> readFromServer(ws)</div><div class="line">	time.Sleep(<span class="number">5e9</span>)</div><div class="line">    ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFromServer</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1000</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s\n"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-12-使用smtp发送邮件"><a href="#15-12-使用smtp发送邮件" class="headerlink" title="15.12 使用smtp发送邮件"></a>15.12 使用smtp发送邮件</h2><ul>
<li>smpt Simple Mail Transfer Protocol</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// Set up authentication information.</span></div><div class="line">        auth := smtp.PlainAuth(</div><div class="line">                <span class="string">""</span>,</div><div class="line">                <span class="string">"user@example.com"</span>,</div><div class="line">                <span class="string">"password"</span>,</div><div class="line">                <span class="string">"mail.example.com"</span>,</div><div class="line">        )</div><div class="line">        <span class="comment">// Connect to the server, authenticate, set the sender and recipient,</span></div><div class="line">        <span class="comment">// and send the email all in one step.</span></div><div class="line">        err := smtp.SendMail(</div><div class="line">                <span class="string">"mail.example.com:25"</span>,</div><div class="line">                auth,</div><div class="line">                <span class="string">"sender@example.org"</span>,</div><div class="line">                []<span class="keyword">string</span>&#123;<span class="string">"recipient@example.net"</span>&#125;,</div><div class="line">                []<span class="keyword">byte</span>(<span class="string">"This is the email body."</span>),</div><div class="line">        )</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                log.Fatal(err)</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第16章-常见的错误与陷阱"><a href="#第16章-常见的错误与陷阱" class="headerlink" title="第16章 常见的错误与陷阱"></a>第16章 常见的错误与陷阱</h1><ul>
<li>永远不要声明形如<code>var p*a</code>的变量</li>
<li>永远不要在for循环中改变计数器的变量</li>
<li>永远不要在for-range循环中使用一个值去改变自身的值</li>
<li>永远不要将goto和前置标签一起使用</li>
<li>永远不要忘记在函数名后边加上()</li>
<li>永远不要使用new()创建map</li>
<li>为一个两类型定义一个String方法时，不要使用fmt.Print或者类似的代码</li>
<li>永远不要忘记当终止缓存写入时，使用Flush函数</li>
<li>永远不要忽略错误提示，忽略错误会导致程序崩溃</li>
<li>不要使用全局变量或者共享内存，并发不安全</li>
<li>println函数仅仅用于调试</li>
<li>使用正确的方式初始化一个元素是切片的映射，例如<code>map[type]slice</code></li>
<li>一直使用逗号，ok或者checked形式作为类型断言</li>
<li>使用一个工厂函数创建并初始化自己定义的类型</li>
<li>仅当一个结构体的方法想改变结构体时，使用结构体指针作为方法的接受者，否则使用一个结构体类型</li>
</ul>
<h2 id="16-1-误用短声明导致变量覆盖"><a href="#16-1-误用短声明导致变量覆盖" class="headerlink" title="16.1 误用短声明导致变量覆盖"></a>16.1 误用短声明导致变量覆盖</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">shadow</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	x, err := check1() <span class="comment">// x是新创建变量，err是被赋值</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 正确返回err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> y, err := check2(x); err != <span class="literal">nil</span> &#123; <span class="comment">// y和if语句中err被创建</span></div><div class="line">		<span class="keyword">return</span> <span class="comment">// if语句中的err覆盖外面的err，所以错误的返回nil！</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(y)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="16-2-误用字符串"><a href="#16-2-误用字符串" class="headerlink" title="16.2 误用字符串"></a>16.2 误用字符串</h2><ul>
<li>字符串不可变</li>
<li>字符串运算效率低下</li>
<li>使用字符数组进行运算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> b bytes.Buffer</div><div class="line">...</div><div class="line"><span class="keyword">for</span> condition &#123;</div><div class="line">    b.WriteString(str) <span class="comment">// 将字符串str写入缓存buffer</span></div><div class="line">&#125;</div><div class="line">    <span class="keyword">return</span> b.String()</div></pre></td></tr></table></figure>
<h2 id="16-3-发生错误时使用defer关闭一个文件"><a href="#16-3-发生错误时使用defer关闭一个文件" class="headerlink" title="16.3 发生错误时使用defer关闭一个文件"></a>16.3 发生错误时使用defer关闭一个文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</div><div class="line">    <span class="keyword">if</span> f, err = os.Open(file); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 对文件进行操作</span></div><div class="line">    f.Process(data)</div><div class="line">    <span class="comment">// 关闭文件</span></div><div class="line">    f.Close()</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>defer只在函数返回时才会被执行，在循环的结尾或其他一些有限范围的代码内是不会被执行的</li>
</ul>
<h2 id="16-4-new和make"><a href="#16-4-new和make" class="headerlink" title="16.4 new和make"></a>16.4 new和make</h2><ul>
<li>切片，Map和channel，用make</li>
<li>数组，结构体，值类型用new</li>
</ul>
<h2 id="16-5-不需要将一个指向切片的指针传递给函数"><a href="#16-5-不需要将一个指向切片的指针传递给函数" class="headerlink" title="16.5 不需要将一个指向切片的指针传递给函数"></a>16.5 不需要将一个指向切片的指针传递给函数</h2><ul>
<li>切片实际上就是一个指向潜在数组的指针</li>
<li>当切片作为参数传递时，切记不要解引用切片</li>
</ul>
<h2 id="16-6-使用指针指向接口类型"><a href="#16-6-使用指针指向接口类型" class="headerlink" title="16.6 使用指针指向接口类型"></a>16.6 使用指针指向接口类型</h2><ul>
<li>接口类型已经是一个指针了</li>
</ul>
<h2 id="16-7-使用值类型时误用指针"><a href="#16-7-使用值类型时误用指针" class="headerlink" title="16.7 使用值类型时误用指针"></a>16.7 使用值类型时误用指针</h2><ul>
<li>值类型的内存时栈上分配，内存分配快速且开销不大</li>
<li>指针类型需要在堆上创建，导致额外的内存分配</li>
</ul>
<h2 id="16-8-误用协程和通道"><a href="#16-8-误用协程和通道" class="headerlink" title="16.8 误用协程和通道"></a>16.8 误用协程和通道</h2><ul>
<li>大多数情况下，通过栈传递参数会更有效率</li>
<li>当且仅当代码中并发执行非常重要，才使用协程和通道</li>
</ul>
<h2 id="16-9-闭包和协程的使用"><a href="#16-9-闭包和协程的使用" class="headerlink" title="16.9 闭包和协程的使用"></a>16.9 闭包和协程的使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> values = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 版本A:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123; <span class="comment">// ix是索引值</span></div><div class="line">        <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;() <span class="comment">// 调用闭包打印每个索引值</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    <span class="comment">// 版本B: 和A版本类似，但是通过调用闭包作为一个协程</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本C: 正确的处理方式</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;(ix)</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本D: 输出值:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        val := values[ix]</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(val, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">0 1 2 3 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">4 4 4 4 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">1 0 3 4 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">10 11 12 13 14</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="16-10-糟糕的错误处理"><a href="#16-10-糟糕的错误处理" class="headerlink" title="16.10 糟糕的错误处理"></a>16.10 糟糕的错误处理</h2><ul>
<li>创建一个布尔型变量用于测试错误条件是多余的</li>
<li>避免错误检测使代码变得混乱，使用闭包来封装你的错误检验</li>
</ul>
<h1 id="第17章-Go语言模式"><a href="#第17章-Go语言模式" class="headerlink" title="第17章 Go语言模式"></a>第17章 Go语言模式</h1><h2 id="17-1-逗号，ok模式"><a href="#17-1-逗号，ok模式" class="headerlink" title="17.1 逗号，ok模式"></a>17.1 逗号，ok模式</h2><ol>
<li>函数返回时检查错误<ol>
<li><code>val, err := pack1.Func()</code></li>
</ol>
</li>
<li>检测Map中是否存在一个键值<ol>
<li><code>if value, isPresent = map1[key1]; isPresent {}</code></li>
</ol>
</li>
<li>检测一个接口类型变量varI是否包含了类型T，类型断言<ol>
<li><code>if value, ok := varI.(T); ok {}</code></li>
</ol>
</li>
<li>检测一个通道ch是否关闭<ol>
<li><code>for input := range ch {}</code></li>
</ol>
</li>
</ol>
<h2 id="17-2-defer模式"><a href="#17-2-defer模式" class="headerlink" title="17.2 defer模式"></a>17.2 defer模式</h2><table>
<thead>
<tr>
<th>使用场景</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>关闭一个文件流</td>
<td><code>defer f.Close()</code></td>
</tr>
<tr>
<td>解锁一个被锁定的资源</td>
<td><code>defer mu.Unlock()</code></td>
</tr>
<tr>
<td>关闭一个通道</td>
<td><code>defer close(ch)</code></td>
</tr>
<tr>
<td>从panic恢复</td>
<td><code>defer func(){if err := revocer(); err ！= nil {}}</code></td>
</tr>
<tr>
<td>停止一个计时器</td>
<td><code>defer tick1.Stop()</code></td>
</tr>
<tr>
<td>释放一个进程p</td>
<td><code>defer p，Release()</code></td>
</tr>
<tr>
<td>停止CPU性能分析并立即写入</td>
<td><code>defer pprof.StopCPUProfile()</code></td>
</tr>
</tbody>
</table>
<h2 id="17-3-可见性模式"><a href="#17-3-可见性模式" class="headerlink" title="17.3 可见性模式"></a>17.3 可见性模式</h2><h2 id="17-4-运算符模式和接口"><a href="#17-4-运算符模式和接口" class="headerlink" title="17.4 运算符模式和接口"></a>17.4 运算符模式和接口</h2><h3 id="17-4-1-函数作为运算符"><a href="#17-4-1-函数作为运算符" class="headerlink" title="17.4.1 函数作为运算符"></a>17.4.1 函数作为运算符</h3><ul>
<li>go中没有函数重载，我们不得不给函数起不同的名称，可以将其作为包的私有函数，并暴露单一的 Add() 函数作为公共 API。可以在嵌套的 switch 断言中测试类型，以便在任何支持的参数组合上执行操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a Matrix, b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> a.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> sparseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">		<span class="keyword">case</span> denseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">		…</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-2-方法作为运算符"><a href="#17-4-2-方法作为运算符" class="headerlink" title="17.4.2 方法作为运算符"></a>17.4.2 方法作为运算符</h3><ul>
<li>根据接收者的不同，可以区分不同的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *sparseMatrix)</span> <span class="title">Add</span><span class="params">(b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">	<span class="keyword">case</span> denseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-3-使用接口"><a href="#17-4-3-使用接口" class="headerlink" title="17.4.3 使用接口"></a>17.4.3 使用接口</h3><ul>
<li>不同类型上执行相同的方法时，创建一个通用化的接口以实现多态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Algebraic <span class="keyword">interface</span> &#123;</div><div class="line">	Add(b Algebraic) Algebraic</div><div class="line">	Min(b Algebraic) Algebraic</div><div class="line">	Mult(b Algebraic) Algebraic</div><div class="line">	…</div><div class="line">	Elements()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *denseMatrix)</span> <span class="title">Add</span><span class="params">(b Algebraic)</span> <span class="title">Algebraic</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addDenseToSparse(a, b.(sparseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> x in <span class="keyword">range</span> b.Elements() …</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第18章-实用代码块"><a href="#第18章-实用代码块" class="headerlink" title="第18章 实用代码块"></a>第18章 实用代码块</h1><h2 id="18-1-字符串"><a href="#18-1-字符串" class="headerlink" title="18.1 字符串"></a>18.1 字符串</h2><ul>
<li>如何修改字符串中的一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">str := <span class="string">"hello"</span></div><div class="line">c := []<span class="keyword">byte</span>(str)</div><div class="line">c[<span class="number">0</span>] = <span class="string">'c'</span></div><div class="line">s2 := <span class="keyword">string</span>(c)</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取字符串的子串 - <code>substr := str[n;m]</code></p>
</li>
<li><p>如何使用for或者for-range遍历一个字符串</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gives only the bytes:</span></div><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ &#123;</div><div class="line">… = str[i]</div><div class="line">&#125;</div><div class="line"><span class="comment">// gives the Unicode characters:</span></div><div class="line"><span class="keyword">for</span> ix, ch := <span class="keyword">range</span> str &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取一个字符串的字节数 - len()</p>
</li>
<li><p>如何获取一个字符串的字符数 - utf8.RuneCountInString(str)</p>
</li>
<li><p>如何连接字符串</p>
<ul>
<li><code>with a bytes.Buffer</code></li>
<li><code>Strings.Join()</code></li>
<li><code>+=</code></li>
</ul>
</li>
<li>如何解析命令行参数：使用os或者flag包</li>
</ul>
<h2 id="18-2-数组和切片"><a href="#18-2-数组和切片" class="headerlink" title="18.2 数组和切片"></a>18.2 数组和切片</h2><ul>
<li><p>创建</p>
<ul>
<li><code>arr1 := new([len]type)</code></li>
<li><code>slice1 := make([]type, len)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>arr1 := [...]type{i1,i2,i3,i4,i5}</code></li>
<li><code>arrKeyValue := [len]type{i1:val1, i2: val2}</code></li>
<li><code>var slice1 []type = arr1[start:end]</code></li>
</ul>
</li>
<li><p>截断数组或者切片的最后一个元素</p>
<ul>
<li><code>line = line[:len(line)-1]</code></li>
</ul>
</li>
<li><p>遍历数组或者切片</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</div><div class="line">… = arr[i]</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> ix, value := <span class="keyword">range</span> arr &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>二维数组或者切片中查找指定值V</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">found := <span class="literal">false</span></div><div class="line">Found: <span class="keyword">for</span> row := <span class="keyword">range</span> arr2Dim &#123;</div><div class="line">    <span class="keyword">for</span> column := <span class="keyword">range</span> arr2Dim[row] &#123;</div><div class="line">        <span class="keyword">if</span> arr2Dim[row][column] == V&#123;</div><div class="line">            found = <span class="literal">true</span></div><div class="line">            <span class="keyword">break</span> Found</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-3-Map"><a href="#18-3-Map" class="headerlink" title="18.3 Map"></a>18.3 Map</h2><ul>
<li><p>创建</p>
<ul>
<li><code>map1 := make(map[keyType]valueType)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>map1 := map[string]int{&quot;one&quot;:1, &quot;two&quot;:2}</code></li>
</ul>
</li>
<li><p>遍历</p>
<ul>
<li><code>for key, val := range map1{}</code></li>
</ul>
</li>
<li><p>在map中检测key1是否存在</p>
<ul>
<li><code>val1, isPresent = map1[key1]</code></li>
</ul>
</li>
<li><p>删除一个键</p>
<ul>
<li><code>delete(map1, key1)</code></li>
</ul>
</li>
</ul>
<h2 id="18-4-结构体"><a href="#18-4-结构体" class="headerlink" title="18.4 结构体"></a>18.4 结构体</h2><ul>
<li>创建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> structName <span class="keyword">struct</span> &#123;</div><div class="line">    field1 type1</div><div class="line">    field2 type2</div><div class="line"></div><div class="line">&#125;</div><div class="line">ms := <span class="built_in">new</span>(struct1)</div></pre></td></tr></table></figure>
<ul>
<li><p>初始化</p>
<ul>
<li><code>ms := &amp;struct1{10,10,&quot;chris&quot;}</code></li>
</ul>
</li>
<li><p>结构体命名大写开头则包外可见</p>
</li>
<li>每个结构体需要定义一个构件函数来初始化结构体</li>
</ul>
<h2 id="18-5-接口"><a href="#18-5-接口" class="headerlink" title="18.5 接口"></a>18.5 接口</h2><ul>
<li><p>检测一个值v是否实现了接口Stringer</p>
<ul>
<li><code>if v, ok := v.(Stringer); ok {}</code></li>
</ul>
</li>
<li><p>如何使用接口实现一个类型分类接口</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">classifier</span><span class="params">(items ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, x := <span class="keyword">range</span> items &#123;</div><div class="line">        <span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a bool\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">float64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a float64\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is an int\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is nil\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a string\n"</span>, i)</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d’s type is unknown\n"</span>, i)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-6-函数"><a href="#18-6-函数" class="headerlink" title="18.6 函数"></a>18.6 函数</h2><ul>
<li>使用recover恢复panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, x)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-7-文件"><a href="#18-7-文件" class="headerlink" title="18.7 文件"></a>18.7 文件</h2><ul>
<li>打开并读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">file, err := os.Open(<span class="string">"input.dat"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> file.Close()</div><div class="line"></div><div class="line">iReader := bufio.NewReader(file)</div><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">    str, err := iReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">""</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过切片读写文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *file.File)</span></span> &#123;</div><div class="line">  <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">  <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">  <span class="keyword">for</span> &#123;</div><div class="line">    <span class="keyword">switch</span> nr, er := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">    <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">      fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading from %s: %s\n"</span>,</div><div class="line">        f.String(), er.String())</div><div class="line">      os.Exit(<span class="number">1</span>)</div><div class="line">    <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">      <span class="keyword">return</span></div><div class="line">    <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">      <span class="keyword">if</span> nw, ew := file.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">        fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing from %s: %s\n"</span>,</div><div class="line">          f.String(), ew.String())</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-8-goroutine和channel"><a href="#18-8-goroutine和channel" class="headerlink" title="18.8 goroutine和channel"></a>18.8 goroutine和channel</h2><ul>
<li><p>tips</p>
<ul>
<li>出于性能考虑建议使用带缓存的通道</li>
<li>限制一个通道的数据数量并将它们封装成一个数组</li>
</ul>
</li>
<li><p>遍历一个channel</p>
<ul>
<li><code>for v := range ch {}</code></li>
</ul>
</li>
<li><p>检测一个通道ch是否关闭</p>
<ul>
<li><code>input, open := &lt;-ch; !open { }</code></li>
</ul>
</li>
<li><p>通过一个通道让主程序等待直到协程完成</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    ch &lt;- <span class="number">1</span></div><div class="line">&#125;()</div><div class="line">&lt;-ch</div></pre></td></tr></table></figure>
<ul>
<li>通道的工厂模板</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代器模板</li>
<li>如何限制并发请求的处理数量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">	a, b   <span class="keyword">int</span></div><div class="line">	replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	<span class="comment">// do something</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	sem &lt;- <span class="number">1</span> <span class="comment">// doesn't matter what we put in it</span></div><div class="line">	process(r)</div><div class="line">	&lt;-sem <span class="comment">// one empty place in the buffer: the next request can start</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		request := &lt;-service</div><div class="line">		<span class="keyword">go</span> handle(request)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">	<span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如何在多核上实现并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span>&#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU) <span class="comment">// Buffering optional but sensible</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Drain the channel sem, waiting for NCPU tasks to complete</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// All done.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="comment">// do the part of the computation</span></div><div class="line">    sem &lt;<span class="number">-1</span> <span class="comment">// signal that this piece is done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU) <span class="comment">// runtime.GOMAXPROCS = NCPU</span></div><div class="line">    DoAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何终止一个协程</p>
<ul>
<li><code>runtime.Goexit()</code></li>
</ul>
</li>
<li><p>简单的超时模板</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>) <span class="comment">// one second</span></div><div class="line">    timeout &lt;- <span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line">    <span class="comment">// a read from ch has occurred</span></div><div class="line">    <span class="keyword">case</span> &lt;-timeout:</div><div class="line">    <span class="comment">// the read from ch has timed out</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用输入通道和输出通道代替锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;-in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-9-网络和网页应用"><a href="#18-9-网络和网页应用" class="headerlink" title="18.9 网络和网页应用"></a>18.9 网络和网页应用</h2><ul>
<li>制作解析并使模板生效<ul>
<li><code>var strTempl = template.Must(template.New(&quot;TName&quot;).Parse(strTemplateHTML))</code></li>
</ul>
</li>
</ul>
<h2 id="18-10-其他"><a href="#18-10-其他" class="headerlink" title="18.10 其他"></a>18.10 其他</h2><ul>
<li>在程序出错时终止程序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    ...</div><div class="line">    os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"ERROR occurred: "</span> + err.Error())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-11-出于性能考虑的最佳实践和建议"><a href="#18-11-出于性能考虑的最佳实践和建议" class="headerlink" title="18.11 出于性能考虑的最佳实践和建议"></a>18.11 出于性能考虑的最佳实践和建议</h2><ul>
<li>尽可能的使用<code>:=</code>去初始化声明的一个变量</li>
<li>尽可能的使用字符代替字符串</li>
<li>尽可能使用切片替代数组</li>
<li>尽可能使用数组和切片替换映射</li>
<li>如果只想获取切片中的某项值，不需要值的索引，尽可能使用for-range去遍历切片</li>
<li>当数组元素是稀疏的，使用映射会降低内存消耗</li>
<li>初始化Map时指定其容量</li>
<li>当定义一个方法时，使用指针类型所谓方法的接受者</li>
<li>在代码中使用常量或者标志提取常量的值</li>
<li>尽可能在需要分配大量内存时使用缓存</li>
<li>使用缓存模板</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/the-way-to-go-基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/16/the-way-to-go-基础/" itemprop="url">the way to go 基础篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T14:16:48+08:00">
                2020-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li><p>go语言诞生条件</p>
<ol>
<li>更快的开发速度</li>
<li>优越的多核工作</li>
<li>更好的网络编程环境</li>
<li>享受开发过程</li>
</ol>
</li>
<li><p>go语言追求短小精悍</p>
</li>
</ul>
<h1 id="第一章-Go语言的起源发展与普及"><a href="#第一章-Go语言的起源发展与普及" class="headerlink" title="第一章 Go语言的起源发展与普及"></a>第一章 Go语言的起源发展与普及</h1><h2 id="起源与发展"><a href="#起源与发展" class="headerlink" title="起源与发展"></a>起源与发展</h2><ol>
<li>起源于07年，09年正式发布，Robert Griesemer， Rob Pike, Ken Thompson</li>
<li>2019/11/10 完全开源Linux和MacOSX</li>
<li>2010/1/8 当选2009年年度语言</li>
<li>2010/5 谷歌开始使用</li>
<li>2011/5/5 Google App Engine支持Go语言</li>
<li>几个网址<ul>
<li>官网 golang.org</li>
<li>github.com/golang/go<br>*</li>
</ul>
</li>
</ol>
<h2 id="语言的主要特性和发展的环境和影响因素"><a href="#语言的主要特性和发展的环境和影响因素" class="headerlink" title="语言的主要特性和发展的环境和影响因素"></a>语言的主要特性和发展的环境和影响因素</h2><ul>
<li>go语言追求快速编译（Java)，高效执行(C++)，易于开发(动态语言）</li>
<li>go语言是一门类型安全和内容安全的编程语言</li>
<li>go语言存在指针，但是不允许指针运算</li>
<li>对于并发编程，网络编程支持极好-goroutine</li>
<li>go语言依赖管理采用分包进行</li>
<li>go语言和Java一样有GC机制</li>
<li>go install部署第三方包</li>
</ul>
<h2 id="指导设计原则"><a href="#指导设计原则" class="headerlink" title="指导设计原则"></a>指导设计原则</h2><ul>
<li>go语言关键字25个</li>
<li>go语言编码规范-<a href="https://golang.org/ref/spec" target="_blank" rel="external">https://golang.org/ref/spec</a></li>
</ul>
<h2 id="语言特性"><a href="#语言特性" class="headerlink" title="语言特性"></a>语言特性</h2><ul>
<li>go语言在本质上支持并发编程</li>
<li>go语言没有类的概念，用interface来实现多态</li>
<li>go语言是类型安全的语言，使用静态类型</li>
<li>go语言是强类型语言</li>
<li>go语言支持交叉编译</li>
<li>go语言代码和字符串的编码方式都是utf-8，支持国际化</li>
</ul>
<h2 id="语言用途"><a href="#语言用途" class="headerlink" title="语言用途"></a>语言用途</h2><ul>
<li>go语言用于web服务器，存储集群，分布式场景，游戏服务</li>
<li>go语言的目标是时限CEP, complex Event Process</li>
<li>go语言不适合开发实时性要求高的软件</li>
</ul>
<h2 id="特性缺失"><a href="#特性缺失" class="headerlink" title="特性缺失"></a>特性缺失</h2><ul>
<li>不支持函数重载和操作符重载</li>
<li>不支持隐式转换</li>
<li>不支持类和类型的继承</li>
<li>不支持变体类型</li>
<li>不支持动态加载代码</li>
<li>不支持动态链接库</li>
<li>不支持泛型</li>
<li>通过recover和panic来替代异常机制</li>
<li>不支持静态变量</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>简化问题，易于学习</li>
<li>内存管理，语法简洁，易于使用</li>
<li>快速编译，高效开发</li>
<li>高效执行</li>
<li>并发支持，轻松驾驭</li>
<li>静态类型</li>
<li>标准类库，规范统一</li>
<li>易于部署</li>
</ul>
<h1 id="第二章-安装与运行环境"><a href="#第二章-安装与运行环境" class="headerlink" title="第二章 安装与运行环境"></a>第二章 安装与运行环境</h1><h2 id="平台与架构"><a href="#平台与架构" class="headerlink" title="平台与架构"></a>平台与架构</h2><ul>
<li>编译器支持的平台：<ul>
<li>Linux</li>
<li>FreeBSD</li>
<li>Mac OS X</li>
</ul>
</li>
<li>编译器<ul>
<li>gc</li>
<li>gccgo</li>
</ul>
</li>
</ul>
<h2 id="Go环境变量"><a href="#Go环境变量" class="headerlink" title="Go环境变量"></a>Go环境变量</h2><ul>
<li>$GOROOT：go的安装位置</li>
<li>$GOARCH：机器的处理器架构</li>
<li>$GOOS：操作系统</li>
<li>$GOBIN：编译器和链接器的安装位置</li>
<li>$GOPATH：包含多个Go语言远吗文件，包文件和可执行文件，src，pkg，bin三个目录</li>
<li>$GOARM：ARM专用</li>
<li>$GOMAXPROCS：设置可用的处理器核数</li>
</ul>
<h2 id="Linux安装go"><a href="#Linux安装go" class="headerlink" title="Linux安装go"></a>Linux安装go</h2><ol>
<li><p>Linux下通过<code>$HOME/.bashrc</code>来自定义环境</p>
<ul>
<li>首先配置GOROOT：<code>export GOROOT=$HOME/go</code></li>
<li>配置path：<code>export PATH=$PATH:$GOROOT/bin</code></li>
<li>配置工作路径：<code>export GOPATH=$HOME/Applications/Go</code></li>
<li><code>source ~/.bashrc</code>生效</li>
<li><code>go env</code>查看</li>
</ul>
</li>
<li><p>go源码获取</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://storage.googleapis.com/golang/go&lt;VERSION&gt;.src.tar.gz</div><div class="line">tar -zxvf go&lt;VERSION&gt;.src.tar.gz</div><div class="line">sudo mv go $GOROOT</div><div class="line">cd $GOROOT/src</div><div class="line">./all.bash</div></pre></td></tr></table></figure>
</li>
<li><p>go version查看版本信息</p>
</li>
</ol>
<h2 id="安装目录"><a href="#安装目录" class="headerlink" title="安装目录"></a>安装目录</h2><pre><code>.
├── CONTRIBUTING.md
├── CONTRIBUTORS
├── PATENTS
├── VERSION
├── api
├── bin     // 可执行文件
├── doc     // 文档
├── favicon.ico
├── lib     // 文档模板
├── misc    // 编辑器相关内容
├── pkg
├── robots.txt
├── src     // 完整源码
└── test
</code></pre><h2 id="go-runtime"><a href="#go-runtime" class="headerlink" title="go runtime"></a>go runtime</h2><ul>
<li>runtime相当于Java的虚拟机，负责内存分配，垃圾回收，栈处理，goroutine，channel，slice，map，reflect等</li>
<li>go的gc采用标记-清除回收器</li>
</ul>
<h1 id="第三章-Go开发环境的基本要求"><a href="#第三章-Go开发环境的基本要求" class="headerlink" title="第三章 Go开发环境的基本要求"></a>第三章 Go开发环境的基本要求</h1><h2 id="调试器"><a href="#调试器" class="headerlink" title="调试器"></a>调试器</h2><ol>
<li>打印语句，print，println,fmt.Println,fmt.Printf</li>
<li>%+v, %#v,%T打印实例的不同信息</li>
<li>使用panic获取堆栈信息</li>
<li>defer关键字来跟踪代码执行</li>
<li>go build 编译</li>
<li>go install 编译并安装</li>
</ol>
<h2 id="格式化代码-gofmt"><a href="#格式化代码-gofmt" class="headerlink" title="格式化代码 - gofmt"></a>格式化代码 - gofmt</h2><ul>
<li><code>gofmt -r &#39;(a) -&gt; a&#39; –w *.go</code></li>
<li><code>gofmt -r &#39;a[n:len(a)] -&gt; a[n:]&#39; –w *.go</code></li>
<li>参考-<a href="http://golang.org/cmd/gofmt/" target="_blank" rel="external">http://golang.org/cmd/gofmt/</a></li>
</ul>
<h2 id="代码文档-go-doc"><a href="#代码文档-go-doc" class="headerlink" title="代码文档 - go doc"></a>代码文档 - go doc</h2><ul>
<li>go doc package 获取包的文档注释，例如：go doc fmt 会显示使用 godoc 生成的 fmt 包的文档注释。</li>
<li>go doc package/subpackage 获取子包的文档注释，例如：go doc container/list。</li>
<li>go doc package function 获取某个函数在某个包中的文档注释，例如：go doc fmt Printf 会显示有关 fmt.Printf() 的使用说明</li>
</ul>
<h1 id="第四章-语言的核心结构和技术"><a href="#第四章-语言的核心结构和技术" class="headerlink" title="第四章 语言的核心结构和技术"></a>第四章 语言的核心结构和技术</h1><h2 id="文件名、关键字与标识符"><a href="#文件名、关键字与标识符" class="headerlink" title="文件名、关键字与标识符"></a>文件名、关键字与标识符</h2><ul>
<li>文件名以<code>.go</code>结尾</li>
<li><code>_</code>空白标识符</li>
<li>go的25个关键字</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">break</td>
<td style="text-align:center">default</td>
<td style="text-align:center">func</td>
<td style="text-align:center">interface</td>
<td style="text-align:center">selcet</td>
</tr>
<tr>
<td style="text-align:center">case</td>
<td style="text-align:center">defer</td>
<td style="text-align:center">go</td>
<td style="text-align:center">map</td>
<td style="text-align:center">struct</td>
</tr>
<tr>
<td style="text-align:center">chan</td>
<td style="text-align:center">else</td>
<td style="text-align:center">goto</td>
<td style="text-align:center">package</td>
<td style="text-align:center">switch</td>
</tr>
<tr>
<td style="text-align:center">const</td>
<td style="text-align:center">fallthrough</td>
<td style="text-align:center">if</td>
<td style="text-align:center">range</td>
<td style="text-align:center">type</td>
</tr>
<tr>
<td style="text-align:center">continue</td>
<td style="text-align:center">for</td>
<td style="text-align:center">import</td>
<td style="text-align:center">return</td>
<td style="text-align:center">var</td>
</tr>
</tbody>
</table>
<ul>
<li>36个预定义标识符，函数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">预定义标识符</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">append</td>
<td style="text-align:center">bool</td>
<td style="text-align:center">byte</td>
<td style="text-align:center">cap</td>
<td style="text-align:center">close</td>
<td style="text-align:center">complex</td>
<td style="text-align:center">complex64</td>
<td style="text-align:center">complex128</td>
<td style="text-align:center">unit16</td>
</tr>
<tr>
<td style="text-align:center">copy</td>
<td style="text-align:center">false</td>
<td style="text-align:center">float32</td>
<td style="text-align:center">float64</td>
<td style="text-align:center">image</td>
<td style="text-align:center">int</td>
<td style="text-align:center">int8</td>
<td style="text-align:center">int16</td>
<td style="text-align:center">uint32</td>
</tr>
<tr>
<td style="text-align:center">int32</td>
<td style="text-align:center">int64</td>
<td style="text-align:center">iota</td>
<td style="text-align:center">len</td>
<td style="text-align:center">make</td>
<td style="text-align:center">new</td>
<td style="text-align:center">nil</td>
<td style="text-align:center">panic</td>
<td style="text-align:center">unit64</td>
</tr>
<tr>
<td style="text-align:center">print</td>
<td style="text-align:center">println</td>
<td style="text-align:center">real</td>
<td style="text-align:center">recover</td>
<td style="text-align:center">string</td>
<td style="text-align:center">true</td>
<td style="text-align:center">uint</td>
<td style="text-align:center">uint8</td>
<td style="text-align:center">uintptr</td>
</tr>
</tbody>
</table>
<ul>
<li>go程序一般由关键字，常量，变量，运算符，类型和函数组成</li>
<li>分隔符 <code>(), [], {}</code></li>
<li>标点<code>.、,、;、:、...</code>等，但是不用<code>;</code>结尾</li>
</ul>
<h2 id="Go程序的基本结构要素"><a href="#Go程序的基本结构要素" class="headerlink" title="Go程序的基本结构要素"></a>Go程序的基本结构要素</h2><h3 id="包-package"><a href="#包-package" class="headerlink" title="包-package"></a>包-package</h3><ul>
<li>包是结构化的一种方式，每个程序都有包的概念组成，一个包可以由多个.go文件组成</li>
<li>在源文件的第一行指明这个文件属于哪个包</li>
<li>一个包的源文件必须一起编译，包是编译的单元</li>
<li>对一个包进行更改或者重新编译，所有引用了这个包的客户端程序都必须全部重新编译</li>
<li>go中包模型采用显示依赖关系机制来打到快速变异的目的</li>
<li><p>包引入</p>
<pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="keyword">import</span> <span class="string">"os"</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>包名不是以<code>.</code>或者<code>/</code>开头，会在全局文件进行查找，以<code>./</code>开头会在相对目录中查找,以<code>/</code>开头会在绝对路径中查找</p>
</li>
<li>可见性规则：标识符的大小写区别</li>
<li>包可以用别名进行区分</li>
</ul>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul>
<li><p>定义格式</p>
<pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">(parameter_list)</span> <span class="params">(return_value_list)</span></span> &#123;</div><div class="line">   …</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>go语言是以<code>;</code>作为语句的结尾，只是由编译器自动完成</p>
</li>
<li>内部包命名遵循驼峰命名法，外部调用的遵循Pascal命名法</li>
<li>程序正常退出代码为0，异常退出代码为1</li>
</ul>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><ul>
<li><code>//</code> - 单行注释</li>
<li><code>/*  */</code> - 多行注释</li>
<li>每个包都应该有注释，package关键字之前的注释默认为对包的说明</li>
<li>全局作用于的类型、变量、常量、函数、对象都应该有一个合理的注释</li>
</ul>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><ul>
<li>类型定义了某个变量的值的集合和可对其进行操作的集合</li>
<li>基础类型：int、float、bool、string、</li>
<li>复合类型：struct、array、slice、map、channel</li>
<li>描述行为的：interface</li>
<li>函数可以作为类型返回</li>
</ul>
<h3 id="go程序的一般结构"><a href="#go程序的一般结构" class="headerlink" title="go程序的一般结构"></a>go程序的一般结构</h3><ul>
<li>完成包的导入</li>
<li>常量，变量，类型的定义或声明</li>
<li>如果存在init函数，对改函数进行定义，每个含有该函数的文件都会先执行init函数</li>
<li>如果包为main包，则定义main函数</li>
<li><p>定义其他的函数，首先是类型的方法，函数名字可以按照字母顺序来排列</p>
</li>
<li><p>go语言执行顺序：</p>
<ul>
<li>按顺序导入所有被main包引入的其他包</li>
<li>如果包中引入了其他包，递归执行包的引入</li>
<li>最新引入的包首先开始常量和变量的初始化</li>
<li>init</li>
<li>main</li>
</ul>
</li>
</ul>
<h3 id="类型抓换"><a href="#类型抓换" class="headerlink" title="类型抓换"></a>类型抓换</h3><ul>
<li>显示转换</li>
<li><code>a := b(a)</code></li>
</ul>
<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><ul>
<li>const关键字定义</li>
<li>类型：bool，int，float，complex，string</li>
<li><code>const Pi = 3.1415926</code></li>
<li>常量的值必须在编译时就能够确定</li>
<li>数字型的常量是没有大小和符号的，不会溢出</li>
<li>iota特性</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><ul>
<li><p>实例<br>  <code>var a string</code></p>
  <figure class="highlight plain"><figcaption><span>(</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">    a int</div><div class="line">    b bool</div><div class="line">    str string</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>变量被声明之后，系统会自动赋给该变量零值0，0.0， false，’’， nil</p>
</li>
<li>驼峰命名法</li>
<li>全局变量和局部变量</li>
<li><p>变量的声明和赋值可以一起进行</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="number">15</span></div><div class="line"><span class="keyword">var</span> b = <span class="literal">false</span></div><div class="line"><span class="keyword">var</span> str = <span class="string">"Go says hello to the world!"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	a = <span class="number">15</span></div><div class="line">	b = <span class="literal">false</span></div><div class="line">	str = <span class="string">"Go says hello to the world!"</span></div><div class="line">	numShips = <span class="number">50</span></div><div class="line">	city <span class="keyword">string</span></div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>通过runtime获取运行环境</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">   <span class="string">"runtime"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> goos <span class="keyword">string</span> = runtime.GOOS</div><div class="line">	fmt.Printf(<span class="string">"The operating system is: %s\n"</span>, goos)</div><div class="line">	path := os.Getenv(<span class="string">"PATH"</span>)</div><div class="line">	fmt.Printf(<span class="string">"Path is %s\n"</span>, path)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="值类型和引用类型"><a href="#值类型和引用类型" class="headerlink" title="值类型和引用类型"></a>值类型和引用类型</h3><ul>
<li>指针 &amp;i</li>
<li>一个引用类型的变量r1存储的是r1的值所在的内存地址，或内存地址中第一个字所在的位置</li>
<li>go语言中指针，slice，maps，channel都是引用类型</li>
</ul>
<h3 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h3><ul>
<li>fmt.Printf</li>
<li>%s-字符串</li>
<li>%v-类型默认输出格式</li>
<li>%T-类型</li>
</ul>
<h3 id="赋值操作符"><a href="#赋值操作符" class="headerlink" title=":=赋值操作符"></a><code>:=</code>赋值操作符</h3><ul>
<li><code>a := 50</code>,类型会自动判断</li>
<li>函数体内的首选方案，但是不能用于全局变量</li>
<li><code>a, b, c := 5, 5.5, &quot;5&quot;</code></li>
<li>a, b = b, a 交换值</li>
<li><code>_</code>抛弃不要的值</li>
</ul>
<h3 id="init函数"><a href="#init函数" class="headerlink" title="init函数"></a>init函数</h3><ul>
<li>不能被人为调用</li>
<li>执行优先级高于main</li>
<li>每个源文件只包含一个init函数</li>
<li>init中可以定义变量，检查数据，调用后台goroutine</li>
</ul>
<h2 id="基本类型和运算符"><a href="#基本类型和运算符" class="headerlink" title="基本类型和运算符"></a>基本类型和运算符</h2><h3 id="bool类型"><a href="#bool类型" class="headerlink" title="bool类型"></a>bool类型</h3><ul>
<li><code>var b bool = true</code></li>
<li><code>==</code>, <code>!=</code></li>
<li>go语言只有类型相同的两个值才可以进行比较</li>
<li><code>!、&amp;&amp;、||</code>，其中<code>&amp;&amp;</code>和<code>||</code></li>
<li>布尔值的命名推荐以is开头，如isSorted，isFinished等</li>
</ul>
<h3 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h3><ul>
<li>int，uint - 4个字节或者8个字节</li>
<li><p>uintptr - 存放一个指针的长度</p>
</li>
<li><p>整数：</p>
<ul>
<li>int8（-128 -&gt; 127）</li>
<li>int16（-32768 -&gt; 32767）</li>
<li>int32（-2,147,483,648 -&gt; 2,147,483,647）</li>
<li>int64（-9,223,372,036,854,775,808 -&gt; 9,223,372,036,854,775,807）</li>
</ul>
</li>
<li>无符号整数：<ul>
<li>uint8（0 -&gt; 255）</li>
<li>uint16（0 -&gt; 65,535）</li>
<li>uint32（0 -&gt; 4,294,967,295）</li>
<li>uint64（0 -&gt; 18,446,744,073,709,551,615）</li>
</ul>
</li>
<li><p>浮点型（IEEE-754 标准）：</p>
<ul>
<li>float32（+- 1e-45 -&gt; +- 3.4 * 1e38）</li>
<li>float64（+- 5 <em> 1e-324 -&gt; 107 </em> 1e308</li>
</ul>
</li>
<li><p>前缀0表示8进制数</p>
</li>
<li>前缀0x表示16进制数</li>
<li>e表示10的次方</li>
<li>go语言中变量之间不可以混用，常量可以，变量之间需要显示转换</li>
<li><p>格式化占位符</p>
<ul>
<li>%d - 整数</li>
<li>%x,%X - 16进制数字</li>
<li>%g - 浮点数</li>
<li>%f - 输出浮点数</li>
<li>%e - 输出科学计数法数</li>
<li>%n.mg - 数字n精确到m位</li>
</ul>
</li>
<li><p>位运算 - 用于整数类型的变量，并且要求变量等长</p>
<ul>
<li>按位与<code>&amp;</code></li>
<li>按位或<code>|</code></li>
<li>按位异或<code>^</code></li>
<li>位清除<code>&amp;^</code>将指定位置上的值设置为0</li>
<li>按位补足<code>^</code></li>
<li>位左移<code>&lt;&lt;</code></li>
<li>位右移<code>&gt;&gt;</code></li>
</ul>
</li>
<li><p>逻辑运算符</p>
<ul>
<li>==</li>
<li>!=</li>
<li>&lt;</li>
<li>&lt;=</li>
<li>&gt;</li>
<li><blockquote>
<p>=</p>
</blockquote>
</li>
</ul>
</li>
<li><p>算数运算符</p>
<ul>
<li>+</li>
<li>-</li>
<li>*</li>
<li>/</li>
<li>%</li>
<li>-=</li>
<li>+=</li>
<li>*=</li>
<li>/=</li>
<li>++，–等操作可以用于语句，但是不可以用于表达式 a[i] = b[i++]是不允许的</li>
</ul>
</li>
<li><p>随机数 - rand包</p>
</li>
</ul>
<h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">优先级 	运算符</div><div class="line"> 7 		^ !</div><div class="line"> 6 		* / % &lt;&lt; &gt;&gt; &amp; &amp;^</div><div class="line"> 5 		+ - | ^</div><div class="line"> 4 		== != &lt; &lt;= &gt;= &gt;</div><div class="line"> 3 		&lt;-</div><div class="line"> 2 		&amp;&amp;</div><div class="line"> 1 		||</div></pre></td></tr></table></figure>
<h3 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h3><ul>
<li><code>type TZ int</code> TZ是int的别名</li>
<li>别名不会拥有原类型的方法</li>
</ul>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><ul>
<li>utf-8编码中每个字符占据字节数不确定，go中字符可能占据1-4个字节</li>
<li>go语言支持两种字面值<ul>
<li>解释字符串<ul>
<li><code>\n</code></li>
<li><code>\r</code></li>
<li><code>\t</code></li>
<li><code>\u</code></li>
<li><code>\\</code></li>
</ul>
</li>
<li>非解释字符串-普通字符串</li>
</ul>
</li>
<li>获取字符串的字节内容：str[i]</li>
<li>拼接符<code>+</code></li>
<li>效率： bytes.Buffer &gt; strings.Join &gt; +</li>
</ul>
<h2 id="strings和strconv包"><a href="#strings和strconv包" class="headerlink" title="strings和strconv包"></a>strings和strconv包</h2><h3 id="前缀和后缀"><a href="#前缀和后缀" class="headerlink" title="前缀和后缀"></a>前缀和后缀</h3><ul>
<li><p>HasPrefix - 前缀</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasPrefix tests whether the string s begins with prefix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, prefix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(prefix) &amp;&amp; s[<span class="number">0</span>:<span class="built_in">len</span>(prefix)] == prefix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>HasSuffix - 后缀</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasSuffix tests whether the string s ends with suffix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasSuffix</span><span class="params">(s, suffix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(suffix) &amp;&amp; s[<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix):] == suffix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="字符串包含关系"><a href="#字符串包含关系" class="headerlink" title="字符串包含关系"></a>字符串包含关系</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Contains reports whether substr is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Contains</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Index(s, substr) &gt;= <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="判断子字符串或字符在父字符串中出现的位置"><a href="#判断子字符串或字符在父字符串中出现的位置" class="headerlink" title="判断子字符串或字符在父字符串中出现的位置"></a>判断子字符串或字符在父字符串中出现的位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// Index returns the index of the first instance of substr in s, or -1 if substr is not present in s.</div><div class="line">func Index(s, substr string) int &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// LastIndex returns the index of the last instance of substr in s, or -1 if substr is not present in s.</div><div class="line">func LastIndex(s, substr string) int &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// IndexRune returns the index of the first instance of the Unicode code point</div><div class="line">// r, or -1 if rune is not present in s.</div><div class="line">// If r is utf8.RuneError, it returns the first instance of any</div><div class="line">// invalid UTF-8 byte sequence.</div><div class="line">func IndexRune(s string, r rune) int &#123;</div><div class="line">	switch &#123;</div><div class="line">	case 0 &lt;= r &amp;&amp; r &lt; utf8.RuneSelf:</div><div class="line">		return IndexByte(s, byte(r))</div><div class="line">	case r == utf8.RuneError:</div><div class="line">		for i, r := range s &#123;</div><div class="line">			if r == utf8.RuneError &#123;</div><div class="line">				return i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return -1</div><div class="line">	case !utf8.ValidRune(r):</div><div class="line">		return -1</div><div class="line">	default:</div><div class="line">		return Index(s, string(r))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="字符串替换"><a href="#字符串替换" class="headerlink" title="字符串替换"></a>字符串替换</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Replace returns a copy of the string s with the first n</span></div><div class="line"><span class="comment">// non-overlapping instances of old replaced by new.</span></div><div class="line"><span class="comment">// If old is empty, it matches at the beginning of the string</span></div><div class="line"><span class="comment">// and after each UTF-8 sequence, yielding up to k+1 replacements</span></div><div class="line"><span class="comment">// for a k-rune string.</span></div><div class="line"><span class="comment">// If n &lt; 0, there is no limit on the number of replacements.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Replace</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> old == <span class="built_in">new</span> || n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Compute number of replacements.</span></div><div class="line">	<span class="keyword">if</span> m := Count(s, old); m == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &lt; <span class="number">0</span> || m &lt; n &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Apply replacements to buffer.</span></div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)+n*(<span class="built_in">len</span>(<span class="built_in">new</span>)-<span class="built_in">len</span>(old)))</div><div class="line">	w := <span class="number">0</span></div><div class="line">	start := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		j := start</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(old) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</div><div class="line">				_, wid := utf8.DecodeRuneInString(s[start:])</div><div class="line">				j += wid</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			j += Index(s[start:], old)</div><div class="line">		&#125;</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], s[start:j])</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], <span class="built_in">new</span>)</div><div class="line">		start = j + <span class="built_in">len</span>(old)</div><div class="line">	&#125;</div><div class="line">	w += <span class="built_in">copy</span>(t[w:], s[start:])</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(t[<span class="number">0</span>:w])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重复字符串"><a href="#重复字符串" class="headerlink" title="重复字符串"></a>重复字符串</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Repeat returns a new string consisting of count copies of the string s.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// It panics if count is negative or if</span></div><div class="line"><span class="comment">// the result of (len(s) * count) overflows.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(s <span class="keyword">string</span>, count <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="修改字符串大小写"><a href="#修改字符串大小写" class="headerlink" title="修改字符串大小写"></a>修改字符串大小写</h3><ul>
<li>strings.ToLower(s) string</li>
<li>strings.ToUpper(s) string</li>
</ul>
<h3 id="修剪字符串"><a href="#修剪字符串" class="headerlink" title="修剪字符串"></a>修剪字符串</h3><ul>
<li>strings.TrimSpcae(s)-剔除字符串开头和结尾的空白</li>
<li>strings.Trim(s, “cut”)-剔除字符串开头和结尾的指定字符</li>
<li>TrimLeft,TrimRight</li>
</ul>
<h3 id="分割字符串"><a href="#分割字符串" class="headerlink" title="分割字符串"></a>分割字符串</h3><ul>
<li>strings.Fields(s) - 根据空白字符分割</li>
<li>strigns.Split(s, sep) - 根据sep来分割字符串</li>
</ul>
<h3 id="拼接slice到字符串"><a href="#拼接slice到字符串" class="headerlink" title="拼接slice到字符串"></a>拼接slice到字符串</h3><ul>
<li>strings.Join(sl []string, sep string) string - 将slice使用分隔符sep来拼接成一个字符串</li>
</ul>
<h3 id="从字符串中读取内容"><a href="#从字符串中读取内容" class="headerlink" title="从字符串中读取内容"></a>从字符串中读取内容</h3><ul>
<li>strings.NewReader(str)</li>
<li>Read()</li>
<li>ReadByte()</li>
<li>ReadRune()</li>
</ul>
<h3 id="字符串和其他类型的转换"><a href="#字符串和其他类型的转换" class="headerlink" title="字符串和其他类型的转换"></a>字符串和其他类型的转换</h3><ul>
<li>strconv.Itoa(i int) string - int转换成字符串</li>
<li>strconv.FormatFloat() string</li>
<li>strconv.Atoi(s string) (int, error) 字符串到int</li>
<li>strconv.ParseFloat(s string, bitSize int) (f float, err error)</li>
</ul>
<h2 id="时间和日期"><a href="#时间和日期" class="headerlink" title="时间和日期"></a>时间和日期</h2><ul>
<li>time包</li>
<li>time.Now</li>
<li>time.Day()</li>
<li>time.Minute()</li>
<li>time.Duration()</li>
</ul>
<h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><ul>
<li>取地址符<code>&amp;</code></li>
<li>一个指针变量可以指向任何一个值的内存地址</li>
<li>通过指针来实现对原来变量值的修改</li>
<li>指针可以用来传递变量的引用，而不是变量的值的拷贝，节省开销</li>
</ul>
<h1 id="第五章-控制结构"><a href="#第五章-控制结构" class="headerlink" title="第五章 控制结构"></a>第五章 控制结构</h1><h2 id="5-1-if-else结构"><a href="#5-1-if-else结构" class="headerlink" title="5.1 if-else结构"></a>5.1 if-else结构</h2><pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> condition1 &#123;</div><div class="line">	<span class="comment">// do something</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> condition2 &#123;</div><div class="line">	<span class="comment">// do something else</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">// catch-all or default</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li>判断一个字符串是否为空</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>  str == <span class="string">""</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="built_in">len</span>(str) == <span class="number">0</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>判断go运行的操作系统</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> runtime.GOOS == <span class="string">"windows"</span> &#123;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试多返回值函数的错误"><a href="#测试多返回值函数的错误" class="headerlink" title="测试多返回值函数的错误"></a>测试多返回值函数的错误</h2><ul>
<li>程序应该在最接近的位置检查所有相关的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">value, err := pack1.Function1(param1)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"An error occured in pack1.Function1 with parameter %v"</span>, param1)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> value, ok := readData(); ok &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="switch结构"><a href="#switch结构" class="headerlink" title="switch结构"></a>switch结构</h2><ul>
<li>使用fallthrough表示执行完当前分支之后继续执行后续分支</li>
<li>分支之间没有break关键字</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> num <span class="keyword">int</span> = <span class="number">100</span></div><div class="line"></div><div class="line">    <span class="keyword">switch</span> num &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">98</span>, <span class="number">99</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    <span class="keyword">case</span> <span class="number">100</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>无初始值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> num1 <span class="keyword">int</span> = <span class="number">7</span></div><div class="line"></div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	    <span class="keyword">case</span> num1 &lt; <span class="number">0</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is negative"</span>)</div><div class="line">	    <span class="keyword">case</span> num1 &gt; <span class="number">0</span> &amp;&amp; num1 &lt; <span class="number">10</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is between 0 and 10"</span>)</div><div class="line">	    <span class="keyword">default</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is 10 or greater"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>包含一个初始化语句</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> a, b := x[i], y[j] &#123;</div><div class="line">	<span class="keyword">case</span> a &lt; b: t = <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> a == b: t = <span class="number">0</span></div><div class="line">	<span class="keyword">case</span> a &gt; b: t = <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="for结构"><a href="#for结构" class="headerlink" title="for结构"></a>for结构</h2><ul>
<li>基于计数器的迭代</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</div><div class="line">	fmt.Printf(<span class="string">"This is the %d iteration\n"</span>, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>基于条件判断的迭代</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i &gt;= <span class="number">0</span> &#123;</div><div class="line">	i = i - <span class="number">1</span></div><div class="line">	fmt.Printf(<span class="string">"The variable i is now: %d\n"</span>, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>无线循环 - 服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> t, err = p.Token(); err == <span class="literal">nil</span>; t, err = p.Token() &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>for-range结构</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	str := <span class="string">"Go is a beautiful language!"</span></div><div class="line">	fmt.Printf(<span class="string">"The length of str is: %d\n"</span>, <span class="built_in">len</span>(str))</div><div class="line">	<span class="keyword">for</span> pos, char := <span class="keyword">range</span> str &#123;</div><div class="line">		fmt.Printf(<span class="string">"Character on position %d is: %c \n"</span>, pos, char)</div><div class="line">	&#125;</div><div class="line">	fmt.Println()</div><div class="line">	str2 := <span class="string">"Chinese: 日本語"</span></div><div class="line">	fmt.Printf(<span class="string">"The length of str2 is: %d\n"</span>, <span class="built_in">len</span>(str2))</div><div class="line">	<span class="keyword">for</span> pos, char := <span class="keyword">range</span> str2 &#123;</div><div class="line">    	fmt.Printf(<span class="string">"character %c starts at byte position %d\n"</span>, char, pos)</div><div class="line">	&#125;</div><div class="line">	fmt.Println()</div><div class="line">	fmt.Println(<span class="string">"index int(rune) rune    char bytes"</span>)</div><div class="line">	<span class="keyword">for</span> index, <span class="keyword">rune</span> := <span class="keyword">range</span> str2 &#123;</div><div class="line">    	fmt.Printf(<span class="string">"%-2d      %d      %U '%c' % X\n"</span>, index, <span class="keyword">rune</span>, <span class="keyword">rune</span>, <span class="keyword">rune</span>, []<span class="keyword">byte</span>(<span class="keyword">string</span>(<span class="keyword">rune</span>)))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="break与continue"><a href="#break与continue" class="headerlink" title="break与continue"></a>break与continue</h2><ul>
<li>break关键字可以退出for循环</li>
<li>break只会退出一层</li>
<li>continue会忽略剩余的循环体跳入下一次循环</li>
</ul>
<h2 id="标签与goto"><a href="#标签与goto" class="headerlink" title="标签与goto"></a>标签与goto</h2><ul>
<li>标签作用于外部循环</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">LABEL1:</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt;= <span class="number">5</span>; j++ &#123;</div><div class="line">			<span class="keyword">if</span> j == <span class="number">4</span> &#123;</div><div class="line">				<span class="keyword">continue</span> LABEL1</div><div class="line">			&#125;</div><div class="line">			fmt.Printf(<span class="string">"i is: %d, and j is: %d\n"</span>, i, j)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>goto和标签可以来模仿循环</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	i:=<span class="number">0</span></div><div class="line">	HERE:</div><div class="line">		<span class="built_in">print</span>(i)</div><div class="line">		i++</div><div class="line">		<span class="keyword">if</span> i==<span class="number">5</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">goto</span> HERE</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第六章-函数"><a href="#第六章-函数" class="headerlink" title="第六章 函数"></a>第六章 函数</h1><h2 id="6-1-简介"><a href="#6-1-简介" class="headerlink" title="6.1 简介"></a>6.1 简介</h2><ul>
<li>函数是基本的代码块</li>
<li>main写在文件的前面</li>
<li>函数主要是为了代码重用</li>
<li>最后一行或者return退出函数</li>
<li>go中包含三种函数<ul>
<li>普通带有名字的函数</li>
<li>匿名函数或者lambda函数</li>
<li>方法</li>
</ul>
</li>
<li>出了main，init函数之外，其他所有函数都可以有参数和返回值</li>
<li>参数，返回值，及其类型称为函数签名-和其他语言一致</li>
<li>函数可以将其他函数作为它的参数，类型相符合就可以</li>
<li>go语言不允许函数重载</li>
<li>函数是一等公民</li>
<li>函数可以相互比较，引用相同就相等</li>
<li>go语言不支持泛型</li>
</ul>
<h2 id="6-2-函数参数与返回值"><a href="#6-2-函数参数与返回值" class="headerlink" title="6.2 函数参数与返回值"></a>6.2 函数参数与返回值</h2><ul>
<li>函数可以接收参数供自己使用，也可以返回零个或者多个值</li>
<li>go语言默认值传递</li>
<li>go语言通过指针来实现引用传递，实际上指针也是变量类型，有自己的地址和值，只是指针的值指向一个变量的地址，按引用传递可以理解为按值传递，传递的值就是指针的值。</li>
<li>slice，map,interface,channel默认引用传递</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"Multiply 2 * 5 * 6 = %d\n"</span>, MultiPly3Nums(<span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>))</div><div class="line">    <span class="comment">// var i1 int = MultiPly3Nums(2, 5, 6)</span></div><div class="line">    <span class="comment">// fmt.Printf("MultiPly 2 * 5 * 6 = %d\n", i1)</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiPly3Nums</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>, c <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">    <span class="comment">// var product int = a * b * c</span></div><div class="line">    <span class="comment">// return product</span></div><div class="line">    <span class="keyword">return</span> a * b * c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="命名的返回值"><a href="#命名的返回值" class="headerlink" title="命名的返回值"></a>命名的返回值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> num <span class="keyword">int</span> = <span class="number">10</span></div><div class="line"><span class="keyword">var</span> numx2, numx3 <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    numx2, numx3 = getX2AndX3(num)</div><div class="line">    PrintValues()</div><div class="line">    numx2, numx3 = getX2AndX3_2(num)</div><div class="line">    PrintValues()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintValues</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"num = %d, 2x num = %d, 3x num = %d\n"</span>, num, numx2, numx3)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getX2AndX3</span><span class="params">(input <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">2</span> * input, <span class="number">3</span> * input</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getX2AndX3_2</span><span class="params">(input <span class="keyword">int</span>)</span> <span class="params">(x2 <span class="keyword">int</span>, x3 <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    x2 = <span class="number">2</span> * input</div><div class="line">    x3 = <span class="number">3</span> * input</div><div class="line">    <span class="comment">// return x2, x3</span></div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>尽量使用命名返回值：会使得代码清晰，更简短，可读性更好。</li>
</ul>
<h3 id="空白符"><a href="#空白符" class="headerlink" title="空白符"></a>空白符</h3><ul>
<li>空白符用来丢弃一些不需要的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> i1 <span class="keyword">int</span></div><div class="line">    <span class="keyword">var</span> f1 <span class="keyword">float32</span></div><div class="line">    i1, _, f1 = ThreeValues()</div><div class="line">    fmt.Printf(<span class="string">"The int: %d, the float: %f \n"</span>, i1, f1)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ThreeValues</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">float32</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">5</span>, <span class="number">6</span>, <span class="number">7.5</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="改变外部变量"><a href="#改变外部变量" class="headerlink" title="改变外部变量"></a>改变外部变量</h3><ul>
<li>指针传递不仅可以节省内存，而且赋予函数改变外部变量的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// this function changes reply:</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Multiply</span><span class="params">(a, b <span class="keyword">int</span>, reply *<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    *reply = a * b</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    n := <span class="number">0</span></div><div class="line">    reply := &amp;n</div><div class="line">    Multiply(<span class="number">10</span>, <span class="number">5</span>, reply)</div><div class="line">    fmt.Println(<span class="string">"Multiply:"</span>, *reply) <span class="comment">// Multiply: 50</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-3-传递变长参数"><a href="#6-3-传递变长参数" class="headerlink" title="6.3 传递变长参数"></a>6.3 传递变长参数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	x := min(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>)</div><div class="line">	fmt.Printf(<span class="string">"The minimum is: %d\n"</span>, x)</div><div class="line">	slice := []<span class="keyword">int</span>&#123;<span class="number">7</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>&#125;</div><div class="line">	x = min(slice...)</div><div class="line">	fmt.Printf(<span class="string">"The minimum in the slice is: %d"</span>, x)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">min</span><span class="params">(s ...<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s)==<span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	min := s[<span class="number">0</span>]</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> v &lt; min &#123;</div><div class="line">			min = v</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> min</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-4-defer和追踪"><a href="#6-4-defer和追踪" class="headerlink" title="6.4 defer和追踪"></a>6.4 defer和追踪</h2><ul>
<li>defer语句在函数结束之前才开始执行，适用于资源的释放等操作，类似于finally</li>
<li>defer的语句会按顺序接收参数，只是执行在最后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">defer</span> fmt.Println(i)</div><div class="line">	i++</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125; <span class="comment">// print 0</span></div></pre></td></tr></table></figure>
<ul>
<li>多个defer语句，类似栈，先出现后执行</li>
<li>关闭文件流，解锁，打印最终报告，关闭数据库连接</li>
<li>defer可以实现代码追踪，在进入和离开函数时打印日志</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">trace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"entering:"</span>, s)</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">un</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"leaving:"</span>, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> un(trace(<span class="string">"a"</span>))</div><div class="line">	fmt.Println(<span class="string">"in a"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> un(trace(<span class="string">"b"</span>))</div><div class="line">	fmt.Println(<span class="string">"in b"</span>)</div><div class="line">	a()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	b()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-5-内置函数"><a href="#6-5-内置函数" class="headerlink" title="6.5 内置函数"></a>6.5 内置函数</h2><table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">close</td>
<td style="text-align:center">用于管道通信</td>
</tr>
<tr>
<td style="text-align:center">len</td>
<td style="text-align:center">返回某个类型的长度或数量，如字符串，数组，切片，map和管道</td>
</tr>
<tr>
<td style="text-align:center">cap</td>
<td style="text-align:center">返回某个类型的最大容量，如切片，map</td>
</tr>
<tr>
<td style="text-align:center">new</td>
<td style="text-align:center">用于值类型和用户定义的类型的创建</td>
</tr>
<tr>
<td style="text-align:center">make</td>
<td style="text-align:center">用于内置类型的创建</td>
</tr>
<tr>
<td style="text-align:center">copy，append</td>
<td style="text-align:center">用于复制和连接切片</td>
</tr>
<tr>
<td style="text-align:center">panic，recover</td>
<td style="text-align:center">错误处理机制</td>
</tr>
<tr>
<td style="text-align:center">print, println</td>
<td style="text-align:center">底层打印函数</td>
</tr>
<tr>
<td style="text-align:center">complex， real imag</td>
<td style="text-align:center">复数操作</td>
</tr>
</tbody>
</table>
<h2 id="6-6-递归函数"><a href="#6-6-递归函数" class="headerlink" title="6.6 递归函数"></a>6.6 递归函数</h2><ul>
<li>自身调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fib</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(res <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>递归的一个问题在于栈溢出</li>
<li>go语言中可以使用相互调用的递归函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"%d is even: is %t\n"</span>, <span class="number">16</span>, even(<span class="number">16</span>)) <span class="comment">// 16 is even: is true</span></div><div class="line">	fmt.Printf(<span class="string">"%d is odd: is %t\n"</span>, <span class="number">17</span>, odd(<span class="number">17</span>))</div><div class="line">	<span class="comment">// 17 is odd: is true</span></div><div class="line">	fmt.Printf(<span class="string">"%d is odd: is %t\n"</span>, <span class="number">18</span>, odd(<span class="number">18</span>))</div><div class="line">	<span class="comment">// 18 is odd: is false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">even</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> odd(RevSign(nr) - <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">odd</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> even(RevSign(nr) - <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RevSign</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> -nr</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nr</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-7-将函数作为参数"><a href="#6-7-将函数作为参数" class="headerlink" title="6.7 将函数作为参数"></a>6.7 将函数作为参数</h2><ul>
<li>go语言中函数可以作为其他函数的参数进行传递，然后在其他函数内调用执行，称为回调函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	callback(<span class="number">1</span>, Add)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"The sum of %d and %d is: %d\n"</span>, a, b, a+b)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">callback</span><span class="params">(y <span class="keyword">int</span>, f <span class="keyword">func</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)</span>)</span> &#123;</div><div class="line">	f(y, <span class="number">2</span>) <span class="comment">// this becomes Add(1, 2)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexFunc</span><span class="params">(s <span class="keyword">string</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>, <span class="title">truth</span> <span class="title">bool</span>) <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, r := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> f(r) == truth &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-8-闭包"><a href="#6-8-闭包" class="headerlink" title="6.8 闭包"></a>6.8 闭包</h3><ul>
<li>不给函数起名，而是将函数指针赋值给某个变量，通过这个变量来实现函数的调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		sum := <span class="number">0</span></div><div class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">1e6</span>; i++ &#123;</div><div class="line">			sum += i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">print</span>(sum)</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	f()</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</div><div class="line">		g := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; fmt.Printf(<span class="string">"%d "</span>, i) &#125; <span class="comment">//此例子中只是为了演示匿名函数可分配不同的内存地址，在现实开发中，不应该把该部分信息放置到循环中。</span></div><div class="line">		g(i)</div><div class="line">		fmt.Printf(<span class="string">" - g is of type %T and has value %v\n"</span>, g, g)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>匿名函数可以被赋值给变量作为值来使用</li>
<li>defer关键字和匿名函数配合使用来改变函数的命名返回值</li>
<li>匿名函数被称为闭包，被允许调用定义在其他环境的变量。</li>
<li>一个函数闭包继承了函数所声明时的作用域</li>
</ul>
<h2 id="闭包应用-将函数作为返回值"><a href="#闭包应用-将函数作为返回值" class="headerlink" title="闭包应用-将函数作为返回值"></a>闭包应用-将函数作为返回值</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// make an Add2 function, give it a name p2, and call it:</span></div><div class="line">	p2 := Add2()</div><div class="line">	fmt.Printf(<span class="string">"Call Add2 for 3 gives: %v\n"</span>, p2(<span class="number">3</span>))</div><div class="line">	<span class="comment">// make a special Adder function, a gets value 2:</span></div><div class="line">	TwoAdder := Adder(<span class="number">2</span>)</div><div class="line">	fmt.Printf(<span class="string">"The result is: %v\n"</span>, TwoAdder(<span class="number">3</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add2</span><span class="params">()</span> <span class="title">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> b + <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Adder</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> a + b</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> f = Adder()</div><div class="line">	fmt.Print(f(<span class="number">1</span>), <span class="string">" - "</span>)</div><div class="line">	fmt.Print(f(<span class="number">20</span>), <span class="string">" - "</span>)</div><div class="line">	fmt.Print(f(<span class="number">300</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Adder</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> x <span class="keyword">int</span></div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(delta <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		x += delta</div><div class="line">		<span class="keyword">return</span> x</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x中的值是可以被保存的</li>
<li>在闭包中使用到的变量可以在函数体内声明，也可以在函数体外声明</li>
</ul>
<h2 id="使用闭包调试"><a href="#使用闭包调试" class="headerlink" title="使用闭包调试"></a>使用闭包调试</h2><ul>
<li>runtime中的函数Caller提供了文件和行数的信息，可以用闭包来实现调试定位</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">where := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">	_, file, line, _ := runtime.Caller(<span class="number">1</span>)</div><div class="line">	log.Printf(<span class="string">"%s:%d"</span>, file, line)</div><div class="line">&#125;</div><div class="line">where()</div><div class="line"><span class="comment">// some code</span></div><div class="line">where()</div><div class="line"><span class="comment">// some more code</span></div><div class="line">where()</div></pre></td></tr></table></figure>
<h2 id="计算函数执行时间"><a href="#计算函数执行时间" class="headerlink" title="计算函数执行时间"></a>计算函数执行时间</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">start := time.Now()</div><div class="line">longCalculation()</div><div class="line">end := time.Now()</div><div class="line">delta := end.Sub(start)</div><div class="line">fmt.Printf(<span class="string">"longCalculation took this amount of time: %s\n"</span>, delta)</div></pre></td></tr></table></figure>
<h2 id="通过内存缓存来提升性能"><a href="#通过内存缓存来提升性能" class="headerlink" title="通过内存缓存来提升性能"></a>通过内存缓存来提升性能</h2><ul>
<li>内存缓存来避免重复计算，如斐波那契，空间换时间</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> LIM = <span class="number">41</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> fibs [LIM]<span class="keyword">uint64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> result <span class="keyword">uint64</span> = <span class="number">0</span></div><div class="line">	start := time.Now()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; LIM; i++ &#123;</div><div class="line">		result = fibonacci(i)</div><div class="line">		fmt.Printf(<span class="string">"fibonacci(%d) is: %d\n"</span>, i, result)</div><div class="line">	&#125;</div><div class="line">	end := time.Now()</div><div class="line">	delta := end.Sub(start)</div><div class="line">	fmt.Printf(<span class="string">"longCalculation took this amount of time: %s\n"</span>, delta)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(res <span class="keyword">uint64</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// memoization: check if fibonacci(n) is already known in array:</span></div><div class="line">	<span class="keyword">if</span> fibs[n] != <span class="number">0</span> &#123;</div><div class="line">		res = fibs[n]</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">1</span> &#123;</div><div class="line">		res = <span class="number">1</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		res = fibonacci(n<span class="number">-1</span>) + fibonacci(n<span class="number">-2</span>)</div><div class="line">	&#125;</div><div class="line">	fibs[n] = res</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第七章-数组和切片"><a href="#第七章-数组和切片" class="headerlink" title="第七章 数组和切片"></a>第七章 数组和切片</h1><h2 id="声明和初始化"><a href="#声明和初始化" class="headerlink" title="声明和初始化"></a>声明和初始化</h2><ul>
<li>数组长度是数组类型的一种</li>
<li>数组长度最大为2Gb</li>
<li>数组声明 <code>var identifier [len]type</code></li>
<li>数组声明之后所有元素会默认为零值</li>
<li>数组遍历用for循环，range更好</li>
<li>数组可以用new来创建，创建之后返回的是数组的地址，而不是数组的值</li>
</ul>
<h2 id="数组常量"><a href="#数组常量" class="headerlink" title="数组常量"></a>数组常量</h2><ul>
<li><code>var arr = [5]{18, 10, 12, 19, 23}</code></li>
<li><code>var arr = [...]{18, 10, 12, 19, 23}</code></li>
<li><code>var arr = [5]string{3: &quot;aa&quot;, 4: &quot;bb&quot;}</code>  - {“”. “”, “”, aa, bb}</li>
</ul>
<h2 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">const</span> (</div><div class="line">	WIDTH  = <span class="number">1920</span></div><div class="line">	HEIGHT = <span class="number">1080</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> pixel <span class="keyword">int</span></div><div class="line"><span class="keyword">var</span> screen [WIDTH][HEIGHT]pixel</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> y := <span class="number">0</span>; y &lt; HEIGHT; y++ &#123;</div><div class="line">		<span class="keyword">for</span> x := <span class="number">0</span>; x &lt; WIDTH; x++ &#123;</div><div class="line">			screen[x][y] = <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="将数组传递给函数"><a href="#将数组传递给函数" class="headerlink" title="将数组传递给函数"></a>将数组传递给函数</h2><ul>
<li>为了降低内存的消耗，传递数组指针或者切片</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	array := [<span class="number">3</span>]<span class="keyword">float64</span>&#123;<span class="number">7.0</span>, <span class="number">8.5</span>, <span class="number">9.1</span>&#125;</div><div class="line">	x := Sum(&amp;array) <span class="comment">// Note the explicit address-of operator</span></div><div class="line">	<span class="comment">// to pass a pointer to the array</span></div><div class="line">	fmt.Printf(<span class="string">"The sum of the array is: %f"</span>, x)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sum</span><span class="params">(a *[3]<span class="keyword">float64</span>)</span> <span class="params">(sum <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123; <span class="comment">// derefencing *a to get back to the array is not necessary!</span></div><div class="line">		sum += v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-2-切片"><a href="#7-2-切片" class="headerlink" title="7.2 切片"></a>7.2 切片</h2><ul>
<li>切片是对数组一个连续片段的引用</li>
<li>切片可以索引，可以len</li>
<li>切片是一个长度可变的数组</li>
<li>cap函数来计算切片的最大容量 0 &lt;= len(s) &lt;= cap(s)</li>
<li>切片是引用，不耗内存，效率更高</li>
<li>声明格式 <code>var identifier []type</code></li>
<li>切片在未初始化之前是nil，长度为0</li>
<li>切片的初始化格式是：<code>var slice1 []type = arr1[start:end]</code> 前闭后开</li>
<li>切片可以扩展到其上限</li>
<li>切片初始化：<code>var x = []int{2, 3, 4, 7, 11}</code></li>
<li>切片只能向后移</li>
<li>不要用指针指向切片，因为切片本身就是一个指针</li>
</ul>
<h3 id="将切片传递给函数"><a href="#将切片传递给函数" class="headerlink" title="将切片传递给函数"></a>将切片传递给函数</h3><ul>
<li>与传递数组相比，节省内存开销，同时函数具备了改变外部变量的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	s := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a); i++ &#123;</div><div class="line">		s += a[i]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> arr = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	sum(arr[:])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="make创建切片"><a href="#make创建切片" class="headerlink" title="make创建切片"></a>make创建切片</h3><ul>
<li><code>var slice []type = make(type[], len)</code>，在创建切片的同时创建好相关数组</li>
<li>make需要两个参数，元素类型和元素个数</li>
</ul>
<h3 id="make和new的区别"><a href="#make和new的区别" class="headerlink" title="make和new的区别"></a>make和new的区别</h3><ul>
<li>new为每个新的类型T分配一片内存，初始化零值并返回类型为*T的内存地址，适用于数组和结构体</li>
<li>make返回一个类型为T的初始值，适合创建slice，map和channel</li>
<li>new分配内存，make函数初始化</li>
</ul>
<h3 id="bytes包"><a href="#bytes包" class="headerlink" title="bytes包"></a>bytes包</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> buffer bytes.Buffer</div><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">	<span class="keyword">if</span> s, ok := getNextString(); ok &#123; <span class="comment">//method getNextString() not shown here</span></div><div class="line">		buffer.WriteString(s)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">break</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">fmt.Print(buffer.String(), <span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>字符串串联效率更高</li>
</ul>
<h2 id="7-3-for-range结构"><a href="#7-3-for-range结构" class="headerlink" title="7.3 for-range结构"></a>7.3 for-range结构</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> idx, value := <span class="keyword">range</span> slice &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>idx是数组或者切片的索引</li>
<li>value是索引对应的值</li>
<li><p>_忽略不需要的idx或者value</p>
</li>
<li><p>多维切片下的for-range</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> row := <span class="keyword">range</span> screen &#123;</div><div class="line">	<span class="keyword">for</span> column := <span class="keyword">range</span> screen[row] &#123;</div><div class="line">		screen[row][column] = <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-4-切片重组"><a href="#7-4-切片重组" class="headerlink" title="7.4 切片重组"></a>7.4 切片重组</h2><p><code>slice1 := make([]type, start_length, capacity)</code></p>
<ul>
<li>切片可以反复扩展直到占据整个数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	slice1 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</div><div class="line">	<span class="comment">// load the slice, cap(slice1) is 10:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(slice1); i++ &#123;</div><div class="line">		slice1 = slice1[<span class="number">0</span>:i+<span class="number">1</span>]</div><div class="line">		slice1[i] = i</div><div class="line">		fmt.Printf(<span class="string">"The length of slice is %d\n"</span>, <span class="built_in">len</span>(slice1))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// print the slice:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(slice1); i++ &#123;</div><div class="line">		fmt.Printf(<span class="string">"Slice at %d is %d\n"</span>, i, slice1[i])</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-5-切片的复制与追加"><a href="#7-5-切片的复制与追加" class="headerlink" title="7.5 切片的复制与追加"></a>7.5 切片的复制与追加</h2><ul>
<li>先创建再拷贝</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	sl_from := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">	sl_to := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</div><div class="line"></div><div class="line">	n := <span class="built_in">copy</span>(sl_to, sl_from)</div><div class="line">	fmt.Println(sl_to)</div><div class="line">	fmt.Printf(<span class="string">"Copied %d elements\n"</span>, n) <span class="comment">// n == 3</span></div><div class="line"></div><div class="line">	sl3 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">	sl3 = <span class="built_in">append</span>(sl3, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</div><div class="line">	fmt.Println(sl3)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>append方法追加切片并返回新的切片</li>
</ul>
<h2 id="7-6-字符串、数组和切片的应用"><a href="#7-6-字符串、数组和切片的应用" class="headerlink" title="7.6 字符串、数组和切片的应用"></a>7.6 字符串、数组和切片的应用</h2><ul>
<li><p>字符串生成切片 - <code>c := []byte(s)</code></p>
</li>
<li><p>获取字符串的某一部分 - substr := str[start:end]</p>
</li>
<li><p>字符串和切片的内存结构，字符串是一个双字结构，地址指针和长度值</p>
</li>
<li><p>go语言中字符串是不可变的，但是可以通过切片操作来改变字符串</p>
</li>
<li><p>append函数常见操作</p>
<ul>
<li>切片追加 - <code>a = append(a, b...)</code></li>
<li>切片复制 - <code>b = make([]Tm len(a))  copy(b, a)</code></li>
<li>删除索引i的元素 - <code>a = append(a[:i], a [i+1:])</code></li>
<li>切除切片 a 中从索引 i 至 j 位置的元素 - <code>a = append(a[:i], a[j:]...)</code></li>
<li>为切片 a 扩展 j 个元素长度 - <code>a = append(a, make([]T, j)...)</code></li>
<li>在索引 i 的位置插入元素 x - <code>a = append(a[:i], append([]T{x}, a[i:]...)...)</code></li>
<li>在索引 i 的位置插入长度为 j 的新切片 - <code>a = append(a[:i], append(make([]T, j), a[i:]...)...)</code></li>
<li>在索引 i 的位置插入切片 b 的所有元素 - <code>a = append(a[:i], append(b, a[i:]...)...)</code></li>
<li>取出位于切片 a 最末尾的元素 x - <code>x, a = a[len(a)-1], a[:len(a)-1]</code></li>
<li>将元素 x 追加到切片 a - <code>a = append(a, x)</code></li>
</ul>
</li>
<li><p>底层数组没有切片引用的时候会被回收</p>
</li>
</ul>
<h1 id="第八章-Map"><a href="#第八章-Map" class="headerlink" title="第八章 Map"></a>第八章 Map</h1><h2 id="8-1-声明和初始化"><a href="#8-1-声明和初始化" class="headerlink" title="8.1 声明和初始化"></a>8.1 声明和初始化</h2><h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><ul>
<li><code>var map1 map[keyType]valueType</code></li>
<li><code>var map1 map[string]int</code></li>
<li>map可以动态增长</li>
<li>未初始化的map是nil</li>
<li>key可以是string，int，float</li>
<li>value可以是任意类型的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> mapLit <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line">	<span class="comment">//var mapCreated map[string]float32</span></div><div class="line">	<span class="keyword">var</span> mapAssigned <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line"></div><div class="line">	mapLit = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"one"</span>: <span class="number">1</span>, <span class="string">"two"</span>: <span class="number">2</span>&#125;</div><div class="line">	mapCreated := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">float32</span>)</div><div class="line">	mapAssigned = mapLit</div><div class="line"></div><div class="line">	mapCreated[<span class="string">"key1"</span>] = <span class="number">4.5</span></div><div class="line">	mapCreated[<span class="string">"key2"</span>] = <span class="number">3.14159</span></div><div class="line">	mapAssigned[<span class="string">"two"</span>] = <span class="number">3</span></div><div class="line"></div><div class="line">	fmt.Printf(<span class="string">"Map literal at \"one\" is: %d\n"</span>, mapLit[<span class="string">"one"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map created at \"key2\" is: %f\n"</span>, mapCreated[<span class="string">"key2"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map assigned at \"two\" is: %d\n"</span>, mapLit[<span class="string">"two"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map literal at \"ten\" is: %d\n"</span>, mapLit[<span class="string">"ten"</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>map是引用类型，内存用make方法来分配，不要用new</li>
<li><p>map的初始化 - <code>map := make(map[string]float32)</code></p>
</li>
<li><p>map容量 - cap会自动+1扩张</p>
</li>
</ul>
<h2 id="测试键值对是否存在及删除元素"><a href="#测试键值对是否存在及删除元素" class="headerlink" title="测试键值对是否存在及删除元素"></a>测试键值对是否存在及删除元素</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> _, ok := <span class="keyword">map</span>[key1]; ok &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>delete(map1, key1)</code></p>
</li>
<li><p><code>for key, value := range map1 {}</code></p>
</li>
</ul>
<h2 id="map类型的切片"><a href="#map类型的切片" class="headerlink" title="map类型的切片"></a>map类型的切片</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Version A:</span></div><div class="line">	items := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">5</span>)</div><div class="line">	<span class="keyword">for</span> i:= <span class="keyword">range</span> items &#123;</div><div class="line">		items[i] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">1</span>)</div><div class="line">		items[i][<span class="number">1</span>] = <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Version A: Value of items: %v\n"</span>, items)</div><div class="line"></div><div class="line">	<span class="comment">// Version B: NOT GOOD!</span></div><div class="line">	items2 := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">5</span>)</div><div class="line">	<span class="keyword">for</span> _, item := <span class="keyword">range</span> items2 &#123;</div><div class="line">		item = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">1</span>) <span class="comment">// item is only a copy of the slice element.</span></div><div class="line">		item[<span class="number">1</span>] = <span class="number">2</span> <span class="comment">// This 'item' will be lost on the next iteration.</span></div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Version B: Value of items: %v\n"</span>, items2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="8-5-map排序"><a href="#8-5-map排序" class="headerlink" title="8.5 map排序"></a>8.5 map排序</h2><ul>
<li>将key或者value拷贝到切片</li>
<li>对切片排序</li>
<li>根据切片打印map</li>
</ul>
<h1 id="第九章-包-package"><a href="#第九章-包-package" class="headerlink" title="第九章 包 package"></a>第九章 包 package</h1><h2 id="9-1-标准库概述"><a href="#9-1-标准库概述" class="headerlink" title="9.1 标准库概述"></a>9.1 标准库概述</h2><ul>
<li>unsafe：C/C++中调用的类型不安全的包</li>
<li>syscall-os-os/exec：底层接口包</li>
<li>archive/tar,zip-compress：文件压缩解压缩</li>
<li>fmt：格式化输入输出</li>
<li>io：基本输入输出</li>
<li>bufio：缓冲输入输出</li>
<li>path/filepath：操作在当前系统中的目标文件名路径</li>
<li>flag：对命令行参数的操作</li>
<li>strings：字符串操作</li>
<li>strconv：字符串类型转换</li>
<li>unicode：Unicode类型字符串功能</li>
<li>regexp：正则</li>
<li>bytes：字符型分片操作</li>
<li>index/suffixarray：子字符串快速查询</li>
<li>math：基本数学函数</li>
<li>math/cmath：对复数的操作</li>
<li>math/rand：随机数</li>
<li>sort：排序</li>
<li>math/big：大数</li>
<li>container-list-ring-heap：集合操作</li>
<li>list：双链表</li>
<li>ring：环形链表</li>
<li>time：日期和时间的基本操作</li>
<li>log：记录程序运行时产生的日志</li>
<li>encoding/json：读取并解码和写入并编码json数据</li>
<li>encoding/xml：xml解析器</li>
<li>text/template：数据驱动模板</li>
<li>net：网络的基本操作</li>
<li>http：可扩展的http服务器和基础客户端</li>
<li>html：html5解析器</li>
<li>runtime：go程序运行时的交互操作</li>
<li>reflect：反射</li>
</ul>
<h2 id="9-2-regexp包"><a href="#9-2-regexp包" class="headerlink" title="9.2 regexp包"></a>9.2 regexp包</h2><ul>
<li>简单模式使用Match方法</li>
</ul>
<p><code>ok, _ := regexp.Match(pattern, []byte(searchIn))</code><br><code>ok, _ := regexp.MatchString(pattern, searchIn)</code></p>
<ul>
<li>通过Compile方法返回Regrep对象进行匹配</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//目标字符串</span></div><div class="line">searchIn := <span class="string">"John: 2578.34 William: 4567.23 Steve: 5632.18"</span></div><div class="line">pat := <span class="string">"[0-9]+.[0-9]+"</span> <span class="comment">//正则</span></div><div class="line"></div><div class="line">f := <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span>&#123;</div><div class="line">   	v, _ := strconv.ParseFloat(s, <span class="number">32</span>)</div><div class="line">   	<span class="keyword">return</span> strconv.FormatFloat(v * <span class="number">2</span>, <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">32</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ok, _ := regexp.Match(pat, []<span class="keyword">byte</span>(searchIn)); ok &#123;</div><div class="line">   fmt.Println(<span class="string">"Match Found!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">re, _ := regexp.Compile(pat)</div><div class="line"><span class="comment">//将匹配到的部分替换为"##.#"</span></div><div class="line">str := re.ReplaceAllString(searchIn, <span class="string">"##.#"</span>)</div><div class="line">fmt.Println(str)</div><div class="line"><span class="comment">//参数为函数时</span></div><div class="line">str2 := re.ReplaceAllStringFunc(searchIn, f)</div><div class="line">fmt.Println(str2)</div></pre></td></tr></table></figure>
<h2 id="9-3-锁和sync包"><a href="#9-3-锁和sync包" class="headerlink" title="9.3 锁和sync包"></a>9.3 锁和sync包</h2><ul>
<li>sync.Mutex是一个互斥锁，保证临界区同一个时间只有一个线程进入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span>  <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</div><div class="line">	mu sync.Mutex</div><div class="line">	<span class="comment">// ... other fields, e.g.: Str string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Update</span><span class="params">(info *Info)</span></span> &#123;</div><div class="line">	info.mu.Lock()</div><div class="line">    <span class="comment">// critical section:</span></div><div class="line">    info.Str = <span class="comment">// new value</span></div><div class="line">    <span class="comment">// end critical section</span></div><div class="line">    info.mu.Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>RWMutex锁：可以通过RLock方法来允许同一时间多个线程读取变量，一个线程写变量</li>
</ul>
<h2 id="精密计算和big包"><a href="#精密计算和big包" class="headerlink" title="精密计算和big包"></a>精密计算和big包</h2><ul>
<li>整数的高精度计算提供了big包</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here are some calculations with bigInts:</span></div><div class="line">im := big.NewInt(math.MaxInt64)</div><div class="line">in := im</div><div class="line">io := big.NewInt(<span class="number">1956</span>)</div><div class="line">ip := big.NewInt(<span class="number">1</span>)</div><div class="line">ip.Mul(im, in).Add(ip, im).Div(ip, io)</div><div class="line">fmt.Printf(<span class="string">"Big Int: %v\n"</span>, ip)</div><div class="line"><span class="comment">// Here are some calculations with bigInts:</span></div><div class="line">rm := big.NewRat(math.MaxInt64, <span class="number">1956</span>)</div><div class="line">rn := big.NewRat(<span class="number">-1956</span>, math.MaxInt64)</div><div class="line">ro := big.NewRat(<span class="number">19</span>, <span class="number">56</span>)</div><div class="line">rp := big.NewRat(<span class="number">1111</span>, <span class="number">2222</span>)</div><div class="line">rq := big.NewRat(<span class="number">1</span>, <span class="number">1</span>)</div><div class="line">rq.Mul(rm, rn).Add(rq, ro).Mul(rq, rp)</div><div class="line">fmt.Printf(<span class="string">"Big Rat: %v\n"</span>, rq)</div></pre></td></tr></table></figure>
<h2 id="自定义包和可见性"><a href="#自定义包和可见性" class="headerlink" title="自定义包和可见性"></a>自定义包和可见性</h2><ul>
<li>import导入包，路径名或者URL地址</li>
<li>导入外部安装包：<code>go install codesite/..</code>,安装在GOROOT/src/目录下</li>
<li>程序的初始化在于导入包，初始化main包然后调用main函数</li>
<li>init函数不能被调用</li>
</ul>
<h2 id="godoc"><a href="#godoc" class="headerlink" title="godoc"></a>godoc</h2><ul>
<li>命令行执行 <code>godoc -http=:6060 -goroot=&quot;.&quot;</code>其中<code>.</code>是当前路径，会在127.0.0.1：6060中看到本地go的注释</li>
</ul>
<h2 id="go-install"><a href="#go-install" class="headerlink" title="go install"></a>go install</h2><ul>
<li>go install是go中自动包安装工具</li>
<li><code>go installl uc</code>会将uc.a包安装到pkg目录下</li>
<li>也可以用gomake来安装</li>
<li>go test测试</li>
</ul>
<h2 id="git打包和安装"><a href="#git打包和安装" class="headerlink" title="git打包和安装"></a>git打包和安装</h2><ul>
<li>安装到GitHub</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git init</div><div class="line">git add .</div><div class="line">git commit -m &quot;&quot;</div><div class="line">git remote add origin git@github.com:NNN/uc.git</div><div class="line">git push -u origin master</div></pre></td></tr></table></figure>
<ul>
<li>从GitHub安装 - <code>go get github.com/xxx/xx</code></li>
</ul>
<h2 id="外部库的使用"><a href="#外部库的使用" class="headerlink" title="外部库的使用"></a>外部库的使用</h2><ol>
<li>下载并安装外部库-go install</li>
<li>GOPATH是否有，包会被下载到<code>$GOPATH/PKG/&quot;machine_arch&quot;/</code></li>
</ol>
<h1 id="第十章-结构和方法"><a href="#第十章-结构和方法" class="headerlink" title="第十章 结构和方法"></a>第十章 结构和方法</h1><ul>
<li>go通过类型别名和结构体的形式支持用户自定义类型</li>
<li>结构体是复合类型，new来创建</li>
<li>数据称为字段fields</li>
</ul>
<h2 id="10-1-结构体定义"><a href="#10-1-结构体定义" class="headerlink" title="10.1 结构体定义"></a>10.1 结构体定义</h2><ul>
<li>结构体的定义方法：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> identifier <span class="keyword">struct</span> &#123;</div><div class="line">    field1 type1</div><div class="line">    field2 type2</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span>&#123;a, b <span class="keyword">int</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li>数组可以看做使用下标的结构体</li>
<li>new函数给结构体分配内存，返回已分配内存的指针</li>
<li>var t T，此时t是T的一个实例/对象</li>
<li>结构体打印和%v效果一样</li>
<li>结构体变量和指针都可以通过<code>.</code>来选择字段值</li>
<li><code>p := Point{}</code>是实例，<code>p := &amp;Point{}是指针</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">    firstName   <span class="keyword">string</span></div><div class="line">    lastName    <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">upPerson</span><span class="params">(p *Person)</span></span> &#123;</div><div class="line">    p.firstName = strings.ToUpper(p.firstName)</div><div class="line">    p.lastName = strings.ToUpper(p.lastName)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 1-struct as a value type:</span></div><div class="line">    <span class="keyword">var</span> pers1 Person</div><div class="line">    pers1.firstName = <span class="string">"Chris"</span></div><div class="line">    pers1.lastName = <span class="string">"Woodward"</span></div><div class="line">    upPerson(&amp;pers1)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers1.firstName, pers1.lastName)</div><div class="line"></div><div class="line">    <span class="comment">// 2—struct as a pointer:</span></div><div class="line">    pers2 := <span class="built_in">new</span>(Person)</div><div class="line">    pers2.firstName = <span class="string">"Chris"</span></div><div class="line">    pers2.lastName = <span class="string">"Woodward"</span></div><div class="line">    (*pers2).lastName = <span class="string">"Woodward"</span>  <span class="comment">// 这是合法的</span></div><div class="line">    upPerson(pers2)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers2.firstName, pers2.lastName)</div><div class="line"></div><div class="line">    <span class="comment">// 3—struct as a literal:</span></div><div class="line">    pers3 := &amp;Person&#123;<span class="string">"Chris"</span>,<span class="string">"Woodward"</span>&#125;</div><div class="line">    upPerson(pers3)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers3.firstName, pers3.lastName)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>go的内存布局，结构体和其字段在内存中是连续存在的，性能更好，空间换时间</p>
</li>
<li><p>递归结构体，链表，树的实现</p>
</li>
<li><p>结构体可以和他别名进行类型转换</p>
</li>
</ul>
<h2 id="10-2-使用工厂方法创建结构体实例"><a href="#10-2-使用工厂方法创建结构体实例" class="headerlink" title="10.2 使用工厂方法创建结构体实例"></a>10.2 使用工厂方法创建结构体实例</h2><ul>
<li>工厂方法以new或者New开头</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> &#123;</div><div class="line">	fd <span class="keyword">int</span></div><div class="line">	name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFile</span><span class="params">(fd <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> *<span class="title">File</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> fd &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;File&#123;fd, name&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>推荐使用工厂方法来创建结构体，结构体字段就可以定义为私有的，OO思想</li>
</ul>
<h2 id="10-3-使用自定义包中的结构体"><a href="#10-3-使用自定义包中的结构体" class="headerlink" title="10.3 使用自定义包中的结构体"></a>10.3 使用自定义包中的结构体</h2><p>直接import就OK了</p>
<h2 id="10-4-带标签的结构体"><a href="#10-4-带标签的结构体" class="headerlink" title="10.4 带标签的结构体"></a>10.4 带标签的结构体</h2><ul>
<li>结构体中的字段出了名字和类型之外，还有一个可选的标签</li>
<li>标签是附属于字段的字符串，文档注释等操作</li>
<li>reflect可以取到tag</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> TagType <span class="keyword">struct</span> &#123; <span class="comment">// tags</span></div><div class="line">	field1 <span class="keyword">bool</span>   <span class="string">"An important answer"</span></div><div class="line">	field2 <span class="keyword">string</span> <span class="string">"The name of the thing"</span></div><div class="line">	field3 <span class="keyword">int</span>    <span class="string">"How much there are"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="10-5-匿名字段和内嵌结构体"><a href="#10-5-匿名字段和内嵌结构体" class="headerlink" title="10.5 匿名字段和内嵌结构体"></a>10.5 匿名字段和内嵌结构体</h2><ul>
<li>字段没有名字，只有类型</li>
<li>匿名字段可以是结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> innerS <span class="keyword">struct</span> &#123;</div><div class="line">	in1 <span class="keyword">int</span></div><div class="line">	in2 <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> outerS <span class="keyword">struct</span> &#123;</div><div class="line">	b    <span class="keyword">int</span></div><div class="line">	c    <span class="keyword">float32</span></div><div class="line">	<span class="keyword">int</span>  <span class="comment">// anonymous field</span></div><div class="line">	innerS <span class="comment">//anonymous field</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>实际上一个结构体对每一个类型最多有一个匿名字段，通过struct.type获取</p>
</li>
<li><p>内嵌结构体的概念类似于继承</p>
</li>
<li><p>内外的结构体命名冲突，外层的名字会覆盖内层的名字，同级别冲突报错</p>
</li>
</ul>
<h2 id="10-6-方法"><a href="#10-6-方法" class="headerlink" title="10.6 方法"></a>10.6 方法</h2><ul>
<li><p>go方法是作用在接收者上的一个函数，接收者是某个类型的变量</p>
</li>
<li><p>接收者可以是任何对象除了interface</p>
</li>
<li><p>go中类型的代码和绑定在它上面的方法的代码可以不放置在一起，只要是同一个包就可以</p>
</li>
<li><p>方法集</p>
</li>
<li><p>方法不允许重载</p>
</li>
<li><p>定义格式 <code>func (_ receiver_type) methodName(parameter_list) (return_value_list) { ... }</code></p>
</li>
<li><p>接收者可以理解为Java中的this</p>
</li>
</ul>
<h3 id="函数和方法的区别"><a href="#函数和方法的区别" class="headerlink" title="函数和方法的区别"></a>函数和方法的区别</h3><ul>
<li>函数将变量作为参数，方法在变量上被调用</li>
<li>接收者需要显示命名</li>
<li>receiver_type必须和方法同包</li>
<li>类型和方法之间的关联由接收者来建立</li>
<li>方法没有和结构体混合，表明数据和方法是独立的</li>
</ul>
<h3 id="指针或值作为接收者"><a href="#指针或值作为接收者" class="headerlink" title="指针或值作为接收者"></a>指针或值作为接收者</h3><ul>
<li><p>一般来说接收者都是类型的指针，效率更高</p>
</li>
<li><p>指针方法和值方法都可以在指针或非指针上被调用</p>
</li>
<li><p>未导出的结构体的对象通过setter\getter来修改和获取</p>
</li>
</ul>
<h3 id="内嵌类型的方法和继承"><a href="#内嵌类型的方法和继承" class="headerlink" title="内嵌类型的方法和继承"></a>内嵌类型的方法和继承</h3><ul>
<li>匿名类型被内嵌时，其可见方法也同样被内嵌，等价于外部结构继承了这些方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Engine <span class="keyword">interface</span> &#123;</div><div class="line">    Start()</div><div class="line">    Stop</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Car <span class="keyword">interface</span> <span class="keyword">struct</span> &#123;</div><div class="line">    Engine</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Car)</span> <span class="title">GoToWorkIn</span><span class="params">()</span></span> &#123;</div><div class="line">    c.Start()</div><div class="line">    c.Stop()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>方法可以被外层结构体覆盖</li>
</ul>
<h3 id="如何在类型中嵌入功能"><a href="#如何在类型中嵌入功能" class="headerlink" title="如何在类型中嵌入功能"></a>如何在类型中嵌入功能</h3><ul>
<li><p>两种方法</p>
<ul>
<li>聚合：包含一个所需要功能的具体字段</li>
<li>内嵌：内嵌需要的功能类型</li>
</ul>
</li>
<li><p>聚合</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</div><div class="line">    msg <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</div><div class="line">    Name <span class="keyword">string</span></div><div class="line">    log *Log</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">Add</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    l.msg += <span class="string">"\n"</span> + s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> l.msg</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Customer)</span> <span class="title">Log</span><span class="params">()</span> *<span class="title">Log</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> c.log</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>内嵌</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</div><div class="line">	msg <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</div><div class="line">	Name <span class="keyword">string</span></div><div class="line">	Log</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	c := &amp;Customer&#123;<span class="string">"Barak Obama"</span>, Log&#123;<span class="string">"1 - Yes we can!"</span>&#125;&#125;</div><div class="line">	c.Add(<span class="string">"2 - After me the world will be a better place!"</span>)</div><div class="line">	fmt.Println(c)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">Add</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	l.msg += <span class="string">"\n"</span> + s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.msg</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Customer)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Name + <span class="string">"\nLog:"</span> + fmt.Sprintln(c.Log)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>内嵌的类型不需要指针</li>
</ul>
<h3 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h3><ul>
<li>多重继承指的是一个类型获得多个父类型的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Camera <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Camera)</span> <span class="title">TakeAPicture</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"click"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Phone <span class="keyword">struct</span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Phone)</span> <span class="title">Call</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"ring"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> CameraPhone <span class="keyword">struct</span> &#123;</div><div class="line">    Camera</div><div class="line">    Phone</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    cp := <span class="built_in">new</span>(CameraPhone)</div><div class="line">    fmt.Println(cp.TakeAPicture(), cp.Call())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其他语言和GO的类型和方法的比较"><a href="#其他语言和GO的类型和方法的比较" class="headerlink" title="其他语言和GO的类型和方法的比较"></a>其他语言和GO的类型和方法的比较</h3><ul>
<li>go中，类型就是类，代码复用和多态更好</li>
<li>go中，代码通过组合和委托实现，多态通过接口的使用来实现</li>
</ul>
<h2 id="10-7-类型的String方法和格式化描述符"><a href="#10-7-类型的String方法和格式化描述符" class="headerlink" title="10.7 类型的String方法和格式化描述符"></a>10.7 类型的String方法和格式化描述符</h2><ul>
<li>定义了string()方法的类型，会被fmt.Println()中生成默认的输出，等同于%v产生的输出</li>
<li>注意不要在String方法里面调用涉及String()方法的方法，放置造成无限递归</li>
</ul>
<h2 id="10-8-垃圾回收和SetFinalizer"><a href="#10-8-垃圾回收和SetFinalizer" class="headerlink" title="10.8 垃圾回收和SetFinalizer"></a>10.8 垃圾回收和SetFinalizer</h2><ul>
<li>go语言有自己的垃圾回收器</li>
<li>通过runtime包访问GC进程，<code>runtime.GC()</code></li>
<li>SetFinalizer可以在对象被移除前进行一些操作<code>runtime.SetFinalizer(obj, func(obj *typeObj))</code></li>
</ul>
<h1 id="第11章-接口与反射"><a href="#第11章-接口与反射" class="headerlink" title="第11章 接口与反射"></a>第11章 接口与反射</h1><ul>
<li>接口定义了一组方法</li>
<li>go中的接口都很简短，0-3个方法</li>
<li>go语言中接口可以有值，为多字数据结构，值为nil</li>
<li>类型来实现接口找那个的方法</li>
<li>类型不需要显示声明它实现了哪个接口：接口被隐式的实现，多个类型可以实现同一个接口</li>
<li>实现某个接口的类型可以有其他的方法</li>
<li>一个类型可以实现多个接口</li>
<li>接口类型可以包含一个实例的引用，该实例的类型实现了此接口，接口是动态类型</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Shaper <span class="keyword">interface</span> &#123;</div><div class="line">	Area() <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Square <span class="keyword">struct</span> &#123;</div><div class="line">	side <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sq *Square)</span> <span class="title">Area</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> sq.side * sq.side</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</div><div class="line">   length, width <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span> <span class="title">Area</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">   <span class="keyword">return</span> r.length * r.width</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">   r := Rectangle&#123;<span class="number">5</span>, <span class="number">3</span>&#125; <span class="comment">// Area() of Rectangle needs a value</span></div><div class="line">   q := &amp;Square&#123;<span class="number">5</span>&#125;      <span class="comment">// Area() of Square needs a pointer</span></div><div class="line">   shapes := []Shaper&#123;r, q&#125;</div><div class="line">   fmt.Println(<span class="string">"Looping through shapes for area ..."</span>)</div><div class="line">   <span class="keyword">for</span> n, _ := <span class="keyword">range</span> shapes &#123;</div><div class="line">       fmt.Println(<span class="string">"Shape details: "</span>, shapes[n])</div><div class="line">       fmt.Println(<span class="string">"Area of this shape is: "</span>, shapes[n].Area())</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接口的多态实例，父类引用持有子类变量。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> stockPosition <span class="keyword">struct</span> &#123;</div><div class="line">    ticker <span class="keyword">string</span></div><div class="line">    sharePrice <span class="keyword">float32</span></div><div class="line">    count <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s stockPosition)</span> <span class="title">getValue</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> s.sharePrice * s.count</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> car <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="built_in">make</span> <span class="keyword">string</span></div><div class="line">    model <span class="keyword">string</span></div><div class="line">    price <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Car)</span> <span class="title">getValue</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> c.price</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> valuable <span class="keyword">interface</span> &#123;</div><div class="line">    getValue() <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">showValue</span><span class="params">(asset valuable)</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"Value of the asset is %f\n"</span>, assert.getValue())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> o valuable = stockPosition&#123;<span class="string">"GOODS"</span>, <span class="number">577.012</span>, <span class="number">4</span>&#125;</div><div class="line">    showValue(o)</div><div class="line">    o = car&#123;<span class="string">"BMW"</span>, <span class="string">"M5"</span>, <span class="number">56565465</span>&#125;</div><div class="line">    showValue(o)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>标准库中的例子-Reader</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-2接口嵌套接口"><a href="#11-2接口嵌套接口" class="headerlink" title="11.2接口嵌套接口"></a>11.2接口嵌套接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReadWrite <span class="keyword">interface</span> &#123;</div><div class="line">    Read(b Buffer) <span class="keyword">bool</span></div><div class="line">    Write(b Buffer) <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Lock <span class="keyword">interface</span> &#123;</div><div class="line">    Lock()</div><div class="line">    Unlock()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> File <span class="keyword">interface</span> &#123;</div><div class="line">    ReadWrite</div><div class="line">    Lokck</div><div class="line">    Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-3-类型断言：如何检测和转换接口变量的类型"><a href="#11-3-类型断言：如何检测和转换接口变量的类型" class="headerlink" title="11.3 类型断言：如何检测和转换接口变量的类型"></a>11.3 类型断言：如何检测和转换接口变量的类型</h2><ul>
<li>一个接口类型的变量可以包含任何类型的值，类型断言来检测某个时刻该接口变量的值</li>
<li><code>v := varI.(T)</code> varI为接口变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> areaIntf Shaper</div><div class="line">sq1 := <span class="built_in">new</span>(Square)</div><div class="line">sq1.side = <span class="number">5</span></div><div class="line"></div><div class="line">areaIntf = sq1</div><div class="line"><span class="keyword">if</span> t, ok := areaIntf.(*Square); ok &#123;</div><div class="line">    fmt.Println()</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> u, ok := areaIntf.(*Circle); ok &#123;</div><div class="line">    fmt.....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-4-类型判断-type-switch"><a href="#11-4-类型判断-type-switch" class="headerlink" title="11.4 类型判断: type-switch"></a>11.4 类型判断: type-switch</h2><ul>
<li>不允许fallthrought关键字</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">classifier</span><span class="params">(items ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, x := <span class="keyword">range</span> items &#123;</div><div class="line">		<span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a bool\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">float64</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a float64\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a int\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a nil\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a string\n"</span>, i)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is unknown\n"</span>, i)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-5-测试一个值是否实现了某个接口"><a href="#11-5-测试一个值是否实现了某个接口" class="headerlink" title="11.5 测试一个值是否实现了某个接口"></a>11.5 测试一个值是否实现了某个接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</div><div class="line">    String() <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> sv, ok := v.(Stringer); ok &#123;</div><div class="line">    fmt.Printf(<span class="string">"v implements String(): %s\n"</span>, sv.String()) <span class="comment">// note: sv, not v</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接口是一种契约，实现类型必须满足它，描述了类型的行为，规定类型可以做什么。</li>
<li>使用接口使得代码更具有普适性</li>
</ul>
<h2 id="11-6-使用方法集与接口"><a href="#11-6-使用方法集与接口" class="headerlink" title="11.6 使用方法集与接口"></a>11.6 使用方法集与接口</h2><ul>
<li>作用于变量上的方法实际上是不区分变量是值还是指针的，但是如果变量是接口类型时，由于接口变量中村的具体指是不可以寻址的，会编译错误</li>
<li>在指针上调用方法时，必须有和方法定义时相同的接收者类型或者可以从具体类型P直接进行辨识的类型<ul>
<li>指针方法可以通过指针调用</li>
<li>值方法可以通过值调用</li>
<li>接收者是值的方法可以通过指针调用，因为指针会首先被解引用</li>
<li>接收者是指针的方法不可以通过值调用，因为存储在接口中的值没有地址</li>
</ul>
</li>
<li>将一个值赋值给接口时，编译器会进行类型检查</li>
</ul>
<p><em>小结</em></p>
<ol>
<li>类型<code>*T</code>的可调用方法集合包含接受者为*T或T的所有方法集</li>
<li>类型T的可调用方法集包含接受者为T的所有方法</li>
</ol>
<h2 id="11-7-Sorter接口排序"><a href="#11-7-Sorter接口排序" class="headerlink" title="11.7 Sorter接口排序"></a>11.7 Sorter接口排序</h2><ul>
<li>Sort函数接收一个Sorter接口类型的参数，Sorter接口定义了len，less,swap方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sort</div><div class="line"></div><div class="line"><span class="keyword">type</span> Sorter <span class="keyword">interface</span> &#123;</div><div class="line">    Len() <span class="keyword">int</span></div><div class="line">    Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">    Swap(i, j, <span class="keyword">int</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Sorter)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> pass := <span class="number">1</span>; pass &lt; data.Len(); pass++ &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; data.Len - pass; i++ &#123;</div><div class="line">            <span class="keyword">if</span> data.Less(i+<span class="number">1</span>, j) &#123;</div><div class="line">                data.Swap(i, i + <span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsSorted</span><span class="params">(data Sorter)</span> <span class="title">bool</span></span> &#123;</div><div class="line">    n := data.Len</div><div class="line">    <span class="keyword">for</span> i := n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</div><div class="line">        <span class="keyword">if</span> data.Less(i, i<span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> IntArray []<span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>&#123;<span class="keyword">return</span> <span class="built_in">len</span>(p)&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;<span class="keyword">return</span> p[i] &lt; p[j]&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;p[i], p[j] = p[j], p[i]&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> StringArray []<span class="keyword">string</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> p[i] &lt; p[j] &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; p[i], p[j] = p[j], p[i] &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortInts</span><span class="params">(a []<span class="keyword">int</span>)</span></span>       &#123; Sort(IntArray(a)) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortStrings</span><span class="params">(a []<span class="keyword">string</span>)</span></span> &#123; Sort(StringArray(a)) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IntsAreSorted</span><span class="params">(a []<span class="keyword">int</span>)</span> <span class="title">bool</span></span>       &#123; <span class="keyword">return</span> IsSorted(IntArray(a)) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringsAreSorted</span><span class="params">(a []<span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> IsSorted(StringArray(a))</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">     	<span class="string">"fmt"</span></div><div class="line">     	<span class="string">"./sort"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// sorting of slice of integers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ints</span><span class="params">()</span></span> &#123;</div><div class="line">    	data := []<span class="keyword">int</span>&#123;<span class="number">74</span>, <span class="number">59</span>, <span class="number">238</span>, <span class="number">-784</span>, <span class="number">9845</span>, <span class="number">959</span>, <span class="number">905</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">7586</span>, <span class="number">-5467984</span>, <span class="number">7586</span>&#125;</div><div class="line">    	a := sort.IntArray(data)  <span class="comment">//conversion to type IntArray</span></div><div class="line">    	sort.Sort(a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">    	&#125;</div><div class="line">	    fmt.Printf(<span class="string">"The sorted array is: %v\n"</span>, a)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// sorting of slice of strings</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">strings</span><span class="params">()</span></span> &#123;</div><div class="line">    	data := []<span class="keyword">string</span>&#123;<span class="string">"monday"</span>, <span class="string">"friday"</span>, <span class="string">"tuesday"</span>, <span class="string">"wednesday"</span>, <span class="string">"sunday"</span>,<span class="string">"thursday"</span>, <span class="string">""</span>, <span class="string">"saturday"</span>&#125;</div><div class="line">    	a := sort.StringArray(data)</div><div class="line">    	sort.Sort(a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">		&#125;</div><div class="line">	    fmt.Printf(<span class="string">"The sorted array is: %v\n"</span>, a)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// a type which describes a day of the week</span></div><div class="line"><span class="keyword">type</span> day <span class="keyword">struct</span> &#123;</div><div class="line">    	num        <span class="keyword">int</span></div><div class="line">    	shortName  <span class="keyword">string</span></div><div class="line">    	longName   <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> dayArray <span class="keyword">struct</span> &#123;</div><div class="line">    	data []*day</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>            &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p.data) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span>  &#123; <span class="keyword">return</span> p.data[i].num &lt; p.data[j].num &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>       &#123; p.data[i], p.data[j] = p.data[j], p.data[i] &#125;</div><div class="line"></div><div class="line"><span class="comment">// sorting of custom type day</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">days</span><span class="params">()</span></span> &#123;</div><div class="line">    	Sunday :=    day&#123;<span class="number">0</span>, <span class="string">"SUN"</span>, <span class="string">"Sunday"</span>&#125;</div><div class="line">    	Monday :=    day&#123;<span class="number">1</span>, <span class="string">"MON"</span>, <span class="string">"Monday"</span>&#125;</div><div class="line">    	Tuesday :=   day&#123;<span class="number">2</span>, <span class="string">"TUE"</span>, <span class="string">"Tuesday"</span>&#125;</div><div class="line">    	Wednesday := day&#123;<span class="number">3</span>, <span class="string">"WED"</span>, <span class="string">"Wednesday"</span>&#125;</div><div class="line">    	Thursday :=  day&#123;<span class="number">4</span>, <span class="string">"THU"</span>, <span class="string">"Thursday"</span>&#125;</div><div class="line">    	Friday :=    day&#123;<span class="number">5</span>, <span class="string">"FRI"</span>, <span class="string">"Friday"</span>&#125;</div><div class="line">    	Saturday :=  day&#123;<span class="number">6</span>, <span class="string">"SAT"</span>, <span class="string">"Saturday"</span>&#125;</div><div class="line">    	data := []*day&#123;&amp;Tuesday, &amp;Thursday, &amp;Wednesday, &amp;Sunday, &amp;Monday, &amp;Friday, &amp;Saturday&#125;</div><div class="line">    	a := dayArray&#123;data&#125;</div><div class="line">    	sort.Sort(&amp;a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(&amp;a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">    	&#125;</div><div class="line">    	<span class="keyword">for</span> _, d := <span class="keyword">range</span> data &#123;</div><div class="line">    			fmt.Printf(<span class="string">"%s "</span>, d.longName)</div><div class="line">    	&#125;</div><div class="line">    	fmt.Printf(<span class="string">"\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ints()</div><div class="line">    strings()</div><div class="line">    days()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-8-读和写"><a href="#11-8-读和写" class="headerlink" title="11.8 读和写"></a>11.8 读和写</h2><ul>
<li>io包中提供了用于读和写的接口<code>io.Reader</code>和<code>io.Writer</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">    Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>只要实现了读写接口，这个对象就是可读写的</li>
<li>bufio里面提供了带缓冲的读写</li>
</ul>
<h2 id="11-9-空接口"><a href="#11-9-空接口" class="headerlink" title="11.9 空接口"></a>11.9 空接口</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul>
<li>空接口不包含任何方法，对实现不做要求 <code>type Any interface{}</code></li>
<li>类似Java中的Object类</li>
<li>空接口可以被赋予任何值</li>
<li>每个interface变量占据两个字长，一个用来存储包含的类型，一个用来存储包含的数据或者数据指针</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">testFunc := <span class="function"><span class="keyword">func</span><span class="params">(any <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> v := any.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a bool type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">int</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is an int type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">float32</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a float32 type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a string type"</span>, v)</div><div class="line">	<span class="keyword">case</span> specialString:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a special String!"</span>, v)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		fmt.Println(<span class="string">"unknown type!"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-2-构建通过类型或者包含不通类型变量的数组"><a href="#11-9-2-构建通过类型或者包含不通类型变量的数组" class="headerlink" title="11.9.2 构建通过类型或者包含不通类型变量的数组"></a>11.9.2 构建通过类型或者包含不通类型变量的数组</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Element <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> Vector <span class="keyword">struct</span> &#123;</div><div class="line">    a []Element</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Vector里面可以存放任何类型的变量</li>
<li>Vector中存储的所有元素都是Element类型，得到袁术类型需要用类型断言</li>
</ul>
<h3 id="11-9-3-复制数据切片到空接口切片"><a href="#11-9-3-复制数据切片到空接口切片" class="headerlink" title="11.9.3 复制数据切片到空接口切片"></a>11.9.3 复制数据切片到空接口切片</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dataSlice []myType = FuncReturnSlice()</div><div class="line"><span class="keyword">var</span> interfaceSlice []<span class="keyword">interface</span>&#123;&#125; = <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(dataSlice))</div><div class="line"><span class="keyword">for</span> idx, val := <span class="keyword">range</span> dataSlice &#123;</div><div class="line">    interfaceSlice[i] = d</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-4-通用类型的节点数据结构"><a href="#11-9-4-通用类型的节点数据结构" class="headerlink" title="11.9.4 通用类型的节点数据结构"></a>11.9.4 通用类型的节点数据结构</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</div><div class="line">    left *Node</div><div class="line">    data <span class="keyword">interface</span>&#123;]</div><div class="line">    right *Node</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNode</span><span class="params">(left, right *Node)</span> *<span class="title">Node</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> &amp;Node&#123;left, <span class="literal">nil</span>, right&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">SetData</span><span class="params">(data <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    n.data = data</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-5-接口到接口"><a href="#11-9-5-接口到接口" class="headerlink" title="11.9.5 接口到接口"></a>11.9.5 接口到接口</h3><ul>
<li>一个接口的值可以赋值给另一个接口，只要底层实现了必要的方法</li>
<li>运行时才会检查两个接口是否可以进行赋值，不可以会报错</li>
</ul>
<h2 id="11-10-反射包"><a href="#11-10-反射包" class="headerlink" title="11.10 反射包"></a>11.10 反射包</h2><ul>
<li>反射是用程序检查其所拥有的结构，类型的一种能力</li>
<li>反射可以在运行时检查类型和变量，比如大小，方法并动态的调用这些方法</li>
<li>反射包中Type用来表示一个Go类型，Value为go提供了反射的接口</li>
<li><code>reflect.TypeOf reflect.ValueOf</code>检查对象的类型和值</li>
<li>反射可以从接口值反射到对象，也可以从对象反射回接口</li>
<li>反射包中的常量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	Invalid Kind = <span class="literal">iota</span></div><div class="line">	Bool</div><div class="line">	Int</div><div class="line">	Int8</div><div class="line">	Int16</div><div class="line">	Int32</div><div class="line">	Int64</div><div class="line">	Uint</div><div class="line">	Uint8</div><div class="line">	Uint16</div><div class="line">	Uint32</div><div class="line">	Uint64</div><div class="line">	Uintptr</div><div class="line">	Float32</div><div class="line">	Float64</div><div class="line">	Complex64</div><div class="line">	Complex128</div><div class="line">	Array</div><div class="line">	Chan</div><div class="line">	Func</div><div class="line">	Interface</div><div class="line">	Map</div><div class="line">	Ptr</div><div class="line">	Slice</div><div class="line">	String</div><div class="line">	Struct</div><div class="line">	UnsafePointer</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>Kind方法总是返回底层类型</li>
</ul>
<h3 id="11-10-2-通过反射修改值"><a href="#11-10-2-通过反射修改值" class="headerlink" title="11.10.2 通过反射修改值"></a>11.10.2 通过反射修改值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x <span class="keyword">float64</span> = <span class="number">3.4</span></div><div class="line">v := reflect.ValueOf(x)</div><div class="line">fmt.Println(<span class="string">"settablity of v:"</span>, v.Canset())</div><div class="line">v = reflect.ValueOf(&amp;x)</div><div class="line">v = v.Elem()</div><div class="line">v.SetFloat(<span class="number">3.1415</span>)</div></pre></td></tr></table></figure>
<ul>
<li>NumField()方法返回结构内的字段数量，通过for循环用索引取得每个字段的值Field<h3 id="11-10-3-反射结构"><a href="#11-10-3-反射结构" class="headerlink" title="11.10.3 反射结构"></a>11.10.3 反射结构</h3></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> NotknownType <span class="keyword">struct</span> &#123;</div><div class="line">	s1, s2, s3 <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n NotknownType)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> n.s1 + <span class="string">" - "</span> + n.s2 + <span class="string">" - "</span> + n.s3</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// variable to investigate:</span></div><div class="line"><span class="keyword">var</span> secret <span class="keyword">interface</span>&#123;&#125; = NotknownType&#123;<span class="string">"Ada"</span>, <span class="string">"Go"</span>, <span class="string">"Oberon"</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	value := reflect.ValueOf(secret) <span class="comment">// &lt;main.NotknownType Value&gt;</span></div><div class="line">	typ := reflect.TypeOf(secret)    <span class="comment">// main.NotknownType</span></div><div class="line">	<span class="comment">// alternative:</span></div><div class="line">	<span class="comment">//typ := value.Type()  // main.NotknownType</span></div><div class="line">	fmt.Println(typ)</div><div class="line">	knd := value.Kind() <span class="comment">// struct</span></div><div class="line">	fmt.Println(knd)</div><div class="line"></div><div class="line">	<span class="comment">// iterate through the fields of the struct:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; value.NumField(); i++ &#123;</div><div class="line">		fmt.Printf(<span class="string">"Field %d: %v\n"</span>, i, value.Field(i))</div><div class="line">		<span class="comment">// error: panic: reflect.Value.SetString using value obtained using unexported field</span></div><div class="line">		<span class="comment">//value.Field(i).SetString("C#")</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// call the first method, which is String():</span></div><div class="line">	results := value.Method(<span class="number">0</span>).Call(<span class="literal">nil</span>)</div><div class="line">	fmt.Println(results) <span class="comment">// [Ada - Go - Oberon]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>结构体中只有被导出字段(大写的字段)才是可以设置的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</div><div class="line">	A <span class="keyword">int</span></div><div class="line">	B <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	t := T&#123;<span class="number">23</span>, <span class="string">"skidoo"</span>&#125;</div><div class="line">	s := reflect.ValueOf(&amp;t).Elem()</div><div class="line">	typeOfT := s.Type()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; s.NumField(); i++ &#123;</div><div class="line">		f := s.Field(i)</div><div class="line">		fmt.Printf(<span class="string">"%d: %s %s = %v\n"</span>, i,</div><div class="line">			typeOfT.Field(i).Name, f.Type(), f.Interface())</div><div class="line">	&#125;</div><div class="line">	s.Field(<span class="number">0</span>).SetInt(<span class="number">77</span>)</div><div class="line">	s.Field(<span class="number">1</span>).SetString(<span class="string">"Sunset Strip"</span>)</div><div class="line">	fmt.Println(<span class="string">"t is now"</span>, t)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-11-Printf和反射"><a href="#11-11-Printf和反射" class="headerlink" title="11.11 Printf和反射"></a>11.11 Printf和反射</h2><ul>
<li>Printf函数声明为</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="keyword">string</span>, args ... <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span></div></pre></td></tr></table></figure>
<ul>
<li><code>...</code>为空接口类型，Printf可以知道每个参数的类型</li>
</ul>
<h2 id="11-12-接口和动态类型"><a href="#11-12-接口和动态类型" class="headerlink" title="11.12 接口和动态类型"></a>11.12 接口和动态类型</h2><h3 id="11-12-1-Go的动态类型"><a href="#11-12-1-Go的动态类型" class="headerlink" title="11.12.1 Go的动态类型"></a>11.12.1 Go的动态类型</h3><ul>
<li>go语言中数据和方法是松耦合的</li>
<li>go中的接口任何提供了接口方法实现代码的类型都隐式的实现了该接口</li>
<li>duck typing，能做什么比是什么更加重要</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> IDuck <span class="keyword">interface</span> &#123;</div><div class="line">    Quack()</div><div class="line">    Walk()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DuckDance</span><span class="params">(duck IDuck)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</div><div class="line">        duck.Quack()</div><div class="line">        duck.Walk()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Bird <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bird)</span> <span class="title">Quack</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"bibibi"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bird)</span> <span class="title">Walk</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"gogogo"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    b := <span class="built_in">new</span>(Bird)</div><div class="line">    DuckDance(b)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-12-2-动态方法调用"><a href="#11-12-2-动态方法调用" class="headerlink" title="11.12.2 动态方法调用"></a>11.12.2 动态方法调用</h3><ul>
<li>当一个变量被赋值给一个接口类型的变量时，编译器会检查其是否实现了该接口的所有函数，空接口可以使用类型断言来判断</li>
<li>go提供了动态语言的优点，却没有其他动态语言在运行时随时会报错的缺点</li>
<li>Go 的接口提高了代码的分离度，改善了代码的复用性，使得代码开发过程中的设计模式更容易实现。用 Go 接口还能实现 依赖注入模式。</li>
</ul>
<h3 id="11-12-3-接口的提取"><a href="#11-12-3-接口的提取" class="headerlink" title="11.12.3 接口的提取"></a>11.12.3 接口的提取</h3><ul>
<li>接口的提取是非常有用的设计模式，可以减少需要的类型和方法数量</li>
<li>一些拥有共同行为的对象可以抽象出接口</li>
<li>整个设计可以持续演进，不用废弃之前的决定</li>
<li>类型要实现某个接口，本身不用改变，在类型上实现新的方法就可以</li>
</ul>
<h3 id="11-12-4-显示的指明类型实现了某个接口"><a href="#11-12-4-显示的指明类型实现了某个接口" class="headerlink" title="11.12.4 显示的指明类型实现了某个接口"></a>11.12.4 显示的指明类型实现了某个接口</h3><ul>
<li>结构体中添加具有描述性名字的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Fooer <span class="keyword">interface</span> &#123;</div><div class="line">    Foo()</div><div class="line">    ImplementsFooer()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-12-5-空接口和函数重载"><a href="#11-12-5-空接口和函数重载" class="headerlink" title="11.12.5 空接口和函数重载"></a>11.12.5 空接口和函数重载</h3><ul>
<li>go语言是不允许函数重载的</li>
<li>go中通过将最后一个参数换成…interface{}来实现函数重载，允许传递任意数量任意类型的参数给函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Printf(format <span class="keyword">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;) (n <span class="keyword">int</span>, err error)</div></pre></td></tr></table></figure>
<h3 id="11-12-6-接口的继承"><a href="#11-12-6-接口的继承" class="headerlink" title="11.12.6 接口的继承"></a>11.12.6 接口的继承</h3><ul>
<li>当一个类型嵌套另外一个类型的指针时，这个类型就可以使用另一个类型的所有方法</li>
<li>多态用的越多，代码就相对越少</li>
<li>类型可以通过继承多个接口来实现多重继承</li>
<li>添加新的接口是非常容易的，因为已有的类型不用变动，仅需要实现新的接口即可</li>
</ul>
<h3 id="11-13-go中面向对象总结"><a href="#11-13-go中面向对象总结" class="headerlink" title="11.13 go中面向对象总结"></a>11.13 go中面向对象总结</h3><ul>
<li>go中没有类，而是松耦合的类型，方法对接口的实现</li>
<li>封装：go的可见层级为两个，包范围内可见和全局可见</li>
<li>继承：用组合实现，内嵌一个或者多个想要的行为的类型，可以多重嵌套</li>
<li>多态：用接口实现，某个类型的实例可以赋值给它所实现的任意接口类型的变量。类型和接口是松耦合的，多重继承可以通过实现多个接口来实现。</li>
</ul>
<h3 id="11-14-结构体、集合和高阶函数"><a href="#11-14-结构体、集合和高阶函数" class="headerlink" title="11.14 结构体、集合和高阶函数"></a>11.14 结构体、集合和高阶函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cars.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</div><div class="line">	Model   	<span class="keyword">string</span></div><div class="line">	Manufacturer	<span class="keyword">string</span></div><div class="line">	BuildYear	<span class="keyword">int</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Cars []*Car</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// make some cars:</span></div><div class="line">	ford := &amp;Car&#123;<span class="string">"Fiesta"</span>,<span class="string">"Ford"</span>, <span class="number">2008</span>&#125;</div><div class="line">	bmw  := &amp;Car&#123;<span class="string">"XL 450"</span>, <span class="string">"BMW"</span>, <span class="number">2011</span>&#125;</div><div class="line">	merc := &amp;Car&#123;<span class="string">"D600"</span>, <span class="string">"Mercedes"</span>, <span class="number">2009</span>&#125;</div><div class="line">	bmw2 := &amp;Car&#123;<span class="string">"X 800"</span>, <span class="string">"BMW"</span>, <span class="number">2008</span>&#125;</div><div class="line">	<span class="comment">// query:</span></div><div class="line">	allCars := Cars([]*Car&#123;ford, bmw, merc, bmw2&#125;)</div><div class="line">	allNewBMWs := allCars.FindAll(<span class="function"><span class="keyword">func</span><span class="params">(car *Car)</span> <span class="title">bool</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> (car.Manufacturer == <span class="string">"BMW"</span>) &amp;&amp; (car.BuildYear &gt; <span class="number">2010</span>)</div><div class="line">	&#125;)</div><div class="line">	fmt.Println(<span class="string">"AllCars: "</span>, allCars)</div><div class="line">	fmt.Println(<span class="string">"New BMWs: "</span>, allNewBMWs)</div><div class="line">	<span class="comment">//</span></div><div class="line">	manufacturers := []<span class="keyword">string</span>&#123;<span class="string">"Ford"</span>, <span class="string">"Aston Martin"</span>, <span class="string">"Land Rover"</span>, <span class="string">"BMW"</span>, <span class="string">"Jaguar"</span>&#125;</div><div class="line">	sortedAppender, sortedCars := MakeSortedAppender(manufacturers)</div><div class="line">	allCars.Process(sortedAppender)</div><div class="line">	fmt.Println(<span class="string">"Map sortedCars: "</span>, sortedCars)</div><div class="line">    BMWCount := <span class="built_in">len</span>(sortedCars[<span class="string">"BMW"</span>])</div><div class="line">	fmt.Println(<span class="string">"We have "</span>, BMWCount, <span class="string">" BMWs"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Process all cars with the given function f:</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">Process</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span>)</span> &#123;</div><div class="line">     <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</div><div class="line">         f(c)</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Find all cars matching a given criteria.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">FindAll</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span> <span class="title">bool</span>) <span class="title">Cars</span></span> &#123;</div><div class="line">    cars := <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line"></div><div class="line">    cs.Process(<span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> f(c) &#123;</div><div class="line">            cars = <span class="built_in">append</span>(cars, c)</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">return</span> cars</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Process cars and create new data.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">Map</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span> <span class="title">Any</span>) []<span class="title">Any</span></span> &#123;</div><div class="line">       result := <span class="built_in">make</span>([]Any, <span class="number">0</span>)</div><div class="line">       ix := <span class="number">0</span></div><div class="line">       cs.Process(<span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">           result[ix] = f(c)</div><div class="line">           ix++</div><div class="line">       &#125;)</div><div class="line">       <span class="keyword">return</span> result</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeSortedAppender</span><span class="params">(manufacturers []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">func</span>(car *Car)</span>, <span class="title">map</span>[<span class="title">string</span>]<span class="title">Cars</span>)</span> &#123;</div><div class="line">     <span class="comment">// Prepare maps of sorted cars.</span></div><div class="line">       sortedCars := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Cars)</div><div class="line"></div><div class="line">       <span class="keyword">for</span> _, m := <span class="keyword">range</span> manufacturers &#123;</div><div class="line">           sortedCars[m] = <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line">       &#125;</div><div class="line">       sortedCars[<span class="string">"Default"</span>] = <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line"></div><div class="line">       <span class="comment">// Prepare appender function:</span></div><div class="line">       appender := <span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">           <span class="keyword">if</span> _, ok := sortedCars[c.Manufacturer]; ok &#123;</div><div class="line">               sortedCars[c.Manufacturer] = <span class="built_in">append</span>(sortedCars[c.Manufacturer], c)</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               sortedCars[<span class="string">"Default"</span>] = <span class="built_in">append</span>(sortedCars[<span class="string">"Default"</span>], c)</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> appender, sortedCars</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Output:</span></div><div class="line"><span class="comment">AllCars:  [0xf8400038a0 0xf840003bd0 0xf840003ba0 0xf840003b70]</span></div><div class="line"><span class="comment">New BMWs:  [0xf840003bd0]</span></div><div class="line"><span class="comment">Map sortedCars:  map[Default:[0xf840003ba0] Jaguar:[] Land Rover:[] BMW:[0xf840003bd0 0xf840003b70] Aston Martin:[] Ford:[0xf8400038a0]]</span></div><div class="line"><span class="comment">We have  2  BMWs</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式简介/" itemprop="url">设计模式简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><ul>
<li>创建型模式：工厂方法模式，抽象工厂模式，单例模式，建造者模式，原型模式</li>
<li>结构型模式：适配器模式，装饰器模式，代理模式，外观模式，桥接模式，组合模式，享元模式</li>
<li>行为型模式：策略模式，模板方法模式，观察者模式，迭代子模式，责任链模式，命令模式，备忘录模式，状态模式，访问者模式，中介者模式，解释器模式。</li>
</ul>
<h1 id="设计模式六大原则"><a href="#设计模式六大原则" class="headerlink" title="设计模式六大原则"></a>设计模式六大原则</h1><ol>
<li>总原则-开闭原则</li>
</ol>
<p>对扩展开放，对修改封闭。</p>
<p>在需要对程序进行扩展时，不去修改原来的代码，而是要扩展原有代码，类似热插拔。需要使用接口或者抽象类。</p>
<ol>
<li>单一职能原则</li>
</ol>
<ul>
<li>不要存在多余一个类变更的原因，也就是每个类应该实现单一的职责，否则需要将类进行拆分。</li>
</ul>
<ol>
<li>里氏替换原则</li>
</ol>
<ul>
<li><p>任何基类可以出现的地方，子类一定可以出现。里氏替换原则是继承复用的基石，只有当衍生类可以替换基类，软件单位的功能不受影响时，基类才能真正被复用，而衍生类也能够在基类的基础上增加新的行为。</p>
</li>
<li><p>里氏替换原则是对实现抽象化的具体步骤的规范。其中子类对父类的方法尽量不要重写和重载。因为父类代表着定义好的结构，通过这个规范的接口与外界交互，子类不应该破坏。</p>
</li>
</ul>
<ol>
<li>依赖倒转原则</li>
</ol>
<ul>
<li>面向接口编程，依赖于抽象而不依赖于具体。写代码时用到具体类时，不与具体类交互，而是与具体类的上层接口交互。</li>
</ul>
<ol>
<li>接口隔离原则</li>
</ol>
<ul>
<li>每个接口中不存在子类用不到却必须实现的方法，否则就拆分接口。使用多个隔离的接口，比使用单个接口要好。</li>
</ul>
<ol>
<li>迪米特法则</li>
</ol>
<ul>
<li><p>一个类对自己依赖的类知道的越少越好。无论被依赖的类多么复杂，都应该讲逻辑封装到方法的内部，通过public方法提供给外部。这样当被依赖的类变化时，才能最小的影响该类。</p>
</li>
<li><p>最少知道原则：只与直接的朋友通信，类之间要是有耦合关系，就称为朋友关系。耦合分为依赖，关联，聚合，组合灯，我们成出现为成员变量，方法参数，方法返回值中的类为直接朋友。局部变量，临时变量则不是直接朋友。我们要求陌生的类不要作为局部变量出现在类中。</p>
</li>
</ul>
<ol>
<li>合成复用原则</li>
</ol>
<ul>
<li>尽量首先使用合成、聚合方式，而不是使用继承。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之原型模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之原型模式/" itemprop="url">设计模式之原型模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h1><p>用原型实例指定创建对象的种类，并通过拷贝这些原型创建新的对象。</p>
<h1 id="模式使用场景"><a href="#模式使用场景" class="headerlink" title="模式使用场景"></a>模式使用场景</h1><ol>
<li>类初始化需要消耗非常多的资源，这个资源包括数据，硬件资源等，通过原型拷贝避免这些消耗。</li>
<li>通过new产生一个对象需要非常繁琐的数据准备或访问权限，则可以使用原型模式。</li>
<li>一个对象需要提供给其他对象访问，而且各个调用者可能都需要修改其值时，可以考虑使用原型模式拷贝多个对象供调用者使用。</li>
</ol>
<h1 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h1><p><img src="/img/dp-factory-prototype.png" alt="Alt text"></p>
<h2 id="角色描述"><a href="#角色描述" class="headerlink" title="角色描述"></a>角色描述</h2><pre><code>* Client: 客户端用户
* Prototype：抽象类或接口，声明具备clone能力
* ConcretePrototype：具体的原型类
</code></pre><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>文档拷贝为例。</p>
<p>Prototype抽象类为java.lang.clone,ConcretePrototype通过重写该方法完成对象的拷贝功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">package prototype;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/25</div><div class="line"> */</div><div class="line">public class ConcretePrototype implements Cloneable&#123;</div><div class="line">    private String mText;</div><div class="line">    private ArrayList&lt;String&gt; mImages = new ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    public ConcretePrototype() &#123;</div><div class="line">        System.out.println(&quot;concretePrototype构造函数&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    protected Object clone() throws CloneNotSupportedException &#123;</div><div class="line">        try &#123;</div><div class="line">            ConcretePrototype concretePrototype = (ConcretePrototype) super.clone();</div><div class="line">            concretePrototype.mText = this.mText;</div><div class="line">            concretePrototype.mImages = this.mImages;</div><div class="line">            return concretePrototype;</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public String getmText() &#123;</div><div class="line">        return mText;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setmText(String mText) &#123;</div><div class="line">        this.mText = mText;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ArrayList&lt;String&gt; getmImages() &#123;</div><div class="line">        return mImages;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setmImages(ArrayList&lt;String&gt; mImages) &#123;</div><div class="line">        this.mImages = mImages;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void addImage(String img) &#123;</div><div class="line">        this.mImages.add(img);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void showContent() &#123;</div><div class="line">        System.out.println(&quot;==========start===========&quot;);</div><div class="line">        System.out.println(&quot;Text:  &quot; + mText);</div><div class="line">        System.out.println(&quot;Images List: &quot;);</div><div class="line">        for (String string : mImages) &#123;</div><div class="line">            System.out.println(&quot;image name : &quot; + string);</div><div class="line">        &#125;</div><div class="line">        System.out.println(&quot;============end==========&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Client:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">package prototype;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/25</div><div class="line"> */</div><div class="line">public class Client &#123;</div><div class="line">    public static void main(String[] args) throws CloneNotSupportedException &#123;</div><div class="line">        //创建对象</div><div class="line">        ConcretePrototype original = new ConcretePrototype();</div><div class="line">        original.setmText(&quot;first&quot;);</div><div class="line">        original.addImage(&quot;pic 1&quot;);</div><div class="line">        original.addImage(&quot;pic 2&quot;);</div><div class="line">        original.addImage(&quot;pic 3&quot;);</div><div class="line">        original.addImage(&quot;pic 4&quot;);</div><div class="line">        original.showContent();</div><div class="line">        //复制对象</div><div class="line">        ConcretePrototype clone = (ConcretePrototype) original.clone();</div><div class="line">        clone.showContent();</div><div class="line">        //修改并展示复制的对象</div><div class="line">        clone.setmText(&quot;clone&quot;);</div><div class="line">        clone.showContent();</div><div class="line">        //展示原型对象</div><div class="line">        original.showContent();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结果：修改clone之后的对象的值不会印象到原来的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">concretePrototype构造函数</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  clone</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div></pre></td></tr></table></figure>
<p>深浅拷贝的区别：引用类型拷贝过程中，只拷贝了其引用，并没有将对象进行复制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">package prototype;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/25</div><div class="line"> */</div><div class="line">public class Client1 &#123;</div><div class="line">    public static void main(String[] args) throws CloneNotSupportedException &#123;</div><div class="line">        //创建对象</div><div class="line">        ConcretePrototype original = new ConcretePrototype();</div><div class="line">        original.setmText(&quot;first&quot;);</div><div class="line">        original.addImage(&quot;pic 1&quot;);</div><div class="line">        original.addImage(&quot;pic 2&quot;);</div><div class="line">        original.addImage(&quot;pic 3&quot;);</div><div class="line">        original.addImage(&quot;pic 4&quot;);</div><div class="line">        original.showContent();</div><div class="line"></div><div class="line">        ConcretePrototype clone = (ConcretePrototype) original.clone();</div><div class="line">        clone.showContent();</div><div class="line"></div><div class="line">        clone.setmText(&quot;clone1&quot;);</div><div class="line">        clone.addImage(&quot;new pic 5&quot;);</div><div class="line">        clone.showContent();</div><div class="line"></div><div class="line">        original.showContent();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">concretePrototype构造函数</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  clone1</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">image name : new pic 5</div><div class="line">============end==========</div><div class="line">==========start===========</div><div class="line">Text:  first</div><div class="line">Images List:</div><div class="line">image name : pic 1</div><div class="line">image name : pic 2</div><div class="line">image name : pic 3</div><div class="line">image name : pic 4</div><div class="line">image name : new pic 5</div><div class="line">============end==========</div></pre></td></tr></table></figure>
<p>深拷贝过程中需要将引用类型的字段也要进行拷贝，而不是单纯的拷贝引用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 深拷贝</div><div class="line"> * @return</div><div class="line"> * @throws CloneNotSupportedException</div><div class="line"> */</div><div class="line">@Override</div><div class="line">protected Object clone() throws CloneNotSupportedException &#123;</div><div class="line">    try &#123;</div><div class="line">        ConcretePrototype concretePrototype = (ConcretePrototype) super.clone();</div><div class="line">        concretePrototype.mText = this.mText;</div><div class="line">        concretePrototype.mImages = (ArrayList&lt;String&gt;) this.mImages.clone();</div><div class="line">        return concretePrototype;</div><div class="line">    &#125; catch (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="优点和缺点"><a href="#优点和缺点" class="headerlink" title="优点和缺点"></a>优点和缺点</h2><ul>
<li><p>优点：原型模式是在内存二进制流的拷贝，要比直接new一个对象性能好很多，特别是需要在一个循环体中产生大量对象时。</p>
</li>
<li><p>缺点：直接在内存中拷贝，构造方法不会执行，减少了约束，需要注意。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之代理模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之代理模式/" itemprop="url">设计模式之代理模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h1><p>为其他对象提供一种代理，以控制对这个对象的访问。代理对象起到中介作用，可以去掉功能服务或者增加额外的功能服务。</p>
<h1 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h1><p>代理和被代理对象在代理之前是确定的。他们都是事先相同的接口或者继承相同的抽象类。</p>
<p><img src="/img/dp-staticProxy.png" alt="Alt text"></p>
<p>创建一个接口Moveable，Car继承Moveable接口，要求用代理类来记录Car的运行时间。</p>
<p>Car继承Moveable接口:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">public interface Moveable &#123;</div><div class="line">    void move();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Car:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class Car implements Moveable&#123;</div><div class="line">    @Override</div><div class="line">    public void move() &#123;</div><div class="line">        try &#123;</div><div class="line">            Thread.sleep(new Random().nextInt(1000));</div><div class="line">        &#125; catch (InterruptedException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="继承实现静态代理"><a href="#继承实现静态代理" class="headerlink" title="继承实现静态代理"></a>继承实现静态代理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Car2 extends Car&#123;</div><div class="line">    @Override</div><div class="line">    public void move() &#123;</div><div class="line">        long startTime = System.currentTimeMillis();</div><div class="line">        System.out.println(startTime);</div><div class="line">        super.move();</div><div class="line">        long endTime = System.currentTimeMillis();</div><div class="line">        System.out.println(endTime);</div><div class="line">        System.out.println(endTime - startTime);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="聚合实现静态代理"><a href="#聚合实现静态代理" class="headerlink" title="聚合实现静态代理"></a>聚合实现静态代理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class Car3 implements Moveable&#123;</div><div class="line"></div><div class="line">    private Car car;</div><div class="line"></div><div class="line">    public Car3(Car car) &#123;</div><div class="line">        this.car = car;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void move() &#123;</div><div class="line">        long startTime = System.currentTimeMillis();</div><div class="line">        System.out.println(startTime);</div><div class="line">        car.move();</div><div class="line">        long endTime = System.currentTimeMillis();</div><div class="line">        System.out.println(endTime);</div><div class="line">        System.out.println(endTime - startTime);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>考虑到继承方式扩展代理功能的不方便，推荐使用聚合实现静态代理。也就是代理类和实际类实现共同的接口，代理类中包含所实现接口的引用。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class CarLogProxy implements Moveable&#123;</div><div class="line"></div><div class="line">    private Moveable moveable;</div><div class="line"></div><div class="line">    public CarLogProxy(Moveable moveable) &#123;</div><div class="line">        this.moveable = moveable;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void move() &#123;</div><div class="line">        System.out.println(&quot;log start&quot;);</div><div class="line">        moveable.move();</div><div class="line">        System.out.println(&quot;log end&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">public class CarTimeProxy implements Moveable&#123;</div><div class="line"></div><div class="line">    private Moveable moveable;</div><div class="line"></div><div class="line">    public CarTimeProxy(Moveable moveable) &#123;</div><div class="line">        this.moveable = moveable;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void move() &#123;</div><div class="line">        long startTime = System.currentTimeMillis();</div><div class="line">        System.out.println(startTime);</div><div class="line">        moveable.move();</div><div class="line">        long endTime = System.currentTimeMillis();</div><div class="line">        System.out.println(endTime);</div><div class="line">        System.out.println(endTime - startTime);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Test &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Moveable car = new Car();</div><div class="line">        CarTimeProxy carTimeProxy = new CarTimeProxy(car);</div><div class="line">        CarLogProxy carLogProxy = new CarLogProxy(carTimeProxy);</div><div class="line">        carLogProxy.move();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h1><p>前面实现了Car类的静态代理，为其添加了运行时间记录和日志记录的功能。如果需要为火车或者自行车添加类似的功能，需要重新定义相同的类，类十分臃肿，同时代码重用性不高，因此引入了动态代理，也就是在程序</p>
<h2 id="jdk动态代理"><a href="#jdk动态代理" class="headerlink" title="jdk动态代理"></a>jdk动态代理</h2><p><img src="/img/dp-dynamicProxy.png" alt="Alt text"></p>
<ul>
<li>InvocationHandler接口，接口中定义了一个invoke方法，invoke方法中第一个参数表示代理类，第二个参数指被代理的方法，args指该方法的参数数组。这个抽象方法会在代理类中动态实现。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public interface InvocationHandler &#123;</div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args)</div><div class="line">        throws Throwable;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Proxy：该类为动态代理类，其中的newProxyInstance方法返回一个代理类实例，返回后的代理类可以被当做代理类使用，可使用被代理类的在接口中声明过的方法。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public static Object newProxyInstance(ClassLoader loader,</div><div class="line">                                          Class&lt;?&gt;[] interfaces,</div><div class="line">                                          InvocationHandler h)</div><div class="line">        throws IllegalArgumentException</div><div class="line">    &#123;</div><div class="line">        Objects.requireNonNull(h);</div><div class="line"></div><div class="line">        final Class&lt;?&gt;[] intfs = interfaces.clone();</div><div class="line">        final SecurityManager sm = System.getSecurityManager();</div><div class="line">        if (sm != null) &#123;</div><div class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, intfs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Look up or generate the designated proxy class.</div><div class="line">         */</div><div class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, intfs);</div><div class="line"></div><div class="line">        /*</div><div class="line">         * Invoke its constructor with the designated invocation handler.</div><div class="line">         */</div><div class="line">        try &#123;</div><div class="line">            if (sm != null) &#123;</div><div class="line">                checkNewProxyPermission(Reflection.getCallerClass(), cl);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</div><div class="line">            final InvocationHandler ih = h;</div><div class="line">            if (!Modifier.isPublic(cl.getModifiers())) &#123;</div><div class="line">                AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123;</div><div class="line">                    public Void run() &#123;</div><div class="line">                        cons.setAccessible(true);</div><div class="line">                        return null;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">            return cons.newInstance(new Object[]&#123;h&#125;);</div><div class="line">        &#125; catch (IllegalAccessException|InstantiationException e) &#123;</div><div class="line">            throw new InternalError(e.toString(), e);</div><div class="line">        &#125; catch (InvocationTargetException e) &#123;</div><div class="line">            Throwable t = e.getCause();</div><div class="line">            if (t instanceof RuntimeException) &#123;</div><div class="line">                throw (RuntimeException) t;</div><div class="line">            &#125; else &#123;</div><div class="line">                throw new InternalError(t.toString(), t);</div><div class="line">            &#125;</div><div class="line">        &#125; catch (NoSuchMethodException e) &#123;</div><div class="line">            throw new InternalError(e.toString(), e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h2 id="动态代理实现步骤"><a href="#动态代理实现步骤" class="headerlink" title="动态代理实现步骤"></a>动态代理实现步骤</h2><ol>
<li>创建一个实现接口InvocationHandler的类，实现invoke方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class TimeHandler implements InvocationHandler&#123;</div><div class="line"></div><div class="line">    private Object target;</div><div class="line"></div><div class="line">    public TimeHandler(Object target) &#123;</div><div class="line">        this.target = target;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     *</div><div class="line">     * @param proxy 被代理的对象</div><div class="line">     * @param method 被代理对象的方法</div><div class="line">     * @param args 被代理对象的方法的参数</div><div class="line">     * @return Object对象，方法的返回值</div><div class="line">     * @throws Throwable</div><div class="line">     */</div><div class="line">    @Override</div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123;</div><div class="line">        System.out.println(&quot;time begin&quot;);</div><div class="line">        method.invoke(target);</div><div class="line">        System.out.println(&quot;time end&quot;);</div><div class="line">        return null;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建被代理的类以及接口(Car以及Moveable)</li>
<li>调用Proxy的静态方法，创建一个代理类</li>
<li>通过代理调用方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class Test &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Car car = new Car();</div><div class="line"></div><div class="line">        InvocationHandler h = new TimeHandler(car);</div><div class="line">        Class&lt;?&gt; cls = car.getClass();</div><div class="line"></div><div class="line">        /**</div><div class="line">         * loader：类加载器</div><div class="line">         * interfaces：实现接口</div><div class="line">         * h ：invocationHandler</div><div class="line">         */</div><div class="line">        Moveable m = (Moveable) Proxy.newProxyInstance(cls.getClassLoader(), cls.getInterfaces(), h);</div><div class="line"></div><div class="line">        m.move();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="JDK动态代理与CGLIB动态代理的区别"><a href="#JDK动态代理与CGLIB动态代理的区别" class="headerlink" title="JDK动态代理与CGLIB动态代理的区别"></a>JDK动态代理与CGLIB动态代理的区别</h2><table>
<thead>
<tr>
<th>jdk动态代理</th>
<th>CGLIB动态代理</th>
</tr>
</thead>
<tbody>
<tr>
<td>只能代理实现了接口的类</td>
<td>针对类来实现代理</td>
</tr>
<tr>
<td>没有实现接口的类不能实现JDK动态代理</td>
<td>对指定目标类产生一个子类，通过方法拦截技术拦截所有父类方法调用</td>
</tr>
<tr>
<td>JDK动态代理利用反射机制生成一个实现代理接口的匿名类，在调用具体方法前调用InvocationHandler来处理</td>
<td>cglib是利用asm开源包，对代理对象的class文件加载进来，通过修改其字节码生成子类来处理</td>
</tr>
</tbody>
</table>
<h2 id="模拟JDK动态代理的实现"><a href="#模拟JDK动态代理的实现" class="headerlink" title="模拟JDK动态代理的实现"></a>模拟JDK动态代理的实现</h2><p>实现功能，通过Proxy的newproxyInstance返回代理对象<br>1、声明一段源码，动态产生代理<br>2、编译源码，产生新的类<br>3、将这个类load到内存中，产生一个新的对象<br>4、return代理对象</p>
<p>handler:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">package proxy;</div><div class="line"></div><div class="line">import java.lang.reflect.Method;</div><div class="line"></div><div class="line">public interface InvocationHandler &#123;</div><div class="line">    public void invoke(Object o, Method m);</div><div class="line">&#125;</div><div class="line"></div><div class="line">package proxy;</div><div class="line"></div><div class="line">import java.lang.reflect.InvocationTargetException;</div><div class="line">import java.lang.reflect.Method;</div><div class="line"></div><div class="line">public class TimeHandler implements InvocationHandler&#123;</div><div class="line"></div><div class="line">    private Object target;</div><div class="line"></div><div class="line">    public TimeHandler(Object target) &#123;</div><div class="line">        this.target = target;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void invoke(Object o, Method m) &#123;</div><div class="line">        try &#123;</div><div class="line">            long starttime = System.currentTimeMillis();</div><div class="line">            System.out.println(&quot;汽车开始行驶....&quot;);</div><div class="line">            m.invoke(target);</div><div class="line">            long endtime = System.currentTimeMillis();</div><div class="line">            System.out.println(&quot;汽车结束行驶....  汽车行驶时间：&quot;+ (endtime - starttime) + &quot;毫秒！&quot;);</div><div class="line">        &#125; catch (IllegalAccessException | InvocationTargetException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>proxy:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">public class Proxy &#123;</div><div class="line"></div><div class="line">    public static Object newProxyInstance(Class infce, InvocationHandler h) throws IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException &#123;</div><div class="line">        //创建源码</div><div class="line">        String rt = &quot;\r\n&quot;;</div><div class="line">        String methodStr = &quot;&quot;;</div><div class="line">        for(Method m : infce.getMethods())&#123;</div><div class="line">            methodStr += &quot;	@Override&quot; + rt +</div><div class="line">                    &quot;	public void &quot; + m.getName() + &quot;() &#123;&quot; + rt +</div><div class="line">                    &quot;  try&#123;&quot; + rt +</div><div class="line">                    &quot;  Method md = &quot; + infce.getName() + &quot;.class.getMethod(\&quot;&quot;</div><div class="line">                    + m.getName() + &quot;\&quot;);&quot; + rt +</div><div class="line">                    &quot;  h.invoke(this,md);&quot; +rt+</div><div class="line">                    &quot;  &#125;catch(Exception e)&#123; e.printStackTrace();&#125;&quot; + rt +</div><div class="line">                    &quot;	&#125;&quot; ;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String str =</div><div class="line">                &quot;package proxy;&quot; + rt +</div><div class="line">                        &quot;import java.lang.reflect.Method;&quot; + rt +</div><div class="line">                        &quot;import proxy.InvocationHandler;&quot; +  rt+</div><div class="line">                        &quot;public class $Proxy0 implements &quot; + infce.getName() + &quot; &#123;&quot; + rt +</div><div class="line">                        &quot;	public $Proxy0(InvocationHandler h) &#123;&quot; + rt +</div><div class="line">                        &quot;		this.h = h;&quot; + rt +</div><div class="line">                        &quot;	&#125;&quot; + rt +</div><div class="line">                        &quot;  private InvocationHandler h;&quot; + rt+</div><div class="line">                        methodStr + rt +</div><div class="line">                        &quot;&#125;&quot; ;</div><div class="line">        String fileName = System.getProperty(&quot;user.dir&quot;) + &quot;/out/production/Design_Patterns_new/proxy/$Proxy0.java&quot;;</div><div class="line">        File file = new File(fileName);</div><div class="line">        FileUtils.writeStringToFile(file, str);</div><div class="line"></div><div class="line">        //编译源码</div><div class="line">        JavaCompiler compiler = ToolProvider.getSystemJavaCompiler();</div><div class="line">        StandardJavaFileManager fileManager = compiler.getStandardFileManager(null, null, null);</div><div class="line">        Iterable units = fileManager.getJavaFileObjects(fileName);</div><div class="line">        //编译任务</div><div class="line">        JavaCompiler.CompilationTask task = compiler.getTask(null, fileManager, null, null, null, units);</div><div class="line">        //执行任务</div><div class="line">        task.call();</div><div class="line">        fileManager.close();</div><div class="line"></div><div class="line">        //load到内存</div><div class="line">        ClassLoader loader = ClassLoader.getSystemClassLoader();</div><div class="line">        Class&lt;?&gt; c = loader.loadClass(&quot;proxy.$Proxy0&quot;);</div><div class="line"></div><div class="line">        Constructor constructor = c.getConstructor(InvocationHandler.class);</div><div class="line">        return constructor.newInstance(h);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之单例模式与工厂方法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之单例模式与工厂方法/" itemprop="url">设计模式之单例模式与工厂方法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h1><p>  设计模式是一套被反复使用的，多数人知晓的，经过分类编目的，代码设计经验的总结。使用设计模式是为了可重用代码。</p>
<h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><ol>
<li><p>定义：单例模式确保只有一个实例，而且自行实例化并向整个系统提供这个实例。</p>
</li>
<li><p>类型：创建类模式</p>
</li>
<li><p>组成：私有构造方法则不能通过构造方法来创建类，静态属性在类加载时就创建了一个对象，公有静态方法保证外部类可以直接调用。</p>
<ul>
<li>私有的构造方法</li>
<li>指向自己实例的私有静态引用</li>
<li>以自己实例为返回值的静态的公有方法</li>
</ul>
</li>
<li><p>实现：</p>
<ol>
<li><p>饿汉式单例：单例类被加载时候，就实例化一个对象交个自己引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public class Singleton &#123;</div><div class="line">    private Singleton() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Singleton singleton = new Singleton();</div><div class="line"></div><div class="line">    public static Singleton getInstance() &#123;</div><div class="line">        return singleton;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>懒汉式实例：调用取得方法实例时才会实例化对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class Singleton1 &#123;</div><div class="line">    private Singleton1()&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Singleton1 singleton1;</div><div class="line"></div><div class="line">    public static synchronized Singleton1 getInstacne()&#123;</div><div class="line">        if (singleton1 == null)</div><div class="line">            singleton1 = new Singleton1();</div><div class="line">        return singleton1;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>优点:</p>
<ul>
<li>内存中只有一个对象，节省内存空间</li>
<li>避免频繁的创建和销毁对象，可以提高性能</li>
<li>避免对共享资源的多重占用</li>
<li>可以全局访问</li>
</ul>
</li>
<li><p>应用场景：</p>
<ul>
<li>需要频繁实例化然后销毁的对象</li>
<li>创建对象耗时过多或者消耗资源过多，但又经常用到的对象。</li>
<li>有状态的工具类对象</li>
<li>频繁访问数据库或文件的对象</li>
</ul>
</li>
<li><p>注意事项：</p>
<ul>
<li>只能使用单例类提供的方法获得单例对象，不要使用反射，否则会实例化一个新对象。</li>
<li>不要做断开单例类对象与类中静态引用的操作。</li>
<li>多线程使用单例共享资源时，注意线程安全的问题。</li>
</ul>
</li>
<li><p>相关问题：</p>
<ul>
<li><p>单例模式的对象长时间不用会被jvm回收吗？<br>  不会，Hotspot中只要对象和GC Roots之间有可达引用链，也就是单例对象和单例中的引用没有被断开就不会被回收。</p>
</li>
<li><p>一个jvm中会出现多个单例吗？<br>  不使用反射的话，在一个jvm中不会出现多个单例。</p>
</li>
<li><p>单例模式只有饿汉和懒汉两种吗？<br>  所有可以实现一个实例的类，都是单例模式。</p>
</li>
<li><p>单例模式可以被继承吗？<br>  饿汉和懒汉，private方法不可以被继承。</p>
</li>
</ul>
</li>
</ol>
<h1 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h1><ol>
<li><p>定义：定义一个用于创建对象的接口，让子类决定实例化哪一个类，工厂方法使一个类的实例化延迟到其子类。</p>
</li>
<li><p>类型：创建类模式</p>
</li>
<li><p>实现：</p>
<p>工厂模式根据抽象程度的不同分为三种：</p>
<ul>
<li><p>简单工厂模式（静态工厂模式）：创建一个工厂来创建新的对象。</p>
<p>   <img src="/img/dp-factory-simpleFactory.png" alt="Alt text"></p>
<p>   工厂类</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Factory &#123;</div><div class="line">    public Product createFactory(int type) &#123;</div><div class="line">        if (type == 1)</div><div class="line">            return new Product1();</div><div class="line">        else</div><div class="line">            return new Product2();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>   产品抽象类和具体产品</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public abstract class Product &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Product1 extends Product&#123;</div><div class="line">    public Product1() &#123;</div><div class="line">        System.out.println(&quot;product1&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Product2 extends Product&#123;</div><div class="line">    public Product2() &#123;</div><div class="line">        System.out.println(&quot;product2&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>   消费者</p>
   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class Customer &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Factory factory = new Factory();</div><div class="line">        Product product1 = factory.createFactory(1);</div><div class="line">        Product product2 = factory.createFactory(2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>组成：</p>
<ul>
<li>工厂类：用于创建商品</li>
<li>抽象产品：具体产品继承的父类或者实现的接口</li>
<li>具体产品：工厂类创建的对象</li>
</ul>
</li>
<li><p>此时当我们想要添加一种产品时，需要修改工厂类的业务员逻辑，实际中对应很多产品，对于工厂类来说负担太大，因此引入工厂方法模式，也就是讲工厂类定义成接口，增加一个商品，就增加该商品对应的工厂类的实现。</p>
</li>
</ul>
</li>
<li><p>工厂方法模式</p>
<p> <img src="/img/dp-factory-factoryMethod.png" alt="Alt text"></p>
<p> 产品类：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public interface IProduct &#123;</div><div class="line">    public void productMethod();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Product implements IProduct&#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;产品&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Product1 implements IProduct&#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;产品1&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 工厂类</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public interface IFactory &#123;</div><div class="line">    public IProduct createProduct();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Factory implements IFactory&#123;</div><div class="line">    @Override</div><div class="line">    public IProduct createProduct() &#123;</div><div class="line">        return new Product();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Factory1 implements IFactory&#123;</div><div class="line">    @Override</div><div class="line">    public IProduct createProduct() &#123;</div><div class="line">        return new Product1();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 客户类</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        IFactory factory = new Factory();</div><div class="line">        IProduct product = factory.createProduct();</div><div class="line">        product.productMethod();</div><div class="line"></div><div class="line">        IFactory factory1 = new Factory1();</div><div class="line">        IProduct product1 = factory1.createProduct();</div><div class="line">        product1.productMethod();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 工厂方法模式去掉了简单工厂模式中工厂方法的静态属性，使得它可以被子类继承。这样在简单工厂模式中集中在工厂方法中的压力就转到不同的工厂子类这种去了。</p>
<ul>
<li><p>组成：</p>
<ul>
<li>抽象工厂：具体工厂必须实现的接口或父类</li>
<li>具体工厂：含有和具体业务逻辑有关的代码。</li>
<li>抽象产品：具体产品继承的接口或父类。</li>
<li>具体产品：创建产品的类。</li>
</ul>
</li>
<li><p>工厂方法模式对对象的创建进行了包装，使得客户程序中仅仅处理抽象产品角色提供的接口。这样的缺点是使得对象的数量成倍增加。</p>
</li>
</ul>
</li>
<li><p>抽象工厂模式</p>
<p>产品类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">public interface IProductA &#123;</div><div class="line">    public void productMethod();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ProductA implements IProductA &#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;A产品&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ProductA1 implements IProductA &#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;A产品1&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public interface IProductB &#123;</div><div class="line">    public void productMethod();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ProductB implements IProductB &#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;B产品&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class ProductB1 implements IProductB &#123;</div><div class="line">    @Override</div><div class="line">    public void productMethod() &#123;</div><div class="line">        System.out.println(&quot;B产品1&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>工厂类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public interface AbstratFactory &#123;</div><div class="line">    public IProductA createProductA();</div><div class="line"></div><div class="line">    public IProductB createProductB();</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Factory implements AbstratFactory&#123;</div><div class="line">    @Override</div><div class="line">    public IProductA createProductA() &#123;</div><div class="line">        return new ProductA();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public IProductB createProductB() &#123;</div><div class="line">        return new ProductB();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public class Factory1 implements AbstratFactory&#123;</div><div class="line">    @Override</div><div class="line">    public IProductA createProductA() &#123;</div><div class="line">        return new ProductA1();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public IProductB createProductB() &#123;</div><div class="line">        return new ProductB1();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>客户端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class Client &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        //生产产品</div><div class="line">        AbstratFactory factory = new Factory();</div><div class="line">        IProductA productA = factory.createProductA();</div><div class="line">        productA.productMethod();</div><div class="line">        IProductB productB = factory.createProductB();</div><div class="line">        productB.productMethod();</div><div class="line">        //生产产品1</div><div class="line"></div><div class="line">        AbstratFactory factory1 = new Factory1();</div><div class="line">        IProductA productA1 = factory1.createProductA();</div><div class="line">        IProductB productB1 = factory1.createProductB();</div><div class="line">        productA1.productMethod();</div><div class="line">        productB1.productMethod();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>无论是简单工厂模式，工厂方法模式，还是抽象工厂模式，他们都属于工厂模式，在形式和特点上也是极为相似的，他们的最终目的都是为了解耦。在使用时，我们不必去在意这个模式到底工厂方法模式还是抽象工厂模式，因为他们之间的演变常常是令人琢磨不透的。经常你会发现，明明使用的工厂方法模式，当新需求来临，稍加修改，加入了一个新方法后，由于类中的产品构成了不同等级结构中的产品族，它就变成抽象工厂模式了；而对于抽象工厂模式，当减少一个方法使的提供的产品不再构成产品族之后，它就演变成了工厂方法模式。</li>
</ul>
</li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之Spring中的应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之Spring中的应用/" itemprop="url">设计模式之Spring中的应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/Spring/" itemprop="url" rel="index">
                    <span itemprop="name">Spring</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Spring中使用的设计模式"><a href="#Spring中使用的设计模式" class="headerlink" title="Spring中使用的设计模式"></a>Spring中使用的设计模式</h1><ol>
<li><p>简单工厂</p>
<ul>
<li>又称为静态工厂，简单工厂模式的实质是由一个工厂类根据传入的参数，动态决定创建哪一个产品类。</li>
<li>Spring中BeanFactory通过传入一个唯一标示来获取bean对象</li>
</ul>
</li>
<li><p>工厂方法</p>
<ul>
<li>程序将对象的创建及初始化职责交给工厂对象，工厂父类负责定义创建产品对象的公共接口，工厂子类负责生成具体的产品对象。将产品类的实例化操作延迟到工厂子类中完成。</li>
<li>Spring中的FactoryBean就是一个典型的工厂方法模式。</li>
</ul>
</li>
<li><p>单例</p>
<ul>
<li>保证一个类仅有一个实例，并提供一个访问他的全局访问点。</li>
<li>Spring下默认的bean均为singleton，通过singleton或者scope属性指定</li>
</ul>
</li>
<li><p>适配器</p>
<ul>
<li>将一个接口转换成客户希望的另一个接口，使得接口不兼容的类可以一起工作，其别名为Wrapper。</li>
<li>Spring中AOP的处理利用了Adapter模式</li>
</ul>
</li>
<li><p>装饰器</p>
<ul>
<li>动态的给一个对象添加一些额外的职责。就增加对象功能来说，装饰模式比生成子类实现更为灵活，别名与适配器相同。</li>
<li>Spring中类名中含有Wrapper或者Decorator中应用了装饰器</li>
</ul>
</li>
<li><p>代理</p>
<ul>
<li>为其他对象提供一种代理以控制对这个对象的访问。</li>
<li>Spring中AOP就是利用JDK动态代理来增强类的切面管理。</li>
</ul>
</li>
<li><p>观察者</p>
<ul>
<li>定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于他的对象都被通知并被自动更新</li>
<li>spring中listener利用了观察者模式</li>
</ul>
</li>
<li><p>策略</p>
<ul>
<li>定义一系列的算法，将他们封装起来，并且使他们可互相替换，策略模式让算法独立于使用它的客户而变化，也称为政策模式。</li>
<li>Spring在实例化对象的时候使用到策略模式。</li>
</ul>
</li>
<li><p>模板方法</p>
<ul>
<li>定义一个操作中的算法的骨架，而将一些步骤延迟到子类中，使得子类可以不改变一个算法的结构即可重新定义该算法的某些特定步骤。</li>
<li>Spring中jdbcTemplate就使用了模板方法。 </li>
</ul>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之七种单例模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之七种单例模式/" itemprop="url">设计模式之七种单例模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对其中单例模式做个总结，以备不时之需。</p>
<h1 id="饿汉单例模式"><a href="#饿汉单例模式" class="headerlink" title="饿汉单例模式"></a>饿汉单例模式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/23</div><div class="line"> * 饿汉，基于ClassLoader机制避免了多线程的同步问题，加载过程较慢，获取对象速度较快</div><div class="line"> * 不过instance在类装载时就实例化。虽然大多数情况下调用单例模式的getInstance方法导致类加载，但是也不能确定没有其他</div><div class="line"> * 静态方法导致类被加载，从而没有达到懒加载的效果。</div><div class="line"> */</div><div class="line">public class Singleton &#123;</div><div class="line">    private Singleton() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Singleton singleton = new Singleton();</div><div class="line"></div><div class="line">    public static Singleton getInstance() &#123;</div><div class="line">        return singleton;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="懒汉（线程不安全）"><a href="#懒汉（线程不安全）" class="headerlink" title="懒汉（线程不安全）"></a>懒汉（线程不安全）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/24</div><div class="line"> * 懒汉设计模式，线程安全，但是效率很低，每次调用getInstance方法都需要</div><div class="line"> * 获得锁，而大多数情况下不需要同步</div><div class="line"> */</div><div class="line">public class Singleton1 &#123;</div><div class="line">    private Singleton1()&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Singleton1 singleton1;</div><div class="line"></div><div class="line">    public static synchronized Singleton1 getInstacne()&#123;</div><div class="line">        if (singleton1 == null)</div><div class="line">            singleton1 = new Singleton1();</div><div class="line">        return singleton1;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="懒汉（线程安全）"><a href="#懒汉（线程安全）" class="headerlink" title="懒汉（线程安全）"></a>懒汉（线程安全）</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/24</div><div class="line"> * 懒汉设计模式，线程不安全</div><div class="line"> */</div><div class="line">public class Singleton2 &#123;</div><div class="line">    private Singleton2()&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static Singleton2 singleton1;</div><div class="line"></div><div class="line">    public static Singleton2 getInstacne()&#123;</div><div class="line">        if (singleton1 == null)</div><div class="line">            singleton1 = new Singleton2();</div><div class="line">        return singleton1;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="双重检查单例模式"><a href="#双重检查单例模式" class="headerlink" title="双重检查单例模式"></a>双重检查单例模式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/30</div><div class="line"> * 双重检查模式，第一次是为了减少不必要的同步，当singleton对象存在时，</div><div class="line"> * 直接返回实例对象，则同步只发生在多个线程同时调用getInstance加载类</div><div class="line"> * 第二次判空是为了singleton为null才创建实例。</div><div class="line"> * DCL优点是资源利用率高，第一次执行getInstance时单例对象才被实例化，效率高。</div><div class="line"> * 缺点是第一次加载速度慢，高并发场景中也会影响其性能，但是也存在DCL失效，</div><div class="line"> * 建议使用静态内部类单例模式来替代DCL</div><div class="line"> */</div><div class="line">public class Singleton3 &#123;</div><div class="line">    private volatile static Singleton3 singleton;</div><div class="line"></div><div class="line">    private Singleton3() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static Singleton3 getInstance() &#123;</div><div class="line">        if (singleton == null) &#123;</div><div class="line">            synchronized (Singleton3.class) &#123;</div><div class="line">                if (singleton == null) &#123;</div><div class="line">                    singleton = new Singleton3();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return singleton;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/30</div><div class="line"> * 静态内部类单例：</div><div class="line"> * 第一次加载Singleton类时并不会初始化是Instance，只有第一次调用Singleton</div><div class="line"> * 方法时虚拟机加载SingletonHolder并初始化sInstance，这样不仅能确保线程安</div><div class="line"> * 全也能保证Singleton的唯一性，推荐使用。</div><div class="line"> */</div><div class="line">public class Singleton4 &#123;</div><div class="line">    private Singleton4() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static Singleton4 getInstance() &#123;</div><div class="line">        return SingletonHolder.sInstance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static class SingletonHolder&#123;</div><div class="line">        private static final Singleton4 sInstance = new Singleton4();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/30</div><div class="line"> * 默认枚举类实例的创建是线程安全的，并且在任何情况下都是单例，上述的几种</div><div class="line"> * 单例在反序列化的情况下会创建对象，将一个单例实例对象写到磁盘再读回来，</div><div class="line"> * 从而获得一个实例。反序列化操作提供了</div><div class="line"> */</div><div class="line">public enum Singleton5 &#123;</div><div class="line">    INSTANCE;</div><div class="line">    public void doSomething() &#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="容器实现单例"><a href="#容器实现单例" class="headerlink" title="容器实现单例"></a>容器实现单例</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">package singleton;</div><div class="line"></div><div class="line">import java.util.HashMap;</div><div class="line">import java.util.Map;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/3/30</div><div class="line"> * 使用容器实现单例模式</div><div class="line"> * 用SingletonManager 将多种的单例类统一管理，在使用时根据key获取对象</div><div class="line"> * 对应类型的对象。这种方式使得我们可以管理多种类型的单例，并且在使用</div><div class="line"> * 时可以通过统一的接口进行获取操作，降低了用户的使用成本，也对用户隐</div><div class="line"> * 藏了具体实现，降低了耦合度。</div><div class="line"> */</div><div class="line">public class Singleton6 &#123;</div><div class="line">    private static Map&lt;String, Object&gt; objectMap = new HashMap&lt;&gt;();</div><div class="line">    private Singleton6() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static void registerService(String key, Object instance) &#123;</div><div class="line">        if (!objectMap.containsKey(key)) &#123;</div><div class="line">            objectMap.put(key, instance);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static Object getService(String key) &#123;</div><div class="line">        return objectMap.get(key);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式之Builder模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式之Builder模式/" itemprop="url">设计模式之Builder模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="模式定义"><a href="#模式定义" class="headerlink" title="模式定义"></a>模式定义</h1><p>将一个复杂对象的构建与他的表示分离，使得同样的构建过程可以创建不同的表示。</p>
<h1 id="模式使用场景"><a href="#模式使用场景" class="headerlink" title="模式使用场景"></a>模式使用场景</h1><ol>
<li>相同的方法，不同的执行顺序，产生不同的时间结果时。</li>
<li>多个部件或零件，都可以装配到一个对象中，但是产生的结果又不相同时。</li>
<li>产品类非常复杂，或者产品类中的调用顺序不同产生了不同的效能时。</li>
</ol>
<h1 id="UML图"><a href="#UML图" class="headerlink" title="UML图"></a>UML图</h1><p><img src="/img/dp-factory-builder.png" alt="Alt text"></p>
<h2 id="角色描述"><a href="#角色描述" class="headerlink" title="角色描述"></a>角色描述</h2><pre><code>* Product产品类：产品的抽象类
* Builder：抽象类，规范产品的组件，一般由子类实现具体的组装过程。
* ConcreteBuilder：具体的构造器
* Director：统一组装过程
</code></pre><h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>电脑组装过程比较复杂，步骤很多，但是顺序却不确定。适用于Builder模式</p>
<p>Computer抽象类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public abstract class Computer &#123;</div><div class="line">    protected int mCpuCore = 1;</div><div class="line">    protected int mRanSize = 0;</div><div class="line">    protected String mOs = &quot;Dos&quot;;</div><div class="line"></div><div class="line">    public Computer() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public abstract void setmCpuCore(int mCpuCore);</div><div class="line"></div><div class="line">    public abstract void setmRanSize(int mRanSize);</div><div class="line"></div><div class="line">    public abstract void setmOs(String mOs);</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public String toString() &#123;</div><div class="line">        return &quot;Computer&#123;&quot; +</div><div class="line">                &quot;mCpuCore=&quot; + mCpuCore +</div><div class="line">                &quot;, mRanSize=&quot; + mRanSize +</div><div class="line">                &quot;, mOs=&apos;&quot; + mOs + &apos;\&apos;&apos; +</div><div class="line">                &apos;&#125;&apos;;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AppleComputer实现类：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class AppleComputer extends Computer&#123;</div><div class="line">    protected AppleComputer()&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void setmCpuCore(int mCpuCore) &#123;</div><div class="line">        super.mCpuCore = mCpuCore;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void setmRanSize(int mRanSize) &#123;</div><div class="line">        super.mRanSize = mRanSize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void setmOs(String mOs) &#123;</div><div class="line">        super.mOs = mOs;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Builder抽象类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public abstract class Builder &#123;</div><div class="line">    public abstract void buildCPU(int core);</div><div class="line"></div><div class="line">    public abstract void buildRAM(int gb);</div><div class="line"></div><div class="line">    public abstract void buildOs(String os);</div><div class="line"></div><div class="line">    public abstract Computer create();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AppleBuilder实现类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class AppleBuilder extends Builder&#123;</div><div class="line"></div><div class="line">    private Computer mApplePC = new AppleComputer();</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void buildCPU(int core) &#123;</div><div class="line">        mApplePC.setmCpuCore(core);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void buildRAM(int gb) &#123;</div><div class="line">        mApplePC.setmRanSize(gb);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public void buildOs(String os) &#123;</div><div class="line">        mApplePC.setmOs(os);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">    public Computer create() &#123;</div><div class="line">        return mApplePC;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public class Director &#123;</div><div class="line">    Builder builder = null;</div><div class="line"></div><div class="line">    public Director(Builder builder) &#123;</div><div class="line">        this.builder = builder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void construct(int cpu, int ram, String os) &#123;</div><div class="line">        builder.buildCPU(cpu);</div><div class="line">        builder.buildRAM(ram);</div><div class="line">        builder.buildOs(os);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Test</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class Test &#123;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        Builder builder = new AppleBuilder();</div><div class="line">        Director director = new Director(builder);</div><div class="line">        director.construct(4,2,&quot;Max OS X 10.0.3&quot;);</div><div class="line">        System.out.println(builder.create().toString());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="优点和缺点"><a href="#优点和缺点" class="headerlink" title="优点和缺点"></a>优点和缺点</h2><ul>
<li><p>优点：</p>
<ul>
<li>良好的封装性，使用Builder模式可以使客户端不必知道产品内部组成的细节。</li>
<li>建造者独立，容易扩展</li>
<li>在对象创建过程中会使用到系统中的其他对象，这些对象在产品的创建过程中不易得到。</li>
</ul>
</li>
<li><p>缺点：</p>
<ul>
<li>会产生多余的Builder对象和Director对象，消耗内存</li>
<li>对象的构建过程暴露。</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/算法之队列/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/算法之队列/" itemprop="url">算法-队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/algorithms/" itemprop="url" rel="index">
                    <span itemprop="name">algorithms</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="树的层序遍历问题"><a href="#树的层序遍历问题" class="headerlink" title="树的层序遍历问题"></a>树的层序遍历问题</h1><h2 id="从上到下"><a href="#从上到下" class="headerlink" title="从上到下"></a>从上到下</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import leetcode.stack.TreeNode;</div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class BinaryTreeLevelOrderTraversal_102 &#123;</div><div class="line">    public List&lt;List&lt;Integer&gt;&gt; levelOrder(TreeNode root) &#123;</div><div class="line">        List&lt;List&lt;Integer&gt;&gt; res = new ArrayList&lt;&gt;();</div><div class="line">        if (root == null)</div><div class="line">            return res;</div><div class="line">        Queue&lt;TreeNode&gt; queue = new LinkedList&lt;&gt;();</div><div class="line">        queue.offer(root);</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            int size = queue.size();</div><div class="line">            List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</div><div class="line">            for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">                TreeNode node = queue.poll();</div><div class="line">                list.add(node.val);</div><div class="line">                if (node.left != null)</div><div class="line">                    queue.offer(node.left);</div><div class="line">                if (node.right != null)</div><div class="line">                    queue.offer(node.right);</div><div class="line">            &#125;</div><div class="line">            res.add(list);</div><div class="line">        &#125;</div><div class="line">        return res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="从下到上"><a href="#从下到上" class="headerlink" title="从下到上"></a>从下到上</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import leetcode.stack.TreeNode;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class BinaryTreeLevelOrderTraversalII_107 &#123;</div><div class="line">    public List&lt;List&lt;Integer&gt;&gt; levelOrderBottom(TreeNode root) &#123;</div><div class="line">        List&lt;List&lt;Integer&gt;&gt; res = new ArrayList&lt;&gt;();</div><div class="line">        if (root == null)</div><div class="line">            return res;</div><div class="line">        Queue&lt;TreeNode&gt; queue = new LinkedList&lt;&gt;();</div><div class="line">        queue.offer(root);</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            int size = queue.size();</div><div class="line">            List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</div><div class="line">            for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">                TreeNode node = queue.poll();</div><div class="line">                list.add(node.val);</div><div class="line">                if (node.left != null)</div><div class="line">                    queue.offer(node.left);</div><div class="line">                if (node.right != null)</div><div class="line">                    queue.offer(node.right);</div><div class="line">            &#125;</div><div class="line">            res.add(0, list);</div><div class="line">        &#125;</div><div class="line">        return res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="之字形层序遍历"><a href="#之字形层序遍历" class="headerlink" title="之字形层序遍历"></a>之字形层序遍历</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import leetcode.stack.TreeNode;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class BinaryTreeZigzagLevelOrderTraversal_103 &#123;</div><div class="line">    public List&lt;List&lt;Integer&gt;&gt; zigzagLevelOrder(TreeNode root) &#123;</div><div class="line">        List&lt;List&lt;Integer&gt;&gt; res = new ArrayList&lt;&gt;();</div><div class="line">        if (root == null)</div><div class="line">            return res;</div><div class="line">        Queue&lt;TreeNode&gt; queue = new LinkedList&lt;&gt;();</div><div class="line">        queue.offer(root);</div><div class="line">        int flag = 1;</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            int size = queue.size();</div><div class="line">            List&lt;Integer&gt; list = new ArrayList&lt;&gt;();</div><div class="line">            for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">                TreeNode node = queue.poll();</div><div class="line">                if (flag % 2 == 1)</div><div class="line">                    list.add(node.val);</div><div class="line">                else</div><div class="line">                    list.add(0, node.val);</div><div class="line">                if (node.left != null)</div><div class="line">                    queue.offer(node.left);</div><div class="line">                if (node.right != null)</div><div class="line">                    queue.offer(node.right);</div><div class="line">            &#125;</div><div class="line">            res.add(list);</div><div class="line">            flag++;</div><div class="line">        &#125;</div><div class="line">        return res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="从一颗树右侧看过去的节点数"><a href="#从一颗树右侧看过去的节点数" class="headerlink" title="从一颗树右侧看过去的节点数"></a>从一颗树右侧看过去的节点数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import leetcode.stack.TreeNode;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.LinkedList;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Queue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class BinaryTreeRightSideView_199 &#123;</div><div class="line">    public List&lt;Integer&gt; rightSideView(TreeNode root) &#123;</div><div class="line">        List&lt;Integer&gt; res = new ArrayList&lt;&gt;();</div><div class="line">        if (root == null)</div><div class="line">            return res;</div><div class="line">        Queue&lt;TreeNode&gt; queue = new LinkedList&lt;&gt;();</div><div class="line">        queue.offer(root);</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            int size = queue.size();</div><div class="line">            for (int i = 0; i &lt; size; i++) &#123;</div><div class="line">                TreeNode node = queue.poll();</div><div class="line">                if (i == size - 1)</div><div class="line">                    res.add(node.val);</div><div class="line">                if (node.left != null)</div><div class="line">                    queue.offer(node.left);</div><div class="line">                if (node.right != null)</div><div class="line">                    queue.offer(node.right);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="合并k个排序链表-用优先队列，重写compare方法"><a href="#合并k个排序链表-用优先队列，重写compare方法" class="headerlink" title="合并k个排序链表, 用优先队列，重写compare方法"></a>合并k个排序链表, 用优先队列，重写compare方法</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import leetcode.linkedList.ListNode;</div><div class="line"></div><div class="line">import java.util.Comparator;</div><div class="line">import java.util.List;</div><div class="line">import java.util.PriorityQueue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class MergeKSortedLists_23 &#123;</div><div class="line">    public ListNode mergeKLists(ListNode[] lists) &#123;</div><div class="line">        if (lists == null || lists.length == 0)</div><div class="line">            return null;</div><div class="line">        PriorityQueue&lt;ListNode&gt; queue = new PriorityQueue&lt;&gt;(lists.length, new Comparator&lt;ListNode&gt;() &#123;</div><div class="line">            @Override</div><div class="line">            public int compare(ListNode o1, ListNode o2) &#123;</div><div class="line">                return o1.val - o2.val;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line"></div><div class="line">        ListNode dummy = new ListNode(0);</div><div class="line">        ListNode p = dummy;</div><div class="line">        for (ListNode node : lists) &#123;</div><div class="line">            if (node != null)</div><div class="line">                queue.add(node);</div><div class="line">        &#125;</div><div class="line">        while (!queue.isEmpty()) &#123;</div><div class="line">            p.next = queue.poll();</div><div class="line">            p = p.next;</div><div class="line">            if (p.next != null)</div><div class="line">                queue.add(p.next);</div><div class="line">        &#125;</div><div class="line">        return dummy.next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="找到数组中出现频率最高的k个数"><a href="#找到数组中出现频率最高的k个数" class="headerlink" title="找到数组中出现频率最高的k个数"></a>找到数组中出现频率最高的k个数</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">package leetcode.queue;</div><div class="line"></div><div class="line">import java.util.ArrayList;</div><div class="line">import java.util.HashMap;</div><div class="line">import java.util.List;</div><div class="line">import java.util.PriorityQueue;</div><div class="line"></div><div class="line">/**</div><div class="line"> * Created by cdx0312</div><div class="line"> * 2018/4/8</div><div class="line"> */</div><div class="line">public class TopKFrequentElements_347 &#123;</div><div class="line">    public List&lt;Integer&gt; topKFrequent(int[] nums, int k) &#123;</div><div class="line">        List&lt;Integer&gt; res = new ArrayList&lt;&gt;();</div><div class="line">        //统计数组中的元素出现的频率，key-num, value-次数</div><div class="line">        HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;();</div><div class="line">        for (int i = 0; i &lt; nums.length; i++) &#123;</div><div class="line">            if (map.containsKey(nums[i])) &#123;</div><div class="line">                map.put(nums[i], map.get(nums[i])+1);</div><div class="line">            &#125; else &#123;</div><div class="line">                map.put(nums[i],1);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //扫描map，维护当前频率最高的k个元素,</div><div class="line">        PriorityQueue&lt;Pair&gt; queue = new PriorityQueue&lt;&gt;(k);</div><div class="line">        for (Integer i : map.keySet()) &#123;</div><div class="line">            if (queue.size() == k) &#123;</div><div class="line">                if (map.get(i) &gt; queue.peek().freq)&#123;</div><div class="line">                    queue.poll();</div><div class="line">                    queue.add(new Pair(map.get(i),i));</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                queue.add(new Pair(map.get(i), i));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        //遍历优先队列，将num加入到结果集中</div><div class="line">        for (Pair pair : queue) &#123;</div><div class="line">            res.add(0, pair.num);</div><div class="line">        &#125;</div><div class="line">        return res;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    class Pair implements Comparable&lt;Pair&gt;&#123;</div><div class="line">        int freq;</div><div class="line">        int num;</div><div class="line">        public Pair(int freq, int num) &#123;</div><div class="line">            this.freq = freq;</div><div class="line">            this.num = num;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public int compareTo(Pair o) &#123;</div><div class="line">            return this.freq - o.freq;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">79</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">31</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">27</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
