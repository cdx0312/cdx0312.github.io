<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/源码解读/io/io/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/源码解读/io/io/" itemprop="url">go源码解读-io包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T09:56:01+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="io包中的接口定义"><a href="#io包中的接口定义" class="headerlink" title="io包中的接口定义"></a>io包中的接口定义</h2><ul>
<li>io包中提供了IO操作相关的一系列接口</li>
<li>io包可以理解对os包中底层操作的封装</li>
<li>由于是对底层进行封装，除非特殊提及，否则io包下的函数是线程不安全的</li>
</ul>
<h3 id="Reader接口"><a href="#Reader接口" class="headerlink" title="Reader接口"></a>Reader接口</h3><ul>
<li>Reader接口只包含一个Read方法</li>
<li>Read方法最多读取len(p)个字节到p中，返回读取到p中的字节数及过程中的错误</li>
<li>Read方法读取过程中出错，会返回已经读取到的字节数</li>
<li>Read出错的时候可以返回已经读取到的字节数和nil错误或者返回遇到的错误，而再下次调用Read方法的时候返回0, err即可</li>
<li>Read方法的调用者需要先处理n&gt;0的情况下的数据，而后考虑err的值，防止读取的数据丢失</li>
<li>Read方法不鼓励返回0，nil样式的返回值，除非len(p) == 0</li>
<li>p不能作为实现Reader接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">	Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Writer接口"><a href="#Writer接口" class="headerlink" title="Writer接口"></a>Writer接口</h3><ul>
<li>Writer接口只包含Write方法</li>
<li>Write方法完成从p中写入len(p)个字节到数据流中，返回的是写入的字节数及遇到的错误</li>
<li>Write方法如果返回的<code>n&lt;len(p)</code>，则必须返回个非空的错误</li>
<li>Write方法不允许调整p中的数据，临时调整也不可以</li>
<li>p不能作为实现Writer接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">	Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Closer接口"><a href="#Closer接口" class="headerlink" title="Closer接口"></a>Closer接口</h3><ul>
<li>Closer接口只包含Close方法</li>
<li>Closer接口返回关闭对象中遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</div><div class="line">	Close() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Seeker接口"><a href="#Seeker接口" class="headerlink" title="Seeker接口"></a>Seeker接口</h3><ul>
<li>Seeker接口只含有一个Seek方法</li>
<li>Seek方法根据whence的值计算出下一个读取或者写入的偏移量<ul>
<li>SeekStart对起始文件的偏移量</li>
<li>SeekCurrent对当前索引的偏移量</li>
<li>SeekEnd对结尾的偏移量</li>
</ul>
</li>
<li>Seek方法返回相对于起始位置的偏移量，和遇到的错误</li>
<li>实际上返回的偏移量小于文件的起始索引会产生错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	SeekStart   = <span class="number">0</span> <span class="comment">// seek relative to the origin of the file</span></div><div class="line">	SeekCurrent = <span class="number">1</span> <span class="comment">// seek relative to the current offset</span></div><div class="line">	SeekEnd     = <span class="number">2</span> <span class="comment">// seek relative to the end</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Seeker <span class="keyword">interface</span> &#123;</div><div class="line">	Seek(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>) (<span class="keyword">int64</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="组合接口"><a href="#组合接口" class="headerlink" title="组合接口"></a>组合接口</h3><ul>
<li>对于上述的接口进行组合会产生一系列新的接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReadWriter is the interface that groups the basic Read and Write methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadCloser is the interface that groups the basic Read and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteCloser is the interface that groups the basic Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> WriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteCloser is the interface that groups the basic Read, Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadSeeker is the interface that groups the basic Read and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteSeeker is the interface that groups the basic Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> WriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteSeeker is the interface that groups the basic Read, Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderFrom接口"><a href="#ReaderFrom接口" class="headerlink" title="ReaderFrom接口"></a>ReaderFrom接口</h3><ul>
<li>ReaderFrom接口只包含ReadFrom方法</li>
<li>ReadFrom方法从r中读取数据直到遇到EOF或者error</li>
<li>ReadFrom方法返回读取到的字节数和遇到的错误</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderFrom <span class="keyword">interface</span> &#123;</div><div class="line">	ReadFrom(r Reader) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteTo接口"><a href="#WriteTo接口" class="headerlink" title="WriteTo接口"></a>WriteTo接口</h3><ul>
<li>WriteTo接口只包含WriteTo方法</li>
<li>WriteTo方法向w中写入数据，直到没有数据可以写入或者遇到了错误</li>
<li>WriteTo方法返回写入的字节数和遇到的问题</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterTo <span class="keyword">interface</span> &#123;</div><div class="line">	WriteTo(w Writer) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderAt接口"><a href="#ReaderAt接口" class="headerlink" title="ReaderAt接口"></a>ReaderAt接口</h3><ul>
<li>ReaderAt接口只包含ReadAt方法</li>
<li>ReadAt方法在实现的结构体的输入流中，在偏移量offset的位置读取len(p)个字节数据导p中</li>
<li>ReadAt方法在读取到的字节小于len(p)时会返回一个非空错误来解释为什么没有读取完全，这个地方的要求比Reader接口更加严格</li>
<li>ReadAt方法在调用过程中会占据p的全部内存空间，即使读取到的n小于p的长度</li>
<li>ReadAt如果读取到的数据小于len(p),则ReadAt方法会等待更多的数据到来或者返回一个错误，这个地方要求也是比Reader更加严格</li>
<li>ReadAt如果读取完最后一个数据之后，刚好读取了len(p)个字节，则可以返回的err为nil或者EOF</li>
<li>ReadAt方法如果读取的是一个实现了Seek接口的结构体，那么ReadAt的offset和seek的offset不应该相互影响</li>
<li>读取的数据流可以支持多个ReadAt方法并发读取，也就是ReadAt是线程安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderAt <span class="keyword">interface</span> &#123;</div><div class="line">	ReadAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteAt接口"><a href="#WriteAt接口" class="headerlink" title="WriteAt接口"></a>WriteAt接口</h3><ul>
<li>WriterAt接口只包含WriteAt方法</li>
<li>WriteAt方法完成向数据流的写入，写入的起点为输入流的offset位置</li>
<li>WriteAt方法返回向数据流写入的数据和遇到的错误</li>
<li>WriteAt方法当写入的数据小于len(p)时，返回的错误不能为nil</li>
<li>WriteAt方法写入的数据流实现了Seek方法，则Seek方法的offset和WriteAt方法的offset互不影响</li>
<li>在数据流不溢出的情况下，WriteAt方法可以并发写入，是线程安全的<br>-</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterAt <span class="keyword">interface</span> &#123;</div><div class="line">	WriteAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteReader接口"><a href="#ByteReader接口" class="headerlink" title="ByteReader接口"></a>ByteReader接口</h3><ul>
<li>ByteReader接口只包含ReadByte方法</li>
<li>ReadByte方法读取一个字节，返回从input数据流中读取到的下一个字节或者遇到的错误</li>
<li>如果返回了一个错误，则input数据流没有字节被读取消费掉，并且返回的字节值为undefined</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadByte() (<span class="keyword">byte</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteScanner接口"><a href="#ByteScanner接口" class="headerlink" title="ByteScanner接口"></a>ByteScanner接口</h3><ul>
<li>ByteScanner接口封装了ByteReader接口和UnreadByte方法</li>
<li>UnreadByte方法在ReadByte方法之后调用，会重置ReadByte方法的操作</li>
<li>如果在没调用ReadByte方法时，调用UnreadByte方法会报错</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteScanner <span class="keyword">interface</span> &#123;</div><div class="line">	ByteReader</div><div class="line">	UnreadByte() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteWriter接口"><a href="#ByteWriter接口" class="headerlink" title="ByteWriter接口"></a>ByteWriter接口</h3><ul>
<li>ByteWriter接口只包含WriteByte方法</li>
<li>WriteByte方法完成对数据流的字节写入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteByte(c <span class="keyword">byte</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneReader接口"><a href="#RuneReader接口" class="headerlink" title="RuneReader接口"></a>RuneReader接口</h3><ul>
<li>RuneReader接口包含ReadRune方法</li>
<li>Readrune方法从数据流中读取一个UTF-8编码的Unicode字符，返回读取到的字符，字符的大小和遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadRune() (r <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneScanner接口"><a href="#RuneScanner接口" class="headerlink" title="RuneScanner接口"></a>RuneScanner接口</h3><ul>
<li>RuneScanner接口封装了RuneReader接口和UnreadRune方法</li>
<li>UnreadRune方法实际上是重置ReadRune方法的操作，需要在ReadRune方法之后调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneScanner <span class="keyword">interface</span> &#123;</div><div class="line">	RuneReader</div><div class="line">	UnreadRune() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="StringWriter接口"><a href="#StringWriter接口" class="headerlink" title="StringWriter接口"></a>StringWriter接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> StringWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteString(s <span class="keyword">string</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="io包中的错误定义"><a href="#io包中的错误定义" class="headerlink" title="io包中的错误定义"></a>io包中的错误定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrShortWrite = errors.New(<span class="string">"short write"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrShortBuffer = errors.New(<span class="string">"short buffer"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> EOF = errors.New(<span class="string">"EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrUnexpectedEOF = errors.New(<span class="string">"unexpected EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrNoProgress = errors.New(<span class="string">"multiple Read calls return no data or error"</span>)</div></pre></td></tr></table></figure>
<h2 id="io包中定义的结构体"><a href="#io包中定义的结构体" class="headerlink" title="io包中定义的结构体"></a>io包中定义的结构体</h2><h3 id="LimitedReader"><a href="#LimitedReader" class="headerlink" title="LimitedReader"></a>LimitedReader</h3><ul>
<li>LimitedReader读入数据到R中，限制读入的字节数为N</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> LimitedReader <span class="keyword">struct</span> &#123;</div><div class="line">	R Reader <span class="comment">// underlying reader</span></div><div class="line">	N <span class="keyword">int64</span>  <span class="comment">// max bytes remaining</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitReader</span><span class="params">(r Reader, n <span class="keyword">int64</span>)</span> <span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;LimitedReader&#123;r, n&#125; &#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LimitedReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.N &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; l.N &#123;</div><div class="line">		p = p[<span class="number">0</span>:l.N]</div><div class="line">	&#125;</div><div class="line">	n, err = l.R.Read(p)</div><div class="line">	l.N -= <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SectionReader"><a href="#SectionReader" class="headerlink" title="SectionReader"></a>SectionReader</h3><ul>
<li>SectionReader完成数据的部分读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> SectionReader <span class="keyword">struct</span> &#123;</div><div class="line">	r     ReaderAt</div><div class="line">	base  <span class="keyword">int64</span></div><div class="line">	off   <span class="keyword">int64</span></div><div class="line">	limit <span class="keyword">int64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSectionReader</span><span class="params">(r ReaderAt, off <span class="keyword">int64</span>, n <span class="keyword">int64</span>)</span> *<span class="title">SectionReader</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;SectionReader&#123;r, off, off, off + n&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.off &gt;= s.limit &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> max := s.limit - s.off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">	&#125;</div><div class="line">	n, err = s.r.ReadAt(p, s.off)</div><div class="line">	s.off += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Seeker接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errWhence</div><div class="line">	<span class="keyword">case</span> SeekStart:</div><div class="line">		offset += s.base</div><div class="line">	<span class="keyword">case</span> SeekCurrent:</div><div class="line">		offset += s.off</div><div class="line">	<span class="keyword">case</span> SeekEnd:</div><div class="line">		offset += s.limit</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> offset &lt; s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errOffset</div><div class="line">	&#125;</div><div class="line">	s.off = offset</div><div class="line">	<span class="keyword">return</span> offset - s.base, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现ReaderAt接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">ReadAt</span><span class="params">(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> || off &gt;= s.limit-s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	off += s.base</div><div class="line">	<span class="keyword">if</span> max := s.limit - off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">		n, err = s.r.ReadAt(p, off)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			err = EOF</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> n, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.r.ReadAt(p, off)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 返回section的字节尺寸</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> s.limit - s.base &#125;</div></pre></td></tr></table></figure>
<h2 id="常用工具类方法"><a href="#常用工具类方法" class="headerlink" title="常用工具类方法"></a>常用工具类方法</h2><ul>
<li>WriteString函数将字符串s写入到w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteString</span><span class="params">(w Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">		<span class="keyword">return</span> sw.WriteString(s)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> w.Write([]<span class="keyword">byte</span>(s))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadAtLeast函数从r中读取数据导buf中，同时规定了最少读取的字节数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Reader, buf []<span class="keyword">byte</span>, min <span class="keyword">int</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(buf) &lt; min &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, ErrShortBuffer</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> n &lt; min &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">var</span> nn <span class="keyword">int</span></div><div class="line">		nn, err = r.Read(buf[n:])</div><div class="line">		n += nn</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &gt;= min &#123;</div><div class="line">		err = <span class="literal">nil</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &gt; <span class="number">0</span> &amp;&amp; err == EOF &#123;</div><div class="line">		err = ErrUnexpectedEOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadFull一次性读取len(buf)个数到buf中，实际上是对ReadAtLeast的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFull</span><span class="params">(r Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ReadAtLeast(r, buf, <span class="built_in">len</span>(buf))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Copy方法完成将src的数据复制到dst中，直到遇到EOF或者错误</li>
<li>Copy成功的话会返回nil，而不是EOF</li>
<li>如果src实现了WriteTo方法，则会优先调用，否则会调用dst的ReadFrom方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyBuffer和Copy是一致的，只是增加了缓冲区</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> buf != <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(buf) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"empty buffer in io.CopyBuffer"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>copyBuffer是实际上的Copy和CopyBuffer的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">copyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 如果src实现了WriteTo接口，则调用其WroteTo方法完成写入</span></div><div class="line">	<span class="keyword">if</span> wt, ok := src.(WriterTo); ok &#123;</div><div class="line">		<span class="keyword">return</span> wt.WriteTo(dst)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 如果dst实现了ReaderFrom接口，则调用ReadFrom方法完成写入</span></div><div class="line">	<span class="keyword">if</span> rt, ok := dst.(ReaderFrom); ok &#123;</div><div class="line">		<span class="keyword">return</span> rt.ReadFrom(src)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 缓冲区大小确定</span></div><div class="line">	<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">		size := <span class="number">32</span> * <span class="number">1024</span></div><div class="line">		<span class="keyword">if</span> l, ok := src.(*LimitedReader); ok &amp;&amp; <span class="keyword">int64</span>(size) &gt; l.N &#123;</div><div class="line">			<span class="keyword">if</span> l.N &lt; <span class="number">1</span> &#123;</div><div class="line">				size = <span class="number">1</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				size = <span class="keyword">int</span>(l.N)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 读取到buf中</span></div><div class="line">		nr, er := src.Read(buf)</div><div class="line">		<span class="keyword">if</span> nr &gt; <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 写入操作</span></div><div class="line">			nw, ew := dst.Write(buf[<span class="number">0</span>:nr])</div><div class="line">			<span class="keyword">if</span> nw &gt; <span class="number">0</span> &#123;</div><div class="line">				written += <span class="keyword">int64</span>(nw)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ew != <span class="literal">nil</span> &#123;</div><div class="line">				err = ew</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> nr != nw &#123;</div><div class="line">				err = ErrShortWrite</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> er != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> er != EOF &#123;</div><div class="line">				err = er</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> written, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyN完成从src复制N个字节数据到dst</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyN</span><span class="params">(dst Writer, src Reader, n <span class="keyword">int64</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	written, err = Copy(dst, LimitReader(src, n))</div><div class="line">	<span class="keyword">if</span> written == n &#123;</div><div class="line">		<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> written &lt; n &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ioutil中的工具类"><a href="#ioutil中的工具类" class="headerlink" title="ioutil中的工具类"></a>ioutil中的工具类</h2><h3 id="ReadAll函数"><a href="#ReadAll函数" class="headerlink" title="ReadAll函数"></a>ReadAll函数</h3><ul>
<li>ReadAll函数将r中的数据读取出来并返回</li>
<li>成功读取返回的err为nil</li>
<li>readAll函数实际上是利用bytes.Buffer完成数据的读取的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> readAll(r, bytes.MinRead)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf bytes.Buffer</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		e := <span class="built_in">recover</span>()</div><div class="line">		<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</div><div class="line">			err = panicErr</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(e)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">  <span class="comment">// 防止capacity溢出</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="keyword">int</span>(capacity)) == capacity &#123;</div><div class="line">		buf.Grow(<span class="keyword">int</span>(capacity))</div><div class="line">	&#125;</div><div class="line">	_, err = buf.ReadFrom(r)</div><div class="line">	<span class="keyword">return</span> buf.Bytes(), err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadFile函数"><a href="#ReadFile函数" class="headerlink" title="ReadFile函数"></a>ReadFile函数</h3><ul>
<li>ReadFile完成对指定文件的读取并且返回其数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filename <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件</span></div><div class="line">	f, err := os.Open(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">var</span> n <span class="keyword">int64</span> = bytes.MinRead</div><div class="line"></div><div class="line">	<span class="keyword">if</span> fi, err := f.Stat(); err == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// 确定读取的size，比文件的大小稍微多一些</span></div><div class="line">		<span class="keyword">if</span> size := fi.Size() + bytes.MinRead; size &gt; n &#123;</div><div class="line">			n = size</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用readAll方法来完成数据的读取</span></div><div class="line">	<span class="keyword">return</span> readAll(f, n)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteFile函数"><a href="#WriteFile函数" class="headerlink" title="WriteFile函数"></a>WriteFile函数</h3><ul>
<li>WriteFile将数据写入到名称为filename的文件中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFile</span><span class="params">(filename <span class="keyword">string</span>, data []<span class="keyword">byte</span>, perm os.FileMode)</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件，如果不存在，则创建</span></div><div class="line">	f, err := os.OpenFile(filename, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, perm)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 数据的追加写入</span></div><div class="line">	n, err := f.Write(data)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; n &lt; <span class="built_in">len</span>(data) &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 关闭文件</span></div><div class="line">	<span class="keyword">if</span> err1 := f.Close(); err == <span class="literal">nil</span> &#123;</div><div class="line">		err = err1</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadDir函数"><a href="#ReadDir函数" class="headerlink" title="ReadDir函数"></a>ReadDir函数</h3><ul>
<li>ReadDir函数读取dirname下的文件或者路径并返回</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadDir</span><span class="params">(dirname <span class="keyword">string</span>)</span> <span class="params">([]os.FileInfo, error)</span></span> &#123;</div><div class="line">	f, err := os.Open(dirname)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	list, err := f.Readdir(<span class="number">-1</span>)</div><div class="line">	f.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	sort.Slice(list, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> list[i].Name() &lt; list[j].Name() &#125;)</div><div class="line">	<span class="keyword">return</span> list, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NopCloser"><a href="#NopCloser" class="headerlink" title="NopCloser"></a>NopCloser</h3><ul>
<li>NopCloser返回带Close方法的Reader</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NopCloser</span><span class="params">(r io.Reader)</span> <span class="title">io</span>.<span class="title">ReadCloser</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> nopCloser&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> nopCloser <span class="keyword">struct</span> &#123;</div><div class="line">	io.Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nopCloser)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="Discard"><a href="#Discard" class="headerlink" title="Discard"></a>Discard</h3><ul>
<li>Discard的写入操作都会被忽略</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Discard实际上是通过devNull来构建的</span></div><div class="line"><span class="keyword">var</span> Discard io.Writer = devNull(<span class="number">0</span>)</div><div class="line"><span class="comment">// devNull结构体本身是个int数据</span></div><div class="line"><span class="keyword">type</span> devNull <span class="keyword">int</span></div><div class="line"><span class="comment">// 实现了Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了StringWriter接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了ReaderFrom接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	bufp := blackHolePool.Get().(*[]<span class="keyword">byte</span>)</div><div class="line">	readSize := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		readSize, err = r.Read(*bufp)</div><div class="line">		n += <span class="keyword">int64</span>(readSize)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			blackHolePool.Put(bufp)</div><div class="line">			<span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">				<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> blackHolePool = sync.Pool&#123;</div><div class="line">	New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">		b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8192</span>)</div><div class="line">		<span class="keyword">return</span> &amp;b</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Pipe函数"><a href="#Pipe函数" class="headerlink" title="Pipe函数"></a>Pipe函数</h2><ul>
<li>Pipe在内存中创建了个管道，可以用于连接需要io.Reader和io.Writer的代码</li>
<li>读写会相互阻塞，除非一个写入被多次读取的场景存在</li>
<li>Pipe是并发安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pipe</span><span class="params">()</span> <span class="params">(*PipeReader, *PipeWriter)</span></span> &#123;</div><div class="line">	p := &amp;pipe&#123;</div><div class="line">		wrCh: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</div><div class="line">		rdCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>),</div><div class="line">		done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;PipeReader&#123;p&#125;, &amp;PipeWriter&#123;p&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PipeReader和PipeWriter"><a href="#PipeReader和PipeWriter" class="headerlink" title="PipeReader和PipeWriter"></a>PipeReader和PipeWriter</h3><ul>
<li>PipeReader是管道读的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeReader <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Read</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.Read(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Closer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.CloseRead(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>PipeWriter是管道写的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeWriter <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Write</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.Write(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io。Close方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.CloseWrite(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pipe结构体"><a href="#pipe结构体" class="headerlink" title="pipe结构体"></a>pipe结构体</h3><ul>
<li>实际上Pipe是对pipe的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> pipe <span class="keyword">struct</span> &#123;</div><div class="line">	wrMu sync.Mutex <span class="comment">// 保障写入的安全</span></div><div class="line">	wrCh <span class="keyword">chan</span> []<span class="keyword">byte</span> <span class="comment">// 写入的数据</span></div><div class="line">	rdCh <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 读取到的数量的byte数</span></div><div class="line"></div><div class="line">	once sync.Once <span class="comment">// 保证pipe只被关闭一次</span></div><div class="line">	done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// pipe关闭通道信息</span></div><div class="line">	rerr atomicError <span class="comment">// 读错误</span></div><div class="line">	werr atomicError <span class="comment">// 写错误</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Reader接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 判断要读取的通道是否已经关闭</span></div><div class="line">  <span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 将数据写入b中，并将写入的字节数写入rdCh通道中</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> bw := &lt;-p.wrCh:</div><div class="line">		nr := <span class="built_in">copy</span>(b, bw)</div><div class="line">		p.rdCh &lt;- nr</div><div class="line">		<span class="keyword">return</span> nr, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Writer接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Write</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 保证写入的时候安全，且pipe没有关闭</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.writeCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		p.wrMu.Lock()</div><div class="line">		<span class="keyword">defer</span> p.wrMu.Unlock()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 写入数据</span></div><div class="line">	<span class="keyword">for</span> once := <span class="literal">true</span>; once || <span class="built_in">len</span>(b) &gt; <span class="number">0</span>; once = <span class="literal">false</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> p.wrCh &lt;- b:</div><div class="line">			nw := &lt;-p.rdCh</div><div class="line">			b = b[nw:]</div><div class="line">			n += nw</div><div class="line">		<span class="keyword">case</span> &lt;-p.done:</div><div class="line">			<span class="keyword">return</span> n, p.writeCloseError()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe的Close方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseRead</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = ErrClosedPipe</div><div class="line">	&#125;</div><div class="line">	p.rerr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseWrite</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	p.werr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="multi"><a href="#multi" class="headerlink" title="multi"></a>multi</h2><h3 id="MultiReader-将多个Reader的内容写入p"><a href="#MultiReader-将多个Reader的内容写入p" class="headerlink" title="MultiReader 将多个Reader的内容写入p"></a>MultiReader 将多个Reader的内容写入p</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiReader</span><span class="params">(readers ...Reader)</span> <span class="title">Reader</span></span> &#123;</div><div class="line">	r := <span class="built_in">make</span>([]Reader, <span class="built_in">len</span>(readers))</div><div class="line">	<span class="built_in">copy</span>(r, readers)</div><div class="line">	<span class="keyword">return</span> &amp;multiReader&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiReader <span class="keyword">struct</span> &#123;</div><div class="line">	readers []Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mr *multiReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">    <span class="comment">// flat嵌套</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(mr.readers) == <span class="number">1</span> &#123;</div><div class="line">			<span class="keyword">if</span> r, ok := mr.readers[<span class="number">0</span>].(*multiReader); ok &#123;</div><div class="line">				mr.readers = r.readers</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		n, err = mr.readers[<span class="number">0</span>].Read(p)</div><div class="line">		<span class="keyword">if</span> err == EOF &#123;</div><div class="line">      <span class="comment">// 避免nl panic</span></div><div class="line">			mr.readers[<span class="number">0</span>] = eofReader&#123;&#125; <span class="comment">// permit earlier GC</span></div><div class="line">			mr.readers = mr.readers[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n &gt; <span class="number">0</span> || err != EOF &#123;</div><div class="line">			<span class="keyword">if</span> err == EOF &amp;&amp; <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// Don't return EOF yet. More readers remain.</span></div><div class="line">				err = <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 避免nil panic</span></div><div class="line"><span class="keyword">type</span> eofReader <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eofReader)</span> <span class="title">Read</span><span class="params">([]<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MultiWriter-将p的内容写入多个数据流中"><a href="#MultiWriter-将p的内容写入多个数据流中" class="headerlink" title="MultiWriter 将p的内容写入多个数据流中"></a>MultiWriter 将p的内容写入多个数据流中</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiWriter</span><span class="params">(writers ...Writer)</span> <span class="title">Writer</span></span> &#123;</div><div class="line">	allWriters := <span class="built_in">make</span>([]Writer, <span class="number">0</span>, <span class="built_in">len</span>(writers))</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> writers &#123;</div><div class="line">		<span class="keyword">if</span> mw, ok := w.(*multiWriter); ok &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, mw.writers...)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, w)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;multiWriter&#123;allWriters&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiWriter <span class="keyword">struct</span> &#123;</div><div class="line">	writers []Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		n, err = w.Write(p)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> p []<span class="keyword">byte</span> <span class="comment">// lazily initialized if/when needed</span></div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">			n, err = sw.WriteString(s)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</div><div class="line">				p = []<span class="keyword">byte</span>(s)</div><div class="line">			&#125;</div><div class="line">			n, err = w.Write(p)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(s) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/sort/sort/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/sort/sort/" itemprop="url">go源码解读-sort</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T17:38:20+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Interface接口"><a href="#Interface接口" class="headerlink" title="Interface接口"></a>Interface接口</h2><ul>
<li>实现了Interface接口的结构体，可以调用sort.Sort进行排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">  <span class="comment">// 长度获取方法</span></div><div class="line">	Len() <span class="keyword">int</span></div><div class="line">  <span class="comment">// 大小比较方法</span></div><div class="line">	Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">  <span class="comment">// 元素交换方法</span></div><div class="line">	Swap(i, j <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Sort函数"><a href="#Sort函数" class="headerlink" title="Sort函数"></a>Sort函数</h2><ul>
<li>Sort函数完成对传入的Interface类型数据data的排序</li>
<li>实际上调用的是quickSort方法来完成排序的</li>
<li>maxDepth函数返回数据的深度，用于确定排序算法是快排还是堆排列，分割值为2*ceil(lg(n+1))</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	quickSort(data, <span class="number">0</span>, n, maxDepth(n))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">maxDepth</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> depth <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> i := n; i &gt; <span class="number">0</span>; i &gt;&gt;= <span class="number">1</span> &#123;</div><div class="line">		depth++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> depth * <span class="number">2</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>quickSort函数完成Interface的排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSort</span><span class="params">(data Interface, a, b, maxDepth <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> b-a &gt; <span class="number">12</span> &#123;</div><div class="line">		<span class="keyword">if</span> maxDepth == <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 堆排序</span></div><div class="line">			heapSort(data, a, b)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		maxDepth--</div><div class="line">    <span class="comment">// 计算基准值，进行快速排序</span></div><div class="line">		mlo, mhi := doPivot(data, a, b)</div><div class="line">		<span class="keyword">if</span> mlo-a &lt; b-mhi &#123;</div><div class="line">			quickSort(data, a, mlo, maxDepth)</div><div class="line">			a = mhi <span class="comment">// i.e., quickSort(data, mhi, b)</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			quickSort(data, mhi, b, maxDepth)</div><div class="line">			b = mlo <span class="comment">// i.e., quickSort(data, a, mlo)</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 排序长度小于12时用Shell排序</span></div><div class="line">	<span class="keyword">if</span> b-a &gt; <span class="number">1</span> &#123;</div><div class="line">    <span class="comment">// Gap=6进行一次希尔排序</span></div><div class="line">		<span class="keyword">for</span> i := a + <span class="number">6</span>; i &lt; b; i++ &#123;</div><div class="line">			<span class="keyword">if</span> data.Less(i, i<span class="number">-6</span>) &#123;</div><div class="line">				data.Swap(i, i<span class="number">-6</span>)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// shell排序完之后用插入排序</span></div><div class="line">		insertionSort(data, a, b)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 插入排序</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">insertionSort</span><span class="params">(data Interface, a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := a + <span class="number">1</span>; i &lt; b; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := i; j &gt; a &amp;&amp; data.Less(j, j<span class="number">-1</span>); j-- &#123;</div><div class="line">			data.Swap(j, j<span class="number">-1</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pivot函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doPivot</span><span class="params">(data Interface, lo, hi <span class="keyword">int</span>)</span> <span class="params">(midlo, midhi <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	m := <span class="keyword">int</span>(<span class="keyword">uint</span>(lo+hi) &gt;&gt; <span class="number">1</span>) <span class="comment">// Written like this to avoid integer overflow.</span></div><div class="line">	<span class="keyword">if</span> hi-lo &gt; <span class="number">40</span> &#123;</div><div class="line">		<span class="comment">// Tukey's ``Ninther,'' median of three medians of three.</span></div><div class="line">		s := (hi - lo) / <span class="number">8</span></div><div class="line">		medianOfThree(data, lo, lo+s, lo+<span class="number">2</span>*s)</div><div class="line">		medianOfThree(data, m, m-s, m+s)</div><div class="line">		medianOfThree(data, hi<span class="number">-1</span>, hi<span class="number">-1</span>-s, hi<span class="number">-1</span><span class="number">-2</span>*s)</div><div class="line">	&#125;</div><div class="line">	medianOfThree(data, lo, m, hi<span class="number">-1</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Invariants are:</span></div><div class="line">	<span class="comment">//	data[lo] = pivot (set up by ChoosePivot)</span></div><div class="line">	<span class="comment">//	data[lo &lt; i &lt; a] &lt; pivot</span></div><div class="line">	<span class="comment">//	data[a &lt;= i &lt; b] &lt;= pivot</span></div><div class="line">	<span class="comment">//	data[b &lt;= i &lt; c] unexamined</span></div><div class="line">	<span class="comment">//	data[c &lt;= i &lt; hi-1] &gt; pivot</span></div><div class="line">	<span class="comment">//	data[hi-1] &gt;= pivot</span></div><div class="line">	pivot := lo</div><div class="line">	a, c := lo+<span class="number">1</span>, hi<span class="number">-1</span></div><div class="line"></div><div class="line">	<span class="keyword">for</span> ; a &lt; c &amp;&amp; data.Less(a, pivot); a++ &#123;</div><div class="line">	&#125;</div><div class="line">	b := a</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; !data.Less(pivot, b); b++ &#123; <span class="comment">// data[b] &lt;= pivot</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> ; b &lt; c &amp;&amp; data.Less(pivot, c<span class="number">-1</span>); c-- &#123; <span class="comment">// data[c-1] &gt; pivot</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> b &gt;= c &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// data[b] &gt; pivot; data[c-1] &lt;= pivot</span></div><div class="line">		data.Swap(b, c<span class="number">-1</span>)</div><div class="line">		b++</div><div class="line">		c--</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// If hi-c&lt;3 then there are duplicates (by property of median of nine).</span></div><div class="line">	<span class="comment">// Let's be a bit more conservative, and set border to 5.</span></div><div class="line">	protect := hi-c &lt; <span class="number">5</span></div><div class="line">	<span class="keyword">if</span> !protect &amp;&amp; hi-c &lt; (hi-lo)/<span class="number">4</span> &#123;</div><div class="line">		<span class="comment">// Lets test some points for equality to pivot</span></div><div class="line">		dups := <span class="number">0</span></div><div class="line">		<span class="keyword">if</span> !data.Less(pivot, hi<span class="number">-1</span>) &#123; <span class="comment">// data[hi-1] = pivot</span></div><div class="line">			data.Swap(c, hi<span class="number">-1</span>)</div><div class="line">			c++</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !data.Less(b<span class="number">-1</span>, pivot) &#123; <span class="comment">// data[b-1] = pivot</span></div><div class="line">			b--</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// m-lo = (hi-lo)/2 &gt; 6</span></div><div class="line">		<span class="comment">// b-lo &gt; (hi-lo)*3/4-1 &gt; 8</span></div><div class="line">		<span class="comment">// ==&gt; m &lt; b ==&gt; data[m] &lt;= pivot</span></div><div class="line">		<span class="keyword">if</span> !data.Less(m, pivot) &#123; <span class="comment">// data[m] = pivot</span></div><div class="line">			data.Swap(m, b<span class="number">-1</span>)</div><div class="line">			b--</div><div class="line">			dups++</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// if at least 2 points are equal to pivot, assume skewed distribution</span></div><div class="line">		protect = dups &gt; <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> protect &#123;</div><div class="line">		<span class="comment">// Protect against a lot of duplicates</span></div><div class="line">		<span class="comment">// Add invariant:</span></div><div class="line">		<span class="comment">//	data[a &lt;= i &lt; b] unexamined</span></div><div class="line">		<span class="comment">//	data[b &lt;= i &lt; c] = pivot</span></div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; !data.Less(b<span class="number">-1</span>, pivot); b-- &#123; <span class="comment">// data[b] == pivot</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">for</span> ; a &lt; b &amp;&amp; data.Less(a, pivot); a++ &#123; <span class="comment">// data[a] &lt; pivot</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> a &gt;= b &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// data[a] == pivot; data[b-1] &lt; pivot</span></div><div class="line">			data.Swap(a, b<span class="number">-1</span>)</div><div class="line">			a++</div><div class="line">			b--</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Swap pivot into middle</span></div><div class="line">	data.Swap(pivot, b<span class="number">-1</span>)</div><div class="line">	<span class="keyword">return</span> b - <span class="number">1</span>, c</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// medianOfThree moves the median of the three values data[m0], data[m1], data[m2] into data[m1].</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">medianOfThree</span><span class="params">(data Interface, m1, m0, m2 <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// sort 3 elements</span></div><div class="line">	<span class="keyword">if</span> data.Less(m1, m0) &#123;</div><div class="line">		data.Swap(m1, m0)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// data[m0] &lt;= data[m1]</span></div><div class="line">	<span class="keyword">if</span> data.Less(m2, m1) &#123;</div><div class="line">		data.Swap(m2, m1)</div><div class="line">		<span class="comment">// data[m0] &lt;= data[m2] &amp;&amp; data[m1] &lt; data[m2]</span></div><div class="line">		<span class="keyword">if</span> data.Less(m1, m0) &#123;</div><div class="line">			data.Swap(m1, m0)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// now data[m0] &lt;= data[m1] &lt;= data[m2]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>堆排序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">heapSort</span><span class="params">(data Interface, a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	first := a</div><div class="line">	lo := <span class="number">0</span></div><div class="line">	hi := b - a</div><div class="line"></div><div class="line">	<span class="comment">// Build heap with greatest element at top.</span></div><div class="line">	<span class="keyword">for</span> i := (hi - <span class="number">1</span>) / <span class="number">2</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		siftDown(data, i, hi, first)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Pop elements, largest first, into end of data.</span></div><div class="line">	<span class="keyword">for</span> i := hi - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		data.Swap(first, first+i)</div><div class="line">		siftDown(data, lo, i, first)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">siftDown</span><span class="params">(data Interface, lo, hi, first <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	root := lo</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		child := <span class="number">2</span>*root + <span class="number">1</span></div><div class="line">		<span class="keyword">if</span> child &gt;= hi &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> child+<span class="number">1</span> &lt; hi &amp;&amp; data.Less(first+child, first+child+<span class="number">1</span>) &#123;</div><div class="line">			child++</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !data.Less(first+root, first+child) &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		data.Swap(first+root, first+child)</div><div class="line">		root = child</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="字符串排序举例"><a href="#字符串排序举例" class="headerlink" title="字符串排序举例"></a>字符串排序举例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> p[i] &lt; p[j] &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; p[i], p[j] = p[j], p[i] &#125;</div><div class="line"></div><div class="line"><span class="comment">// Sort is a convenience method.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringSlice)</span> <span class="title">Sort</span><span class="params">()</span></span> &#123; Sort(p) &#125;</div></pre></td></tr></table></figure>
<h2 id="工具类函数"><a href="#工具类函数" class="headerlink" title="工具类函数"></a>工具类函数</h2><ul>
<li>IsSorted判断data是否是有序的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsSorted</span><span class="params">(data Interface)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	<span class="keyword">for</span> i := n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> data.Less(i, i<span class="number">-1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Reverse对data进行倒序排列</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reverse</span><span class="params">(data Interface)</span> <span class="title">Interface</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;reverse&#123;data&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> reverse <span class="keyword">struct</span> &#123;</div><div class="line">	Interface</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 重写Interface的Less方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r reverse)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.Interface.Less(j, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Stable函数在排序过程中保持相等数据的原始顺序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stable</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	stable(data, data.Len())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">stable</span><span class="params">(data Interface, n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	blockSize := <span class="number">20</span> <span class="comment">// must be &gt; 0</span></div><div class="line">	a, b := <span class="number">0</span>, blockSize</div><div class="line">	<span class="keyword">for</span> b &lt;= n &#123;</div><div class="line">		insertionSort(data, a, b)</div><div class="line">		a = b</div><div class="line">		b += blockSize</div><div class="line">	&#125;</div><div class="line">	insertionSort(data, a, n)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> blockSize &lt; n &#123;</div><div class="line">		a, b = <span class="number">0</span>, <span class="number">2</span>*blockSize</div><div class="line">		<span class="keyword">for</span> b &lt;= n &#123;</div><div class="line">			symMerge(data, a, a+blockSize, b)</div><div class="line">			a = b</div><div class="line">			b += <span class="number">2</span> * blockSize</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> m := a + blockSize; m &lt; n &#123;</div><div class="line">			symMerge(data, a, m, n)</div><div class="line">		&#125;</div><div class="line">		blockSize *= <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/strings/strings/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/strings/strings/" itemprop="url">go源码解读-strings包的工具函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T16:58:15+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="strings包中的常用函数"><a href="#strings包中的常用函数" class="headerlink" title="strings包中的常用函数"></a>strings包中的常用函数</h2><h3 id="Contains类函数"><a href="#Contains类函数" class="headerlink" title="Contains类函数"></a>Contains类函数</h3><ul>
<li>Contains函数返回字符串s中是否存在substr，具体实现的Index方法和bytes包中的实现类似，也是用了Rabin-Karp search进行字符匹配查找</li>
<li>ContainsAny函数返回字符串s中是否存在chars中任意一个字符，实现中使用ASCiiSet的方法</li>
<li>ContainsRune函数返回字符串s中是否包含字符r,通过Index方法实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Contains reports whether substr is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Contains</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Index(s, substr) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ContainsAny reports whether any Unicode code points in chars are within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexAny(s, chars) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// Avoid scanning all of s.</span></div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(s[i]) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">for</span> _, m := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> c == m &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// makeASCIISet creates a set of ASCII characters and reports whether all</span></div><div class="line"><span class="comment">// characters in chars are ASCII.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeASCIISet</span><span class="params">(chars <span class="keyword">string</span>)</span> <span class="params">(as asciiSet, ok <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(chars); i++ &#123;</div><div class="line">		c := chars[i]</div><div class="line">		<span class="keyword">if</span> c &gt;= utf8.RuneSelf &#123;</div><div class="line">			<span class="keyword">return</span> as, <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		as[c&gt;&gt;<span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(c&amp;<span class="number">31</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> as, <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ContainsRune reports whether the Unicode code point r is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsRune</span><span class="params">(s <span class="keyword">string</span>, r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexRune(s, r) &gt;= <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><ul>
<li>Fields函数将字符串按照空白字符进行切割，返回字符串数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fields</span><span class="params">(s <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	wasSpace := <span class="number">1</span></div><div class="line">	<span class="comment">// setBits is used to track which bits are set in the bytes of s.</span></div><div class="line">	setBits := <span class="keyword">uint8</span>(<span class="number">0</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		r := s[i]</div><div class="line">		setBits |= r</div><div class="line">		isSpace := <span class="keyword">int</span>(asciiSpace[r])</div><div class="line">		n += wasSpace &amp; ^isSpace</div><div class="line">		wasSpace = isSpace</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// ASCII编码的快捷返回</span></div><div class="line">	<span class="keyword">if</span> setBits &lt; utf8.RuneSelf &#123; <span class="comment">// ASCII fast path</span></div><div class="line">		a := <span class="built_in">make</span>([]<span class="keyword">string</span>, n)</div><div class="line">		na := <span class="number">0</span></div><div class="line">		fieldStart := <span class="number">0</span></div><div class="line">		i := <span class="number">0</span></div><div class="line">		<span class="comment">// Skip spaces in the front of the input.</span></div><div class="line">		<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">			i++</div><div class="line">		&#125;</div><div class="line">		fieldStart = i</div><div class="line">		<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &#123;</div><div class="line">			<span class="keyword">if</span> asciiSpace[s[i]] == <span class="number">0</span> &#123;</div><div class="line">				i++</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			a[na] = s[fieldStart:i]</div><div class="line">			na++</div><div class="line">			i++</div><div class="line">			<span class="comment">// Skip spaces in between fields.</span></div><div class="line">			<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">				i++</div><div class="line">			&#125;</div><div class="line">			fieldStart = i</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> fieldStart &lt; <span class="built_in">len</span>(s) &#123; <span class="comment">// Last field might end at EOF.</span></div><div class="line">			a[na] = s[fieldStart:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> a</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用FieldsFunc来完成字符串的分割操作</span></div><div class="line">	<span class="keyword">return</span> FieldsFunc(s, unicode.IsSpace)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FieldsFunc</span><span class="params">(s <span class="keyword">string</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>) []<span class="title">string</span></span> &#123;</div><div class="line">  <span class="comment">// 分割起点终点索引值</span></div><div class="line">	<span class="keyword">type</span> span <span class="keyword">struct</span> &#123;</div><div class="line">		start <span class="keyword">int</span></div><div class="line">		end   <span class="keyword">int</span></div><div class="line">	&#125;</div><div class="line">	spans := <span class="built_in">make</span>([]span, <span class="number">0</span>, <span class="number">32</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Find the field start and end indices.</span></div><div class="line">	wasField := <span class="literal">false</span></div><div class="line">	fromIndex := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i, <span class="keyword">rune</span> := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> f(<span class="keyword">rune</span>) &#123;</div><div class="line">			<span class="keyword">if</span> wasField &#123;</div><div class="line">				spans = <span class="built_in">append</span>(spans, span&#123;start: fromIndex, end: i&#125;)</div><div class="line">				wasField = <span class="literal">false</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> !wasField &#123;</div><div class="line">				fromIndex = i</div><div class="line">				wasField = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Last field might end at EOF.</span></div><div class="line">	<span class="keyword">if</span> wasField &#123;</div><div class="line">		spans = <span class="built_in">append</span>(spans, span&#123;fromIndex, <span class="built_in">len</span>(s)&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 返回结果值</span></div><div class="line">	a := <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="built_in">len</span>(spans))</div><div class="line">	<span class="keyword">for</span> i, span := <span class="keyword">range</span> spans &#123;</div><div class="line">		a[i] = s[span.start:span.end]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> a</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Has函数"><a href="#Has函数" class="headerlink" title="Has函数"></a>Has函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasPrefix tests whether the string s begins with prefix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, prefix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(prefix) &amp;&amp; s[<span class="number">0</span>:<span class="built_in">len</span>(prefix)] == prefix</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HasSuffix tests whether the string s ends with suffix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasSuffix</span><span class="params">(s, suffix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(suffix) &amp;&amp; s[<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix):] == suffix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Join函数"><a href="#Join函数" class="headerlink" title="Join函数"></a>Join函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Join</span><span class="params">(a []<span class="keyword">string</span>, sep <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> <span class="built_in">len</span>(a) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span></div><div class="line">	<span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> a[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 计算结果需要的内存大小</span></div><div class="line">	n := <span class="built_in">len</span>(sep) * (<span class="built_in">len</span>(a) - <span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a); i++ &#123;</div><div class="line">		n += <span class="built_in">len</span>(a[i])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 构建strings.Builder并分配内存</span></div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line">	b.Grow(n)</div><div class="line">  <span class="comment">// 将字符串数组s和sep逐个写入</span></div><div class="line">	b.WriteString(a[<span class="number">0</span>])</div><div class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> a[<span class="number">1</span>:] &#123;</div><div class="line">		b.WriteString(sep)</div><div class="line">		b.WriteString(s)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 返回结果</span></div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Last类函数"><a href="#Last类函数" class="headerlink" title="Last类函数"></a>Last类函数</h3><ul>
<li>LastIndex函数返回最后一个匹配的substr的索引值，使用了Rabin-Karp算法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndex</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(substr)</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> n == <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s)</div><div class="line">	<span class="keyword">case</span> n == <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> LastIndexByte(s, substr[<span class="number">0</span>])</div><div class="line">	<span class="keyword">case</span> n == <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">if</span> substr == s &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> n &gt; <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Rabin-Karp search from the end of the string</span></div><div class="line">	hashss, pow := hashStrRev(substr)</div><div class="line">	last := <span class="built_in">len</span>(s) - n</div><div class="line">	<span class="keyword">var</span> h <span class="keyword">uint32</span></div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= last; i-- &#123;</div><div class="line">		h = h*primeRK + <span class="keyword">uint32</span>(s[i])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> h == hashss &amp;&amp; s[last:] == substr &#123;</div><div class="line">		<span class="keyword">return</span> last</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := last - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		h *= primeRK</div><div class="line">		h += <span class="keyword">uint32</span>(s[i])</div><div class="line">		h -= pow * <span class="keyword">uint32</span>(s[i+n])</div><div class="line">		<span class="keyword">if</span> h == hashss &amp;&amp; s[i:i+n] == substr &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LastIndexAny函数返回s中找到的最后一个chars中任意一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexAny</span><span class="params">(s, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(s[i]) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s); i &gt; <span class="number">0</span>; &#123;</div><div class="line">		r, size := utf8.DecodeLastRuneInString(s[:i])</div><div class="line">		i -= size</div><div class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> r == c &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LastIndexByte返回s中匹配的最后一个字节c的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexByte</span><span class="params">(s <span class="keyword">string</span>, c <span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> s[i] == c &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Map函数"><a href="#Map函数" class="headerlink" title="Map函数"></a>Map函数</h3><ul>
<li>Map函数根据映射规则函数mapping，完成对字符串s的字符替换</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(mapping <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">rune</span>, <span class="title">s</span> <span class="title">string</span>) <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> s &#123;</div><div class="line">		r := mapping(c)</div><div class="line">		<span class="keyword">if</span> r == c &amp;&amp; c != utf8.RuneError &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">var</span> width <span class="keyword">int</span></div><div class="line">		<span class="keyword">if</span> c == utf8.RuneError &#123;</div><div class="line">			c, width = utf8.DecodeRuneInString(s[i:])</div><div class="line">			<span class="keyword">if</span> width != <span class="number">1</span> &amp;&amp; r == c &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			width = utf8.RuneLen(c)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		b.Grow(<span class="built_in">len</span>(s) + utf8.UTFMax)</div><div class="line">		b.WriteString(s[:i])</div><div class="line">		<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">			b.WriteRune(r)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		s = s[i+width:]</div><div class="line">		<span class="keyword">break</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> b.Cap() == <span class="number">0</span> &#123; <span class="comment">// didn't call b.Grow above</span></div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, c := <span class="keyword">range</span> s &#123;</div><div class="line">		r := mapping(c)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> r &lt; utf8.RuneSelf &#123;</div><div class="line">				b.WriteByte(<span class="keyword">byte</span>(r))</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				<span class="comment">// r is not a ASCII rune.</span></div><div class="line">				b.WriteRune(r)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Repeat函数"><a href="#Repeat函数" class="headerlink" title="Repeat函数"></a>Repeat函数</h3><ul>
<li>Repeat函数将字符串s复制count遍并组合到一起</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(s <span class="keyword">string</span>, count <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> count == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> count &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: negative Repeat count"</span>)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="built_in">len</span>(s)*count/count != <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: Repeat count causes overflow"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	n := <span class="built_in">len</span>(s) * count</div><div class="line">	<span class="keyword">var</span> b Builder</div><div class="line">	b.Grow(n)</div><div class="line">	b.WriteString(s)</div><div class="line">	<span class="keyword">for</span> b.Len() &lt; n &#123;</div><div class="line">		<span class="keyword">if</span> b.Len() &lt;= n/<span class="number">2</span> &#123;</div><div class="line">			b.WriteString(b.String())</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			b.WriteString(b.String()[:n-b.Len()])</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b.String()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h3><ul>
<li>Replace方法完成对字符串的替换并制定替换的个数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Replace</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> old == <span class="built_in">new</span> || n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Compute number of replacements.</span></div><div class="line">	<span class="keyword">if</span> m := Count(s, old); m == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &lt; <span class="number">0</span> || m &lt; n &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Apply replacements to buffer.</span></div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)+n*(<span class="built_in">len</span>(<span class="built_in">new</span>)-<span class="built_in">len</span>(old)))</div><div class="line">	w := <span class="number">0</span></div><div class="line">	start := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		j := start</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(old) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</div><div class="line">				_, wid := utf8.DecodeRuneInString(s[start:])</div><div class="line">				j += wid</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			j += Index(s[start:], old)</div><div class="line">		&#125;</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], s[start:j])</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], <span class="built_in">new</span>)</div><div class="line">		start = j + <span class="built_in">len</span>(old)</div><div class="line">	&#125;</div><div class="line">	w += <span class="built_in">copy</span>(t[w:], s[start:])</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(t[<span class="number">0</span>:w])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReplaceAll</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Replace(s, old, <span class="built_in">new</span>, <span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Split方法"><a href="#Split方法" class="headerlink" title="Split方法"></a>Split方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Split</span><span class="params">(s, sep <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, <span class="number">-1</span>) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfter</span><span class="params">(s, sep <span class="keyword">string</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), <span class="number">-1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfterN</span><span class="params">(s, sep <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), n)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitN</span><span class="params">(s, sep <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, n) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Split类函数实际上都是对genSplit函数的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">genSplit</span><span class="params">(s, sep <span class="keyword">string</span>, sepSave, n <span class="keyword">int</span>)</span> []<span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> sep == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> explode(s, n)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		n = Count(s, sep) + <span class="number">1</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	a := <span class="built_in">make</span>([]<span class="keyword">string</span>, n)</div><div class="line">	n--</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i &lt; n &#123;</div><div class="line">		m := Index(s, sep)</div><div class="line">		<span class="keyword">if</span> m &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		a[i] = s[:m+sepSave]</div><div class="line">		s = s[m+<span class="built_in">len</span>(sep):]</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	a[i] = s</div><div class="line">	<span class="keyword">return</span> a[:i+<span class="number">1</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Title函数"><a href="#Title函数" class="headerlink" title="Title函数"></a>Title函数</h3><ul>
<li>Title对Map进行了封装，将空白字符的下一个字符进行大写处理</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Title</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	prev := <span class="string">' '</span></div><div class="line">	<span class="keyword">return</span> Map(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">rune</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> isSeparator(prev) &#123;</div><div class="line">				prev = r</div><div class="line">				<span class="keyword">return</span> unicode.ToTitle(r)</div><div class="line">			&#125;</div><div class="line">			prev = r</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;,</div><div class="line">		s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>To类方法和Trim类方法和bytes包中的类似，没有本质区别，不再赘述</em></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/11/golang/源码解读/strings/search/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/11/golang/源码解读/strings/search/" itemprop="url">go源码解读-strings.stringFinder</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-11T16:28:51+08:00">
                2020-05-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="stringFinder"><a href="#stringFinder" class="headerlink" title="stringFinder"></a>stringFinder</h2><ul>
<li>stringFinder 结构体来完成在一个文本中查找指定的字符串</li>
<li>采用Boyer-Moore字符串查找算法，简单来说每次字符串后移的位数为坏字符规则和好后缀规则的较大值</li>
<li>参考 <a href="https://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html" target="_blank" rel="external">https://www.ruanyifeng.com/blog/2013/05/boyer-moore_string_search_algorithm.html</a></li>
<li>stringFinder包含三个参数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> stringFinder <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// 待查找的目标字符串</span></div><div class="line">	pattern <span class="keyword">string</span></div><div class="line">  <span class="comment">// 坏字符对应的偏移量，索引为对应的字节</span></div><div class="line">	badCharSkip [<span class="number">256</span>]<span class="keyword">int</span></div><div class="line">  <span class="comment">// 好字符偏移量，索引表示有几个匹配的字符</span></div><div class="line">	goodSuffixSkip []<span class="keyword">int</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="makeStringFinder函数"><a href="#makeStringFinder函数" class="headerlink" title="makeStringFinder函数"></a>makeStringFinder函数</h3><ul>
<li>完成构建badCharSkip和goodSuffixSkip的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeStringFinder</span><span class="params">(pattern <span class="keyword">string</span>)</span> *<span class="title">stringFinder</span></span> &#123;</div><div class="line">	f := &amp;stringFinder&#123;</div><div class="line">		pattern:        pattern,</div><div class="line">		goodSuffixSkip: <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(pattern)),</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// last is the index of the last character in the pattern.</span></div><div class="line">	last := <span class="built_in">len</span>(pattern) - <span class="number">1</span></div><div class="line"></div><div class="line">	<span class="comment">// Build bad character table.</span></div><div class="line">	<span class="comment">// Bytes not in the pattern can skip one pattern's length.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> f.badCharSkip &#123;</div><div class="line">		f.badCharSkip[i] = <span class="built_in">len</span>(pattern)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// The loop condition is &lt; instead of &lt;= so that the last byte does not</span></div><div class="line">	<span class="comment">// have a zero distance to itself. Finding this byte out of place implies</span></div><div class="line">	<span class="comment">// that it is not in the last position.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; last; i++ &#123;</div><div class="line">		f.badCharSkip[pattern[i]] = last - i</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Build good suffix table.</span></div><div class="line">	<span class="comment">// First pass: set each value to the next index which starts a prefix of</span></div><div class="line">	<span class="comment">// pattern.</span></div><div class="line">	lastPrefix := last</div><div class="line">	<span class="keyword">for</span> i := last; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> HasPrefix(pattern, pattern[i+<span class="number">1</span>:]) &#123;</div><div class="line">			lastPrefix = i + <span class="number">1</span></div><div class="line">		&#125;</div><div class="line">		<span class="comment">// lastPrefix is the shift, and (last-i) is len(suffix).</span></div><div class="line">		f.goodSuffixSkip[i] = lastPrefix + last - i</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Second pass: find repeats of pattern's suffix starting from the front.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; last; i++ &#123;</div><div class="line">		lenSuffix := longestCommonSuffix(pattern, pattern[<span class="number">1</span>:i+<span class="number">1</span>])</div><div class="line">		<span class="keyword">if</span> pattern[i-lenSuffix] != pattern[last-lenSuffix] &#123;</div><div class="line">			<span class="comment">// (last-i) is the shift, and lenSuffix is len(suffix).</span></div><div class="line">			f.goodSuffixSkip[last-lenSuffix] = lenSuffix + last - i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 最长相同字符的数量，从后向前</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">longestCommonSuffix</span><span class="params">(a, b <span class="keyword">string</span>)</span> <span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(a) &amp;&amp; i &lt; <span class="built_in">len</span>(b); i++ &#123;</div><div class="line">		<span class="keyword">if</span> a[<span class="built_in">len</span>(a)<span class="number">-1</span>-i] != b[<span class="built_in">len</span>(b)<span class="number">-1</span>-i] &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上移动的位数是从两个里面取最大值，next方法如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *stringFinder)</span> <span class="title">next</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	i := <span class="built_in">len</span>(f.pattern) - <span class="number">1</span></div><div class="line">	<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(text) &#123;</div><div class="line">		<span class="comment">// Compare backwards from the end until the first unmatching character.</span></div><div class="line">		j := <span class="built_in">len</span>(f.pattern) - <span class="number">1</span></div><div class="line">		<span class="keyword">for</span> j &gt;= <span class="number">0</span> &amp;&amp; text[i] == f.pattern[j] &#123;</div><div class="line">			i--</div><div class="line">			j--</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> j &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> i + <span class="number">1</span> <span class="comment">// match</span></div><div class="line">		&#125;</div><div class="line">		i += max(f.badCharSkip[text[i]], f.goodSuffixSkip[j])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">max</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> a &gt; b &#123;</div><div class="line">		<span class="keyword">return</span> a</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/strings/replace/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/strings/replace/" itemprop="url">go源码解读-strings.Compare、strings.Replace</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T11:14:43+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Compare"><a href="#Compare" class="headerlink" title="Compare"></a>Compare</h2><ul>
<li>Compare只是提供一个方法，考虑性能的时候不建议调用</li>
<li>建议使用内建操作符<code>== &gt; &lt;</code>进行字符串的比较，效率更高，性能更好</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Compare</span><span class="params">(a, b <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> a == b &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> a &lt; b &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> +<span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h2><h3 id="replacer接口"><a href="#replacer接口" class="headerlink" title="replacer接口"></a>replacer接口</h3><ul>
<li>抽象出来的所有replace方法都需要实现的接口</li>
<li>包含Replace方法和WriteString方法</li>
<li>Replace方法完成s中字符串的替换</li>
<li>WriteString方法在将s写入w中完成s字符串的替换操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> replacer <span class="keyword">interface</span> &#123;</div><div class="line">	Replace(s <span class="keyword">string</span>) <span class="keyword">string</span></div><div class="line">	WriteString(w io.Writer, s <span class="keyword">string</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Replace结构体"><a href="#Replace结构体" class="headerlink" title="Replace结构体"></a>Replace结构体</h3><ul>
<li>Replacer结构体完成字符串切片的替换,第一个字符串是旧的，第二个是匹配到替换为新的字符串</li>
<li>Replacer是线程安全的，可以用于并发编程中，通过once参数来实现</li>
<li>NewReplacer完成Replacer结构体的初始化</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Replacer <span class="keyword">struct</span> &#123;</div><div class="line">	once   sync.Once <span class="comment">// guards buildOnce method</span></div><div class="line">	r      replacer</div><div class="line">	oldnew []<span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReplacer</span><span class="params">(oldnew ...<span class="keyword">string</span>)</span> *<span class="title">Replacer</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(oldnew)%<span class="number">2</span> == <span class="number">1</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.NewReplacer: odd argument count"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Replacer&#123;oldnew: <span class="built_in">append</span>([]<span class="keyword">string</span>(<span class="literal">nil</span>), oldnew...)&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Replace本身实现了replacer接口</li>
<li>实际上的替换操作是通过其参数r来完成的</li>
<li>r.once.Do保证参数函数只被执行一次</li>
<li>buildOnce函数完成对参数r的赋值，以及参数oldNew的置空操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	r.once.Do(r.buildOnce)</div><div class="line">	<span class="keyword">return</span> r.r.Replace(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	r.once.Do(r.buildOnce)</div><div class="line">	<span class="keyword">return</span> r.r.WriteString(w, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Replacer)</span> <span class="title">buildOnce</span><span class="params">()</span></span> &#123;</div><div class="line">	r.r = r.build()</div><div class="line">	r.oldnew = <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="build方法"><a href="#build方法" class="headerlink" title="build方法"></a>build方法</h3><ul>
<li>build函数完成Replace中r的构造，根据oldnew内容的不通进行筛选<ul>
<li>如果替换的新旧字符串长度为2，且被替换的字符串的长度&gt;1，makeSingleStringReplacer完成替换</li>
<li>如果被替换的字符串不是单字节数据，则调用函数makeGenericReplacer构建通用的替换器</li>
<li>如果只是字节之间的替换，构造器为byteReplacer即可</li>
<li>如果是将单个字节替换为string字符串的情况，则byteStringReplacer可以完成替换能力</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Replacer)</span> <span class="title">build</span><span class="params">()</span> <span class="title">replacer</span></span> &#123;</div><div class="line">	oldnew := b.oldnew</div><div class="line">  <span class="comment">// 如果替换的新旧字符串长度为2，且被替换的字符串的长度&gt;1，makeSingleStringReplacer完成替换</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(oldnew) == <span class="number">2</span> &amp;&amp; <span class="built_in">len</span>(oldnew[<span class="number">0</span>]) &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> makeSingleStringReplacer(oldnew[<span class="number">0</span>], oldnew[<span class="number">1</span>])</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	allNewBytes := <span class="literal">true</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">    <span class="comment">// 如果被替换的字符串不是单字节数据，则调用函数makeGenericReplacer构建通用的替换器</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(oldnew[i]) != <span class="number">1</span> &#123;</div><div class="line">			<span class="keyword">return</span> makeGenericReplacer(oldnew)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(oldnew[i+<span class="number">1</span>]) != <span class="number">1</span> &#123;</div><div class="line">			allNewBytes = <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果只是字节之间的替换，构造器为byteReplacer即可</span></div><div class="line">	<span class="keyword">if</span> allNewBytes &#123;</div><div class="line">		r := byteReplacer&#123;&#125;</div><div class="line">		<span class="keyword">for</span> i := <span class="keyword">range</span> r &#123;</div><div class="line">			r[i] = <span class="keyword">byte</span>(i)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">for</span> i := <span class="built_in">len</span>(oldnew) - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">2</span> &#123;</div><div class="line">			o := oldnew[i][<span class="number">0</span>]</div><div class="line">			n := oldnew[i+<span class="number">1</span>][<span class="number">0</span>]</div><div class="line">			r[o] = n</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> &amp;r</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果是将单个字节替换为string字符串的情况，则byteStringReplacer可以完成替换能力</span></div><div class="line">	r := byteStringReplacer&#123;toReplace: <span class="built_in">make</span>([]<span class="keyword">string</span>, <span class="number">0</span>, <span class="built_in">len</span>(oldnew)/<span class="number">2</span>)&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(oldnew) - <span class="number">2</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">2</span> &#123;</div><div class="line">		o := oldnew[i][<span class="number">0</span>]</div><div class="line">		n := oldnew[i+<span class="number">1</span>]</div><div class="line">		<span class="keyword">if</span> r.replacements[o] == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="comment">// 这个地方用string([]byte&#123;o&#125;)是为了处理o为utf8编码的情况</span></div><div class="line">			r.toReplace = <span class="built_in">append</span>(r.toReplace, <span class="keyword">string</span>([]<span class="keyword">byte</span>&#123;o&#125;))</div><div class="line">		&#125;</div><div class="line">		r.replacements[o] = []<span class="keyword">byte</span>(n)</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="byteReplacer结构体"><a href="#byteReplacer结构体" class="headerlink" title="byteReplacer结构体"></a>byteReplacer结构体</h3><ul>
<li>byteReplacer结构体完成单个ASCII编码字节的替换</li>
<li>Replace方法利用一个256大小的字节数组来完成字节的替换工作</li>
<li>WriteString完成替换，并将替换之后的数据写入到w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> byteReplacer [<span class="number">256</span>]<span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span> <span class="comment">// 懒初始化</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r[b] != b &#123;</div><div class="line">			<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">				buf = []<span class="keyword">byte</span>(s)</div><div class="line">			&#125;</div><div class="line">			buf[i] = r[b]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// TODO(bradfitz): use io.WriteString with slices of s, avoiding allocation.</span></div><div class="line">	bufsize := <span class="number">32</span> &lt;&lt; <span class="number">10</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; bufsize &#123;</div><div class="line">		bufsize = <span class="built_in">len</span>(s)</div><div class="line">	&#125;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, bufsize)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</div><div class="line">		ncopy := <span class="built_in">copy</span>(buf, s)</div><div class="line">		s = s[ncopy:]</div><div class="line">    <span class="comment">// 替换操作</span></div><div class="line">		<span class="keyword">for</span> i, b := <span class="keyword">range</span> buf[:ncopy] &#123;</div><div class="line">			buf[i] = r[b]</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 写入操作</span></div><div class="line">		wn, err := w.Write(buf[:ncopy])</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="singleStringReplacer结构体"><a href="#singleStringReplacer结构体" class="headerlink" title="singleStringReplacer结构体"></a>singleStringReplacer结构体</h3><ul>
<li>singleStringReplacer结构体包含两个参数<ul>
<li>finder结构体用于进行字符串的查找</li>
<li>value是查找到的字符串替换为的值</li>
</ul>
</li>
<li>makeSingleStringReplacer完成singleStringReplacer的构建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> singleStringReplacer <span class="keyword">struct</span> &#123;</div><div class="line">	finder *stringFinder</div><div class="line">	<span class="comment">// value is the new string that replaces that pattern when it's found.</span></div><div class="line">	value <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSingleStringReplacer</span><span class="params">(pattern <span class="keyword">string</span>, value <span class="keyword">string</span>)</span> *<span class="title">singleStringReplacer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;singleStringReplacer&#123;finder: makeStringFinder(pattern), value: value&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Replace方法完成字符串的匹配替换</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *singleStringReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf []<span class="keyword">byte</span></div><div class="line">	i, matched := <span class="number">0</span>, <span class="literal">false</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 返回匹配到的起始位置</span></div><div class="line">		match := r.finder.next(s[i:])</div><div class="line">		<span class="keyword">if</span> match == <span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		matched = <span class="literal">true</span></div><div class="line">    <span class="comment">// 写入buf</span></div><div class="line">		buf = <span class="built_in">append</span>(buf, s[i:i+match]...)</div><div class="line">		buf = <span class="built_in">append</span>(buf, r.value...)</div><div class="line">		i += match + <span class="built_in">len</span>(r.finder.pattern)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !matched &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	buf = <span class="built_in">append</span>(buf, s[i:]...)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteString将匹配之后的结果写入w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *singleStringReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	<span class="keyword">var</span> i, wn <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		match := r.finder.next(s[i:])</div><div class="line">		<span class="keyword">if</span> match == <span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		wn, err = sw.WriteString(s[i : i+match])</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		wn, err = sw.WriteString(r.value)</div><div class="line">		n += wn</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		i += match + <span class="built_in">len</span>(r.finder.pattern)</div><div class="line">	&#125;</div><div class="line">	wn, err = sw.WriteString(s[i:])</div><div class="line">	n += wn</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStringWriter</span><span class="params">(w io.Writer)</span> <span class="title">io</span>.<span class="title">StringWriter</span></span> &#123;</div><div class="line">	sw, ok := w.(io.StringWriter)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		sw = stringWriter&#123;w&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> sw</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// stringWriter实现了io.Writer接口</span></div><div class="line"><span class="keyword">type</span> stringWriter <span class="keyword">struct</span> &#123;</div><div class="line">	w io.Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w stringWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.w.Write([]<span class="keyword">byte</span>(s))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="byteStringReplacer-结构体"><a href="#byteStringReplacer-结构体" class="headerlink" title="byteStringReplacer 结构体"></a>byteStringReplacer 结构体</h3><ul>
<li>byteStringReplacer完成字节替换成字符串的操作的结构体<ul>
<li>replacements记录字符和字符串之间的替换映射关系</li>
<li>toReplace记录待替换的字符数组，以[]string格式记录</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> byteStringReplacer <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// 替换规则</span></div><div class="line">	replacements [<span class="number">256</span>][]<span class="keyword">byte</span></div><div class="line">  <span class="comment">// 待替换的字符串数组，实际上记录的是单个字符的字符串数组</span></div><div class="line">	toReplace []<span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> countCutOff = <span class="number">8</span></div></pre></td></tr></table></figure>
<ul>
<li>Replace方法替换中会根据字符串的长度采用效率更高的方法来确认替换后的字符串需要的空间</li>
<li>然后遍历完成替换操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteStringReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	newSize := <span class="built_in">len</span>(s)</div><div class="line">	anyChanges := <span class="literal">false</span></div><div class="line">	<span class="comment">// Is it faster to use Count?</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(r.toReplace)*countCutOff &lt;= <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="keyword">for</span> _, x := <span class="keyword">range</span> r.toReplace &#123;</div><div class="line">			<span class="keyword">if</span> c := Count(s, x); c != <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// The -1 is because we are replacing 1 byte with len(replacements[b]) bytes.</span></div><div class="line">				newSize += c * (<span class="built_in">len</span>(r.replacements[x[<span class="number">0</span>]]) - <span class="number">1</span>)</div><div class="line">				anyChanges = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">			b := s[i]</div><div class="line">			<span class="keyword">if</span> r.replacements[b] != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="comment">// See above for explanation of -1</span></div><div class="line">				newSize += <span class="built_in">len</span>(r.replacements[b]) - <span class="number">1</span></div><div class="line">				anyChanges = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !anyChanges &#123;</div><div class="line">		<span class="keyword">return</span> s</div><div class="line">	&#125;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, newSize)</div><div class="line">	j := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r.replacements[b] != <span class="literal">nil</span> &#123;</div><div class="line">			j += <span class="built_in">copy</span>(buf[j:], r.replacements[b])</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			buf[j] = b</div><div class="line">			j++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteString则直接进行循环替换并写入w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *byteStringReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	last := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		b := s[i]</div><div class="line">		<span class="keyword">if</span> r.replacements[b] == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> last != i &#123;</div><div class="line">			nw, err := sw.WriteString(s[last:i])</div><div class="line">			n += nw</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> n, err</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		last = i + <span class="number">1</span></div><div class="line">		nw, err := w.Write(r.replacements[b])</div><div class="line">		n += nw</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> last != <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="keyword">var</span> nw <span class="keyword">int</span></div><div class="line">		nw, err = sw.WriteString(s[last:])</div><div class="line">		n += nw</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="genericReplacer结构体"><a href="#genericReplacer结构体" class="headerlink" title="genericReplacer结构体"></a>genericReplacer结构体</h3><ul>
<li>genericReplacer实际上是完整的通用算法，其余的各种分支是效率更高的快捷替换方法</li>
<li>genericReplacer包含三个参数<ul>
<li>root节点，，类型时trieNode，Trie树的根节点</li>
<li>tableSize int类型 trie树的查找表大小</li>
<li>mapping 完成字节到trie树索引的映射</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> genericReplacer <span class="keyword">struct</span> &#123;</div><div class="line">	root trieNode</div><div class="line">	<span class="comment">// tableSize is the size of a trie node's lookup table. It is the number</span></div><div class="line">	<span class="comment">// of unique key bytes.</span></div><div class="line">	tableSize <span class="keyword">int</span></div><div class="line">	<span class="comment">// mapping maps from key bytes to a dense index for trieNode.table.</span></div><div class="line">	mapping [<span class="number">256</span>]<span class="keyword">byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="trieNode结构体"><a href="#trieNode结构体" class="headerlink" title="trieNode结构体"></a>trieNode结构体</h4><ul>
<li>trieNode是trie树的一个节点，含有5个参数<ul>
<li>value为节点key/value对中的值，如果当前节点不是一个完整的key的话，value为空</li>
<li>priority 优先值，当前节点为完整路径时大于0，否则优先级为0</li>
<li>prefix,next，如果这两个非空，则当前节点有一个子节点</li>
<li>table，如果table非空，则其中记录了所有的子节点</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> trieNode <span class="keyword">struct</span> &#123;</div><div class="line">	value <span class="keyword">string</span></div><div class="line">	priority <span class="keyword">int</span></div><div class="line">	prefix <span class="keyword">string</span></div><div class="line">	next   *trieNode</div><div class="line">	table []*trieNode</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>trieNode的add方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *trieNode)</span> <span class="title">add</span><span class="params">(key, val <span class="keyword">string</span>, priority <span class="keyword">int</span>, r *genericReplacer)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> key == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">if</span> t.priority == <span class="number">0</span> &#123;</div><div class="line">			t.value = val</div><div class="line">			t.priority = priority</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> t.prefix != <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// n记录key和t.prefix的最大相同的前缀，也就是n之前是匹配的，n之后是不匹配的</span></div><div class="line">		<span class="keyword">var</span> n <span class="keyword">int</span></div><div class="line">		<span class="keyword">for</span> ; n &lt; <span class="built_in">len</span>(t.prefix) &amp;&amp; n &lt; <span class="built_in">len</span>(key); n++ &#123;</div><div class="line">			<span class="keyword">if</span> t.prefix[n] != key[n] &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n == <span class="built_in">len</span>(t.prefix) &#123;</div><div class="line">      <span class="comment">// 如果n和t.prefix的长度相等，也就是说key之后的部分都是没有的索引值</span></div><div class="line">			t.next.add(key[n:], val, priority, r)</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 首字母就不同，这时候需要在root节点创建个新的查找表</span></div><div class="line">			<span class="keyword">var</span> prefixNode *trieNode</div><div class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(t.prefix) == <span class="number">1</span> &#123;</div><div class="line">				prefixNode = t.next</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				prefixNode = &amp;trieNode&#123;</div><div class="line">					prefix: t.prefix[<span class="number">1</span>:],</div><div class="line">					next:   t.next,</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			keyNode := <span class="built_in">new</span>(trieNode)</div><div class="line">			t.table = <span class="built_in">make</span>([]*trieNode, r.tableSize)</div><div class="line">			t.table[r.mapping[t.prefix[<span class="number">0</span>]]] = prefixNode</div><div class="line">			t.table[r.mapping[key[<span class="number">0</span>]]] = keyNode</div><div class="line">			t.prefix = <span class="string">""</span></div><div class="line">			t.next = <span class="literal">nil</span></div><div class="line">			keyNode.add(key[<span class="number">1</span>:], val, priority, r)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="comment">// 插入节点数据</span></div><div class="line">			next := &amp;trieNode&#123;</div><div class="line">				prefix: t.prefix[n:],</div><div class="line">				next:   t.next,</div><div class="line">			&#125;</div><div class="line">			t.prefix = t.prefix[:n]</div><div class="line">			t.next = next</div><div class="line">			next.add(key[n:], val, priority, r)</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> t.table != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// 插入已经存在table列表中心的节点</span></div><div class="line">		m := r.mapping[key[<span class="number">0</span>]]</div><div class="line">		<span class="keyword">if</span> t.table[m] == <span class="literal">nil</span> &#123;</div><div class="line">			t.table[m] = <span class="built_in">new</span>(trieNode)</div><div class="line">		&#125;</div><div class="line">		t.table[m].add(key[<span class="number">1</span>:], val, priority, r)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 创建根节点</span></div><div class="line">		t.prefix = key</div><div class="line">		t.next = <span class="built_in">new</span>(trieNode)</div><div class="line">		t.next.add(<span class="string">""</span>, val, priority, r)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Replace方法"><a href="#Replace方法" class="headerlink" title="Replace方法"></a>Replace方法</h4><ul>
<li>Replace方法实际上是对WriteString方法的调用，将s替换之后的结果写入到buf中</li>
<li>buf实际上是对io.Writer接口的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">Replace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>(appendSliceWriter, <span class="number">0</span>, <span class="built_in">len</span>(s))</div><div class="line">	r.WriteString(&amp;buf, s)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(buf)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> appendSliceWriter []<span class="keyword">byte</span></div><div class="line"></div><div class="line"><span class="comment">// Write writes to the buffer to satisfy io.Writer.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *appendSliceWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	*w = <span class="built_in">append</span>(*w, p...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteString writes to the buffer without string-&gt;[]byte-&gt;string allocations.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *appendSliceWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	*w = <span class="built_in">append</span>(*w, s...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="WriteString方法"><a href="#WriteString方法" class="headerlink" title="WriteString方法"></a>WriteString方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">WriteString</span><span class="params">(w io.Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	sw := getStringWriter(w)</div><div class="line">	<span class="keyword">var</span> last, wn <span class="keyword">int</span></div><div class="line">	<span class="keyword">var</span> prevMatchEmpty <span class="keyword">bool</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="built_in">len</span>(s); &#123;</div><div class="line">		<span class="keyword">if</span> i != <span class="built_in">len</span>(s) &amp;&amp; r.root.priority == <span class="number">0</span> &#123;</div><div class="line">			index := <span class="keyword">int</span>(r.mapping[s[i]])</div><div class="line">			<span class="keyword">if</span> index == r.tableSize || r.root.table[index] == <span class="literal">nil</span> &#123;</div><div class="line">				i++</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		val, keylen, match := r.lookup(s[i:], prevMatchEmpty)</div><div class="line">		prevMatchEmpty = match &amp;&amp; keylen == <span class="number">0</span></div><div class="line">		<span class="keyword">if</span> match &#123;</div><div class="line">			wn, err = sw.WriteString(s[last:i])</div><div class="line">			n += wn</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			wn, err = sw.WriteString(val)</div><div class="line">			n += wn</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			i += keylen</div><div class="line">			last = i</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> last != <span class="built_in">len</span>(s) &#123;</div><div class="line">		wn, err = sw.WriteString(s[last:])</div><div class="line">		n += wn</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 查找方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *genericReplacer)</span> <span class="title">lookup</span><span class="params">(s <span class="keyword">string</span>, ignoreRoot <span class="keyword">bool</span>)</span> <span class="params">(val <span class="keyword">string</span>, keylen <span class="keyword">int</span>, found <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	bestPriority := <span class="number">0</span></div><div class="line">	node := &amp;r.root</div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> node != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">if</span> node.priority &gt; bestPriority &amp;&amp; !(ignoreRoot &amp;&amp; node == &amp;r.root) &#123;</div><div class="line">			bestPriority = node.priority</div><div class="line">			val = node.value</div><div class="line">			keylen = n</div><div class="line">			found = <span class="literal">true</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">if</span> s == <span class="string">""</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> node.table != <span class="literal">nil</span> &#123;</div><div class="line">			index := r.mapping[s[<span class="number">0</span>]]</div><div class="line">			<span class="keyword">if</span> <span class="keyword">int</span>(index) == r.tableSize &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			node = node.table[index]</div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">			n++</div><div class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> node.prefix != <span class="string">""</span> &amp;&amp; HasPrefix(s, node.prefix) &#123;</div><div class="line">			n += <span class="built_in">len</span>(node.prefix)</div><div class="line">			s = s[<span class="built_in">len</span>(node.prefix):]</div><div class="line">			node = node.next</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 创建通用的替换器，实际上是完成trie树的构建</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeGenericReplacer</span><span class="params">(oldnew []<span class="keyword">string</span>)</span> *<span class="title">genericReplacer</span></span> &#123;</div><div class="line">	r := <span class="built_in">new</span>(genericReplacer)</div><div class="line">	<span class="comment">// Find each byte used, then assign them each an index.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">		key := oldnew[i]</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt; <span class="built_in">len</span>(key); j++ &#123;</div><div class="line">			r.mapping[key[j]] = <span class="number">1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> _, b := <span class="keyword">range</span> r.mapping &#123;</div><div class="line">		r.tableSize += <span class="keyword">int</span>(b)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> index <span class="keyword">byte</span></div><div class="line">	<span class="keyword">for</span> i, b := <span class="keyword">range</span> r.mapping &#123;</div><div class="line">		<span class="keyword">if</span> b == <span class="number">0</span> &#123;</div><div class="line">			r.mapping[i] = <span class="keyword">byte</span>(r.tableSize)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r.mapping[i] = index</div><div class="line">			index++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Ensure root node uses a lookup table (for performance).</span></div><div class="line">	r.root.table = <span class="built_in">make</span>([]*trieNode, r.tableSize)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(oldnew); i += <span class="number">2</span> &#123;</div><div class="line">		r.root.add(oldnew[i], oldnew[i+<span class="number">1</span>], <span class="built_in">len</span>(oldnew)-i, r)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/strings/reader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/strings/reader/" itemprop="url">go源码解读-strings.Reader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T10:32:25+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Reader"><a href="#Reader" class="headerlink" title="Reader"></a>Reader</h2><h3 id="strings-Reader结构体"><a href="#strings-Reader结构体" class="headerlink" title="strings.Reader结构体"></a>strings.Reader结构体</h3><ul>
<li>Reader结构体包三个参数<ul>
<li>s,带读取的字符串</li>
<li>i,当前读取到的字符索引值</li>
<li>prevRune上一个读取到的字符索引值</li>
<li>Reader结构体的零值和从空字符串读取创建Reader是等价的</li>
<li>Reader结构体实现了io.Reader, io.ReaderAt, io.Seeker, io.WriterTo,io.ByteScanner, and io.RuneScanner等接口</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">struct</span> &#123;</div><div class="line">	s        <span class="keyword">string</span></div><div class="line">	i        <span class="keyword">int64</span> <span class="comment">// current reading index</span></div><div class="line">	prevRune <span class="keyword">int</span>   <span class="comment">// index of previous rune; or &lt; 0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 结构体初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReader</span><span class="params">(s <span class="keyword">string</span>)</span> *<span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;Reader&#123;s, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>
<h3 id="结构体的方法"><a href="#结构体的方法" class="headerlink" title="结构体的方法"></a>结构体的方法</h3><ul>
<li>Len方法返回字符串s未读取部分的字节数</li>
<li>Size方法返回字符串s的字节数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">int</span>(<span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) - r.i)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Read方法，从字符串s中读取数据到b中，读取到字节数为len(b)和len(s[s.r:])之间的较小值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadAt方法读取s[off:]之后的字节切片到字符串到b中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadAt</span><span class="params">(b []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="comment">// cannot modify state - see io.ReaderAt</span></div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.ReadAt: negative offset"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> off &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	n = <span class="built_in">copy</span>(b, r.s[off:])</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="built_in">len</span>(b) &#123;</div><div class="line">		err = io.EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadByte方法从s中读取i指向的字节</li>
<li>UnreadByte方法将reader的索引值i–，还原读取一个字节之前的状态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadByte</span><span class="params">()</span> <span class="params">(<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	b := r.s[r.i]</div><div class="line">	r.i++</div><div class="line">	<span class="keyword">return</span> b, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadByte</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadByte: at beginning of string"</span>)</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	r.i--</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadRune方法从s中读取i指向的字符</li>
<li>UnreadRune方法完成对ReadRune方法的重置</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">ReadRune</span><span class="params">()</span> <span class="params">(ch <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		r.prevRune = <span class="number">-1</span></div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	r.prevRune = <span class="keyword">int</span>(r.i)</div><div class="line">	<span class="keyword">if</span> c := r.s[r.i]; c &lt; utf8.RuneSelf &#123;</div><div class="line">		r.i++</div><div class="line">		<span class="keyword">return</span> <span class="keyword">rune</span>(c), <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	ch, size = utf8.DecodeRuneInString(r.s[r.i:])</div><div class="line">	r.i += <span class="keyword">int64</span>(size)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.i &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadRune: at beginning of string"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r.prevRune &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"strings.Reader.UnreadRune: previous operation was not ReadRune"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = <span class="keyword">int64</span>(r.prevRune)</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Seek方法根据whence设定下一个读取的字符的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">var</span> abs <span class="keyword">int64</span></div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">case</span> io.SeekStart:</div><div class="line">		abs = offset</div><div class="line">	<span class="keyword">case</span> io.SeekCurrent:</div><div class="line">		abs = r.i + offset</div><div class="line">	<span class="keyword">case</span> io.SeekEnd:</div><div class="line">		abs = <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) + offset</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.Seek: invalid whence"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> abs &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"strings.Reader.Seek: negative position"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i = abs</div><div class="line">	<span class="keyword">return</span> abs, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriterTo方法将w中的数据写入到reader中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">WriteTo</span><span class="params">(w io.Writer)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	r.prevRune = <span class="number">-1</span></div><div class="line">	<span class="keyword">if</span> r.i &gt;= <span class="keyword">int64</span>(<span class="built_in">len</span>(r.s)) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	s := r.s[r.i:]</div><div class="line">	m, err := io.WriteString(w, s)</div><div class="line">	<span class="keyword">if</span> m &gt; <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.Reader.WriteTo: invalid WriteString count"</span>)</div><div class="line">	&#125;</div><div class="line">	r.i += <span class="keyword">int64</span>(m)</div><div class="line">	n = <span class="keyword">int64</span>(m)</div><div class="line">	<span class="keyword">if</span> m != <span class="built_in">len</span>(s) &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Reset方法完成Reader的重置操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Reader)</span> <span class="title">Reset</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123; *r = Reader&#123;s, <span class="number">0</span>, <span class="number">-1</span>&#125; &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/09/golang/源码解读/errors/errors/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/09/golang/源码解读/errors/errors/" itemprop="url">go源码解读-errors包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-09T10:12:58+08:00">
                2020-05-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="errors"><a href="#errors" class="headerlink" title="errors"></a>errors</h2><ul>
<li>go语言的errors包比较简单，实际上就是基于内建函数的实现</li>
<li>内建接口error，该接口只含有一个Error方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</div><div class="line">	Error() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上可以根据需要实现error接口来封装自己的error</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// MyError is an error implementation that includes a time and message.</span></div><div class="line"><span class="keyword">type</span> MyError <span class="keyword">struct</span> &#123;</div><div class="line">	When time.Time</div><div class="line">	What <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e MyError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v: %v"</span>, e.When, e.What)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>errors包中的实现也只是对一个内部结构体errorString的简单封装</li>
<li>包含初始化函数和Error方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns an error that formats as the given text.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;errorString&#123;text&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// errorString is a trivial implementation of error.</span></div><div class="line"><span class="keyword">type</span> errorString <span class="keyword">struct</span> &#123;</div><div class="line">	s <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errorString)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> e.s</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/08/golang/源码解读/bytes/bytes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/08/golang/源码解读/bytes/bytes/" itemprop="url">go源码解读-bytes包常用函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-08T11:43:01+08:00">
                2020-05-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bytes包常用函数"><a href="#bytes包常用函数" class="headerlink" title="bytes包常用函数"></a>bytes包常用函数</h2><ul>
<li>bytes.go中提供了很多字节切片的工具类</li>
</ul>
<h3 id="Compare"><a href="#Compare" class="headerlink" title="Compare"></a>Compare</h3><ul>
<li>Compare方法比较两个字节切片的大小，-1，0， 1</li>
<li>nil和空切片是相等的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Compare</span><span class="params">(a, b []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> bytealg.Compare(a, b)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Contains"><a href="#Contains" class="headerlink" title="Contains"></a>Contains</h3><ul>
<li>Contains方法返回b中是否存在子切片subslice</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Contains</span><span class="params">(b, subslice []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Index(b, subslice) != <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Contains函数主题为函数Index</li>
<li>Index函数返回sep在s中找到的第一个实例的索引值，比如s为{1,2,3,1,2,3}， sep为{2,3}，则Index函数返回1，如果没有匹配到，则返回-1</li>
<li>Index方法中，根据sep的长度做了一些优化，为0直接返回0，意思是index为0</li>
<li>sep长度为1时，利用IndexByte函数找一个字节是否在切片中出现过</li>
<li>sep的长度和s的长度相等时，利用Equal方法判断两个切片是否相等</li>
<li>sep长度小于MaxLen时，这个值根据操作系统在32或者64，<ul>
<li>s的长度小于64时，直接用bytealg.Index函数进行暴力查找即可</li>
<li>是的长度大于64时，先找到匹配sep第一个字符的索引值，然后判断第二个字符是否相等，相等则直接用Equal方法判断两个截取的切片是否相等。如果第二个字符不相等，则失败次数+1，同时比较失败次数和Cutover函数的返回值，如果错误次数过多，此时会直接进行暴力查找</li>
</ul>
</li>
<li>sep的长度大于MaxLen时，前半部分和之前阐述的类似，不通的在于对失败错误的容忍度。<ul>
<li>Cutover函数允许每8个字节出错一次，实验证明其切换间隔为16个字节时效率更高，此时采用RabinKarp算法进行查找</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(sep)</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> n == <span class="number">0</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	<span class="keyword">case</span> n == <span class="number">1</span>:</div><div class="line">		<span class="keyword">return</span> IndexByte(s, sep[<span class="number">0</span>])</div><div class="line">	<span class="keyword">case</span> n == <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">if</span> Equal(sep, s) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> n &gt; <span class="built_in">len</span>(s):</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> n &lt;= bytealg.MaxLen:</div><div class="line">		<span class="comment">// Use brute force when s and sep both are small</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt;= bytealg.MaxBruteForce &#123;</div><div class="line">			<span class="keyword">return</span> bytealg.Index(s, sep)</div><div class="line">		&#125;</div><div class="line">		c0 := sep[<span class="number">0</span>]</div><div class="line">		c1 := sep[<span class="number">1</span>]</div><div class="line">		i := <span class="number">0</span></div><div class="line">		t := <span class="built_in">len</span>(s) - n + <span class="number">1</span></div><div class="line">		fails := <span class="number">0</span></div><div class="line">		<span class="keyword">for</span> i &lt; t &#123;</div><div class="line">			<span class="keyword">if</span> s[i] != c0 &#123;</div><div class="line">				<span class="comment">// IndexByte is faster than bytealg.Index, so use it as long as</span></div><div class="line">				<span class="comment">// we're not getting lots of false positives.</span></div><div class="line">				o := IndexByte(s[i:t], c0)</div><div class="line">				<span class="keyword">if</span> o &lt; <span class="number">0</span> &#123;</div><div class="line">					<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">				&#125;</div><div class="line">				i += o</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> s[i+<span class="number">1</span>] == c1 &amp;&amp; Equal(s[i:i+n], sep) &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">			fails++</div><div class="line">			i++</div><div class="line">			<span class="comment">// Switch to bytealg.Index when IndexByte produces too many false positives.</span></div><div class="line">			<span class="keyword">if</span> fails &gt; bytealg.Cutover(i) &#123;</div><div class="line">				r := bytealg.Index(s[i:], sep)</div><div class="line">				<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">					<span class="keyword">return</span> r + i</div><div class="line">				&#125;</div><div class="line">				<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	c0 := sep[<span class="number">0</span>]</div><div class="line">	c1 := sep[<span class="number">1</span>]</div><div class="line">	i := <span class="number">0</span></div><div class="line">	fails := <span class="number">0</span></div><div class="line">	t := <span class="built_in">len</span>(s) - n + <span class="number">1</span></div><div class="line">	<span class="keyword">for</span> i &lt; t &#123;</div><div class="line">		<span class="keyword">if</span> s[i] != c0 &#123;</div><div class="line">			o := IndexByte(s[i:t], c0)</div><div class="line">			<span class="keyword">if</span> o &lt; <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			i += o</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> s[i+<span class="number">1</span>] == c1 &amp;&amp; Equal(s[i:i+n], sep) &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">		i++</div><div class="line">		fails++</div><div class="line">		<span class="keyword">if</span> fails &gt;= <span class="number">4</span>+i&gt;&gt;<span class="number">4</span> &amp;&amp; i &lt; t &#123;</div><div class="line">			j := indexRabinKarp(s[i:], sep)</div><div class="line">			<span class="keyword">if</span> j &lt; <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> i + j</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexByte</span><span class="params">(b []<span class="keyword">byte</span>, c <span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> bytealg.IndexByte(b, c)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Equal</span><span class="params">(a, b []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> bytealg.Equal(a, b)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cutover</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="comment">// 1 error per 8 characters, plus a few slop to start.</span></div><div class="line">	<span class="keyword">return</span> (n + <span class="number">16</span>) / <span class="number">8</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>RabinKarp算法实现，假定sep为{a,b}，s为{d,c,a,b}<ul>
<li>RabinKarp算法首先选取一个基准值，primeRK=16777619，这个</li>
<li>然后用函数hashStr对sep进行hash运算，返回的结果包括两个<ul>
<li>第一个hash，表示的是对子串的计算值，其值可以理解为primeRK进制下该字节数组的值，则hash=97*primeRK+b</li>
<li>第二个pow，返回的是和sep长度相关的值，由于pow的值为uint32，则实际上是个取余之后的值，RK^(len（sep-1) % 2^32，其目的是为了在s上找sep滑动时，去除掉最高位的hash值</li>
</ul>
</li>
<li>在s的最左边开始计算和sep长度相等的hash值为d*RK+c，如果匹配则直接返回索引0</li>
<li>如果不匹配，则在s上进行长度为len(sep)的滑动，此时hash为<code>d*Rk*Rk + c * RK + a - d * pow</code></li>
<li>而实际上<code>pow = RK*RK</code>的，则hash值为<code>c*RK + a</code>,此时不符合继续滑动</li>
<li>滑动之后hash值为<code>a*RK + b</code>，此时返回索引2</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexRabinKarp</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="comment">// Rabin-Karp search</span></div><div class="line">	hashsep, pow := hashStr(sep)</div><div class="line">	n := <span class="built_in">len</span>(sep)</div><div class="line">	<span class="keyword">var</span> h <span class="keyword">uint32</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		h = h*primeRK + <span class="keyword">uint32</span>(s[i])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> h == hashsep &amp;&amp; Equal(s[:n], sep) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := n; i &lt; <span class="built_in">len</span>(s); &#123;</div><div class="line">		h *= primeRK</div><div class="line">		h += <span class="keyword">uint32</span>(s[i])</div><div class="line">		h -= pow * <span class="keyword">uint32</span>(s[i-n])</div><div class="line">		i++</div><div class="line">		<span class="keyword">if</span> h == hashsep &amp;&amp; Equal(s[i-n:i], sep) &#123;</div><div class="line">			<span class="keyword">return</span> i - n</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 基准值</span></div><div class="line"><span class="keyword">const</span> primeRK = <span class="number">16777619</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashStr</span><span class="params">(sep []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">uint32</span>, <span class="keyword">uint32</span>)</span></span> &#123;</div><div class="line">	hash := <span class="keyword">uint32</span>(<span class="number">0</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(sep); i++ &#123;</div><div class="line">		hash = hash*primeRK + <span class="keyword">uint32</span>(sep[i])</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> pow, sq <span class="keyword">uint32</span> = <span class="number">1</span>, primeRK</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(sep); i &gt; <span class="number">0</span>; i &gt;&gt;= <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">if</span> i&amp;<span class="number">1</span> != <span class="number">0</span> &#123;</div><div class="line">			pow *= sq</div><div class="line">		&#125;</div><div class="line">		sq *= sq</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> hash, pow</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ContainsAny方法只要chars中任意一个utf-8编码的字符存在于字节切片中，返回true<ul>
<li>IndexAny实际上为ContainsAny的主要函数</li>
<li>如果s字节数组大于8并且是ASCII编码的，则用函数makeASCIISet构建ASCII集合<ul>
<li>makeASCIISet返回的数据asciiSet为一个32字节的数据，从前向后每一个bit位的索引代表对应的ASCII的值，实际上32字节的数据是分为8个uint32的数字来表示的，这样如字符a的位置为第四个元素的倒数第二个bit位</li>
<li>从而对s进行迭代，看其中的byte是否存asciiSet中，asciiSet提供了contain方法来校验其对应的bit位上是否存在该字符</li>
<li>bitmap可以最大限度的节省内存空间，但是代码会复杂一些，实际工作中自己做取舍</li>
</ul>
</li>
<li>否则对切片s进行rune转码，逐个字符迭代比较并返回结果，属于暴力方法</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsAny</span><span class="params">(b []<span class="keyword">byte</span>, chars <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexAny(b, chars) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexAny</span><span class="params">(s []<span class="keyword">byte</span>, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// Avoid scanning all of s.</span></div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i, c := <span class="keyword">range</span> s &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(c) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">var</span> width <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i += width &#123;</div><div class="line">		r := <span class="keyword">rune</span>(s[i])</div><div class="line">		<span class="keyword">if</span> r &lt; utf8.RuneSelf &#123;</div><div class="line">			width = <span class="number">1</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r, width = utf8.DecodeRune(s[i:])</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">for</span> _, ch := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> r == ch &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> asciiSet [<span class="number">8</span>]<span class="keyword">uint32</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeASCIISet</span><span class="params">(chars <span class="keyword">string</span>)</span> <span class="params">(as asciiSet, ok <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(chars); i++ &#123;</div><div class="line">		c := chars[i]</div><div class="line">		<span class="keyword">if</span> c &gt;= utf8.RuneSelf &#123;</div><div class="line">			<span class="keyword">return</span> as, <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		as[c&gt;&gt;<span class="number">5</span>] |= <span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(c&amp;<span class="number">31</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> as, <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// contains reports whether c is inside the set.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(as *asciiSet)</span> <span class="title">contains</span><span class="params">(c <span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> (as[c&gt;&gt;<span class="number">5</span>] &amp; (<span class="number">1</span> &lt;&lt; <span class="keyword">uint</span>(c&amp;<span class="number">31</span>))) != <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ContainsRune方法返回切片b中是否含有字符r，返回找到的匹配字节的索引值</li>
<li>通过方法IndexRune来实现<ul>
<li>如果r是ASCII字符，调用函数IndexBytes来完成查找</li>
<li>如果要查找的是utf8.RuneError，则返回第一个不合法的序列</li>
<li>否则将rune转换成字节切片，调用Index方法完成查找</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ContainsRune</span><span class="params">(b []<span class="keyword">byte</span>, r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> IndexRune(b, r) &gt;= <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IndexRune</span><span class="params">(s []<span class="keyword">byte</span>, r <span class="keyword">rune</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> <span class="number">0</span> &lt;= r &amp;&amp; r &lt; utf8.RuneSelf:</div><div class="line">		<span class="keyword">return</span> IndexByte(s, <span class="keyword">byte</span>(r))</div><div class="line">	<span class="keyword">case</span> r == utf8.RuneError:</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); &#123;</div><div class="line">			r1, n := utf8.DecodeRune(s[i:])</div><div class="line">			<span class="keyword">if</span> r1 == utf8.RuneError &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">			i += n</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> !utf8.ValidRune(r):</div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">var</span> b [utf8.UTFMax]<span class="keyword">byte</span></div><div class="line">		n := utf8.EncodeRune(b[:], r)</div><div class="line">		<span class="keyword">return</span> Index(s, b[:n])</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h3><ul>
<li>Count函数返回字节数组中s存在sep的个数<ul>
<li>sep长度为0，则返回s中字符数+1</li>
<li>sep长度为1，调用bytealg.Count函数返回结果</li>
<li>否则，利用Index方法来进行个数查找</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Count</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sep) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> utf8.RuneCount(s) + <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sep) == <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> bytealg.Count(s, sep[<span class="number">0</span>])</div><div class="line">	&#125;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		i := Index(s, sep)</div><div class="line">		<span class="keyword">if</span> i == <span class="number">-1</span> &#123;</div><div class="line">			<span class="keyword">return</span> n</div><div class="line">		&#125;</div><div class="line">		n++</div><div class="line">		s = s[i+<span class="built_in">len</span>(sep):]</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Equal"><a href="#Equal" class="headerlink" title="Equal"></a>Equal</h3><ul>
<li>Equal的实现是调用更底层的Equal方法</li>
<li>Equal实际上只是看两个字节切片的长度和元素值是否相等，不看是否来自同一个底层数组的引用</li>
<li>nil和空切片是相等的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Equal</span><span class="params">(a, b []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> bytealg.Equal(a, b)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="EqualFold"><a href="#EqualFold" class="headerlink" title="EqualFold"></a>EqualFold</h3><ul>
<li>EqualFold方法将判断s,t在Unicode大小写折叠下是否相等</li>
<li>如果是ASCII编码则简单比较大小写即可，否则需要进行unicode.SimpleFold进行转换并比较</li>
<li>判断也是值是否相等</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">EqualFold</span><span class="params">(s, t []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(s) != <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(t) != <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Extract first rune from each.</span></div><div class="line">		<span class="keyword">var</span> sr, tr <span class="keyword">rune</span></div><div class="line">		<span class="keyword">if</span> s[<span class="number">0</span>] &lt; utf8.RuneSelf &#123;</div><div class="line">			sr, s = <span class="keyword">rune</span>(s[<span class="number">0</span>]), s[<span class="number">1</span>:]</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r, size := utf8.DecodeRune(s)</div><div class="line">			sr, s = r, s[size:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> t[<span class="number">0</span>] &lt; utf8.RuneSelf &#123;</div><div class="line">			tr, t = <span class="keyword">rune</span>(t[<span class="number">0</span>]), t[<span class="number">1</span>:]</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			r, size := utf8.DecodeRune(t)</div><div class="line">			tr, t = r, t[size:]</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// If they match, keep going; if not, return false.</span></div><div class="line"></div><div class="line">		<span class="comment">// Easy case.</span></div><div class="line">		<span class="keyword">if</span> tr == sr &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Make sr &lt; tr to simplify what follows.</span></div><div class="line">		<span class="keyword">if</span> tr &lt; sr &#123;</div><div class="line">			tr, sr = sr, tr</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Fast check for ASCII.</span></div><div class="line">		<span class="keyword">if</span> tr &lt; utf8.RuneSelf &#123;</div><div class="line">			<span class="comment">// ASCII only, sr/tr must be upper/lower case</span></div><div class="line">			<span class="keyword">if</span> <span class="string">'A'</span> &lt;= sr &amp;&amp; sr &lt;= <span class="string">'Z'</span> &amp;&amp; tr == sr+<span class="string">'a'</span>-<span class="string">'A'</span> &#123;</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// General case. SimpleFold(x) returns the next equivalent rune &gt; x</span></div><div class="line">		<span class="comment">// or wraps around to smaller values.</span></div><div class="line">		r := unicode.SimpleFold(sr)</div><div class="line">		<span class="keyword">for</span> r != sr &amp;&amp; r &lt; tr &#123;</div><div class="line">			r = unicode.SimpleFold(r)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> r == tr &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// One string is empty. Are both?</span></div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) == <span class="built_in">len</span>(t)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h3><ul>
<li>Fields函数将字节切片s，以空白字符切割，并返回[][]byte类型结果，如<code>[]byte(&quot;1  2  3  4&quot;)</code>返回<code>[]string{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;}</code></li>
<li>用setBits来记录s中出现过的字节</li>
<li>如果<code>setBits&gt;utf8.RuneSelf</code>表示存在不是ASCII编码的数据，此时调用FieldsFunc方法来完成分割操作<ul>
<li>FieldFunc传入的第二个参数为unicode.IsSpace，来判断一个字符是否为空白字符</li>
<li>span用于记录各个分割出的Fied的起点和终点，从而组织输出数据</li>
</ul>
</li>
<li>如果<code>setBits&lt;utf8.RuneSelf</code>则表示都是ASCII编码，而ASCII编码的空白字符为<code>[256]uint{&#39;\t&#39;: 1, &#39;\n&#39;: 1, &#39;\v&#39;: 1, &#39;\f&#39;: 1, &#39;\r&#39;: 1, &#39; &#39;: 1}</code>,可以快速进行分割</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fields</span><span class="params">(s []<span class="keyword">byte</span>)</span> [][]<span class="title">byte</span></span> &#123;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	wasSpace := <span class="number">1</span></div><div class="line">	<span class="comment">// setBits is used to track which bits are set in the bytes of s.</span></div><div class="line">	setBits := <span class="keyword">uint8</span>(<span class="number">0</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">		r := s[i]</div><div class="line">		setBits |= r</div><div class="line">		isSpace := <span class="keyword">int</span>(asciiSpace[r])</div><div class="line">		n += wasSpace &amp; ^isSpace</div><div class="line">		wasSpace = isSpace</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> setBits &gt;= utf8.RuneSelf &#123;</div><div class="line">		<span class="comment">// Some runes in the input slice are not ASCII.</span></div><div class="line">		<span class="keyword">return</span> FieldsFunc(s, unicode.IsSpace)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// ASCII fast path</span></div><div class="line">	a := <span class="built_in">make</span>([][]<span class="keyword">byte</span>, n)</div><div class="line">	na := <span class="number">0</span></div><div class="line">	fieldStart := <span class="number">0</span></div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="comment">// Skip spaces in the front of the input.</span></div><div class="line">	<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	fieldStart = i</div><div class="line">	<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &#123;</div><div class="line">		<span class="keyword">if</span> asciiSpace[s[i]] == <span class="number">0</span> &#123;</div><div class="line">			i++</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		a[na] = s[fieldStart:i:i]</div><div class="line">		na++</div><div class="line">		i++</div><div class="line">		<span class="comment">// Skip spaces in between fields.</span></div><div class="line">		<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(s) &amp;&amp; asciiSpace[s[i]] != <span class="number">0</span> &#123;</div><div class="line">			i++</div><div class="line">		&#125;</div><div class="line">		fieldStart = i</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> fieldStart &lt; <span class="built_in">len</span>(s) &#123; <span class="comment">// Last field might end at EOF.</span></div><div class="line">		a[na] = s[fieldStart:<span class="built_in">len</span>(s):<span class="built_in">len</span>(s)]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> a</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FieldsFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>) [][]<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="comment">// A span is used to record a slice of s of the form s[start:end].</span></div><div class="line">	<span class="comment">// The start index is inclusive and the end index is exclusive.</span></div><div class="line">	<span class="keyword">type</span> span <span class="keyword">struct</span> &#123;</div><div class="line">		start <span class="keyword">int</span></div><div class="line">		end   <span class="keyword">int</span></div><div class="line">	&#125;</div><div class="line">	spans := <span class="built_in">make</span>([]span, <span class="number">0</span>, <span class="number">32</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Find the field start and end indices.</span></div><div class="line">	wasField := <span class="literal">false</span></div><div class="line">	fromIndex := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); &#123;</div><div class="line">		size := <span class="number">1</span></div><div class="line">		r := <span class="keyword">rune</span>(s[i])</div><div class="line">		<span class="keyword">if</span> r &gt;= utf8.RuneSelf &#123;</div><div class="line">			r, size = utf8.DecodeRune(s[i:])</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> f(r) &#123;</div><div class="line">			<span class="keyword">if</span> wasField &#123;</div><div class="line">				spans = <span class="built_in">append</span>(spans, span&#123;start: fromIndex, end: i&#125;)</div><div class="line">				wasField = <span class="literal">false</span></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> !wasField &#123;</div><div class="line">				fromIndex = i</div><div class="line">				wasField = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		i += size</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Last field might end at EOF.</span></div><div class="line">	<span class="keyword">if</span> wasField &#123;</div><div class="line">		spans = <span class="built_in">append</span>(spans, span&#123;fromIndex, <span class="built_in">len</span>(s)&#125;)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create subslices from recorded field indices.</span></div><div class="line">	a := <span class="built_in">make</span>([][]<span class="keyword">byte</span>, <span class="built_in">len</span>(spans))</div><div class="line">	<span class="keyword">for</span> i, span := <span class="keyword">range</span> spans &#123;</div><div class="line">		a[i] = s[span.start:span.end:span.end]</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> a</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Has函数"><a href="#Has函数" class="headerlink" title="Has函数"></a>Has函数</h3><ul>
<li>HasPrefix，HasSuffix函数本质上是用Equals方法判断截取后的字节切片是否相等</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasPrefix tests whether the byte slice s begins with prefix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, prefix []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(prefix) &amp;&amp; Equal(s[<span class="number">0</span>:<span class="built_in">len</span>(prefix)], prefix)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// HasSuffix tests whether the byte slice s ends with suffix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasSuffix</span><span class="params">(s, suffix []<span class="keyword">byte</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(suffix) &amp;&amp; Equal(s[<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix):], suffix)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h3><ul>
<li>Join函数，Fields的逆向操作，将二维字切片用sep切片拼接为一维字节切片</li>
<li>对于二维切片数组不同的长度做了相应的拼接处理</li>
<li>拼接过程中用内建函数copy来完成</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Join</span><span class="params">(s [][]<span class="keyword">byte</span>, sep []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">1</span> &#123;</div><div class="line">		<span class="comment">// Just return a copy.</span></div><div class="line">		<span class="keyword">return</span> <span class="built_in">append</span>([]<span class="keyword">byte</span>(<span class="literal">nil</span>), s[<span class="number">0</span>]...)</div><div class="line">	&#125;</div><div class="line">	n := <span class="built_in">len</span>(sep) * (<span class="built_in">len</span>(s) - <span class="number">1</span>)</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</div><div class="line">		n += <span class="built_in">len</span>(v)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</div><div class="line">	bp := <span class="built_in">copy</span>(b, s[<span class="number">0</span>])</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s[<span class="number">1</span>:] &#123;</div><div class="line">		bp += <span class="built_in">copy</span>(b[bp:], sep)</div><div class="line">		bp += <span class="built_in">copy</span>(b[bp:], v)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Last类函数"><a href="#Last类函数" class="headerlink" title="Last类函数"></a>Last类函数</h3><ul>
<li>LastIndex函数返回s中sep最后一次出现的索引值</li>
<li>LastIndexByte返回字节c在s中最后一次出现的索引值</li>
<li>LastIndexAny返回s中最后一个出现的chars中的任意一个字符的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndex</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(sep)</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">len</span>(s)</div><div class="line">	&#125;</div><div class="line">	c := sep[<span class="number">0</span>]</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - n; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> s[i] == c &amp;&amp; (n == <span class="number">1</span> || Equal(s[i:i+n], sep)) &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexByte</span><span class="params">(s []<span class="keyword">byte</span>, c <span class="keyword">byte</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		<span class="keyword">if</span> s[i] == c &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexAny</span><span class="params">(s []<span class="keyword">byte</span>, chars <span class="keyword">string</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> chars == <span class="string">""</span> &#123;</div><div class="line">		<span class="comment">// Avoid scanning all of s.</span></div><div class="line">		<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &gt; <span class="number">8</span> &#123;</div><div class="line">		<span class="keyword">if</span> as, isASCII := makeASCIISet(chars); isASCII &#123;</div><div class="line">			<span class="keyword">for</span> i := <span class="built_in">len</span>(s) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">				<span class="keyword">if</span> as.contains(s[i]) &#123;</div><div class="line">					<span class="keyword">return</span> i</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s); i &gt; <span class="number">0</span>; &#123;</div><div class="line">		r, size := utf8.DecodeLastRune(s[:i])</div><div class="line">		i -= size</div><div class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> chars &#123;</div><div class="line">			<span class="keyword">if</span> r == c &#123;</div><div class="line">				<span class="keyword">return</span> i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LastIndexFunc返回满足函数f的最后一个字符的索引值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LastIndexFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">bool</span>) <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> lastIndexFunc(s, f, <span class="literal">true</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">lastIndexFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">bool</span>, <span class="title">truth</span> <span class="title">bool</span>) <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="built_in">len</span>(s); i &gt; <span class="number">0</span>; &#123;</div><div class="line">		r, size := <span class="keyword">rune</span>(s[i<span class="number">-1</span>]), <span class="number">1</span></div><div class="line">		<span class="keyword">if</span> r &gt;= utf8.RuneSelf &#123;</div><div class="line">			r, size = utf8.DecodeLastRune(s[<span class="number">0</span>:i])</div><div class="line">		&#125;</div><div class="line">		i -= size</div><div class="line">		<span class="keyword">if</span> f(r) == truth &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><ul>
<li>Map函数根据函数mapping完成s中字符的映射变换</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Map</span><span class="params">(mapping <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">rune</span>, <span class="title">s</span> []<span class="title">byte</span>) []<span class="title">byte</span></span> &#123;</div><div class="line">	maxbytes := <span class="built_in">len</span>(s) <span class="comment">// length of b</span></div><div class="line">	nbytes := <span class="number">0</span>        <span class="comment">// number of bytes encoded in b</span></div><div class="line">	b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, maxbytes)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(s); &#123;</div><div class="line">		wid := <span class="number">1</span></div><div class="line">		r := <span class="keyword">rune</span>(s[i])</div><div class="line">		<span class="keyword">if</span> r &gt;= utf8.RuneSelf &#123;</div><div class="line">			r, wid = utf8.DecodeRune(s[i:])</div><div class="line">		&#125;</div><div class="line">		r = mapping(r)</div><div class="line">		<span class="keyword">if</span> r &gt;= <span class="number">0</span> &#123;</div><div class="line">			rl := utf8.RuneLen(r)</div><div class="line">			<span class="keyword">if</span> rl &lt; <span class="number">0</span> &#123;</div><div class="line">				rl = <span class="built_in">len</span>(<span class="keyword">string</span>(utf8.RuneError))</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> nbytes+rl &gt; maxbytes &#123;</div><div class="line">				<span class="comment">// Grow the buffer.</span></div><div class="line">				maxbytes = maxbytes*<span class="number">2</span> + utf8.UTFMax</div><div class="line">				nb := <span class="built_in">make</span>([]<span class="keyword">byte</span>, maxbytes)</div><div class="line">				<span class="built_in">copy</span>(nb, b[<span class="number">0</span>:nbytes])</div><div class="line">				b = nb</div><div class="line">			&#125;</div><div class="line">			nbytes += utf8.EncodeRune(b[nbytes:maxbytes], r)</div><div class="line">		&#125;</div><div class="line">		i += wid</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> b[<span class="number">0</span>:nbytes]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h3><ul>
<li>Repeat函数完成对s的多份复制，如{a,b}变为{a,b,a,b}</li>
<li>程序中进行相乘的时候需要考虑溢出问题</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(b []<span class="keyword">byte</span>, count <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> count &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes: negative Repeat count"</span>)</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> count &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">len</span>(b)*count/count != <span class="built_in">len</span>(b) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes: Repeat count causes overflow"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	nb := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(b)*count)</div><div class="line">	bp := <span class="built_in">copy</span>(nb, b)</div><div class="line">	<span class="keyword">for</span> bp &lt; <span class="built_in">len</span>(nb) &#123;</div><div class="line">		<span class="built_in">copy</span>(nb[bp:], nb[:bp])</div><div class="line">		bp *= <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nb</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Replace"><a href="#Replace" class="headerlink" title="Replace"></a>Replace</h3><ul>
<li>Replace函数完成字节切片替换，n为替换的个数，n&lt;0则替换全部</li>
<li>Count函数用于计算old切片出现的次数</li>
<li>Index用于查找要替换的旧切片old</li>
<li>ReplaceAll将n设置为-1即可</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Replace</span><span class="params">(s, old, <span class="built_in">new</span> []<span class="keyword">byte</span>, n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	m := <span class="number">0</span></div><div class="line">	<span class="keyword">if</span> n != <span class="number">0</span> &#123;</div><div class="line">		m = Count(s, old)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> m == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="built_in">append</span>([]<span class="keyword">byte</span>(<span class="literal">nil</span>), s...)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> || m &lt; n &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Apply replacements to buffer.</span></div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)+n*(<span class="built_in">len</span>(<span class="built_in">new</span>)-<span class="built_in">len</span>(old)))</div><div class="line">	w := <span class="number">0</span></div><div class="line">	start := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		j := start</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(old) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</div><div class="line">				_, wid := utf8.DecodeRune(s[start:])</div><div class="line">				j += wid</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			j += Index(s[start:], old)</div><div class="line">		&#125;</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], s[start:j])</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], <span class="built_in">new</span>)</div><div class="line">		start = j + <span class="built_in">len</span>(old)</div><div class="line">	&#125;</div><div class="line">	w += <span class="built_in">copy</span>(t[w:], s[start:])</div><div class="line">	<span class="keyword">return</span> t[<span class="number">0</span>:w]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReplaceAll</span><span class="params">(s, old, <span class="built_in">new</span> []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Replace(s, old, <span class="built_in">new</span>, <span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Rune"><a href="#Rune" class="headerlink" title="Rune"></a>Rune</h3><ul>
<li>Rune函数将字节数组转换成Rune切片，主要调用utf8编码的函数来实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Runes</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">rune</span></span> &#123;</div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">rune</span>, utf8.RuneCount(s))</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</div><div class="line">		r, l := utf8.DecodeRune(s)</div><div class="line">		t[i] = r</div><div class="line">		i++</div><div class="line">		s = s[l:]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> t</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Split函数"><a href="#Split函数" class="headerlink" title="Split函数"></a>Split函数</h3><ul>
<li>SplitN函数表示将s按照分隔符sep分割成n份，不带分隔符，最后一份不再进行分割</li>
<li>SplitAfterN表示将s按照分隔符sep分割成n份，最后一份不再进行分割，带分隔符</li>
<li>Split函数将s按照分隔符sep进行分割，不带分隔符</li>
<li>SplitAfter函数将s按照分隔符sep进行分割，带分隔符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitN</span><span class="params">(s, sep []<span class="keyword">byte</span>, n <span class="keyword">int</span>)</span> [][]<span class="title">byte</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, n) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfterN</span><span class="params">(s, sep []<span class="keyword">byte</span>, n <span class="keyword">int</span>)</span> [][]<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), n)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Split</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> [][]<span class="title">byte</span></span> &#123; <span class="keyword">return</span> genSplit(s, sep, <span class="number">0</span>, <span class="number">-1</span>) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SplitAfter</span><span class="params">(s, sep []<span class="keyword">byte</span>)</span> [][]<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> genSplit(s, sep, <span class="built_in">len</span>(sep), <span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Split类方法实际上都是对genSplit方法的封装</li>
<li>sep为空的时候，用explode完成对字节切片的按照字符的分割</li>
<li>索引定位的时候也是通过Index方法来实现的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">genSplit</span><span class="params">(s, sep []<span class="keyword">byte</span>, sepSave, n <span class="keyword">int</span>)</span> [][]<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(sep) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> explode(s, n)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		n = Count(s, sep) + <span class="number">1</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	a := <span class="built_in">make</span>([][]<span class="keyword">byte</span>, n)</div><div class="line">	n--</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i &lt; n &#123;</div><div class="line">		m := Index(s, sep)</div><div class="line">		<span class="keyword">if</span> m &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		a[i] = s[: m+sepSave : m+sepSave]</div><div class="line">		s = s[m+<span class="built_in">len</span>(sep):]</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	a[i] = s</div><div class="line">	<span class="keyword">return</span> a[:i+<span class="number">1</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">explode</span><span class="params">(s []<span class="keyword">byte</span>, n <span class="keyword">int</span>)</span> [][]<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;</div><div class="line">		n = <span class="built_in">len</span>(s)</div><div class="line">	&#125;</div><div class="line">	a := <span class="built_in">make</span>([][]<span class="keyword">byte</span>, n)</div><div class="line">	<span class="keyword">var</span> size <span class="keyword">int</span></div><div class="line">	na := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(s) &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">if</span> na+<span class="number">1</span> &gt;= n &#123;</div><div class="line">			a[na] = s</div><div class="line">			na++</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		_, size = utf8.DecodeRune(s)</div><div class="line">		a[na] = s[<span class="number">0</span>:size:size]</div><div class="line">		s = s[size:]</div><div class="line">		na++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> a[<span class="number">0</span>:na]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Title"><a href="#Title" class="headerlink" title="Title"></a>Title</h3><ul>
<li>Title方法利用Map完成对切片s首字母的大写转换</li>
<li>isSeparator标识一个字符是否为边界字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Title</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	prev := <span class="string">' '</span></div><div class="line">	<span class="keyword">return</span> Map(</div><div class="line">		<span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">rune</span></span> &#123;</div><div class="line">			<span class="keyword">if</span> isSeparator(prev) &#123;</div><div class="line">				prev = r</div><div class="line">				<span class="keyword">return</span> unicode.ToTitle(r)</div><div class="line">			&#125;</div><div class="line">			prev = r</div><div class="line">			<span class="keyword">return</span> r</div><div class="line">		&#125;,</div><div class="line">		s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">isSeparator</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="comment">// ASCII alphanumerics ad underscore are not separators</span></div><div class="line">	<span class="keyword">if</span> r &lt;= <span class="number">0x7F</span> &#123;</div><div class="line">		<span class="keyword">switch</span> &#123;</div><div class="line">		<span class="keyword">case</span> <span class="string">'0'</span> &lt;= r &amp;&amp; r &lt;= <span class="string">'9'</span>:</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		<span class="keyword">case</span> <span class="string">'a'</span> &lt;= r &amp;&amp; r &lt;= <span class="string">'z'</span>:</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		<span class="keyword">case</span> <span class="string">'A'</span> &lt;= r &amp;&amp; r &lt;= <span class="string">'Z'</span>:</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		<span class="keyword">case</span> r == <span class="string">'_'</span>:</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Letters and digits are not separators</span></div><div class="line">	<span class="keyword">if</span> unicode.IsLetter(r) || unicode.IsDigit(r) &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Otherwise, all we can do for now is treat spaces as separators.</span></div><div class="line">	<span class="keyword">return</span> unicode.IsSpace(r)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="To类函数"><a href="#To类函数" class="headerlink" title="To类函数"></a>To类函数</h3><ul>
<li>To类函数实际上都是对Map的一层封装，具体对字符的操作可以参照unicode包的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToUpper</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123; <span class="keyword">return</span> Map(unicode.ToUpper, s) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToLower</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123; <span class="keyword">return</span> Map(unicode.ToLower, s) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToTitle</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123; <span class="keyword">return</span> Map(unicode.ToTitle, s) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToUpperSpecial</span><span class="params">(c unicode.SpecialCase, s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Map(c.ToUpper, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToLowerSpecial</span><span class="params">(c unicode.SpecialCase, s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Map(c.ToLower, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ToTitleSpecial</span><span class="params">(c unicode.SpecialCase, s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Map(c.ToTitle, s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Trim类函数"><a href="#Trim类函数" class="headerlink" title="Trim类函数"></a>Trim类函数</h3><ul>
<li>Trim函数完成字节切片前后去除指定的字符数据</li>
<li>Trim函数的实现是通过TrimFunc函数来实现的</li>
<li>TrimFunc函数是通过组合TrimRightFunc和TrimLeftFunc来实现的</li>
<li>TrimRightFunc完成右侧的字符截取，通过lastIndexFunc函数完成</li>
<li>TrimLeftFunc完成左侧的字符截取，通过indexFunc函数完成</li>
<li>Trim函数的筛选函数f是makeCutsetFunc函数的返回值</li>
<li>makeCutsetFunc会分情况返回当前的字节是否属于该剔除的字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Trim</span><span class="params">(s []<span class="keyword">byte</span>, cutset <span class="keyword">string</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> TrimFunc(s, makeCutsetFunc(cutset))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">bool</span>) []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> TrimRightFunc(TrimLeftFunc(s, f), f)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimRightFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">bool</span>) []<span class="title">byte</span></span> &#123;</div><div class="line">	i := lastIndexFunc(s, f, <span class="literal">false</span>)</div><div class="line">	<span class="keyword">if</span> i &gt;= <span class="number">0</span> &amp;&amp; s[i] &gt;= utf8.RuneSelf &#123;</div><div class="line">		_, wid := utf8.DecodeRune(s[i:])</div><div class="line">		i += wid</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s[<span class="number">0</span>:i]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimLeftFunc</span><span class="params">(s []<span class="keyword">byte</span>, f <span class="keyword">func</span>(r <span class="keyword">rune</span>)</span> <span class="title">bool</span>) []<span class="title">byte</span></span> &#123;</div><div class="line">	i := indexFunc(s, f, <span class="literal">false</span>)</div><div class="line">	<span class="keyword">if</span> i == <span class="number">-1</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s[i:]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeCutsetFunc</span><span class="params">(cutset <span class="keyword">string</span>)</span> <span class="title">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(cutset) == <span class="number">1</span> &amp;&amp; cutset[<span class="number">0</span>] &lt; utf8.RuneSelf &#123;</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> r == <span class="keyword">rune</span>(cutset[<span class="number">0</span>])</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> as, isASCII := makeASCIISet(cutset); isASCII &#123;</div><div class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">			<span class="keyword">return</span> r &lt; utf8.RuneSelf &amp;&amp; as.contains(<span class="keyword">byte</span>(r))</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> _, c := <span class="keyword">range</span> cutset &#123;</div><div class="line">			<span class="keyword">if</span> c == r &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>TrimPrefix完成指定前缀的截取</li>
<li>TrimSuffix完成指定后缀的截取</li>
<li>TrimSpace完成对前后空白字符的截取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimPrefix</span><span class="params">(s, prefix []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> HasPrefix(s, prefix) &#123;</div><div class="line">		<span class="keyword">return</span> s[<span class="built_in">len</span>(prefix):]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimSuffix</span><span class="params">(s, suffix []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> HasSuffix(s, suffix) &#123;</div><div class="line">		<span class="keyword">return</span> s[:<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix)]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TrimSpace</span><span class="params">(s []<span class="keyword">byte</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> TrimFunc(s, unicode.IsSpace)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/golang/源码解读/bytes/buffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/07/golang/源码解读/bytes/buffer/" itemprop="url">go源码解读-bytes.Buffer</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-07T17:28:50+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="bytes-Buffer"><a href="#bytes-Buffer" class="headerlink" title="bytes.Buffer"></a>bytes.Buffer</h2><ul>
<li>Buffer结构体<ul>
<li>bytes.Buffer实际上就是长度可变的，可读可写的数组buffer</li>
<li>bytes.Buffer的零值为一个可用的buffer</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Buffer <span class="keyword">struct</span> &#123;</div><div class="line">	buf      []<span class="keyword">byte</span> <span class="comment">// 字节切片，Buffer中的内容为切片[off: len(buf)]</span></div><div class="line">	off      <span class="keyword">int</span>    <span class="comment">// 读取索引 &amp;buf[off], 写入从&amp;buf[len(buf)]写入</span></div><div class="line">	lastRead readOp <span class="comment">// 记录上一次对buffer的操作，从而实现撤销操作</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 最后一次操作buffer的行为</span></div><div class="line"><span class="keyword">type</span> readOp <span class="keyword">int8</span></div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	opRead      readOp = <span class="number">-1</span> <span class="comment">// Any other read operation.</span></div><div class="line">	opInvalid   readOp = <span class="number">0</span>  <span class="comment">// Non-read operation.</span></div><div class="line">	opReadRune1 readOp = <span class="number">1</span>  <span class="comment">// Read rune of size 1.</span></div><div class="line">	opReadRune2 readOp = <span class="number">2</span>  <span class="comment">// Read rune of size 2.</span></div><div class="line">	opReadRune3 readOp = <span class="number">3</span>  <span class="comment">// Read rune of size 3.</span></div><div class="line">	opReadRune4 readOp = <span class="number">4</span>  <span class="comment">// Read rune of size 4.</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="Buffer结构体的方法"><a href="#Buffer结构体的方法" class="headerlink" title="Buffer结构体的方法"></a>Buffer结构体的方法</h3><ul>
<li>Bytes方法返回Buffer未读取的字节数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Bytes</span><span class="params">()</span> []<span class="title">byte</span></span> &#123; <span class="keyword">return</span> b.buf[b.off:] &#125;</div></pre></td></tr></table></figure>
<ul>
<li>String方法以字符串的格式返回未读取的buffer数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Special case, useful in debugging.</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"&lt;nil&gt;"</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(b.buf[b.off:])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Len方法返回未读取的字节数</li>
<li>Cap方法返回buffer数据分配的内存大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(b.buf) - b.off &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">cap</span>(b.buf) &#125;</div></pre></td></tr></table></figure>
<ul>
<li>Truncate截取<code>b.buf[:b.off+n]</code>为新的buf</li>
<li>Reset方法为重置操作，创建一个零值的Buffer</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Truncate</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n == <span class="number">0</span> &#123;</div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> || n &gt; b.Len() &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes.Buffer: truncation out of range"</span>)</div><div class="line">	&#125;</div><div class="line">	b.buf = b.buf[:b.off+n]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Reset</span><span class="params">()</span></span> &#123;</div><div class="line">	b.buf = b.buf[:<span class="number">0</span>]</div><div class="line">	b.off = <span class="number">0</span></div><div class="line">	b.lastRead = opInvalid</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Grow方法对buffer的容量进行扩容，n指定扩容的字节数大小</li>
<li>n为负数会panic, buffer不能扩容也会报错</li>
<li>grow方法返回的m为写入数据的起点</li>
<li>tryGrowByReslice方法是在buf本身容量是足够的情况下的扩容操作，只需要重新获取切片接口</li>
<li>扩容时是有最小扩容空间的，为64字节，n&lt;64则会被赋值为64，避免小尺度多次扩容的情况</li>
<li>扩容时，会优先考虑复用已经分配的切片空间，不能满足其需求则会重新扩容</li>
<li>makeSlice创建一个新的slice并分配空间，扩容尺寸为原来分配的内存空间的2倍+n个字节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"bytes.Buffer.Grow: negative count"</span>)</div><div class="line">	&#125;</div><div class="line">	m := b.grow(n)</div><div class="line">	b.buf = b.buf[:m]</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">grow</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	m := b.Len()</div><div class="line">	<span class="comment">// If buffer is empty, reset to recover space.</span></div><div class="line">	<span class="keyword">if</span> m == <span class="number">0</span> &amp;&amp; b.off != <span class="number">0</span> &#123;</div><div class="line">		b.Reset()</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Try to grow by means of a reslice.</span></div><div class="line">	<span class="keyword">if</span> i, ok := b.tryGrowByReslice(n); ok &#123;</div><div class="line">		<span class="keyword">return</span> i</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.buf == <span class="literal">nil</span> &amp;&amp; n &lt;= smallBufferSize &#123;</div><div class="line">		b.buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, n, smallBufferSize)</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	c := <span class="built_in">cap</span>(b.buf)</div><div class="line">	<span class="keyword">if</span> n &lt;= c/<span class="number">2</span>-m &#123;</div><div class="line">		<span class="comment">// We can slide things down instead of allocating a new</span></div><div class="line">		<span class="comment">// slice. We only need m+n &lt;= c to slide, but</span></div><div class="line">		<span class="comment">// we instead let capacity get twice as large so we</span></div><div class="line">		<span class="comment">// don't spend all our time copying.</span></div><div class="line">		<span class="built_in">copy</span>(b.buf, b.buf[b.off:])</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> c &gt; maxInt-c-n &#123;</div><div class="line">		<span class="built_in">panic</span>(ErrTooLarge)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// Not enough space anywhere, we need to allocate.</span></div><div class="line">		buf := makeSlice(<span class="number">2</span>*c + n)</div><div class="line">		<span class="built_in">copy</span>(buf, b.buf[b.off:])</div><div class="line">		b.buf = buf</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Restore b.off and len(b.buf).</span></div><div class="line">	b.off = <span class="number">0</span></div><div class="line">	b.buf = b.buf[:m+n]</div><div class="line">	<span class="keyword">return</span> m</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">tryGrowByReslice</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l := <span class="built_in">len</span>(b.buf); n &lt;= <span class="built_in">cap</span>(b.buf)-l &#123;</div><div class="line">		b.buf = b.buf[:l+n]</div><div class="line">		<span class="keyword">return</span> l, <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// makeSlice allocates a slice of size n. If the allocation fails, it panics</span></div><div class="line"><span class="comment">// with ErrTooLarge.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeSlice</span><span class="params">(n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	<span class="comment">// If the make fails, give a known error.</span></div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">recover</span>() != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(ErrTooLarge)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> <span class="built_in">make</span>([]<span class="keyword">byte</span>, n)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Write方法向buf中写入字节数组p</li>
<li>WriteString向buf中写入字符串，内建方法copy支持复制字符串到字节数组中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(p))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(p))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(s))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(s))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>MinRead为ReadFrom最少读入的字节数</li>
<li>ReadFrom从实现了io.Reader接口的结构体中读取数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MinRead = <span class="number">512</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		i := b.grow(MinRead)</div><div class="line">		b.buf = b.buf[:i]</div><div class="line">		m, e := r.Read(b.buf[i:<span class="built_in">cap</span>(b.buf)])</div><div class="line">		<span class="keyword">if</span> m &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(errNegativeRead)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		b.buf = b.buf[:i+m]</div><div class="line">		n += <span class="keyword">int64</span>(m)</div><div class="line">		<span class="keyword">if</span> e == io.EOF &#123;</div><div class="line">			<span class="keyword">return</span> n, <span class="literal">nil</span> <span class="comment">// e is EOF, so return nil explicitly</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, e</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>WriteTo 将数据写入到,直到Buffer中数据为空</li>
<li>WriteByte方法将字节c写入到buffer中</li>
<li>WriteRune方法将字符r写入到buffer中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteTo</span><span class="params">(w io.Writer)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> nBytes := b.Len(); nBytes &gt; <span class="number">0</span> &#123;</div><div class="line">		m, e := w.Write(b.buf[b.off:])</div><div class="line">		<span class="keyword">if</span> m &gt; nBytes &#123;</div><div class="line">			<span class="built_in">panic</span>(<span class="string">"bytes.Buffer.WriteTo: invalid Write count"</span>)</div><div class="line">		&#125;</div><div class="line">		b.off += m</div><div class="line">		n = <span class="keyword">int64</span>(m)</div><div class="line">		<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> n, e</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// all bytes should have been written, by definition of</span></div><div class="line">		<span class="comment">// Write method in io.Writer</span></div><div class="line">		<span class="keyword">if</span> m != nBytes &#123;</div><div class="line">			<span class="keyword">return</span> n, io.ErrShortWrite</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Buffer is now empty; reset.</span></div><div class="line">	b.Reset()</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">WriteByte</span><span class="params">(c <span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="number">1</span>)</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="number">1</span>)</div><div class="line">	&#125;</div><div class="line">	b.buf[m] = c</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Read方法从buffer中读取len(p)个字节到字节切片p中</li>
<li>Next返回从buffer中将要读取到的n个字节切片</li>
<li>ReadByte从buffer中读取一个字节</li>
<li>ReadRune从buffer中读取一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(p) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	n = <span class="built_in">copy</span>(p, b.buf[b.off:])</div><div class="line">	b.off += n</div><div class="line">	<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</div><div class="line">		b.lastRead = opRead</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Next</span><span class="params">(n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m := b.Len()</div><div class="line">	<span class="keyword">if</span> n &gt; m &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line">	data := b.buf[b.off : b.off+n]</div><div class="line">	b.off += n</div><div class="line">	<span class="keyword">if</span> n &gt; <span class="number">0</span> &#123;</div><div class="line">		b.lastRead = opRead</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> data</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadByte</span><span class="params">()</span> <span class="params">(<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	c := b.buf[b.off]</div><div class="line">	b.off++</div><div class="line">	b.lastRead = opRead</div><div class="line">	<span class="keyword">return</span> c, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadRune</span><span class="params">()</span> <span class="params">(r <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.empty() &#123;</div><div class="line">		<span class="comment">// Buffer is empty, reset to recover space.</span></div><div class="line">		b.Reset()</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="number">0</span>, io.EOF</div><div class="line">	&#125;</div><div class="line">	c := b.buf[b.off]</div><div class="line">	<span class="keyword">if</span> c &lt; utf8.RuneSelf &#123;</div><div class="line">		b.off++</div><div class="line">		b.lastRead = opReadRune1</div><div class="line">		<span class="keyword">return</span> <span class="keyword">rune</span>(c), <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	r, n := utf8.DecodeRune(b.buf[b.off:])</div><div class="line">	b.off += n</div><div class="line">	b.lastRead = readOp(n)</div><div class="line">	<span class="keyword">return</span> r, n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>UnreadRune,撤销ReadRune方法的操作</li>
<li>UnreadByte,撤销ReadByte方法的操作</li>
<li>UnreadRune,撤销ReadRune方法的操作</li>
<li>UnreadRune,撤销ReadRune方法的操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadRune</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.lastRead &lt;= opInvalid &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b.off &gt;= <span class="keyword">int</span>(b.lastRead) &#123;</div><div class="line">		b.off -= <span class="keyword">int</span>(b.lastRead)</div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// bytes, UnreadByte returns an error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">UnreadByte</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.lastRead == opInvalid &#123;</div><div class="line">		<span class="keyword">return</span> errors.New(<span class="string">"bytes.Buffer: UnreadByte: previous operation was not a successful read"</span>)</div><div class="line">	&#125;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	<span class="keyword">if</span> b.off &gt; <span class="number">0</span> &#123;</div><div class="line">		b.off--</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadBytes从buffer中读取字节切片直到遇到delim字节，返回结果中包含delim字节</li>
<li>ReadString从buffer中读取字符串，直到遇到delim字节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadBytes</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	slice, err := b.readSlice(delim)</div><div class="line">	<span class="comment">// return a copy of slice. The buffer's backing array may</span></div><div class="line">	<span class="comment">// be overwritten by later calls.</span></div><div class="line">	line = <span class="built_in">append</span>(line, slice...)</div><div class="line">	<span class="keyword">return</span> line, err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// readSlice is like ReadBytes but returns a reference to internal buffer data.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">readSlice</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	i := IndexByte(b.buf[b.off:], delim)</div><div class="line">	end := b.off + i + <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> i &lt; <span class="number">0</span> &#123;</div><div class="line">		end = <span class="built_in">len</span>(b.buf)</div><div class="line">		err = io.EOF</div><div class="line">	&#125;</div><div class="line">	line = b.buf[b.off:end]</div><div class="line">	b.off = end</div><div class="line">	b.lastRead = opRead</div><div class="line">	<span class="keyword">return</span> line, err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadString</span><span class="params">(delim <span class="keyword">byte</span>)</span> <span class="params">(line <span class="keyword">string</span>, err error)</span></span> &#123;</div><div class="line">	slice, err := b.readSlice(delim)</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(slice), err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="初始化方法"><a href="#初始化方法" class="headerlink" title="初始化方法"></a>初始化方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBuffer</span><span class="params">(buf []<span class="keyword">byte</span>)</span> *<span class="title">Buffer</span></span> &#123; <span class="keyword">return</span> &amp;Buffer&#123;buf: buf&#125; &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBufferString</span><span class="params">(s <span class="keyword">string</span>)</span> *<span class="title">Buffer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Buffer&#123;buf: []<span class="keyword">byte</span>(s)&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/07/golang/源码解读/strings/builder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/07/golang/源码解读/strings/builder/" itemprop="url">go源码解读-strings.Builder</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-07T17:26:49+08:00">
                2020-05-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="builder"><a href="#builder" class="headerlink" title="builder"></a>builder</h2><ul>
<li>Builder是效率最高，内存使用最少的创建一个字符串的方法</li>
<li>Builder结构体包含两个参数<ul>
<li>addr 字符串的地址</li>
<li>buf 字节数组</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// A Builder is used to efficiently build a string using Write methods.</span></div><div class="line"><span class="comment">// It minimizes memory copying. The zero value is ready to use.</span></div><div class="line"><span class="comment">// Do not copy a non-zero Builder.</span></div><div class="line"><span class="keyword">type</span> Builder <span class="keyword">struct</span> &#123;</div><div class="line">	addr *Builder <span class="comment">// of receiver, to detect copies by value</span></div><div class="line">	buf  []<span class="keyword">byte</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h3><ul>
<li>String方法返回Builder构建的数据</li>
<li>Len方法返回字节数组占据的字节数，1个汉字三个字节</li>
<li>Cap方法返回字节数组分配的内存空间大小</li>
<li>Reset方法将Builder重置为初始状态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// String returns the accumulated string.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b.buf))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Len returns the number of accumulated bytes; b.Len() == len(b.String()).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(b.buf) &#125;</div><div class="line"></div><div class="line"><span class="comment">// Cap returns the capacity of the builder's underlying byte slice. It is the</span></div><div class="line"><span class="comment">// total space allocated for the string being built and includes any bytes</span></div><div class="line"><span class="comment">// already written.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Cap</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">cap</span>(b.buf) &#125;</div><div class="line"></div><div class="line"><span class="comment">// Reset resets the Builder to be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Reset</span><span class="params">()</span></span> &#123;</div><div class="line">	b.addr = <span class="literal">nil</span></div><div class="line">	b.buf = <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Grow方法"><a href="#Grow方法" class="headerlink" title="Grow方法"></a>Grow方法</h3><ul>
<li>Grow方法来扩展buf数组的分配内存的大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// grow copies the buffer to a new, larger buffer so that there are at least n</span></div><div class="line"><span class="comment">// bytes of capacity beyond len(b.buf).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(b.buf), <span class="number">2</span>*<span class="built_in">cap</span>(b.buf)+n)</div><div class="line">	<span class="built_in">copy</span>(buf, b.buf)</div><div class="line">	b.buf = buf</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Grow grows b's capacity, if necessary, to guarantee space for</span></div><div class="line"><span class="comment">// another n bytes. After Grow(n), at least n bytes can be written to b</span></div><div class="line"><span class="comment">// without another allocation. If n is negative, Grow panics.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Grow</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	<span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings.Builder.Grow: negative count"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>(b.buf)-<span class="built_in">len</span>(b.buf) &lt; n &#123;</div><div class="line">		b.grow(n)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">copyCheck</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> b.addr == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// This hack works around a failing of Go's escape analysis</span></div><div class="line">		<span class="comment">// that was causing b to escape and be heap allocated.</span></div><div class="line">		<span class="comment">// See issue 23382.</span></div><div class="line">		<span class="comment">// <span class="doctag">TODO:</span> once issue 7921 is fixed, this should be reverted to</span></div><div class="line">		<span class="comment">// just "b.addr = b".</span></div><div class="line">		b.addr = (*Builder)(noescape(unsafe.Pointer(b)))</div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> b.addr != b &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"strings: illegal use of non-zero Builder copied by value"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">noescape</span><span class="params">(p unsafe.Pointer)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</div><div class="line">	x := <span class="keyword">uintptr</span>(p)</div><div class="line">	<span class="keyword">return</span> unsafe.Pointer(x ^ <span class="number">0</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Write相关方法"><a href="#Write相关方法" class="headerlink" title="Write相关方法"></a>Write相关方法</h3><ul>
<li>Write方法将字节数组加添加到buf数组后面</li>
<li>WriteByte将字节c添加到buf数组后边</li>
<li>WriteRune将rune字符添加到buf数组后面</li>
<li>WriteString将字符串添加到buf数组后面</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Write appends the contents of p to b's buffer.</span></div><div class="line"><span class="comment">// Write always returns len(p), nil.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, p...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteByte appends the byte c to b's buffer.</span></div><div class="line"><span class="comment">// The returned error is always nil.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteByte</span><span class="params">(c <span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, c)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteRune appends the UTF-8 encoding of Unicode code point r to b's buffer.</span></div><div class="line"><span class="comment">// It returns the length of r and a nil error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteRune</span><span class="params">(r <span class="keyword">rune</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	<span class="keyword">if</span> r &lt; utf8.RuneSelf &#123;</div><div class="line">		b.buf = <span class="built_in">append</span>(b.buf, <span class="keyword">byte</span>(r))</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	l := <span class="built_in">len</span>(b.buf)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">cap</span>(b.buf)-l &lt; utf8.UTFMax &#123;</div><div class="line">		b.grow(utf8.UTFMax)</div><div class="line">	&#125;</div><div class="line">	n := utf8.EncodeRune(b.buf[l:l+utf8.UTFMax], r)</div><div class="line">	b.buf = b.buf[:l+n]</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteString appends the contents of s to b's buffer.</span></div><div class="line"><span class="comment">// It returns the length of s and a nil error.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Builder)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	b.copyCheck()</div><div class="line">	b.buf = <span class="built_in">append</span>(b.buf, s...)</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">97</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
