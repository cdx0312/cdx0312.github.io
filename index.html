<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/29/golang/源码解读/unsafe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/29/golang/源码解读/unsafe/" itemprop="url">go源码解读-unsafe包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-29T14:44:24+08:00">
                2020-05-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="unsafe包"><a href="#unsafe包" class="headerlink" title="unsafe包"></a>unsafe包</h2><ul>
<li>unsafe包中的操作是不安全的操作，会绕过go原因的内存保护机制</li>
<li>引用有风险，使用须谨慎</li>
<li>unsafe包提供了直接操作内存的能力</li>
</ul>
<h3 id="unsafe源码"><a href="#unsafe源码" class="headerlink" title="unsafe源码"></a>unsafe源码</h3><ul>
<li>unsafe包中只包含两个结构体和三个函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ArbitraryType <span class="keyword">int</span></div><div class="line"><span class="keyword">type</span> Pointer *ArbitraryType</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sizeof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">Offsetof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">Alignof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div></pre></td></tr></table></figure>
<h3 id="两个变量"><a href="#两个变量" class="headerlink" title="两个变量"></a>两个变量</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ArbitraryType <span class="keyword">int</span></div><div class="line"><span class="keyword">type</span> Pointer *ArbitraryType</div></pre></td></tr></table></figure>
<ul>
<li>ArbitraryType实际上并不是unsafe包的一部分，只是为了文档展示</li>
<li>ArbitraryType虽然类型时int，但是其实质上代表的是任意类型的go表达式<br>-</li>
<li>Pointer变量代表一个指向ArbitraryType对象的指针，实际上就是一个指向任意类型的指针</li>
<li>Pointer结构体有四个其他类型的结构体不具有的操作，这些能力使得go可以无视类型的限制来读写任意的内存，使用的时候需要谨慎<ul>
<li>一个任意结构体类型的指针可以转换为Pointer类型</li>
<li>一个Pointer类型的结构体可以转换成一个指针</li>
<li>一个uintptr可以转换成Pointer类型</li>
<li>一个Pointer类型的结构体可以转换成一个uintptr指针，uintptr是一个能存储指针的整形值</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Human <span class="keyword">struct</span> &#123;</div><div class="line">	sex  <span class="keyword">bool</span></div><div class="line">	age  <span class="keyword">uint8</span></div><div class="line">	min  <span class="keyword">int</span></div><div class="line">	name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	human := Human&#123;</div><div class="line">		<span class="literal">true</span>,</div><div class="line">		<span class="number">30</span>,</div><div class="line">		<span class="number">1</span>,</div><div class="line">		<span class="string">"hello"</span>,</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 结构体转换</span></div><div class="line">	fmt.Printf(<span class="string">"address os h is %p \n"</span>, &amp;human)</div><div class="line">	pointer := unsafe.Pointer(&amp;human)</div><div class="line">	fmt.Printf(<span class="string">"convert pointer human to Pointer type: %p \n"</span>, pointer)</div><div class="line"></div><div class="line">	<span class="comment">// 直接操作对象的内存</span></div><div class="line">	u1 := (*<span class="keyword">int16</span>)(unsafe.Pointer(<span class="keyword">uintptr</span>(unsafe.Pointer(&amp;human)) + unsafe.Offsetof(human.age)))</div><div class="line">	fmt.Println(human.age)</div><div class="line">	*u1 = <span class="number">12</span></div><div class="line">	fmt.Println(human.age)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">address os h is 0xc00000c060</span></div><div class="line"><span class="comment">convert pointer human to Pointer type: 0xc00000c060</span></div><div class="line"><span class="comment">0xc00000c061</span></div><div class="line"><span class="comment">30</span></div><div class="line"><span class="comment">12</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<ul>
<li>unsafe包规定了一些Pointer合理的使用模式，不符合的可能已经不可用或者即将不可用<ul>
<li>将*T1类型的指针转换成Pointer类型，然后再讲Pointer类型转换成T2类型指针<ul>
<li>这要求T1占用的内存要大于T2占用的内存</li>
<li>如math.Float64bits的实现</li>
</ul>
</li>
<li>将一个Pointer类型转换成一个uintptr类型，也就是将指向的值的地址作为一个uintptr变量的值，<ul>
<li>将uintptr转换成Pointer通常来说会产生问题</li>
<li>uintptr是个值，不是指针，因此其没有任何语义</li>
<li>uintptr即使有某个对象的地址，但是在gc的时候是不会影响该对象的gc操作的</li>
</ul>
</li>
<li>Pointer -&gt; uintptr -&gt; Pointer有时候是合法的，如进行算数运算的<ul>
<li><code>p = unsafe.Pointer(uintptr(p)+offset)</code></li>
<li>最常用的地方是获取结构体中的元素指针或者数组中的元素</li>
<li><code>f := unsafe.Pointer(uintptr(unsafe.Pointer(&amp;s)) + unsafe.Offsetof(s.f))</code> 等价于 <code>f := unsafe.Pointer(&amp;s.f)</code></li>
<li><code>e := unsafe.Pointer(uintptr(unsafe.Pointer(&amp;x[0])) + i*unsafe.Sizeof(x[0]))</code> 等价于 <code>e := unsafe.Pointer(&amp;x[i])</code></li>
<li>但是如果计算完指向了未分配的内存，则是不合法的</li>
</ul>
</li>
<li>调用syscall.Syscall的时候将Pointer类型转换成uintptr</li>
<li>将reflect.Value.Pointer或者reflect.Value.UnsafeAddr的结果从uintptr转换成Pointer类型时合法的<ul>
<li>这是因为reflect返回uintptr可以让上层调用不必引入unsafe包</li>
<li><code>p :+ (*int)(unsafe.Pointer(reflect.ValueOf(new)))</code></li>
</ul>
</li>
<li>Pointer可以与reflect.SliceHeader或者reflect.StringHeader的Data字段进行互相转换<ul>
<li><code>hdr.Data = uintptr(unsafe.Pointer(p))</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Float64bits returns the IEEE 754 binary representation of f,</span></div><div class="line"><span class="comment">// with the sign bit of f and the result in the same bit position,</span></div><div class="line"><span class="comment">// and Float64bits(Float64frombits(x)) == x.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Float64bits</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="title">uint64</span></span> &#123; <span class="keyword">return</span> *(*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;f)) &#125;</div></pre></td></tr></table></figure>
<h3 id="三个函数"><a href="#三个函数" class="headerlink" title="三个函数"></a>三个函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sizeof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">Offsetof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">Alignof</span><span class="params">(x ArbitraryType)</span> <span class="title">uintptr</span></span></div></pre></td></tr></table></figure>
<ul>
<li>三个函数传入的参数为ArbitraryType类型变量，也就是可以穿任意类型的数据的地址进来</li>
<li>SizeOf函数返回x类型占据的字节数的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	slice := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</div><div class="line">	i := <span class="keyword">int</span>(<span class="number">6</span>)</div><div class="line">	fmt.Println(<span class="keyword">int</span>(unsafe.Sizeof(i)) * <span class="built_in">len</span>(slice)) <span class="comment">// 64</span></div><div class="line">	fmt.Println(unsafe.Sizeof(slice)) <span class="comment">// 24</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Offsetof实际上返回的是当前结构体开始的位置到当前字段的位置之间的偏移量</li>
<li>Alignof返回变量对其字节数量ß</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/21/golang/源码解读/sync/pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/21/golang/源码解读/sync/pool/" itemprop="url">go源码解读-sync.WaitGroup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-21T10:31:29+08:00">
                2020-05-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Pool"><a href="#Pool" class="headerlink" title="Pool"></a>Pool</h2><ul>
<li>一个Pool是一群对象的集合，集合可能是单独存储</li>
<li>Pool中存储的对象可以自动在池中移除而不用通知，当只有Pool持有对象的引用时，对象有可能会释放内存</li>
<li>Pool是线程安全的</li>
<li>Pool的创建用意是缓存已经分配内存且已经用完的对象，方便后续复用的时候不必申请内存，同时减轻gc的压力</li>
<li>Pool适用于管理一组对象，可以被多个独立的客户端复用，从而避免每个客户端都要申请内存。</li>
<li>如果对象存在的声明周期很短，则不适合用Pool来管理</li>
</ul>
<h3 id="Pool结构体"><a href="#Pool结构体" class="headerlink" title="Pool结构体"></a>Pool结构体</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	noCopy noCopy  <span class="comment">// 确保pool在使用之后不会被复制</span></div><div class="line">	local     unsafe.Pointer <span class="comment">// 指向[]poolLocal的指针</span></div><div class="line">	localSize <span class="keyword">uintptr</span>        <span class="comment">// poolLocal的长度</span></div><div class="line">	victim     unsafe.Pointer <span class="comment">// victim一次GC之后的幸存者，这个地方也是指向[]poolLocal的指针，local经过一次GC就变为了victim</span></div><div class="line">	victimSize <span class="keyword">uintptr</span>        <span class="comment">// victim的长度</span></div><div class="line">	New <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; <span class="comment">// 当无法从Pool中获取到新的对象的时候，会调用New函数来创建个对象来返回</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>poolLocal是每个调度器P存储对象的结构体</li>
<li>pad防止伪共享</li>
<li>private为每个调度器的私有空间</li>
<li>shared空间当前调度器可以pushHead和popTail，所有调度器都可以popTail</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> poolLocal <span class="keyword">struct</span> &#123;</div><div class="line">	poolLocalInternal</div><div class="line"></div><div class="line">	<span class="comment">// Prevents false sharing on widespread platforms with</span></div><div class="line">	<span class="comment">// 128 mod (cache line size) = 0 .</span></div><div class="line">	pad [<span class="number">128</span> - unsafe.Sizeof(poolLocalInternal&#123;&#125;)%<span class="number">128</span>]<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Local per-P Pool appendix.</span></div><div class="line"><span class="keyword">type</span> poolLocalInternal <span class="keyword">struct</span> &#123;</div><div class="line">	private <span class="keyword">interface</span>&#123;&#125; <span class="comment">// Can be used only by the respective P.</span></div><div class="line">	shared  poolChain   <span class="comment">// Local P can pushHead/popHead; any P can popTail.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>poolChain为动态版的poolDequeue</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> poolChain <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// push节点，由当前P来push，不需要加锁</span></div><div class="line">	head *poolChainElt</div><div class="line">  <span class="comment">// get节点，所有调度器都可以操作，需要用原子方法写入和读取</span></div><div class="line">	tail *poolChainElt</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// poolChain的一个节点</span></div><div class="line"><span class="keyword">type</span> poolChainElt <span class="keyword">struct</span> &#123;</div><div class="line">	poolDequeue <span class="comment">// 为一个无锁，固定大小的单生产者多消费穿者的唤醒队列</span></div><div class="line">	next, prev *poolChainElt</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> poolDequeue <span class="keyword">struct</span> &#123;</div><div class="line">  <span class="comment">// headTail表示下标，高32位表示头下标，低32位表示尾下标，poolDequeue定义了，head tail的pack和unpack函数方便转化，实际用的时候都会mod ( len(vals) - 1 ) 来防止溢出</span></div><div class="line">	headTail <span class="keyword">uint64</span></div><div class="line">  <span class="comment">// vals的大小必须是2的幂，因为go的内存管理策略是将内存分为2的幂大小的链表，申请2的幂大小的内存可以有效减小分配内存的开销</span></div><div class="line">	vals []eface</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> eface <span class="keyword">struct</span> &#123;</div><div class="line">	typ, val unsafe.Pointer</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Pool结构体的方法"><a href="#Pool结构体的方法" class="headerlink" title="Pool结构体的方法"></a>Pool结构体的方法</h3><ul>
<li>Put方法将对象添加到Pool中<ul>
<li>pin函数将当前goroutine绑定到指定的调度器P上，同时禁止抢占，返回poolLocal对象和绑定的Pid</li>
<li>从Pool的local中获取调度器P的poolLocal，没有需要新建<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Put</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> &#123; <span class="comment">// 放入的对象为空，直接返回</span></div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123; <span class="comment">// 关闭竞争检测</span></div><div class="line">		<span class="keyword">if</span> fastrand()%<span class="number">4</span> == <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// Randomly drop x on floor.</span></div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		race.ReleaseMerge(poolRaceAddr(x))</div><div class="line">		race.Disable() <span class="comment">// 关闭操作</span></div><div class="line">	&#125;</div><div class="line">	l, _ := p.pin()</div><div class="line">  <span class="comment">// 私有空间为空，则将x放置到私有空间</span></div><div class="line">	<span class="keyword">if</span> l.private == <span class="literal">nil</span> &#123;</div><div class="line">		l.private = x</div><div class="line">		x = <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 私有空间已满，则将x放到公有空间中</span></div><div class="line">	<span class="keyword">if</span> x != <span class="literal">nil</span> &#123;</div><div class="line">		l.shared.pushHead(x)</div><div class="line">	&#125;</div><div class="line">	runtime_procUnpin()</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">pin</span><span class="params">()</span> <span class="params">(*poolLocal, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	pid := runtime_procPin() <span class="comment">// 关闭抢占，这个goroutine工作完才释放时间片</span></div><div class="line"></div><div class="line">	s := atomic.LoadUintptr(&amp;p.localSize) <span class="comment">// load-acquire</span></div><div class="line">	l := p.local                          <span class="comment">// load-consume</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(pid) &lt; s &#123; <span class="comment">// 如果p.local的长度大于pid，则直接取数据即可</span></div><div class="line">		<span class="keyword">return</span> indexLocal(l, pid), pid</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// pinSlow函数来完成p.local的新增</span></div><div class="line">	<span class="keyword">return</span> p.pinSlow()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexLocal</span><span class="params">(l unsafe.Pointer, i <span class="keyword">int</span>)</span> *<span class="title">poolLocal</span></span> &#123;</div><div class="line">	lp := unsafe.Pointer(<span class="keyword">uintptr</span>(l) + <span class="keyword">uintptr</span>(i)*unsafe.Sizeof(poolLocal&#123;&#125;))</div><div class="line">	<span class="keyword">return</span> (*poolLocal)(lp)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">pinSlow</span><span class="params">()</span> <span class="params">(*poolLocal, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">  <span class="comment">// 尝试重新将goroutine绑定到其他的goroutine,查看是否有poolLocal使用</span></div><div class="line">	runtime_procUnpin()</div><div class="line">	allPoolsMu.Lock()</div><div class="line">	<span class="keyword">defer</span> allPoolsMu.Unlock()</div><div class="line">	pid := runtime_procPin()</div><div class="line">	<span class="comment">// poolCleanup won't be called while we are pinned.</span></div><div class="line">	s := p.localSize</div><div class="line">	l := p.local</div><div class="line">  <span class="comment">// 新绑定的P有poolLocal空间，则直接获取返回</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(pid) &lt; s &#123;</div><div class="line">		<span class="keyword">return</span> indexLocal(l, pid), pid</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// Pool为空，则将pool添加到allPools中</span></div><div class="line">	<span class="keyword">if</span> p.local == <span class="literal">nil</span> &#123;</div><div class="line">		allPools = <span class="built_in">append</span>(allPools, p)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 创建一个cpu数量大小的[]poolLocal并返回</span></div><div class="line">	size := runtime.GOMAXPROCS(<span class="number">0</span>)</div><div class="line">	local := <span class="built_in">make</span>([]poolLocal, size)</div><div class="line">	atomic.StorePointer(&amp;p.local, unsafe.Pointer(&amp;local[<span class="number">0</span>])) <span class="comment">// store-release</span></div><div class="line">	atomic.StoreUintptr(&amp;p.localSize, <span class="keyword">uintptr</span>(size))         <span class="comment">// store-release</span></div><div class="line">	<span class="keyword">return</span> &amp;local[pid], pid</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h4 id="Get方法"><a href="#Get方法" class="headerlink" title="Get方法"></a>Get方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Get</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">  <span class="comment">// 关闭竞争检测</span></div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 将goroutine固定到P上，并获取其localPool和pid</span></div><div class="line">	l, pid := p.pin()</div><div class="line">	x := l.private</div><div class="line">	l.private = <span class="literal">nil</span></div><div class="line">  <span class="comment">// localPool的私有空间为空，则从共享头空间中pop数据</span></div><div class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">// Try to pop the head of the local shard. We prefer</span></div><div class="line">		<span class="comment">// the head over the tail for temporal locality of</span></div><div class="line">		<span class="comment">// reuse.</span></div><div class="line">		x, _ = l.shared.popHead()</div><div class="line">		<span class="keyword">if</span> x == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="comment">// pop数据为空，则调用getSlow方法来获取</span></div><div class="line">			x = p.getSlow(pid)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	runtime_procUnpin()</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">		<span class="keyword">if</span> x != <span class="literal">nil</span> &#123;</div><div class="line">			race.Acquire(poolRaceAddr(x))</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 如果没有获取到，则调用pool的New函数来完成创建</span></div><div class="line">	<span class="keyword">if</span> x == <span class="literal">nil</span> &amp;&amp; p.New != <span class="literal">nil</span> &#123;</div><div class="line">		x = p.New()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> x</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 懒获取</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">getSlow</span><span class="params">(pid <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">  <span class="comment">// 获取Pool的localSize和local</span></div><div class="line">	size := atomic.LoadUintptr(&amp;p.localSize) <span class="comment">// load-acquire</span></div><div class="line">	locals := p.local                        <span class="comment">// load-consume</span></div><div class="line">  <span class="comment">// 遍历其他调度器的polLocal,看起poptail中是否可以取出对象</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(size); i++ &#123;</div><div class="line">		l := indexLocal(locals, (pid+i+<span class="number">1</span>)%<span class="keyword">int</span>(size))</div><div class="line">		<span class="keyword">if</span> x, _ := l.shared.popTail(); x != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> x</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 到pool的victim中查询</span></div><div class="line">	size = atomic.LoadUintptr(&amp;p.victimSize)</div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(pid) &gt;= size &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	locals = p.victim</div><div class="line">	l := indexLocal(locals, pid)</div><div class="line">  <span class="comment">// 私有空间有直接返回</span></div><div class="line">	<span class="keyword">if</span> x := l.private; x != <span class="literal">nil</span> &#123;</div><div class="line">		l.private = <span class="literal">nil</span></div><div class="line">		<span class="keyword">return</span> x</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 遍历victim中其他调度的poolLocal，看是否可以通过popTail获取到对象</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(size); i++ &#123;</div><div class="line">		l := indexLocal(locals, (pid+i)%<span class="keyword">int</span>(size))</div><div class="line">		<span class="keyword">if</span> x, _ := l.shared.popTail(); x != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> x</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 没有查到，编辑victim为空，下次就不查找victim</span></div><div class="line">	atomic.StoreUintptr(&amp;p.victimSize, <span class="number">0</span>)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/18/golang/源码解读/sync/waitGroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/18/golang/源码解读/sync/waitGroup/" itemprop="url">go源码解读-sync.WaitGroup</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-18T18:00:40+08:00">
                2020-05-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="WaitGroup"><a href="#WaitGroup" class="headerlink" title="WaitGroup"></a>WaitGroup</h2><ul>
<li>WaitGroup结构体会等待一组goroutines结束</li>
<li>Add方法会设置等待的goroutine的数量</li>
<li>goroutine结束之后调用done即可</li>
<li>WaitGroup可以用于所有线程都结束之后才执行的逻辑</li>
<li>使用之后不可以再复制</li>
<li>state1为64位结构的值<ul>
<li>高位的32位为计数器</li>
<li>低位的32位为等待线程数</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WaitGroup <span class="keyword">struct</span> &#123;</div><div class="line">	noCopy noCopy <span class="comment">// 第一次使用之后，不可以用copy函数进行复制</span></div><div class="line">	state1 [<span class="number">3</span>]<span class="keyword">uint32</span> <span class="comment">// 计数器，高4个字节记录要等待的线程总数，低位4个字节记录还需要等待完成的线程数量</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="state方法"><a href="#state方法" class="headerlink" title="state方法"></a>state方法</h3><ul>
<li>state方法返回计数和信号量的地址</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">state</span><span class="params">()</span> <span class="params">(statep *<span class="keyword">uint64</span>, semap *<span class="keyword">uint32</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(unsafe.Pointer(&amp;wg.state1))%<span class="number">8</span> == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> (*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;wg.state1)), &amp;wg.state1[<span class="number">2</span>]</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> (*<span class="keyword">uint64</span>)(unsafe.Pointer(&amp;wg.state1[<span class="number">1</span>])), &amp;wg.state1[<span class="number">0</span>]</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Add方法"><a href="#Add方法" class="headerlink" title="Add方法"></a>Add方法</h3><ul>
<li>Add方法添加计数的goroutine数到wg中</li>
<li>添加完计数器变为0，所有的阻塞的线程会被释放</li>
<li>添加完计数器为负数，会panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Add</span><span class="params">(delta <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="comment">// 获取当前计数和信号量的地址</span></div><div class="line">	statep, semap := wg.state()</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = *statep <span class="comment">// trigger nil deref early</span></div><div class="line">		<span class="keyword">if</span> delta &lt; <span class="number">0</span> &#123;</div><div class="line">			race.ReleaseMerge(unsafe.Pointer(wg))</div><div class="line">		&#125;</div><div class="line">		race.Disable()</div><div class="line">		<span class="keyword">defer</span> race.Enable()</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// 高32位来进行计数器的CAS加法</span></div><div class="line">	state := atomic.AddUint64(statep, <span class="keyword">uint64</span>(delta)&lt;&lt;<span class="number">32</span>)</div><div class="line">    <span class="comment">// 当前需要等待的线总数</span></div><div class="line">	v := <span class="keyword">int32</span>(state &gt;&gt; <span class="number">32</span>)</div><div class="line">    <span class="comment">// 获取需要等待结束的线程数</span></div><div class="line">	w := <span class="keyword">uint32</span>(state)</div><div class="line">	<span class="keyword">if</span> race.Enabled &amp;&amp; delta &gt; <span class="number">0</span> &amp;&amp; v == <span class="keyword">int32</span>(delta) &#123;</div><div class="line">		race.Read(unsafe.Pointer(semap))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> v &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"sync: negative WaitGroup counter"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> w != <span class="number">0</span> &amp;&amp; delta &gt; <span class="number">0</span> &amp;&amp; v == <span class="keyword">int32</span>(delta) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"sync: WaitGroup misuse: Add called concurrently with Wait"</span>)</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// v或者w为0直接返回即可</span></div><div class="line">	<span class="keyword">if</span> v &gt; <span class="number">0</span> || w == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">    <span class="comment">// Add和Wait同步发生，此时会报错</span></div><div class="line">	<span class="keyword">if</span> *statep != state &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"sync: WaitGroup misuse: Add called concurrently with Wait"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    <span class="comment">// 将等待完成的线程数设置为0，逐一释放之前等待的线程</span></div><div class="line">	*statep = <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> ; w != <span class="number">0</span>; w-- &#123;</div><div class="line">		runtime_Semrelease(semap, <span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Done方法"><a href="#Done方法" class="headerlink" title="Done方法"></a>Done方法</h3><ul>
<li>Done方法完成counter–</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Done</span><span class="params">()</span></span> &#123;</div><div class="line">	wg.Add(<span class="number">-1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Wait方法"><a href="#Wait方法" class="headerlink" title="Wait方法"></a>Wait方法</h3><ul>
<li>Wait方法完成线程阻塞，直到counter为0</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(wg *WaitGroup)</span> <span class="title">Wait</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 获取计数器和信号量的地址</span></div><div class="line">	statep, semap := wg.state()</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = *statep <span class="comment">// trigger nil deref early</span></div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line">    <span class="comment">// 循环等待counter为0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		state := atomic.LoadUint64(statep)</div><div class="line">      <span class="comment">// 获取counter和waiter的值</span></div><div class="line">		v := <span class="keyword">int32</span>(state &gt;&gt; <span class="number">32</span>)</div><div class="line">		w := <span class="keyword">uint32</span>(state)</div><div class="line">		<span class="keyword">if</span> v == <span class="number">0</span> &#123;</div><div class="line">        <span class="comment">// 如果counter为0，则直接返回，进行后续操作</span></div><div class="line">			<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">				race.Enable()</div><div class="line">				race.Acquire(unsafe.Pointer(wg))</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		  <span class="comment">// 否则waiter计数++</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapUint64(statep, state, state+<span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">if</span> race.Enabled &amp;&amp; w == <span class="number">0</span> &#123;</div><div class="line">				race.Write(unsafe.Pointer(semap))</div><div class="line">			&#125;</div><div class="line">        <span class="comment">// 排队休眠，等待信号量唤醒</span></div><div class="line">			runtime_Semacquire(semap)</div><div class="line">        <span class="comment">// 休眠过程中，wg被重用会导致state不一致，从而panic</span></div><div class="line">			<span class="keyword">if</span> *statep != <span class="number">0</span> &#123;</div><div class="line">				<span class="built_in">panic</span>(<span class="string">"sync: WaitGroup is reused before previous Wait has returned"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">				race.Enable()</div><div class="line">				race.Acquire(unsafe.Pointer(wg))</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/18/golang/源码解读/sync/rwmutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/18/golang/源码解读/sync/rwmutex/" itemprop="url">go源码解读-sync.RWMutex</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-18T17:02:27+08:00">
                2020-05-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RWMutex"><a href="#RWMutex" class="headerlink" title="RWMutex"></a>RWMutex</h2><ul>
<li>RWMutex是一个互斥读写锁</li>
<li>可以被多个读线程持有或者被一个写线程持有</li>
<li>零值为未上锁的mutex</li>
<li>第一次使用之后不可复制</li>
<li>多个线程的读取操作不会被阻塞，读写，写读，读读会被阻塞</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RWMutex <span class="keyword">struct</span> &#123;</div><div class="line">	w           Mutex  <span class="comment">// 互斥量</span></div><div class="line">	writerSem   <span class="keyword">uint32</span> <span class="comment">// 写阻塞等待的信号量，最后一个读线程释放锁时会释放信号量</span></div><div class="line">	readerSem   <span class="keyword">uint32</span> <span class="comment">// 读阻塞等待信号量，持有写锁的线程完成释放锁后释放的信号量</span></div><div class="line">	readerCount <span class="keyword">int32</span>  <span class="comment">// 记录读者的数量</span></div><div class="line">	readerWait  <span class="keyword">int32</span>  <span class="comment">// 记录写阻塞时读者的个数</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RWMutex的方法"><a href="#RWMutex的方法" class="headerlink" title="RWMutex的方法"></a>RWMutex的方法</h3><ul>
<li>RLock方法完成读锁的加锁，如果是个写线程请求锁将会被阻塞</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RLock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = rw.w.state</div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 完成当前持有该锁的读者的个数的+1，如果没有持有该锁的读线程，则会唤醒等待中的写信号量</span></div><div class="line">	<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerCount, <span class="number">1</span>) &lt; <span class="number">0</span> &#123;</div><div class="line">		runtime_SemacquireMutex(&amp;rw.readerSem, <span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>RUnlock方法完成读锁的解锁操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RUnlock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = rw.w.state</div><div class="line">		race.ReleaseMerge(unsafe.Pointer(&amp;rw.writerSem))</div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> r := atomic.AddInt32(&amp;rw.readerCount, <span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">if</span> r+<span class="number">1</span> == <span class="number">0</span> || r+<span class="number">1</span> == -rwmutexMaxReaders &#123;</div><div class="line">			race.Enable()</div><div class="line">			throw(<span class="string">"sync: RUnlock of unlocked RWMutex"</span>)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// A writer is pending.</span></div><div class="line">		<span class="keyword">if</span> atomic.AddInt32(&amp;rw.readerWait, <span class="number">-1</span>) == <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// The last reader unblocks the writer.</span></div><div class="line">			runtime_Semrelease(&amp;rw.writerSem, <span class="literal">false</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Lock完成写锁的加锁</li>
<li>写锁实际上是加到w中的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = rw.w.state</div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// First, resolve competition with other writers.</span></div><div class="line">	rw.w.Lock()</div><div class="line">	<span class="comment">// Announce to readers there is a pending writer.</span></div><div class="line">	r := atomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders</div><div class="line">	<span class="comment">// Wait for active readers.</span></div><div class="line">	<span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; atomic.AddInt32(&amp;rw.readerWait, r) != <span class="number">0</span> &#123;</div><div class="line">		runtime_SemacquireMutex(&amp;rw.writerSem, <span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">		race.Acquire(unsafe.Pointer(&amp;rw.readerSem))</div><div class="line">		race.Acquire(unsafe.Pointer(&amp;rw.writerSem))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Unlock方法完成写锁的解锁</li>
<li>逻辑与Mutex的解锁是一致的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = rw.w.state</div><div class="line">		race.Release(unsafe.Pointer(&amp;rw.readerSem))</div><div class="line">		race.Disable()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Announce to readers there is no active writer.</span></div><div class="line">	r := atomic.AddInt32(&amp;rw.readerCount, rwmutexMaxReaders)</div><div class="line">	<span class="keyword">if</span> r &gt;= rwmutexMaxReaders &#123;</div><div class="line">		race.Enable()</div><div class="line">		throw(<span class="string">"sync: Unlock of unlocked RWMutex"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Unblock blocked readers, if any.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="keyword">int</span>(r); i++ &#123;</div><div class="line">		runtime_Semrelease(&amp;rw.readerSem, <span class="literal">false</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Allow other writers to proceed.</span></div><div class="line">	rw.w.Unlock()</div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Enable()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>封装了专门的读锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// RLocker returns a Locker interface that implements</span></div><div class="line"><span class="comment">// the Lock and Unlock methods by calling rw.RLock and rw.RUnlock.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span> <span class="title">RLocker</span><span class="params">()</span> <span class="title">Locker</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> (*rlocker)(rw)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> rlocker RWMutex</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rlocker)</span> <span class="title">Lock</span><span class="params">()</span></span>   &#123; (*RWMutex)(r).RLock() &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *rlocker)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123; (*RWMutex)(r).RUnlock() &#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/18/golang/源码解读/sync/cond/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/18/golang/源码解读/sync/cond/" itemprop="url">go源码解读-sync.Cond</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-18T17:00:16+08:00">
                2020-05-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Cond"><a href="#Cond" class="headerlink" title="Cond"></a>Cond</h2><ul>
<li>Cond结构体如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Cond <span class="keyword">struct</span> &#123;</div><div class="line">	noCopy noCopy <span class="comment">// noCopy保证Cond第一次被使用之后不能被copy复制</span></div><div class="line">	L Locker <span class="comment">// L为获取Cond的值或者改变Cond的值的时候需要获取的锁</span></div><div class="line">	notify  notifyList <span class="comment">// notifyList记录Cond将要通知的信号量列表</span></div><div class="line">	checker copyChecker <span class="comment">// 用于检查copy复制的状态</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCond</span><span class="params">(l Locker)</span> *<span class="title">Cond</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Cond&#123;L: l&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> noCopy <span class="keyword">struct</span>&#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*noCopy)</span> <span class="title">Lock</span><span class="params">()</span></span>   &#123;&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*noCopy)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> copyChecker <span class="keyword">uintptr</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *copyChecker)</span> <span class="title">check</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(*c) != <span class="keyword">uintptr</span>(unsafe.Pointer(c)) &amp;&amp;</div><div class="line">		!atomic.CompareAndSwapUintptr((*<span class="keyword">uintptr</span>)(c), <span class="number">0</span>, <span class="keyword">uintptr</span>(unsafe.Pointer(c))) &amp;&amp;</div><div class="line">		<span class="keyword">uintptr</span>(*c) != <span class="keyword">uintptr</span>(unsafe.Pointer(c)) &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"sync.Cond is copied"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Cond实现的方法"><a href="#Cond实现的方法" class="headerlink" title="Cond实现的方法"></a>Cond实现的方法</h2><ul>
<li>Wait方法会对c.L进行解锁，并挂起当前执行的线程，之后当前线程的执行</li>
<li>Wait操作实际上是会释放当前线程的锁，进入等待队列，等待被唤醒</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cond)</span> <span class="title">Wait</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 检查是否被复制</span></div><div class="line">	c.checker.check()</div><div class="line">  <span class="comment">// 将当前线程加入到等待队列中</span></div><div class="line">	t := runtime_notifyListAdd(&amp;c.notify)</div><div class="line">  <span class="comment">// 解锁</span></div><div class="line">  c.L.Unlock()</div><div class="line">  <span class="comment">// 等待锁</span></div><div class="line">	runtime_notifyListWait(&amp;c.notify, t)</div><div class="line">  <span class="comment">// 加锁继续执行</span></div><div class="line">  c.L.Lock()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 将调用线程加入到等待队列中</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">notifyListAdd</span><span class="params">(l *notifyList)</span> <span class="title">uint32</span></span> &#123;</div><div class="line">	<span class="comment">// This may be called concurrently, for example, when called from</span></div><div class="line">	<span class="comment">// sync.Cond.Wait while holding a RWMutex in read mode.</span></div><div class="line">	<span class="keyword">return</span> atomic.Xadd(&amp;l.wait, <span class="number">1</span>) - <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Signal将会唤醒一个等待c的线程</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cond)</span> <span class="title">Signal</span><span class="params">()</span></span> &#123;</div><div class="line"> c.checker.check()</div><div class="line"> runtime_notifyListNotifyOne(&amp;c.notify)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Broadcast将会唤醒所有等待c的线程</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Cond)</span> <span class="title">Broadcast</span><span class="params">()</span></span> &#123;</div><div class="line">	c.checker.check()</div><div class="line">	runtime_notifyListNotifyAll(&amp;c.notify)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestCondSignal</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> m sync.Mutex</div><div class="line">	c := sync.NewCond(&amp;m)</div><div class="line">	n := <span class="number">10</span></div><div class="line">	running := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, n)</div><div class="line">	awake := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, n)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			m.Lock()</div><div class="line">			running &lt;- <span class="literal">true</span></div><div class="line">			t.Logf(<span class="string">"goroutine %d is waiting \n"</span>, i+<span class="number">1</span>)</div><div class="line">			c.Wait()</div><div class="line">			awake &lt;- <span class="literal">true</span></div><div class="line">			t.Logf(<span class="string">"goroutine %d is awake\n"</span>, i+<span class="number">1</span>)</div><div class="line">			m.Unlock()</div><div class="line">		&#125;(i)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		&lt;-running <span class="comment">// Wait for everyone to run.</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> n &gt; <span class="number">5</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> &lt;-awake:</div><div class="line">			t.Fatal(<span class="string">"goroutine not asleep"</span>)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		&#125;</div><div class="line">		m.Lock()</div><div class="line">		c.Signal()</div><div class="line">		m.Unlock()</div><div class="line">		&lt;-awake <span class="comment">// Will deadlock if no goroutine wakes up</span></div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> &lt;-awake:</div><div class="line">			t.Fatal(<span class="string">"too many goroutines awake"</span>)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">		&#125;</div><div class="line">		n--</div><div class="line">	&#125;</div><div class="line">	c.Signal()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">=== RUN   TestCondSignal</span></div><div class="line"><span class="comment">--- PASS: TestCondSignal (0.00s)</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 10 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 3 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 1 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 8 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 2 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 7 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 9 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 4 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 5 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:18: goroutine 6 is waiting</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 10 is awake</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 3 is awake</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 1 is awake</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 8 is awake</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 2 is awake</span></div><div class="line"><span class="comment">    cond_test.go:21: goroutine 7 is awake</span></div><div class="line"><span class="comment">PASS</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/13/k8s/k8s简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/13/k8s/k8s简介/" itemprop="url">kubernates简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-13T14:26:16+08:00">
                2020-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernates/" itemprop="url" rel="index">
                    <span itemprop="name">kubernates</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernates/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernates/go/docker/" itemprop="url" rel="index">
                    <span itemprop="name">docker</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Kubernates"><a href="#Kubernates" class="headerlink" title="Kubernates"></a>Kubernates</h2><ul>
<li>Kubernates需要使用k8s API对象来完成对集群的操作，包括但不限于运行程序，使用容器镜像，设定备份，设置网络和磁盘配置。完成这些操作需要使用k8s API来创建对象来实现，通常是通过命令行命令kubectl。同样也可以使用k8s API与集群直接交互。</li>
<li>当你设定了你想要的集群状态之后，Kubernates Control Plane会通过Pod Lifecycle Event Generator来完成集群当前状态到预期状态的转变，</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/13/golang/源码解读/sync/mutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/13/golang/源码解读/sync/mutex/" itemprop="url">go源码解读-sync.Mutex</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-13T10:10:06+08:00">
                2020-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Mutex"><a href="#Mutex" class="headerlink" title="Mutex"></a>Mutex</h2><ul>
<li>sync包提供了互斥量，Once, WaitGroup来保证多线程并发安全</li>
<li>比较简单的同步通过sync包，比较复杂的同步建议通过channel来实现</li>
</ul>
<h3 id="Mutex结构体"><a href="#Mutex结构体" class="headerlink" title="Mutex结构体"></a>Mutex结构体</h3><ul>
<li>Mutex实际上是互斥锁</li>
<li>Mutex的初始化状态就是一个没加锁的互斥锁</li>
<li>Mutex在被加锁之后不允许被复制，也就是带有状态的Mutex不能被复制，否则会给原来的临界数据复制出一把锁</li>
<li>Mutex包含两个字段<ul>
<li>state</li>
<li>sema</li>
</ul>
</li>
<li>Mutex现在有两种状态，normal和starvation<ul>
<li>normal状态下，goroutine是在一个FIFO的队列中排队等待锁的，也就是按照锁的请求时间依次获取锁。但是被唤醒的goroutine并不会立刻拥有mutex，而是需要与新到达的goroutine进行竞争，由于新到达的goroutine已经加载在内存中，所以被唤醒的goroutine大概率会竞争失败，竞争失败之后被唤醒的goroutine会被防止到FIFO的队首。如果一个被唤醒的goroutine在1ms内获取mutex失败，则mutex状态设置为starvation</li>
<li>starvation状态下，mutex在被当前持有的线程解锁之后，FIFO队列首的goroutine被唤醒并直接拥有改mutex，新到达的goroutine不再尝试获取mutex,也不再自选等待获取锁，而是直接排到队列的队尾</li>
<li>如果一个goroutine获取到mutex，如果这个goroutine是队列中的最后一个goroutine或者goroutine等待时间小于1ms，则mutex状态变为noraml状态</li>
<li>normal状态下性能更好，starvation状态下更加公平，不存在插队和多次获取的情况</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</div><div class="line">	state <span class="keyword">int32</span></div><div class="line">	sema  <span class="keyword">uint32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	mutexLocked = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span>      <span class="comment">// 锁定状态 001</span></div><div class="line">	mutexWoken                   <span class="comment">// 唤醒状态 010</span></div><div class="line">	mutexStarving                <span class="comment">// 饥饿状态 100</span></div><div class="line">	mutexWaiterShift = <span class="literal">iota</span>      <span class="comment">// 向右偏移3位之后的值记录等待该mutex的goroutine数量</span></div><div class="line">	starvationThresholdNs = <span class="number">1e6</span>  <span class="comment">// normal到starvation状态的阈值 1ms</span></div><div class="line">)</div></pre></td></tr></table></figure>
<h3 id="Mutex实现了Locker接口"><a href="#Mutex实现了Locker接口" class="headerlink" title="Mutex实现了Locker接口"></a>Mutex实现了Locker接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Locker <span class="keyword">interface</span> &#123;</div><div class="line">	Lock()</div><div class="line">	Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>lock方法对mutex加锁</li>
<li>如果mutex已经被加锁，尝试加锁的goroutine将会被阻塞直到获取到该锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Lock</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 如果mutex没有被加过锁,则用原子方法CAS修改mutex的状态为mutexLocked，直接返回结果即可</span></div><div class="line">	<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</div><div class="line">		<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">			race.Acquire(unsafe.Pointer(m))</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> waitStartTime <span class="keyword">int64</span></div><div class="line">	starving := <span class="literal">false</span></div><div class="line">	awoke := <span class="literal">false</span></div><div class="line">	iter := <span class="number">0</span></div><div class="line">	old := m.state</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 如果当前mutex的状态为starvation，则当前线程不再自旋等待mutex</span></div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</div><div class="line">			<span class="comment">// Active spinning makes sense.</span></div><div class="line">			<span class="comment">// Try to set mutexWoken flag to inform Unlock</span></div><div class="line">			<span class="comment">// to not wake other blocked goroutines.</span></div><div class="line">      <span class="comment">// awork为false,mutex为非awoke状态，有等待状态的goroutine且CAS更改awoke位成功，则将awoke设置为true</span></div><div class="line">			<span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</div><div class="line">				atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</div><div class="line">				awoke = <span class="literal">true</span></div><div class="line">			&#125;</div><div class="line">      <span class="comment">// 实际的自旋等待操作，更新iter和old的值</span></div><div class="line">			runtime_doSpin()</div><div class="line">			iter++</div><div class="line">			old = m.state</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="built_in">new</span> := old</div><div class="line">    <span class="comment">// 如果mutex为starvation状态的话，当前的goroutine需要去队列中排队</span></div><div class="line">		<span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexLocked</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 当前goroutine为starvation状态并且为非锁定状态，设置mutex状态为starvation</span></div><div class="line">		<span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</div><div class="line">			<span class="built_in">new</span> |= mutexStarving</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// awoke为true,在等待队列中唤醒一个goroutine</span></div><div class="line">		<span class="keyword">if</span> awoke &#123;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</div><div class="line">				throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="built_in">new</span> &amp;^= mutexWoken</div><div class="line">		&#125;</div><div class="line">    <span class="comment">// 将新的mutex状态值通过CAS复制给state</span></div><div class="line">		<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">      <span class="comment">// 如果old的状态为000，则直接退出，已经完成了上锁操作</span></div><div class="line">			<span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span> <span class="comment">// locked the mutex with CAS</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// If we were already waiting before, queue at the front of the queue.</span></div><div class="line">			queueLifo := waitStartTime != <span class="number">0</span></div><div class="line">			<span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</div><div class="line">				waitStartTime = runtime_nanotime()</div><div class="line">			&#125;</div><div class="line">      <span class="comment">// 阻塞获取mutex，这个地方会一直阻塞，直到获取到mutex锁</span></div><div class="line">			runtime_SemacquireMutex(&amp;m.sema, queueLifo)</div><div class="line">      <span class="comment">// 获取到锁之后，根据获取锁的等待时间，设置mutex的运行状态是否为starvation</span></div><div class="line">			starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</div><div class="line">			old = m.state</div><div class="line">      <span class="comment">// 设置mutex的starvation状态</span></div><div class="line">			<span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</div><div class="line">					throw(<span class="string">"sync: inconsistent mutex state"</span>)</div><div class="line">				&#125;</div><div class="line">				delta := <span class="keyword">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</div><div class="line">				<span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</div><div class="line">					delta -= mutexStarving</div><div class="line">				&#125;</div><div class="line">				atomic.AddInt32(&amp;m.state, delta)</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			awoke = <span class="literal">true</span></div><div class="line">			iter = <span class="number">0</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		race.Acquire(unsafe.Pointer(m))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// runtime包中的，返回当前时刻自旋等待是否有意义</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">runtime_canSpin</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">bool</span></span></div></pre></td></tr></table></figure>
<ul>
<li>Unlock完成解锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span> <span class="title">Unlock</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 快速解锁</span></div><div class="line">	<span class="keyword">if</span> race.Enabled &#123;</div><div class="line">		_ = m.state</div><div class="line">		race.Release(unsafe.Pointer(m))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 快速重置mutexLocked位置为0，完成之后很可能被其他goroutine抢走锁</span></div><div class="line">	<span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</div><div class="line">	<span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</div><div class="line">		throw(<span class="string">"sync: unlock of unlocked mutex"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 如果mutex为normal状态，走stravtion分支即可</span></div><div class="line">	<span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</div><div class="line">		old := <span class="built_in">new</span></div><div class="line">		<span class="keyword">for</span> &#123;</div><div class="line">      <span class="comment">// 如果没有等待的goroutine，直接返回即可</span></div><div class="line">			<span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 有等待的goroutine，则会减少等待数量并且唤醒一个goroutine进行竞争mutex</span></div><div class="line">			<span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</div><div class="line">			<span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</div><div class="line">				runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>)</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;</div><div class="line">			old = m.state</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// starvation分支直接将mutex交给FIFO队列首部的goroutine</span></div><div class="line">    <span class="comment">// 通过runtime_Semrelease唤醒等待的goroutine</span></div><div class="line">		runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/goroutine&channel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/goroutine&channel/" itemprop="url">goroutine&channel学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T17:37:17+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="goroutine-amp-channel"><a href="#goroutine-amp-channel" class="headerlink" title="goroutine &amp; channel"></a>goroutine &amp; channel</h2><ul>
<li>不需要共享内存来通信，而是通过通信来共享内存。</li>
</ul>
<h3 id="1-channel关键的概念总结"><a href="#1-channel关键的概念总结" class="headerlink" title="1. channel关键的概念总结"></a>1. channel关键的概念总结</h3><ul>
<li>通道（channel），就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。 数据的所有权（可以读写数据的能力）也因此被传递。</li>
<li>channel零值nil</li>
<li>channel只能传递一种类型的数据</li>
<li>channel实际上是类型化消息的队列，使数据得以传输。它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</li>
<li>channel是引用类型，make来初始化 <code>ch1 := make(chan string)</code></li>
<li>通信操作符<code>&lt;-</code><ul>
<li><code>ch &lt;-int1</code> 写入</li>
<li><code>int2 := &lt;- ch</code> 写出</li>
<li><code>&lt;-ch</code> 写出</li>
</ul>
</li>
<li><p>channel的收发都是原子操作</p>
</li>
<li><p>channel默认是同步且无缓冲的：接收者接收数据之前，发送不会结束。channel的发送和接收操作都是在对方准备好之前是阻塞的</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump(ch1)       <span class="comment">// pump hangs</span></div><div class="line">    fmt.Println(&lt;-ch1) <span class="comment">// prints only 0</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 0</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="2-通过channel进行协程同步"><a href="#2-通过channel进行协程同步" class="headerlink" title="2. 通过channel进行协程同步"></a>2. 通过channel进行协程同步</h3><pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Println(&lt;-in)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    out &lt;- <span class="number">2</span></div><div class="line">    <span class="keyword">go</span> f1(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><h3 id="3-channel可以用来完成协程间的通信"><a href="#3-channel可以用来完成协程间的通信" class="headerlink" title="3. channel可以用来完成协程间的通信"></a>3. channel可以用来完成协程间的通信</h3><ul>
<li><code>ch1 := make(chan string, buf)</code> buf为个数</li>
<li>在缓冲满载之前，给通道发送数据是不会被阻塞的</li>
<li>在缓冲空之前，读取是不会阻塞的</li>
<li>协程通过在channel中放置一个值来发出处理结束的信号</li>
<li><p>信号量是实现互斥锁常见的同步机制</p>
<ul>
<li>带缓冲通道的容量和要同步的资源容量相同</li>
<li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li>
<li><p>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    stream := pump()</div><div class="line">    <span class="keyword">go</span> suck(stream)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(&lt;-ch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>channel可以用for关键字循环</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    suck(pump())</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>channel可以指定数据流动方向</p>
<ul>
<li>只接收：<code>var recv_noly &lt;-chan int</code></li>
<li>只发送：<code>var send_only chan&lt;- int</code></li>
</ul>
</li>
<li><p>channel关闭 <code>defer close(ch)</code></p>
</li>
<li><p>使用select切换协程,select 被称为通信开关,select可以处理多个通信中的一个</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump1(ch1)</div><div class="line">    <span class="keyword">go</span> pump2(ch2)</div><div class="line">    <span class="keyword">go</span> suck(ch1, ch2)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i * <span class="number">2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i + <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch1, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch1:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 1: %d\n"</span>, v)</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch2:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 2: %d\n"</span>, v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>goroutine recover机制，保证一个协程出错会继续执行其他的协程</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(workChan &lt;-<span class="keyword">chan</span> *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> work := <span class="keyword">range</span> workChan &#123;</div><div class="line">        <span class="keyword">go</span> safelyDo(work)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">safelyDo</span><span class="params">(work *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err := revocer(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">""</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    do(work)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="4-channel通信方式和传统共享内存方式的对比"><a href="#4-channel通信方式和传统共享内存方式的对比" class="headerlink" title="4. channel通信方式和传统共享内存方式的对比"></a>4. channel通信方式和传统共享内存方式的对比</h2><ul>
<li>使用共享内存来进行同步：<ul>
<li>首先定义一个结构体处理一个任务</li>
<li>各个任务组成任务池来共享内存，引入锁机制</li>
<li>任务数量巨大，则锁机制的开销会导致效率急剧下降</li>
</ul>
</li>
<li><p>channel方式</p>
<ul>
<li>使用一个通道接受需要处理的任务，一个通道接受处理完成的任务及其结果。worker在协程中启动，数量N可以调整</li>
<li>不使用锁的机制，因为从通道获取到新任务不存在竞争关系</li>
<li><p>我理解实际上锁机制是实现在了channel中，一个channel的获取是原子性的，从而提高性能</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Worker的写法, Master -&gt; Workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;- in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>使用锁的情景：</p>
<ul>
<li>访问共享数据结构中的缓存信息</li>
<li>保存应用程序上下文和状态信息数据</li>
</ul>
</li>
<li>使用通道的情景<ul>
<li>与异步操作的结果进行交互</li>
<li>分发任务</li>
<li>传递数据所有权</li>
</ul>
</li>
</ul>
<h2 id="5-int-channel实现惰性生成器"><a href="#5-int-channel实现惰性生成器" class="headerlink" title="5. int channel实现惰性生成器"></a>5. int channel实现惰性生成器</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> resume <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">integers</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    yield := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    count := <span class="number">0</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            yield &lt;- count</div><div class="line">            count++</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> yield</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateInteger</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    resume = integers()</div><div class="line">    <span class="keyword">return</span> &lt;- resume</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>使用空接口，闭包和高阶函数可以实现一个通用的惰性生产期的工厂函数</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> EvalFunc <span class="function"><span class="keyword">func</span><span class="params">(Any)</span> <span class="params">(Any, Any)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">BuildLazyEvaluator</span><span class="params">(evalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">    retValChan := <span class="built_in">make</span>(<span class="keyword">chan</span> Any)</div><div class="line">    loopFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">var</span> actState Any = initState</div><div class="line">        <span class="keyword">var</span> retVal</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            retVal, actState = evalFunc(actState)</div><div class="line">            retValChan &lt;- retVal</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    retFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> &lt;- retValChan</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> loopFunc()</div><div class="line">    <span class="keyword">return</span> retFunc</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildLazyIntEvaluator</span><span class="params">(evalFunc EvalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    ef := BuildLazyIntEvaluator(evalFunc, initState)</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> ef().(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    evenFunc := <span class="function"><span class="keyword">func</span><span class="params">(state Any)</span> <span class="params">(Any, Any)</span></span> &#123;</div><div class="line">        os := state.(<span class="keyword">int</span>)</div><div class="line">        ns := os + <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> os, ns</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    even := BuildLazyIntEvaluator(evenFunc, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        fmt.</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="6-带缓冲的channel可以用于降频"><a href="#6-带缓冲的channel可以用于降频" class="headerlink" title="6. 带缓冲的channel可以用于降频"></a>6. 带缓冲的channel可以用于降频</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line"><span class="comment">//    ...</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">    process(r)</div><div class="line">    &lt;- sem</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        request := &lt;- service</div><div class="line">        <span class="keyword">go</span> handler(request)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>链式协程，海量协程的创建和运行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ngoroutine = flag.Int(<span class="string">"n"</span>, <span class="number">100000</span>, <span class="string">"how many goroutines"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;- right</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">var</span> left, right <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="literal">nil</span>, leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *ngoroutine; i++ &#123;</div><div class="line">        left, right = right, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">    &#125;</div><div class="line">    right &lt;- <span class="number">0</span></div><div class="line">    x := &lt;-leftmost</div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="并行化大量数据的计算"><a href="#并行化大量数据的计算" class="headerlink" title="并行化大量数据的计算"></a>并行化大量数据的计算</h2><ul>
<li><p>串行处理流水线</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SerialProcessData</span><span class="params">(in &lt;- <span class="keyword">chan</span> *Data, out <span class="keyword">chan</span> &lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> in &#123;</div><div class="line">        tmpA := PreproceeData(data)</div><div class="line">        tmpB := ProcessStepA(tmpA)</div><div class="line">        tmpC := ProcessStepB(tmpB)</div><div class="line">        out &lt;- PostProcessData(tmpC)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>并行计算</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParallelProcessData</span><span class="params">(in &lt;-<span class="keyword">chan</span> *Data, out <span class="keyword">chan</span>&lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="comment">// make channels:</span></div><div class="line">    preOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepAOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepBOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepCOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    <span class="comment">// start parallel computations:</span></div><div class="line">    <span class="keyword">go</span> PreprocessData(in, preOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepA(preOut,StepAOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepB(StepAOut,StepBOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepC(StepBOut,StepCOut)</div><div class="line">    <span class="keyword">go</span> PostProcessData(StepCOut,out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="8-使用channel并发访问对象"><a href="#8-使用channel并发访问对象" class="headerlink" title="8. 使用channel并发访问对象"></a>8. 使用channel并发访问对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name   <span class="keyword">string</span></div><div class="line">	salary <span class="keyword">float64</span></div><div class="line">	chF    <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, salary <span class="keyword">float64</span>)</span> *<span class="title">Person</span></span> &#123;</div><div class="line">	p := &amp;Person&#123;name, salary, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>)&#125;</span></div><div class="line"><span class="function">	<span class="title">go</span> <span class="title">p</span>.<span class="title">backend</span><span class="params">()</span></span></div><div class="line"><span class="function">	<span class="title">return</span> <span class="title">p</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(p *Person)</span> <span class="title">backend</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> f := <span class="keyword">range</span> p.chF &#123;</div><div class="line">		f()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">SetSalary</span><span class="params">(sal <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; p.salary = sal &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Retrieve salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Salary</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	fChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">float64</span>)</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fChan &lt;- p.salary &#125;</div><div class="line">	<span class="keyword">return</span> &lt;-fChan</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"Person - name is: "</span> + p.Name + <span class="string">" - salary is: "</span> + strconv.FormatFloat(p.Salary(), <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">64</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	bs := NewPerson(<span class="string">"Smith Bill"</span>, <span class="number">2500.5</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">	bs.SetSalary(<span class="number">4000.25</span>)</div><div class="line">	fmt.Println(<span class="string">"Salary changed:"</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/go-interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/go-interface/" itemprop="url">golang interface学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T17:36:31+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>go中的接口使用隐式实现的</li>
<li>LSP里式替换-一个类型可以自由的使用另一个满足相同接口的类型来进行替换</li>
<li>接口类型具体描述了一系列方法的集合，一个实现了这些方法的具体类型时这个接口类型的实例</li>
<li><p>go标准库存在大量的单方法接口的命名习惯</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io</div><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</div><div class="line">    Close() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>接口内嵌，关注的是内嵌的方法，和组合的设计模式思想类似</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReadWriterCloser <span class="keyword">interface</span> &#123;</div><div class="line">    Reader</div><div class="line">    Writer</div><div class="line">    Closer</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>一个类型持有一个方法，对于一个具体类型T，其一些方法的接收者可以是T也可以是T的指针，是因为比那一起隐式的获取了变量的地址。但是实际上T类型的值是不拥有所有*T指针的方法，这样就可能其实现更少的接口</p>
<ul>
<li><p>IntSet类型的String方法的接收者是一个指针类型，则不能在一个不能寻址的IntSet值上调用这个方法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">type IntSet struct &#123;/* ... */&#125;</div><div class="line">func (*IntSet) String() string</div><div class="line">var _ = IntSet&#123;&#125;.String() // compile error : String requires *IntSet receiver</div></pre></td></tr></table></figure>
</li>
<li><p>但是可以在一个IntSet值上调用这个方法</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">var s IntSet</div><div class="line">var _ = s.String() // ok</div></pre></td></tr></table></figure>
</li>
<li><p>同时只有IntSet类型有String类型，也只有IntSet类型实现了fmt.Stringer接口</p>
</li>
</ul>
</li>
<li><p>接口类型封装和隐藏了具体类型和它的值，及时具体类型有其他方法也只有接口类型暴露出来的方法会被调用，也就是说一个具体的类型可以实现很多的接口，在调用的时候看持有这个变量的类型时哪个接口，就可以调用该接口的方法，而其他接口在该类型中实现的方法是被隐藏的。</p>
</li>
<li><p>空接口interface{}可以承接任意的值</p>
</li>
<li><p>每一个具体类型的组基于他们相同的行为可以表示成一个接口类型，不需要修改具体类型的定义，这个地方感觉还是组合的思想</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 出售数字文化产品如音乐，书籍，电影等</span></div><div class="line"><span class="keyword">type</span> Artifact <span class="keyword">interface</span> &#123;</div><div class="line">    Title() <span class="keyword">string</span></div><div class="line">    Creator() []<span class="keyword">string</span></div><div class="line">    Created() time.Time</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Text <span class="keyword">interface</span> &#123;</div><div class="line">    Pages() <span class="keyword">int</span></div><div class="line">    Words() <span class="keyword">int</span></div><div class="line">    PageSize() <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Audio <span class="keyword">interface</span> &#123;</div><div class="line">    Stream() (io.Readerclose, error)</div><div class="line">    RunningTime() time.Duration</div><div class="line">    Format() <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Video <span class="keyword">interface</span> &#123;</div><div class="line">    Stream() (io.ReadCloser, error)</div><div class="line">    RunningTime() time.Duration</div><div class="line">    Format() <span class="keyword">string</span></div><div class="line">    Resolution() (x, y <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="flag-Value接口"><a href="#flag-Value接口" class="headerlink" title="flag.Value接口"></a>flag.Value接口</h2><h3 id="flag-Duration方法"><a href="#flag-Duration方法" class="headerlink" title="flag.Duration方法"></a>flag.Duration方法</h3><ul>
<li>flag可以为程序预设命令行参数，会有一个参数缺省默认值</li>
<li>flag.Duration函数创建一个time.Duration类型的标记变量并且允许用户通过多种用户友好的方式来设置这个值的大小</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> period = flag.Duration(<span class="string">"period"</span>, <span class="number">1</span> * time.Second, <span class="string">"Sleep duration"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	fmt.Printf(<span class="string">"Sleeping for %v..."</span>, *period)</div><div class="line">	time.Sleep(*period)</div><div class="line">	fmt.Println(<span class="string">"end"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>首先看flag.Duration方法，返回的是一个地址指着</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Duration</span><span class="params">(name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span> *<span class="title">time</span>.<span class="title">Duration</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> CommandLine.Duration(name, value, usage)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>然后看CommandLine的结构体和其Duration方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> CommandLine = NewFlagSet(os.Args[<span class="number">0</span>], ExitOnError)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFlagSet</span><span class="params">(name <span class="keyword">string</span>, errorHandling ErrorHandling)</span> *<span class="title">FlagSet</span></span> &#123;</div><div class="line">	f := &amp;FlagSet&#123;</div><div class="line">		name:          name,</div><div class="line">		errorHandling: errorHandling,</div><div class="line">	&#125;</div><div class="line">	f.Usage = f.defaultUsage</div><div class="line">	<span class="keyword">return</span> f</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Duration</span><span class="params">(name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span> *<span class="title">time</span>.<span class="title">Duration</span></span> &#123;</div><div class="line">	p := <span class="built_in">new</span>(time.Duration)</div><div class="line">	f.DurationVar(p, name, value, usage)</div><div class="line">	<span class="keyword">return</span> p</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">DurationVar</span><span class="params">(p *time.Duration, name <span class="keyword">string</span>, value time.Duration, usage <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	f.Var(newDurationValue(value, p), name, usage)</div><div class="line">&#125;</div><div class="line"><span class="comment">// 真正实现值注入的地方</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Var</span><span class="params">(value Value, name <span class="keyword">string</span>, usage <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// Remember the default value as a string; it won't change.</span></div><div class="line">	flag := &amp;Flag&#123;name, usage, value, value.String()&#125;</div><div class="line">	_, alreadythere := f.formal[name]</div><div class="line">	<span class="keyword">if</span> alreadythere &#123;</div><div class="line">		<span class="keyword">var</span> msg <span class="keyword">string</span></div><div class="line">		<span class="keyword">if</span> f.name == <span class="string">""</span> &#123;</div><div class="line">			msg = fmt.Sprintf(<span class="string">"flag redefined: %s"</span>, name)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			msg = fmt.Sprintf(<span class="string">"%s flag redefined: %s"</span>, f.name, name)</div><div class="line">		&#125;</div><div class="line">		fmt.Fprintln(f.Output(), msg)</div><div class="line">		<span class="built_in">panic</span>(msg) <span class="comment">// Happens only if flags are declared with identical names</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> f.formal == <span class="literal">nil</span> &#123;</div><div class="line">		f.formal = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Flag)</div><div class="line">	&#125;</div><div class="line">	f.formal[name] = flag</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上所有的Flag值保存在FlagSet结构体中的formal（map[string] *Flag）中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> FlagSet <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// Usage is the function called when an error occurs while parsing flags.</span></div><div class="line">	Usage <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">	<span class="title">name</span>          <span class="title">string</span></span></div><div class="line"><span class="function">	<span class="title">parsed</span>        <span class="title">bool</span></span></div><div class="line"><span class="function">	<span class="title">actual</span>        <span class="title">map</span>[<span class="title">string</span>]*<span class="title">Flag</span></span></div><div class="line"><span class="function">	<span class="title">formal</span>        <span class="title">map</span>[<span class="title">string</span>]*<span class="title">Flag</span></span></div><div class="line"><span class="function">	<span class="title">args</span>          []<span class="title">string</span> // <span class="title">arguments</span> <span class="title">after</span> <span class="title">flags</span></span></div><div class="line"><span class="function">	<span class="title">errorHandling</span> <span class="title">ErrorHandling</span></span></div><div class="line"><span class="function">	<span class="title">output</span>        <span class="title">io</span>.<span class="title">Writer</span> // <span class="title">nil</span> <span class="title">means</span> <span class="title">stderr</span>; <span class="title">use</span> <span class="title">out</span><span class="params">()</span> <span class="title">accessor</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function">// <span class="title">A</span> <span class="title">Flag</span> <span class="title">represents</span> <span class="title">the</span> <span class="title">state</span> <span class="title">of</span> <span class="title">a</span> <span class="title">flag</span>.</span></div><div class="line"><span class="function"><span class="title">type</span> <span class="title">Flag</span> <span class="title">struct</span></span> &#123;</div><div class="line">	Name     <span class="keyword">string</span> <span class="comment">// name as it appears on command line</span></div><div class="line">	Usage    <span class="keyword">string</span> <span class="comment">// help message</span></div><div class="line">	Value    Value  <span class="comment">// value as set</span></div><div class="line">	DefValue <span class="keyword">string</span> <span class="comment">// default value (as text); for usage message</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Value is the interface to the dynamic value stored in a flag.</span></div><div class="line"><span class="keyword">type</span> Value <span class="keyword">interface</span> &#123;</div><div class="line">	String() <span class="keyword">string</span></div><div class="line">	Set(<span class="keyword">string</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="flag-Parse-方法"><a href="#flag-Parse-方法" class="headerlink" title="flag.Parse()方法"></a>flag.Parse()方法</h3><ul>
<li>首先看Parse()方法的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Ignore errors; CommandLine is set for ExitOnError.</span></div><div class="line">	CommandLine.Parse(os.Args[<span class="number">1</span>:])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// flags初始化默认值之后，flag值使用之前，实际上是从命令行读取参数值对默认值进行覆盖操作</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">Parse</span><span class="params">(arguments []<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	f.parsed = <span class="literal">true</span></div><div class="line">	f.args = arguments</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		seen, err := f.parseOne()</div><div class="line">		<span class="keyword">if</span> seen &#123;</div><div class="line">			<span class="keyword">continue</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">switch</span> f.errorHandling &#123;</div><div class="line">		<span class="keyword">case</span> ContinueOnError:</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		<span class="keyword">case</span> ExitOnError:</div><div class="line">			os.Exit(<span class="number">2</span>)</div><div class="line">		<span class="keyword">case</span> PanicOnError:</div><div class="line">			<span class="built_in">panic</span>(err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *FlagSet)</span> <span class="title">parseOne</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(f.args) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	s := f.args[<span class="number">0</span>]</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) &lt; <span class="number">2</span> || s[<span class="number">0</span>] != <span class="string">'-'</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	numMinuses := <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> s[<span class="number">1</span>] == <span class="string">'-'</span> &#123;</div><div class="line">		numMinuses++</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">2</span> &#123; <span class="comment">// "--" terminates the flags</span></div><div class="line">			f.args = f.args[<span class="number">1</span>:]</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	name := s[numMinuses:]</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(name) == <span class="number">0</span> || name[<span class="number">0</span>] == <span class="string">'-'</span> || name[<span class="number">0</span>] == <span class="string">'='</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"bad flag syntax: %s"</span>, s)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// it's a flag. does it have an argument?</span></div><div class="line">	f.args = f.args[<span class="number">1</span>:]</div><div class="line">	hasValue := <span class="literal">false</span></div><div class="line">	value := <span class="string">""</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="built_in">len</span>(name); i++ &#123; <span class="comment">// equals cannot be first</span></div><div class="line">		<span class="keyword">if</span> name[i] == <span class="string">'='</span> &#123;</div><div class="line">			value = name[i+<span class="number">1</span>:]</div><div class="line">			hasValue = <span class="literal">true</span></div><div class="line">			name = name[<span class="number">0</span>:i]</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	m := f.formal</div><div class="line">	flag, alreadythere := m[name] <span class="comment">// BUG</span></div><div class="line">	<span class="keyword">if</span> !alreadythere &#123;</div><div class="line">		<span class="keyword">if</span> name == <span class="string">"help"</span> || name == <span class="string">"h"</span> &#123; <span class="comment">// special case for nice help message.</span></div><div class="line">			f.usage()</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, ErrHelp</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"flag provided but not defined: -%s"</span>, name)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> fv, ok := flag.Value.(boolFlag); ok &amp;&amp; fv.IsBoolFlag() &#123; <span class="comment">// special case: doesn't need an arg</span></div><div class="line">		<span class="keyword">if</span> hasValue &#123;</div><div class="line">			<span class="keyword">if</span> err := fv.Set(value); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid boolean value %q for -%s: %v"</span>, value, name, err)</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> err := fv.Set(<span class="string">"true"</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid boolean flag %s: %v"</span>, name, err)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="comment">// It must have a value, which might be the next argument.</span></div><div class="line">		<span class="comment">// 在这里进行解析替换</span></div><div class="line">		<span class="keyword">if</span> !hasValue &amp;&amp; <span class="built_in">len</span>(f.args) &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// value is the next arg</span></div><div class="line">			hasValue = <span class="literal">true</span></div><div class="line">			value, f.args = f.args[<span class="number">0</span>], f.args[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !hasValue &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"flag needs an argument: -%s"</span>, name)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// set设置</span></div><div class="line">		<span class="keyword">if</span> err := flag.Value.Set(value); err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">false</span>, f.failf(<span class="string">"invalid value %q for flag -%s: %v"</span>, value, name, err)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> f.actual == <span class="literal">nil</span> &#123;</div><div class="line">		f.actual = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*Flag)</div><div class="line">	&#125;</div><div class="line">	f.actual[name] = flag</div><div class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Duration的Set方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *durationValue)</span> <span class="title">Set</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	v, err := time.ParseDuration(s)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		err = errParse</div><div class="line">	&#125;</div><div class="line">	*d = durationValue(v)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseDuration</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(Duration, error)</span></span> &#123;</div><div class="line">	<span class="comment">// [-+]?([0-9]*(\.[0-9]*)?[a-z]+)+</span></div><div class="line">	orig := s</div><div class="line">	<span class="keyword">var</span> d <span class="keyword">int64</span></div><div class="line">	neg := <span class="literal">false</span></div><div class="line"></div><div class="line">	<span class="comment">// Consume [-+]?</span></div><div class="line">	<span class="keyword">if</span> s != <span class="string">""</span> &#123;</div><div class="line">		c := s[<span class="number">0</span>]</div><div class="line">		<span class="keyword">if</span> c == <span class="string">'-'</span> || c == <span class="string">'+'</span> &#123;</div><div class="line">			neg = c == <span class="string">'-'</span></div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Special case: if all that is left is "0", this is zero.</span></div><div class="line">	<span class="keyword">if</span> s == <span class="string">"0"</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> s == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> s != <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">var</span> (</div><div class="line">			v, f  <span class="keyword">int64</span>       <span class="comment">// integers before, after decimal point</span></div><div class="line">			scale <span class="keyword">float64</span> = <span class="number">1</span> <span class="comment">// value = v + f/scale</span></div><div class="line">		)</div><div class="line"></div><div class="line">		<span class="keyword">var</span> err error</div><div class="line"></div><div class="line">		<span class="comment">// The next character must be [0-9.]</span></div><div class="line">		<span class="keyword">if</span> !(s[<span class="number">0</span>] == <span class="string">'.'</span> || <span class="string">'0'</span> &lt;= s[<span class="number">0</span>] &amp;&amp; s[<span class="number">0</span>] &lt;= <span class="string">'9'</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// Consume [0-9]*</span></div><div class="line">		pl := <span class="built_in">len</span>(s)</div><div class="line">		v, s, err = leadingInt(s)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		pre := pl != <span class="built_in">len</span>(s) <span class="comment">// whether we consumed anything before a period</span></div><div class="line"></div><div class="line">		<span class="comment">// Consume (\.[0-9]*)?</span></div><div class="line">		post := <span class="literal">false</span></div><div class="line">		<span class="keyword">if</span> s != <span class="string">""</span> &amp;&amp; s[<span class="number">0</span>] == <span class="string">'.'</span> &#123;</div><div class="line">			s = s[<span class="number">1</span>:]</div><div class="line">			pl := <span class="built_in">len</span>(s)</div><div class="line">			f, scale, s = leadingFraction(s)</div><div class="line">			post = pl != <span class="built_in">len</span>(s)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !pre &amp;&amp; !post &#123;</div><div class="line">			<span class="comment">// no digits (e.g. ".s" or "-.s")</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// Consume unit.</span></div><div class="line">		i := <span class="number">0</span></div><div class="line">		<span class="keyword">for</span> ; i &lt; <span class="built_in">len</span>(s); i++ &#123;</div><div class="line">			c := s[i]</div><div class="line">			<span class="keyword">if</span> c == <span class="string">'.'</span> || <span class="string">'0'</span> &lt;= c &amp;&amp; c &lt;= <span class="string">'9'</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> i == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: missing unit in duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		u := s[:i]</div><div class="line">		s = s[i:]</div><div class="line">		unit, ok := unitMap[u]</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: unknown unit "</span> + u + <span class="string">" in duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> v &gt; (<span class="number">1</span>&lt;&lt;<span class="number">63</span><span class="number">-1</span>)/unit &#123;</div><div class="line">			<span class="comment">// overflow</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">		v *= unit</div><div class="line">		<span class="keyword">if</span> f &gt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// float64 is needed to be nanosecond accurate for fractions of hours.</span></div><div class="line">			<span class="comment">// v &gt;= 0 &amp;&amp; (f*unit/scale) &lt;= 3.6e+12 (ns/h, h is the largest unit)</span></div><div class="line">			v += <span class="keyword">int64</span>(<span class="keyword">float64</span>(f) * (<span class="keyword">float64</span>(unit) / scale))</div><div class="line">			<span class="keyword">if</span> v &lt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// overflow</span></div><div class="line">				<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		d += v</div><div class="line">		<span class="keyword">if</span> d &lt; <span class="number">0</span> &#123;</div><div class="line">			<span class="comment">// overflow</span></div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">"time: invalid duration "</span> + orig)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> neg &#123;</div><div class="line">		d = -d</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> Duration(d), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="接口值"><a href="#接口值" class="headerlink" title="接口值"></a>接口值</h2><ul>
<li>接口值指一个具体的类型和那个类型的值，也称为接口的动态类型和动态值</li>
<li>go中提供类型信息的值实际上是类型描述符，类型时编译期的概念</li>
<li>接口的零值指的是期类型和值的部分都是nil</li>
<li>不包含任何值的nil接口和一个刚好包含nil指针的接口值是不同的</li>
</ul>
<h2 id="go中排序算法的实现"><a href="#go中排序算法的实现" class="headerlink" title="go中排序算法的实现"></a>go中排序算法的实现</h2><h3 id="sort接口"><a href="#sort接口" class="headerlink" title="sort接口"></a>sort接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sort</div><div class="line"><span class="comment">// 排序接口只规定了三个方法，序列长度，两个元素的比较结果，交换两个元素的方式</span></div><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">	Len() <span class="keyword">int</span></div><div class="line">	Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">	Swap(i, j <span class="keyword">int</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="go中排序函数的实现"><a href="#go中排序函数的实现" class="headerlink" title="go中排序函数的实现"></a>go中排序函数的实现</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 实现了前面Interface的结构体都可以进行排序，go中排序使用的是改进后的快排</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Interface)</span></span> &#123;</div><div class="line">	n := data.Len()</div><div class="line">	quickSort(data, <span class="number">0</span>, n, maxDepth(n))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 堆排序最大深度</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">maxDepth</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> depth <span class="keyword">int</span></div><div class="line">	<span class="keyword">for</span> i := n; i &gt; <span class="number">0</span>; i &gt;&gt;= <span class="number">1</span> &#123;</div><div class="line">		depth++</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> depth * <span class="number">2</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSort</span><span class="params">(data Interface, a, b, maxDepth <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> b-a &gt; <span class="number">12</span> &#123; <span class="comment">// Use ShellSort for slices &lt;= 12 elements</span></div><div class="line">		<span class="keyword">if</span> maxDepth == <span class="number">0</span> &#123;</div><div class="line">		    <span class="comment">// 进行堆排序</span></div><div class="line">			heapSort(data, a, b)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		maxDepth--</div><div class="line">		<span class="comment">// 获取pivot，进行快排</span></div><div class="line">		mlo, mhi := doPivot(data, a, b)</div><div class="line">		<span class="comment">// Avoiding recursion on the larger subproblem guarantees</span></div><div class="line">		<span class="comment">// a stack depth of at most lg(b-a).</span></div><div class="line">		<span class="keyword">if</span> mlo-a &lt; b-mhi &#123;</div><div class="line">			quickSort(data, a, mlo, maxDepth)</div><div class="line">			a = mhi <span class="comment">// i.e., quickSort(data, mhi, b)</span></div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			quickSort(data, mhi, b, maxDepth)</div><div class="line">			b = mlo <span class="comment">// i.e., quickSort(data, a, mlo)</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> b-a &gt; <span class="number">1</span> &#123;</div><div class="line">		<span class="comment">// 希尔排序</span></div><div class="line">		<span class="comment">// It could be written in this simplified form cause b-a &lt;= 12</span></div><div class="line">		<span class="keyword">for</span> i := a + <span class="number">6</span>; i &lt; b; i++ &#123;</div><div class="line">			<span class="keyword">if</span> data.Less(i, i<span class="number">-6</span>) &#123;</div><div class="line">				data.Swap(i, i<span class="number">-6</span>)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		insertionSort(data, a, b)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>interface是一种类型</li>
<li>interfacde{}是空接口，和Java中Object类似，所有的结构体都实现了空接口</li>
<li>如果一个类型实现了一个interface的所有方法，则该类型实现了该接口</li>
<li>interface变量存储的是实现结构体的值，并且只会暴露接口公开的值和方法</li>
<li>判断interface存储的类型可以使用断言来实现。value, ok := interfaceObject.(assertType)</li>
<li><p>interface的接收者是类型值还是指针在定义的时候没有严格规定，但是go语言实际上是只支持值传递。golang的语法糖会将函数里调用的指针进行隐式的转换成值，但是反过来是不行的。函数调用优先使用指针就OK了。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">type I interface &#123;</div><div class="line">	Get() int</div><div class="line">	Set(int)</div><div class="line">&#125;</div><div class="line"></div><div class="line">type SS struct &#123;</div><div class="line">	Age int</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (s SS) Get() int &#123;</div><div class="line">	return s.Age</div><div class="line">&#125;</div><div class="line"></div><div class="line">func (s SS) Set(age int) &#123;</div><div class="line">	s.Age = age</div><div class="line">&#125;</div><div class="line"></div><div class="line">func f(i I) &#123;</div><div class="line">	i.Set(10)</div><div class="line">	fmt.Println(i.Get())</div><div class="line">&#125;</div><div class="line"></div><div class="line">func main() &#123;</div><div class="line">	ss := SS&#123;&#125;</div><div class="line">	f(&amp;ss) //指针参数，无论函数的接收者是值还是指针都不会保存</div><div class="line">	f(ss)  //值参数，函数的接收者是值不会报错，是指针会编译报错</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/golang/源码解读/io/io/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/golang/源码解读/io/io/" itemprop="url">go源码解读-io包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-12T09:56:01+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="io包中的接口定义"><a href="#io包中的接口定义" class="headerlink" title="io包中的接口定义"></a>io包中的接口定义</h2><ul>
<li>io包中提供了IO操作相关的一系列接口</li>
<li>io包可以理解对os包中底层操作的封装</li>
<li>由于是对底层进行封装，除非特殊提及，否则io包下的函数是线程不安全的</li>
</ul>
<h3 id="Reader接口"><a href="#Reader接口" class="headerlink" title="Reader接口"></a>Reader接口</h3><ul>
<li>Reader接口只包含一个Read方法</li>
<li>Read方法最多读取len(p)个字节到p中，返回读取到p中的字节数及过程中的错误</li>
<li>Read方法读取过程中出错，会返回已经读取到的字节数</li>
<li>Read出错的时候可以返回已经读取到的字节数和nil错误或者返回遇到的错误，而再下次调用Read方法的时候返回0, err即可</li>
<li>Read方法的调用者需要先处理n&gt;0的情况下的数据，而后考虑err的值，防止读取的数据丢失</li>
<li>Read方法不鼓励返回0，nil样式的返回值，除非len(p) == 0</li>
<li>p不能作为实现Reader接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">	Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Writer接口"><a href="#Writer接口" class="headerlink" title="Writer接口"></a>Writer接口</h3><ul>
<li>Writer接口只包含Write方法</li>
<li>Write方法完成从p中写入len(p)个字节到数据流中，返回的是写入的字节数及遇到的错误</li>
<li>Write方法如果返回的<code>n&lt;len(p)</code>，则必须返回个非空的错误</li>
<li>Write方法不允许调整p中的数据，临时调整也不可以</li>
<li>p不能作为实现Writer接口的结构体的成员变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">	Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Closer接口"><a href="#Closer接口" class="headerlink" title="Closer接口"></a>Closer接口</h3><ul>
<li>Closer接口只包含Close方法</li>
<li>Closer接口返回关闭对象中遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Closer <span class="keyword">interface</span> &#123;</div><div class="line">	Close() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Seeker接口"><a href="#Seeker接口" class="headerlink" title="Seeker接口"></a>Seeker接口</h3><ul>
<li>Seeker接口只含有一个Seek方法</li>
<li>Seek方法根据whence的值计算出下一个读取或者写入的偏移量<ul>
<li>SeekStart对起始文件的偏移量</li>
<li>SeekCurrent对当前索引的偏移量</li>
<li>SeekEnd对结尾的偏移量</li>
</ul>
</li>
<li>Seek方法返回相对于起始位置的偏移量，和遇到的错误</li>
<li>实际上返回的偏移量小于文件的起始索引会产生错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	SeekStart   = <span class="number">0</span> <span class="comment">// seek relative to the origin of the file</span></div><div class="line">	SeekCurrent = <span class="number">1</span> <span class="comment">// seek relative to the current offset</span></div><div class="line">	SeekEnd     = <span class="number">2</span> <span class="comment">// seek relative to the end</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Seeker <span class="keyword">interface</span> &#123;</div><div class="line">	Seek(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>) (<span class="keyword">int64</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="组合接口"><a href="#组合接口" class="headerlink" title="组合接口"></a>组合接口</h3><ul>
<li>对于上述的接口进行组合会产生一系列新的接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ReadWriter is the interface that groups the basic Read and Write methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriter <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadCloser is the interface that groups the basic Read and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteCloser is the interface that groups the basic Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> WriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteCloser is the interface that groups the basic Read, Write and Close methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteCloser <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Closer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadSeeker is the interface that groups the basic Read and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// WriteSeeker is the interface that groups the basic Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> WriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ReadWriteSeeker is the interface that groups the basic Read, Write and Seek methods.</span></div><div class="line"><span class="keyword">type</span> ReadWriteSeeker <span class="keyword">interface</span> &#123;</div><div class="line">	Reader</div><div class="line">	Writer</div><div class="line">	Seeker</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderFrom接口"><a href="#ReaderFrom接口" class="headerlink" title="ReaderFrom接口"></a>ReaderFrom接口</h3><ul>
<li>ReaderFrom接口只包含ReadFrom方法</li>
<li>ReadFrom方法从r中读取数据直到遇到EOF或者error</li>
<li>ReadFrom方法返回读取到的字节数和遇到的错误</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderFrom <span class="keyword">interface</span> &#123;</div><div class="line">	ReadFrom(r Reader) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteTo接口"><a href="#WriteTo接口" class="headerlink" title="WriteTo接口"></a>WriteTo接口</h3><ul>
<li>WriteTo接口只包含WriteTo方法</li>
<li>WriteTo方法向w中写入数据，直到没有数据可以写入或者遇到了错误</li>
<li>WriteTo方法返回写入的字节数和遇到的问题</li>
<li>io.Copy函数会优先使用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterTo <span class="keyword">interface</span> &#123;</div><div class="line">	WriteTo(w Writer) (n <span class="keyword">int64</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReaderAt接口"><a href="#ReaderAt接口" class="headerlink" title="ReaderAt接口"></a>ReaderAt接口</h3><ul>
<li>ReaderAt接口只包含ReadAt方法</li>
<li>ReadAt方法在实现的结构体的输入流中，在偏移量offset的位置读取len(p)个字节数据导p中</li>
<li>ReadAt方法在读取到的字节小于len(p)时会返回一个非空错误来解释为什么没有读取完全，这个地方的要求比Reader接口更加严格</li>
<li>ReadAt方法在调用过程中会占据p的全部内存空间，即使读取到的n小于p的长度</li>
<li>ReadAt如果读取到的数据小于len(p),则ReadAt方法会等待更多的数据到来或者返回一个错误，这个地方要求也是比Reader更加严格</li>
<li>ReadAt如果读取完最后一个数据之后，刚好读取了len(p)个字节，则可以返回的err为nil或者EOF</li>
<li>ReadAt方法如果读取的是一个实现了Seek接口的结构体，那么ReadAt的offset和seek的offset不应该相互影响</li>
<li>读取的数据流可以支持多个ReadAt方法并发读取，也就是ReadAt是线程安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReaderAt <span class="keyword">interface</span> &#123;</div><div class="line">	ReadAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteAt接口"><a href="#WriteAt接口" class="headerlink" title="WriteAt接口"></a>WriteAt接口</h3><ul>
<li>WriterAt接口只包含WriteAt方法</li>
<li>WriteAt方法完成向数据流的写入，写入的起点为输入流的offset位置</li>
<li>WriteAt方法返回向数据流写入的数据和遇到的错误</li>
<li>WriteAt方法当写入的数据小于len(p)时，返回的错误不能为nil</li>
<li>WriteAt方法写入的数据流实现了Seek方法，则Seek方法的offset和WriteAt方法的offset互不影响</li>
<li>在数据流不溢出的情况下，WriteAt方法可以并发写入，是线程安全的<br>-</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> WriterAt <span class="keyword">interface</span> &#123;</div><div class="line">	WriteAt(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteReader接口"><a href="#ByteReader接口" class="headerlink" title="ByteReader接口"></a>ByteReader接口</h3><ul>
<li>ByteReader接口只包含ReadByte方法</li>
<li>ReadByte方法读取一个字节，返回从input数据流中读取到的下一个字节或者遇到的错误</li>
<li>如果返回了一个错误，则input数据流没有字节被读取消费掉，并且返回的字节值为undefined</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadByte() (<span class="keyword">byte</span>, error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteScanner接口"><a href="#ByteScanner接口" class="headerlink" title="ByteScanner接口"></a>ByteScanner接口</h3><ul>
<li>ByteScanner接口封装了ByteReader接口和UnreadByte方法</li>
<li>UnreadByte方法在ReadByte方法之后调用，会重置ReadByte方法的操作</li>
<li>如果在没调用ReadByte方法时，调用UnreadByte方法会报错</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteScanner <span class="keyword">interface</span> &#123;</div><div class="line">	ByteReader</div><div class="line">	UnreadByte() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ByteWriter接口"><a href="#ByteWriter接口" class="headerlink" title="ByteWriter接口"></a>ByteWriter接口</h3><ul>
<li>ByteWriter接口只包含WriteByte方法</li>
<li>WriteByte方法完成对数据流的字节写入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ByteWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteByte(c <span class="keyword">byte</span>) error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneReader接口"><a href="#RuneReader接口" class="headerlink" title="RuneReader接口"></a>RuneReader接口</h3><ul>
<li>RuneReader接口包含ReadRune方法</li>
<li>Readrune方法从数据流中读取一个UTF-8编码的Unicode字符，返回读取到的字符，字符的大小和遇到的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneReader <span class="keyword">interface</span> &#123;</div><div class="line">	ReadRune() (r <span class="keyword">rune</span>, size <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="RuneScanner接口"><a href="#RuneScanner接口" class="headerlink" title="RuneScanner接口"></a>RuneScanner接口</h3><ul>
<li>RuneScanner接口封装了RuneReader接口和UnreadRune方法</li>
<li>UnreadRune方法实际上是重置ReadRune方法的操作，需要在ReadRune方法之后调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> RuneScanner <span class="keyword">interface</span> &#123;</div><div class="line">	RuneReader</div><div class="line">	UnreadRune() error</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="StringWriter接口"><a href="#StringWriter接口" class="headerlink" title="StringWriter接口"></a>StringWriter接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> StringWriter <span class="keyword">interface</span> &#123;</div><div class="line">	WriteString(s <span class="keyword">string</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="io包中的错误定义"><a href="#io包中的错误定义" class="headerlink" title="io包中的错误定义"></a>io包中的错误定义</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrShortWrite = errors.New(<span class="string">"short write"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrShortBuffer = errors.New(<span class="string">"short buffer"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> EOF = errors.New(<span class="string">"EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrUnexpectedEOF = errors.New(<span class="string">"unexpected EOF"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrNoProgress = errors.New(<span class="string">"multiple Read calls return no data or error"</span>)</div></pre></td></tr></table></figure>
<h2 id="io包中定义的结构体"><a href="#io包中定义的结构体" class="headerlink" title="io包中定义的结构体"></a>io包中定义的结构体</h2><h3 id="LimitedReader"><a href="#LimitedReader" class="headerlink" title="LimitedReader"></a>LimitedReader</h3><ul>
<li>LimitedReader读入数据到R中，限制读入的字节数为N</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> LimitedReader <span class="keyword">struct</span> &#123;</div><div class="line">	R Reader <span class="comment">// underlying reader</span></div><div class="line">	N <span class="keyword">int64</span>  <span class="comment">// max bytes remaining</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LimitReader</span><span class="params">(r Reader, n <span class="keyword">int64</span>)</span> <span class="title">Reader</span></span> &#123; <span class="keyword">return</span> &amp;LimitedReader&#123;r, n&#125; &#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *LimitedReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.N &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; l.N &#123;</div><div class="line">		p = p[<span class="number">0</span>:l.N]</div><div class="line">	&#125;</div><div class="line">	n, err = l.R.Read(p)</div><div class="line">	l.N -= <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SectionReader"><a href="#SectionReader" class="headerlink" title="SectionReader"></a>SectionReader</h3><ul>
<li>SectionReader完成数据的部分读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> SectionReader <span class="keyword">struct</span> &#123;</div><div class="line">	r     ReaderAt</div><div class="line">	base  <span class="keyword">int64</span></div><div class="line">	off   <span class="keyword">int64</span></div><div class="line">	limit <span class="keyword">int64</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 初始化</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSectionReader</span><span class="params">(r ReaderAt, off <span class="keyword">int64</span>, n <span class="keyword">int64</span>)</span> *<span class="title">SectionReader</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;SectionReader&#123;r, off, off, off + n&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> s.off &gt;= s.limit &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> max := s.limit - s.off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">	&#125;</div><div class="line">	n, err = s.r.ReadAt(p, s.off)</div><div class="line">	s.off += <span class="keyword">int64</span>(n)</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现Seeker接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Seek</span><span class="params">(offset <span class="keyword">int64</span>, whence <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int64</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> whence &#123;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errWhence</div><div class="line">	<span class="keyword">case</span> SeekStart:</div><div class="line">		offset += s.base</div><div class="line">	<span class="keyword">case</span> SeekCurrent:</div><div class="line">		offset += s.off</div><div class="line">	<span class="keyword">case</span> SeekEnd:</div><div class="line">		offset += s.limit</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> offset &lt; s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, errOffset</div><div class="line">	&#125;</div><div class="line">	s.off = offset</div><div class="line">	<span class="keyword">return</span> offset - s.base, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现ReaderAt接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">ReadAt</span><span class="params">(p []<span class="keyword">byte</span>, off <span class="keyword">int64</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> off &lt; <span class="number">0</span> || off &gt;= s.limit-s.base &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">	&#125;</div><div class="line">	off += s.base</div><div class="line">	<span class="keyword">if</span> max := s.limit - off; <span class="keyword">int64</span>(<span class="built_in">len</span>(p)) &gt; max &#123;</div><div class="line">		p = p[<span class="number">0</span>:max]</div><div class="line">		n, err = s.r.ReadAt(p, off)</div><div class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">			err = EOF</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> n, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s.r.ReadAt(p, off)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 返回section的字节尺寸</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SectionReader)</span> <span class="title">Size</span><span class="params">()</span> <span class="title">int64</span></span> &#123; <span class="keyword">return</span> s.limit - s.base &#125;</div></pre></td></tr></table></figure>
<h2 id="常用工具类方法"><a href="#常用工具类方法" class="headerlink" title="常用工具类方法"></a>常用工具类方法</h2><ul>
<li>WriteString函数将字符串s写入到w中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteString</span><span class="params">(w Writer, s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">		<span class="keyword">return</span> sw.WriteString(s)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> w.Write([]<span class="keyword">byte</span>(s))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadAtLeast函数从r中读取数据导buf中，同时规定了最少读取的字节数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Reader, buf []<span class="keyword">byte</span>, min <span class="keyword">int</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(buf) &lt; min &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, ErrShortBuffer</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> n &lt; min &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">var</span> nn <span class="keyword">int</span></div><div class="line">		nn, err = r.Read(buf[n:])</div><div class="line">		n += nn</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &gt;= min &#123;</div><div class="line">		err = <span class="literal">nil</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &gt; <span class="number">0</span> &amp;&amp; err == EOF &#123;</div><div class="line">		err = ErrUnexpectedEOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ReadFull一次性读取len(buf)个数到buf中，实际上是对ReadAtLeast的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFull</span><span class="params">(r Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> ReadAtLeast(r, buf, <span class="built_in">len</span>(buf))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Copy方法完成将src的数据复制到dst中，直到遇到EOF或者错误</li>
<li>Copy成功的话会返回nil，而不是EOF</li>
<li>如果src实现了WriteTo方法，则会优先调用，否则会调用dst的ReadFrom方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Copy</span><span class="params">(dst Writer, src Reader)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyBuffer和Copy是一致的，只是增加了缓冲区</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> buf != <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(buf) == <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"empty buffer in io.CopyBuffer"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> copyBuffer(dst, src, buf)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>copyBuffer是实际上的Copy和CopyBuffer的实现</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">copyBuffer</span><span class="params">(dst Writer, src Reader, buf []<span class="keyword">byte</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 如果src实现了WriteTo接口，则调用其WroteTo方法完成写入</span></div><div class="line">	<span class="keyword">if</span> wt, ok := src.(WriterTo); ok &#123;</div><div class="line">		<span class="keyword">return</span> wt.WriteTo(dst)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 如果dst实现了ReaderFrom接口，则调用ReadFrom方法完成写入</span></div><div class="line">	<span class="keyword">if</span> rt, ok := dst.(ReaderFrom); ok &#123;</div><div class="line">		<span class="keyword">return</span> rt.ReadFrom(src)</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 缓冲区大小确定</span></div><div class="line">	<span class="keyword">if</span> buf == <span class="literal">nil</span> &#123;</div><div class="line">		size := <span class="number">32</span> * <span class="number">1024</span></div><div class="line">		<span class="keyword">if</span> l, ok := src.(*LimitedReader); ok &amp;&amp; <span class="keyword">int64</span>(size) &gt; l.N &#123;</div><div class="line">			<span class="keyword">if</span> l.N &lt; <span class="number">1</span> &#123;</div><div class="line">				size = <span class="number">1</span></div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				size = <span class="keyword">int</span>(l.N)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		buf = <span class="built_in">make</span>([]<span class="keyword">byte</span>, size)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">    <span class="comment">// 读取到buf中</span></div><div class="line">		nr, er := src.Read(buf)</div><div class="line">		<span class="keyword">if</span> nr &gt; <span class="number">0</span> &#123;</div><div class="line">      <span class="comment">// 写入操作</span></div><div class="line">			nw, ew := dst.Write(buf[<span class="number">0</span>:nr])</div><div class="line">			<span class="keyword">if</span> nw &gt; <span class="number">0</span> &#123;</div><div class="line">				written += <span class="keyword">int64</span>(nw)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> ew != <span class="literal">nil</span> &#123;</div><div class="line">				err = ew</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> nr != nw &#123;</div><div class="line">				err = ErrShortWrite</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> er != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">if</span> er != EOF &#123;</div><div class="line">				err = er</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> written, err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>CopyN完成从src复制N个字节数据到dst</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyN</span><span class="params">(dst Writer, src Reader, n <span class="keyword">int64</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	written, err = Copy(dst, LimitReader(src, n))</div><div class="line">	<span class="keyword">if</span> written == n &#123;</div><div class="line">		<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> written &lt; n &amp;&amp; err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ioutil中的工具类"><a href="#ioutil中的工具类" class="headerlink" title="ioutil中的工具类"></a>ioutil中的工具类</h2><h3 id="ReadAll函数"><a href="#ReadAll函数" class="headerlink" title="ReadAll函数"></a>ReadAll函数</h3><ul>
<li>ReadAll函数将r中的数据读取出来并返回</li>
<li>成功读取返回的err为nil</li>
<li>readAll函数实际上是利用bytes.Buffer完成数据的读取的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> readAll(r, bytes.MinRead)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> buf bytes.Buffer</div><div class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		e := <span class="built_in">recover</span>()</div><div class="line">		<span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</div><div class="line">			err = panicErr</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="built_in">panic</span>(e)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">  <span class="comment">// 防止capacity溢出</span></div><div class="line">	<span class="keyword">if</span> <span class="keyword">int64</span>(<span class="keyword">int</span>(capacity)) == capacity &#123;</div><div class="line">		buf.Grow(<span class="keyword">int</span>(capacity))</div><div class="line">	&#125;</div><div class="line">	_, err = buf.ReadFrom(r)</div><div class="line">	<span class="keyword">return</span> buf.Bytes(), err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadFile函数"><a href="#ReadFile函数" class="headerlink" title="ReadFile函数"></a>ReadFile函数</h3><ul>
<li>ReadFile完成对指定文件的读取并且返回其数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filename <span class="keyword">string</span>)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件</span></div><div class="line">	f, err := os.Open(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> f.Close()</div><div class="line">	<span class="keyword">var</span> n <span class="keyword">int64</span> = bytes.MinRead</div><div class="line"></div><div class="line">	<span class="keyword">if</span> fi, err := f.Stat(); err == <span class="literal">nil</span> &#123;</div><div class="line">    <span class="comment">// 确定读取的size，比文件的大小稍微多一些</span></div><div class="line">		<span class="keyword">if</span> size := fi.Size() + bytes.MinRead; size &gt; n &#123;</div><div class="line">			n = size</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 调用readAll方法来完成数据的读取</span></div><div class="line">	<span class="keyword">return</span> readAll(f, n)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="WriteFile函数"><a href="#WriteFile函数" class="headerlink" title="WriteFile函数"></a>WriteFile函数</h3><ul>
<li>WriteFile将数据写入到名称为filename的文件中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteFile</span><span class="params">(filename <span class="keyword">string</span>, data []<span class="keyword">byte</span>, perm os.FileMode)</span> <span class="title">error</span></span> &#123;</div><div class="line">  <span class="comment">// 打开文件，如果不存在，则创建</span></div><div class="line">	f, err := os.OpenFile(filename, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, perm)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 数据的追加写入</span></div><div class="line">	n, err := f.Write(data)</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &amp;&amp; n &lt; <span class="built_in">len</span>(data) &#123;</div><div class="line">		err = io.ErrShortWrite</div><div class="line">	&#125;</div><div class="line">  <span class="comment">// 关闭文件</span></div><div class="line">	<span class="keyword">if</span> err1 := f.Close(); err == <span class="literal">nil</span> &#123;</div><div class="line">		err = err1</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ReadDir函数"><a href="#ReadDir函数" class="headerlink" title="ReadDir函数"></a>ReadDir函数</h3><ul>
<li>ReadDir函数读取dirname下的文件或者路径并返回</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadDir</span><span class="params">(dirname <span class="keyword">string</span>)</span> <span class="params">([]os.FileInfo, error)</span></span> &#123;</div><div class="line">	f, err := os.Open(dirname)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	list, err := f.Readdir(<span class="number">-1</span>)</div><div class="line">	f.Close()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	sort.Slice(list, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> list[i].Name() &lt; list[j].Name() &#125;)</div><div class="line">	<span class="keyword">return</span> list, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="NopCloser"><a href="#NopCloser" class="headerlink" title="NopCloser"></a>NopCloser</h3><ul>
<li>NopCloser返回带Close方法的Reader</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NopCloser</span><span class="params">(r io.Reader)</span> <span class="title">io</span>.<span class="title">ReadCloser</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> nopCloser&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> nopCloser <span class="keyword">struct</span> &#123;</div><div class="line">	io.Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nopCloser)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div></pre></td></tr></table></figure>
<h3 id="Discard"><a href="#Discard" class="headerlink" title="Discard"></a>Discard</h3><ul>
<li>Discard的写入操作都会被忽略</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Discard实际上是通过devNull来构建的</span></div><div class="line"><span class="keyword">var</span> Discard io.Writer = devNull(<span class="number">0</span>)</div><div class="line"><span class="comment">// devNull结构体本身是个int数据</span></div><div class="line"><span class="keyword">type</span> devNull <span class="keyword">int</span></div><div class="line"><span class="comment">// 实现了Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了StringWriter接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 实现了ReaderFrom接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(devNull)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">	bufp := blackHolePool.Get().(*[]<span class="keyword">byte</span>)</div><div class="line">	readSize := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		readSize, err = r.Read(*bufp)</div><div class="line">		n += <span class="keyword">int64</span>(readSize)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			blackHolePool.Put(bufp)</div><div class="line">			<span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">				<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> blackHolePool = sync.Pool&#123;</div><div class="line">	New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">		b := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">8192</span>)</div><div class="line">		<span class="keyword">return</span> &amp;b</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Pipe函数"><a href="#Pipe函数" class="headerlink" title="Pipe函数"></a>Pipe函数</h2><ul>
<li>Pipe在内存中创建了个管道，可以用于连接需要io.Reader和io.Writer的代码</li>
<li>读写会相互阻塞，除非一个写入被多次读取的场景存在</li>
<li>Pipe是并发安全的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pipe</span><span class="params">()</span> <span class="params">(*PipeReader, *PipeWriter)</span></span> &#123;</div><div class="line">	p := &amp;pipe&#123;</div><div class="line">		wrCh: <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="keyword">byte</span>),</div><div class="line">		rdCh: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>),</div><div class="line">		done: <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;PipeReader&#123;p&#125;, &amp;PipeWriter&#123;p&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="PipeReader和PipeWriter"><a href="#PipeReader和PipeWriter" class="headerlink" title="PipeReader和PipeWriter"></a>PipeReader和PipeWriter</h3><ul>
<li>PipeReader是管道读的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeReader <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Reader接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Read</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.Read(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Closer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *PipeReader)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> r.p.CloseRead(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>PipeWriter是管道写的半边</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> PipeWriter <span class="keyword">struct</span> &#123;</div><div class="line">	p *pipe</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io.Writer接口</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Write</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.Write(data)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 实现了io。Close方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.CloseWithError(<span class="literal">nil</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(w *PipeWriter)</span> <span class="title">CloseWithError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> w.p.CloseWrite(err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pipe结构体"><a href="#pipe结构体" class="headerlink" title="pipe结构体"></a>pipe结构体</h3><ul>
<li>实际上Pipe是对pipe的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> pipe <span class="keyword">struct</span> &#123;</div><div class="line">	wrMu sync.Mutex <span class="comment">// 保障写入的安全</span></div><div class="line">	wrCh <span class="keyword">chan</span> []<span class="keyword">byte</span> <span class="comment">// 写入的数据</span></div><div class="line">	rdCh <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// 读取到的数量的byte数</span></div><div class="line"></div><div class="line">	once sync.Once <span class="comment">// 保证pipe只被关闭一次</span></div><div class="line">	done <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; <span class="comment">// pipe关闭通道信息</span></div><div class="line">	rerr atomicError <span class="comment">// 读错误</span></div><div class="line">	werr atomicError <span class="comment">// 写错误</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Reader接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Read</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 判断要读取的通道是否已经关闭</span></div><div class="line">  <span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 将数据写入b中，并将写入的字节数写入rdCh通道中</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> bw := &lt;-p.wrCh:</div><div class="line">		nr := <span class="built_in">copy</span>(b, bw)</div><div class="line">		p.rdCh &lt;- nr</div><div class="line">		<span class="keyword">return</span> nr, <span class="literal">nil</span></div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.readCloseError()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe实现了io.Writer接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">Write</span><span class="params">(b []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">  <span class="comment">// 保证写入的时候安全，且pipe没有关闭</span></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;-p.done:</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span>, p.writeCloseError()</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		p.wrMu.Lock()</div><div class="line">		<span class="keyword">defer</span> p.wrMu.Unlock()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">  <span class="comment">// 写入数据</span></div><div class="line">	<span class="keyword">for</span> once := <span class="literal">true</span>; once || <span class="built_in">len</span>(b) &gt; <span class="number">0</span>; once = <span class="literal">false</span> &#123;</div><div class="line">		<span class="keyword">select</span> &#123;</div><div class="line">		<span class="keyword">case</span> p.wrCh &lt;- b:</div><div class="line">			nw := &lt;-p.rdCh</div><div class="line">			b = b[nw:]</div><div class="line">			n += nw</div><div class="line">		<span class="keyword">case</span> &lt;-p.done:</div><div class="line">			<span class="keyword">return</span> n, p.writeCloseError()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>pipe的Close方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseRead</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = ErrClosedPipe</div><div class="line">	&#125;</div><div class="line">	p.rerr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *pipe)</span> <span class="title">CloseWrite</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</div><div class="line">		err = EOF</div><div class="line">	&#125;</div><div class="line">	p.werr.Store(err)</div><div class="line">	p.once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="built_in">close</span>(p.done) &#125;)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="multi"><a href="#multi" class="headerlink" title="multi"></a>multi</h2><h3 id="MultiReader-将多个Reader的内容写入p"><a href="#MultiReader-将多个Reader的内容写入p" class="headerlink" title="MultiReader 将多个Reader的内容写入p"></a>MultiReader 将多个Reader的内容写入p</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiReader</span><span class="params">(readers ...Reader)</span> <span class="title">Reader</span></span> &#123;</div><div class="line">	r := <span class="built_in">make</span>([]Reader, <span class="built_in">len</span>(readers))</div><div class="line">	<span class="built_in">copy</span>(r, readers)</div><div class="line">	<span class="keyword">return</span> &amp;multiReader&#123;r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiReader <span class="keyword">struct</span> &#123;</div><div class="line">	readers []Reader</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mr *multiReader)</span> <span class="title">Read</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">    <span class="comment">// flat嵌套</span></div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(mr.readers) == <span class="number">1</span> &#123;</div><div class="line">			<span class="keyword">if</span> r, ok := mr.readers[<span class="number">0</span>].(*multiReader); ok &#123;</div><div class="line">				mr.readers = r.readers</div><div class="line">				<span class="keyword">continue</span></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		n, err = mr.readers[<span class="number">0</span>].Read(p)</div><div class="line">		<span class="keyword">if</span> err == EOF &#123;</div><div class="line">      <span class="comment">// 避免nl panic</span></div><div class="line">			mr.readers[<span class="number">0</span>] = eofReader&#123;&#125; <span class="comment">// permit earlier GC</span></div><div class="line">			mr.readers = mr.readers[<span class="number">1</span>:]</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n &gt; <span class="number">0</span> || err != EOF &#123;</div><div class="line">			<span class="keyword">if</span> err == EOF &amp;&amp; <span class="built_in">len</span>(mr.readers) &gt; <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// Don't return EOF yet. More readers remain.</span></div><div class="line">				err = <span class="literal">nil</span></div><div class="line">			&#125;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 避免nil panic</span></div><div class="line"><span class="keyword">type</span> eofReader <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(eofReader)</span> <span class="title">Read</span><span class="params">([]<span class="keyword">byte</span>)</span> <span class="params">(<span class="keyword">int</span>, error)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>, EOF</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="MultiWriter-将p的内容写入多个数据流中"><a href="#MultiWriter-将p的内容写入多个数据流中" class="headerlink" title="MultiWriter 将p的内容写入多个数据流中"></a>MultiWriter 将p的内容写入多个数据流中</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiWriter</span><span class="params">(writers ...Writer)</span> <span class="title">Writer</span></span> &#123;</div><div class="line">	allWriters := <span class="built_in">make</span>([]Writer, <span class="number">0</span>, <span class="built_in">len</span>(writers))</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> writers &#123;</div><div class="line">		<span class="keyword">if</span> mw, ok := w.(*multiWriter); ok &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, mw.writers...)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			allWriters = <span class="built_in">append</span>(allWriters, w)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;multiWriter&#123;allWriters&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> multiWriter <span class="keyword">struct</span> &#123;</div><div class="line">	writers []Writer</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		n, err = w.Write(p)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(p) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(p), <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *multiWriter)</span> <span class="title">WriteString</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> p []<span class="keyword">byte</span> <span class="comment">// lazily initialized if/when needed</span></div><div class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> t.writers &#123;</div><div class="line">		<span class="keyword">if</span> sw, ok := w.(StringWriter); ok &#123;</div><div class="line">			n, err = sw.WriteString(s)</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			<span class="keyword">if</span> p == <span class="literal">nil</span> &#123;</div><div class="line">				p = []<span class="keyword">byte</span>(s)</div><div class="line">			&#125;</div><div class="line">			n, err = w.Write(p)</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> n != <span class="built_in">len</span>(s) &#123;</div><div class="line">			err = ErrShortWrite</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">106</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">30</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
