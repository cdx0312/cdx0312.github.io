<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Be a better man!">
<meta property="og:type" content="website">
<meta property="og:title" content="小黄">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="小黄">
<meta property="og:description" content="Be a better man!">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小黄">
<meta name="twitter:description" content="Be a better man!">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>小黄</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">小黄</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">黄小黄的幸福生活！</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-java">
          <a href="/Java/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br />
            
            Java
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/24/go语言实战-打包和工具链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/24/go语言实战-打包和工具链/" itemprop="url">go语言实战 - 3、4、5</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-24T17:08:09+08:00">
                2020-04-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第三章-打包和工具链"><a href="#第三章-打包和工具链" class="headerlink" title="第三章 打包和工具链"></a>第三章 打包和工具链</h2><h3 id="包-package"><a href="#包-package" class="headerlink" title="包 package"></a>包 package</h3><ul>
<li>go语言的程序会被组织成若干组文件，每组文件都被称为一个包</li>
<li>不能把多个包放在同一个目录中</li>
<li>不能把同一个包拆分到多个不同目录中</li>
<li>一个目录下的.go文件必须声明同一个包名</li>
<li>包名命名的管理是使用包所在的目录的名字</li>
<li>包的导入使用全路径，允许名字重复</li>
<li>导入后的报名默认使用包的名字，但是是可以修改的</li>
<li>main包会被编译成二进制可执行文件</li>
<li>main包需要有个main函数作为主函数入口</li>
<li>go build 命令用于构建可执行程序</li>
</ul>
<h3 id="导入-import"><a href="#导入-import" class="headerlink" title="导入 import"></a>导入 import</h3><ul>
<li>import语句告诉编译器到磁盘的哪里去寻找导入的包</li>
<li>编译器会使用Go环境变量设置的路径，通过引入的相对路径来查找磁盘上的包</li>
<li>标准库中的包会在安装Go的位置找到</li>
<li>Go开发者创建的包会在Gopath的环境变量指定的目录中查找</li>
<li>go get命令将获取指定URL的包</li>
<li>包支持命名导入 <code>import nh net/http</code></li>
<li>导入一个不在代码里使用的包时，会导致编译报错，避免代码变得臃肿</li>
<li><code>_</code>空白标识符用于抛弃，比如导入的包，抛出的异常，返回的函数都可以被抛弃</li>
</ul>
<h3 id="初始函数-init"><a href="#初始函数-init" class="headerlink" title="初始函数 init"></a>初始函数 init</h3><ul>
<li>每个包可以包含任意多个init函数，这些函数在程序执行开始的时候被调用</li>
<li>所有被编译器发现的init函数都会在main函数之前执行</li>
<li>init函数主要用在设置包、初始化变量、或者其他先导设置工作，例如在数据库驱动启动的包中，初始化函数会将自身注册到sql包中，启动之后才可以完成数据库的调用</li>
<li>空白标识符可以保证导入包的初始化函数正常执行，而不会报错</li>
</ul>
<h3 id="go-工具"><a href="#go-工具" class="headerlink" title="go 工具"></a>go 工具</h3><ul>
<li>go build 执行编译</li>
<li>go clean 删除编译之后产生的二进制文件</li>
<li>go run 先编译，后执行</li>
<li>go vet 帮助开发人员检测代码的常见错误<ul>
<li>类型匹配错误</li>
<li>方法签名调用错误</li>
<li>错误的结构标签</li>
<li>没有指定字段名的结构字面量</li>
</ul>
</li>
<li>go fmt 将代码布局修改成和go源码类似的风格</li>
<li>go doc tar可以在命令行打开tar包的相关文档</li>
<li>godoc -http=:6060可以在web浏览文档</li>
</ul>
<h3 id="良好的习惯"><a href="#良好的习惯" class="headerlink" title="良好的习惯"></a>良好的习惯</h3><ul>
<li>包应该在代码库的根目录</li>
<li>包可以非常小</li>
<li>代码需要执行 go fmt</li>
<li>给代码写文档</li>
</ul>
<h2 id="第四章-数组、切片和映射"><a href="#第四章-数组、切片和映射" class="headerlink" title="第四章 数组、切片和映射"></a>第四章 数组、切片和映射</h2><h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><ul>
<li>数组是一个长度固定的数据类型，用于存储一段具有相同的类型的元素的连续块</li>
<li>内存时连续分配的</li>
<li>数组的类型信息可以提供每次访问一个元素时需要在内存中移动的距离</li>
<li>随机读取速度非常快</li>
<li>声明 var array [5]int，声明之后数组里存储的数据类型和长度都不能改变了</li>
<li>声明之后，数组的值默认为零值</li>
<li>使用数组字面量可以在定义的时候给数组元素赋值 <code>array := [5]int{1,2,3,4,5}</code></li>
<li>相同类型的数组可以赋值给另一个数组</li>
<li>数组变量的类型时包含长度和每个元素的类型的，只有两部分都相同的数组，才是同类型的数组，才可以互相赋值</li>
<li>指针数组赋值，两个数组会指向同一组的字符串</li>
<li>多维数组 <code>var array [2][2]int</code></li>
<li>函数之间传递数组的开销比较大，值传递需要复制整个数组，最好只传入指向数组的指针</li>
</ul>
<h3 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h3><ul>
<li>切片的概念类似于动态数组，可以根据需要自动增长和缩小</li>
<li>切片是一个很小的对象，对底层数组进行了抽象，并提供相关的方法</li>
<li>前片有3个字段的数据，指向底层数组的指针，切片长度，切片容量</li>
<li>切片的创建方法<ul>
<li>make创建<ul>
<li>只指定长度，长度和容量相等 <code>slice := make([]string, 5)</code></li>
<li>指定了长度和容量 <code>slice := make([]string, 3, 5)</code></li>
<li>不允许创建容量小于长度的切片</li>
</ul>
</li>
<li>使用切片字面量来创建<ul>
<li>长度和容量都是3 <code>slice := []string{&quot;r&quot;, &quot;g&quot;, &quot;b&quot;}</code></li>
<li>创建长度和容量是100的切片 <code>slice := []string{99: &quot;&quot;}</code></li>
</ul>
</li>
<li>nil 切片 <code>var slice []int</code></li>
</ul>
</li>
<li>空切片，在底层数组中包含0个元素，也没有分配内核的存储空间<ul>
<li><code>slice := []int{}</code></li>
<li><code>slice := make([]int, 0)</code></li>
</ul>
</li>
<li>切片索引的赋值和数组完全一致</li>
<li>切片可以理解为底层数组的一个滑动窗口，类似于视图的概念</li>
<li>底层数组容量是k的切片<code>slice[i:j]</code>其长度为j-i,容量为k-i</li>
<li>切片是可以根据需要来增加切片的容量的，go语言内置的append函数会处理其细节</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// The append built-in function appends elements to the end of a slice. If</span></div><div class="line"><span class="comment">// it has sufficient capacity, the destination is resliced to accommodate the</span></div><div class="line"><span class="comment">// new elements. If it does not, a new underlying array will be allocated.</span></div><div class="line"><span class="comment">// Append returns the updated slice. It is therefore necessary to store the</span></div><div class="line"><span class="comment">// result of append, often in the variable holding the slice itself:</span></div><div class="line"><span class="comment">//	slice = append(slice, elem1, elem2)</span></div><div class="line"><span class="comment">//	slice = append(slice, anotherSlice...)</span></div><div class="line"><span class="comment">// As a special case, it is legal to append a string to a byte slice, like this:</span></div><div class="line"><span class="comment">//	slice = append([]byte("hello "), "world"...)</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">append</span><span class="params">(slice []Type, elems ...Type)</span> []<span class="title">Type</span></span></div></pre></td></tr></table></figure>
<ul>
<li>切片添加多个数据用<code>...</code>完成</li>
<li>切片迭代<code>for index, val := range slice</code></li>
<li>切片也支持多维</li>
<li>函数内传递切片采用值传递，其本身尺寸很小</li>
</ul>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><ul>
<li>映射用于存储一组无序的键值对</li>
<li>查询时间复杂度O(1)</li>
<li>映射是可以迭代的，但是不保证顺序</li>
<li>映射的散列表包含一组桶，在存储、删除或者查找键值对的时候，所有操作都需要选择一个桶</li>
<li>散列函数生成的散列值的低位来选择桶</li>
<li>创建和初始化<ul>
<li><code>dict := make(map[string]int)</code></li>
<li><code>dict := map[string]string{&quot;Red&quot;:&quot;red&quot;}</code></li>
<li><code>dict := map[int][]string{}</code></li>
</ul>
</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>数组是构造切片和映射的基石</li>
<li>go语言里切片经常用于处理数据的集合，映射用来处理具有键值对结构的数据</li>
<li>内置函数make可以创建切片和映射，并制定原始的长度和容量</li>
<li>切片有容量限制，可以使用append来扩展容量</li>
<li>映射的增长没有任何限制</li>
<li>内置函数len可以用来获取切片或者映射的长度</li>
<li>内置函数cap只能用于切片</li>
<li>将切片或者映射传递给函数的成本很小，不会复制底层的数据结构</li>
</ul>
<h2 id="第五章-Go语言的类型系统"><a href="#第五章-Go语言的类型系统" class="headerlink" title="第五章 Go语言的类型系统"></a>第五章 Go语言的类型系统</h2><ul>
<li>go语言是一种静态类型的语言，编译器编译时需要知道每个值的类型</li>
<li>值的类型可以使得编译器知道分配多少内存给这个值，以及这个内存存储什么数据</li>
</ul>
<h3 id="用户定义的类型"><a href="#用户定义的类型" class="headerlink" title="用户定义的类型"></a>用户定义的类型</h3><ul>
<li>当用户声明一个新的类型时，这个声明就给编译器提供一个框架，告知必要的内存大小和表示信息</li>
<li>自定义类型的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</div><div class="line">  name <span class="keyword">string</span></div><div class="line">  age <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> bill user</div></pre></td></tr></table></figure>
<ul>
<li>声明变量时，这个变量对应的值总是会被初始化，未指定初始化的值时，各个字段默认取零值<ul>
<li>数字类型零值为0</li>
<li>字符串类型零值为””</li>
<li>bool类型零值为false</li>
</ul>
</li>
</ul>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ul>
<li>方法能给用户定义的类型添加新的行为</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> user <span class="keyword">struct</span> &#123;</div><div class="line">  name <span class="keyword">string</span></div><div class="line">  email <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span> <span class="title">notify</span> <span class="params">()</span></span> &#123;</div><div class="line">  fmt.Printf(<span class="string">"Sending User Email To %s&lt;%s&gt; \n"</span>, u.name, u.email)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(u user)</span> <span class="title">changeEmail</span><span class="params">(email <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">  u.email = email</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span> <span class="params">()</span></span> &#123;</div><div class="line">  bill := user &#123;</div><div class="line">    name: <span class="string">"Bill"</span>,</div><div class="line">    email: <span class="string">"bill@email.com"</span>,</div><div class="line">  &#125;</div><div class="line">  bill.notify()</div><div class="line"></div><div class="line">  lisa := &amp;user&#123;<span class="string">"Lisa"</span>, <span class="string">"lisa@email.com"</span>&#125;</div><div class="line">  lisa.notify()</div><div class="line"></div><div class="line">  bill.changeEmail(<span class="string">"bill@new.com"</span>)</div><div class="line">  bill.notify()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>实际上一个函数如果有接收者，这个函数就被称为方法</li>
</ul>
<h3 id="类型的本质"><a href="#类型的本质" class="headerlink" title="类型的本质"></a>类型的本质</h3><ul>
<li><p>内置类型</p>
<ul>
<li>对内置类型进行增加或者删除的时候，会创建一个新值，所以函数中内置类型的传递时值传递</li>
</ul>
</li>
<li><p>引用类型</p>
<ul>
<li>引用类型包括：切片，映射，通道，接口，函数类型</li>
<li>创建的变量被称为标头值，函数中使用是指针传递，本质上共享底层数据结构</li>
</ul>
</li>
<li><p>结构类型</p>
<ul>
<li>当需要更改类型本身的值时，采用指针传递</li>
<li>当不需要更改类型本身的值时，用值传递</li>
</ul>
</li>
</ul>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><ul>
<li>多态是指代码可以根据类型的具体实现采用不同行为的能力</li>
<li>如果一个类型实现了这个接口的所有方法，那么就是实现了这个接口</li>
<li>接口是用来定义行为的类型</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/23/go语言实战-测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/23/go语言实战-测试/" itemprop="url">go语言实战 - 测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-23T10:07:50+08:00">
                2020-04-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="go语言实战-测试"><a href="#go语言实战-测试" class="headerlink" title="go语言实战 - 测试"></a>go语言实战 - 测试</h1><h2 id="第九章-测试和性能"><a href="#第九章-测试和性能" class="headerlink" title="第九章 测试和性能"></a>第九章 测试和性能</h2><h3 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h3><ul>
<li>单元测试是用来测试包或者程序的一部分代码或者一组代码的函数</li>
<li>正向路径测试，保证代码不产生错误，正常运行的测试</li>
<li>负向路径测试，保证代码产生错误，并且是预期的错误</li>
<li>go中的单元测试<ul>
<li>基础测试，只用一组参数和结果进行测试</li>
<li>表组测试，多组参数和结果进行测试</li>
<li>mock数据来减少外部依赖</li>
</ul>
</li>
</ul>
<h4 id="基础单元测试"><a href="#基础单元测试" class="headerlink" title="基础单元测试"></a>基础单元测试</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	checkMark = <span class="string">"\u2713"</span></div><div class="line">	ballotX = <span class="string">"\u2717"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	statusCode := <span class="number">200</span></div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, uri, statusCode)</div><div class="line">		&#123;</div><div class="line">			resp, err := http.Get(uri)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">			&#125;</div><div class="line">			t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">			<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">			<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">=== RUN   TestDownload</span></div><div class="line"><span class="comment">--- PASS: TestDownload (0.27s)</span></div><div class="line"><span class="comment">    01_test.go:17: Given the need to test downloading content</span></div><div class="line"><span class="comment">    01_test.go:19: 	When checking "https://api.weixin.qq.com/cgi-bin/user/info" for status code "200"</span></div><div class="line"><span class="comment">    01_test.go:25: 		Should be able to make the Get call ✓</span></div><div class="line"><span class="comment">    01_test.go:30: 		Should reveive a "200" status ✓</span></div><div class="line"><span class="comment">PASS</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<ul>
<li>go语言只认为以_test.go结尾的文件是测试文件</li>
<li>testing包提供了从测试框架到报告测试的输出和状态的各种测试功能的支持</li>
<li>测试函数必须是公开的函数，并且以Test开头，函数签名必须接收一个指向testing.T类型的指针，并且不返回任何值</li>
</ul>
<h4 id="表组测试"><a href="#表组测试" class="headerlink" title="表组测试"></a>表组测试</h4><ul>
<li>测试可以接受一组不通的输入并且产生不同的输出的代码，推荐使用表组测试的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload2</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> urls = []<span class="keyword">struct</span>&#123;</div><div class="line">		url <span class="keyword">string</span></div><div class="line">		statusCode <span class="keyword">int</span></div><div class="line">	&#125; &#123;</div><div class="line">		&#123;</div><div class="line">			url: <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span>,</div><div class="line">			statusCode: <span class="number">200</span>,</div><div class="line">		&#125;,</div><div class="line">		&#123;</div><div class="line">			url: <span class="string">"https://api.weixin.qq.com/cgi-bin/user"</span>,</div><div class="line">			statusCode: http.StatusNotFound,</div><div class="line">		&#125;,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">for</span> _, u := <span class="keyword">range</span> urls &#123;</div><div class="line">			uri := u.url</div><div class="line">			statusCode := u.statusCode</div><div class="line">			t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, uri, statusCode)</div><div class="line">			&#123;</div><div class="line">				resp, err := http.Get(uri)</div><div class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">					t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">				&#125;</div><div class="line">				t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">				<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">				<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">					t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Mock调用"><a href="#Mock调用" class="headerlink" title="Mock调用"></a>Mock调用</h4><ul>
<li>httptest包可以让开发人员模仿基于http的网络调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> feed = <span class="string">`&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></div><div class="line"><span class="string">&lt;rss&gt;</span></div><div class="line"><span class="string">&lt;channel&gt;</span></div><div class="line"><span class="string">	&lt;title&gt;Going Go Programming&lt;/title&gt;</span></div><div class="line"><span class="string">	&lt;description&gt;Golang : https://github.com/goinggo&lt;/description&gt;</span></div><div class="line"><span class="string">	&lt;link&gt;http://www.goinggo.net/&lt;/link&gt;</span></div><div class="line"><span class="string">	&lt;item&gt;</span></div><div class="line"><span class="string">		&lt;pubDate&gt;Sun, 15 Mar 2015 15:04:00 +0000&lt;/pubDate&gt;</span></div><div class="line"><span class="string">		&lt;title&gt;Object Oriented Programming Mechanics&lt;/title&gt;</span></div><div class="line"><span class="string">		&lt;description&gt;Go is an object oriented language.&lt;/description&gt;</span></div><div class="line"><span class="string">		&lt;link&gt;http://www.goinggo.net/2015/03/object-oriented&lt;/link&gt;</span></div><div class="line"><span class="string">	&lt;/item&gt;</span></div><div class="line"><span class="string">&lt;/channel&gt;</span></div><div class="line"><span class="string">&lt;/rss&gt;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mockServer</span><span class="params">()</span> *<span class="title">httptest</span>.<span class="title">Server</span></span> &#123;</div><div class="line">	f := <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		w.WriteHeader(<span class="number">200</span>)</div><div class="line">		w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"application/xml"</span>)</div><div class="line">		_, _ = fmt.Fprintln(w, feed)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> httptest.NewServer(http.HandlerFunc(f))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestDownload3</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">	statusCode := <span class="number">200</span></div><div class="line"></div><div class="line">	server := mockServer()</div><div class="line">	<span class="keyword">defer</span> server.Close()</div><div class="line"></div><div class="line">	t.Log(<span class="string">"Given the need to test downloading content"</span>)</div><div class="line">	&#123;</div><div class="line">		t.Logf(<span class="string">"\tWhen checking \"%s\" for status code \"%d\""</span>, server.URL, statusCode)</div><div class="line">		&#123;</div><div class="line">			resp, err := http.Get(server.URL)</div><div class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">				t.Fatal(<span class="string">"\t\tShould be able to make the Get call"</span>, ballotX, err)</div><div class="line">			&#125;</div><div class="line">			t.Log(<span class="string">"\t\tShould be able to make the Get call"</span>, checkMark)</div><div class="line"></div><div class="line">			<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">			<span class="keyword">if</span> resp.StatusCode == statusCode &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v"</span>, statusCode, checkMark)</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				t.Logf(<span class="string">"\t\tShould reveive a \"%d\" status %v %v"</span>, statusCode, ballotX, resp.StatusCode)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><ul>
<li>开发人员可以创建自己的示例</li>
<li>函数开头为Example</li>
<li>示例代码的函数名字必须基于已经存在的公开的函数或者方法</li>
<li>最好将示例的输出列在下方</li>
</ul>
<h3 id="基准测试"><a href="#基准测试" class="headerlink" title="基准测试"></a>基准测试</h3><ul>
<li>基准测试是测试代码性能的方法</li>
<li>基准测试必须以Benchmark开头，接受一个执行testing.B类型的指针作为唯一参数</li>
<li>基准测试默认框架会在持续1s的时间内，反复调用需要测试的函数，测试框架每次调用测试函数时，都会增加b.N的值</li>
<li>如果只想运行基准测试，而跳过单元测试，则用命令<code>go test -v -run=&quot;none&quot; -bench=&quot;BenchmarkSprintf&quot;</code>即可</li>
<li><code>-benchtime=3s</code>可以变更基准测试的运行时间，默认为1s</li>
<li><code>b.ResetTimer</code>用来重置计时器</li>
<li><code>-benchmem</code>展示每次操作分配内存的次数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"strconv"</span></div><div class="line">	<span class="string">"testing"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 找出最快的奖整数转换成字符串的方法</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkSprintf</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="number">10</span></div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		fmt.Sprintf(<span class="string">"%d"</span>, number)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkFormat</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="keyword">int64</span>(<span class="number">10</span>)</div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		strconv.FormatInt(number, <span class="number">10</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkItoa</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	number := <span class="number">10</span></div><div class="line"></div><div class="line">	b.ResetTimer()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">		strconv.Itoa(number)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">goos: darwin</span></div><div class="line"><span class="comment">goarch: amd64</span></div><div class="line"><span class="comment">pkg: api/books/go-in-action/9-testing</span></div><div class="line"><span class="comment">BenchmarkSprintf-12    	20000000	        70.6 ns/op</span></div><div class="line"><span class="comment">BenchmarkFormat-12     	1000000000	         2.56 ns/op</span></div><div class="line"><span class="comment">BenchmarkItoa-12       	1000000000	         2.42 ns/op</span></div><div class="line"><span class="comment">PASS</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>测试功能被内置到go语言中，go语言提供了必要的测试工具</li>
<li>go test工具用来运行测试</li>
<li>测试文件总是以_test作为文件名的结尾</li>
<li>表组测试是利用一个测试函数测试多组值的好办法</li>
<li>表中的实例代码，既能用于测试，也能用于文档</li>
<li>基准测试提供了探查代码性能的机制</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/21/go语言实战-标准库/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/21/go语言实战-标准库/" itemprop="url">go语言实战 - 标准库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-21T10:27:52+08:00">
                2020-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="第八章-标准库"><a href="#第八章-标准库" class="headerlink" title="第八章 标准库"></a>第八章 标准库</h2><ul>
<li>标准库是一组核心包，用于扩展和增强语言的能力<ul>
<li>每次语言更新都会带有标准库</li>
<li>标准库会严格遵守哦向后兼容的承诺</li>
<li>标准库是go语言开发，构建，发布过程的一部分</li>
<li>标准库由go的构建者们维护和评审</li>
<li>go语言发布新版本时，标准库都会被测试，并评估性能</li>
</ul>
</li>
<li>开发中尽量使用标准库</li>
</ul>
<h3 id="文档与源代码"><a href="#文档与源代码" class="headerlink" title="文档与源代码"></a>文档与源代码</h3><ul>
<li>作为go发布包的一部分，标准库的源代码是经过预编译的，称为归档文件</li>
<li>这些文件是go静态库文件，由go的构建工具创建，并在编译和链接最终程序时被使用</li>
</ul>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><h4 id="log包简介"><a href="#log包简介" class="headerlink" title="log包简介"></a>log包简介</h4><ul>
<li>log包日志项包含前缀、日期时间戳、源文件、行数、日志消息等组成</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"log"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	log.SetPrefix(<span class="string">"TRACE: "</span>)</div><div class="line">	log.SetFlags(log.Ldate | log.Lmicroseconds | log.Llongfile)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"message"</span>)</div><div class="line"></div><div class="line">	log.Fatalln(<span class="string">"fatal message"</span>)</div><div class="line"></div><div class="line">	log.Panicln(<span class="string">"panic message"</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/* 输出结果</span></div><div class="line"><span class="comment">TRACE: 2020/04/21 14:34:16.281971 /Users/dxchang/go/src/api/books/go-in-action/8-pkg/log.go:11: message</span></div><div class="line"><span class="comment">TRACE: 2020/04/21 14:34:16.282102 /Users/dxchang/go/src/api/books/go-in-action/8-pkg/log.go:13: fatal message</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<ul>
<li>init函数作为初始化的一部分，会在main函数执行前执行</li>
<li>SetPrefix()方法进行设置前缀，一般全部大写</li>
<li>SetFlags设定标志来控制可以写到每个日志项的输出信息，如下</li>
<li>这样可以用一个字节来存储日志的标志位，<code>log.Ldate | log.Ltime | log.Lmicroseconds | log.Llongfile</code>和传入<code>00001111</code>是等价的</li>
<li>日志中以ln结尾的函数会换行，以f结尾的函数可以自定义格式化输出</li>
<li>log包是多线程安全的，多个goroutine同时来调用一个日志记录器的函数，不会存在写冲突</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	Ldate         = <span class="number">1</span> &lt;&lt; <span class="literal">iota</span>     <span class="comment">// 本地日期: 2009/01/23</span></div><div class="line">	Ltime                         <span class="comment">// 本地时间: 01:23:23</span></div><div class="line">	Lmicroseconds                 <span class="comment">// 时间毫秒数: 01:23:23.123123.</span></div><div class="line">	Llongfile                     <span class="comment">// 日志打印的文件全路径: /a/b/c/d.go:23</span></div><div class="line">	Lshortfile                    <span class="comment">// 日志打印的文件短路径: d.go:23</span></div><div class="line">	LUTC                          <span class="comment">// 使用UTC时区时间</span></div><div class="line">	LstdFlags     = Ldate | Ltime <span class="comment">// 默认日志，打印日期和时间，到秒</span></div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>Fatal系列函数来先写消息，然后调用os.Exit方法退出</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Fatal is equivalent to Print() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatal</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprint(v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Fatalf is equivalent to Printf() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatalf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintf(format, v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Fatalln is equivalent to Println() followed by a call to os.Exit(1).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fatalln</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintln(v...))</div><div class="line">	os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Panic函数写日志消息，触发panic，打印堆栈然后退出</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Panic is equivalent to Print() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panic</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprint(v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Panicf is equivalent to Printf() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panicf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprintf(format, v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Panicln is equivalent to Println() followed by a call to panic().</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Panicln</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	s := fmt.Sprintln(v...)</div><div class="line">	std.Output(<span class="number">2</span>, s)</div><div class="line">	<span class="built_in">panic</span>(s)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Print函数是写日志消息的标准方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Print calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Print.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprint(v...))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Printf calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Printf.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="keyword">string</span>, v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintf(format, v...))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Println calls Output to print to the standard logger.</span></div><div class="line"><span class="comment">// Arguments are handled in the manner of fmt.Println.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	std.Output(<span class="number">2</span>, fmt.Sprintln(v...))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="定制的日志记录器"><a href="#定制的日志记录器" class="headerlink" title="定制的日志记录器"></a>定制的日志记录器</h4><ul>
<li>创建一个定制的日志记录器，需要创建一个Logger类型值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	Trace *log.Logger <span class="comment">// 记录所有日志</span></div><div class="line">	Info *log.Logger <span class="comment">// 重要的信息</span></div><div class="line">	Warning *log.Logger <span class="comment">// 警告</span></div><div class="line">	Error *log.Logger <span class="comment">// 错误</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	file, err := os.OpenFile(<span class="string">"errors.txt"</span>, os.O_CREATE | os.O_WRONLY | os.O_APPEND, <span class="number">0666</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(<span class="string">"Failed to open error log file:"</span>, err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	Trace = log.New(ioutil.Discard, <span class="string">"TRACE: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Info = log.New(os.Stdout, <span class="string">"INFO: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Warning = log.New(os.Stdout, <span class="string">"WARNING: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">	Error = log.New(io.MultiWriter(file, os.Stderr), <span class="string">"TRACE: "</span>, log.Ldate | log.Ltime | log.Lshortfile)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	Trace.Println(<span class="string">"I have something standard to say"</span>)</div><div class="line">	Info.Println(<span class="string">"Special Information"</span>)</div><div class="line">	Warning.Println(<span class="string">"There is something you need to know"</span>)</div><div class="line">	Error.Println(<span class="string">"Something has failed"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>log包的New()函数完成Logger类型的初始化，设定输出位置，日志前缀，及日志输出内容</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(out io.Writer, prefix <span class="keyword">string</span>, flag <span class="keyword">int</span>)</span> *<span class="title">Logger</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Logger&#123;out: out, prefix: prefix, flag: flag&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>ioutil.Discard实现了io.Writer接口，但是并不会发生实际的写入，使用Discard可以禁用这个类型的日志</li>
<li>os.Stdin、os.Stdout、os.Stderr分别指向标准输入，标准输出，标准错误</li>
<li>io.MultiWriter()方法可以向多个实现了io.Writer接口的位置写入日志</li>
</ul>
<h4 id="log包中的其余函数"><a href="#log包中的其余函数" class="headerlink" title="log包中的其余函数"></a>log包中的其余函数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flags</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Flags()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetFlags</span><span class="params">(flag <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	std.SetFlags(flag)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Prefix</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Prefix()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetPrefix</span><span class="params">(prefix <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	std.SetPrefix(prefix)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// SetOutput sets the output destination for the standard logger.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SetOutput</span><span class="params">(w io.Writer)</span></span> &#123;</div><div class="line">	std.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> std.mu.Unlock()</div><div class="line">	std.out = w</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Output</span><span class="params">(calldepth <span class="keyword">int</span>, s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> std.Output(calldepth+<span class="number">1</span>, s) <span class="comment">// +1 for this frame.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>logger结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Logger <span class="keyword">struct</span> &#123;</div><div class="line">	mu     sync.Mutex <span class="comment">// 互斥锁，支持原子写入</span></div><div class="line">	prefix <span class="keyword">string</span>     <span class="comment">// 日志前缀</span></div><div class="line">	flag   <span class="keyword">int</span>        <span class="comment">// 日志输出内容标志位</span></div><div class="line">	out    io.Writer  <span class="comment">// 日志输出位置</span></div><div class="line">	buf    []<span class="keyword">byte</span>     <span class="comment">// 要追加的日志内容</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>logger核心方法 Output</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// s为要写入的日志，calldepth目前均为2</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Logger)</span> <span class="title">Output</span><span class="params">(calldepth <span class="keyword">int</span>, s <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	now := time.Now() <span class="comment">// get this early.</span></div><div class="line">	<span class="keyword">var</span> file <span class="keyword">string</span></div><div class="line">	<span class="keyword">var</span> line <span class="keyword">int</span></div><div class="line">	l.mu.Lock()</div><div class="line">	<span class="keyword">defer</span> l.mu.Unlock()</div><div class="line">	<span class="keyword">if</span> l.flag&amp;(Lshortfile|Llongfile) != <span class="number">0</span> &#123;</div><div class="line">		<span class="comment">// Release lock while getting caller info - it's expensive.</span></div><div class="line">		l.mu.Unlock()</div><div class="line">		<span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">		_, file, line, ok = runtime.Caller(calldepth)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			file = <span class="string">"???"</span></div><div class="line">			line = <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">		l.mu.Lock()</div><div class="line">	&#125;</div><div class="line">	l.buf = l.buf[:<span class="number">0</span>]</div><div class="line">	l.formatHeader(&amp;l.buf, now, file, line)</div><div class="line">	l.buf = <span class="built_in">append</span>(l.buf, s...)</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span> || s[<span class="built_in">len</span>(s)<span class="number">-1</span>] != <span class="string">'\n'</span> &#123;</div><div class="line">		l.buf = <span class="built_in">append</span>(l.buf, <span class="string">'\n'</span>)</div><div class="line">	&#125;</div><div class="line">	_, err := l.out.Write(l.buf)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="编码-解码"><a href="#编码-解码" class="headerlink" title="编码/解码"></a>编码/解码</h3><ul>
<li>xml/json包可以完成json和xml的编码解码</li>
</ul>
<h4 id="解码JSON"><a href="#解码JSON" class="headerlink" title="解码JSON"></a>解码JSON</h4><ul>
<li>使用json包的NewDecode函数和Decode方法来完成json解码</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> gResponse <span class="keyword">struct</span> &#123;</div><div class="line">	ErrCode <span class="keyword">int</span> <span class="string">`json:"errcode"`</span></div><div class="line">	ErrMsg <span class="keyword">string</span> <span class="string">`json:"errmsg"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	resp, err := http.Get(uri)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">	<span class="keyword">var</span> gr gResponse</div><div class="line">	err = json.NewDecoder(resp.Body).Decode(&amp;gr)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(gr)</div><div class="line">&#125;</div><div class="line"><span class="comment">// &#123;41001 access_token missing hints: [xHkBIOLoRa-GmALMa!]&#125;</span></div></pre></td></tr></table></figure>
<ul>
<li>json中NewDecoder方法返回Decoder对象</li>
<li>Decoder结构体从输入流中读取数据并解码成json</li>
<li>Decode方法完成JSON的解析映射</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Decoder&#123;r: r&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// A Decoder reads and decodes JSON values from an input stream.</span></div><div class="line"><span class="keyword">type</span> Decoder <span class="keyword">struct</span> &#123;</div><div class="line">	r       io.Reader</div><div class="line">	buf     []<span class="keyword">byte</span></div><div class="line">	d       decodeState</div><div class="line">	scanp   <span class="keyword">int</span>   <span class="comment">// start of unread data in buf</span></div><div class="line">	scanned <span class="keyword">int64</span> <span class="comment">// amount of data already scanned</span></div><div class="line">	scan    scanner</div><div class="line">	err     error</div><div class="line"></div><div class="line">	tokenState <span class="keyword">int</span></div><div class="line">	tokenStack []<span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dec *Decoder)</span> <span class="title">Decode</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> dec.err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> dec.err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := dec.tokenPrepareForDecode(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> !dec.tokenValueAllowed() &#123;</div><div class="line">		<span class="keyword">return</span> &amp;SyntaxError&#123;msg: <span class="string">"not at beginning of value"</span>, Offset: dec.offset()&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Read whole value into buffer.</span></div><div class="line">	n, err := dec.readValue()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	&#125;</div><div class="line">	dec.d.init(dec.buf[dec.scanp : dec.scanp+n])</div><div class="line">	dec.scanp += n</div><div class="line"></div><div class="line">	err = dec.d.unmarshal(v)</div><div class="line"></div><div class="line">	dec.tokenValueEnd()</div><div class="line"></div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>json文档以string的形式存在，此时使用json.Unmarshal方法完成反序列化处理</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> gResponse <span class="keyword">struct</span> &#123;</div><div class="line">	ErrCode <span class="keyword">int</span> <span class="string">`json:"errcode"`</span></div><div class="line">	ErrMsg <span class="keyword">string</span> <span class="string">`json:"errmsg"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	uri := <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info"</span></div><div class="line">	resp, err := http.Get(uri)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> resp.Body.Close()</div><div class="line"></div><div class="line">	bytes, err := ioutil.ReadAll(resp.Body)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">var</span> gr gResponse</div><div class="line">	err = json.Unmarshal(bytes, &amp;gr)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(<span class="string">"ERROR: "</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	fmt.Println(gr)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="编码JSON"><a href="#编码JSON" class="headerlink" title="编码JSON"></a>编码JSON</h4><ul>
<li>MarshalIndent方法可以完成map和结构体到json的映射</li>
</ul>
<h3 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h3><h4 id="Writer和Reader接口"><a href="#Writer和Reader接口" class="headerlink" title="Writer和Reader接口"></a>Writer和Reader接口</h4><ul>
<li>io包的核心就是Writer和Reader接口<ul>
<li>Writer接口<ul>
<li>Writer接口接收字节切片，返回两个值，写入的字节数和错误输出</li>
<li>Writer接口从p里向底层的数据流写入len(p)字节的数据</li>
<li>Writer无论如何也不能改p中的数据</li>
</ul>
</li>
<li>Reader接口<ul>
<li>Reader接口接收字节切片，返回两个值，读取的字节数和错误输出</li>
<li>Read最多读入len(p)个字节，保存到p</li>
<li>可以使用所有的p的空间来存储临时数据</li>
<li>当字节长度不足len(p)，Read会立刻返回可用的数据，而不是等待更多的数据</li>
<li>当成功读取了部分字节后，发生错误或者读取完成，Read方法会返回读入的字节数</li>
<li>即使有错误发生，当读取的字节数&gt;0时，需要先处理读取的数据，再处理错误</li>
<li>读取的实现，不鼓励返回0个字节并且返回nil值的错误<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">	Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">	Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> b bytes.Buffer</div><div class="line">	b.Write([]<span class="keyword">byte</span>(<span class="string">"Hello "</span>))</div><div class="line"></div><div class="line">	fmt.Fprintf(&amp;b, <span class="string">"World"</span>)</div><div class="line"></div><div class="line">	b.WriteTo(os.Stdout)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Buffe的Write方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Write appends the contents of p to the buffer, growing the buffer as</span></div><div class="line"><span class="comment">// needed. The return value n is the length of p; err is always nil. If the</span></div><div class="line"><span class="comment">// buffer becomes too large, Write will panic with ErrTooLarge.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">Write</span><span class="params">(p []<span class="keyword">byte</span>)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">	b.lastRead = opInvalid</div><div class="line">	m, ok := b.tryGrowByReslice(<span class="built_in">len</span>(p))</div><div class="line">	<span class="keyword">if</span> !ok &#123;</div><div class="line">		m = b.grow(<span class="built_in">len</span>(p))</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">copy</span>(b.buf[m:], p), <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="curl"><a href="#curl" class="headerlink" title="curl"></a>curl</h4><ul>
<li>一个简单的curl,第一个参数指定curl的网站，，第二个参数指定将curl获取的response的body写入的文件名</li>
<li>defer 打开关闭的资源</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	r, err := http.Get(os.Args[<span class="number">1</span>])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	file, err := os.Create(os.Args[<span class="number">2</span>])</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> file.Close()</div><div class="line"></div><div class="line">	dest := io.MultiWriter(os.Stdout, file)</div><div class="line">	io.Copy(dest, r.Body)</div><div class="line">	<span class="keyword">if</span> err := r.Body.Close(); err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatalln(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>标准库由特殊的保证，并且被社区广泛应用</li>
<li>使用标准库会让你的代码更易于管理</li>
<li>接口允许你的代码组合已有的功能</li>
<li>阅读标准库的代码是熟悉go语言习惯的好方法</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/ring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/ring/" itemprop="url">go源码解读-ring</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="ring"><a href="#ring" class="headerlink" title="ring"></a>ring</h2><ul>
<li>ring为环结构，没有开始和结束</li>
<li>本质是双向链表</li>
<li>空ring的next和prev都指向自己</li>
</ul>
<h3 id="ring结构体"><a href="#ring结构体" class="headerlink" title="ring结构体"></a>ring结构体</h3><ul>
<li>Ring结构体包含三个参数<ul>
<li>next 指向当前节点的下一个节点</li>
<li>prev 指向当前节点的上一个节点</li>
<li>Value 当前节点的值</li>
</ul>
</li>
<li>New方法为创建一个包含n个元素的ring的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ring <span class="keyword">struct</span> &#123;</div><div class="line">	next, prev *Ring</div><div class="line">	Value      <span class="keyword">interface</span>&#123;&#125; <span class="comment">// for use by client; untouched by this library</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// New creates a ring of n elements.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	r := <span class="built_in">new</span>(Ring)</div><div class="line">	p := r</div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; n; i++ &#123;</div><div class="line">		p.next = &amp;Ring&#123;prev: p&#125;</div><div class="line">		p = p.next</div><div class="line">	&#125;</div><div class="line">	p.next = r</div><div class="line">	r.prev = p</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Ring结构体的方法"><a href="#Ring结构体的方法" class="headerlink" title="Ring结构体的方法"></a>Ring结构体的方法</h3><ul>
<li>init为初始一个0个节点的Ring结构体的方法</li>
<li>Next返回当前节点的下一个节点</li>
<li>Prev返回当前节点的上一个节点</li>
<li>Move将当前节点移动n个位置</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">init</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	r.next = r</div><div class="line">	r.prev = r</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Next returns the next ring element. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.next</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Prev returns the previous ring element. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.prev</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Move moves n % r.Len() elements backward (n &lt; 0) or forward (n &gt;= 0)</span></div><div class="line"><span class="comment">// in the ring and returns that ring element. r must not be empty.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Move</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> r.next == <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> r.init()</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	<span class="keyword">case</span> n &lt; <span class="number">0</span>:</div><div class="line">		<span class="keyword">for</span> ; n &lt; <span class="number">0</span>; n++ &#123;</div><div class="line">			r = r.prev</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">case</span> n &gt; <span class="number">0</span>:</div><div class="line">		<span class="keyword">for</span> ; n &gt; <span class="number">0</span>; n-- &#123;</div><div class="line">			r = r.next</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="链接操作"><a href="#链接操作" class="headerlink" title="链接操作"></a>链接操作</h4><ul>
<li>Link 将s和r链接到一起，返回r.next<ul>
<li>s和r在一个圆环里，操作会将r和s之间的元素移除到圆环</li>
<li>s和r不在一个圆环里，操作会将r和s合并成一个圆环</li>
</ul>
</li>
<li>Unlink移除n%r.len个元素，本质上是对Link方法的封装</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Link</span><span class="params">(s *Ring)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	n := r.Next()</div><div class="line">	<span class="keyword">if</span> s != <span class="literal">nil</span> &#123;</div><div class="line">		p := s.Prev()</div><div class="line">		<span class="comment">// Note: Cannot use multiple assignment because</span></div><div class="line">		<span class="comment">// evaluation order of LHS is not specified.</span></div><div class="line">		r.next = s</div><div class="line">		s.prev = r</div><div class="line">		n.prev = p</div><div class="line">		p.next = n</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Unlink removes n % r.Len() elements from the ring r, starting</span></div><div class="line"><span class="comment">// at r.Next(). If n % r.Len() == 0, r remains unchanged.</span></div><div class="line"><span class="comment">// The result is the removed subring. r must not be empty.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Unlink</span><span class="params">(n <span class="keyword">int</span>)</span> *<span class="title">Ring</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> r.Link(r.Move(n + <span class="number">1</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Len和Do方法"><a href="#Len和Do方法" class="headerlink" title="Len和Do方法"></a>Len和Do方法</h4><ul>
<li>Len方法返回圆环的长度</li>
<li>Do方法的参数为一个函数f，对于圆环上的每个元素的值，执行该函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">	n := <span class="number">0</span></div><div class="line">	<span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</div><div class="line">		n = <span class="number">1</span></div><div class="line">		<span class="keyword">for</span> p := r.Next(); p != r; p = p.next &#123;</div><div class="line">			n++</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> n</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Do calls function f on each element of the ring, in forward order.</span></div><div class="line"><span class="comment">// The behavior of Do is undefined if f changes *r.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Ring)</span> <span class="title">Do</span><span class="params">(f <span class="keyword">func</span>(<span class="keyword">interface</span>&#123;&#125;)</span>)</span> &#123;</div><div class="line">	<span class="keyword">if</span> r != <span class="literal">nil</span> &#123;</div><div class="line">		f(r.Value)</div><div class="line">		<span class="keyword">for</span> p := r.Next(); p != r; p = p.next &#123;</div><div class="line">			f(p.Value)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/list/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/list/" itemprop="url">go源码解读-list</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><ul>
<li>go语言中的列表采用双向链表来实现</li>
<li>实现过程中主要依赖于两个结构体，Element和List对象</li>
<li>显然list是线程不安全的包</li>
</ul>
<h3 id="Element详解"><a href="#Element详解" class="headerlink" title="Element详解"></a>Element详解</h3><ul>
<li>Element中包含四个字段，类似于Java中的成员变量<ul>
<li>next为当前元素的下一个元素</li>
<li>pre为当前元素的上一个元素</li>
<li>&amp;l.root为链表最后一个元素的下一个元素，同时也是链表第一个元素的上个元素，形如一个环</li>
<li>list标识当前元素归属于哪个链表</li>
<li>Value采用interface{}类型，可以保存任意的数据结构，也就是说go中的链表可以保存一个类似[‘abc’,12,12.03]这样的数据</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Element is an element of a linked list.</span></div><div class="line"><span class="keyword">type</span> Element <span class="keyword">struct</span> &#123;</div><div class="line">	next, prev *Element</div><div class="line"></div><div class="line">  list *List</div><div class="line"></div><div class="line">	Value <span class="keyword">interface</span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Element结构体实现了两个方法<ul>
<li>Next()方法返回当前节点的下一个节点数据</li>
<li>Prev()方法返回当前节点的上一个节点数据</li>
<li>两个方法都屏蔽掉了list.root的情况，也就是如果找到的节点是根节点，则不做返回</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> p := e.next; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</div><div class="line">		<span class="keyword">return</span> p</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> p := e.prev; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</div><div class="line">		<span class="keyword">return</span> p</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ul>
<li>链表包含两个元素<ul>
<li>root 根节点，只用在&amp;root, root.prev, root.next这三种情况</li>
<li>len 链表中的节点数量，不包含根节点</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// List represents a doubly linked list.</span></div><div class="line"><span class="comment">// The zero value for List is an empty list ready to use.</span></div><div class="line"><span class="keyword">type</span> List <span class="keyword">struct</span> &#123;</div><div class="line">	root Element <span class="comment">// sentinel list element, only &amp;root, root.prev, and root.next are used</span></div><div class="line">	<span class="built_in">len</span>  <span class="keyword">int</span>     <span class="comment">// current list length excluding (this) sentinel element</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="初始化列表"><a href="#初始化列表" class="headerlink" title="初始化列表"></a>初始化列表</h4><ul>
<li>list提供一个可外部调用的初始化方法New,实际上是调用了List的Init()方法</li>
<li>Init方法返回一个空列表，也就是root的前后节点都指向自己，并且列表长度为0</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// New returns an initialized list.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">List</span></span> &#123; <span class="keyword">return</span> <span class="built_in">new</span>(List).Init() &#125;</div><div class="line"></div><div class="line"><span class="comment">// Init initializes or clears list l.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">List</span></span> &#123;</div><div class="line">	l.root.next = &amp;l.root</div><div class="line">	l.root.prev = &amp;l.root</div><div class="line">	l.<span class="built_in">len</span> = <span class="number">0</span></div><div class="line">	<span class="keyword">return</span> l</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Len-Front-Back方法"><a href="#Len-Front-Back方法" class="headerlink" title="Len, Front, Back方法"></a>Len, Front, Back方法</h4><ul>
<li>Len返回list中的元素数量，获取复杂度O(1)</li>
<li>Front方法返回列表第一个元素，也就是l.root.next</li>
<li>Back方法返回列表最后一个元素，也就是l.root.prev</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> l.<span class="built_in">len</span> &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Front</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.root.next</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Back</span><span class="params">()</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.root.prev</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Remove方法"><a href="#Remove方法" class="headerlink" title="Remove方法"></a>Remove方法</h4><ul>
<li>Remove方法移除列表中指定元素，这个地方会对e.list做校验，如果不符合则不会进入remove方法</li>
<li>remove方法完成移除元素e的操作，将e.next和e.prev设置为nil，防止内存泄露</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Remove</span><span class="params">(e *Element)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	<span class="keyword">if</span> e.list == l &#123;</div><div class="line">		<span class="comment">// if e.list == l, l must have been initialized when e was inserted</span></div><div class="line">		<span class="comment">// in l or l == nil (e is a zero Element) and l.remove will crash</span></div><div class="line">		l.remove(e)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> e.Value</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// remove removes e from its list, decrements l.len, and returns e.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">remove</span><span class="params">(e *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	e.prev.next = e.next</div><div class="line">	e.next.prev = e.prev</div><div class="line">	e.next = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></div><div class="line">	e.prev = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></div><div class="line">	e.list = <span class="literal">nil</span></div><div class="line">	l.<span class="built_in">len</span>--</div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h3><ul>
<li>lazyInit方法，懒加载，延迟初始化一个空链表</li>
<li>insertValue方法是对insert的一层封装</li>
<li>insert方法将节点e插入到节点at后面</li>
<li>PushFront 将节点插入到root节点之后</li>
<li>PushBach 将节点插入到root.prev之后</li>
<li>InsertBefore 将节点插入到mark节点之前</li>
<li>InsertAfter 将节点插入到mark节点之后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFront</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, &amp;l.root)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBack</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, l.root.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertBefore</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> l.insertValue(v, mark.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertAfter</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	<span class="keyword">return</span> l.insertValue(v, mark)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">lazyInit</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> l.root.next == <span class="literal">nil</span> &#123;</div><div class="line">		l.Init()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">List</span></span> &#123;</div><div class="line">	l.root.next = &amp;l.root</div><div class="line">	l.root.prev = &amp;l.root</div><div class="line">	l.<span class="built_in">len</span> = <span class="number">0</span></div><div class="line">	<span class="keyword">return</span> l</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">insertValue</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.insert(&amp;Element&#123;Value: v&#125;, at)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">insert</span><span class="params">(e, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	n := at.next</div><div class="line">	at.next = e</div><div class="line">	e.prev = at</div><div class="line">	e.next = n</div><div class="line">	n.prev = e</div><div class="line">	e.list = l</div><div class="line">	l.<span class="built_in">len</span>++</div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="移动节点操作"><a href="#移动节点操作" class="headerlink" title="移动节点操作"></a>移动节点操作</h4><ul>
<li>move为节点移动的核心方法，将节点e移动到节点at后面</li>
<li>MoveToFront将节点e移动到root节点之后</li>
<li>MoveToBack将节点e移动到root.prev节点之后</li>
<li>MoveBefore将节点移动到mark节点之前,这个地方如果e.next == mark的时候是不需要移动的</li>
<li>MoveAfter将节点移动到mark节点之后,这个地方如果mark.next == e 也是不需要移动的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToFront</span><span class="params">(e *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || l.root.next == e &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	l.move(e, &amp;l.root)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToBack</span><span class="params">(e *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || l.root.prev == e &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="comment">// see comment in List.Remove about initialization of l</span></div><div class="line">	l.move(e, l.root.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveBefore</span><span class="params">(e, mark *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	l.move(e, mark.prev)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveAfter</span><span class="params">(e, mark *Element)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	l.move(e, mark)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// move moves e to next to at and returns e.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">move</span><span class="params">(e, at *Element)</span> *<span class="title">Element</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> e == at &#123;</div><div class="line">		<span class="keyword">return</span> e</div><div class="line">	&#125;</div><div class="line">	e.prev.next = e.next</div><div class="line">	e.next.prev = e.prev</div><div class="line"></div><div class="line">	n := at.next</div><div class="line">	at.next = e</div><div class="line">	e.prev = at</div><div class="line">	e.next = n</div><div class="line">	n.prev = e</div><div class="line"></div><div class="line">	<span class="keyword">return</span> e</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="列表方法"><a href="#列表方法" class="headerlink" title="列表方法"></a>列表方法</h4><ul>
<li>PushBackList方法将other列表插入到l列表root.prev之后</li>
<li>PushFrontList方法将other列表插入到l列表root节点之后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBackList</span><span class="params">(other *List)</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">for</span> i, e := other.Len(), other.Front(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Next() &#123;</div><div class="line">		l.insertValue(e.Value, l.root.prev)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFrontList</span><span class="params">(other *List)</span></span> &#123;</div><div class="line">	l.lazyInit()</div><div class="line">	<span class="keyword">for</span> i, e := other.Len(), other.Back(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Prev() &#123;</div><div class="line">		l.insertValue(e.Value, &amp;l.root)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/heap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/heap/" itemprop="url">go源码解读-heap</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:24:43+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h2><ul>
<li>go中的堆采用小根堆实现</li>
<li>采用接口形式，也就是需要实现Push,Pop,Len,Less,Swap方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Interface <span class="keyword">interface</span> &#123;</div><div class="line">	sort.Interface</div><div class="line">	Push(x <span class="keyword">interface</span>&#123;&#125;) <span class="comment">// add x as element Len()</span></div><div class="line">	Pop() <span class="keyword">interface</span>&#123;&#125;   <span class="comment">// remove and return element Len() - 1.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="堆的构建"><a href="#堆的构建" class="headerlink" title="堆的构建"></a>堆的构建</h3><ul>
<li>调用init来完成对于堆的构建</li>
<li>比较i与<code>2*i+1</code>, <code>2*i+2</code>的大小进行建堆</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Init</span><span class="params">(h Interface)</span></span> &#123;</div><div class="line">	<span class="comment">// heapify</span></div><div class="line">	n := h.Len()</div><div class="line">	<span class="keyword">for</span> i := n/<span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i-- &#123;</div><div class="line">		down(h, i, n)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">down</span><span class="params">(h Interface, i0, n <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	i := i0</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		j1 := <span class="number">2</span>*i + <span class="number">1</span></div><div class="line">		<span class="keyword">if</span> j1 &gt;= n || j1 &lt; <span class="number">0</span> &#123; <span class="comment">// j1 &lt; 0 after int overflow</span></div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		j := j1 <span class="comment">// left child</span></div><div class="line">		<span class="keyword">if</span> j2 := j1 + <span class="number">1</span>; j2 &lt; n &amp;&amp; h.Less(j2, j1) &#123;</div><div class="line">			j = j2 <span class="comment">// = 2*i + 2  // right child</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !h.Less(j, i) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		h.Swap(i, j)</div><div class="line">		i = j</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> i &gt; i0</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Push-Pop方法"><a href="#Push-Pop方法" class="headerlink" title="Push, Pop方法"></a>Push, Pop方法</h3><ul>
<li>Push方法将数据防止在末尾，逐个节点向上调整</li>
<li>Pop方法将待出堆的节点和末尾节点交换，向下调整根节点</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Push</span><span class="params">(h Interface, x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	h.Push(x)</div><div class="line">	up(h, h.Len()<span class="number">-1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Pop is equivalent to Remove(h, 0).</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Pop</span><span class="params">(h Interface)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	n := h.Len() - <span class="number">1</span></div><div class="line">	h.Swap(<span class="number">0</span>, n)</div><div class="line">	down(h, <span class="number">0</span>, n)</div><div class="line">	<span class="keyword">return</span> h.Pop()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">up</span><span class="params">(h Interface, j <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		i := (j - <span class="number">1</span>) / <span class="number">2</span> <span class="comment">// parent</span></div><div class="line">		<span class="keyword">if</span> i == j || !h.Less(j, i) &#123;</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">		h.Swap(i, j)</div><div class="line">		j = i</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Fix-Remove方法"><a href="#Fix-Remove方法" class="headerlink" title="Fix, Remove方法"></a>Fix, Remove方法</h3><ul>
<li>Remove方法移除树第i个节点，并调整堆结构</li>
<li>Fix方法在数据值便跟时调整堆结构</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Remove</span><span class="params">(h Interface, i <span class="keyword">int</span>)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	n := h.Len() - <span class="number">1</span></div><div class="line">	<span class="keyword">if</span> n != i &#123;</div><div class="line">		h.Swap(i, n)</div><div class="line">		<span class="keyword">if</span> !down(h, i, n) &#123;</div><div class="line">			up(h, i)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> h.Pop()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Fix</span><span class="params">(h Interface, i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> !down(h, i, h.Len()) &#123;</div><div class="line">		up(h, i)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="示例-优先队列"><a href="#示例-优先队列" class="headerlink" title="示例-优先队列"></a>示例-优先队列</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// An Item is something we manage in a priority queue.</span></div><div class="line"><span class="keyword">type</span> Item <span class="keyword">struct</span> &#123;</div><div class="line">	value    <span class="keyword">string</span> <span class="comment">// The value of the item; arbitrary.</span></div><div class="line">	priority <span class="keyword">int</span>    <span class="comment">// The priority of the item in the queue.</span></div><div class="line">	<span class="comment">// The index is needed by update and is maintained by the heap.Interface methods.</span></div><div class="line">	index <span class="keyword">int</span> <span class="comment">// The index of the item in the heap.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// A PriorityQueue implements heap.Interface and holds Items.</span></div><div class="line"><span class="keyword">type</span> PriorityQueue []*Item</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span> &#123; <span class="keyword">return</span> <span class="built_in">len</span>(pq) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="comment">// We want Pop to give us the highest, not lowest, priority so we use greater than here.</span></div><div class="line">	<span class="keyword">return</span> pq[i].priority &gt; pq[j].priority</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq PriorityQueue)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	pq[i], pq[j] = pq[j], pq[i]</div><div class="line">	pq[i].index = i</div><div class="line">	pq[j].index = j</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">Push</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	n := <span class="built_in">len</span>(*pq)</div><div class="line">	item := x.(*Item)</div><div class="line">	item.index = n</div><div class="line">	*pq = <span class="built_in">append</span>(*pq, item)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">Pop</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</div><div class="line">	old := *pq</div><div class="line">	n := <span class="built_in">len</span>(old)</div><div class="line">	item := old[n<span class="number">-1</span>]</div><div class="line">	item.index = <span class="number">-1</span> <span class="comment">// for safety</span></div><div class="line">	*pq = old[<span class="number">0</span> : n<span class="number">-1</span>]</div><div class="line">	<span class="keyword">return</span> item</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// update modifies the priority and value of an Item in the queue.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pq *PriorityQueue)</span> <span class="title">update</span><span class="params">(item *Item, value <span class="keyword">string</span>, priority <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	item.value = value</div><div class="line">	item.priority = priority</div><div class="line">	heap.Fix(pq, item.index)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This example creates a PriorityQueue with some items, adds and manipulates an item,</span></div><div class="line"><span class="comment">// and then removes the items in priority order.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Some items and their priorities.</span></div><div class="line">	items := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;</div><div class="line">		<span class="string">"banana"</span>: <span class="number">3</span>, <span class="string">"apple"</span>: <span class="number">2</span>, <span class="string">"pear"</span>: <span class="number">4</span>,</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Create a priority queue, put the items in it, and</span></div><div class="line">	<span class="comment">// establish the priority queue (heap) invariants.</span></div><div class="line">	pq := <span class="built_in">make</span>(PriorityQueue, <span class="built_in">len</span>(items))</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> value, priority := <span class="keyword">range</span> items &#123;</div><div class="line">		pq[i] = &amp;Item&#123;</div><div class="line">			value:    value,</div><div class="line">			priority: priority,</div><div class="line">			index:    i,</div><div class="line">		&#125;</div><div class="line">		i++</div><div class="line">	&#125;</div><div class="line">	heap.Init(&amp;pq)</div><div class="line"></div><div class="line">	<span class="comment">// Insert a new item and then modify its priority.</span></div><div class="line">	item := &amp;Item&#123;</div><div class="line">		value:    <span class="string">"orange"</span>,</div><div class="line">		priority: <span class="number">1</span>,</div><div class="line">	&#125;</div><div class="line">	heap.Push(&amp;pq, item)</div><div class="line">	pq.update(item, item.value, <span class="number">5</span>)</div><div class="line"></div><div class="line">	<span class="comment">// Take the items out; they arrive in decreasing priority order.</span></div><div class="line">	<span class="keyword">for</span> pq.Len() &gt; <span class="number">0</span> &#123;</div><div class="line">		item := heap.Pop(&amp;pq).(*Item)</div><div class="line">		fmt.Printf(<span class="string">"%.2d:%s "</span>, item.priority, item.value)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Output:</span></div><div class="line">	<span class="comment">// 05:orange 04:pear 03:banana 02:apple</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/17/go语言实战-并发/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/17/go语言实战-并发/" itemprop="url">go语言实战 - 并发</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-17T19:23:36+08:00">
                2020-04-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="go语言实战-并发"><a href="#go语言实战-并发" class="headerlink" title="go语言实战 - 并发"></a>go语言实战 - 并发</h1><h2 id="第六章-并发"><a href="#第六章-并发" class="headerlink" title="第六章 并发"></a>第六章 并发</h2><ul>
<li>go语言的并发是指让某个函数独立于其他函数运行的能力</li>
<li>go语言的并发同步模型来自于<em>通信顺序进程</em>泛型(Communication SequentialProcess，CSP)<ul>
<li>CSP是一种消息传递模型，通过在goroutine之间传递数据来传递消息，而非对数据加锁来实现同步访问</li>
<li>go引入了新数据类型，通道channle</li>
</ul>
</li>
</ul>
<h3 id="并发与并行"><a href="#并发与并行" class="headerlink" title="并发与并行"></a>并发与并行</h3><ul>
<li><p>操作系统的进程与线程</p>
<ul>
<li>进程包含了应用程序在运行时需要用到和维护的各种资源的容器，如内存地址空间，文件，设备的句柄及线程</li>
<li>线程是一个执行空间，被操作系统调度来执行代码</li>
</ul>
</li>
<li><p>操作系统会在物理处理器上调度线程来运行，go语言会在逻辑处理器上调度goroutine来运行</p>
</li>
<li>go语言默认给每个可用的物理处理器分配一个逻辑处理器</li>
<li>一个逻辑处理器可以调度无数个goroutine<ul>
<li>创建一个goroutine并准备运行</li>
<li>goroutine会首先进入调度器的全局运行队列中</li>
<li>调度器将队列中的goroutine分配给一个逻辑处理器，也就是将goroutinue放置到逻辑处理器对应的本地运行队列中</li>
<li>本地运行队列中的goroutine会等待到自己被分配的逻辑处理器执行</li>
</ul>
</li>
</ul>
<h3 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h3><ul>
<li>runtime.GOMAXPROCS可以更改调度器可以使用的逻辑处理器的数量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	runtime.GOMAXPROCS(<span class="number">1</span>)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Start Goroutine"</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">		<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">3</span>; count++ &#123;</div><div class="line">			<span class="keyword">for</span> char := <span class="string">'a'</span>; char &lt; <span class="string">'z'</span>; char++ &#123;</div><div class="line">				fmt.Printf(<span class="string">"%c"</span>, char)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">		<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">3</span>; count++ &#123;</div><div class="line">			<span class="keyword">for</span> char := <span class="string">'A'</span>; char &lt; <span class="string">'Z'</span>; char++ &#123;</div><div class="line">				fmt.Printf(<span class="string">"%c"</span>, char)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Waiting To Finish"</span>)</div><div class="line">	wg.Wait()</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"Finish this"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>设置一个逻辑处理器的结果</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Start Goroutine</div><div class="line">Waiting To Finish</div><div class="line">A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y</div><div class="line">Finish this</div></pre></td></tr></table></figure>
<ul>
<li>设置多个逻辑处理器的结果</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Start Goroutine</div><div class="line">Waiting To Finish</div><div class="line">a b c d e f g h A B C D E F G H I J K L M N i j k l m n o p q r O P Q R S s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y a b c d e f g h i j k l m n o p q r s t u v w x y T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y A B C D E F G H I J K L M N O P Q R S T U V W X Y</div><div class="line">Finish this</div></pre></td></tr></table></figure>
<ul>
<li>一个正运行的goroutine再工作结束前，可以被停止并重新调度，避免一个goroutine长时间占用逻辑处理器</li>
<li>runtime包提供了修改go语言运行时配置参数的能力</li>
<li>并不是逻辑处理器数量越多越好，需要经过基准测试来评估</li>
</ul>
<h3 id="竞争状态"><a href="#竞争状态" class="headerlink" title="竞争状态"></a>竞争状态</h3><ul>
<li>两个或者多个goroutine访问某个共享资源，则称其处于互相竞争的状态</li>
<li>runtime.Gosched()强制调度器切换两个goroutine</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter <span class="keyword">int</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line">		value := counter</div><div class="line">		<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">		runtime.Gosched()</div><div class="line"></div><div class="line">		value++</div><div class="line">		counter = value</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="锁住共享资源"><a href="#锁住共享资源" class="headerlink" title="锁住共享资源"></a>锁住共享资源</h3><h4 id="原子函数"><a href="#原子函数" class="headerlink" title="原子函数"></a>原子函数</h4><ul>
<li>原子函数能够以底层的加锁机制来同步访问整醒变量和指针</li>
<li>atomic包的AddInt64函数会同步整型值的加法，强制同一时刻只能有一个goroutine运行并完成这个加法操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter <span class="keyword">int64</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line"></div><div class="line">		atomic.AddInt64(&amp;counter, <span class="number">1</span>)</div><div class="line"></div><div class="line">		<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">		runtime.Gosched()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>LoadInt64和StoreInt64提供了一种安全地读写一个整型值的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	shutdown <span class="keyword">int64</span></div><div class="line">	wg sync.WaitGroup</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> doWork(<span class="string">"A"</span>)</div><div class="line">	<span class="keyword">go</span> doWork(<span class="string">"B"</span>)</div><div class="line"></div><div class="line">	time.Sleep(<span class="number">1</span>*time.Second)</div><div class="line"></div><div class="line">	fmt.Println(<span class="string">"shutdown now"</span>)</div><div class="line"></div><div class="line">	atomic.StoreInt64(&amp;shutdown, <span class="number">1</span>)</div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(name <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		fmt.Printf(<span class="string">"Doing %s Work \n"</span>, name)</div><div class="line">		time.Sleep(<span class="number">250</span>*time.Millisecond)</div><div class="line"></div><div class="line">		<span class="keyword">if</span> atomic.LoadInt64(&amp;shutdown) == <span class="number">1</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"Shutting %s Down \n"</span>, name)</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h3><ul>
<li>互斥锁mutex用于在代码上创建一个临界区，保证统一时间只有一个goroutine可以执行这个临界区代码，修正上述代码如下</li>
<li>使用大括号可以使得临界区看起来更加清晰</li>
<li>强制退出当前线程之后，如果调度器分配其他线程执行，会因为拿不到临界区的互斥锁而等待，从而保证调度器会分配回当前线程来进行程序继续执行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	counter   <span class="keyword">int</span></div><div class="line">	waitGroup sync.WaitGroup</div><div class="line">	mutex     sync.Mutex</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	waitGroup.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">1</span>)</div><div class="line">	<span class="keyword">go</span> incCounter(<span class="number">2</span>)</div><div class="line"></div><div class="line">	waitGroup.Wait()</div><div class="line">	fmt.Println(<span class="string">"Final Counter: "</span>, counter)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">incCounter</span><span class="params">(Iid <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> waitGroup.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> count := <span class="number">0</span>; count &lt; <span class="number">2</span>; count++ &#123;</div><div class="line">		mutex.Lock()</div><div class="line">		&#123;</div><div class="line">			value := counter</div><div class="line">			<span class="comment">// 退出当前goroutine，将其放回队列</span></div><div class="line">			runtime.Gosched()</div><div class="line"></div><div class="line">			value++</div><div class="line">			counter = value</div><div class="line">		&#125;</div><div class="line">		mutex.Unlock()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通道"><a href="#通道" class="headerlink" title="通道"></a>通道</h3><ul>
<li>通道通过发送和接收需要共享的资源，在goroutine之间做同步</li>
<li>声明通道时，需要指定将要被共享的数据的类型，可以通过通道共享内置类型，命名类型，结构类型和引用类型的值或者指针</li>
<li>make关键字来创建通道</li>
<li><code>&lt;-</code>运算符表示数据的流向</li>
</ul>
<h4 id="无缓冲的通道"><a href="#无缓冲的通道" class="headerlink" title="无缓冲的通道"></a>无缓冲的通道</h4><ul>
<li>无缓冲的通道指的是接手前没有能力保存任何值的通道</li>
<li>这种对通道进行发送和接收的交互 行为本身就是同步的，否则会阻塞，发送和接收的goroutine互相依赖</li>
<li>网球比赛示例如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> wg sync.WaitGroup</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UnixNano())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	court := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">	wg.Add(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> player(<span class="string">"Nodal"</span>, court)</div><div class="line">	<span class="keyword">go</span> player(<span class="string">"Dick"</span>, court)</div><div class="line"></div><div class="line">	court &lt;- <span class="number">1</span></div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">player</span><span class="params">(name <span class="keyword">string</span>, court <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		ball, ok := &lt;- court</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			fmt.Printf(<span class="string">"Player %s win \n"</span>, name)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		n := rand.Intn(<span class="number">100</span>)</div><div class="line">		<span class="keyword">if</span> n % <span class="number">13</span> == <span class="number">0</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"Player %s missed \n"</span>, name)</div><div class="line">			<span class="built_in">close</span>(court)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		fmt.Printf(<span class="string">"Player %s hit %d \n"</span>, name, ball)</div><div class="line"></div><div class="line">		ball++</div><div class="line"></div><div class="line">		court &lt;- ball</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="有缓冲通道"><a href="#有缓冲通道" class="headerlink" title="有缓冲通道"></a>有缓冲通道</h3><ul>
<li>有缓冲通道时一种在被接收前能存储一个或多个值的通道</li>
<li>并不强制要求goroutine之间必须同时完成接收和发送</li>
<li>4个goroutine来完成10个工作可以使用带缓冲的通道来实现</li>
<li>需要注意，通道关闭之后是只能从通道读取数据，不能写入，不会有数据丢失</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	numberGoroutine = <span class="number">4</span></div><div class="line">	taskLoad = <span class="number">10</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> wg sync.WaitGroup</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	rand.Seed(time.Now().UnixNano())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	tasks := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>, taskLoad)</div><div class="line">	wg.Add(numberGoroutine)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> gr := <span class="number">1</span>; gr &lt;= numberGoroutine; gr++ &#123;</div><div class="line">		<span class="keyword">go</span> worker(tasks, gr)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> post := <span class="number">1</span>; post &lt;= taskLoad; post++ &#123;</div><div class="line">		tasks &lt;- fmt.Sprintf(<span class="string">"Task %d"</span>, post)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="built_in">close</span>(tasks)</div><div class="line">	wg.Wait()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(tasks <span class="keyword">chan</span> <span class="keyword">string</span>, worker <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> wg.Done()</div><div class="line"></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		task, ok := &lt;- tasks</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			fmt.Printf(<span class="string">"Worker %d shutdown \n"</span>, worker)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">		fmt.Printf(<span class="string">"Worker %d start work %s \n"</span>, worker, task)</div><div class="line"></div><div class="line">		time.Sleep(time.Duration(rand.Int63n(<span class="number">100</span>))*time.Millisecond)</div><div class="line">		fmt.Printf(<span class="string">"Worker %d finshed work %s \n"</span>, worker, task)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">Worker 2 start work Task 1</span></div><div class="line"><span class="comment">Worker 4 start work Task 4</span></div><div class="line"><span class="comment">Worker 1 start work Task 2</span></div><div class="line"><span class="comment">Worker 3 start work Task 3</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 4</span></div><div class="line"><span class="comment">Worker 4 start work Task 5</span></div><div class="line"><span class="comment">Worker 1 finshed work Task 2</span></div><div class="line"><span class="comment">Worker 1 start work Task 6</span></div><div class="line"><span class="comment">Worker 3 finshed work Task 3</span></div><div class="line"><span class="comment">Worker 3 start work Task 7</span></div><div class="line"><span class="comment">Worker 2 finshed work Task 1</span></div><div class="line"><span class="comment">Worker 2 start work Task 8</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 5</span></div><div class="line"><span class="comment">Worker 4 start work Task 9</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 9</span></div><div class="line"><span class="comment">Worker 4 start work Task 10</span></div><div class="line"><span class="comment">Worker 1 finshed work Task 6</span></div><div class="line"><span class="comment">Worker 1 shutdown</span></div><div class="line"><span class="comment">Worker 2 finshed work Task 8</span></div><div class="line"><span class="comment">Worker 3 finshed work Task 7</span></div><div class="line"><span class="comment">Worker 3 shutdown</span></div><div class="line"><span class="comment">Worker 2 shutdown</span></div><div class="line"><span class="comment">Worker 4 finshed work Task 10</span></div><div class="line"><span class="comment">Worker 4 shutdown</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>并发是指goroutine运行的时候是互相独立的</li>
<li>使用关键字go创建goroutine来运行函数</li>
<li>goroutine在逻辑处理器上执行，而逻辑处理器则具有独立的系统线程和运行队列</li>
<li>竞争状态是指两个或者多个goroutine试图访问同一个资源</li>
<li>原子函数和互斥锁提供了一种防止出现竞争状态的方法</li>
<li>通道提供了一种在两个goroutine之间共享数据的简单方法</li>
<li>无缓冲的通道保证同时交换数据，有缓冲的通道不做这种保证</li>
</ul>
<h2 id="第七章-并发模式"><a href="#第七章-并发模式" class="headerlink" title="第七章 并发模式"></a>第七章 并发模式</h2><h3 id="runner"><a href="#runner" class="headerlink" title="runner"></a>runner</h3><ul>
<li>runner包用于展示如何通过通道来监视程序的执行时间</li>
<li>runner包也可以终止程序</li>
<li>适合用于定时任务中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ErrTimeout = errors.New(<span class="string">"received timeout"</span>)</div><div class="line"><span class="keyword">var</span> ErrInterrupt = errors.New(<span class="string">"received interrupt"</span>)</div><div class="line"></div><div class="line"><span class="comment">// Runner 在给定的超时时间内执行一组任务，并且在操作系统发出终端信号时结束这些任务</span></div><div class="line"><span class="keyword">type</span> Runner <span class="keyword">struct</span> &#123;</div><div class="line">	<span class="comment">// 操作系统信号</span></div><div class="line">	interrupt <span class="keyword">chan</span> os.Signal</div><div class="line"></div><div class="line">	complete <span class="keyword">chan</span> error</div><div class="line"></div><div class="line">	timeout &lt;-<span class="keyword">chan</span> time.Time</div><div class="line"></div><div class="line">	tasks []<span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewRunner</span><span class="params">(d time.Duration)</span> *<span class="title">Runner</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> &amp;Runner&#123;</div><div class="line">		interrupt: <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">1</span>),</div><div class="line">		complete: <span class="built_in">make</span>(<span class="keyword">chan</span> error),</div><div class="line">		timeout: time.After(d),</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Add</span><span class="params">(tasks ...<span class="keyword">func</span>(<span class="keyword">int</span>)</span>)</span>  &#123;</div><div class="line">	r.tasks = <span class="built_in">append</span>(r.tasks, tasks...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">Start</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	signal.Notify(r.interrupt, os.Interrupt)</div><div class="line"></div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		r.complete &lt;- r.run()</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> err := &lt;- r.complete:</div><div class="line">		<span class="keyword">return</span> err</div><div class="line">	<span class="keyword">case</span> &lt;-r.timeout:</div><div class="line">		<span class="keyword">return</span> ErrTimeout</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> id, task := <span class="keyword">range</span> r.tasks &#123;</div><div class="line">		<span class="keyword">if</span> r.gotInterrupt() &#123;</div><div class="line">			<span class="keyword">return</span> ErrInterrupt</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		task(id)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Runner)</span> <span class="title">gotInterrupt</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> &lt;- r.interrupt:</div><div class="line">		signal.Stop(r.interrupt)</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>函数调用方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> timeout = <span class="number">3</span> * time.Second</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"Starting work"</span>)</div><div class="line"></div><div class="line">	r := runner.NewRunner(timeout)</div><div class="line"></div><div class="line">	r.Add(createTask(), createTask(), createTask())</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err := r.Start(); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">switch</span> err &#123;</div><div class="line">		<span class="keyword">case</span> runner.ErrTimeout:</div><div class="line">			log.Println(<span class="string">"Terminating due to timeout."</span>)</div><div class="line">			os.Exit(<span class="number">1</span>)</div><div class="line">		<span class="keyword">case</span> runner.ErrInterrupt:</div><div class="line">			log.Println(<span class="string">"Terminating due to interrupt"</span>)</div><div class="line">			os.Exit(<span class="number">2</span>)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	log.Println(<span class="string">"Process ended."</span>)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createTask</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">		log.Printf(<span class="string">"Processor - Task %d."</span>, id)</div><div class="line">		time.Sleep(time.Duration(id) * time.Second)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h3><ul>
<li>pool用于展示如何使用有缓冲的通道实现资源池</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> pool</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"errors"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	m sync.Mutex</div><div class="line">	resources <span class="keyword">chan</span> io.Closer</div><div class="line">	factory <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span></div><div class="line"><span class="function">	<span class="title">closed</span> <span class="title">bool</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPool</span><span class="params">(fn <span class="keyword">func</span>()</span> <span class="params">(io.Closer, error)</span>, <span class="title">size</span> <span class="title">uint</span>) <span class="params">(*Pool, error)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> size &lt;= <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">"size value too small"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;Pool&#123;</div><div class="line">		factory:fn,</div><div class="line">		resources: <span class="built_in">make</span>(<span class="keyword">chan</span> io.Closer, size),</div><div class="line">	&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> ErrPoolClosed = errors.New(<span class="string">"pool has been closed"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Acquire</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> r, ok := &lt;- p.resources:</div><div class="line">		log.Println(<span class="string">"Acquire:"</span>, <span class="string">"Shared Resource"</span>)</div><div class="line">		<span class="keyword">if</span> !ok &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, ErrPoolClosed</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> r, <span class="literal">nil</span></div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		log.Println(<span class="string">"Acquire:"</span>, <span class="string">"New Resource"</span>)</div><div class="line">		<span class="keyword">return</span> p.factory()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Release</span><span class="params">(r io.Closer)</span></span> &#123;</div><div class="line">	p.m.Lock()</div><div class="line">	<span class="keyword">defer</span> p.m.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> p.closed &#123;</div><div class="line">		r.Close()</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> p.resources &lt;- r:</div><div class="line">		log.Println(<span class="string">"Release: "</span>, <span class="string">"In Queue"</span>)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		log.Println(<span class="string">"Release:"</span>, <span class="string">"Closing"</span>)</div><div class="line">		r.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</div><div class="line">	p.m.Lock()</div><div class="line">	<span class="keyword">defer</span> p.m.Unlock()</div><div class="line"></div><div class="line">	<span class="keyword">if</span> p.closed &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	p.closed = <span class="literal">true</span></div><div class="line"></div><div class="line">	<span class="built_in">close</span>(p.resources)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> r := <span class="keyword">range</span> p.resources&#123;</div><div class="line">		r.Close()</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>连接池的使用代码如下</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"api/books/go-in-action/7-concurrency-pattern/pool"</span></div><div class="line">	<span class="string">"io"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"math/rand"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"sync/atomic"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> (</div><div class="line">	maxGoroutines = <span class="number">25</span></div><div class="line">	poolResources = <span class="number">2</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> dbConnection <span class="keyword">struct</span> &#123;</div><div class="line">	ID <span class="keyword">int32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(conn *dbConnection)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	log.Println(<span class="string">"Close: Connection"</span>, conn.ID)</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> idCounter <span class="keyword">int32</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">createConnection</span><span class="params">()</span> <span class="params">(io.Closer, error)</span></span> &#123;</div><div class="line">	id := atomic.AddInt32(&amp;idCounter, <span class="number">1</span>)</div><div class="line">	log.Println(<span class="string">"Create: New Connection"</span>, id)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;dbConnection&#123;ID:id&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(maxGoroutines)</div><div class="line"></div><div class="line">	p, err := pool.NewPool(createConnection, poolResources)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(err)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">for</span> query := <span class="number">0</span>; query &lt; maxGoroutines; query++ &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(q <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">			performQueries(q, p)</div><div class="line">			wg.Done()</div><div class="line">		&#125;(query)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	wg.Wait()</div><div class="line">	log.Println(<span class="string">"Shutdown Program"</span>)</div><div class="line">	p.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">performQueries</span><span class="params">(query <span class="keyword">int</span>, p *pool.Pool)</span></span> &#123;</div><div class="line">	conn, err := p.Acquire()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Println(err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">defer</span> p.Release(conn)</div><div class="line"></div><div class="line">	time.Sleep(time.Duration(rand.Intn(<span class="number">1000</span>)) * time.Millisecond)</div><div class="line">	log.Printf(<span class="string">"QID[%d] CID[%d] \n"</span>, query, conn.(*dbConnection).ID)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="work"><a href="#work" class="headerlink" title="work"></a>work</h3><ul>
<li>work包的目的是展示如何使用无缓冲的通道来创建一个goroutine池</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> work</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Worker <span class="keyword">interface</span> &#123;</div><div class="line">	Task()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</div><div class="line">	work <span class="keyword">chan</span> Worker</div><div class="line">	wg sync.WaitGroup</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(maxGoroutines <span class="keyword">int</span>)</span> *<span class="title">Pool</span></span> &#123;</div><div class="line">	p := Pool&#123;</div><div class="line">		work: <span class="built_in">make</span>(<span class="keyword">chan</span> Worker),</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	p.wg.Add(maxGoroutines)</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">1</span>; i &lt; maxGoroutines; i++ &#123;</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			<span class="keyword">for</span> w := <span class="keyword">range</span> p.work &#123;</div><div class="line">				w.Task()</div><div class="line">			&#125;</div><div class="line">			p.wg.Done()</div><div class="line">		&#125;()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;p</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Run</span><span class="params">(w Worker)</span></span> &#123;</div><div class="line">	p.work &lt;- w</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pool)</span> <span class="title">Shutdown</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="built_in">close</span>(p.work)</div><div class="line">	p.wg.Wait()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>运行函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"api/books/go-in-action/7-concurrency-pattern/work"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"sync"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">var</span> names = []<span class="keyword">string</span> &#123;</div><div class="line">	<span class="string">"steve"</span>,</div><div class="line">	<span class="string">"bob"</span>,</div><div class="line">	<span class="string">"mary"</span>,</div><div class="line">	<span class="string">"therese"</span>,</div><div class="line">	<span class="string">"jason"</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> namePrinter <span class="keyword">struct</span> &#123;</div><div class="line">	name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *namePrinter)</span> <span class="title">Task</span><span class="params">()</span></span> &#123;</div><div class="line">	log.Println(m.name)</div><div class="line">	time.Sleep(time.Second)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	p := work.New(<span class="number">2</span>)</div><div class="line"></div><div class="line">	<span class="keyword">var</span> wg sync.WaitGroup</div><div class="line">	wg.Add(<span class="number">100</span> * <span class="built_in">len</span>(names))</div><div class="line"></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</div><div class="line">		<span class="keyword">for</span> _, name := <span class="keyword">range</span> names &#123;</div><div class="line">			np := namePrinter&#123;name:name&#125;</div><div class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">				p.Run(&amp;np)</div><div class="line">				wg.Done()</div><div class="line">			&#125;()</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	wg.Wait()</div><div class="line">	p.Shutdown()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><ul>
<li>可以使用通道来控制程序的声明周期</li>
<li>带default分支的select语句可以用来尝试向通道发送或者接受数据，而不会被阻塞</li>
<li>有缓冲的通道可以用来管理一组可服用的资源</li>
<li>语言运行时会处理好通道的协作和同步</li>
<li>使用无缓冲的通道来创建完成工作的goroutines池</li>
<li>任何时间都可以用无缓冲的通道来让两个goroutine交换数据，在通道操作完成时一定保证对方接收到了数据</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/the-way-to-go-advanced/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/16/the-way-to-go-advanced/" itemprop="url">the way to go advaced</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T14:22:48+08:00">
                2020-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="第12章-读写数据"><a href="#第12章-读写数据" class="headerlink" title="第12章 读写数据"></a>第12章 读写数据</h1><h2 id="12-1-读取用户的输入"><a href="#12-1-读取用户的输入" class="headerlink" title="12.1 读取用户的输入"></a>12.1 读取用户的输入</h2><ul>
<li>fmt.Scanln扫描来自标准输入的文本，空格分隔，直到换行为止</li>
<li>fmt.Scanf第一个参数用来格式化字符串</li>
<li>fmt.Sscan从字符串读取</li>
<li>bufio.Reader缓冲读，读到指定字符输出一次</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">inputReader := bufio.NewReader(os.Stdin)</div><div class="line">fmt.Println(<span class="string">"Please enter your name:"</span>)</div><div class="line">input, err := inputReader.ReadString(<span class="string">'\n'</span>)</div></pre></td></tr></table></figure>
<h2 id="12-2-文件读写"><a href="#12-2-文件读写" class="headerlink" title="12.2 文件读写"></a>12.2 文件读写</h2><h3 id="12-2-1-读文件"><a href="#12-2-1-读文件" class="headerlink" title="12.2.1 读文件"></a>12.2.1 读文件</h3><ul>
<li>go语言中os.File类型的指针叫做文件句柄</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    inputFile, inputError := os.Open(<span class="string">"input.dat"</span>)</div><div class="line">    <span class="keyword">if</span> inputError != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"An error occurred on opening the inputfile\n Does the file exist?\n Have you got acces to it?\n"</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> inputFile.Close()</div><div class="line">    inputReader := bufio.NewReader(inputFile)</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        inputString, readerError := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> readerError == io.EOF &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"The input was: %s"</span>, inputString)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>将整个文件的内容读到一个字符串里边去 - ioutil.ReadFile(),第一个返回值是[]byte，第二个是error</li>
<li>带缓冲的读取 - bufio.Reader.Read()</li>
<li>按列读取文件中的数据，空格分隔，fmt.Fscanln(file, str1 str2 str3)</li>
</ul>
<h3 id="12-2-2-compress包：读取压缩文件"><a href="#12-2-2-compress包：读取压缩文件" class="headerlink" title="12.2.2 compress包：读取压缩文件"></a>12.2.2 compress包：读取压缩文件</h3><ul>
<li>compress包支持的压缩文件格式为bzip2,flate,gzip,lzw,zlib</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fz, err := gzip.NewReader(fi)</div></pre></td></tr></table></figure>
<h3 id="12-2-3-写文件"><a href="#12-2-3-写文件" class="headerlink" title="12.2.3 写文件"></a>12.2.3 写文件</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">outputFile, outputError := os.OpenFile(<span class="string">"output.dat"</span>, os.O_WRONLY|os.O_CREATE, <span class="number">0666</span>)</div><div class="line"><span class="keyword">if</span> outputError != <span class="literal">nil</span> &#123;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> outputFile.Close()</div><div class="line">outputWriter := bufio.NewWriter(outputFile)</div><div class="line">outputString := <span class="string">"Hello hello hello"</span></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">    outputWriter.WriteString(outputString)</div><div class="line">&#125;</div><div class="line">outputWrite.Flush()</div></pre></td></tr></table></figure>
<ul>
<li>os.O_RDONLY</li>
<li>os.O_WRONLY</li>
<li>os.O_CREATE：不存在创建</li>
<li>os.O_TRUNC：存在截断长度为0，类似清空</li>
<li>使用os.Stdout.WriteString(“string”) 可以输出到屏幕</li>
</ul>
<h2 id="12-3-文件拷贝"><a href="#12-3-文件拷贝" class="headerlink" title="12.3 文件拷贝"></a>12.3 文件拷贝</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    CopyFile(<span class="string">"target.txt"</span>, <span class="string">"source.txt"</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CopyFile</span><span class="params">(dstName, srcName <span class="keyword">string</span>)</span> <span class="params">(written <span class="keyword">int64</span>, err error)</span></span> &#123;</div><div class="line">    src, err := os.Open(srcName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> src.Close()</div><div class="line"></div><div class="line">    dst, err := os.Create(dstName)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="built_in">panic</span>()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> dst.Close()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> io.Copy(dst, src)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-4-从命令行读取参数"><a href="#12-4-从命令行读取参数" class="headerlink" title="12.4 从命令行读取参数"></a>12.4 从命令行读取参数</h2><h3 id="12-4-1-os包"><a href="#12-4-1-os包" class="headerlink" title="12.4.1 os包"></a>12.4.1 os包</h3><ul>
<li>os包中的os.Args来处理命令行参数，在程序启动后读取命令行输入的参数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    who := <span class="string">"Alice"</span></div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(os.Args) &gt; <span class="number">1</span> &#123;</div><div class="line">        who += strings.Join(os.Args[<span class="number">1</span>:], <span class="string">" "</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">"hello"</span>, who)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="12-4-2-flag包"><a href="#12-4-2-flag包" class="headerlink" title="12.4.2 flag包"></a>12.4.2 flag包</h3><ul>
<li>flag包可以用来替换变量</li>
<li>flag.Parse()扫描参数列表或者常量列表</li>
<li>flag.Arg(0) 第一个参数</li>
</ul>
<h2 id="12-5-buffer读取文件"><a href="#12-5-buffer读取文件" class="headerlink" title="12.5 buffer读取文件"></a>12.5 buffer读取文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(r *bufio.Reader)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf, err := r.ReadBytes(<span class="string">'\n'</span>)</div><div class="line">        <span class="keyword">if</span> err == io.EOF &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Fprintf(os.Stdout, <span class="string">"%s"</span>, buf)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    <span class="keyword">if</span> flag.NArgs() == <span class="number">0</span> &#123;</div><div class="line">        cat(bufio.NewReader(os.Stdin))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; flag.NArg(); i++ &#123;</div><div class="line">        f, err := os.Open(flag.Arg(i))</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        cat(bufio.NewReader(f))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-6-用切片读写文件"><a href="#12-6-用切片读写文件" class="headerlink" title="12.6 用切片读写文件"></a>12.6 用切片读写文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *os.File)</span></span> &#123;</div><div class="line">    <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">    <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">switch</span> nr, err := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">        <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">            fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading: %s\n"</span>, err.Error())</div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">        <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">if</span> nw, ew := os.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">                fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing: %s\n"</span>, ew.Error())</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-7-defer关闭文件"><a href="#12-7-defer关闭文件" class="headerlink" title="12.7 defer关闭文件"></a>12.7 defer关闭文件</h2><p>函数退出前会执行文件关闭</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">data</span><span class="params">(name <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">    f, _ := os.Open(name, os.O_RDONLY, <span class="number">0</span>)</div><div class="line">    <span class="keyword">defer</span> f.Close()</div><div class="line">    contents, _ := ioutil.ReadAll(f)</div><div class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(contents)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-8-fmt-Fprintf"><a href="#12-8-fmt-Fprintf" class="headerlink" title="12.8 fmt.Fprintf"></a>12.8 fmt.Fprintf</h2><p>接口概念阐述例子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// unbuffered</span></div><div class="line">    fmt.Fprintf(os.Stdout, <span class="string">"%s\n"</span>, <span class="string">"hello world! - unbuffered"</span>)</div><div class="line">    <span class="comment">// buffered: os.Stdout implements io.Writer</span></div><div class="line">    buf := bufio.NewWriter(os.Stdout)</div><div class="line">    <span class="comment">// and now so does buf.</span></div><div class="line">    fmt.Fprintf(buf, <span class="string">"%s\n"</span>, <span class="string">"hello world! - buffered"</span>)</div><div class="line">    buf.Flush()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>函数签名：<code>func Fprintf(w io.Writer, format string, a ...interface{}) (n int, err error)</code></p>
</li>
<li><p>第一个参数必须实现io.Writer接口</p>
</li>
</ul>
<h2 id="12-9-json数据格式"><a href="#12-9-json数据格式" class="headerlink" title="12.9 json数据格式"></a>12.9 json数据格式</h2><ul>
<li><p>编码格式JSON，XML，gob等</p>
</li>
<li><p>术语</p>
<ul>
<li>数据结构-&gt;指定格式=序列化或者编码-传输之前</li>
<li>指定格式-&gt;数据结构=反序列化或者解码-传输之后</li>
</ul>
</li>
<li><p>序列化是将内存中的数据结构转换成指定格式</p>
</li>
<li><p>json.Marshal() - 编码，web中使用json.MarshalforHTML()</p>
</li>
<li><p>JSON和go类型对应：</p>
<ul>
<li>bool-boolean</li>
<li>float64-number</li>
<li>string-string</li>
<li>nil-null</li>
</ul>
</li>
<li><p>编码要求：</p>
<ul>
<li>JSON 对象只支持字符串类型的 key；要编码一个 Go map 类型，map 必须是 map[string]T（T是 json 包中支持的任何类型）</li>
<li>Channel，复杂类型和函数类型不能被编码</li>
<li>不支持循环数据结构；它将引起序列化进入一个无限循环</li>
<li>指针可以被编码，实际上是对指针指向的值进行编码（或者指针是 nil）</li>
</ul>
</li>
<li><p>反序列化</p>
<ul>
<li>json.Unmarshal(json, &amp;v)</li>
</ul>
</li>
<li><p>编码和解码流</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewDecoder</span><span class="params">(r io.Reader)</span> *<span class="title">Decoder</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewEncoder</span><span class="params">(r io.Writer)</span> *<span class="title">Encoder</span></span></div></pre></td></tr></table></figure>
<ul>
<li>json到文件 encode</li>
<li>文件到json decode</li>
</ul>
<h2 id="12-10-XML数据格式"><a href="#12-10-XML数据格式" class="headerlink" title="12.10 XML数据格式"></a>12.10 XML数据格式</h2><ul>
<li>encoding/xml包含了xml解析器来解析xml内容</li>
<li>marshal()，unMarshal()完成数据结构和xml内容的转换</li>
<li>xml中的标签<ul>
<li>StartElement</li>
<li>Chardata</li>
<li>EndElement</li>
<li>Comment</li>
<li>Directive</li>
<li>ProcInst</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    input := <span class="string">"&lt;Person&gt;&lt;FirstName&gt;Laura&lt;/FirstName&gt;&lt;LastName&gt;Lynn&lt;/LastName&gt;&lt;/Person&gt;"</span></div><div class="line">    inputReader := strings.NewReader(input)</div><div class="line">    p := xml.NewDecoder(inputReader)</div><div class="line">    <span class="keyword">for</span> t, err = p.Token(); err == <span class="literal">nil</span>; t, err = p.Token() &#123;</div><div class="line">        <span class="keyword">switch</span> token := t.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> xml.StartElement:</div><div class="line">            name := token.Name.Local</div><div class="line">            fmt.Printf(<span class="string">"Token name: %s\n"</span>, name)</div><div class="line">            <span class="keyword">for</span> _, attr := <span class="keyword">range</span> token.Attr &#123;</div><div class="line">                attrName := attr.Name.Local</div><div class="line">                attrValue := attr.Value</div><div class="line">                fmt.Printf(<span class="string">"An attribute is: %s %s\n"</span>, attrName, attrValue)</div><div class="line">                <span class="comment">// ...</span></div><div class="line">            &#125;</div><div class="line">        <span class="keyword">case</span> xml.EndElement:</div><div class="line">            fmt.Println(<span class="string">"End of token"</span>)</div><div class="line">        <span class="keyword">case</span> xml.CharData:</div><div class="line">            content := <span class="keyword">string</span>([]<span class="keyword">byte</span>(token))</div><div class="line">            fmt.Printf(<span class="string">"This is the content: %v\n"</span>, content)</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            <span class="comment">// ...</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Gob传输数据"><a href="#Gob传输数据" class="headerlink" title="Gob传输数据"></a>Gob传输数据</h2><ul>
<li>Gob是go自己的以二进制形式序列化和反序列化程序数据的格式</li>
<li>Gob通常用于远程调用参数和结果的传输，机器和程序之间的数据传输</li>
<li>Gob只用于go语言中</li>
<li>Gob 文件或流是完全自描述的：里面包含的所有类型都有一个对应的描述，并且总是可以用 Go 解码，而不需要了解文件的内容。</li>
<li>可导出字段会被编码，零值会被忽略</li>
<li>Gob 使用通用的 io.Writer 接口，通过 NewEncoder() 函数创建 Encoder 对象并调用 Encode()；相反的过程使用通用的 io.Reader 接口，通过 NewDecoder() 函数创建 Decoder 对象并调用 Decode()</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> P <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y, Z <span class="keyword">int</span></div><div class="line">    Name    <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Q <span class="keyword">struct</span> &#123;</div><div class="line">    X, Y *<span class="keyword">int32</span></div><div class="line">    Name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// Initialize the encoder and decoder.  Normally enc and dec would be</span></div><div class="line">    <span class="comment">// bound to network connections and the encoder and decoder would</span></div><div class="line">    <span class="comment">// run in different processes.</span></div><div class="line">    <span class="keyword">var</span> network bytes.Buffer   <span class="comment">// Stand-in for a network connection</span></div><div class="line">    enc := gob.NewEncoder(&amp;network) <span class="comment">// Will write to network.</span></div><div class="line">    dec := gob.NewDecoder(&amp;network)    <span class="comment">// Will read from network.</span></div><div class="line">    <span class="comment">// Encode (send) the value.</span></div><div class="line">    err := enc.Encode(P&#123;<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="string">"Pythagoras"</span>&#125;)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"encode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Decode (receive) the value.</span></div><div class="line">    <span class="keyword">var</span> q Q</div><div class="line">    err = dec.Decode(&amp;q)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Fatal(<span class="string">"decode error:"</span>, err)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"%q: &#123;%d,%d&#125;\n"</span>, q.Name, *q.X, *q.Y)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编码到文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> &#123;</div><div class="line">    Type             <span class="keyword">string</span></div><div class="line">    City             <span class="keyword">string</span></div><div class="line">    Country          <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> VCard <span class="keyword">struct</span> &#123;</div><div class="line">    FirstName    <span class="keyword">string</span></div><div class="line">    LastName    <span class="keyword">string</span></div><div class="line">    Addresses    []*Address</div><div class="line">    Remark        <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> content    <span class="keyword">string</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    pa := &amp;Address&#123;<span class="string">"private"</span>, <span class="string">"Aartselaar"</span>,<span class="string">"Belgium"</span>&#125;</div><div class="line">    wa := &amp;Address&#123;<span class="string">"work"</span>, <span class="string">"Boom"</span>, <span class="string">"Belgium"</span>&#125;</div><div class="line">    vc := VCard&#123;<span class="string">"Jan"</span>, <span class="string">"Kersschot"</span>, []*Address&#123;pa,wa&#125;, <span class="string">"none"</span>&#125;</div><div class="line">    <span class="comment">// fmt.Printf("%v: \n", vc) // &#123;Jan Kersschot [0x126d2b80 0x126d2be0] none&#125;:</span></div><div class="line">    <span class="comment">// using an encoder:</span></div><div class="line">    file, _ := os.OpenFile(<span class="string">"vcard.gob"</span>, os.O_CREATE|os.O_WRONLY, <span class="number">0666</span>)</div><div class="line">    <span class="keyword">defer</span> file.Close()</div><div class="line">    enc := gob.NewEncoder(file)</div><div class="line">    err := enc.Encode(vc)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Println(<span class="string">"Error in encoding gob"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="12-12-go中的密码学"><a href="#12-12-go中的密码学" class="headerlink" title="12.12 go中的密码学"></a>12.12 go中的密码学</h2><ul>
<li>hash 包：实现了 adler32、crc32、crc64 和 fnv 校验；</li>
<li>crypto 包：实现了其它的 hash 算法，比如 md4、md5、sha1 等。以及完整地实现了 aes、blowfish、rc4、rsa、xtea 等加密算法。</li>
<li>sha1</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    hasher := sha1.New()</div><div class="line">    io.WriteString(hasher, <span class="string">"test"</span>)</div><div class="line">    b := []<span class="keyword">byte</span>&#123;&#125;</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, hasher.Sum(b))</div><div class="line">    fmt.Printf(<span class="string">"Result: %d\n"</span>, hasher.Sum(b))</div><div class="line">    <span class="comment">//</span></div><div class="line">    hasher.Reset()</div><div class="line">    data := []<span class="keyword">byte</span>(<span class="string">"We shall overcome!"</span>)</div><div class="line">    n, err := hasher.Write(data)</div><div class="line">    <span class="keyword">if</span> n!=<span class="built_in">len</span>(data) || err!=<span class="literal">nil</span> &#123;</div><div class="line">        log.Printf(<span class="string">"Hash write error: %v / %v"</span>, n, err)</div><div class="line">    &#125;</div><div class="line">    checksum := hasher.Sum(b)</div><div class="line">    fmt.Printf(<span class="string">"Result: %x\n"</span>, checksum)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第13章-错误处理与测试"><a href="#第13章-错误处理与测试" class="headerlink" title="第13章 错误处理与测试"></a>第13章 错误处理与测试</h1><ul>
<li>go没有try-catch-finally机制</li>
<li>go有defer-panic-and-recover机制</li>
<li>永远不要忽略错误，否则可能会导致程序崩溃！！</li>
<li>普通错误通过返回值来返回</li>
<li>真正的异常用panic和recover来处理</li>
<li>产生错误的函数会返回两个变量，一个值和一个错误码；如果后者是 nil 就是成功，非 nil 就是发生了错误。</li>
<li>为了防止发生错误时正在执行的函数（如果有必要的话甚至会是整个程序）被中止，在调用函数后必须检查错误。</li>
</ul>
<h2 id="13-1-错误处理"><a href="#13-1-错误处理" class="headerlink" title="13.1 错误处理"></a>13.1 错误处理</h2><ul>
<li>go中的error接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</div><div class="line">    Error() <span class="keyword">string</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="13-1-1-定义错误"><a href="#13-1-1-定义错误" class="headerlink" title="13.1.1 定义错误"></a>13.1.1 定义错误</h3><ul>
<li>新建：<code>err := errors.New(&quot;error string&quot;)</code></li>
<li>自定义error</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// PathError records an error and the operation and file path that caused it.</span></div><div class="line"><span class="keyword">type</span> PathError <span class="keyword">struct</span> &#123;</div><div class="line">    Op <span class="keyword">string</span>    <span class="comment">// "open", "unlink", etc.</span></div><div class="line">    Path <span class="keyword">string</span>  <span class="comment">// The associated file.</span></div><div class="line">    Err error  <span class="comment">// Returned by the system call.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *PathError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> e.Op + <span class="string">" "</span> + e.Path + <span class="string">": "</span>+ e.Err.Error()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>错误类型以<code>Error</code>结尾，错误变量以<code>err</code>或者<code>Err</code>开头</li>
</ul>
<h3 id="13-1-2-用fmt创建错误对象"><a href="#13-1-2-用fmt创建错误对象" class="headerlink" title="13.1.2 用fmt创建错误对象"></a>13.1.2 用fmt创建错误对象</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Errorf(<span class="string">"math: square root of negative number %g"</span>, f)</div></pre></td></tr></table></figure>
<h2 id="13-2-运行时异常和panic"><a href="#13-2-运行时异常和panic" class="headerlink" title="13.2 运行时异常和panic"></a>13.2 运行时异常和panic</h2><ul>
<li>运行时异常：数组越界，断言失败等会触发panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Starting the program</div><div class="line"><span class="built_in">panic</span>: A severe error occurred: stopping the program!</div><div class="line"><span class="built_in">panic</span> PC=<span class="number">0x4f</span>3038</div><div class="line">runtime.<span class="built_in">panic</span>+<span class="number">0x99</span> /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">1032</span></div><div class="line">       runtime.<span class="built_in">panic</span>(<span class="number">0x442938</span>, <span class="number">0x4f</span>08e8)</div><div class="line">main.main+<span class="number">0xa5</span> E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.<span class="keyword">go</span>:<span class="number">8</span></div><div class="line">       main.main()</div><div class="line">runtime.mainstart+<span class="number">0xf</span> <span class="number">386</span>/asm.s:<span class="number">84</span></div><div class="line">       runtime.mainstart()</div><div class="line">runtime.goexit /<span class="keyword">go</span>/src/pkg/runtime/proc.c:<span class="number">148</span></div><div class="line">       runtime.goexit()</div><div class="line">---- Error run E:/Go/GoBoek/code examples/chapter <span class="number">13</span>/<span class="built_in">panic</span>.exe with code Crashed</div><div class="line">---- Program exited with code <span class="number">-1073741783</span></div></pre></td></tr></table></figure>
<ul>
<li>Go panicking：在多层嵌套的函数调用中调用 panic，可以马上中止当前函数的执行，所有的 defer 语句都会保证执行并把控制权交还给接收到 panic 的函数调用者。这样向上冒泡直到最顶层，并执行（每层的） defer，在栈顶处程序崩溃，并在命令行中用传给 panic 的值报告错误情况：这个终止过程就是 panicking</li>
</ul>
<h2 id="13-3-recover"><a href="#13-3-recover" class="headerlink" title="13.3 recover"></a>13.3 recover</h2><ul>
<li>recover用于从panic中恢复，停止终止过程，恢复正常执行</li>
<li>recover中能在defer修饰的函数中使用，用来取得panic调用中传递过来的错误值，如果是正常执行，调用recover会返回nil，不会生效</li>
<li>panic 会导致栈被展开直到 defer 修饰的 recover() 被调用或者程序中止。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> err := <span class="built_in">recover</span>(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, err)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g() <span class="comment">//   possible runtime-error</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>recover和catch很像</li>
<li>defer-panic-recover 在某种意义上也是一种像 if，for 这样的控制流机制</li>
</ul>
<h2 id="13-4-自定义包中的错误处理和panicking"><a href="#13-4-自定义包中的错误处理和panicking" class="headerlink" title="13.4 自定义包中的错误处理和panicking"></a>13.4 自定义包中的错误处理和panicking</h2><ul>
<li>最佳实践<ul>
<li>在包的内部，总是应该从panic中recover，不允许显式的超出包范围的panic()</li>
<li>向包的调用者返回错误值，而不是panic</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// parse.go</span></div><div class="line"><span class="keyword">package</span> parse</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">    <span class="string">"strconv"</span></div><div class="line">)</div><div class="line"><span class="comment">// A ParseError indicates an error in converting a word into an integer.</span></div><div class="line"><span class="keyword">type</span> ParseError <span class="keyword">struct</span> &#123;</div><div class="line">    Index <span class="keyword">int</span>      <span class="comment">// The index into the space-separated list of words.</span></div><div class="line">    Word  <span class="keyword">string</span>   <span class="comment">// The word that generated the parse error.</span></div><div class="line">    Err error <span class="comment">// The raw error that precipitated this error, if any.</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// String returns a human-readable error message.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *ParseError)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> fmt.Sprintf(<span class="string">"pkg parse: error parsing %q as int"</span>, e.Word)</div><div class="line">&#125;</div><div class="line"><span class="comment">// Parse parses the space-separated words in in put as integers.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Parse</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>, err error)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">var</span> ok <span class="keyword">bool</span></div><div class="line">            err, ok = r.(error)</div><div class="line">            <span class="keyword">if</span> !ok &#123;</div><div class="line">                err = fmt.Errorf(<span class="string">"pkg: %v"</span>, r)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fields := strings.Fields(input)</div><div class="line">    numbers = fields2numbers(fields)</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fields2numbers</span><span class="params">(fields []<span class="keyword">string</span>)</span> <span class="params">(numbers []<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(fields) == <span class="number">0</span> &#123;</div><div class="line">        <span class="built_in">panic</span>(<span class="string">"no words to parse"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> idx, field := <span class="keyword">range</span> fields &#123;</div><div class="line">        num, err := strconv.Atoi(field)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="built_in">panic</span>(&amp;ParseError&#123;idx, field, err&#125;)</div><div class="line">        &#125;</div><div class="line">        numbers = <span class="built_in">append</span>(numbers, num)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// panic_package.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"./parse/parse"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> examples = []<span class="keyword">string</span>&#123;</div><div class="line">            <span class="string">"1 2 3 4 5"</span>,</div><div class="line">            <span class="string">"100 50 25 12.5 6.25"</span>,</div><div class="line">            <span class="string">"2 + 2 = 4"</span>,</div><div class="line">            <span class="string">"1st class"</span>,</div><div class="line">            <span class="string">""</span>,</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> _, ex := <span class="keyword">range</span> examples &#123;</div><div class="line">        fmt.Printf(<span class="string">"Parsing %q:\n  "</span>, ex)</div><div class="line">        nums, err := parse.Parse(ex)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(err) <span class="comment">// here String() method from ParseError is used</span></div><div class="line">            <span class="keyword">continue</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(nums)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-5-一种用闭包处理错误的模式"><a href="#13-5-一种用闭包处理错误的模式" class="headerlink" title="13.5 一种用闭包处理错误的模式"></a>13.5 一种用闭包处理错误的模式</h2><ul>
<li>每当函数返回时，我们检查是否有错误发生，会很繁琐</li>
<li>defer/panic/recover和闭包可以优雅的解决这个问题，但是要求所有函数都是同一种签名才可以</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    f()</div><div class="line">    fmt.Println(<span class="string">"Returned normally from f."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> r := <span class="built_in">recover</span>(); r != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Println(<span class="string">"Recovered in f"</span>, r)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    fmt.Println(<span class="string">"Calling g."</span>)</div><div class="line">    g(<span class="number">0</span>)</div><div class="line">    fmt.Println(<span class="string">"Returned normally from g."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> i &gt; <span class="number">3</span> &#123;</div><div class="line">        fmt.Println(<span class="string">"Panicking!"</span>)</div><div class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">"%v"</span>, i))</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">"Defer in g"</span>, i)</div><div class="line">    fmt.Println(<span class="string">"Printing in g"</span>, i)</div><div class="line">    g(i + <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">Calling g.</span></div><div class="line"><span class="comment">Printing in g 0</span></div><div class="line"><span class="comment">Printing in g 1</span></div><div class="line"><span class="comment">Printing in g 2</span></div><div class="line"><span class="comment">Printing in g 3</span></div><div class="line"><span class="comment">Panicking!</span></div><div class="line"><span class="comment">Defer in g 3</span></div><div class="line"><span class="comment">Defer in g 2</span></div><div class="line"><span class="comment">Defer in g 1</span></div><div class="line"><span class="comment">Defer in g 0</span></div><div class="line"><span class="comment">Recovered in f 4</span></div><div class="line"><span class="comment">Returned normally from f.</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="13-6-启动外部命令和程序"><a href="#13-6-启动外部命令和程序" class="headerlink" title="13.6 启动外部命令和程序"></a>13.6 启动外部命令和程序</h2><ul>
<li>os包又一个StartProcess函数可以调用或者启动外部系统命令和二进制可执行文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// exec.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os/exec"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"><span class="comment">// 1) os.StartProcess //</span></div><div class="line"><span class="comment">/*********************/</span></div><div class="line"><span class="comment">/* Linux: */</span></div><div class="line">    env := os.Environ()</div><div class="line">    procAttr := &amp;os.ProcAttr&#123;</div><div class="line">               Env: env,</div><div class="line">               Files: []*os.File&#123;</div><div class="line">                   os.Stdin,</div><div class="line">                   os.Stdout,</div><div class="line">                   os.Stderr,</div><div class="line">               &#125;,</div><div class="line">           &#125;</div><div class="line">    <span class="comment">// 1st example: list files</span></div><div class="line">    pid, err := os.StartProcess(<span class="string">"/bin/ls"</span>, []<span class="keyword">string</span>&#123;<span class="string">"ls"</span>, <span class="string">"-l"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line">    <span class="comment">// 2nd example: show all processes</span></div><div class="line">    pid, err = os.StartProcess(<span class="string">"/bin/ps"</span>, []<span class="keyword">string</span>&#123;<span class="string">"-e"</span>, <span class="string">"-opid,ppid,comm"</span>&#125;, procAttr)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            fmt.Printf(<span class="string">"Error %v starting process!"</span>, err)  <span class="comment">//</span></div><div class="line">            os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The process id is %v"</span>, pid)</div><div class="line"><span class="comment">/* Output 1st:</span></div><div class="line"><span class="comment">The process id is &amp;&#123;2054 0&#125;total 2056</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo 1157555 2011-07-04 16:48 Mieken_exec</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo    2124 2011-07-04 16:48 Mieken_exec.go</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo   18528 2011-07-04 16:48 Mieken_exec_go_.6</span></div><div class="line"><span class="comment">-rwxr-xr-x 1 ivo ivo  913920 2011-06-03 16:13 panic.exe</span></div><div class="line"><span class="comment">-rw-r--r-- 1 ivo ivo     180 2011-04-11 20:39 panic.go</span></div><div class="line"><span class="comment">*/</span></div><div class="line"></div><div class="line"><span class="comment">// 2) exec.Run //</span></div><div class="line"><span class="comment">/***************/</span></div><div class="line"><span class="comment">// Linux:  OK, but not for ls ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls", "-l")  // no error, but doesn't show anything ?</span></div><div class="line"><span class="comment">// cmd := exec.Command("ls")          // no error, but doesn't show anything ?</span></div><div class="line">    cmd := exec.Command(<span class="string">"gedit"</span>)  <span class="comment">// this opens a gedit-window</span></div><div class="line">    err = cmd.Run()</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        fmt.Printf(<span class="string">"Error %v executing command!"</span>, err)</div><div class="line">        os.Exit(<span class="number">1</span>)</div><div class="line">    &#125;</div><div class="line">    fmt.Printf(<span class="string">"The command is %v"</span>, cmd)</div><div class="line"><span class="comment">// The command is &amp;&#123;/bin/ls [ls -l] []  &lt;nil&gt; &lt;nil&gt; &lt;nil&gt; 0xf840000210 &lt;nil&gt; true [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [0xf84000ea50 0xf84000e9f0 0xf84000e9c0] [] [] 0xf8400128c0&#125;</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// in Windows: uitvoering: Error fork/exec /bin/ls: The system cannot find the path specified. starting process!</span></div></pre></td></tr></table></figure>
<h2 id="13-7-go中的单元测试和基准测试"><a href="#13-7-go中的单元测试和基准测试" class="headerlink" title="13.7 go中的单元测试和基准测试"></a>13.7 go中的单元测试和基准测试</h2><ul>
<li>testing包是用来进行自动化测试，日志和错误报告的</li>
<li>单元测试文件名为<code>*_test.go</code>，测试文件不会被普通的go编译器编译，不会被部署，只会被gotest编译</li>
<li><code>func TestAbcde(t *testing.T)</code></li>
<li>测试失败<ul>
<li><code>Fail</code> 失败继续执行</li>
<li><code>FailNow</code>失败终止执行，继续执行下一个文件</li>
<li><code>Log</code> 打印到错误日志</li>
<li><code>Fatal</code> Log+FailNow</li>
</ul>
</li>
<li>基准测试函数 <code>BenchmarkReverse()</code> 用<code>go test -test.bench=.*</code>来执行基准函数</li>
</ul>
<h2 id="13-8-测试实例"><a href="#13-8-测试实例" class="headerlink" title="13.8 测试实例"></a>13.8 测试实例</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> even</div><div class="line"><span class="keyword">import</span> <span class="string">"testing"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestEven</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Even(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 must be even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Even(<span class="number">7</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 7 is not even!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestOdd</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">if</span> !Odd(<span class="number">11</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 11 must be odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> Odd(<span class="number">10</span>) &#123;</div><div class="line">        t.Log(<span class="string">" 10 is not odd!"</span>)</div><div class="line">        t.Fail()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试用例需要覆盖<ul>
<li>正常的用例</li>
<li>反面的用例</li>
<li>边界检查用例</li>
</ul>
</li>
</ul>
<h2 id="13-9-用测试数据表驱动测试"><a href="#13-9-用测试数据表驱动测试" class="headerlink" title="13.9 用测试数据表驱动测试"></a>13.9 用测试数据表驱动测试</h2><ul>
<li>将测试的输入数据和期望的结果写在一起组成一个数据表，数据表中的每条记录都是一个含有输入和期望值的完整测试用例</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> tests = []<span class="keyword">struct</span>&#123;     <span class="comment">// Test table</span></div><div class="line">    in  <span class="keyword">string</span></div><div class="line">    out <span class="keyword">string</span></div><div class="line">&#125;&#123;</div><div class="line">    &#123;<span class="string">"in1"</span>, <span class="string">"exp1"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in2"</span>, <span class="string">"exp2"</span>&#125;,</div><div class="line">    &#123;<span class="string">"in3"</span>, <span class="string">"exp3"</span>&#125;,</div><div class="line">...</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestFunction</span><span class="params">(t *testing.T)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, tt := <span class="keyword">range</span> tests &#123;</div><div class="line">        s := FuncToBeTested(tt.in)</div><div class="line">        <span class="keyword">if</span> s != tt.out &#123;</div><div class="line">            t.Errorf(<span class="string">"%d. %q =&gt; %q, wanted: %q"</span>, i, tt.in, s, tt.out)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="13-10-性能调试：分析并优化go程序"><a href="#13-10-性能调试：分析并优化go程序" class="headerlink" title="13.10 性能调试：分析并优化go程序"></a>13.10 性能调试：分析并优化go程序</h2><h3 id="13-10-1-时间和内存消耗"><a href="#13-10-1-时间和内存消耗" class="headerlink" title="13.10.1 时间和内存消耗"></a>13.10.1 时间和内存消耗</h3><ul>
<li><code>/usr/bin/time -f &#39;%Uu %Ss %er %MkB %C&#39; goprogexec</code> 用户时间，系统时间，实际时间，最大内存占用</li>
</ul>
<h3 id="13-10-2-go-test调试"><a href="#13-10-2-go-test调试" class="headerlink" title="13.10.2 go test调试"></a>13.10.2 go test调试</h3><ul>
<li>go test -x -v -cpuprofile=prof.out -file x_test.go</li>
</ul>
<h3 id="13-10-3-pprof调试"><a href="#13-10-3-pprof调试" class="headerlink" title="13.10.3 pprof调试"></a>13.10.3 pprof调试</h3><ul>
<li>pprof运行时报告数据</li>
<li>有用的命令<ul>
<li>topN - 分析结果中最开头的N份样本</li>
<li>web - 调用统计，浏览器打开</li>
<li>list - 代码行数和执行消耗时间</li>
</ul>
</li>
</ul>
<h2 id="第14章-协程和通道"><a href="#第14章-协程和通道" class="headerlink" title="第14章 协程和通道"></a>第14章 协程和通道</h2><p>不需要共享内存来通信，而是通过通信来共享内存。</p>
<h3 id="14-1-并发，并行和协程"><a href="#14-1-并发，并行和协程" class="headerlink" title="14.1 并发，并行和协程"></a>14.1 并发，并行和协程</h3><ul>
<li>不要使用全局变量或者共享内存，会给你代码在并发运算时带来风险</li>
<li>go中使用goroutine进行并发运算</li>
<li>协程和操作系统的线程不是一对一的关系，协程是根据一个或多个线程的可用性，映射（多路复用，执行于）在他们之上的；协程调度器在 Go 运行时很好的完成了这个工作。</li>
<li>协程工作在相同的地址空间中，所以共享内存的方式一定是同步的</li>
<li>go使用channel来同步协程</li>
<li>当系统调用阻塞协程时，其他协程会继续在其他线程上工作</li>
<li>协程比线程更轻量级，4K的内存就可以创建一个协程</li>
<li>协程通过关键字go来创建</li>
<li>协程的栈会根据需要进行伸缩，不会溢出，结束会自动退出清理</li>
<li>main可以看做一个协程</li>
<li>init函数中可以运行协程</li>
<li>并发程序可能并行，也可能不是</li>
<li>并行是一种通过多处理器来提高速度的能力</li>
<li><p>go中设置GOMASXPROCS来支持多个系统线程的应用，n个核设置GOMAXPROCS=n-1</p>
</li>
<li><p>Go 协程意味着并行（或者可以以并行的方式部署），协程一般来说不是这样的</p>
</li>
<li>Go 协程通过通道来通信；协程通过让出和恢复操作来通信</li>
</ul>
<h3 id="14-2-协程间的通信"><a href="#14-2-协程间的通信" class="headerlink" title="14.2 协程间的通信"></a>14.2 协程间的通信</h3><h3 id="14-2-1-概念"><a href="#14-2-1-概念" class="headerlink" title="14.2.1 概念"></a>14.2.1 概念</h3><ul>
<li>通道（channel），就像一个可以用于发送类型化数据的管道，由其负责协程之间的通信，从而避开所有由共享内存导致的陷阱；这种通过通道进行通信的方式保证了同步性。数据在通道中进行传递：在任何给定时间，一个数据被设计为只有一个协程可以对其访问，所以不会发生数据竞争。 数据的所有权（可以读写数据的能力）也因此被传递。</li>
<li>channel未初始化未nil</li>
<li>channel只能传递一种类型的数据</li>
<li>channel实际上是类型化消息的队列，使数据得以传输。它是先进先出（FIFO）的结构所以可以保证发送给他们的元素的顺序</li>
<li>channel是引用类型，make来初始化 <code>ch1 := make(chan string)</code></li>
</ul>
<h3 id="14-2-2-通信操作符-lt"><a href="#14-2-2-通信操作符-lt" class="headerlink" title="14.2.2 通信操作符&lt;-"></a>14.2.2 通信操作符<code>&lt;-</code></h3><ul>
<li>数据是按照箭头的方向流动的<ul>
<li><code>ch &lt;-int1</code></li>
<li><code>int2 := &lt;- ch</code></li>
<li><code>&lt;-ch</code></li>
</ul>
</li>
<li>channel的收发都是原子操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    <span class="keyword">go</span> getData(ch)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokyo"</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> input <span class="keyword">string</span></div><div class="line">    <span class="comment">// time.Sleep(2e9)</span></div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input = &lt;-ch</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>协程的同步：<ul>
<li>main() 等待了 1 秒让两个协程完成，如果不这样，sendData() 就没有机会输出。</li>
<li>getData() 使用了无限循环：它随着 sendData() 的发送完成和 ch 变空也结束了。</li>
<li>如果我们移除一个或所有 go 关键字，程序无法运行，Go 运行时会抛出 panic：</li>
</ul>
</li>
</ul>
<h3 id="14-2-3-通道阻塞"><a href="#14-2-3-通道阻塞" class="headerlink" title="14.2.3 通道阻塞"></a>14.2.3 通道阻塞</h3><ul>
<li>通道默认是同步且无缓冲的：接收者接收数据之前，发送不会结束。通道的发送和接收操作都是在对方准备好之前是阻塞的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump(ch1)       <span class="comment">// pump hangs</span></div><div class="line">    fmt.Println(&lt;-ch1) <span class="comment">// prints only 0</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// 0</span></div></pre></td></tr></table></figure>
<h3 id="14-2-4-通过channel进行协程同步"><a href="#14-2-4-通过channel进行协程同步" class="headerlink" title="14.2.4 通过channel进行协程同步"></a>14.2.4 通过channel进行协程同步</h3><ul>
<li>通过channel，两个协程在通信中的某刻同步交换数据</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(in <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    fmt.Println(&lt;-in)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    out := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    out &lt;- <span class="number">2</span></div><div class="line">    <span class="keyword">go</span> f1(out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-5-同步通道-使用带缓冲的通道"><a href="#14-2-5-同步通道-使用带缓冲的通道" class="headerlink" title="14.2.5 同步通道-使用带缓冲的通道"></a>14.2.5 同步通道-使用带缓冲的通道</h3><ul>
<li><code>ch1 := make(chan string, buf)</code> buf为个数</li>
<li>在缓冲满载之前，给通道发送数据是不会被阻塞的</li>
<li>在缓冲空之前，读取是不会阻塞的</li>
</ul>
<h3 id="14-2-6-协程中用通道输出结果"><a href="#14-2-6-协程中用通道输出结果" class="headerlink" title="14.2.6 协程中用通道输出结果"></a>14.2.6 协程中用通道输出结果</h3><p>用通道来完成阻塞</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> sum(bigArray, ch) <span class="comment">// bigArray puts the calculated sum on ch</span></div><div class="line"><span class="comment">// .. do something else for a while</span></div><div class="line">sum := &lt;- ch <span class="comment">// wait for, and retrieve the sum</span></div></pre></td></tr></table></figure>
<h3 id="14-2-7-信号量模式"><a href="#14-2-7-信号量模式" class="headerlink" title="14.2.7 信号量模式"></a>14.2.7 信号量模式</h3><ul>
<li>协程通过在通道中放置一个值来处理结束的信号</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">compute</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</div><div class="line">    ch &lt;- someComputation() <span class="comment">// when it completes, signal on the channel.</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)     <span class="comment">// allocate a channel.</span></div><div class="line">    <span class="keyword">go</span> compute(ch)        <span class="comment">// stat something in a goroutines</span></div><div class="line">    doSomethingElseForAWhile()</div><div class="line">    result := &lt;- ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-实现并行的for循环"><a href="#14-2-8-实现并行的for循环" class="headerlink" title="14.2.8 实现并行的for循环"></a>14.2.8 实现并行的for循环</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i, v := <span class="keyword">range</span> data &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span> <span class="params">(i <span class="keyword">int</span>, v <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">        doSomething(i, v)</div><div class="line">        ...</div><div class="line">    &#125; (i, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-8-用带缓冲通道实现一个信号量"><a href="#14-2-8-用带缓冲通道实现一个信号量" class="headerlink" title="14.2.8 用带缓冲通道实现一个信号量"></a>14.2.8 用带缓冲通道实现一个信号量</h3><ul>
<li>信号量是实现互斥锁常见的同步机制<ul>
<li>带缓冲通道的容量和要同步的资源容量相同</li>
<li>通道的长度（当前存放的元素个数）与当前资源被使用的数量相同</li>
<li>容量减去通道的长度就是未处理的资源个数（标准信号量的整数值）</li>
</ul>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    stream := pump()</div><div class="line">    <span class="keyword">go</span> suck(stream)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        fmt.Println(&lt;-ch)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="14-2-10-给通道使用for循环"><a href="#14-2-10-给通道使用for循环" class="headerlink" title="14.2.10 给通道使用for循环"></a>14.2.10 给通道使用for循环</h3><ul>
<li>for-range</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">    fmt.Printf(<span class="string">"The value is %v\n"</span>, v)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"time"</span></div><div class="line">)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    suck(pump())</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> v := <span class="keyword">range</span> ch &#123;</div><div class="line">            fmt.Println(v)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-2-11-通道的方向"><a href="#14-2-11-通道的方向" class="headerlink" title="14.2.11 通道的方向"></a>14.2.11 通道的方向</h2><ul>
<li>只接收：<code>var recv_noly &lt;-chan int</code></li>
<li>只发送：<code>var send_only chan&lt;- int</code></li>
</ul>
<h2 id="14-3-协程的同步：关闭通道-测试阻塞的通道"><a href="#14-3-协程的同步：关闭通道-测试阻塞的通道" class="headerlink" title="14.3 协程的同步：关闭通道-测试阻塞的通道"></a>14.3 协程的同步：关闭通道-测试阻塞的通道</h2><ul>
<li>通道可以被显示的关闭</li>
<li>发送者需要关闭通道，接收者不需要</li>
<li>关闭方法：defer close(ch)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> sendData(ch)</div><div class="line">    getData(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sendData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    ch &lt;- <span class="string">"Washington"</span></div><div class="line">    ch &lt;- <span class="string">"Tripoli"</span></div><div class="line">    ch &lt;- <span class="string">"London"</span></div><div class="line">    ch &lt;- <span class="string">"Beijing"</span></div><div class="line">    ch &lt;- <span class="string">"Tokio"</span></div><div class="line">    <span class="built_in">close</span>(ch)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getData</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        input, open := &lt;-ch</div><div class="line">        <span class="keyword">if</span> !open &#123;</div><div class="line">            <span class="keyword">break</span></div><div class="line">        &#125;</div><div class="line">        fmt.Printf(<span class="string">"%s "</span>, input)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>for-range来读取通道会检测通道是否会关闭</li>
</ul>
<h2 id="14-4-使用select切换协程"><a href="#14-4-使用select切换协程" class="headerlink" title="14.4 使用select切换协程"></a>14.4 使用select切换协程</h2><ul>
<li>select 被称为通信开关</li>
<li>select可以处理多个通信中的一个</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> pump1(ch1)</div><div class="line">    <span class="keyword">go</span> pump2(ch2)</div><div class="line">    <span class="keyword">go</span> suck(ch1, ch2)</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump1</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i * <span class="number">2</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump2</span><span class="params">(ch <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        ch &lt;- i + <span class="number">5</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">suck</span><span class="params">(ch1, ch2 <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch1:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 1: %d\n"</span>, v)</div><div class="line">        <span class="keyword">case</span> v := &lt;-ch2:</div><div class="line">            fmt.Printf(<span class="string">"Received on channel 2: %d\n"</span>, v)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-5-通道、超时和计时器"><a href="#14-5-通道、超时和计时器" class="headerlink" title="14.5 通道、超时和计时器"></a>14.5 通道、超时和计时器</h2><ul>
<li>time.Ticker结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Ticker <span class="keyword">struct</span> &#123;</div><div class="line">    C &lt;-<span class="keyword">chan</span> Time <span class="comment">// the channel on which the ticks are delivered.</span></div><div class="line">    <span class="comment">// contains filtered or unexported fields</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>可以返回一个通道并且不关闭</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">rate_per_sec := <span class="number">10</span></div><div class="line"><span class="keyword">var</span> dur Duration = <span class="number">1e9</span></div><div class="line">chRate := time.Tick(dur)</div><div class="line"><span class="keyword">for</span> req := <span class="keyword">range</span> requests &#123;</div><div class="line">    &lt;- chRate</div><div class="line">    <span class="keyword">go</span> client.Call(<span class="string">"Service.Method"</span>, req, ...)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实现了按照指定频率处理请求</p>
<ul>
<li>Timer和Ticker类似，但是只会发送一次时间，可以应用在超时模式中</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">    timeout&lt;-<span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line"></div><div class="line">    <span class="keyword">case</span> &lt;-timeout</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-6-协程和恢复"><a href="#14-6-协程和恢复" class="headerlink" title="14.6 协程和恢复"></a>14.6 协程和恢复</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(workChan &lt;-<span class="keyword">chan</span> *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> work := <span class="keyword">range</span> workChan &#123;</div><div class="line">        <span class="keyword">go</span> safelyDo(work)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">safelyDo</span><span class="params">(work *Work)</span></span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> err := revocer(); err != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">""</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    do(work)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em>一个协程发生panic会继续执行其他的协程</em></p>
<h2 id="14-7-新旧模型对比"><a href="#14-7-新旧模型对比" class="headerlink" title="14.7 新旧模型对比"></a>14.7 新旧模型对比</h2><h3 id="旧模式-使用共享内存来进行同步"><a href="#旧模式-使用共享内存来进行同步" class="headerlink" title="旧模式 - 使用共享内存来进行同步"></a>旧模式 - 使用共享内存来进行同步</h3><ul>
<li>首先定义一个结构体处理一个任务</li>
<li>各个任务组成任务池来共享内存，引入锁机制</li>
<li>任务数量巨大，则锁机制的开销会导致效率急剧下降</li>
</ul>
<h3 id="新模式-使用通道"><a href="#新模式-使用通道" class="headerlink" title="新模式 - 使用通道"></a>新模式 - 使用通道</h3><ul>
<li>使用一个通道接受需要处理的任务，一个通道接受处理完成的任务及其结果。worker在协程中启动，数量N可以调整</li>
<li>不使用锁的机制，因为从通道获取到新任务不存在竞争关系</li>
<li>我理解实际上锁机制是实现在了channel中，一个channel的获取是原子性的，从而提高性能</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Worker的写法, Master -&gt; Workers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;- in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用锁的情景：<ul>
<li>访问共享数据结构中的缓存信息</li>
<li>保存应用程序上下文和状态信息数据</li>
</ul>
</li>
<li>使用通道的情景<ul>
<li>与异步操作的结果进行交互</li>
<li>分发任务</li>
<li>传递数据所有权</li>
</ul>
</li>
</ul>
<h2 id="14-8-惰性生成器的实现"><a href="#14-8-惰性生成器的实现" class="headerlink" title="14.8 惰性生成器的实现"></a>14.8 惰性生成器的实现</h2><ul>
<li>生成器是指当被调用时返回一个序列中下一个值的函数，也被称为惰性求值</li>
<li>int channel实现的生成器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> resume <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">integers</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    yield := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    count := <span class="number">0</span></div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            yield &lt;- count</div><div class="line">            count++</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> yield</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateInteger</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    resume = integers()</div><div class="line">    <span class="keyword">return</span> &lt;- resume</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用空接口，闭包和高阶函数可以实现一个通用的惰性生产期的工厂函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> EvalFunc <span class="function"><span class="keyword">func</span><span class="params">(Any)</span> <span class="params">(Any, Any)</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">BuildLazyEvaluator</span><span class="params">(evalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">    retValChan := <span class="built_in">make</span>(<span class="keyword">chan</span> Any)</div><div class="line">    loopFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">var</span> actState Any = initState</div><div class="line">        <span class="keyword">var</span> retVal</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            retVal, actState = evalFunc(actState)</div><div class="line">            retValChan &lt;- retVal</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    retFunc := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">Any</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> &lt;- retValChan</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> loopFunc()</div><div class="line">    <span class="keyword">return</span> retFunc</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BuildLazyIntEvaluator</span><span class="params">(evalFunc EvalFunc, initState Any)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">    ef := BuildLazyIntEvaluator(evalFunc, initState)</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</div><div class="line">        <span class="keyword">return</span> ef().(<span class="keyword">int</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    evenFunc := <span class="function"><span class="keyword">func</span><span class="params">(state Any)</span> <span class="params">(Any, Any)</span></span> &#123;</div><div class="line">        os := state.(<span class="keyword">int</span>)</div><div class="line">        ns := os + <span class="number">2</span></div><div class="line">        <span class="keyword">return</span> os, ns</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    even := BuildLazyIntEvaluator(evenFunc, <span class="number">0</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">        fmt.</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-9-实现Future模式"><a href="#14-9-实现Future模式" class="headerlink" title="14.9 实现Future模式"></a>14.9 实现Future模式</h2><ul>
<li>Future指的是你使用某一个值之前需要先对其进行计算，因此可以提前计算好</li>
<li>求两个矩阵的乘积的逆 -&gt; 先逆运算再乘</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseProduct</span><span class="params">(a, b Matrix)</span></span> &#123;</div><div class="line">    a_inv_future := InverseFuture(a)</div><div class="line">    b_inv_future := InverseFuture(b)</div><div class="line">    a_inv := &lt;- a_inv_future</div><div class="line">    b_inv := &lt;- b_inv_future</div><div class="line">    <span class="keyword">return</span> Product(a_inv, b_inv)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">InverseFuture</span><span class="params">(a Matrix)</span> <span class="title">chan</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">    future := <span class="built_in">make</span>(<span class="keyword">chan</span> Matrix)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        future &lt;- Inverse(a)</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> future</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-10-复用"><a href="#14-10-复用" class="headerlink" title="14.10 复用"></a>14.10 复用</h2><h3 id="CS模式"><a href="#CS模式" class="headerlink" title="CS模式"></a>CS模式</h3><ul>
<li>go中服务器通常会在协程中执行向客户端的响应，故而会对每一个客户端请求启动一个协程，常见操作为客户端请求包含一个通道，服务器向这个通道中发送响应</li>
<li>使用协程可以大大提高QPS</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> binOp <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">run</span><span class="params">(op binOp, req *Request)</span></span> &#123;</div><div class="line">    req.replyc &lt;- op(req.a, req.b)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span> <span class="params">(op binOp, service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        req := &lt;- service</div><div class="line">        <span class="keyword">go</span> run(op, req)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="title">chan</span> *<span class="title">Request</span></span> &#123;</div><div class="line">    reqChan := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(op, reqChan)</div><div class="line">    <span class="keyword">return</span> reqChan</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    adder := startServer(<span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;<span class="keyword">return</span> a + b&#125;)</div><div class="line">    <span class="keyword">const</span> N = <span class="number">100</span></div><div class="line">    <span class="keyword">var</span> reqs [n]Request</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; N; i++ &#123;</div><div class="line">        req := &amp;reqs[i]</div><div class="line">        req.a = i</div><div class="line">        req.b = i + N</div><div class="line">        req.replyc = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        adder &lt;- req</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="通过信号通道关闭服务器"><a href="#通过信号通道关闭服务器" class="headerlink" title="通过信号通道关闭服务器"></a>通过信号通道关闭服务器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServer</span><span class="params">(op binOp)</span> <span class="params">(service <span class="keyword">chan</span> *Request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    service = <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    quit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>)</div><div class="line">    <span class="keyword">go</span> server(op, service, quit)</div><div class="line">    <span class="keyword">return</span> service, quit</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(op binOp, service <span class="keyword">chan</span> *request, quit <span class="keyword">chan</span> <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> req := &lt;-service:</div><div class="line">                <span class="keyword">go</span> run(op, req)</div><div class="line">            <span class="keyword">case</span> &lt;- quit:</div><div class="line">                <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-11-限制同时处理的请求数-带缓冲的通道"><a href="#14-11-限制同时处理的请求数-带缓冲的通道" class="headerlink" title="14.11 限制同时处理的请求数 - 带缓冲的通道"></a>14.11 限制同时处理的请求数 - 带缓冲的通道</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">    a, b <span class="keyword">int</span></div><div class="line">    replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line"><span class="comment">//    ...</span></div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">    process(r)</div><div class="line">    &lt;- sem</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        request := &lt;- service</div><div class="line">        <span class="keyword">go</span> handler(request)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">    <span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-12-链式协程"><a href="#14-12-链式协程" class="headerlink" title="14.12 链式协程"></a>14.12 链式协程</h2><ul>
<li>海量协程的创建和运行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ngoroutine = flag.Int(<span class="string">"n"</span>, <span class="number">100000</span>, <span class="string">"how many goroutines"</span>)</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;- right</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    flag.Parse()</div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">var</span> left, right <span class="keyword">chan</span> <span class="keyword">int</span> = <span class="literal">nil</span>, leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; *ngoroutine; i++ &#123;</div><div class="line">        left, right = right, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">    &#125;</div><div class="line">    right &lt;- <span class="number">0</span></div><div class="line">    x := &lt;-leftmost</div><div class="line">    fmt.Println(x)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-13-在多核心上并行运算"><a href="#14-13-在多核心上并行运算" class="headerlink" title="14.13 在多核心上并行运算"></a>14.13 在多核心上并行运算</h2><ul>
<li>信号量模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span> &#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU)</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    sem &lt;- <span class="number">1</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU)</div><div class="line">    DOAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-14并行化大量数据的计算"><a href="#14-14并行化大量数据的计算" class="headerlink" title="14.14并行化大量数据的计算"></a>14.14并行化大量数据的计算</h2><ul>
<li>串行处理流水线</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SerialProcessData</span><span class="params">(in &lt;- <span class="keyword">chan</span> *Data, out <span class="keyword">chan</span> &lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> data := <span class="keyword">range</span> in &#123;</div><div class="line">        tmpA := PreproceeData(data)</div><div class="line">        tmpB := ProcessStepA(tmpA)</div><div class="line">        tmpC := ProcessStepB(tmpB)</div><div class="line">        out &lt;- PostProcessData(tmpC)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParallelProcessData</span><span class="params">(in &lt;-<span class="keyword">chan</span> *Data, out <span class="keyword">chan</span>&lt;- *Data)</span></span> &#123;</div><div class="line">    <span class="comment">// make channels:</span></div><div class="line">    preOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepAOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepBOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    stepCOut := <span class="built_in">make</span>(<span class="keyword">chan</span> *Data, <span class="number">100</span>)</div><div class="line">    <span class="comment">// start parallel computations:</span></div><div class="line">    <span class="keyword">go</span> PreprocessData(in, preOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepA(preOut,StepAOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepB(StepAOut,StepBOut)</div><div class="line">    <span class="keyword">go</span> ProcessStepC(StepBOut,StepCOut)</div><div class="line">    <span class="keyword">go</span> PostProcessData(StepCOut,out)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-15-漏桶算法"><a href="#14-15-漏桶算法" class="headerlink" title="14.15 漏桶算法"></a>14.15 漏桶算法</h2><ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">client</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        <span class="keyword">var</span> b *Buffer</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> b = &lt;- freeList</div><div class="line">                <span class="comment">// got one</span></div><div class="line">            <span class="keyword">default</span>: b = <span class="built_in">new</span>(Buffer)</div><div class="line">        &#125;</div><div class="line">        loadInto(b)</div><div class="line">        serverChan &lt;- b</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        b := &lt;-serverChan       <span class="comment">// Wait for work.</span></div><div class="line">        process(b)</div><div class="line">        <span class="comment">// Reuse buffer if there's room.</span></div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> freeList &lt;- b:</div><div class="line">                <span class="comment">// Reuse buffer if free slot on freeList; nothing more to do</span></div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                <span class="comment">// Free list full, just carry on: the buffer is 'dropped'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-16-对go协程进行基准测试"><a href="#14-16-对go协程进行基准测试" class="headerlink" title="14.16 对go协程进行基准测试"></a>14.16 对go协程进行基准测试</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">" sync"</span>, testing.Benchmark(BenchmarkChannelSync).String())</div><div class="line">	fmt.Println(<span class="string">"buffered"</span>, testing.Benchmark(BenchmarkChannelBuffered).String())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelSync</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkChannelBuffered</span><span class="params">(b *testing.B)</span></span> &#123;</div><div class="line">	ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">128</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</div><div class="line">			ch &lt;- i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">close</span>(ch)</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">for</span> <span class="keyword">range</span> ch &#123;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="14-17-使用通道并发访问对象"><a href="#14-17-使用通道并发访问对象" class="headerlink" title="14.17 使用通道并发访问对象"></a>14.17 使用通道并发访问对象</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">	Name   <span class="keyword">string</span></div><div class="line">	salary <span class="keyword">float64</span></div><div class="line">	chF    <span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">NewPerson</span><span class="params">(name <span class="keyword">string</span>, salary <span class="keyword">float64</span>)</span> *<span class="title">Person</span></span> &#123;</div><div class="line">	p := &amp;Person&#123;name, salary, <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="function"><span class="keyword">func</span><span class="params">()</span>)&#125;</span></div><div class="line"><span class="function">	<span class="title">go</span> <span class="title">p</span>.<span class="title">backend</span><span class="params">()</span></span></div><div class="line"><span class="function">	<span class="title">return</span> <span class="title">p</span></span></div><div class="line"><span class="function">&#125;</span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="params">(p *Person)</span> <span class="title">backend</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> f := <span class="keyword">range</span> p.chF &#123;</div><div class="line">		f()</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Set salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">SetSalary</span><span class="params">(sal <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; p.salary = sal &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Retrieve salary.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">Salary</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</div><div class="line">	fChan := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">float64</span>)</div><div class="line">	p.chF &lt;- <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; fChan &lt;- p.salary &#125;</div><div class="line">	<span class="keyword">return</span> &lt;-fChan</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="string">"Person - name is: "</span> + p.Name + <span class="string">" - salary is: "</span> + strconv.FormatFloat(p.Salary(), <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">64</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	bs := NewPerson(<span class="string">"Smith Bill"</span>, <span class="number">2500.5</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">	bs.SetSalary(<span class="number">4000.25</span>)</div><div class="line">	fmt.Println(<span class="string">"Salary changed:"</span>)</div><div class="line">	fmt.Println(bs)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第15章-网络，模板和网页应用"><a href="#第15章-网络，模板和网页应用" class="headerlink" title="第15章 网络，模板和网页应用"></a>第15章 网络，模板和网页应用</h1><h2 id="15-1-tcp服务器"><a href="#15-1-tcp服务器" class="headerlink" title="15.1 tcp服务器"></a>15.1 tcp服务器</h2><ul>
<li>服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    listener, err := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        conn, err := listener.Accept()</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">go</span> doServerStuff(conn)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doServerStuff</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">512</span>)</div><div class="line">        <span class="built_in">len</span>, err := conn.Read(buf)</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">            <span class="keyword">return</span></div><div class="line">        &#125;</div><div class="line">        fmt.Println(<span class="string">"%v"</span>, <span class="keyword">string</span>(buf[:<span class="built_in">len</span>]))</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">//打开连接:</span></div><div class="line">	conn, err := net.Dial(<span class="string">"tcp"</span>, <span class="string">"localhost:50000"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="comment">//由于目标计算机积极拒绝而无法创建连接</span></div><div class="line">		fmt.Println(<span class="string">"Error dialing"</span>, err.Error())</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 终止程序</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	inputReader := bufio.NewReader(os.Stdin)</div><div class="line">	fmt.Println(<span class="string">"First, what is your name?"</span>)</div><div class="line">	clientName, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">	<span class="comment">// fmt.Printf("CLIENTNAME %s", clientName)</span></div><div class="line">	trimmedClient := strings.Trim(clientName, <span class="string">"\r\n"</span>) <span class="comment">// Windows 平台下用 "\r\n"，Linux平台下使用 "\n"</span></div><div class="line">	<span class="comment">// 给服务器发送信息直到程序退出：</span></div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		fmt.Println(<span class="string">"What to send to the server? Type Q to quit."</span>)</div><div class="line">		input, _ := inputReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">		trimmedInput := strings.Trim(input, <span class="string">"\r\n"</span>)</div><div class="line">		<span class="comment">// fmt.Printf("input:--%s--", input)</span></div><div class="line">		<span class="comment">// fmt.Printf("trimmedInput:--%s--", trimmedInput)</span></div><div class="line">		<span class="keyword">if</span> trimmedInput == <span class="string">"Q"</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		_, err = conn.Write([]<span class="keyword">byte</span>(trimmedClient + <span class="string">" says: "</span> + trimmedInput))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>改进后的tcp_server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> maxRead = <span class="number">25</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	flag.Parse()</div><div class="line">	<span class="keyword">if</span> flag.NArg() != <span class="number">2</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"usage: host port"</span>)</div><div class="line">	&#125;</div><div class="line">	hostAndPort := fmt.Sprintf(<span class="string">"%s:%s"</span>, flag.Arg(<span class="number">0</span>), flag.Arg(<span class="number">1</span>))</div><div class="line">	listener := initServer(hostAndPort)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		conn, err := listener.Accept()</div><div class="line">		checkError(err, <span class="string">"Accept: "</span>)</div><div class="line">		<span class="keyword">go</span> connectionHandler(conn)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">initServer</span><span class="params">(hostAndPort <span class="keyword">string</span>)</span> *<span class="title">net</span>.<span class="title">TCPListener</span></span> &#123;</div><div class="line">	serverAddr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, hostAndPort)</div><div class="line">	checkError(err, <span class="string">"Resolving address:port failed: `"</span> + hostAndPort + <span class="string">"'"</span>)</div><div class="line">	listener, err := net.ListenTCP(<span class="string">"tcp"</span>, serverAddr)</div><div class="line">	checkError(err, <span class="string">"ListenTCP: "</span>)</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Listening to:    "</span>, listener.Addr().String())</div><div class="line">	<span class="keyword">return</span> listener</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">connectionHandler</span><span class="params">(conn net.Conn)</span></span> &#123;</div><div class="line">	connFrom := conn.RemoteAddr().String()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Connection from: "</span>, connFrom)</div><div class="line">	sayHello(conn)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">var</span> ibuf []<span class="keyword">byte</span> = <span class="built_in">make</span>([]<span class="keyword">byte</span>, maxRead + <span class="number">1</span>)</div><div class="line">		length, err := conn.Read(ibuf[<span class="number">0</span>:maxRead])</div><div class="line">		ibuf[maxRead] = <span class="number">0</span> <span class="comment">// to prevent overflow</span></div><div class="line">		<span class="keyword">switch</span> err &#123;</div><div class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">		   handleMsg(length, err, ibuf)</div><div class="line">		<span class="keyword">case</span> syscall.EAGAIN:  <span class="comment">// try again</span></div><div class="line">		   <span class="keyword">continue</span></div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			    <span class="keyword">goto</span> DISCONNECT</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">DISCONNECT:</div><div class="line">	err := conn.Close()</div><div class="line">	<span class="built_in">println</span>(<span class="string">"Closed connection: "</span>, connFrom)</div><div class="line">	checkError(err, <span class="string">"Close: "</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sayHello</span><span class="params">(to net.Conn)</span></span> &#123;</div><div class="line">	obuf := []<span class="keyword">byte</span>&#123;<span class="string">'L'</span>, <span class="string">'e'</span>, <span class="string">'t'</span>, <span class="string">'\''</span>, <span class="string">'s'</span>, <span class="string">' '</span>, <span class="string">'G'</span>, <span class="string">'O'</span>, <span class="string">'!'</span>, <span class="string">'\n'</span>&#125;</div><div class="line">	wrote, err := to.Write(obuf)</div><div class="line">	checkError(err, <span class="string">"Write: wrote "</span> + <span class="keyword">string</span>(wrote) + <span class="string">" bytes."</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleMsg</span><span class="params">(length <span class="keyword">int</span>, err error, msg []<span class="keyword">byte</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> length &gt; <span class="number">0</span> &#123;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&lt;"</span>, length, <span class="string">":"</span>)</div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">			<span class="keyword">if</span> msg[i] == <span class="number">0</span> &#123;</div><div class="line">				<span class="keyword">break</span></div><div class="line">			&#125;</div><div class="line">			fmt.Printf(<span class="string">"%c"</span>, msg[i])</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">print</span>(<span class="string">"&gt;"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkError</span><span class="params">(error error, info <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ERROR: "</span> + info + <span class="string">" "</span> + error.Error())  <span class="comment">// terminate goprogram</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-2-简单的网页服务器"><a href="#15-2-简单的网页服务器" class="headerlink" title="15.2 简单的网页服务器"></a>15.2 简单的网页服务器</h2><ul>
<li>net/http包</li>
<li>http.ListenAndServer</li>
<li>http.URL</li>
<li>http.Request</li>
<li>request.FormValue</li>
<li>request.ParseForm</li>
<li>http.HandlerFunc 具体函数 - 对应路径，类似于controller</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HelloServer</span><span class="params">(w http.ResponseWriter, req *http.Request)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"Inside HelloServer handler"</span>)</div><div class="line">	fmt.Fprintf(w, <span class="string">"Hello,"</span>+req.URL.Path[<span class="number">1</span>:])</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/"</span>, HelloServer)</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>http.ListenAndServerTLS - https</li>
</ul>
<h2 id="15-3-访问并读取页面"><a href="#15-3-访问并读取页面" class="headerlink" title="15.3 访问并读取页面"></a>15.3 访问并读取页面</h2><ul>
<li><code>http.Head()</code>来请求URL</li>
<li><code>http.Get()</code>获取Body中的网页内容</li>
<li><code>http.Redirect(w RespoonseWriter, r *Request, url string, code int)</code> 浏览器重定向URL</li>
<li><code>http.NotFound(w ResponseWriter, r *Request)</code> 404</li>
<li><code>http.Error(w ResponseWriter, r *Request)</code> 错误信息和错误码</li>
<li><code>http.Request</code></li>
<li><p><code>req.Method</code></p>
</li>
<li><p>go定义的HTTP状态码</p>
<ul>
<li>http.StatusContinue               = 100</li>
<li>http.StatusOK                       = 200</li>
<li>http.StatusFound                   = 302</li>
<li>http.StatusBadRequest            = 400</li>
<li>http.StatusUnauthorized        = 401</li>
<li>http.StatusForbidden            = 403</li>
<li>http.StatusNotFound             = 404</li>
<li>http.StatusInternalServerError    = 500</li>
</ul>
</li>
</ul>
<h2 id="15-4-网页应用"><a href="#15-4-网页应用" class="headerlink" title="15.4 网页应用"></a>15.4 网页应用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> form = <span class="string">`</span></div><div class="line"><span class="string">	&lt;html&gt;&lt;body&gt;</span></div><div class="line"><span class="string">		&lt;form action="#" method="post" name="bar"&gt;</span></div><div class="line"><span class="string">			&lt;input type="text" name="in" /&gt;</span></div><div class="line"><span class="string">			&lt;input type="submit" value="submit"/&gt;</span></div><div class="line"><span class="string">		&lt;/form&gt;</span></div><div class="line"><span class="string">	&lt;/body&gt;&lt;/html&gt;</span></div><div class="line"><span class="string">`</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SimpleServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	io.WriteString(w, <span class="string">"&lt;h1&gt;hello, world&lt;/h1&gt;"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">FormServer</span><span class="params">(w http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">	w.Header().Set(<span class="string">"Content-Type"</span>, <span class="string">"text/html"</span>)</div><div class="line">	<span class="keyword">switch</span> request.Method &#123;</div><div class="line">	<span class="keyword">case</span> <span class="string">"GET"</span>:</div><div class="line">		io.WriteString(w, form)</div><div class="line">	<span class="keyword">case</span> <span class="string">"POST"</span>:</div><div class="line">		io.WriteString(w, request.FormValue(<span class="string">"in"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/test1"</span>, SimpleServer)</div><div class="line">	http.HandleFunc(<span class="string">"/test2"</span>, FormServer)</div><div class="line">	<span class="keyword">if</span> err := http.ListenAndServe(<span class="string">":8088"</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(err)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-5-网页应用健壮"><a href="#15-5-网页应用健壮" class="headerlink" title="15.5 网页应用健壮"></a>15.5 网页应用健壮</h2><ul>
<li>使用闭包的错误处理模式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> HandleFnc <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span></div><div class="line"><span class="function"></span></div><div class="line"><span class="function"><span class="title">func</span> <span class="title">logPanics</span><span class="params">(function HandlerFunc)</span> <span class="title">HandlerFnc</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(writer http.ResponseWriter, request *http.Request)</span></span> &#123;</div><div class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">                log...</div><div class="line">            &#125;</div><div class="line">        &#125;()</div><div class="line">        function(writer, request)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-6-模板技术动态生成页面"><a href="#15-6-模板技术动态生成页面" class="headerlink" title="15.6 模板技术动态生成页面"></a>15.6 模板技术动态生成页面</h2><ul>
<li>模板缓存</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"io/ioutil"</span></div><div class="line">	<span class="string">"log"</span></div><div class="line">	<span class="string">"net/http"</span></div><div class="line">	<span class="string">"regexp"</span></div><div class="line">	<span class="string">"text/template"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> lenPath = <span class="built_in">len</span>(<span class="string">"/view/"</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> titleValidator = regexp.MustCompile(<span class="string">"^[a-zA-Z0-9]+$"</span>)</div><div class="line"><span class="keyword">var</span> templates = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*template.Template)</div><div class="line"><span class="keyword">var</span> err error</div><div class="line"></div><div class="line"><span class="keyword">type</span> Page <span class="keyword">struct</span> &#123;</div><div class="line">	Title <span class="keyword">string</span></div><div class="line">	Body  []<span class="keyword">byte</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, tmpl := <span class="keyword">range</span> []<span class="keyword">string</span>&#123;<span class="string">"edit"</span>, <span class="string">"view"</span>&#125; &#123;</div><div class="line">		templates[tmpl] = template.Must(template.ParseFiles(tmpl + <span class="string">".html"</span>))</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.HandleFunc(<span class="string">"/view/"</span>, makeHandler(viewHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/edit/"</span>, makeHandler(editHandler))</div><div class="line">	http.HandleFunc(<span class="string">"/save/"</span>, makeHandler(saveHandler))</div><div class="line">	err := http.ListenAndServe(<span class="string">"localhost:8080"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"ListenAndServe: "</span>, err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeHandler</span><span class="params">(fn <span class="keyword">func</span>(http.ResponseWriter, *http.Request, <span class="keyword">string</span>)</span>) <span class="title">http</span>.<span class="title">HandlerFunc</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		title := r.URL.Path[lenPath:]</div><div class="line">		<span class="keyword">if</span> !titleValidator.MatchString(title) &#123;</div><div class="line">			http.NotFound(w, r)</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		fn(w, r, title)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">viewHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123; <span class="comment">// page not found</span></div><div class="line">		http.Redirect(w, r, <span class="string">"/edit/"</span>+title, http.StatusFound)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"view"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">editHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	p, err := load(title)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		p = &amp;Page&#123;Title: title&#125;</div><div class="line">	&#125;</div><div class="line">	renderTemplate(w, <span class="string">"edit"</span>, p)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveHandler</span><span class="params">(w http.ResponseWriter, r *http.Request, title <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	body := r.FormValue(<span class="string">"body"</span>)</div><div class="line">	p := &amp;Page&#123;Title: title, Body: []<span class="keyword">byte</span>(body)&#125;</div><div class="line">	err := p.save()</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	http.Redirect(w, r, <span class="string">"/view/"</span>+title, http.StatusFound)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">renderTemplate</span><span class="params">(w http.ResponseWriter, tmpl <span class="keyword">string</span>, p *Page)</span></span> &#123;</div><div class="line">	err := templates[tmpl].Execute(w, p)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		http.Error(w, err.Error(), http.StatusInternalServerError)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Page)</span> <span class="title">save</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	filename := p.Title + <span class="string">".txt"</span></div><div class="line">	<span class="comment">// file created with read-write permissions for the current user only</span></div><div class="line">	<span class="keyword">return</span> ioutil.WriteFile(filename, p.Body, <span class="number">0600</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">load</span><span class="params">(title <span class="keyword">string</span>)</span> <span class="params">(*Page, error)</span></span> &#123;</div><div class="line">	filename := title + <span class="string">".txt"</span></div><div class="line">	body, err := ioutil.ReadFile(filename)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;Page&#123;Title: title, Body: body&#125;, <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-7-template包-先不看"><a href="#15-7-template包-先不看" class="headerlink" title="15.7 template包 - 先不看"></a>15.7 template包 - 先不看</h2><h2 id="15-8-多功能网页服务器"><a href="#15-8-多功能网页服务器" class="headerlink" title="15.8 多功能网页服务器"></a>15.8 多功能网页服务器</h2><h2 id="15-9-RPC远程调用"><a href="#15-9-RPC远程调用" class="headerlink" title="15.9 RPC远程调用"></a>15.9 RPC远程调用</h2><ul>
<li><p>net/rpc包实现互相通信</p>
</li>
<li><p>rpc_object</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> rpc_objects</div><div class="line"></div><div class="line"><span class="keyword">type</span> Args <span class="keyword">struct</span> &#123;</div><div class="line">	N, M <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *Args)</span> <span class="title">Multiply</span><span class="params">(args *Args, reply *<span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</div><div class="line">	*reply = args.N * args.M</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>server</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	calc := <span class="built_in">new</span>(rpc_objects.Args)</div><div class="line">	rpc.Register(calc)</div><div class="line">	rpc.HandleHTTP()</div><div class="line">	listener, e := net.Listen(<span class="string">"tcp"</span>, <span class="string">"localhost:1234"</span>)</div><div class="line">	<span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Starting RPC-server -listen error:"</span>, e)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> http.Serve(listener, <span class="literal">nil</span>)</div><div class="line">	time.Sleep(<span class="number">1000e9</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>rpc_client</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> serverAddress = <span class="string">"localhost"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	client, err := rpc.DialHTTP(<span class="string">"tcp"</span>, serverAddress + <span class="string">":1234"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Error dialing:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// Synchronous call</span></div><div class="line">	args := &amp;rpc_objects.Args&#123;<span class="number">7</span>, <span class="number">8</span>&#125;</div><div class="line">	<span class="keyword">var</span> reply <span class="keyword">int</span></div><div class="line">	err = client.Call(<span class="string">"Args.Multiply"</span>, args, &amp;reply)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Fatal(<span class="string">"Args error:"</span>, err)</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Args: %d * %d = %d"</span>, args.N, args.M, reply)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-10-基于网络的通道-netchan"><a href="#15-10-基于网络的通道-netchan" class="headerlink" title="15.10 基于网络的通道 netchan"></a>15.10 基于网络的通道 netchan</h2><ul>
<li>netchan包实现了类型安全的网络通道：允许一个通道两端出现由网络连接的不同计算机</li>
<li><p>一组导出器会按名称发布一组通道，导入器连接到导出的机器，并按照名称导入这些通道</p>
</li>
<li><p>发送端</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">exp, err := netchan.NewExporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Exporter: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err := exp.Export(<span class="string">"sendmyType"</span>, ch, netchan.Send)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Send Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接收端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">imp, err := netchan.NewImporter(<span class="string">"tcp"</span>, <span class="string">"netchanserver.mydomain.com:1234"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Error making Importer: %v"</span>, err)</div><div class="line">&#125;</div><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> myType)</div><div class="line">err = imp.Import(<span class="string">"sendmyType"</span>, ch, netchan.Receive)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	log.Fatalf(<span class="string">"Receive Error: %v"</span>, err)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-11-websocket"><a href="#15-11-websocket" class="headerlink" title="15.11 websocket"></a>15.11 websocket</h2><ul>
<li>服务端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"new connection\n"</span>)</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">100</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">" =&gt; closing connection\n"</span>)</div><div class="line">	ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	http.Handle(<span class="string">"/websocket"</span>, websocket.Handler(server))</div><div class="line">	err := http.ListenAndServe(<span class="string">":12345"</span>, <span class="literal">nil</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"ListenAndServe: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>客户端</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	ws, err := websocket.Dial(<span class="string">"ws://localhost:12345/websocket"</span>, <span class="string">""</span>,</div><div class="line">		<span class="string">"http://localhost/"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="built_in">panic</span>(<span class="string">"Dial: "</span> + err.Error())</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">go</span> readFromServer(ws)</div><div class="line">	time.Sleep(<span class="number">5e9</span>)</div><div class="line">    ws.Close()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">readFromServer</span><span class="params">(ws *websocket.Conn)</span></span> &#123;</div><div class="line">	buf := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1000</span>)</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		<span class="keyword">if</span> _, err := ws.Read(buf); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Printf(<span class="string">"%s\n"</span>, err.Error())</div><div class="line">			<span class="keyword">break</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="15-12-使用smtp发送邮件"><a href="#15-12-使用smtp发送邮件" class="headerlink" title="15.12 使用smtp发送邮件"></a>15.12 使用smtp发送邮件</h2><ul>
<li>smpt Simple Mail Transfer Protocol</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="comment">// Set up authentication information.</span></div><div class="line">        auth := smtp.PlainAuth(</div><div class="line">                <span class="string">""</span>,</div><div class="line">                <span class="string">"user@example.com"</span>,</div><div class="line">                <span class="string">"password"</span>,</div><div class="line">                <span class="string">"mail.example.com"</span>,</div><div class="line">        )</div><div class="line">        <span class="comment">// Connect to the server, authenticate, set the sender and recipient,</span></div><div class="line">        <span class="comment">// and send the email all in one step.</span></div><div class="line">        err := smtp.SendMail(</div><div class="line">                <span class="string">"mail.example.com:25"</span>,</div><div class="line">                auth,</div><div class="line">                <span class="string">"sender@example.org"</span>,</div><div class="line">                []<span class="keyword">string</span>&#123;<span class="string">"recipient@example.net"</span>&#125;,</div><div class="line">                []<span class="keyword">byte</span>(<span class="string">"This is the email body."</span>),</div><div class="line">        )</div><div class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">                log.Fatal(err)</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第16章-常见的错误与陷阱"><a href="#第16章-常见的错误与陷阱" class="headerlink" title="第16章 常见的错误与陷阱"></a>第16章 常见的错误与陷阱</h1><ul>
<li>永远不要声明形如<code>var p*a</code>的变量</li>
<li>永远不要在for循环中改变计数器的变量</li>
<li>永远不要在for-range循环中使用一个值去改变自身的值</li>
<li>永远不要将goto和前置标签一起使用</li>
<li>永远不要忘记在函数名后边加上()</li>
<li>永远不要使用new()创建map</li>
<li>为一个两类型定义一个String方法时，不要使用fmt.Print或者类似的代码</li>
<li>永远不要忘记当终止缓存写入时，使用Flush函数</li>
<li>永远不要忽略错误提示，忽略错误会导致程序崩溃</li>
<li>不要使用全局变量或者共享内存，并发不安全</li>
<li>println函数仅仅用于调试</li>
<li>使用正确的方式初始化一个元素是切片的映射，例如<code>map[type]slice</code></li>
<li>一直使用逗号，ok或者checked形式作为类型断言</li>
<li>使用一个工厂函数创建并初始化自己定义的类型</li>
<li>仅当一个结构体的方法想改变结构体时，使用结构体指针作为方法的接受者，否则使用一个结构体类型</li>
</ul>
<h2 id="16-1-误用短声明导致变量覆盖"><a href="#16-1-误用短声明导致变量覆盖" class="headerlink" title="16.1 误用短声明导致变量覆盖"></a>16.1 误用短声明导致变量覆盖</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">shadow</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</div><div class="line">	x, err := check1() <span class="comment">// x是新创建变量，err是被赋值</span></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="comment">// 正确返回err</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> y, err := check2(x); err != <span class="literal">nil</span> &#123; <span class="comment">// y和if语句中err被创建</span></div><div class="line">		<span class="keyword">return</span> <span class="comment">// if语句中的err覆盖外面的err，所以错误的返回nil！</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		fmt.Println(y)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="16-2-误用字符串"><a href="#16-2-误用字符串" class="headerlink" title="16.2 误用字符串"></a>16.2 误用字符串</h2><ul>
<li>字符串不可变</li>
<li>字符串运算效率低下</li>
<li>使用字符数组进行运算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> b bytes.Buffer</div><div class="line">...</div><div class="line"><span class="keyword">for</span> condition &#123;</div><div class="line">    b.WriteString(str) <span class="comment">// 将字符串str写入缓存buffer</span></div><div class="line">&#125;</div><div class="line">    <span class="keyword">return</span> b.String()</div></pre></td></tr></table></figure>
<h2 id="16-3-发生错误时使用defer关闭一个文件"><a href="#16-3-发生错误时使用defer关闭一个文件" class="headerlink" title="16.3 发生错误时使用defer关闭一个文件"></a>16.3 发生错误时使用defer关闭一个文件</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</div><div class="line">    <span class="keyword">if</span> f, err = os.Open(file); err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 对文件进行操作</span></div><div class="line">    f.Process(data)</div><div class="line">    <span class="comment">// 关闭文件</span></div><div class="line">    f.Close()</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<ul>
<li>defer只在函数返回时才会被执行，在循环的结尾或其他一些有限范围的代码内是不会被执行的</li>
</ul>
<h2 id="16-4-new和make"><a href="#16-4-new和make" class="headerlink" title="16.4 new和make"></a>16.4 new和make</h2><ul>
<li>切片，Map和channel，用make</li>
<li>数组，结构体，值类型用new</li>
</ul>
<h2 id="16-5-不需要将一个指向切片的指针传递给函数"><a href="#16-5-不需要将一个指向切片的指针传递给函数" class="headerlink" title="16.5 不需要将一个指向切片的指针传递给函数"></a>16.5 不需要将一个指向切片的指针传递给函数</h2><ul>
<li>切片实际上就是一个指向潜在数组的指针</li>
<li>当切片作为参数传递时，切记不要解引用切片</li>
</ul>
<h2 id="16-6-使用指针指向接口类型"><a href="#16-6-使用指针指向接口类型" class="headerlink" title="16.6 使用指针指向接口类型"></a>16.6 使用指针指向接口类型</h2><ul>
<li>接口类型已经是一个指针了</li>
</ul>
<h2 id="16-7-使用值类型时误用指针"><a href="#16-7-使用值类型时误用指针" class="headerlink" title="16.7 使用值类型时误用指针"></a>16.7 使用值类型时误用指针</h2><ul>
<li>值类型的内存时栈上分配，内存分配快速且开销不大</li>
<li>指针类型需要在堆上创建，导致额外的内存分配</li>
</ul>
<h2 id="16-8-误用协程和通道"><a href="#16-8-误用协程和通道" class="headerlink" title="16.8 误用协程和通道"></a>16.8 误用协程和通道</h2><ul>
<li>大多数情况下，通过栈传递参数会更有效率</li>
<li>当且仅当代码中并发执行非常重要，才使用协程和通道</li>
</ul>
<h2 id="16-9-闭包和协程的使用"><a href="#16-9-闭包和协程的使用" class="headerlink" title="16.9 闭包和协程的使用"></a>16.9 闭包和协程的使用</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> values = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 版本A:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123; <span class="comment">// ix是索引值</span></div><div class="line">        <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;() <span class="comment">// 调用闭包打印每个索引值</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    <span class="comment">// 版本B: 和A版本类似，但是通过调用闭包作为一个协程</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本C: 正确的处理方式</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(ix <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">            fmt.Print(ix, <span class="string">" "</span>)</div><div class="line">        &#125;(ix)</div><div class="line">    &#125;</div><div class="line">    fmt.Println()</div><div class="line">    time.Sleep(<span class="number">5e9</span>)</div><div class="line">    <span class="comment">// 版本D: 输出值:</span></div><div class="line">    <span class="keyword">for</span> ix := <span class="keyword">range</span> values &#123;</div><div class="line">        val := values[ix]</div><div class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">            fmt.Print(val, <span class="string">" "</span>)</div><div class="line">        &#125;()</div><div class="line">    &#125;</div><div class="line">    time.Sleep(<span class="number">1e9</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">0 1 2 3 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">4 4 4 4 4</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">1 0 3 4 2</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">10 11 12 13 14</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>
<h2 id="16-10-糟糕的错误处理"><a href="#16-10-糟糕的错误处理" class="headerlink" title="16.10 糟糕的错误处理"></a>16.10 糟糕的错误处理</h2><ul>
<li>创建一个布尔型变量用于测试错误条件是多余的</li>
<li>避免错误检测使代码变得混乱，使用闭包来封装你的错误检验</li>
</ul>
<h1 id="第17章-Go语言模式"><a href="#第17章-Go语言模式" class="headerlink" title="第17章 Go语言模式"></a>第17章 Go语言模式</h1><h2 id="17-1-逗号，ok模式"><a href="#17-1-逗号，ok模式" class="headerlink" title="17.1 逗号，ok模式"></a>17.1 逗号，ok模式</h2><ol>
<li>函数返回时检查错误<ol>
<li><code>val, err := pack1.Func()</code></li>
</ol>
</li>
<li>检测Map中是否存在一个键值<ol>
<li><code>if value, isPresent = map1[key1]; isPresent {}</code></li>
</ol>
</li>
<li>检测一个接口类型变量varI是否包含了类型T，类型断言<ol>
<li><code>if value, ok := varI.(T); ok {}</code></li>
</ol>
</li>
<li>检测一个通道ch是否关闭<ol>
<li><code>for input := range ch {}</code></li>
</ol>
</li>
</ol>
<h2 id="17-2-defer模式"><a href="#17-2-defer模式" class="headerlink" title="17.2 defer模式"></a>17.2 defer模式</h2><table>
<thead>
<tr>
<th>使用场景</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>关闭一个文件流</td>
<td><code>defer f.Close()</code></td>
</tr>
<tr>
<td>解锁一个被锁定的资源</td>
<td><code>defer mu.Unlock()</code></td>
</tr>
<tr>
<td>关闭一个通道</td>
<td><code>defer close(ch)</code></td>
</tr>
<tr>
<td>从panic恢复</td>
<td><code>defer func(){if err := revocer(); err ！= nil {}}</code></td>
</tr>
<tr>
<td>停止一个计时器</td>
<td><code>defer tick1.Stop()</code></td>
</tr>
<tr>
<td>释放一个进程p</td>
<td><code>defer p，Release()</code></td>
</tr>
<tr>
<td>停止CPU性能分析并立即写入</td>
<td><code>defer pprof.StopCPUProfile()</code></td>
</tr>
</tbody>
</table>
<h2 id="17-3-可见性模式"><a href="#17-3-可见性模式" class="headerlink" title="17.3 可见性模式"></a>17.3 可见性模式</h2><h2 id="17-4-运算符模式和接口"><a href="#17-4-运算符模式和接口" class="headerlink" title="17.4 运算符模式和接口"></a>17.4 运算符模式和接口</h2><h3 id="17-4-1-函数作为运算符"><a href="#17-4-1-函数作为运算符" class="headerlink" title="17.4.1 函数作为运算符"></a>17.4.1 函数作为运算符</h3><ul>
<li>go中没有函数重载，我们不得不给函数起不同的名称，可以将其作为包的私有函数，并暴露单一的 Add() 函数作为公共 API。可以在嵌套的 switch 断言中测试类型，以便在任何支持的参数组合上执行操作</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a Matrix, b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> a.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> sparseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">		<span class="keyword">case</span> denseMatrix:</div><div class="line">			<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">		…</div><div class="line">		&#125;</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-2-方法作为运算符"><a href="#17-4-2-方法作为运算符" class="headerlink" title="17.4.2 方法作为运算符"></a>17.4.2 方法作为运算符</h3><ul>
<li>根据接收者的不同，可以区分不同的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *sparseMatrix)</span> <span class="title">Add</span><span class="params">(b Matrix)</span> <span class="title">Matrix</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToSparse(a.(sparseMatrix), b.(sparseMatrix))</div><div class="line">	<span class="keyword">case</span> denseMatrix:</div><div class="line">		<span class="keyword">return</span> addSparseToDense(a.(sparseMatrix), b.(denseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="comment">// 不支持的参数</span></div><div class="line">		…</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="17-4-3-使用接口"><a href="#17-4-3-使用接口" class="headerlink" title="17.4.3 使用接口"></a>17.4.3 使用接口</h3><ul>
<li>不同类型上执行相同的方法时，创建一个通用化的接口以实现多态</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Algebraic <span class="keyword">interface</span> &#123;</div><div class="line">	Add(b Algebraic) Algebraic</div><div class="line">	Min(b Algebraic) Algebraic</div><div class="line">	Mult(b Algebraic) Algebraic</div><div class="line">	…</div><div class="line">	Elements()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a *denseMatrix)</span> <span class="title">Add</span><span class="params">(b Algebraic)</span> <span class="title">Algebraic</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> b.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> sparseMatrix:</div><div class="line">		<span class="keyword">return</span> addDenseToSparse(a, b.(sparseMatrix))</div><div class="line">	…</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		<span class="keyword">for</span> x in <span class="keyword">range</span> b.Elements() …</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第18章-实用代码块"><a href="#第18章-实用代码块" class="headerlink" title="第18章 实用代码块"></a>第18章 实用代码块</h1><h2 id="18-1-字符串"><a href="#18-1-字符串" class="headerlink" title="18.1 字符串"></a>18.1 字符串</h2><ul>
<li>如何修改字符串中的一个字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">str := <span class="string">"hello"</span></div><div class="line">c := []<span class="keyword">byte</span>(str)</div><div class="line">c[<span class="number">0</span>] = <span class="string">'c'</span></div><div class="line">s2 := <span class="keyword">string</span>(c)</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取字符串的子串 - <code>substr := str[n;m]</code></p>
</li>
<li><p>如何使用for或者for-range遍历一个字符串</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// gives only the bytes:</span></div><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ &#123;</div><div class="line">… = str[i]</div><div class="line">&#125;</div><div class="line"><span class="comment">// gives the Unicode characters:</span></div><div class="line"><span class="keyword">for</span> ix, ch := <span class="keyword">range</span> str &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何获取一个字符串的字节数 - len()</p>
</li>
<li><p>如何获取一个字符串的字符数 - utf8.RuneCountInString(str)</p>
</li>
<li><p>如何连接字符串</p>
<ul>
<li><code>with a bytes.Buffer</code></li>
<li><code>Strings.Join()</code></li>
<li><code>+=</code></li>
</ul>
</li>
<li>如何解析命令行参数：使用os或者flag包</li>
</ul>
<h2 id="18-2-数组和切片"><a href="#18-2-数组和切片" class="headerlink" title="18.2 数组和切片"></a>18.2 数组和切片</h2><ul>
<li><p>创建</p>
<ul>
<li><code>arr1 := new([len]type)</code></li>
<li><code>slice1 := make([]type, len)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>arr1 := [...]type{i1,i2,i3,i4,i5}</code></li>
<li><code>arrKeyValue := [len]type{i1:val1, i2: val2}</code></li>
<li><code>var slice1 []type = arr1[start:end]</code></li>
</ul>
</li>
<li><p>截断数组或者切片的最后一个元素</p>
<ul>
<li><code>line = line[:len(line)-1]</code></li>
</ul>
</li>
<li><p>遍历数组或者切片</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i:=<span class="number">0</span>; i &lt; <span class="built_in">len</span>(arr); i++ &#123;</div><div class="line">… = arr[i]</div><div class="line">&#125;</div><div class="line"><span class="keyword">for</span> ix, value := <span class="keyword">range</span> arr &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>二维数组或者切片中查找指定值V</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">found := <span class="literal">false</span></div><div class="line">Found: <span class="keyword">for</span> row := <span class="keyword">range</span> arr2Dim &#123;</div><div class="line">    <span class="keyword">for</span> column := <span class="keyword">range</span> arr2Dim[row] &#123;</div><div class="line">        <span class="keyword">if</span> arr2Dim[row][column] == V&#123;</div><div class="line">            found = <span class="literal">true</span></div><div class="line">            <span class="keyword">break</span> Found</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-3-Map"><a href="#18-3-Map" class="headerlink" title="18.3 Map"></a>18.3 Map</h2><ul>
<li><p>创建</p>
<ul>
<li><code>map1 := make(map[keyType]valueType)</code></li>
</ul>
</li>
<li><p>初始化</p>
<ul>
<li><code>map1 := map[string]int{&quot;one&quot;:1, &quot;two&quot;:2}</code></li>
</ul>
</li>
<li><p>遍历</p>
<ul>
<li><code>for key, val := range map1{}</code></li>
</ul>
</li>
<li><p>在map中检测key1是否存在</p>
<ul>
<li><code>val1, isPresent = map1[key1]</code></li>
</ul>
</li>
<li><p>删除一个键</p>
<ul>
<li><code>delete(map1, key1)</code></li>
</ul>
</li>
</ul>
<h2 id="18-4-结构体"><a href="#18-4-结构体" class="headerlink" title="18.4 结构体"></a>18.4 结构体</h2><ul>
<li>创建</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> structName <span class="keyword">struct</span> &#123;</div><div class="line">    field1 type1</div><div class="line">    field2 type2</div><div class="line"></div><div class="line">&#125;</div><div class="line">ms := <span class="built_in">new</span>(struct1)</div></pre></td></tr></table></figure>
<ul>
<li><p>初始化</p>
<ul>
<li><code>ms := &amp;struct1{10,10,&quot;chris&quot;}</code></li>
</ul>
</li>
<li><p>结构体命名大写开头则包外可见</p>
</li>
<li>每个结构体需要定义一个构件函数来初始化结构体</li>
</ul>
<h2 id="18-5-接口"><a href="#18-5-接口" class="headerlink" title="18.5 接口"></a>18.5 接口</h2><ul>
<li><p>检测一个值v是否实现了接口Stringer</p>
<ul>
<li><code>if v, ok := v.(Stringer); ok {}</code></li>
</ul>
</li>
<li><p>如何使用接口实现一个类型分类接口</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">classifier</span><span class="params">(items ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i, x := <span class="keyword">range</span> items &#123;</div><div class="line">        <span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</div><div class="line">        <span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a bool\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">float64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a float64\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is an int\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is nil\n"</span>, i)</div><div class="line">        <span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d is a string\n"</span>, i)</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            fmt.Printf(<span class="string">"param #%d’s type is unknown\n"</span>, i)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-6-函数"><a href="#18-6-函数" class="headerlink" title="18.6 函数"></a>18.6 函数</h2><ul>
<li>使用recover恢复panic</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">protect</span><span class="params">(g <span class="keyword">func</span>()</span>)</span> &#123;</div><div class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        log.Println(<span class="string">"done"</span>)</div><div class="line">        <span class="comment">// Println executes normally even if there is a panic</span></div><div class="line">        <span class="keyword">if</span> x := <span class="built_in">recover</span>(); x != <span class="literal">nil</span> &#123;</div><div class="line">            log.Printf(<span class="string">"run time panic: %v"</span>, x)</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    log.Println(<span class="string">"start"</span>)</div><div class="line">    g()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-7-文件"><a href="#18-7-文件" class="headerlink" title="18.7 文件"></a>18.7 文件</h2><ul>
<li>打开并读取</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">file, err := os.Open(<span class="string">"input.dat"</span>)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="keyword">defer</span> file.Close()</div><div class="line"></div><div class="line">iReader := bufio.NewReader(file)</div><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">    str, err := iReader.ReadString(<span class="string">'\n'</span>)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    fmt.Println(<span class="string">""</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通过切片读写文件</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">cat</span><span class="params">(f *file.File)</span></span> &#123;</div><div class="line">  <span class="keyword">const</span> NBUF = <span class="number">512</span></div><div class="line">  <span class="keyword">var</span> buf [NBUF]<span class="keyword">byte</span></div><div class="line">  <span class="keyword">for</span> &#123;</div><div class="line">    <span class="keyword">switch</span> nr, er := f.Read(buf[:]); <span class="literal">true</span> &#123;</div><div class="line">    <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</div><div class="line">      fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading from %s: %s\n"</span>,</div><div class="line">        f.String(), er.String())</div><div class="line">      os.Exit(<span class="number">1</span>)</div><div class="line">    <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></div><div class="line">      <span class="keyword">return</span></div><div class="line">    <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</div><div class="line">      <span class="keyword">if</span> nw, ew := file.Stdout.Write(buf[<span class="number">0</span>:nr]); nw != nr &#123;</div><div class="line">        fmt.Fprintf(os.Stderr, <span class="string">"cat: error writing from %s: %s\n"</span>,</div><div class="line">          f.String(), ew.String())</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-8-goroutine和channel"><a href="#18-8-goroutine和channel" class="headerlink" title="18.8 goroutine和channel"></a>18.8 goroutine和channel</h2><ul>
<li><p>tips</p>
<ul>
<li>出于性能考虑建议使用带缓存的通道</li>
<li>限制一个通道的数据数量并将它们封装成一个数组</li>
</ul>
</li>
<li><p>遍历一个channel</p>
<ul>
<li><code>for v := range ch {}</code></li>
</ul>
</li>
<li><p>检测一个通道ch是否关闭</p>
<ul>
<li><code>input, open := &lt;-ch; !open { }</code></li>
</ul>
</li>
<li><p>通过一个通道让主程序等待直到协程完成</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    ch &lt;- <span class="number">1</span></div><div class="line">&#125;()</div><div class="line">&lt;-ch</div></pre></td></tr></table></figure>
<ul>
<li>通道的工厂模板</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pump</span><span class="params">()</span> <span class="title">chan</span> <span class="title">int</span></span> &#123;</div><div class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">            ch &lt;- i</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> ch</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>通道迭代器模板</li>
<li>如何限制并发请求的处理数量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> MAXREQS = <span class="number">50</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> sem = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, MAXREQS)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Request <span class="keyword">struct</span> &#123;</div><div class="line">	a, b   <span class="keyword">int</span></div><div class="line">	replyc <span class="keyword">chan</span> <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	<span class="comment">// do something</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">(r *Request)</span></span> &#123;</div><div class="line">	sem &lt;- <span class="number">1</span> <span class="comment">// doesn't matter what we put in it</span></div><div class="line">	process(r)</div><div class="line">	&lt;-sem <span class="comment">// one empty place in the buffer: the next request can start</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">server</span><span class="params">(service <span class="keyword">chan</span> *Request)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> &#123;</div><div class="line">		request := &lt;-service</div><div class="line">		<span class="keyword">go</span> handle(request)</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	service := <span class="built_in">make</span>(<span class="keyword">chan</span> *Request)</div><div class="line">	<span class="keyword">go</span> server(service)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如何在多核上实现并行计算</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoAll</span><span class="params">()</span></span>&#123;</div><div class="line">    sem := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, NCPU) <span class="comment">// Buffering optional but sensible</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        <span class="keyword">go</span> DoPart(sem)</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Drain the channel sem, waiting for NCPU tasks to complete</span></div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; NCPU; i++ &#123;</div><div class="line">        &lt;-sem <span class="comment">// wait for one task to complete</span></div><div class="line">    &#125;</div><div class="line">    <span class="comment">// All done.</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DoPart</span><span class="params">(sem <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="comment">// do the part of the computation</span></div><div class="line">    sem &lt;<span class="number">-1</span> <span class="comment">// signal that this piece is done</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    runtime.GOMAXPROCS(NCPU) <span class="comment">// runtime.GOMAXPROCS = NCPU</span></div><div class="line">    DoAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>如何终止一个协程</p>
<ul>
<li><code>runtime.Goexit()</code></li>
</ul>
</li>
<li><p>简单的超时模板</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">timeout := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>, <span class="number">1</span>)</div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">    time.Sleep(<span class="number">1e9</span>) <span class="comment">// one second</span></div><div class="line">    timeout &lt;- <span class="literal">true</span></div><div class="line">&#125;()</div><div class="line"><span class="keyword">select</span> &#123;</div><div class="line">    <span class="keyword">case</span> &lt;-ch:</div><div class="line">    <span class="comment">// a read from ch has occurred</span></div><div class="line">    <span class="keyword">case</span> &lt;-timeout:</div><div class="line">    <span class="comment">// the read from ch has timed out</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>使用输入通道和输出通道代替锁</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(in, out <span class="keyword">chan</span> *Task)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> &#123;</div><div class="line">        t := &lt;-in</div><div class="line">        process(t)</div><div class="line">        out &lt;- t</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-9-网络和网页应用"><a href="#18-9-网络和网页应用" class="headerlink" title="18.9 网络和网页应用"></a>18.9 网络和网页应用</h2><ul>
<li>制作解析并使模板生效<ul>
<li><code>var strTempl = template.Must(template.New(&quot;TName&quot;).Parse(strTemplateHTML))</code></li>
</ul>
</li>
</ul>
<h2 id="18-10-其他"><a href="#18-10-其他" class="headerlink" title="18.10 其他"></a>18.10 其他</h2><ul>
<li>在程序出错时终止程序</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">    ...</div><div class="line">    os.Exit(<span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	<span class="built_in">panic</span>(<span class="string">"ERROR occurred: "</span> + err.Error())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="18-11-出于性能考虑的最佳实践和建议"><a href="#18-11-出于性能考虑的最佳实践和建议" class="headerlink" title="18.11 出于性能考虑的最佳实践和建议"></a>18.11 出于性能考虑的最佳实践和建议</h2><ul>
<li>尽可能的使用<code>:=</code>去初始化声明的一个变量</li>
<li>尽可能的使用字符代替字符串</li>
<li>尽可能使用切片替代数组</li>
<li>尽可能使用数组和切片替换映射</li>
<li>如果只想获取切片中的某项值，不需要值的索引，尽可能使用for-range去遍历切片</li>
<li>当数组元素是稀疏的，使用映射会降低内存消耗</li>
<li>初始化Map时指定其容量</li>
<li>当定义一个方法时，使用指针类型所谓方法的接受者</li>
<li>在代码中使用常量或者标志提取常量的值</li>
<li>尽可能在需要分配大量内存时使用缓存</li>
<li>使用缓存模板</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/04/16/the-way-to-go-基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/04/16/the-way-to-go-基础/" itemprop="url">the way to go 基础篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-16T14:16:48+08:00">
                2020-04-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index">
                    <span itemprop="name">go</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li><p>go语言诞生条件</p>
<ol>
<li>更快的开发速度</li>
<li>优越的多核工作</li>
<li>更好的网络编程环境</li>
<li>享受开发过程</li>
</ol>
</li>
<li><p>go语言追求短小精悍</p>
</li>
</ul>
<h1 id="第一章-Go语言的起源发展与普及"><a href="#第一章-Go语言的起源发展与普及" class="headerlink" title="第一章 Go语言的起源发展与普及"></a>第一章 Go语言的起源发展与普及</h1><h2 id="起源与发展"><a href="#起源与发展" class="headerlink" title="起源与发展"></a>起源与发展</h2><ol>
<li>起源于07年，09年正式发布，Robert Griesemer， Rob Pike, Ken Thompson</li>
<li>2019/11/10 完全开源Linux和MacOSX</li>
<li>2010/1/8 当选2009年年度语言</li>
<li>2010/5 谷歌开始使用</li>
<li>2011/5/5 Google App Engine支持Go语言</li>
<li>几个网址<ul>
<li>官网 golang.org</li>
<li>github.com/golang/go<br>*</li>
</ul>
</li>
</ol>
<h2 id="语言的主要特性和发展的环境和影响因素"><a href="#语言的主要特性和发展的环境和影响因素" class="headerlink" title="语言的主要特性和发展的环境和影响因素"></a>语言的主要特性和发展的环境和影响因素</h2><ul>
<li>go语言追求快速编译（Java)，高效执行(C++)，易于开发(动态语言）</li>
<li>go语言是一门类型安全和内容安全的编程语言</li>
<li>go语言存在指针，但是不允许指针运算</li>
<li>对于并发编程，网络编程支持极好-goroutine</li>
<li>go语言依赖管理采用分包进行</li>
<li>go语言和Java一样有GC机制</li>
<li>go install部署第三方包</li>
</ul>
<h2 id="指导设计原则"><a href="#指导设计原则" class="headerlink" title="指导设计原则"></a>指导设计原则</h2><ul>
<li>go语言关键字25个</li>
<li>go语言编码规范-<a href="https://golang.org/ref/spec" target="_blank" rel="external">https://golang.org/ref/spec</a></li>
</ul>
<h2 id="语言特性"><a href="#语言特性" class="headerlink" title="语言特性"></a>语言特性</h2><ul>
<li>go语言在本质上支持并发编程</li>
<li>go语言没有类的概念，用interface来实现多态</li>
<li>go语言是类型安全的语言，使用静态类型</li>
<li>go语言是强类型语言</li>
<li>go语言支持交叉编译</li>
<li>go语言代码和字符串的编码方式都是utf-8，支持国际化</li>
</ul>
<h2 id="语言用途"><a href="#语言用途" class="headerlink" title="语言用途"></a>语言用途</h2><ul>
<li>go语言用于web服务器，存储集群，分布式场景，游戏服务</li>
<li>go语言的目标是时限CEP, complex Event Process</li>
<li>go语言不适合开发实时性要求高的软件</li>
</ul>
<h2 id="特性缺失"><a href="#特性缺失" class="headerlink" title="特性缺失"></a>特性缺失</h2><ul>
<li>不支持函数重载和操作符重载</li>
<li>不支持隐式转换</li>
<li>不支持类和类型的继承</li>
<li>不支持变体类型</li>
<li>不支持动态加载代码</li>
<li>不支持动态链接库</li>
<li>不支持泛型</li>
<li>通过recover和panic来替代异常机制</li>
<li>不支持静态变量</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li>简化问题，易于学习</li>
<li>内存管理，语法简洁，易于使用</li>
<li>快速编译，高效开发</li>
<li>高效执行</li>
<li>并发支持，轻松驾驭</li>
<li>静态类型</li>
<li>标准类库，规范统一</li>
<li>易于部署</li>
</ul>
<h1 id="第二章-安装与运行环境"><a href="#第二章-安装与运行环境" class="headerlink" title="第二章 安装与运行环境"></a>第二章 安装与运行环境</h1><h2 id="平台与架构"><a href="#平台与架构" class="headerlink" title="平台与架构"></a>平台与架构</h2><ul>
<li>编译器支持的平台：<ul>
<li>Linux</li>
<li>FreeBSD</li>
<li>Mac OS X</li>
</ul>
</li>
<li>编译器<ul>
<li>gc</li>
<li>gccgo</li>
</ul>
</li>
</ul>
<h2 id="Go环境变量"><a href="#Go环境变量" class="headerlink" title="Go环境变量"></a>Go环境变量</h2><ul>
<li>$GOROOT：go的安装位置</li>
<li>$GOARCH：机器的处理器架构</li>
<li>$GOOS：操作系统</li>
<li>$GOBIN：编译器和链接器的安装位置</li>
<li>$GOPATH：包含多个Go语言远吗文件，包文件和可执行文件，src，pkg，bin三个目录</li>
<li>$GOARM：ARM专用</li>
<li>$GOMAXPROCS：设置可用的处理器核数</li>
</ul>
<h2 id="Linux安装go"><a href="#Linux安装go" class="headerlink" title="Linux安装go"></a>Linux安装go</h2><ol>
<li><p>Linux下通过<code>$HOME/.bashrc</code>来自定义环境</p>
<ul>
<li>首先配置GOROOT：<code>export GOROOT=$HOME/go</code></li>
<li>配置path：<code>export PATH=$PATH:$GOROOT/bin</code></li>
<li>配置工作路径：<code>export GOPATH=$HOME/Applications/Go</code></li>
<li><code>source ~/.bashrc</code>生效</li>
<li><code>go env</code>查看</li>
</ul>
</li>
<li><p>go源码获取</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://storage.googleapis.com/golang/go&lt;VERSION&gt;.src.tar.gz</div><div class="line">tar -zxvf go&lt;VERSION&gt;.src.tar.gz</div><div class="line">sudo mv go $GOROOT</div><div class="line">cd $GOROOT/src</div><div class="line">./all.bash</div></pre></td></tr></table></figure>
</li>
<li><p>go version查看版本信息</p>
</li>
</ol>
<h2 id="安装目录"><a href="#安装目录" class="headerlink" title="安装目录"></a>安装目录</h2><pre><code>.
├── CONTRIBUTING.md
├── CONTRIBUTORS
├── PATENTS
├── VERSION
├── api
├── bin     // 可执行文件
├── doc     // 文档
├── favicon.ico
├── lib     // 文档模板
├── misc    // 编辑器相关内容
├── pkg
├── robots.txt
├── src     // 完整源码
└── test
</code></pre><h2 id="go-runtime"><a href="#go-runtime" class="headerlink" title="go runtime"></a>go runtime</h2><ul>
<li>runtime相当于Java的虚拟机，负责内存分配，垃圾回收，栈处理，goroutine，channel，slice，map，reflect等</li>
<li>go的gc采用标记-清除回收器</li>
</ul>
<h1 id="第三章-Go开发环境的基本要求"><a href="#第三章-Go开发环境的基本要求" class="headerlink" title="第三章 Go开发环境的基本要求"></a>第三章 Go开发环境的基本要求</h1><h2 id="调试器"><a href="#调试器" class="headerlink" title="调试器"></a>调试器</h2><ol>
<li>打印语句，print，println,fmt.Println,fmt.Printf</li>
<li>%+v, %#v,%T打印实例的不同信息</li>
<li>使用panic获取堆栈信息</li>
<li>defer关键字来跟踪代码执行</li>
<li>go build 编译</li>
<li>go install 编译并安装</li>
</ol>
<h2 id="格式化代码-gofmt"><a href="#格式化代码-gofmt" class="headerlink" title="格式化代码 - gofmt"></a>格式化代码 - gofmt</h2><ul>
<li><code>gofmt -r &#39;(a) -&gt; a&#39; –w *.go</code></li>
<li><code>gofmt -r &#39;a[n:len(a)] -&gt; a[n:]&#39; –w *.go</code></li>
<li>参考-<a href="http://golang.org/cmd/gofmt/" target="_blank" rel="external">http://golang.org/cmd/gofmt/</a></li>
</ul>
<h2 id="代码文档-go-doc"><a href="#代码文档-go-doc" class="headerlink" title="代码文档 - go doc"></a>代码文档 - go doc</h2><ul>
<li>go doc package 获取包的文档注释，例如：go doc fmt 会显示使用 godoc 生成的 fmt 包的文档注释。</li>
<li>go doc package/subpackage 获取子包的文档注释，例如：go doc container/list。</li>
<li>go doc package function 获取某个函数在某个包中的文档注释，例如：go doc fmt Printf 会显示有关 fmt.Printf() 的使用说明</li>
</ul>
<h1 id="第四章-语言的核心结构和技术"><a href="#第四章-语言的核心结构和技术" class="headerlink" title="第四章 语言的核心结构和技术"></a>第四章 语言的核心结构和技术</h1><h2 id="文件名、关键字与标识符"><a href="#文件名、关键字与标识符" class="headerlink" title="文件名、关键字与标识符"></a>文件名、关键字与标识符</h2><ul>
<li>文件名以<code>.go</code>结尾</li>
<li><code>_</code>空白标识符</li>
<li>go的25个关键字</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">关键字</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">break</td>
<td style="text-align:center">default</td>
<td style="text-align:center">func</td>
<td style="text-align:center">interface</td>
<td style="text-align:center">selcet</td>
</tr>
<tr>
<td style="text-align:center">case</td>
<td style="text-align:center">defer</td>
<td style="text-align:center">go</td>
<td style="text-align:center">map</td>
<td style="text-align:center">struct</td>
</tr>
<tr>
<td style="text-align:center">chan</td>
<td style="text-align:center">else</td>
<td style="text-align:center">goto</td>
<td style="text-align:center">package</td>
<td style="text-align:center">switch</td>
</tr>
<tr>
<td style="text-align:center">const</td>
<td style="text-align:center">fallthrough</td>
<td style="text-align:center">if</td>
<td style="text-align:center">range</td>
<td style="text-align:center">type</td>
</tr>
<tr>
<td style="text-align:center">continue</td>
<td style="text-align:center">for</td>
<td style="text-align:center">import</td>
<td style="text-align:center">return</td>
<td style="text-align:center">var</td>
</tr>
</tbody>
</table>
<ul>
<li>36个预定义标识符，函数</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">预定义标识符</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">append</td>
<td style="text-align:center">bool</td>
<td style="text-align:center">byte</td>
<td style="text-align:center">cap</td>
<td style="text-align:center">close</td>
<td style="text-align:center">complex</td>
<td style="text-align:center">complex64</td>
<td style="text-align:center">complex128</td>
<td style="text-align:center">unit16</td>
</tr>
<tr>
<td style="text-align:center">copy</td>
<td style="text-align:center">false</td>
<td style="text-align:center">float32</td>
<td style="text-align:center">float64</td>
<td style="text-align:center">image</td>
<td style="text-align:center">int</td>
<td style="text-align:center">int8</td>
<td style="text-align:center">int16</td>
<td style="text-align:center">uint32</td>
</tr>
<tr>
<td style="text-align:center">int32</td>
<td style="text-align:center">int64</td>
<td style="text-align:center">iota</td>
<td style="text-align:center">len</td>
<td style="text-align:center">make</td>
<td style="text-align:center">new</td>
<td style="text-align:center">nil</td>
<td style="text-align:center">panic</td>
<td style="text-align:center">unit64</td>
</tr>
<tr>
<td style="text-align:center">print</td>
<td style="text-align:center">println</td>
<td style="text-align:center">real</td>
<td style="text-align:center">recover</td>
<td style="text-align:center">string</td>
<td style="text-align:center">true</td>
<td style="text-align:center">uint</td>
<td style="text-align:center">uint8</td>
<td style="text-align:center">uintptr</td>
</tr>
</tbody>
</table>
<ul>
<li>go程序一般由关键字，常量，变量，运算符，类型和函数组成</li>
<li>分隔符 <code>(), [], {}</code></li>
<li>标点<code>.、,、;、:、...</code>等，但是不用<code>;</code>结尾</li>
</ul>
<h2 id="Go程序的基本结构要素"><a href="#Go程序的基本结构要素" class="headerlink" title="Go程序的基本结构要素"></a>Go程序的基本结构要素</h2><h3 id="包-package"><a href="#包-package" class="headerlink" title="包-package"></a>包-package</h3><ul>
<li>包是结构化的一种方式，每个程序都有包的概念组成，一个包可以由多个.go文件组成</li>
<li>在源文件的第一行指明这个文件属于哪个包</li>
<li>一个包的源文件必须一起编译，包是编译的单元</li>
<li>对一个包进行更改或者重新编译，所有引用了这个包的客户端程序都必须全部重新编译</li>
<li>go中包模型采用显示依赖关系机制来打到快速变异的目的</li>
<li><p>包引入</p>
<pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"><span class="keyword">import</span> <span class="string">"os"</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"os"</span></div><div class="line">)</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>包名不是以<code>.</code>或者<code>/</code>开头，会在全局文件进行查找，以<code>./</code>开头会在相对目录中查找,以<code>/</code>开头会在绝对路径中查找</p>
</li>
<li>可见性规则：标识符的大小写区别</li>
<li>包可以用别名进行区分</li>
</ul>
<h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><ul>
<li><p>定义格式</p>
<pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">functionName</span><span class="params">(parameter_list)</span> <span class="params">(return_value_list)</span></span> &#123;</div><div class="line">   …</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre></li>
<li><p>go语言是以<code>;</code>作为语句的结尾，只是由编译器自动完成</p>
</li>
<li>内部包命名遵循驼峰命名法，外部调用的遵循Pascal命名法</li>
<li>程序正常退出代码为0，异常退出代码为1</li>
</ul>
<h3 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h3><ul>
<li><code>//</code> - 单行注释</li>
<li><code>/*  */</code> - 多行注释</li>
<li>每个包都应该有注释，package关键字之前的注释默认为对包的说明</li>
<li>全局作用于的类型、变量、常量、函数、对象都应该有一个合理的注释</li>
</ul>
<h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><ul>
<li>类型定义了某个变量的值的集合和可对其进行操作的集合</li>
<li>基础类型：int、float、bool、string、</li>
<li>复合类型：struct、array、slice、map、channel</li>
<li>描述行为的：interface</li>
<li>函数可以作为类型返回</li>
</ul>
<h3 id="go程序的一般结构"><a href="#go程序的一般结构" class="headerlink" title="go程序的一般结构"></a>go程序的一般结构</h3><ul>
<li>完成包的导入</li>
<li>常量，变量，类型的定义或声明</li>
<li>如果存在init函数，对改函数进行定义，每个含有该函数的文件都会先执行init函数</li>
<li>如果包为main包，则定义main函数</li>
<li><p>定义其他的函数，首先是类型的方法，函数名字可以按照字母顺序来排列</p>
</li>
<li><p>go语言执行顺序：</p>
<ul>
<li>按顺序导入所有被main包引入的其他包</li>
<li>如果包中引入了其他包，递归执行包的引入</li>
<li>最新引入的包首先开始常量和变量的初始化</li>
<li>init</li>
<li>main</li>
</ul>
</li>
</ul>
<h3 id="类型抓换"><a href="#类型抓换" class="headerlink" title="类型抓换"></a>类型抓换</h3><ul>
<li>显示转换</li>
<li><code>a := b(a)</code></li>
</ul>
<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><ul>
<li>const关键字定义</li>
<li>类型：bool，int，float，complex，string</li>
<li><code>const Pi = 3.1415926</code></li>
<li>常量的值必须在编译时就能够确定</li>
<li>数字型的常量是没有大小和符号的，不会溢出</li>
<li>iota特性</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><ul>
<li><p>实例<br>  <code>var a string</code></p>
  <figure class="highlight plain"><figcaption><span>(</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">    a int</div><div class="line">    b bool</div><div class="line">    str string</div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>变量被声明之后，系统会自动赋给该变量零值0，0.0， false，’’， nil</p>
</li>
<li>驼峰命名法</li>
<li>全局变量和局部变量</li>
<li><p>变量的声明和赋值可以一起进行</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> a = <span class="number">15</span></div><div class="line"><span class="keyword">var</span> b = <span class="literal">false</span></div><div class="line"><span class="keyword">var</span> str = <span class="string">"Go says hello to the world!"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> (</div><div class="line">	a = <span class="number">15</span></div><div class="line">	b = <span class="literal">false</span></div><div class="line">	str = <span class="string">"Go says hello to the world!"</span></div><div class="line">	numShips = <span class="number">50</span></div><div class="line">	city <span class="keyword">string</span></div><div class="line">)</div></pre></td></tr></table></figure>
</li>
<li><p>通过runtime获取运行环境</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">   <span class="string">"runtime"</span></div><div class="line">	<span class="string">"os"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> goos <span class="keyword">string</span> = runtime.GOOS</div><div class="line">	fmt.Printf(<span class="string">"The operating system is: %s\n"</span>, goos)</div><div class="line">	path := os.Getenv(<span class="string">"PATH"</span>)</div><div class="line">	fmt.Printf(<span class="string">"Path is %s\n"</span>, path)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="值类型和引用类型"><a href="#值类型和引用类型" class="headerlink" title="值类型和引用类型"></a>值类型和引用类型</h3><ul>
<li>指针 &amp;i</li>
<li>一个引用类型的变量r1存储的是r1的值所在的内存地址，或内存地址中第一个字所在的位置</li>
<li>go语言中指针，slice，maps，channel都是引用类型</li>
</ul>
<h3 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h3><ul>
<li>fmt.Printf</li>
<li>%s-字符串</li>
<li>%v-类型默认输出格式</li>
<li>%T-类型</li>
</ul>
<h3 id="赋值操作符"><a href="#赋值操作符" class="headerlink" title=":=赋值操作符"></a><code>:=</code>赋值操作符</h3><ul>
<li><code>a := 50</code>,类型会自动判断</li>
<li>函数体内的首选方案，但是不能用于全局变量</li>
<li><code>a, b, c := 5, 5.5, &quot;5&quot;</code></li>
<li>a, b = b, a 交换值</li>
<li><code>_</code>抛弃不要的值</li>
</ul>
<h3 id="init函数"><a href="#init函数" class="headerlink" title="init函数"></a>init函数</h3><ul>
<li>不能被人为调用</li>
<li>执行优先级高于main</li>
<li>每个源文件只包含一个init函数</li>
<li>init中可以定义变量，检查数据，调用后台goroutine</li>
</ul>
<h2 id="基本类型和运算符"><a href="#基本类型和运算符" class="headerlink" title="基本类型和运算符"></a>基本类型和运算符</h2><h3 id="bool类型"><a href="#bool类型" class="headerlink" title="bool类型"></a>bool类型</h3><ul>
<li><code>var b bool = true</code></li>
<li><code>==</code>, <code>!=</code></li>
<li>go语言只有类型相同的两个值才可以进行比较</li>
<li><code>!、&amp;&amp;、||</code>，其中<code>&amp;&amp;</code>和<code>||</code></li>
<li>布尔值的命名推荐以is开头，如isSorted，isFinished等</li>
</ul>
<h3 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h3><ul>
<li>int，uint - 4个字节或者8个字节</li>
<li><p>uintptr - 存放一个指针的长度</p>
</li>
<li><p>整数：</p>
<ul>
<li>int8（-128 -&gt; 127）</li>
<li>int16（-32768 -&gt; 32767）</li>
<li>int32（-2,147,483,648 -&gt; 2,147,483,647）</li>
<li>int64（-9,223,372,036,854,775,808 -&gt; 9,223,372,036,854,775,807）</li>
</ul>
</li>
<li>无符号整数：<ul>
<li>uint8（0 -&gt; 255）</li>
<li>uint16（0 -&gt; 65,535）</li>
<li>uint32（0 -&gt; 4,294,967,295）</li>
<li>uint64（0 -&gt; 18,446,744,073,709,551,615）</li>
</ul>
</li>
<li><p>浮点型（IEEE-754 标准）：</p>
<ul>
<li>float32（+- 1e-45 -&gt; +- 3.4 * 1e38）</li>
<li>float64（+- 5 <em> 1e-324 -&gt; 107 </em> 1e308</li>
</ul>
</li>
<li><p>前缀0表示8进制数</p>
</li>
<li>前缀0x表示16进制数</li>
<li>e表示10的次方</li>
<li>go语言中变量之间不可以混用，常量可以，变量之间需要显示转换</li>
<li><p>格式化占位符</p>
<ul>
<li>%d - 整数</li>
<li>%x,%X - 16进制数字</li>
<li>%g - 浮点数</li>
<li>%f - 输出浮点数</li>
<li>%e - 输出科学计数法数</li>
<li>%n.mg - 数字n精确到m位</li>
</ul>
</li>
<li><p>位运算 - 用于整数类型的变量，并且要求变量等长</p>
<ul>
<li>按位与<code>&amp;</code></li>
<li>按位或<code>|</code></li>
<li>按位异或<code>^</code></li>
<li>位清除<code>&amp;^</code>将指定位置上的值设置为0</li>
<li>按位补足<code>^</code></li>
<li>位左移<code>&lt;&lt;</code></li>
<li>位右移<code>&gt;&gt;</code></li>
</ul>
</li>
<li><p>逻辑运算符</p>
<ul>
<li>==</li>
<li>!=</li>
<li>&lt;</li>
<li>&lt;=</li>
<li>&gt;</li>
<li><blockquote>
<p>=</p>
</blockquote>
</li>
</ul>
</li>
<li><p>算数运算符</p>
<ul>
<li>+</li>
<li>-</li>
<li>*</li>
<li>/</li>
<li>%</li>
<li>-=</li>
<li>+=</li>
<li>*=</li>
<li>/=</li>
<li>++，–等操作可以用于语句，但是不可以用于表达式 a[i] = b[i++]是不允许的</li>
</ul>
</li>
<li><p>随机数 - rand包</p>
</li>
</ul>
<h3 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">优先级 	运算符</div><div class="line"> 7 		^ !</div><div class="line"> 6 		* / % &lt;&lt; &gt;&gt; &amp; &amp;^</div><div class="line"> 5 		+ - | ^</div><div class="line"> 4 		== != &lt; &lt;= &gt;= &gt;</div><div class="line"> 3 		&lt;-</div><div class="line"> 2 		&amp;&amp;</div><div class="line"> 1 		||</div></pre></td></tr></table></figure>
<h3 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h3><ul>
<li><code>type TZ int</code> TZ是int的别名</li>
<li>别名不会拥有原类型的方法</li>
</ul>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><ul>
<li>utf-8编码中每个字符占据字节数不确定，go中字符可能占据1-4个字节</li>
<li>go语言支持两种字面值<ul>
<li>解释字符串<ul>
<li><code>\n</code></li>
<li><code>\r</code></li>
<li><code>\t</code></li>
<li><code>\u</code></li>
<li><code>\\</code></li>
</ul>
</li>
<li>非解释字符串-普通字符串</li>
</ul>
</li>
<li>获取字符串的字节内容：str[i]</li>
<li>拼接符<code>+</code></li>
<li>效率： bytes.Buffer &gt; strings.Join &gt; +</li>
</ul>
<h2 id="strings和strconv包"><a href="#strings和strconv包" class="headerlink" title="strings和strconv包"></a>strings和strconv包</h2><h3 id="前缀和后缀"><a href="#前缀和后缀" class="headerlink" title="前缀和后缀"></a>前缀和后缀</h3><ul>
<li><p>HasPrefix - 前缀</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasPrefix tests whether the string s begins with prefix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasPrefix</span><span class="params">(s, prefix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(prefix) &amp;&amp; s[<span class="number">0</span>:<span class="built_in">len</span>(prefix)] == prefix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>HasSuffix - 后缀</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// HasSuffix tests whether the string s ends with suffix.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">HasSuffix</span><span class="params">(s, suffix <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="built_in">len</span>(s) &gt;= <span class="built_in">len</span>(suffix) &amp;&amp; s[<span class="built_in">len</span>(s)-<span class="built_in">len</span>(suffix):] == suffix</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="字符串包含关系"><a href="#字符串包含关系" class="headerlink" title="字符串包含关系"></a>字符串包含关系</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Contains reports whether substr is within s.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Contains</span><span class="params">(s, substr <span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Index(s, substr) &gt;= <span class="number">0</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="判断子字符串或字符在父字符串中出现的位置"><a href="#判断子字符串或字符在父字符串中出现的位置" class="headerlink" title="判断子字符串或字符在父字符串中出现的位置"></a>判断子字符串或字符在父字符串中出现的位置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// Index returns the index of the first instance of substr in s, or -1 if substr is not present in s.</div><div class="line">func Index(s, substr string) int &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// LastIndex returns the index of the last instance of substr in s, or -1 if substr is not present in s.</div><div class="line">func LastIndex(s, substr string) int &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// IndexRune returns the index of the first instance of the Unicode code point</div><div class="line">// r, or -1 if rune is not present in s.</div><div class="line">// If r is utf8.RuneError, it returns the first instance of any</div><div class="line">// invalid UTF-8 byte sequence.</div><div class="line">func IndexRune(s string, r rune) int &#123;</div><div class="line">	switch &#123;</div><div class="line">	case 0 &lt;= r &amp;&amp; r &lt; utf8.RuneSelf:</div><div class="line">		return IndexByte(s, byte(r))</div><div class="line">	case r == utf8.RuneError:</div><div class="line">		for i, r := range s &#123;</div><div class="line">			if r == utf8.RuneError &#123;</div><div class="line">				return i</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return -1</div><div class="line">	case !utf8.ValidRune(r):</div><div class="line">		return -1</div><div class="line">	default:</div><div class="line">		return Index(s, string(r))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="字符串替换"><a href="#字符串替换" class="headerlink" title="字符串替换"></a>字符串替换</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Replace returns a copy of the string s with the first n</span></div><div class="line"><span class="comment">// non-overlapping instances of old replaced by new.</span></div><div class="line"><span class="comment">// If old is empty, it matches at the beginning of the string</span></div><div class="line"><span class="comment">// and after each UTF-8 sequence, yielding up to k+1 replacements</span></div><div class="line"><span class="comment">// for a k-rune string.</span></div><div class="line"><span class="comment">// If n &lt; 0, there is no limit on the number of replacements.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Replace</span><span class="params">(s, old, <span class="built_in">new</span> <span class="keyword">string</span>, n <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> old == <span class="built_in">new</span> || n == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Compute number of replacements.</span></div><div class="line">	<span class="keyword">if</span> m := Count(s, old); m == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> s <span class="comment">// avoid allocation</span></div><div class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> n &lt; <span class="number">0</span> || m &lt; n &#123;</div><div class="line">		n = m</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Apply replacements to buffer.</span></div><div class="line">	t := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="built_in">len</span>(s)+n*(<span class="built_in">len</span>(<span class="built_in">new</span>)-<span class="built_in">len</span>(old)))</div><div class="line">	w := <span class="number">0</span></div><div class="line">	start := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">		j := start</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(old) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">if</span> i &gt; <span class="number">0</span> &#123;</div><div class="line">				_, wid := utf8.DecodeRuneInString(s[start:])</div><div class="line">				j += wid</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">			j += Index(s[start:], old)</div><div class="line">		&#125;</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], s[start:j])</div><div class="line">		w += <span class="built_in">copy</span>(t[w:], <span class="built_in">new</span>)</div><div class="line">		start = j + <span class="built_in">len</span>(old)</div><div class="line">	&#125;</div><div class="line">	w += <span class="built_in">copy</span>(t[w:], s[start:])</div><div class="line">	<span class="keyword">return</span> <span class="keyword">string</span>(t[<span class="number">0</span>:w])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="重复字符串"><a href="#重复字符串" class="headerlink" title="重复字符串"></a>重复字符串</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Repeat returns a new string consisting of count copies of the string s.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// It panics if count is negative or if</span></div><div class="line"><span class="comment">// the result of (len(s) * count) overflows.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Repeat</span><span class="params">(s <span class="keyword">string</span>, count <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="修改字符串大小写"><a href="#修改字符串大小写" class="headerlink" title="修改字符串大小写"></a>修改字符串大小写</h3><ul>
<li>strings.ToLower(s) string</li>
<li>strings.ToUpper(s) string</li>
</ul>
<h3 id="修剪字符串"><a href="#修剪字符串" class="headerlink" title="修剪字符串"></a>修剪字符串</h3><ul>
<li>strings.TrimSpcae(s)-剔除字符串开头和结尾的空白</li>
<li>strings.Trim(s, “cut”)-剔除字符串开头和结尾的指定字符</li>
<li>TrimLeft,TrimRight</li>
</ul>
<h3 id="分割字符串"><a href="#分割字符串" class="headerlink" title="分割字符串"></a>分割字符串</h3><ul>
<li>strings.Fields(s) - 根据空白字符分割</li>
<li>strigns.Split(s, sep) - 根据sep来分割字符串</li>
</ul>
<h3 id="拼接slice到字符串"><a href="#拼接slice到字符串" class="headerlink" title="拼接slice到字符串"></a>拼接slice到字符串</h3><ul>
<li>strings.Join(sl []string, sep string) string - 将slice使用分隔符sep来拼接成一个字符串</li>
</ul>
<h3 id="从字符串中读取内容"><a href="#从字符串中读取内容" class="headerlink" title="从字符串中读取内容"></a>从字符串中读取内容</h3><ul>
<li>strings.NewReader(str)</li>
<li>Read()</li>
<li>ReadByte()</li>
<li>ReadRune()</li>
</ul>
<h3 id="字符串和其他类型的转换"><a href="#字符串和其他类型的转换" class="headerlink" title="字符串和其他类型的转换"></a>字符串和其他类型的转换</h3><ul>
<li>strconv.Itoa(i int) string - int转换成字符串</li>
<li>strconv.FormatFloat() string</li>
<li>strconv.Atoi(s string) (int, error) 字符串到int</li>
<li>strconv.ParseFloat(s string, bitSize int) (f float, err error)</li>
</ul>
<h2 id="时间和日期"><a href="#时间和日期" class="headerlink" title="时间和日期"></a>时间和日期</h2><ul>
<li>time包</li>
<li>time.Now</li>
<li>time.Day()</li>
<li>time.Minute()</li>
<li>time.Duration()</li>
</ul>
<h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><ul>
<li>取地址符<code>&amp;</code></li>
<li>一个指针变量可以指向任何一个值的内存地址</li>
<li>通过指针来实现对原来变量值的修改</li>
<li>指针可以用来传递变量的引用，而不是变量的值的拷贝，节省开销</li>
</ul>
<h1 id="第五章-控制结构"><a href="#第五章-控制结构" class="headerlink" title="第五章 控制结构"></a>第五章 控制结构</h1><h2 id="5-1-if-else结构"><a href="#5-1-if-else结构" class="headerlink" title="5.1 if-else结构"></a>5.1 if-else结构</h2><pre><code><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> condition1 &#123;</div><div class="line">	<span class="comment">// do something</span></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> condition2 &#123;</div><div class="line">	<span class="comment">// do something else</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	<span class="comment">// catch-all or default</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</code></pre><ul>
<li>判断一个字符串是否为空</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>  str == <span class="string">""</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="built_in">len</span>(str) == <span class="number">0</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>判断go运行的操作系统</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> runtime.GOOS == <span class="string">"windows"</span> &#123;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="测试多返回值函数的错误"><a href="#测试多返回值函数的错误" class="headerlink" title="测试多返回值函数的错误"></a>测试多返回值函数的错误</h2><ul>
<li>程序应该在最接近的位置检查所有相关的错误</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">value, err := pack1.Function1(param1)</div><div class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"An error occured in pack1.Function1 with parameter %v"</span>, param1)</div><div class="line">	<span class="keyword">return</span> err</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> value, ok := readData(); ok &#123;</div><div class="line">…</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="switch结构"><a href="#switch结构" class="headerlink" title="switch结构"></a>switch结构</h2><ul>
<li>使用fallthrough表示执行完当前分支之后继续执行后续分支</li>
<li>分支之间没有break关键字</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> num <span class="keyword">int</span> = <span class="number">100</span></div><div class="line"></div><div class="line">    <span class="keyword">switch</span> num &#123;</div><div class="line">    <span class="keyword">case</span> <span class="number">98</span>, <span class="number">99</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    <span class="keyword">case</span> <span class="number">100</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">            fmt.Println(<span class="string">".."</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>无初始值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> num1 <span class="keyword">int</span> = <span class="number">7</span></div><div class="line"></div><div class="line">	<span class="keyword">switch</span> &#123;</div><div class="line">	    <span class="keyword">case</span> num1 &lt; <span class="number">0</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is negative"</span>)</div><div class="line">	    <span class="keyword">case</span> num1 &gt; <span class="number">0</span> &amp;&amp; num1 &lt; <span class="number">10</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is between 0 and 10"</span>)</div><div class="line">	    <span class="keyword">default</span>:</div><div class="line">		    fmt.Println(<span class="string">"Number is 10 or greater"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>包含一个初始化语句</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> a, b := x[i], y[j] &#123;</div><div class="line">	<span class="keyword">case</span> a &lt; b: t = <span class="number">-1</span></div><div class="line">	<span class="keyword">case</span> a == b: t = <span class="number">0</span></div><div class="line">	<span class="keyword">case</span> a &gt; b: t = <span class="number">1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="for结构"><a href="#for结构" class="headerlink" title="for结构"></a>for结构</h2><ul>
<li>基于计数器的迭代</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</div><div class="line">	fmt.Printf(<span class="string">"This is the %d iteration\n"</span>, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>基于条件判断的迭代</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> i &gt;= <span class="number">0</span> &#123;</div><div class="line">	i = i - <span class="number">1</span></div><div class="line">	fmt.Printf(<span class="string">"The variable i is now: %d\n"</span>, i)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>无线循环 - 服务器</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> t, err = p.Token(); err == <span class="literal">nil</span>; t, err = p.Token() &#123;</div><div class="line">	...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>for-range结构</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	str := <span class="string">"Go is a beautiful language!"</span></div><div class="line">	fmt.Printf(<span class="string">"The length of str is: %d\n"</span>, <span class="built_in">len</span>(str))</div><div class="line">	<span class="keyword">for</span> pos, char := <span class="keyword">range</span> str &#123;</div><div class="line">		fmt.Printf(<span class="string">"Character on position %d is: %c \n"</span>, pos, char)</div><div class="line">	&#125;</div><div class="line">	fmt.Println()</div><div class="line">	str2 := <span class="string">"Chinese: 日本語"</span></div><div class="line">	fmt.Printf(<span class="string">"The length of str2 is: %d\n"</span>, <span class="built_in">len</span>(str2))</div><div class="line">	<span class="keyword">for</span> pos, char := <span class="keyword">range</span> str2 &#123;</div><div class="line">    	fmt.Printf(<span class="string">"character %c starts at byte position %d\n"</span>, char, pos)</div><div class="line">	&#125;</div><div class="line">	fmt.Println()</div><div class="line">	fmt.Println(<span class="string">"index int(rune) rune    char bytes"</span>)</div><div class="line">	<span class="keyword">for</span> index, <span class="keyword">rune</span> := <span class="keyword">range</span> str2 &#123;</div><div class="line">    	fmt.Printf(<span class="string">"%-2d      %d      %U '%c' % X\n"</span>, index, <span class="keyword">rune</span>, <span class="keyword">rune</span>, <span class="keyword">rune</span>, []<span class="keyword">byte</span>(<span class="keyword">string</span>(<span class="keyword">rune</span>)))</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="break与continue"><a href="#break与continue" class="headerlink" title="break与continue"></a>break与continue</h2><ul>
<li>break关键字可以退出for循环</li>
<li>break只会退出一层</li>
<li>continue会忽略剩余的循环体跳入下一次循环</li>
</ul>
<h2 id="标签与goto"><a href="#标签与goto" class="headerlink" title="标签与goto"></a>标签与goto</h2><ul>
<li>标签作用于外部循环</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line"></div><div class="line">LABEL1:</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++ &#123;</div><div class="line">		<span class="keyword">for</span> j := <span class="number">0</span>; j &lt;= <span class="number">5</span>; j++ &#123;</div><div class="line">			<span class="keyword">if</span> j == <span class="number">4</span> &#123;</div><div class="line">				<span class="keyword">continue</span> LABEL1</div><div class="line">			&#125;</div><div class="line">			fmt.Printf(<span class="string">"i is: %d, and j is: %d\n"</span>, i, j)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>goto和标签可以来模仿循环</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	i:=<span class="number">0</span></div><div class="line">	HERE:</div><div class="line">		<span class="built_in">print</span>(i)</div><div class="line">		i++</div><div class="line">		<span class="keyword">if</span> i==<span class="number">5</span> &#123;</div><div class="line">			<span class="keyword">return</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">goto</span> HERE</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第六章-函数"><a href="#第六章-函数" class="headerlink" title="第六章 函数"></a>第六章 函数</h1><h2 id="6-1-简介"><a href="#6-1-简介" class="headerlink" title="6.1 简介"></a>6.1 简介</h2><ul>
<li>函数是基本的代码块</li>
<li>main写在文件的前面</li>
<li>函数主要是为了代码重用</li>
<li>最后一行或者return退出函数</li>
<li>go中包含三种函数<ul>
<li>普通带有名字的函数</li>
<li>匿名函数或者lambda函数</li>
<li>方法</li>
</ul>
</li>
<li>出了main，init函数之外，其他所有函数都可以有参数和返回值</li>
<li>参数，返回值，及其类型称为函数签名-和其他语言一致</li>
<li>函数可以将其他函数作为它的参数，类型相符合就可以</li>
<li>go语言不允许函数重载</li>
<li>函数是一等公民</li>
<li>函数可以相互比较，引用相同就相等</li>
<li>go语言不支持泛型</li>
</ul>
<h2 id="6-2-函数参数与返回值"><a href="#6-2-函数参数与返回值" class="headerlink" title="6.2 函数参数与返回值"></a>6.2 函数参数与返回值</h2><ul>
<li>函数可以接收参数供自己使用，也可以返回零个或者多个值</li>
<li>go语言默认值传递</li>
<li>go语言通过指针来实现引用传递，实际上指针也是变量类型，有自己的地址和值，只是指针的值指向一个变量的地址，按引用传递可以理解为按值传递，传递的值就是指针的值。</li>
<li>slice，map,interface,channel默认引用传递</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"Multiply 2 * 5 * 6 = %d\n"</span>, MultiPly3Nums(<span class="number">2</span>, <span class="number">5</span>, <span class="number">6</span>))</div><div class="line">    <span class="comment">// var i1 int = MultiPly3Nums(2, 5, 6)</span></div><div class="line">    <span class="comment">// fmt.Printf("MultiPly 2 * 5 * 6 = %d\n", i1)</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MultiPly3Nums</span><span class="params">(a <span class="keyword">int</span>, b <span class="keyword">int</span>, c <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">    <span class="comment">// var product int = a * b * c</span></div><div class="line">    <span class="comment">// return product</span></div><div class="line">    <span class="keyword">return</span> a * b * c</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="命名的返回值"><a href="#命名的返回值" class="headerlink" title="命名的返回值"></a>命名的返回值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> num <span class="keyword">int</span> = <span class="number">10</span></div><div class="line"><span class="keyword">var</span> numx2, numx3 <span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    numx2, numx3 = getX2AndX3(num)</div><div class="line">    PrintValues()</div><div class="line">    numx2, numx3 = getX2AndX3_2(num)</div><div class="line">    PrintValues()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">PrintValues</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"num = %d, 2x num = %d, 3x num = %d\n"</span>, num, numx2, numx3)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getX2AndX3</span><span class="params">(input <span class="keyword">int</span>)</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">2</span> * input, <span class="number">3</span> * input</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">getX2AndX3_2</span><span class="params">(input <span class="keyword">int</span>)</span> <span class="params">(x2 <span class="keyword">int</span>, x3 <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    x2 = <span class="number">2</span> * input</div><div class="line">    x3 = <span class="number">3</span> * input</div><div class="line">    <span class="comment">// return x2, x3</span></div><div class="line">    <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>尽量使用命名返回值：会使得代码清晰，更简短，可读性更好。</li>
</ul>
<h3 id="空白符"><a href="#空白符" class="headerlink" title="空白符"></a>空白符</h3><ul>
<li>空白符用来丢弃一些不需要的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> i1 <span class="keyword">int</span></div><div class="line">    <span class="keyword">var</span> f1 <span class="keyword">float32</span></div><div class="line">    i1, _, f1 = ThreeValues()</div><div class="line">    fmt.Printf(<span class="string">"The int: %d, the float: %f \n"</span>, i1, f1)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ThreeValues</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">float32</span>)</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">5</span>, <span class="number">6</span>, <span class="number">7.5</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="改变外部变量"><a href="#改变外部变量" class="headerlink" title="改变外部变量"></a>改变外部变量</h3><ul>
<li>指针传递不仅可以节省内存，而且赋予函数改变外部变量的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// this function changes reply:</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Multiply</span><span class="params">(a, b <span class="keyword">int</span>, reply *<span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    *reply = a * b</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    n := <span class="number">0</span></div><div class="line">    reply := &amp;n</div><div class="line">    Multiply(<span class="number">10</span>, <span class="number">5</span>, reply)</div><div class="line">    fmt.Println(<span class="string">"Multiply:"</span>, *reply) <span class="comment">// Multiply: 50</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-3-传递变长参数"><a href="#6-3-传递变长参数" class="headerlink" title="6.3 传递变长参数"></a>6.3 传递变长参数</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	x := min(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">0</span>)</div><div class="line">	fmt.Printf(<span class="string">"The minimum is: %d\n"</span>, x)</div><div class="line">	slice := []<span class="keyword">int</span>&#123;<span class="number">7</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">1</span>&#125;</div><div class="line">	x = min(slice...)</div><div class="line">	fmt.Printf(<span class="string">"The minimum in the slice is: %d"</span>, x)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">min</span><span class="params">(s ...<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(s)==<span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">0</span></div><div class="line">	&#125;</div><div class="line">	min := s[<span class="number">0</span>]</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> v &lt; min &#123;</div><div class="line">			min = v</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> min</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-4-defer和追踪"><a href="#6-4-defer和追踪" class="headerlink" title="6.4 defer和追踪"></a>6.4 defer和追踪</h2><ul>
<li>defer语句在函数结束之前才开始执行，适用于资源的释放等操作，类似于finally</li>
<li>defer的语句会按顺序接收参数，只是执行在最后</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</div><div class="line">	i := <span class="number">0</span></div><div class="line">	<span class="keyword">defer</span> fmt.Println(i)</div><div class="line">	i++</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125; <span class="comment">// print 0</span></div></pre></td></tr></table></figure>
<ul>
<li>多个defer语句，类似栈，先出现后执行</li>
<li>关闭文件流，解锁，打印最终报告，关闭数据库连接</li>
<li>defer可以实现代码追踪，在进入和离开函数时打印日志</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">trace</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"entering:"</span>, s)</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">un</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	fmt.Println(<span class="string">"leaving:"</span>, s)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> un(trace(<span class="string">"a"</span>))</div><div class="line">	fmt.Println(<span class="string">"in a"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">defer</span> un(trace(<span class="string">"b"</span>))</div><div class="line">	fmt.Println(<span class="string">"in b"</span>)</div><div class="line">	a()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	b()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-5-内置函数"><a href="#6-5-内置函数" class="headerlink" title="6.5 内置函数"></a>6.5 内置函数</h2><table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">close</td>
<td style="text-align:center">用于管道通信</td>
</tr>
<tr>
<td style="text-align:center">len</td>
<td style="text-align:center">返回某个类型的长度或数量，如字符串，数组，切片，map和管道</td>
</tr>
<tr>
<td style="text-align:center">cap</td>
<td style="text-align:center">返回某个类型的最大容量，如切片，map</td>
</tr>
<tr>
<td style="text-align:center">new</td>
<td style="text-align:center">用于值类型和用户定义的类型的创建</td>
</tr>
<tr>
<td style="text-align:center">make</td>
<td style="text-align:center">用于内置类型的创建</td>
</tr>
<tr>
<td style="text-align:center">copy，append</td>
<td style="text-align:center">用于复制和连接切片</td>
</tr>
<tr>
<td style="text-align:center">panic，recover</td>
<td style="text-align:center">错误处理机制</td>
</tr>
<tr>
<td style="text-align:center">print, println</td>
<td style="text-align:center">底层打印函数</td>
</tr>
<tr>
<td style="text-align:center">complex， real imag</td>
<td style="text-align:center">复数操作</td>
</tr>
</tbody>
</table>
<h2 id="6-6-递归函数"><a href="#6-6-递归函数" class="headerlink" title="6.6 递归函数"></a>6.6 递归函数</h2><ul>
<li>自身调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fib</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(res <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">1</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> fib(n - <span class="number">1</span>) + fib(n - <span class="number">2</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>递归的一个问题在于栈溢出</li>
<li>go语言中可以使用相互调用的递归函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"%d is even: is %t\n"</span>, <span class="number">16</span>, even(<span class="number">16</span>)) <span class="comment">// 16 is even: is true</span></div><div class="line">	fmt.Printf(<span class="string">"%d is odd: is %t\n"</span>, <span class="number">17</span>, odd(<span class="number">17</span>))</div><div class="line">	<span class="comment">// 17 is odd: is true</span></div><div class="line">	fmt.Printf(<span class="string">"%d is odd: is %t\n"</span>, <span class="number">18</span>, odd(<span class="number">18</span>))</div><div class="line">	<span class="comment">// 18 is odd: is false</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">even</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">true</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> odd(RevSign(nr) - <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">odd</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">false</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> even(RevSign(nr) - <span class="number">1</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">RevSign</span><span class="params">(nr <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> nr &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> -nr</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> nr</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="6-7-将函数作为参数"><a href="#6-7-将函数作为参数" class="headerlink" title="6.7 将函数作为参数"></a>6.7 将函数作为参数</h2><ul>
<li>go语言中函数可以作为其他函数的参数进行传递，然后在其他函数内调用执行，称为回调函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	callback(<span class="number">1</span>, Add)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add</span><span class="params">(a, b <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">	fmt.Printf(<span class="string">"The sum of %d and %d is: %d\n"</span>, a, b, a+b)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">callback</span><span class="params">(y <span class="keyword">int</span>, f <span class="keyword">func</span>(<span class="keyword">int</span>, <span class="keyword">int</span>)</span>)</span> &#123;</div><div class="line">	f(y, <span class="number">2</span>) <span class="comment">// this becomes Add(1, 2)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">indexFunc</span><span class="params">(s <span class="keyword">string</span>, f <span class="keyword">func</span>(<span class="keyword">rune</span>)</span> <span class="title">bool</span>, <span class="title">truth</span> <span class="title">bool</span>) <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, r := <span class="keyword">range</span> s &#123;</div><div class="line">		<span class="keyword">if</span> f(r) == truth &#123;</div><div class="line">			<span class="keyword">return</span> i</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">-1</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="6-8-闭包"><a href="#6-8-闭包" class="headerlink" title="6.8 闭包"></a>6.8 闭包</h3><ul>
<li>不给函数起名，而是将函数指针赋值给某个变量，通过这个变量来实现函数的调用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		sum := <span class="number">0</span></div><div class="line">		<span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">1e6</span>; i++ &#123;</div><div class="line">			sum += i</div><div class="line">		&#125;</div><div class="line">		<span class="built_in">print</span>(sum)</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">	f()</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">4</span>; i++ &#123;</div><div class="line">		g := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123; fmt.Printf(<span class="string">"%d "</span>, i) &#125; <span class="comment">//此例子中只是为了演示匿名函数可分配不同的内存地址，在现实开发中，不应该把该部分信息放置到循环中。</span></div><div class="line">		g(i)</div><div class="line">		fmt.Printf(<span class="string">" - g is of type %T and has value %v\n"</span>, g, g)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>匿名函数可以被赋值给变量作为值来使用</li>
<li>defer关键字和匿名函数配合使用来改变函数的命名返回值</li>
<li>匿名函数被称为闭包，被允许调用定义在其他环境的变量。</li>
<li>一个函数闭包继承了函数所声明时的作用域</li>
</ul>
<h2 id="闭包应用-将函数作为返回值"><a href="#闭包应用-将函数作为返回值" class="headerlink" title="闭包应用-将函数作为返回值"></a>闭包应用-将函数作为返回值</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// make an Add2 function, give it a name p2, and call it:</span></div><div class="line">	p2 := Add2()</div><div class="line">	fmt.Printf(<span class="string">"Call Add2 for 3 gives: %v\n"</span>, p2(<span class="number">3</span>))</div><div class="line">	<span class="comment">// make a special Adder function, a gets value 2:</span></div><div class="line">	TwoAdder := Adder(<span class="number">2</span>)</div><div class="line">	fmt.Printf(<span class="string">"The result is: %v\n"</span>, TwoAdder(<span class="number">3</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Add2</span><span class="params">()</span> <span class="title">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> b + <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Adder</span><span class="params">(a <span class="keyword">int</span>)</span> <span class="title">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(b <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		<span class="keyword">return</span> a + b</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> f = Adder()</div><div class="line">	fmt.Print(f(<span class="number">1</span>), <span class="string">" - "</span>)</div><div class="line">	fmt.Print(f(<span class="number">20</span>), <span class="string">" - "</span>)</div><div class="line">	fmt.Print(f(<span class="number">300</span>))</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Adder</span><span class="params">()</span> <span class="title">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> x <span class="keyword">int</span></div><div class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(delta <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">		x += delta</div><div class="line">		<span class="keyword">return</span> x</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>x中的值是可以被保存的</li>
<li>在闭包中使用到的变量可以在函数体内声明，也可以在函数体外声明</li>
</ul>
<h2 id="使用闭包调试"><a href="#使用闭包调试" class="headerlink" title="使用闭包调试"></a>使用闭包调试</h2><ul>
<li>runtime中的函数Caller提供了文件和行数的信息，可以用闭包来实现调试定位</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">where := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">	_, file, line, _ := runtime.Caller(<span class="number">1</span>)</div><div class="line">	log.Printf(<span class="string">"%s:%d"</span>, file, line)</div><div class="line">&#125;</div><div class="line">where()</div><div class="line"><span class="comment">// some code</span></div><div class="line">where()</div><div class="line"><span class="comment">// some more code</span></div><div class="line">where()</div></pre></td></tr></table></figure>
<h2 id="计算函数执行时间"><a href="#计算函数执行时间" class="headerlink" title="计算函数执行时间"></a>计算函数执行时间</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">start := time.Now()</div><div class="line">longCalculation()</div><div class="line">end := time.Now()</div><div class="line">delta := end.Sub(start)</div><div class="line">fmt.Printf(<span class="string">"longCalculation took this amount of time: %s\n"</span>, delta)</div></pre></td></tr></table></figure>
<h2 id="通过内存缓存来提升性能"><a href="#通过内存缓存来提升性能" class="headerlink" title="通过内存缓存来提升性能"></a>通过内存缓存来提升性能</h2><ul>
<li>内存缓存来避免重复计算，如斐波那契，空间换时间</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">	<span class="string">"time"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">const</span> LIM = <span class="number">41</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> fibs [LIM]<span class="keyword">uint64</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> result <span class="keyword">uint64</span> = <span class="number">0</span></div><div class="line">	start := time.Now()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; LIM; i++ &#123;</div><div class="line">		result = fibonacci(i)</div><div class="line">		fmt.Printf(<span class="string">"fibonacci(%d) is: %d\n"</span>, i, result)</div><div class="line">	&#125;</div><div class="line">	end := time.Now()</div><div class="line">	delta := end.Sub(start)</div><div class="line">	fmt.Printf(<span class="string">"longCalculation took this amount of time: %s\n"</span>, delta)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fibonacci</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="params">(res <span class="keyword">uint64</span>)</span></span> &#123;</div><div class="line">	<span class="comment">// memoization: check if fibonacci(n) is already known in array:</span></div><div class="line">	<span class="keyword">if</span> fibs[n] != <span class="number">0</span> &#123;</div><div class="line">		res = fibs[n]</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> n &lt;= <span class="number">1</span> &#123;</div><div class="line">		res = <span class="number">1</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		res = fibonacci(n<span class="number">-1</span>) + fibonacci(n<span class="number">-2</span>)</div><div class="line">	&#125;</div><div class="line">	fibs[n] = res</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="第七章-数组和切片"><a href="#第七章-数组和切片" class="headerlink" title="第七章 数组和切片"></a>第七章 数组和切片</h1><h2 id="声明和初始化"><a href="#声明和初始化" class="headerlink" title="声明和初始化"></a>声明和初始化</h2><ul>
<li>数组长度是数组类型的一种</li>
<li>数组长度最大为2Gb</li>
<li>数组声明 <code>var identifier [len]type</code></li>
<li>数组声明之后所有元素会默认为零值</li>
<li>数组遍历用for循环，range更好</li>
<li>数组可以用new来创建，创建之后返回的是数组的地址，而不是数组的值</li>
</ul>
<h2 id="数组常量"><a href="#数组常量" class="headerlink" title="数组常量"></a>数组常量</h2><ul>
<li><code>var arr = [5]{18, 10, 12, 19, 23}</code></li>
<li><code>var arr = [...]{18, 10, 12, 19, 23}</code></li>
<li><code>var arr = [5]string{3: &quot;aa&quot;, 4: &quot;bb&quot;}</code>  - {“”. “”, “”, aa, bb}</li>
</ul>
<h2 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">const</span> (</div><div class="line">	WIDTH  = <span class="number">1920</span></div><div class="line">	HEIGHT = <span class="number">1080</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> pixel <span class="keyword">int</span></div><div class="line"><span class="keyword">var</span> screen [WIDTH][HEIGHT]pixel</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> y := <span class="number">0</span>; y &lt; HEIGHT; y++ &#123;</div><div class="line">		<span class="keyword">for</span> x := <span class="number">0</span>; x &lt; WIDTH; x++ &#123;</div><div class="line">			screen[x][y] = <span class="number">0</span></div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="将数组传递给函数"><a href="#将数组传递给函数" class="headerlink" title="将数组传递给函数"></a>将数组传递给函数</h2><ul>
<li>为了降低内存的消耗，传递数组指针或者切片</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	array := [<span class="number">3</span>]<span class="keyword">float64</span>&#123;<span class="number">7.0</span>, <span class="number">8.5</span>, <span class="number">9.1</span>&#125;</div><div class="line">	x := Sum(&amp;array) <span class="comment">// Note the explicit address-of operator</span></div><div class="line">	<span class="comment">// to pass a pointer to the array</span></div><div class="line">	fmt.Printf(<span class="string">"The sum of the array is: %f"</span>, x)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sum</span><span class="params">(a *[3]<span class="keyword">float64</span>)</span> <span class="params">(sum <span class="keyword">float64</span>)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> _, v := <span class="keyword">range</span> a &#123; <span class="comment">// derefencing *a to get back to the array is not necessary!</span></div><div class="line">		sum += v</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-2-切片"><a href="#7-2-切片" class="headerlink" title="7.2 切片"></a>7.2 切片</h2><ul>
<li>切片是对数组一个连续片段的引用</li>
<li>切片可以索引，可以len</li>
<li>切片是一个长度可变的数组</li>
<li>cap函数来计算切片的最大容量 0 &lt;= len(s) &lt;= cap(s)</li>
<li>切片是引用，不耗内存，效率更高</li>
<li>声明格式 <code>var identifier []type</code></li>
<li>切片在未初始化之前是nil，长度为0</li>
<li>切片的初始化格式是：<code>var slice1 []type = arr1[start:end]</code> 前闭后开</li>
<li>切片可以扩展到其上限</li>
<li>切片初始化：<code>var x = []int{2, 3, 4, 7, 11}</code></li>
<li>切片只能向后移</li>
<li>不要用指针指向切片，因为切片本身就是一个指针</li>
</ul>
<h3 id="将切片传递给函数"><a href="#将切片传递给函数" class="headerlink" title="将切片传递给函数"></a>将切片传递给函数</h3><ul>
<li>与传递数组相比，节省内存开销，同时函数具备了改变外部变量的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(a []<span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</div><div class="line">	s := <span class="number">0</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a); i++ &#123;</div><div class="line">		s += a[i]</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> arr = [<span class="number">5</span>]<span class="keyword">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</div><div class="line">	sum(arr[:])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="make创建切片"><a href="#make创建切片" class="headerlink" title="make创建切片"></a>make创建切片</h3><ul>
<li><code>var slice []type = make(type[], len)</code>，在创建切片的同时创建好相关数组</li>
<li>make需要两个参数，元素类型和元素个数</li>
</ul>
<h3 id="make和new的区别"><a href="#make和new的区别" class="headerlink" title="make和new的区别"></a>make和new的区别</h3><ul>
<li>new为每个新的类型T分配一片内存，初始化零值并返回类型为*T的内存地址，适用于数组和结构体</li>
<li>make返回一个类型为T的初始值，适合创建slice，map和channel</li>
<li>new分配内存，make函数初始化</li>
</ul>
<h3 id="bytes包"><a href="#bytes包" class="headerlink" title="bytes包"></a>bytes包</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> buffer bytes.Buffer</div><div class="line"><span class="keyword">for</span> &#123;</div><div class="line">	<span class="keyword">if</span> s, ok := getNextString(); ok &#123; <span class="comment">//method getNextString() not shown here</span></div><div class="line">		buffer.WriteString(s)</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">break</span></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">fmt.Print(buffer.String(), <span class="string">"\n"</span>)</div></pre></td></tr></table></figure>
<ul>
<li>字符串串联效率更高</li>
</ul>
<h2 id="7-3-for-range结构"><a href="#7-3-for-range结构" class="headerlink" title="7.3 for-range结构"></a>7.3 for-range结构</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> idx, value := <span class="keyword">range</span> slice &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>idx是数组或者切片的索引</li>
<li>value是索引对应的值</li>
<li><p>_忽略不需要的idx或者value</p>
</li>
<li><p>多维切片下的for-range</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> row := <span class="keyword">range</span> screen &#123;</div><div class="line">	<span class="keyword">for</span> column := <span class="keyword">range</span> screen[row] &#123;</div><div class="line">		screen[row][column] = <span class="number">1</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-4-切片重组"><a href="#7-4-切片重组" class="headerlink" title="7.4 切片重组"></a>7.4 切片重组</h2><p><code>slice1 := make([]type, start_length, capacity)</code></p>
<ul>
<li>切片可以反复扩展直到占据整个数组</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	slice1 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">10</span>)</div><div class="line">	<span class="comment">// load the slice, cap(slice1) is 10:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">cap</span>(slice1); i++ &#123;</div><div class="line">		slice1 = slice1[<span class="number">0</span>:i+<span class="number">1</span>]</div><div class="line">		slice1[i] = i</div><div class="line">		fmt.Printf(<span class="string">"The length of slice is %d\n"</span>, <span class="built_in">len</span>(slice1))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// print the slice:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(slice1); i++ &#123;</div><div class="line">		fmt.Printf(<span class="string">"Slice at %d is %d\n"</span>, i, slice1[i])</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="7-5-切片的复制与追加"><a href="#7-5-切片的复制与追加" class="headerlink" title="7.5 切片的复制与追加"></a>7.5 切片的复制与追加</h2><ul>
<li>先创建再拷贝</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	sl_from := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">	sl_to := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">10</span>)</div><div class="line"></div><div class="line">	n := <span class="built_in">copy</span>(sl_to, sl_from)</div><div class="line">	fmt.Println(sl_to)</div><div class="line">	fmt.Printf(<span class="string">"Copied %d elements\n"</span>, n) <span class="comment">// n == 3</span></div><div class="line"></div><div class="line">	sl3 := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</div><div class="line">	sl3 = <span class="built_in">append</span>(sl3, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</div><div class="line">	fmt.Println(sl3)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>append方法追加切片并返回新的切片</li>
</ul>
<h2 id="7-6-字符串、数组和切片的应用"><a href="#7-6-字符串、数组和切片的应用" class="headerlink" title="7.6 字符串、数组和切片的应用"></a>7.6 字符串、数组和切片的应用</h2><ul>
<li><p>字符串生成切片 - <code>c := []byte(s)</code></p>
</li>
<li><p>获取字符串的某一部分 - substr := str[start:end]</p>
</li>
<li><p>字符串和切片的内存结构，字符串是一个双字结构，地址指针和长度值</p>
</li>
<li><p>go语言中字符串是不可变的，但是可以通过切片操作来改变字符串</p>
</li>
<li><p>append函数常见操作</p>
<ul>
<li>切片追加 - <code>a = append(a, b...)</code></li>
<li>切片复制 - <code>b = make([]Tm len(a))  copy(b, a)</code></li>
<li>删除索引i的元素 - <code>a = append(a[:i], a [i+1:])</code></li>
<li>切除切片 a 中从索引 i 至 j 位置的元素 - <code>a = append(a[:i], a[j:]...)</code></li>
<li>为切片 a 扩展 j 个元素长度 - <code>a = append(a, make([]T, j)...)</code></li>
<li>在索引 i 的位置插入元素 x - <code>a = append(a[:i], append([]T{x}, a[i:]...)...)</code></li>
<li>在索引 i 的位置插入长度为 j 的新切片 - <code>a = append(a[:i], append(make([]T, j), a[i:]...)...)</code></li>
<li>在索引 i 的位置插入切片 b 的所有元素 - <code>a = append(a[:i], append(b, a[i:]...)...)</code></li>
<li>取出位于切片 a 最末尾的元素 x - <code>x, a = a[len(a)-1], a[:len(a)-1]</code></li>
<li>将元素 x 追加到切片 a - <code>a = append(a, x)</code></li>
</ul>
</li>
<li><p>底层数组没有切片引用的时候会被回收</p>
</li>
</ul>
<h1 id="第八章-Map"><a href="#第八章-Map" class="headerlink" title="第八章 Map"></a>第八章 Map</h1><h2 id="8-1-声明和初始化"><a href="#8-1-声明和初始化" class="headerlink" title="8.1 声明和初始化"></a>8.1 声明和初始化</h2><h3 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h3><ul>
<li><code>var map1 map[keyType]valueType</code></li>
<li><code>var map1 map[string]int</code></li>
<li>map可以动态增长</li>
<li>未初始化的map是nil</li>
<li>key可以是string，int，float</li>
<li>value可以是任意类型的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">var</span> mapLit <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line">	<span class="comment">//var mapCreated map[string]float32</span></div><div class="line">	<span class="keyword">var</span> mapAssigned <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span></div><div class="line"></div><div class="line">	mapLit = <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int</span>&#123;<span class="string">"one"</span>: <span class="number">1</span>, <span class="string">"two"</span>: <span class="number">2</span>&#125;</div><div class="line">	mapCreated := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">float32</span>)</div><div class="line">	mapAssigned = mapLit</div><div class="line"></div><div class="line">	mapCreated[<span class="string">"key1"</span>] = <span class="number">4.5</span></div><div class="line">	mapCreated[<span class="string">"key2"</span>] = <span class="number">3.14159</span></div><div class="line">	mapAssigned[<span class="string">"two"</span>] = <span class="number">3</span></div><div class="line"></div><div class="line">	fmt.Printf(<span class="string">"Map literal at \"one\" is: %d\n"</span>, mapLit[<span class="string">"one"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map created at \"key2\" is: %f\n"</span>, mapCreated[<span class="string">"key2"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map assigned at \"two\" is: %d\n"</span>, mapLit[<span class="string">"two"</span>])</div><div class="line">	fmt.Printf(<span class="string">"Map literal at \"ten\" is: %d\n"</span>, mapLit[<span class="string">"ten"</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>map是引用类型，内存用make方法来分配，不要用new</li>
<li><p>map的初始化 - <code>map := make(map[string]float32)</code></p>
</li>
<li><p>map容量 - cap会自动+1扩张</p>
</li>
</ul>
<h2 id="测试键值对是否存在及删除元素"><a href="#测试键值对是否存在及删除元素" class="headerlink" title="测试键值对是否存在及删除元素"></a>测试键值对是否存在及删除元素</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> _, ok := <span class="keyword">map</span>[key1]; ok &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p><code>delete(map1, key1)</code></p>
</li>
<li><p><code>for key, value := range map1 {}</code></p>
</li>
</ul>
<h2 id="map类型的切片"><a href="#map类型的切片" class="headerlink" title="map类型的切片"></a>map类型的切片</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// Version A:</span></div><div class="line">	items := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">5</span>)</div><div class="line">	<span class="keyword">for</span> i:= <span class="keyword">range</span> items &#123;</div><div class="line">		items[i] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">1</span>)</div><div class="line">		items[i][<span class="number">1</span>] = <span class="number">2</span></div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Version A: Value of items: %v\n"</span>, items)</div><div class="line"></div><div class="line">	<span class="comment">// Version B: NOT GOOD!</span></div><div class="line">	items2 := <span class="built_in">make</span>([]<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">5</span>)</div><div class="line">	<span class="keyword">for</span> _, item := <span class="keyword">range</span> items2 &#123;</div><div class="line">		item = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">int</span>, <span class="number">1</span>) <span class="comment">// item is only a copy of the slice element.</span></div><div class="line">		item[<span class="number">1</span>] = <span class="number">2</span> <span class="comment">// This 'item' will be lost on the next iteration.</span></div><div class="line">	&#125;</div><div class="line">	fmt.Printf(<span class="string">"Version B: Value of items: %v\n"</span>, items2)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="8-5-map排序"><a href="#8-5-map排序" class="headerlink" title="8.5 map排序"></a>8.5 map排序</h2><ul>
<li>将key或者value拷贝到切片</li>
<li>对切片排序</li>
<li>根据切片打印map</li>
</ul>
<h1 id="第九章-包-package"><a href="#第九章-包-package" class="headerlink" title="第九章 包 package"></a>第九章 包 package</h1><h2 id="9-1-标准库概述"><a href="#9-1-标准库概述" class="headerlink" title="9.1 标准库概述"></a>9.1 标准库概述</h2><ul>
<li>unsafe：C/C++中调用的类型不安全的包</li>
<li>syscall-os-os/exec：底层接口包</li>
<li>archive/tar,zip-compress：文件压缩解压缩</li>
<li>fmt：格式化输入输出</li>
<li>io：基本输入输出</li>
<li>bufio：缓冲输入输出</li>
<li>path/filepath：操作在当前系统中的目标文件名路径</li>
<li>flag：对命令行参数的操作</li>
<li>strings：字符串操作</li>
<li>strconv：字符串类型转换</li>
<li>unicode：Unicode类型字符串功能</li>
<li>regexp：正则</li>
<li>bytes：字符型分片操作</li>
<li>index/suffixarray：子字符串快速查询</li>
<li>math：基本数学函数</li>
<li>math/cmath：对复数的操作</li>
<li>math/rand：随机数</li>
<li>sort：排序</li>
<li>math/big：大数</li>
<li>container-list-ring-heap：集合操作</li>
<li>list：双链表</li>
<li>ring：环形链表</li>
<li>time：日期和时间的基本操作</li>
<li>log：记录程序运行时产生的日志</li>
<li>encoding/json：读取并解码和写入并编码json数据</li>
<li>encoding/xml：xml解析器</li>
<li>text/template：数据驱动模板</li>
<li>net：网络的基本操作</li>
<li>http：可扩展的http服务器和基础客户端</li>
<li>html：html5解析器</li>
<li>runtime：go程序运行时的交互操作</li>
<li>reflect：反射</li>
</ul>
<h2 id="9-2-regexp包"><a href="#9-2-regexp包" class="headerlink" title="9.2 regexp包"></a>9.2 regexp包</h2><ul>
<li>简单模式使用Match方法</li>
</ul>
<p><code>ok, _ := regexp.Match(pattern, []byte(searchIn))</code><br><code>ok, _ := regexp.MatchString(pattern, searchIn)</code></p>
<ul>
<li>通过Compile方法返回Regrep对象进行匹配</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//目标字符串</span></div><div class="line">searchIn := <span class="string">"John: 2578.34 William: 4567.23 Steve: 5632.18"</span></div><div class="line">pat := <span class="string">"[0-9]+.[0-9]+"</span> <span class="comment">//正则</span></div><div class="line"></div><div class="line">f := <span class="function"><span class="keyword">func</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span>&#123;</div><div class="line">   	v, _ := strconv.ParseFloat(s, <span class="number">32</span>)</div><div class="line">   	<span class="keyword">return</span> strconv.FormatFloat(v * <span class="number">2</span>, <span class="string">'f'</span>, <span class="number">2</span>, <span class="number">32</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> ok, _ := regexp.Match(pat, []<span class="keyword">byte</span>(searchIn)); ok &#123;</div><div class="line">   fmt.Println(<span class="string">"Match Found!"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line">re, _ := regexp.Compile(pat)</div><div class="line"><span class="comment">//将匹配到的部分替换为"##.#"</span></div><div class="line">str := re.ReplaceAllString(searchIn, <span class="string">"##.#"</span>)</div><div class="line">fmt.Println(str)</div><div class="line"><span class="comment">//参数为函数时</span></div><div class="line">str2 := re.ReplaceAllStringFunc(searchIn, f)</div><div class="line">fmt.Println(str2)</div></pre></td></tr></table></figure>
<h2 id="9-3-锁和sync包"><a href="#9-3-锁和sync包" class="headerlink" title="9.3 锁和sync包"></a>9.3 锁和sync包</h2><ul>
<li>sync.Mutex是一个互斥锁，保证临界区同一个时间只有一个线程进入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span>  <span class="string">"sync"</span></div><div class="line"></div><div class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</div><div class="line">	mu sync.Mutex</div><div class="line">	<span class="comment">// ... other fields, e.g.: Str string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Update</span><span class="params">(info *Info)</span></span> &#123;</div><div class="line">	info.mu.Lock()</div><div class="line">    <span class="comment">// critical section:</span></div><div class="line">    info.Str = <span class="comment">// new value</span></div><div class="line">    <span class="comment">// end critical section</span></div><div class="line">    info.mu.Unlock()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>RWMutex锁：可以通过RLock方法来允许同一时间多个线程读取变量，一个线程写变量</li>
</ul>
<h2 id="精密计算和big包"><a href="#精密计算和big包" class="headerlink" title="精密计算和big包"></a>精密计算和big包</h2><ul>
<li>整数的高精度计算提供了big包</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Here are some calculations with bigInts:</span></div><div class="line">im := big.NewInt(math.MaxInt64)</div><div class="line">in := im</div><div class="line">io := big.NewInt(<span class="number">1956</span>)</div><div class="line">ip := big.NewInt(<span class="number">1</span>)</div><div class="line">ip.Mul(im, in).Add(ip, im).Div(ip, io)</div><div class="line">fmt.Printf(<span class="string">"Big Int: %v\n"</span>, ip)</div><div class="line"><span class="comment">// Here are some calculations with bigInts:</span></div><div class="line">rm := big.NewRat(math.MaxInt64, <span class="number">1956</span>)</div><div class="line">rn := big.NewRat(<span class="number">-1956</span>, math.MaxInt64)</div><div class="line">ro := big.NewRat(<span class="number">19</span>, <span class="number">56</span>)</div><div class="line">rp := big.NewRat(<span class="number">1111</span>, <span class="number">2222</span>)</div><div class="line">rq := big.NewRat(<span class="number">1</span>, <span class="number">1</span>)</div><div class="line">rq.Mul(rm, rn).Add(rq, ro).Mul(rq, rp)</div><div class="line">fmt.Printf(<span class="string">"Big Rat: %v\n"</span>, rq)</div></pre></td></tr></table></figure>
<h2 id="自定义包和可见性"><a href="#自定义包和可见性" class="headerlink" title="自定义包和可见性"></a>自定义包和可见性</h2><ul>
<li>import导入包，路径名或者URL地址</li>
<li>导入外部安装包：<code>go install codesite/..</code>,安装在GOROOT/src/目录下</li>
<li>程序的初始化在于导入包，初始化main包然后调用main函数</li>
<li>init函数不能被调用</li>
</ul>
<h2 id="godoc"><a href="#godoc" class="headerlink" title="godoc"></a>godoc</h2><ul>
<li>命令行执行 <code>godoc -http=:6060 -goroot=&quot;.&quot;</code>其中<code>.</code>是当前路径，会在127.0.0.1：6060中看到本地go的注释</li>
</ul>
<h2 id="go-install"><a href="#go-install" class="headerlink" title="go install"></a>go install</h2><ul>
<li>go install是go中自动包安装工具</li>
<li><code>go installl uc</code>会将uc.a包安装到pkg目录下</li>
<li>也可以用gomake来安装</li>
<li>go test测试</li>
</ul>
<h2 id="git打包和安装"><a href="#git打包和安装" class="headerlink" title="git打包和安装"></a>git打包和安装</h2><ul>
<li>安装到GitHub</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git init</div><div class="line">git add .</div><div class="line">git commit -m &quot;&quot;</div><div class="line">git remote add origin git@github.com:NNN/uc.git</div><div class="line">git push -u origin master</div></pre></td></tr></table></figure>
<ul>
<li>从GitHub安装 - <code>go get github.com/xxx/xx</code></li>
</ul>
<h2 id="外部库的使用"><a href="#外部库的使用" class="headerlink" title="外部库的使用"></a>外部库的使用</h2><ol>
<li>下载并安装外部库-go install</li>
<li>GOPATH是否有，包会被下载到<code>$GOPATH/PKG/&quot;machine_arch&quot;/</code></li>
</ol>
<h1 id="第十章-结构和方法"><a href="#第十章-结构和方法" class="headerlink" title="第十章 结构和方法"></a>第十章 结构和方法</h1><ul>
<li>go通过类型别名和结构体的形式支持用户自定义类型</li>
<li>结构体是复合类型，new来创建</li>
<li>数据称为字段fields</li>
</ul>
<h2 id="10-1-结构体定义"><a href="#10-1-结构体定义" class="headerlink" title="10.1 结构体定义"></a>10.1 结构体定义</h2><ul>
<li>结构体的定义方法：</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> identifier <span class="keyword">struct</span> &#123;</div><div class="line">    field1 type1</div><div class="line">    field2 type2</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span>&#123;a, b <span class="keyword">int</span>&#125;</div></pre></td></tr></table></figure>
<ul>
<li>数组可以看做使用下标的结构体</li>
<li>new函数给结构体分配内存，返回已分配内存的指针</li>
<li>var t T，此时t是T的一个实例/对象</li>
<li>结构体打印和%v效果一样</li>
<li>结构体变量和指针都可以通过<code>.</code>来选择字段值</li>
<li><code>p := Point{}</code>是实例，<code>p := &amp;Point{}是指针</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"><span class="keyword">import</span> (</div><div class="line">    <span class="string">"fmt"</span></div><div class="line">    <span class="string">"strings"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</div><div class="line">    firstName   <span class="keyword">string</span></div><div class="line">    lastName    <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">upPerson</span><span class="params">(p *Person)</span></span> &#123;</div><div class="line">    p.firstName = strings.ToUpper(p.firstName)</div><div class="line">    p.lastName = strings.ToUpper(p.lastName)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 1-struct as a value type:</span></div><div class="line">    <span class="keyword">var</span> pers1 Person</div><div class="line">    pers1.firstName = <span class="string">"Chris"</span></div><div class="line">    pers1.lastName = <span class="string">"Woodward"</span></div><div class="line">    upPerson(&amp;pers1)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers1.firstName, pers1.lastName)</div><div class="line"></div><div class="line">    <span class="comment">// 2—struct as a pointer:</span></div><div class="line">    pers2 := <span class="built_in">new</span>(Person)</div><div class="line">    pers2.firstName = <span class="string">"Chris"</span></div><div class="line">    pers2.lastName = <span class="string">"Woodward"</span></div><div class="line">    (*pers2).lastName = <span class="string">"Woodward"</span>  <span class="comment">// 这是合法的</span></div><div class="line">    upPerson(pers2)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers2.firstName, pers2.lastName)</div><div class="line"></div><div class="line">    <span class="comment">// 3—struct as a literal:</span></div><div class="line">    pers3 := &amp;Person&#123;<span class="string">"Chris"</span>,<span class="string">"Woodward"</span>&#125;</div><div class="line">    upPerson(pers3)</div><div class="line">    fmt.Printf(<span class="string">"The name of the person is %s %s\n"</span>, pers3.firstName, pers3.lastName)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>go的内存布局，结构体和其字段在内存中是连续存在的，性能更好，空间换时间</p>
</li>
<li><p>递归结构体，链表，树的实现</p>
</li>
<li><p>结构体可以和他别名进行类型转换</p>
</li>
</ul>
<h2 id="10-2-使用工厂方法创建结构体实例"><a href="#10-2-使用工厂方法创建结构体实例" class="headerlink" title="10.2 使用工厂方法创建结构体实例"></a>10.2 使用工厂方法创建结构体实例</h2><ul>
<li>工厂方法以new或者New开头</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> File <span class="keyword">struct</span> &#123;</div><div class="line">	fd <span class="keyword">int</span></div><div class="line">	name <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFile</span><span class="params">(fd <span class="keyword">int</span>, name <span class="keyword">string</span>)</span> *<span class="title">File</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> fd &lt; <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> &amp;File&#123;fd, name&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>推荐使用工厂方法来创建结构体，结构体字段就可以定义为私有的，OO思想</li>
</ul>
<h2 id="10-3-使用自定义包中的结构体"><a href="#10-3-使用自定义包中的结构体" class="headerlink" title="10.3 使用自定义包中的结构体"></a>10.3 使用自定义包中的结构体</h2><p>直接import就OK了</p>
<h2 id="10-4-带标签的结构体"><a href="#10-4-带标签的结构体" class="headerlink" title="10.4 带标签的结构体"></a>10.4 带标签的结构体</h2><ul>
<li>结构体中的字段出了名字和类型之外，还有一个可选的标签</li>
<li>标签是附属于字段的字符串，文档注释等操作</li>
<li>reflect可以取到tag</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> TagType <span class="keyword">struct</span> &#123; <span class="comment">// tags</span></div><div class="line">	field1 <span class="keyword">bool</span>   <span class="string">"An important answer"</span></div><div class="line">	field2 <span class="keyword">string</span> <span class="string">"The name of the thing"</span></div><div class="line">	field3 <span class="keyword">int</span>    <span class="string">"How much there are"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="10-5-匿名字段和内嵌结构体"><a href="#10-5-匿名字段和内嵌结构体" class="headerlink" title="10.5 匿名字段和内嵌结构体"></a>10.5 匿名字段和内嵌结构体</h2><ul>
<li>字段没有名字，只有类型</li>
<li>匿名字段可以是结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> innerS <span class="keyword">struct</span> &#123;</div><div class="line">	in1 <span class="keyword">int</span></div><div class="line">	in2 <span class="keyword">int</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> outerS <span class="keyword">struct</span> &#123;</div><div class="line">	b    <span class="keyword">int</span></div><div class="line">	c    <span class="keyword">float32</span></div><div class="line">	<span class="keyword">int</span>  <span class="comment">// anonymous field</span></div><div class="line">	innerS <span class="comment">//anonymous field</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li><p>实际上一个结构体对每一个类型最多有一个匿名字段，通过struct.type获取</p>
</li>
<li><p>内嵌结构体的概念类似于继承</p>
</li>
<li><p>内外的结构体命名冲突，外层的名字会覆盖内层的名字，同级别冲突报错</p>
</li>
</ul>
<h2 id="10-6-方法"><a href="#10-6-方法" class="headerlink" title="10.6 方法"></a>10.6 方法</h2><ul>
<li><p>go方法是作用在接收者上的一个函数，接收者是某个类型的变量</p>
</li>
<li><p>接收者可以是任何对象除了interface</p>
</li>
<li><p>go中类型的代码和绑定在它上面的方法的代码可以不放置在一起，只要是同一个包就可以</p>
</li>
<li><p>方法集</p>
</li>
<li><p>方法不允许重载</p>
</li>
<li><p>定义格式 <code>func (_ receiver_type) methodName(parameter_list) (return_value_list) { ... }</code></p>
</li>
<li><p>接收者可以理解为Java中的this</p>
</li>
</ul>
<h3 id="函数和方法的区别"><a href="#函数和方法的区别" class="headerlink" title="函数和方法的区别"></a>函数和方法的区别</h3><ul>
<li>函数将变量作为参数，方法在变量上被调用</li>
<li>接收者需要显示命名</li>
<li>receiver_type必须和方法同包</li>
<li>类型和方法之间的关联由接收者来建立</li>
<li>方法没有和结构体混合，表明数据和方法是独立的</li>
</ul>
<h3 id="指针或值作为接收者"><a href="#指针或值作为接收者" class="headerlink" title="指针或值作为接收者"></a>指针或值作为接收者</h3><ul>
<li><p>一般来说接收者都是类型的指针，效率更高</p>
</li>
<li><p>指针方法和值方法都可以在指针或非指针上被调用</p>
</li>
<li><p>未导出的结构体的对象通过setter\getter来修改和获取</p>
</li>
</ul>
<h3 id="内嵌类型的方法和继承"><a href="#内嵌类型的方法和继承" class="headerlink" title="内嵌类型的方法和继承"></a>内嵌类型的方法和继承</h3><ul>
<li>匿名类型被内嵌时，其可见方法也同样被内嵌，等价于外部结构继承了这些方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Engine <span class="keyword">interface</span> &#123;</div><div class="line">    Start()</div><div class="line">    Stop</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Car <span class="keyword">interface</span> <span class="keyword">struct</span> &#123;</div><div class="line">    Engine</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Car)</span> <span class="title">GoToWorkIn</span><span class="params">()</span></span> &#123;</div><div class="line">    c.Start()</div><div class="line">    c.Stop()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>方法可以被外层结构体覆盖</li>
</ul>
<h3 id="如何在类型中嵌入功能"><a href="#如何在类型中嵌入功能" class="headerlink" title="如何在类型中嵌入功能"></a>如何在类型中嵌入功能</h3><ul>
<li><p>两种方法</p>
<ul>
<li>聚合：包含一个所需要功能的具体字段</li>
<li>内嵌：内嵌需要的功能类型</li>
</ul>
</li>
<li><p>聚合</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</div><div class="line">    msg <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</div><div class="line">    Name <span class="keyword">string</span></div><div class="line">    log *Log</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">Add</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">    l.msg += <span class="string">"\n"</span> + s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> l.msg</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Customer)</span> <span class="title">Log</span><span class="params">()</span> *<span class="title">Log</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> c.log</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>内嵌</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Log <span class="keyword">struct</span> &#123;</div><div class="line">	msg <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Customer <span class="keyword">struct</span> &#123;</div><div class="line">	Name <span class="keyword">string</span></div><div class="line">	Log</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	c := &amp;Customer&#123;<span class="string">"Barak Obama"</span>, Log&#123;<span class="string">"1 - Yes we can!"</span>&#125;&#125;</div><div class="line">	c.Add(<span class="string">"2 - After me the world will be a better place!"</span>)</div><div class="line">	fmt.Println(c)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">Add</span><span class="params">(s <span class="keyword">string</span>)</span></span> &#123;</div><div class="line">	l.msg += <span class="string">"\n"</span> + s</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Log)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> l.msg</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Customer)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> c.Name + <span class="string">"\nLog:"</span> + fmt.Sprintln(c.Log)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>内嵌的类型不需要指针</li>
</ul>
<h3 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h3><ul>
<li>多重继承指的是一个类型获得多个父类型的能力</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Camera <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Camera)</span> <span class="title">TakeAPicture</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"click"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Phone <span class="keyword">struct</span>&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Phone)</span> <span class="title">Call</span> <span class="title">string</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"ring"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> CameraPhone <span class="keyword">struct</span> &#123;</div><div class="line">    Camera</div><div class="line">    Phone</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    cp := <span class="built_in">new</span>(CameraPhone)</div><div class="line">    fmt.Println(cp.TakeAPicture(), cp.Call())</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其他语言和GO的类型和方法的比较"><a href="#其他语言和GO的类型和方法的比较" class="headerlink" title="其他语言和GO的类型和方法的比较"></a>其他语言和GO的类型和方法的比较</h3><ul>
<li>go中，类型就是类，代码复用和多态更好</li>
<li>go中，代码通过组合和委托实现，多态通过接口的使用来实现</li>
</ul>
<h2 id="10-7-类型的String方法和格式化描述符"><a href="#10-7-类型的String方法和格式化描述符" class="headerlink" title="10.7 类型的String方法和格式化描述符"></a>10.7 类型的String方法和格式化描述符</h2><ul>
<li>定义了string()方法的类型，会被fmt.Println()中生成默认的输出，等同于%v产生的输出</li>
<li>注意不要在String方法里面调用涉及String()方法的方法，放置造成无限递归</li>
</ul>
<h2 id="10-8-垃圾回收和SetFinalizer"><a href="#10-8-垃圾回收和SetFinalizer" class="headerlink" title="10.8 垃圾回收和SetFinalizer"></a>10.8 垃圾回收和SetFinalizer</h2><ul>
<li>go语言有自己的垃圾回收器</li>
<li>通过runtime包访问GC进程，<code>runtime.GC()</code></li>
<li>SetFinalizer可以在对象被移除前进行一些操作<code>runtime.SetFinalizer(obj, func(obj *typeObj))</code></li>
</ul>
<h1 id="第11章-接口与反射"><a href="#第11章-接口与反射" class="headerlink" title="第11章 接口与反射"></a>第11章 接口与反射</h1><ul>
<li>接口定义了一组方法</li>
<li>go中的接口都很简短，0-3个方法</li>
<li>go语言中接口可以有值，为多字数据结构，值为nil</li>
<li>类型来实现接口找那个的方法</li>
<li>类型不需要显示声明它实现了哪个接口：接口被隐式的实现，多个类型可以实现同一个接口</li>
<li>实现某个接口的类型可以有其他的方法</li>
<li>一个类型可以实现多个接口</li>
<li>接口类型可以包含一个实例的引用，该实例的类型实现了此接口，接口是动态类型</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Shaper <span class="keyword">interface</span> &#123;</div><div class="line">	Area() <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Square <span class="keyword">struct</span> &#123;</div><div class="line">	side <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(sq *Square)</span> <span class="title">Area</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> sq.side * sq.side</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Rectangle <span class="keyword">struct</span> &#123;</div><div class="line">   length, width <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r Rectangle)</span> <span class="title">Area</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">   <span class="keyword">return</span> r.length * r.width</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">   r := Rectangle&#123;<span class="number">5</span>, <span class="number">3</span>&#125; <span class="comment">// Area() of Rectangle needs a value</span></div><div class="line">   q := &amp;Square&#123;<span class="number">5</span>&#125;      <span class="comment">// Area() of Square needs a pointer</span></div><div class="line">   shapes := []Shaper&#123;r, q&#125;</div><div class="line">   fmt.Println(<span class="string">"Looping through shapes for area ..."</span>)</div><div class="line">   <span class="keyword">for</span> n, _ := <span class="keyword">range</span> shapes &#123;</div><div class="line">       fmt.Println(<span class="string">"Shape details: "</span>, shapes[n])</div><div class="line">       fmt.Println(<span class="string">"Area of this shape is: "</span>, shapes[n].Area())</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接口的多态实例，父类引用持有子类变量。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> stockPosition <span class="keyword">struct</span> &#123;</div><div class="line">    ticker <span class="keyword">string</span></div><div class="line">    sharePrice <span class="keyword">float32</span></div><div class="line">    count <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s stockPosition)</span> <span class="title">getValue</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> s.sharePrice * s.count</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> car <span class="keyword">struct</span> &#123;</div><div class="line">    <span class="built_in">make</span> <span class="keyword">string</span></div><div class="line">    model <span class="keyword">string</span></div><div class="line">    price <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Car)</span> <span class="title">getValue</span><span class="params">()</span> <span class="title">float32</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> c.price</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> valuable <span class="keyword">interface</span> &#123;</div><div class="line">    getValue() <span class="keyword">float32</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">showValue</span><span class="params">(asset valuable)</span></span> &#123;</div><div class="line">    fmt.Printf(<span class="string">"Value of the asset is %f\n"</span>, assert.getValue())</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">var</span> o valuable = stockPosition&#123;<span class="string">"GOODS"</span>, <span class="number">577.012</span>, <span class="number">4</span>&#125;</div><div class="line">    showValue(o)</div><div class="line">    o = car&#123;<span class="string">"BMW"</span>, <span class="string">"M5"</span>, <span class="number">56565465</span>&#125;</div><div class="line">    showValue(o)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>标准库中的例子-Reader</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-2接口嵌套接口"><a href="#11-2接口嵌套接口" class="headerlink" title="11.2接口嵌套接口"></a>11.2接口嵌套接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> ReadWrite <span class="keyword">interface</span> &#123;</div><div class="line">    Read(b Buffer) <span class="keyword">bool</span></div><div class="line">    Write(b Buffer) <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Lock <span class="keyword">interface</span> &#123;</div><div class="line">    Lock()</div><div class="line">    Unlock()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> File <span class="keyword">interface</span> &#123;</div><div class="line">    ReadWrite</div><div class="line">    Lokck</div><div class="line">    Close()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-3-类型断言：如何检测和转换接口变量的类型"><a href="#11-3-类型断言：如何检测和转换接口变量的类型" class="headerlink" title="11.3 类型断言：如何检测和转换接口变量的类型"></a>11.3 类型断言：如何检测和转换接口变量的类型</h2><ul>
<li>一个接口类型的变量可以包含任何类型的值，类型断言来检测某个时刻该接口变量的值</li>
<li><code>v := varI.(T)</code> varI为接口变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> areaIntf Shaper</div><div class="line">sq1 := <span class="built_in">new</span>(Square)</div><div class="line">sq1.side = <span class="number">5</span></div><div class="line"></div><div class="line">areaIntf = sq1</div><div class="line"><span class="keyword">if</span> t, ok := areaIntf.(*Square); ok &#123;</div><div class="line">    fmt.Println()</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> u, ok := areaIntf.(*Circle); ok &#123;</div><div class="line">    fmt.....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-4-类型判断-type-switch"><a href="#11-4-类型判断-type-switch" class="headerlink" title="11.4 类型判断: type-switch"></a>11.4 类型判断: type-switch</h2><ul>
<li>不允许fallthrought关键字</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">classifier</span><span class="params">(items ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">for</span> i, x := <span class="keyword">range</span> items &#123;</div><div class="line">		<span class="keyword">switch</span> x.(<span class="keyword">type</span>) &#123;</div><div class="line">		<span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a bool\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">float64</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a float64\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">int</span>, <span class="keyword">int64</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a int\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="literal">nil</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a nil\n"</span>, i)</div><div class="line">		<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is a string\n"</span>, i)</div><div class="line">		<span class="keyword">default</span>:</div><div class="line">			fmt.Printf(<span class="string">"Param #%d is unknown\n"</span>, i)</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-5-测试一个值是否实现了某个接口"><a href="#11-5-测试一个值是否实现了某个接口" class="headerlink" title="11.5 测试一个值是否实现了某个接口"></a>11.5 测试一个值是否实现了某个接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Stringer <span class="keyword">interface</span> &#123;</div><div class="line">    String() <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> sv, ok := v.(Stringer); ok &#123;</div><div class="line">    fmt.Printf(<span class="string">"v implements String(): %s\n"</span>, sv.String()) <span class="comment">// note: sv, not v</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>接口是一种契约，实现类型必须满足它，描述了类型的行为，规定类型可以做什么。</li>
<li>使用接口使得代码更具有普适性</li>
</ul>
<h2 id="11-6-使用方法集与接口"><a href="#11-6-使用方法集与接口" class="headerlink" title="11.6 使用方法集与接口"></a>11.6 使用方法集与接口</h2><ul>
<li>作用于变量上的方法实际上是不区分变量是值还是指针的，但是如果变量是接口类型时，由于接口变量中村的具体指是不可以寻址的，会编译错误</li>
<li>在指针上调用方法时，必须有和方法定义时相同的接收者类型或者可以从具体类型P直接进行辨识的类型<ul>
<li>指针方法可以通过指针调用</li>
<li>值方法可以通过值调用</li>
<li>接收者是值的方法可以通过指针调用，因为指针会首先被解引用</li>
<li>接收者是指针的方法不可以通过值调用，因为存储在接口中的值没有地址</li>
</ul>
</li>
<li>将一个值赋值给接口时，编译器会进行类型检查</li>
</ul>
<p><em>小结</em></p>
<ol>
<li>类型<code>*T</code>的可调用方法集合包含接受者为*T或T的所有方法集</li>
<li>类型T的可调用方法集包含接受者为T的所有方法</li>
</ol>
<h2 id="11-7-Sorter接口排序"><a href="#11-7-Sorter接口排序" class="headerlink" title="11.7 Sorter接口排序"></a>11.7 Sorter接口排序</h2><ul>
<li>Sort函数接收一个Sorter接口类型的参数，Sorter接口定义了len，less,swap方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> sort</div><div class="line"></div><div class="line"><span class="keyword">type</span> Sorter <span class="keyword">interface</span> &#123;</div><div class="line">    Len() <span class="keyword">int</span></div><div class="line">    Less(i, j <span class="keyword">int</span>) <span class="keyword">bool</span></div><div class="line">    Swap(i, j, <span class="keyword">int</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sort</span><span class="params">(data Sorter)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> pass := <span class="number">1</span>; pass &lt; data.Len(); pass++ &#123;</div><div class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; data.Len - pass; i++ &#123;</div><div class="line">            <span class="keyword">if</span> data.Less(i+<span class="number">1</span>, j) &#123;</div><div class="line">                data.Swap(i, i + <span class="number">1</span>)</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IsSorted</span><span class="params">(data Sorter)</span> <span class="title">bool</span></span> &#123;</div><div class="line">    n := data.Len</div><div class="line">    <span class="keyword">for</span> i := n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i-- &#123;</div><div class="line">        <span class="keyword">if</span> data.Less(i, i<span class="number">-1</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> IntArray []<span class="keyword">int</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>&#123;<span class="keyword">return</span> <span class="built_in">len</span>(p)&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123;<span class="keyword">return</span> p[i] &lt; p[j]&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p IntArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;p[i], p[j] = p[j], p[i]&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> StringArray []<span class="keyword">string</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> p[i] &lt; p[j] &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p StringArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; p[i], p[j] = p[j], p[i] &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortInts</span><span class="params">(a []<span class="keyword">int</span>)</span></span>       &#123; Sort(IntArray(a)) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">SortStrings</span><span class="params">(a []<span class="keyword">string</span>)</span></span> &#123; Sort(StringArray(a)) &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">IntsAreSorted</span><span class="params">(a []<span class="keyword">int</span>)</span> <span class="title">bool</span></span>       &#123; <span class="keyword">return</span> IsSorted(IntArray(a)) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">StringsAreSorted</span><span class="params">(a []<span class="keyword">string</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> IsSorted(StringArray(a))</div></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">     	<span class="string">"fmt"</span></div><div class="line">     	<span class="string">"./sort"</span></div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// sorting of slice of integers</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">ints</span><span class="params">()</span></span> &#123;</div><div class="line">    	data := []<span class="keyword">int</span>&#123;<span class="number">74</span>, <span class="number">59</span>, <span class="number">238</span>, <span class="number">-784</span>, <span class="number">9845</span>, <span class="number">959</span>, <span class="number">905</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">7586</span>, <span class="number">-5467984</span>, <span class="number">7586</span>&#125;</div><div class="line">    	a := sort.IntArray(data)  <span class="comment">//conversion to type IntArray</span></div><div class="line">    	sort.Sort(a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">    	&#125;</div><div class="line">	    fmt.Printf(<span class="string">"The sorted array is: %v\n"</span>, a)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// sorting of slice of strings</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">strings</span><span class="params">()</span></span> &#123;</div><div class="line">    	data := []<span class="keyword">string</span>&#123;<span class="string">"monday"</span>, <span class="string">"friday"</span>, <span class="string">"tuesday"</span>, <span class="string">"wednesday"</span>, <span class="string">"sunday"</span>,<span class="string">"thursday"</span>, <span class="string">""</span>, <span class="string">"saturday"</span>&#125;</div><div class="line">    	a := sort.StringArray(data)</div><div class="line">    	sort.Sort(a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">		&#125;</div><div class="line">	    fmt.Printf(<span class="string">"The sorted array is: %v\n"</span>, a)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// a type which describes a day of the week</span></div><div class="line"><span class="keyword">type</span> day <span class="keyword">struct</span> &#123;</div><div class="line">    	num        <span class="keyword">int</span></div><div class="line">    	shortName  <span class="keyword">string</span></div><div class="line">    	longName   <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> dayArray <span class="keyword">struct</span> &#123;</div><div class="line">    	data []*day</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>            &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p.data) &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span>  &#123; <span class="keyword">return</span> p.data[i].num &lt; p.data[j].num &#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *dayArray)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>       &#123; p.data[i], p.data[j] = p.data[j], p.data[i] &#125;</div><div class="line"></div><div class="line"><span class="comment">// sorting of custom type day</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">days</span><span class="params">()</span></span> &#123;</div><div class="line">    	Sunday :=    day&#123;<span class="number">0</span>, <span class="string">"SUN"</span>, <span class="string">"Sunday"</span>&#125;</div><div class="line">    	Monday :=    day&#123;<span class="number">1</span>, <span class="string">"MON"</span>, <span class="string">"Monday"</span>&#125;</div><div class="line">    	Tuesday :=   day&#123;<span class="number">2</span>, <span class="string">"TUE"</span>, <span class="string">"Tuesday"</span>&#125;</div><div class="line">    	Wednesday := day&#123;<span class="number">3</span>, <span class="string">"WED"</span>, <span class="string">"Wednesday"</span>&#125;</div><div class="line">    	Thursday :=  day&#123;<span class="number">4</span>, <span class="string">"THU"</span>, <span class="string">"Thursday"</span>&#125;</div><div class="line">    	Friday :=    day&#123;<span class="number">5</span>, <span class="string">"FRI"</span>, <span class="string">"Friday"</span>&#125;</div><div class="line">    	Saturday :=  day&#123;<span class="number">6</span>, <span class="string">"SAT"</span>, <span class="string">"Saturday"</span>&#125;</div><div class="line">    	data := []*day&#123;&amp;Tuesday, &amp;Thursday, &amp;Wednesday, &amp;Sunday, &amp;Monday, &amp;Friday, &amp;Saturday&#125;</div><div class="line">    	a := dayArray&#123;data&#125;</div><div class="line">    	sort.Sort(&amp;a)</div><div class="line">    	<span class="keyword">if</span> !sort.IsSorted(&amp;a) &#123;</div><div class="line">    			<span class="built_in">panic</span>(<span class="string">"fail"</span>)</div><div class="line">    	&#125;</div><div class="line">    	<span class="keyword">for</span> _, d := <span class="keyword">range</span> data &#123;</div><div class="line">    			fmt.Printf(<span class="string">"%s "</span>, d.longName)</div><div class="line">    	&#125;</div><div class="line">    	fmt.Printf(<span class="string">"\n"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    ints()</div><div class="line">    strings()</div><div class="line">    days()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-8-读和写"><a href="#11-8-读和写" class="headerlink" title="11.8 读和写"></a>11.8 读和写</h2><ul>
<li>io包中提供了用于读和写的接口<code>io.Reader</code>和<code>io.Writer</code></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</div><div class="line">    Read(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Writer <span class="keyword">interface</span> &#123;</div><div class="line">    Write(p []<span class="keyword">byte</span>) (n <span class="keyword">int</span>, err error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>只要实现了读写接口，这个对象就是可读写的</li>
<li>bufio里面提供了带缓冲的读写</li>
</ul>
<h2 id="11-9-空接口"><a href="#11-9-空接口" class="headerlink" title="11.9 空接口"></a>11.9 空接口</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul>
<li>空接口不包含任何方法，对实现不做要求 <code>type Any interface{}</code></li>
<li>类似Java中的Object类</li>
<li>空接口可以被赋予任何值</li>
<li>每个interface变量占据两个字长，一个用来存储包含的类型，一个用来存储包含的数据或者数据指针</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">testFunc := <span class="function"><span class="keyword">func</span><span class="params">(any <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> v := any.(<span class="keyword">type</span>) &#123;</div><div class="line">	<span class="keyword">case</span> <span class="keyword">bool</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a bool type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">int</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is an int type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">float32</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a float32 type"</span>, v)</div><div class="line">	<span class="keyword">case</span> <span class="keyword">string</span>:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a string type"</span>, v)</div><div class="line">	<span class="keyword">case</span> specialString:</div><div class="line">		fmt.Printf(<span class="string">"any %v is a special String!"</span>, v)</div><div class="line">	<span class="keyword">default</span>:</div><div class="line">		fmt.Println(<span class="string">"unknown type!"</span>)</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-2-构建通过类型或者包含不通类型变量的数组"><a href="#11-9-2-构建通过类型或者包含不通类型变量的数组" class="headerlink" title="11.9.2 构建通过类型或者包含不通类型变量的数组"></a>11.9.2 构建通过类型或者包含不通类型变量的数组</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Element <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> Vector <span class="keyword">struct</span> &#123;</div><div class="line">    a []Element</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>Vector里面可以存放任何类型的变量</li>
<li>Vector中存储的所有元素都是Element类型，得到袁术类型需要用类型断言</li>
</ul>
<h3 id="11-9-3-复制数据切片到空接口切片"><a href="#11-9-3-复制数据切片到空接口切片" class="headerlink" title="11.9.3 复制数据切片到空接口切片"></a>11.9.3 复制数据切片到空接口切片</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> dataSlice []myType = FuncReturnSlice()</div><div class="line"><span class="keyword">var</span> interfaceSlice []<span class="keyword">interface</span>&#123;&#125; = <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="built_in">len</span>(dataSlice))</div><div class="line"><span class="keyword">for</span> idx, val := <span class="keyword">range</span> dataSlice &#123;</div><div class="line">    interfaceSlice[i] = d</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-4-通用类型的节点数据结构"><a href="#11-9-4-通用类型的节点数据结构" class="headerlink" title="11.9.4 通用类型的节点数据结构"></a>11.9.4 通用类型的节点数据结构</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Node <span class="keyword">struct</span> &#123;</div><div class="line">    left *Node</div><div class="line">    data <span class="keyword">interface</span>&#123;]</div><div class="line">    right *Node</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewNode</span><span class="params">(left, right *Node)</span> *<span class="title">Node</span></span> &#123;</div><div class="line">    <span class="keyword">return</span> &amp;Node&#123;left, <span class="literal">nil</span>, right&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n *Node)</span> <span class="title">SetData</span><span class="params">(data <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">    n.data = data</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-9-5-接口到接口"><a href="#11-9-5-接口到接口" class="headerlink" title="11.9.5 接口到接口"></a>11.9.5 接口到接口</h3><ul>
<li>一个接口的值可以赋值给另一个接口，只要底层实现了必要的方法</li>
<li>运行时才会检查两个接口是否可以进行赋值，不可以会报错</li>
</ul>
<h2 id="11-10-反射包"><a href="#11-10-反射包" class="headerlink" title="11.10 反射包"></a>11.10 反射包</h2><ul>
<li>反射是用程序检查其所拥有的结构，类型的一种能力</li>
<li>反射可以在运行时检查类型和变量，比如大小，方法并动态的调用这些方法</li>
<li>反射包中Type用来表示一个Go类型，Value为go提供了反射的接口</li>
<li><code>reflect.TypeOf reflect.ValueOf</code>检查对象的类型和值</li>
<li>反射可以从接口值反射到对象，也可以从对象反射回接口</li>
<li>反射包中的常量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> (</div><div class="line">	Invalid Kind = <span class="literal">iota</span></div><div class="line">	Bool</div><div class="line">	Int</div><div class="line">	Int8</div><div class="line">	Int16</div><div class="line">	Int32</div><div class="line">	Int64</div><div class="line">	Uint</div><div class="line">	Uint8</div><div class="line">	Uint16</div><div class="line">	Uint32</div><div class="line">	Uint64</div><div class="line">	Uintptr</div><div class="line">	Float32</div><div class="line">	Float64</div><div class="line">	Complex64</div><div class="line">	Complex128</div><div class="line">	Array</div><div class="line">	Chan</div><div class="line">	Func</div><div class="line">	Interface</div><div class="line">	Map</div><div class="line">	Ptr</div><div class="line">	Slice</div><div class="line">	String</div><div class="line">	Struct</div><div class="line">	UnsafePointer</div><div class="line">)</div></pre></td></tr></table></figure>
<ul>
<li>Kind方法总是返回底层类型</li>
</ul>
<h3 id="11-10-2-通过反射修改值"><a href="#11-10-2-通过反射修改值" class="headerlink" title="11.10.2 通过反射修改值"></a>11.10.2 通过反射修改值</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> x <span class="keyword">float64</span> = <span class="number">3.4</span></div><div class="line">v := reflect.ValueOf(x)</div><div class="line">fmt.Println(<span class="string">"settablity of v:"</span>, v.Canset())</div><div class="line">v = reflect.ValueOf(&amp;x)</div><div class="line">v = v.Elem()</div><div class="line">v.SetFloat(<span class="number">3.1415</span>)</div></pre></td></tr></table></figure>
<ul>
<li>NumField()方法返回结构内的字段数量，通过for循环用索引取得每个字段的值Field<h3 id="11-10-3-反射结构"><a href="#11-10-3-反射结构" class="headerlink" title="11.10.3 反射结构"></a>11.10.3 反射结构</h3></li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> NotknownType <span class="keyword">struct</span> &#123;</div><div class="line">	s1, s2, s3 <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(n NotknownType)</span> <span class="title">String</span><span class="params">()</span> <span class="title">string</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> n.s1 + <span class="string">" - "</span> + n.s2 + <span class="string">" - "</span> + n.s3</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// variable to investigate:</span></div><div class="line"><span class="keyword">var</span> secret <span class="keyword">interface</span>&#123;&#125; = NotknownType&#123;<span class="string">"Ada"</span>, <span class="string">"Go"</span>, <span class="string">"Oberon"</span>&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	value := reflect.ValueOf(secret) <span class="comment">// &lt;main.NotknownType Value&gt;</span></div><div class="line">	typ := reflect.TypeOf(secret)    <span class="comment">// main.NotknownType</span></div><div class="line">	<span class="comment">// alternative:</span></div><div class="line">	<span class="comment">//typ := value.Type()  // main.NotknownType</span></div><div class="line">	fmt.Println(typ)</div><div class="line">	knd := value.Kind() <span class="comment">// struct</span></div><div class="line">	fmt.Println(knd)</div><div class="line"></div><div class="line">	<span class="comment">// iterate through the fields of the struct:</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; value.NumField(); i++ &#123;</div><div class="line">		fmt.Printf(<span class="string">"Field %d: %v\n"</span>, i, value.Field(i))</div><div class="line">		<span class="comment">// error: panic: reflect.Value.SetString using value obtained using unexported field</span></div><div class="line">		<span class="comment">//value.Field(i).SetString("C#")</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// call the first method, which is String():</span></div><div class="line">	results := value.Method(<span class="number">0</span>).Call(<span class="literal">nil</span>)</div><div class="line">	fmt.Println(results) <span class="comment">// [Ada - Go - Oberon]</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>结构体中只有被导出字段(大写的字段)才是可以设置的</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> T <span class="keyword">struct</span> &#123;</div><div class="line">	A <span class="keyword">int</span></div><div class="line">	B <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	t := T&#123;<span class="number">23</span>, <span class="string">"skidoo"</span>&#125;</div><div class="line">	s := reflect.ValueOf(&amp;t).Elem()</div><div class="line">	typeOfT := s.Type()</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; s.NumField(); i++ &#123;</div><div class="line">		f := s.Field(i)</div><div class="line">		fmt.Printf(<span class="string">"%d: %s %s = %v\n"</span>, i,</div><div class="line">			typeOfT.Field(i).Name, f.Type(), f.Interface())</div><div class="line">	&#125;</div><div class="line">	s.Field(<span class="number">0</span>).SetInt(<span class="number">77</span>)</div><div class="line">	s.Field(<span class="number">1</span>).SetString(<span class="string">"Sunset Strip"</span>)</div><div class="line">	fmt.Println(<span class="string">"t is now"</span>, t)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="11-11-Printf和反射"><a href="#11-11-Printf和反射" class="headerlink" title="11.11 Printf和反射"></a>11.11 Printf和反射</h2><ul>
<li>Printf函数声明为</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="keyword">string</span>, args ... <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(n <span class="keyword">int</span>, err error)</span></span></div></pre></td></tr></table></figure>
<ul>
<li><code>...</code>为空接口类型，Printf可以知道每个参数的类型</li>
</ul>
<h2 id="11-12-接口和动态类型"><a href="#11-12-接口和动态类型" class="headerlink" title="11.12 接口和动态类型"></a>11.12 接口和动态类型</h2><h3 id="11-12-1-Go的动态类型"><a href="#11-12-1-Go的动态类型" class="headerlink" title="11.12.1 Go的动态类型"></a>11.12.1 Go的动态类型</h3><ul>
<li>go语言中数据和方法是松耦合的</li>
<li>go中的接口任何提供了接口方法实现代码的类型都隐式的实现了该接口</li>
<li>duck typing，能做什么比是什么更加重要</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> IDuck <span class="keyword">interface</span> &#123;</div><div class="line">    Quack()</div><div class="line">    Walk()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">DuckDance</span><span class="params">(duck IDuck)</span></span> &#123;</div><div class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">3</span>; i++ &#123;</div><div class="line">        duck.Quack()</div><div class="line">        duck.Walk()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Bird <span class="keyword">struct</span> &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bird)</span> <span class="title">Quack</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"bibibi"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Bird)</span> <span class="title">Walk</span><span class="params">()</span></span> &#123;</div><div class="line">    fmt.Println(<span class="string">"gogogo"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    b := <span class="built_in">new</span>(Bird)</div><div class="line">    DuckDance(b)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-12-2-动态方法调用"><a href="#11-12-2-动态方法调用" class="headerlink" title="11.12.2 动态方法调用"></a>11.12.2 动态方法调用</h3><ul>
<li>当一个变量被赋值给一个接口类型的变量时，编译器会检查其是否实现了该接口的所有函数，空接口可以使用类型断言来判断</li>
<li>go提供了动态语言的优点，却没有其他动态语言在运行时随时会报错的缺点</li>
<li>Go 的接口提高了代码的分离度，改善了代码的复用性，使得代码开发过程中的设计模式更容易实现。用 Go 接口还能实现 依赖注入模式。</li>
</ul>
<h3 id="11-12-3-接口的提取"><a href="#11-12-3-接口的提取" class="headerlink" title="11.12.3 接口的提取"></a>11.12.3 接口的提取</h3><ul>
<li>接口的提取是非常有用的设计模式，可以减少需要的类型和方法数量</li>
<li>一些拥有共同行为的对象可以抽象出接口</li>
<li>整个设计可以持续演进，不用废弃之前的决定</li>
<li>类型要实现某个接口，本身不用改变，在类型上实现新的方法就可以</li>
</ul>
<h3 id="11-12-4-显示的指明类型实现了某个接口"><a href="#11-12-4-显示的指明类型实现了某个接口" class="headerlink" title="11.12.4 显示的指明类型实现了某个接口"></a>11.12.4 显示的指明类型实现了某个接口</h3><ul>
<li>结构体中添加具有描述性名字的方法</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Fooer <span class="keyword">interface</span> &#123;</div><div class="line">    Foo()</div><div class="line">    ImplementsFooer()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="11-12-5-空接口和函数重载"><a href="#11-12-5-空接口和函数重载" class="headerlink" title="11.12.5 空接口和函数重载"></a>11.12.5 空接口和函数重载</h3><ul>
<li>go语言是不允许函数重载的</li>
<li>go中通过将最后一个参数换成…interface{}来实现函数重载，允许传递任意数量任意类型的参数给函数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fmt.Printf(format <span class="keyword">string</span>, a ...<span class="keyword">interface</span>&#123;&#125;) (n <span class="keyword">int</span>, err error)</div></pre></td></tr></table></figure>
<h3 id="11-12-6-接口的继承"><a href="#11-12-6-接口的继承" class="headerlink" title="11.12.6 接口的继承"></a>11.12.6 接口的继承</h3><ul>
<li>当一个类型嵌套另外一个类型的指针时，这个类型就可以使用另一个类型的所有方法</li>
<li>多态用的越多，代码就相对越少</li>
<li>类型可以通过继承多个接口来实现多重继承</li>
<li>添加新的接口是非常容易的，因为已有的类型不用变动，仅需要实现新的接口即可</li>
</ul>
<h3 id="11-13-go中面向对象总结"><a href="#11-13-go中面向对象总结" class="headerlink" title="11.13 go中面向对象总结"></a>11.13 go中面向对象总结</h3><ul>
<li>go中没有类，而是松耦合的类型，方法对接口的实现</li>
<li>封装：go的可见层级为两个，包范围内可见和全局可见</li>
<li>继承：用组合实现，内嵌一个或者多个想要的行为的类型，可以多重嵌套</li>
<li>多态：用接口实现，某个类型的实例可以赋值给它所实现的任意接口类型的变量。类型和接口是松耦合的，多重继承可以通过实现多个接口来实现。</li>
</ul>
<h3 id="11-14-结构体、集合和高阶函数"><a href="#11-14-结构体、集合和高阶函数" class="headerlink" title="11.14 结构体、集合和高阶函数"></a>11.14 结构体、集合和高阶函数</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// cars.go</span></div><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> (</div><div class="line">	<span class="string">"fmt"</span></div><div class="line">)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">type</span> Any <span class="keyword">interface</span>&#123;&#125;</div><div class="line"><span class="keyword">type</span> Car <span class="keyword">struct</span> &#123;</div><div class="line">	Model   	<span class="keyword">string</span></div><div class="line">	Manufacturer	<span class="keyword">string</span></div><div class="line">	BuildYear	<span class="keyword">int</span></div><div class="line">    <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">type</span> Cars []*Car</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="comment">// make some cars:</span></div><div class="line">	ford := &amp;Car&#123;<span class="string">"Fiesta"</span>,<span class="string">"Ford"</span>, <span class="number">2008</span>&#125;</div><div class="line">	bmw  := &amp;Car&#123;<span class="string">"XL 450"</span>, <span class="string">"BMW"</span>, <span class="number">2011</span>&#125;</div><div class="line">	merc := &amp;Car&#123;<span class="string">"D600"</span>, <span class="string">"Mercedes"</span>, <span class="number">2009</span>&#125;</div><div class="line">	bmw2 := &amp;Car&#123;<span class="string">"X 800"</span>, <span class="string">"BMW"</span>, <span class="number">2008</span>&#125;</div><div class="line">	<span class="comment">// query:</span></div><div class="line">	allCars := Cars([]*Car&#123;ford, bmw, merc, bmw2&#125;)</div><div class="line">	allNewBMWs := allCars.FindAll(<span class="function"><span class="keyword">func</span><span class="params">(car *Car)</span> <span class="title">bool</span></span> &#123;</div><div class="line">      <span class="keyword">return</span> (car.Manufacturer == <span class="string">"BMW"</span>) &amp;&amp; (car.BuildYear &gt; <span class="number">2010</span>)</div><div class="line">	&#125;)</div><div class="line">	fmt.Println(<span class="string">"AllCars: "</span>, allCars)</div><div class="line">	fmt.Println(<span class="string">"New BMWs: "</span>, allNewBMWs)</div><div class="line">	<span class="comment">//</span></div><div class="line">	manufacturers := []<span class="keyword">string</span>&#123;<span class="string">"Ford"</span>, <span class="string">"Aston Martin"</span>, <span class="string">"Land Rover"</span>, <span class="string">"BMW"</span>, <span class="string">"Jaguar"</span>&#125;</div><div class="line">	sortedAppender, sortedCars := MakeSortedAppender(manufacturers)</div><div class="line">	allCars.Process(sortedAppender)</div><div class="line">	fmt.Println(<span class="string">"Map sortedCars: "</span>, sortedCars)</div><div class="line">    BMWCount := <span class="built_in">len</span>(sortedCars[<span class="string">"BMW"</span>])</div><div class="line">	fmt.Println(<span class="string">"We have "</span>, BMWCount, <span class="string">" BMWs"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Process all cars with the given function f:</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">Process</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span>)</span> &#123;</div><div class="line">     <span class="keyword">for</span> _, c := <span class="keyword">range</span> cs &#123;</div><div class="line">         f(c)</div><div class="line">     &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Find all cars matching a given criteria.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">FindAll</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span> <span class="title">bool</span>) <span class="title">Cars</span></span> &#123;</div><div class="line">    cars := <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line"></div><div class="line">    cs.Process(<span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> f(c) &#123;</div><div class="line">            cars = <span class="built_in">append</span>(cars, c)</div><div class="line">        &#125;</div><div class="line">    &#125;)</div><div class="line">    <span class="keyword">return</span> cars</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Process cars and create new data.</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cs Cars)</span> <span class="title">Map</span><span class="params">(f <span class="keyword">func</span>(car *Car)</span> <span class="title">Any</span>) []<span class="title">Any</span></span> &#123;</div><div class="line">       result := <span class="built_in">make</span>([]Any, <span class="number">0</span>)</div><div class="line">       ix := <span class="number">0</span></div><div class="line">       cs.Process(<span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">           result[ix] = f(c)</div><div class="line">           ix++</div><div class="line">       &#125;)</div><div class="line">       <span class="keyword">return</span> result</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeSortedAppender</span><span class="params">(manufacturers []<span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">func</span>(car *Car)</span>, <span class="title">map</span>[<span class="title">string</span>]<span class="title">Cars</span>)</span> &#123;</div><div class="line">     <span class="comment">// Prepare maps of sorted cars.</span></div><div class="line">       sortedCars := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]Cars)</div><div class="line"></div><div class="line">       <span class="keyword">for</span> _, m := <span class="keyword">range</span> manufacturers &#123;</div><div class="line">           sortedCars[m] = <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line">       &#125;</div><div class="line">       sortedCars[<span class="string">"Default"</span>] = <span class="built_in">make</span>([]*Car, <span class="number">0</span>)</div><div class="line"></div><div class="line">       <span class="comment">// Prepare appender function:</span></div><div class="line">       appender := <span class="function"><span class="keyword">func</span><span class="params">(c *Car)</span></span> &#123;</div><div class="line">           <span class="keyword">if</span> _, ok := sortedCars[c.Manufacturer]; ok &#123;</div><div class="line">               sortedCars[c.Manufacturer] = <span class="built_in">append</span>(sortedCars[c.Manufacturer], c)</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               sortedCars[<span class="string">"Default"</span>] = <span class="built_in">append</span>(sortedCars[<span class="string">"Default"</span>], c)</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> appender, sortedCars</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* Output:</span></div><div class="line"><span class="comment">AllCars:  [0xf8400038a0 0xf840003bd0 0xf840003ba0 0xf840003b70]</span></div><div class="line"><span class="comment">New BMWs:  [0xf840003bd0]</span></div><div class="line"><span class="comment">Map sortedCars:  map[Default:[0xf840003ba0] Jaguar:[] Land Rover:[] BMW:[0xf840003bd0 0xf840003b70] Aston Martin:[] Ford:[0xf8400038a0]]</span></div><div class="line"><span class="comment">We have  2  BMWs</span></div><div class="line"><span class="comment">*/</span></div></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/21/设计模式简介/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="cdx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小黄">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/21/设计模式简介/" itemprop="url">设计模式简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-21T14:13:14+08:00">
                2019-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index">
                    <span itemprop="name">Java</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/design-patterns/" itemprop="url" rel="index">
                    <span itemprop="name">design patterns</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h1><ul>
<li>创建型模式：工厂方法模式，抽象工厂模式，单例模式，建造者模式，原型模式</li>
<li>结构型模式：适配器模式，装饰器模式，代理模式，外观模式，桥接模式，组合模式，享元模式</li>
<li>行为型模式：策略模式，模板方法模式，观察者模式，迭代子模式，责任链模式，命令模式，备忘录模式，状态模式，访问者模式，中介者模式，解释器模式。</li>
</ul>
<h1 id="设计模式六大原则"><a href="#设计模式六大原则" class="headerlink" title="设计模式六大原则"></a>设计模式六大原则</h1><ol>
<li>总原则-开闭原则</li>
</ol>
<p>对扩展开放，对修改封闭。</p>
<p>在需要对程序进行扩展时，不去修改原来的代码，而是要扩展原有代码，类似热插拔。需要使用接口或者抽象类。</p>
<ol>
<li>单一职能原则</li>
</ol>
<ul>
<li>不要存在多余一个类变更的原因，也就是每个类应该实现单一的职责，否则需要将类进行拆分。</li>
</ul>
<ol>
<li>里氏替换原则</li>
</ol>
<ul>
<li><p>任何基类可以出现的地方，子类一定可以出现。里氏替换原则是继承复用的基石，只有当衍生类可以替换基类，软件单位的功能不受影响时，基类才能真正被复用，而衍生类也能够在基类的基础上增加新的行为。</p>
</li>
<li><p>里氏替换原则是对实现抽象化的具体步骤的规范。其中子类对父类的方法尽量不要重写和重载。因为父类代表着定义好的结构，通过这个规范的接口与外界交互，子类不应该破坏。</p>
</li>
</ul>
<ol>
<li>依赖倒转原则</li>
</ol>
<ul>
<li>面向接口编程，依赖于抽象而不依赖于具体。写代码时用到具体类时，不与具体类交互，而是与具体类的上层接口交互。</li>
</ul>
<ol>
<li>接口隔离原则</li>
</ol>
<ul>
<li>每个接口中不存在子类用不到却必须实现的方法，否则就拆分接口。使用多个隔离的接口，比使用单个接口要好。</li>
</ul>
<ol>
<li>迪米特法则</li>
</ol>
<ul>
<li><p>一个类对自己依赖的类知道的越少越好。无论被依赖的类多么复杂，都应该讲逻辑封装到方法的内部，通过public方法提供给外部。这样当被依赖的类变化时，才能最小的影响该类。</p>
</li>
<li><p>最少知道原则：只与直接的朋友通信，类之间要是有耦合关系，就称为朋友关系。耦合分为依赖，关联，聚合，组合灯，我们成出现为成员变量，方法参数，方法返回值中的类为直接朋友。局部变量，临时变量则不是直接朋友。我们要求陌生的类不要作为局部变量出现在类中。</p>
</li>
</ul>
<ol>
<li>合成复用原则</li>
</ol>
<ul>
<li>尽量首先使用合成、聚合方式，而不是使用继承。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="/images/avatar.gif"
              alt="cdx" />
          
            <p class="site-author-name" itemprop="name">cdx</p>
            <p class="site-description motion-element" itemprop="description">Be a better man!</p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/cdx0312" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>GitHub</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="mailto:cdxu0312@outlook.com" target="_blank" title="E-Mail">
                  
                    <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cdx</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  





  

  

  

  

  

  

</body>
</html>
